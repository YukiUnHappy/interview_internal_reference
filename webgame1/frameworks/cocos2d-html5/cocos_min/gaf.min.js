var gaf=gaf||{};gaf.COMPRESSION_NONE=4669766,gaf.COMPRESSION_ZIP=4669763,gaf.IDNONE=4294967295,gaf.FIRST_FRAME_INDEX=0,gaf.EFFECT_DROP_SHADOW=0,gaf.EFFECT_BLUR=1,gaf.EFFECT_GLOW=2,gaf.EFFECT_COLOR_MATRIX=6,gaf.ACTION_STOP=0,gaf.ACTION_PLAY=1,gaf.ACTION_GO_TO_AND_STOP=2,gaf.ACTION_GO_TO_AND_PLAY=3,gaf.ACTION_DISPATCH_EVENT=4,gaf.PI_FRAME=0,gaf.PI_EVENT_TYPE=0,gaf.TYPE_TEXTURE=0,gaf.TYPE_TEXT_FIELD=1,gaf.TYPE_TIME_LINE=2,gaf.UNIFORM_BLUR_TEXEL_OFFSET="u_step",gaf.UNIFORM_GLOW_TEXEL_OFFSET="u_step",gaf.UNIFORM_GLOW_COLOR="u_glowColor",gaf.UNIFORM_ALPHA_TINT_MULT="colorTransformMult",gaf.UNIFORM_ALPHA_TINT_OFFSET="colorTransformOffsets",gaf.UNIFORM_ALPHA_COLOR_MATRIX_BODY="colorMatrix",gaf.UNIFORM_ALPHA_COLOR_MATRIX_APPENDIX="colorMatrix2",(gaf=gaf||{})._tmp=gaf._tmp||{},gaf._initialized=!1,gaf.CCGAFLoader=function(){this.load=function(realUrl,url,item,cb){gaf._initialized||gaf._setup(),(new gaf.Loader).LoadFile(realUrl,function(data){cb(null,data)})}},gaf._setup=function(){gaf._setupShaders(),gaf._initialized=!0},cc.loader.register(".gaf",new gaf.CCGAFLoader),gaf.CGAffineTransformCocosFormatFromFlashFormat=function(transform){var t={};return t.a=transform.a,t.b=-transform.b,t.c=-transform.c,t.d=transform.d,t.tx=transform.tx,t.ty=-transform.ty,t},gaf._AssetPreload=function(){this[0]=this.End,this[1]=this.Atlases,this[2]=this.AnimationMasks,this[3]=this.AnimationObjects,this[4]=this.AnimationFrames,this[5]=this.NamedParts,this[6]=this.Sequences,this[7]=this.TextFields,this[8]=this.Atlases,this[9]=this.Stage,this[10]=this.AnimationObjects,this[11]=this.AnimationMasks,this[12]=this.AnimationFrames,this[13]=this.TimeLine},gaf._AssetPreload.prototype.End=function(asset,content,timeLine){timeLine&&(timeLine.getFps=function(){return asset.getSceneFps()})},gaf._AssetPreload.prototype.Tag=function(asset,tag,timeLine){this[tag.tagId].call(this,asset,tag.content,timeLine)},gaf._AssetPreload.prototype.Tags=function(asset,tags,timeLine){var self=this;tags.forEach(function(tag){self.Tag(asset,tag,timeLine)})},gaf._AssetPreload.prototype.AtlasCreateFrames=function(elements,asset,spriteFrames){elements.forEach(function(item){var texture=asset._atlases[item.atlasId],rect=cc.rect(item.origin.x,item.origin.y,item.size.x,item.size.y),frame=new cc.SpriteFrame(texture,rect);frame._gafAnchor={x:0-(0-item.pivot.x/item.size.x),y:1-item.pivot.y/item.size.y+0},spriteFrames[item.elementAtlasId]=frame})},gaf._AssetPreload.prototype.Atlases=function(asset,content,timeLine){var spriteFrames=asset._atlasScales[content.scale]=asset._atlasScales[content.scale]||[],csf=cc.Director._getInstance().getContentScaleFactor();content.atlases.forEach(function(item){var atlasId=item.id,finalizeLoading=function(){gaf._AssetPreload.AtlasCreateFrames(content.elements,asset,spriteFrames)},atlasPath="";item.sources.forEach(function(atlasSource){atlasSource.csf===csf&&(atlasPath=atlasSource.source)}),cc.assert(atlasPath,"GAF Error. Texture for current CSF not found. Reconvert animation with correct parameters."),asset._textureLoadDelegate&&(atlasPath=asset._textureLoadDelegate(atlasPath));for(var loaded=!1,paths=asset._getSearchPaths(atlasPath),i=0,len=paths.length;i<len;++i){var path=paths[i],atlas=cc.textureCache.getTextureForKey(path);if(atlas&&atlas.isLoaded()){atlas.handleLoadedTexture(!0),loaded=!0,asset._atlases[atlasId]=atlas,finalizeLoading();break}}if(!loaded){asset._atlasesToLoad.hasOwnProperty(atlasId)||(gaf._AtlasLoader.loadArray(paths,function(atlas){atlas.handleLoadedTexture(!0),asset._onAtlasLoaded(atlasId,atlas)},function(){cc.log("GAF Error. Couldn't find `"+atlasPath+"` required by `"+asset.getGAFFileName()+"`")}),asset._atlasesToLoad[atlasId]={}),asset._onLoadTasks.push(finalizeLoading)}})},gaf._AssetPreload.prototype.AnimationObjects=function(asset,content,timeLine){content.forEach(function(item){item.type=void 0===item.type?gaf.TYPE_TEXTURE:item.type,timeLine._objects.push(item.objectId),asset._objects[item.objectId]=item})},gaf._AssetPreload.prototype.convertTint=function(mat,alpha){return mat?{mult:{r:255*mat.redMultiplier,g:255*mat.greenMultiplier,b:255*mat.blueMultiplier,a:255*alpha},offset:{r:255*mat.redOffset,g:255*mat.greenOffset,b:255*mat.blueOffset,a:255*mat.alphaOffset}}:null},gaf._AssetPreload.prototype.convertState=function(state){return{hasColorTransform:state.hasColorTransform,hasMask:state.hasMask,hasEffect:state.hasEffect,objectIdRef:state.objectIdRef,depth:state.depth,alpha:255*state.alpha,matrix:gaf.CGAffineTransformCocosFormatFromFlashFormat(state.matrix),colorTransform:this.convertTint(state.colorTransform,state.alpha),effect:state.effect,maskObjectIdRef:state.maskObjectIdRef}},gaf._AssetPreload.prototype.AnimationFrames=function(asset,content,timeLine){var self=this;cc.assert(timeLine,"Error. Time Line should not be null.");for(var statesForId={},frames=[],i=0,len=content.length;i<len;++i){var frame=content[i];frame.state&&frame.state.forEach(function(state){0!==state.alpha?statesForId[state.objectIdRef]=self.convertState(state):statesForId[state.objectIdRef]=null});var stateArray=[];for(var obj in statesForId)statesForId.hasOwnProperty(obj)&&statesForId[obj]&&stateArray.push(statesForId[obj]);frame,frames[frame.frame-1]={states:stateArray,actions:frame.actions||null}}timeLine.getFrames=function(){return frames}},gaf._AssetPreload.prototype.NamedParts=function(asset,content,timeLine){var parts={};content.forEach(function(item){parts[item.name]=item.objectId}),timeLine.getNamedParts=function(){return parts}},gaf._AssetPreload.prototype.Sequences=function(asset,content,timeLine){var sequences={};content.forEach(function(item){sequences[item.id]={start:item.start-1,end:item.end}}),timeLine.getSequences=function(){return sequences}},gaf._AssetPreload.prototype.TextFields=function(asset,content,timeLine){},gaf._AssetPreload.prototype.Stage=function(asset,content,timeLine){asset._sceneFps=content.fps,asset._sceneColor=content.color,asset._sceneWidth=content.width,asset._sceneHeight=content.height},gaf._AssetPreload.prototype.AnimationMasks=function(asset,content,timeLine){content.forEach(function(item){item.type=void 0===item.type?gaf.TYPE_TEXTURE:item.type,timeLine._objects.push(item.objectId),asset._masks[item.objectId]=item})},gaf._AssetPreload.prototype.TimeLine=function(asset,content,timeLine){var result=new gaf._TimeLineProto(asset,content.animationFrameCount,content.boundingBox,content.pivotPoint,content.id,content.linkageName);asset._pushTimeLine(result),this.Tags(asset,content.tags,result)},gaf._AssetPreload=new gaf._AssetPreload,(gaf=gaf||{}).Asset=cc.Class.extend({_className:"GAFAsset",_header:null,_timeLines:null,_textFields:null,_protos:null,_objects:null,_masks:null,_rootTimeLine:null,_textureLoadDelegate:null,_sceneFps:60,_sceneWidth:0,_sceneHeight:0,_sceneColor:0,_gafData:null,_desiredAtlasScale:1,_usedAtlasScale:0,_atlases:null,_onLoadTasks:null,_atlasScales:null,_textureLoaded:!1,_atlasesToLoad:null,_gafName:null,initWithGAFFile:function(filePath,textureLoadDelegate){var self=this;this._textureLoadDelegate=textureLoadDelegate,this._gafName=filePath;var gafData=cc.loader.getRes(filePath);return gafData?this._init(gafData):(cc.loader.load(filePath,function(err,data){err||self._init(data[0])}),!1)},initWithGAFBundle:function(zipFilePath,entryFile,delegate){return cc.assert(!1,"initWithGAFBundle is not yet implemented"),!1},setRootTimelineWithName:function(name){for(var i=0,end=this._timeLines.length;i<end;++i){var object=this._timeLines[i];if(object&&object.getLinkageName()===name)return void this._setRootTimeline(object)}},isAssetVersionPlayable:function(){return!0},desiredAtlasScale:function(){return this._desiredAtlasScale},setDesiredAtlasScale:function(desiredAtlasScale){this._desiredAtlasScale=desiredAtlasScale;for(var currentScale in this._atlasScales)this._atlasScales.hasOwnProperty(currentScale)&&(0===this._usedAtlasScale||Math.abs(this._usedAtlasScale-desiredAtlasScale)>Math.abs(currentScale-desiredAtlasScale))&&(this._usedAtlasScale=currentScale)},createObject:function(){return this._instantiateGaf(this._gafData)},createObjectAndRun:function(looped){cc.assert(1===arguments.length,"GAFAsset::createObjectAndRun should have one param");var object=this._instantiateGaf(this._gafData);return object.setLooped(looped,!0),object.start(),object},setTextureLoadDelegate:function(delegate){},getSceneFps:function(){return this._sceneFps},getSceneWidth:function(){},getSceneHeight:function(){},getSceneColor:function(){},setSceneFps:function(fps){this._sceneFps=fps},setSceneWidth:function(width){},setSceneHeight:function(height){},setSceneColor:function(color4B){},getHeader:function(){return this._header},getGAFFileName:function(){return this._gafName},ctor:function(){this._header={},this._timeLines=[],this._textFields=[],this._objects=[],this._masks=[],this._protos=[],this._atlases={},this._onLoadTasks=[],this._atlasScales={},this._atlasesToLoad={},arguments.length>0&&this.initWithGAFFile.apply(this,arguments)},_getProtos:function(){return this._protos},_setRootTimeline:function(timeLine){this._rootTimeLine=timeLine,this._header.pivot=timeLine.getPivot(),this._header.frameSize=timeLine.getRect()},_setHeader:function(gafHeader){for(var prop in gafHeader)gafHeader.hasOwnProperty(prop)&&(this._header[prop]=gafHeader[prop])},_getMajorVerison:function(){return this._header.versionMajor},_init:function(gafData){var self=this;this._gafData=gafData,this._setHeader(gafData.header),this._timeLinesToLink=[],this._getMajorVerison()<4&&this._pushTimeLine(new gaf._TimeLineProto(this,this._header.framesCount,this._header.frameSize,this._header.pivot)),gaf._AssetPreload.Tags(this,gafData.tags,this._rootTimeLine),this._objects.forEach(function(item){switch(item.type){case gaf.TYPE_TEXTURE:self._protos[item.objectId]||(self._protos[item.objectId]=new gaf._SpriteProto(self,self._atlasScales,item.elementAtlasIdRef));break;case gaf.TYPE_TIME_LINE:self._protos[item.objectId]=self._timeLines[item.elementAtlasIdRef];break;case gaf.TYPE_TEXT_FIELD:self._protos[item.objectId]=self._textFields[item.elementAtlasIdRef];break;default:cc.log("Unknown object type: "+item.type)}}),this._masks.forEach(function(item){if(!self._protos[item.objectId]){var proto=null;switch(item.type){case gaf.TYPE_TEXTURE:proto=new gaf._SpriteProto(self,self._atlasScales,item.elementAtlasIdRef);break;case gaf.TYPE_TIME_LINE:proto=self._timeLines[item.elementAtlasIdRef];break;case gaf.TYPE_TEXT_FIELD:proto=self._textFields[item.elementAtlasIdRef]}self._protos[item.objectId]=new gaf._MaskProto(self,proto,item.elementAtlasIdRef)}}),this.setDesiredAtlasScale(this._desiredAtlasScale),0===Object.keys(this._atlasesToLoad).length&&(this._textureLoaded=!0,this.dispatchEvent("load"))},_pushTimeLine:function(timeLine){this._timeLines[timeLine.getId()]=timeLine,0===timeLine.getId()&&this._setRootTimeline(timeLine)},_instantiateGaf:function(){return this._rootTimeLine._gafConstruct()},_onAtlasLoaded:function(id,atlas){this._atlases[id]=atlas,delete this._atlasesToLoad[id],0===Object.keys(this._atlasesToLoad).length&&(this._onLoadTasks.forEach(function(fn){fn()}),this._onLoadTasks.length=0,this._textureLoaded=!0,this.dispatchEvent("load"))},isLoaded:function(){return this._textureLoaded},_getSearchPaths:function(imageUrl){var extendedPath=this.getGAFFileName().split("/");return extendedPath[extendedPath.length-1]=imageUrl,[imageUrl,extendedPath.join("/")]}}),gaf.Asset.create=function(gafFilePath,delegate){return new gaf.Asset(gafFilePath,delegate)},gaf.Asset.createWithBundle=function(zipFilePath,entryFile,delegate){var asset=new gaf.Asset;return asset.initWithGAFBundle(zipFilePath,entryFile,delegate),asset},cc.EventHelper.prototype.apply(gaf.Asset.prototype),(gaf=gaf||{})._stateHasCtx=function(state){if(state.hasColorTransform&&(state.colorTransform.offset.r>0||state.colorTransform.offset.g>0||state.colorTransform.offset.b>0||state.colorTransform.offset.a>0))return!0;if(state.hasEffect)for(var i=0,total=state.effect.length;i<total;++i)if(state.effect[i].type===gaf.EFFECT_COLOR_MATRIX)return!0;return!1},gaf.Object=cc.Node.extend({_asset:null,_className:"GAFObject",_id:gaf.IDNONE,_gafproto:null,_parentTimeLine:null,_lastVisibleInFrame:0,_filterStack:null,_cascadeColorMult:null,_cascadeColorOffset:null,_needsCtx:!1,_usedAtlasScale:1,ctor:function(scale){1==arguments.length&&(this._usedAtlasScale=scale),this._super(),this._cascadeColorMult=cc.color(255,255,255,255),this._cascadeColorOffset=cc.color(0,0,0,0),this._filterStack=[]},setAnimationStartedNextLoopDelegate:function(delegate){},setAnimationFinishedPlayDelegate:function(delegate){},setLooped:function(looped){},getBoundingBoxForCurrentFrame:function(){return null},setFps:function(fps){},getObjectByName:function(name){return null},clearSequence:function(){},getIsAnimationRunning:function(){return!1},getSequences:function(){return[]},gotoAndStop:function(value){},getStartFrame:function(frameLabel){return gaf.IDNONE},setFramePlayedDelegate:function(delegate){},getCurrentFrameIndex:function(){return gaf.IDNONE},getTotalFrameCount:function(){return 0},start:function(){},stop:function(){},isVisibleInCurrentFrame:function(){return!(this._parentTimeLine&&this._parentTimeLine.getCurrentFrameIndex()+1!=this._lastVisibleInFrame)},isDone:function(){return!0},playSequence:function(name,looped,resume){return!1},isReversed:function(){return!1},setSequenceDelegate:function(delegate){},setFrame:function(index){return!1},setControlDelegate:function(func){},getEndFrame:function(frameLabel){return gaf.IDNONE},pauseAnimation:function(){},gotoAndPlay:function(value){},isLooped:function(){return!1},resumeAnimation:function(){},setReversed:function(reversed){},hasSequences:function(){return!1},getFps:function(){return 60},setLocator:function(locator){},setExternalTransform:function(affineTransform){cc.affineTransformEqualToTransform(this._additionalTransform,affineTransform)||this.setAdditionalTransform(affineTransform)},getExternalTransform:function(){return this._additionalTransform},setAnimationRunning:function(){},_enableTick:function(val){},_resetState:function(){},_updateVisibility:function(state,parent){var alphaOffset=state.hasColorTransform?state.colorTransform.offset.a:0;this.setOpacity(state.alpha+alphaOffset)},isVisible:function(){return this.getOpacity()>0},visit:function(parentCmd){this.isVisibleInCurrentFrame()&&this._super(parentCmd)},_getFilters:function(){return null},_processAnimation:function(){},_applyState:function(state,parent){this._applyStateSuper(state,parent)},_applyStateSuper:function(state,parent){if(this._needsCtx=parent._needsCtx,this._filterStack.length=0,this._parentTimeLine=parent,1!=this._usedAtlasScale){var newMat=cc.clone(state.matrix);newMat.tx*=this._usedAtlasScale,newMat.ty*=this._usedAtlasScale,this.setExternalTransform(newMat)}else this.setExternalTransform(state.matrix);state.hasEffect&&(this._filterStack=this._filterStack.concat(state.effect),this._needsCtx=!0),parent._filterStack&&parent._filterStack.length>0&&(this._filterStack=this._filterStack.concat(parent._filterStack)),this._filterStack.length>0&&this._filterStack[0].type===gaf.EFFECT_COLOR_MATRIX&&(this._needsCtx=!0),state.hasColorTransform?(this._cascadeColorMult.r=state.colorTransform.mult.r*parent._cascadeColorMult.r/255,this._cascadeColorMult.g=state.colorTransform.mult.g*parent._cascadeColorMult.g/255,this._cascadeColorMult.b=state.colorTransform.mult.b*parent._cascadeColorMult.b/255,this._cascadeColorMult.a=state.colorTransform.mult.a*parent._cascadeColorMult.a/255,this._cascadeColorOffset.r=state.colorTransform.offset.r+parent._cascadeColorOffset.r,this._cascadeColorOffset.g=state.colorTransform.offset.g+parent._cascadeColorOffset.g,this._cascadeColorOffset.b=state.colorTransform.offset.b+parent._cascadeColorOffset.b,this._cascadeColorOffset.a=state.colorTransform.offset.a+parent._cascadeColorOffset.a):(this._cascadeColorMult.r=parent._cascadeColorMult.r,this._cascadeColorMult.g=parent._cascadeColorMult.g,this._cascadeColorMult.b=parent._cascadeColorMult.b,this._cascadeColorMult.a=state.alpha*(parent._cascadeColorMult.a/255),this._cascadeColorOffset.r=parent._cascadeColorOffset.r,this._cascadeColorOffset.g=parent._cascadeColorOffset.g,this._cascadeColorOffset.b=parent._cascadeColorOffset.b,this._cascadeColorOffset.a=parent._cascadeColorOffset.a),(this._cascadeColorOffset.r>0||this._cascadeColorOffset.g>0||this._cascadeColorOffset.b>0||this._cascadeColorOffset.a>0)&&(this._needsCtx=!0)},_initRendererCmd:function(){this._renderCmd=cc.renderer.getRenderCmd(this),this._renderCmd._visit=this._renderCmd.visit;var self=this;this._renderCmd.visit=function(parentCmd){self.isVisibleInCurrentFrame()&&this._visit(parentCmd)}},_getNode:function(){return this},setAnchorPoint:function(point,y){void 0===y?this._super(point.x,point.y-1):this._super(point,y-1)}}),gaf.Object._createNullObject=function(){var ret=new gaf.Object;return ret.isVisible=function(){return!0},ret},gaf.TimeLine=gaf.Object.extend({_className:"GAFTimeLine",_objects:null,_container:null,_animationStartedNextLoopDelegate:null,_animationFinishedPlayDelegate:null,_framePlayedDelegate:null,_sequenceDelegate:null,_fps:60,_frameTime:1/60,_currentSequenceStart:gaf.FIRST_FRAME_INDEX,_currentSequenceEnd:gaf.FIRST_FRAME_INDEX,_totalFrameCount:0,_isRunning:!1,_isLooped:!1,_isReversed:!1,_timeDelta:0,_animationsSelectorScheduled:!1,_currentFrame:gaf.FIRST_FRAME_INDEX,setAnimationStartedNextLoopDelegate:function(delegate){this._animationStartedNextLoopDelegate=delegate},setAnimationFinishedPlayDelegate:function(delegate){this._animationFinishedPlayDelegate=delegate},setLooped:function(looped,recursively){this._isLooped=looped,recursively&&this._objects.forEach(function(item){item.setLooped(looped,recursively)})},getBoundingBoxForCurrentFrame:function(){var result=null,isFirstObj=!0;return this._objects.forEach(function(item){if(item.isVisibleInCurrentFrame()&&item.isVisible()){var bb=item.getBoundingBoxForCurrentFrame();bb||(bb=item.getBoundingBox()),isFirstObj?(isFirstObj=!1,result=bb):result=cc.rectUnion(result,bb)}}),cc._rectApplyAffineTransformIn(result,this._container.getNodeToParentTransform())},setFps:function(fps){cc.assert(0!==fps,"Error! Fps is set to zero."),this._fps=fps,this._frameTime=1/fps},getObjectByName:function(name){var elements=name.split("."),result=null,retId=-1,timeLine=this,BreakException={};try{elements.forEach(function(element){var parts=timeLine._gafproto.getNamedParts();if(!parts.hasOwnProperty(element))throw BreakException.lastElement=element,BreakException;retId=parts[element],result=timeLine._objects[retId],timeLine=result})}catch(e){if(e!==BreakException)throw e;return cc.log("Sequence incorrect: `"+name+"` At: `"+BreakException.lastElement+"`"),null}return result},clearSequence:function(){this._currentSequenceStart=gaf.FIRST_FRAME_INDEX,this._currentSequenceEnd=this._gafproto.getTotalFrames()},getIsAnimationRunning:function(){return this._isRunning},gotoAndStop:function(value){var frame=0;return frame="string"==typeof value?this.getStartFrame(value):value,!!this.setFrame(frame)&&(this.setAnimationRunning(!1,!1),!0)},gotoAndPlay:function(value){var frame=0;return frame="string"==typeof value?this.getStartFrame(value):value,!!this.setFrame(frame)&&(this.setAnimationRunning(!0,!1),!0)},getStartFrame:function(frameLabel){var seq=this._gafproto.getSequences()[frameLabel];return seq?seq.start:gaf.IDNONE},getEndFrame:function(frameLabel){var seq=this._gafproto.getSequences()[frameLabel];return seq?seq.end:gaf.IDNONE},setFramePlayedDelegate:function(delegate){this._framePlayedDelegate=delegate},getCurrentFrameIndex:function(){return this._showingFrame},getTotalFrameCount:function(){return this._gafproto.getTotalFrames()},start:function(){this._enableTick(!0),this._isRunning||(this._currentFrame=gaf.FIRST_FRAME_INDEX,this.setAnimationRunning(!0,!0))},stop:function(){this._enableTick(!1),this._isRunning&&(this._currentFrame=gaf.FIRST_FRAME_INDEX,this.setAnimationRunning(!1,!0))},isDone:function(){return!this._isLooped&&(this._isReversed?this._currentFrame<gaf.FIRST_FRAME_INDEX-1:this._currentFrame>this._totalFrameCount)},getSequences:function(){return this._gafproto.getSequences()},playSequence:function(name,looped){var s=this.getStartFrame(name),e=this.getEndFrame(name);return gaf.IDNONE!==s&&gaf.IDNONE!==e&&(this._currentSequenceStart=s,this._currentSequenceEnd=e,this._currentFrame<this._currentSequenceStart||(this._currentFrame,this._currentSequenceEnd),this._currentFrame=this._currentSequenceStart,this.setLooped(looped,!1),this.resumeAnimation(),!0)},isReversed:function(){return this._isReversed},setSequenceDelegate:function(delegate){this._sequenceDelegate=delegate},setFrame:function(index){return index>=gaf.FIRST_FRAME_INDEX&&index<this._totalFrameCount&&(this._showingFrame=index,this._currentFrame=index,this._processAnimation(),!0)},pauseAnimation:function(){this._isRunning&&this.setAnimationRunning(!1,!1)},isLooped:function(){return this._isLooped},resumeAnimation:function(){this._isRunning||this.setAnimationRunning(!0,!1)},setReversed:function(reversed){this._isReversed=reversed},hasSequences:function(){return this._gafproto.getSequences().length>0},getFps:function(){return this._fps},ctor:function(gafTimeLineProto,scale){this._super(scale),this._objects=[],cc.assert(gafTimeLineProto,"Error! Missing mandatory parameter."),this._gafproto=gafTimeLineProto},setExternalTransform:function(affineTransform){cc.affineTransformEqualToTransform(this._container._additionalTransform,affineTransform)||this._container.setAdditionalTransform(affineTransform)},_init:function(){this.setContentSize(this._gafproto.getBoundingBox()),this._currentSequenceEnd=this._gafproto.getTotalFrames(),this._totalFrameCount=this._currentSequenceEnd,this.setFps(this._gafproto.getFps()),this._container=new cc.Node,this.addChild(this._container);var self=this,asset=this._gafproto.getAsset();this._gafproto.getObjects().forEach(function(object){var objectProto=asset._getProtos()[object];cc.assert(objectProto,"Error. GAF proto for type: "+object.type+" and reference id: "+object+" not found."),self._objects[object]=objectProto._gafConstruct()})},_enableTick:function(val){!this._animationsSelectorScheduled&&val?(this.schedule(this._processAnimations),this._animationsSelectorScheduled=!0):this._animationsSelectorScheduled&&!val&&(this.unschedule(this._processAnimations),this._animationsSelectorScheduled=!1)},_processAnimations:function(dt){for(this._timeDelta+=dt;this._timeDelta>=this._frameTime;)this._timeDelta-=this._frameTime,this._step()},_step:function(){if(this._showingFrame=this._currentFrame,this.getIsAnimationRunning()){if(this._sequenceDelegate){var seq;(seq=this._isReversed?this._getSequenceByFirstFrame(this._currentFrame+1):this._getSequenceByLastFrame(this._currentFrame))&&this._sequenceDelegate(this,seq)}this._isCurrentFrameLastInSequence()&&(this._isLooped?this._animationStartedNextLoopDelegate&&this._animationStartedNextLoopDelegate(this):(this.setAnimationRunning(!1,!1),this._animationFinishedPlayDelegate&&this._animationFinishedPlayDelegate(this))),this._processAnimation(),this._currentFrame=this._nextFrame()}else this._processAnimation()},_isCurrentFrameLastInSequence:function(){return this._isReversed?this._currentFrame==this._currentSequenceStart:this._currentFrame==this._currentSequenceEnd-1},_nextFrame:function(){return this._isCurrentFrameLastInSequence()?this._isLooped?this._isReversed?this._currentSequenceEnd-1:this._currentSequenceStart:this._currentFrame:this._currentFrame+(this._isReversed?-1:1)},_processAnimation:function(){this._realizeFrame(this._container,this._currentFrame),this._framePlayedDelegate&&this._framePlayedDelegate(this,this._currentFrame)},_realizeFrame:function(out,frameIndex){var self=this,objects=self._objects,frames=self._gafproto.getFrames();if(!(frameIndex>frames.length)){var currentFrame=frames[frameIndex];if(currentFrame)for(var states=currentFrame.states,stateIdx=0,total=states.length;stateIdx<total;++stateIdx){var state=states[stateIdx],object=objects[state.objectIdRef];if(!object)return;if(state.alpha<0&&object._resetState(),object._updateVisibility(state,self),object.isVisible()){object._applyState(state,self);var parent=out;state.hasMask&&(parent=objects[state.maskObjectIdRef]._getNode(),cc.assert(parent,"Error! Mask not found.")),object._lastVisibleInFrame=1+frameIndex,gaf.TimeLine.rearrangeSubobject(parent,object,state.depth),object._step&&object._step()}}}},setAnimationRunning:function(value,recursively){this._isRunning=value,recursively&&this._objects.forEach(function(obj){obj&&obj.setAnimationRunning&&obj.setAnimationRunning(value,recursively)})},_getSequenceByLastFrame:function(){var sequences=this._gafproto.getSequences();for(var item in sequences)if(sequences.hasOwnProperty(item)&&sequences[item].end===frame+1)return item;return""},_resetState:function(){this._super(),this._currentFrame=this._currentSequenceStart},_getSequenceByFirstFrame:function(){var sequences=this._gafproto.getSequences();for(var item in sequences)if(sequences.hasOwnProperty(item)&&sequences[item].start===frame)return item;return""}}),gaf.TimeLine.rearrangeSubobject=function(out,object,depth){object.getParent()!==out?(object.removeFromParent(!1),out.addChild(object,depth)):object.setLocalZOrder(depth)},gaf.TextField=gaf.Object.extend({_className:"GAFTextField"}),gaf.Sprite=gaf.Object.extend({_className:"GAFSprite",_hasCtx:!1,_hasFilter:!1,ctor:function(gafSpriteProto,usedScale){this._super(usedScale),cc.assert(gafSpriteProto,"Error! Missing mandatory parameter."),this._gafproto=gafSpriteProto},_init:function(){var frame=this._gafproto.getFrame();cc.assert(frame instanceof cc.SpriteFrame,"Error. Wrong object type."),this._sprite=new cc.Sprite,this._sprite._renderCmd=this._gafCreateRenderCmd(this._sprite),this._sprite.initWithSpriteFrame(frame),this._sprite.setAnchorPoint(this._gafproto.getAnchor()),this.addChild(this._sprite),this._sprite.setOpacityModifyRGB(!0),cc._renderType===cc.game.RENDER_TYPE_WEBGL&&this._sprite.setBlendFunc(gl.ONE,gl.ONE_MINUS_SRC_ALPHA)},_applyState:function(state,parent){this._applyStateSuper(state,parent),this._needsCtx?(this._hasCtx||(this._enableCtx(),this._hasCtx=!0),this._applyCtxState(state)):(this._hasCtx&&(this._disableCtx(),this._hasCtx=!1),cc.colorEqual(this._sprite._realColor,this._cascadeColorMult)||this._sprite.setColor(this._cascadeColorMult),this._sprite.getOpacity()!=this._cascadeColorMult.a&&this._sprite.setOpacity(this._cascadeColorMult.a))},_enableCtx:function(){this._sprite._renderCmd._enableCtx()},_disableCtx:function(){this._sprite._renderCmd._disableCtx()},_applyCtxState:function(state){this._sprite._renderCmd._applyCtxState(this)},getBoundingBoxForCurrentFrame:function(){var result=this._sprite.getBoundingBox();return cc._rectApplyAffineTransformIn(result,this.getNodeToParentTransform())},_gafCreateRenderCmd:function(item){return cc._renderType===cc.game.RENDER_TYPE_CANVAS?new gaf.Sprite.CanvasRenderCmd(item):new gaf.Sprite.WebGLRenderCmd(item)}}),gaf.Mask=gaf.Object.extend({_className:"GAFMask",_clippingNode:null,ctor:function(gafSpriteProto){this._super(),cc.assert(gafSpriteProto,"Error! Missing mandatory parameter."),this._gafproto=gafSpriteProto},_init:function(){var maskNodeProto=this._gafproto.getMaskNodeProto();cc.assert(maskNodeProto,"Error. Mask node for id ref "+this._gafproto.getIdRef()+" not found."),this._maskNode=maskNodeProto._gafConstruct(),this._clippingNode=cc.ClippingNode.create(this._maskNode),this._clippingNode.setAlphaThreshold(.5),this.addChild(this._clippingNode)},setExternalTransform:function(affineTransform){cc.affineTransformEqualToTransform(this._maskNode._additionalTransform,affineTransform)||this._maskNode.setAdditionalTransform(affineTransform)},_getNode:function(){return this._clippingNode}}),function(){gaf.Sprite.CanvasRenderCmd=function(renderable){cc.Sprite.CanvasRenderCmd.call(this,renderable),this._hasTintMult=!1,this._hasTintOffset=!1,this._hasCtx=!1,this._tintMult=cc.color(255,255,255,255),this._tintOffset=cc.color(0,0,0,0),this._textureDirty=!1};var proto=gaf.Sprite.CanvasRenderCmd.prototype=Object.create(cc.Sprite.CanvasRenderCmd.prototype);proto.constructor=gaf.Sprite.CanvasRenderCmd,proto._disableCtx=function(){this._hasTintOffset=!1,this._hasCtx=!1,this._textureDirty=!0,this.setDirtyFlag(cc.Node._dirtyFlags.colorDirty),this._tintMult=cc.color(255,255,255,255),this._tintOffset=cc.color(0,0,0,0)},proto._enableCtx=function(){},proto._applyCtxState=function(gafObject){var tintMult=gafObject._cascadeColorMult,tintOffset=gafObject._cascadeColorOffset,opacity=tintMult.a;this._node.getOpacity()!=opacity&&this._node.setOpacity(opacity);var multDirty=!cc.colorEqual(this._tintMult,tintMult);multDirty&&(this._node.setColor(tintMult),this._tintMult=tintMult,this._hasTintMult=255!==tintMult.r||255!==tintMult.g||255!==tintMult.b);var offfsetDirty=this._tintOffset.r!=tintOffset.r||this._tintOffset.g!=tintOffset.g||this._tintOffset.b!=tintOffset.b||this._tintOffset.a!=tintOffset.a;offfsetDirty&&(this._tintOffset=tintOffset,this._hasTintOffset=0!==tintOffset.r||0!==tintOffset.g||0!==tintOffset.b||0!==tintOffset.a),this._textureDirty=multDirty||offfsetDirty,this._textureDirty&&this.setDirtyFlag(cc.Node._dirtyFlags.colorDirty),this._hasCtx=gafObject._filterStack.length>0&&gafObject._filterStack[0].type===gaf.EFFECT_COLOR_MATRIX},proto.rendering=function(ctx,scaleX,scaleY){var node=this._node,locTextureCoord=this._textureCoord,alpha=this._displayedOpacity/255;if((!node._texture||0!==locTextureCoord.width&&0!==locTextureCoord.height&&node._texture._textureLoaded)&&0!==alpha){var image,wrapper=ctx||cc._renderContext,context=wrapper.getContext(),locX=node._offsetPosition.x,locHeight=node._rect.height,locWidth=node._rect.width,locY=-node._offsetPosition.y-locHeight;wrapper.setTransform(this._worldTransform,scaleX,scaleY),wrapper.setCompositeOperation(this._blendFuncStr),wrapper.setGlobalAlpha(alpha),(node._flippedX||node._flippedY)&&wrapper.save(),node._flippedX&&(locX=-locX-locWidth,context.scale(-1,1)),node._flippedY&&(locY=node._offsetPosition.y,context.scale(1,-1)),image=node._texture._htmlElementObj,this._colorized?context.drawImage(image,0,0,locTextureCoord.width,locTextureCoord.height,locX*scaleX,locY*scaleY,locWidth*scaleX,locHeight*scaleY):context.drawImage(image,locTextureCoord.renderX,locTextureCoord.renderY,locTextureCoord.width,locTextureCoord.height,locX*scaleX,locY*scaleY,locWidth*scaleX,locHeight*scaleY),(node._flippedX||node._flippedY)&&wrapper.restore(),cc.g_NumberOfDraws++}},cc.sys._supportCanvasNewBlendModes&&(proto._updateColor=function(){var displayedColor=this._displayedColor,node=this._node;if(this._hasTintMult|=255!==displayedColor.r||255!==displayedColor.g||255!==displayedColor.b,this._textureDirty){this._textureDirty=!1,this._colorized&&(this._colorized=!1,node.texture=this._originalTexture);var locElement,locTexture=node._texture,locRect=this._textureCoord;if(this._hasTintMult&&locTexture&&locRect.validRect&&this._originalTexture){if(!(locElement=locTexture.getHtmlElementObj()))return;this._colorized=!0,(this._hasTintOffset||this._hasCtx)&&(displayedColor=this._tintMult),locElement=cc.Sprite.CanvasRenderCmd._generateTintImageWithMultiply(this._originalTexture._htmlElementObj,displayedColor,locRect),(locTexture=new cc.Texture2D).initWithElement(locElement),locTexture.handleLoadedTexture(),node.texture=locTexture}if(locTexture=node._texture,this._hasTintOffset){var cacheTextureForColor=cc.textureCache.getTextureColors(this._originalTexture.getHtmlElementObj());if(locTexture&&locRect.validRect&&this._originalTexture){if(!(locElement=locTexture.getHtmlElementObj()))return;if(this._colorized)var texRect=cc.rect(0,0,locRect.width,locRect.height);else texRect=locRect;locElement=this._gafGenerateTintImage(node.texture._htmlElementObj,texRect,cacheTextureForColor,this._tintOffset,locRect),(locTexture=new cc.Texture2D).initWithElement(locElement),locTexture.handleLoadedTexture(),node.texture=locTexture,this._colorized=!0}}}},proto._gafGenerateTintImage=function(texture,texRect,tintedImgCache,color,rect,renderCanvas){rect||(rect=cc.rect(0,0,texture.width,texture.height));var ctx,w=Math.min(rect.width,tintedImgCache[0].width),h=Math.min(rect.height,tintedImgCache[0].height),buff=renderCanvas;return buff?(ctx=buff.getContext("2d")).clearRect(0,0,w,h):((buff=document.createElement("canvas")).width=w,buff.height=h,ctx=buff.getContext("2d")),ctx.save(),ctx.globalCompositeOperation="source-over",ctx.drawImage(tintedImgCache[2],rect.x,rect.y,w,h,0,0,w,h),ctx.globalCompositeOperation="source-in",ctx.fillStyle="rgba("+Math.round(color.r)+","+Math.round(color.g)+","+Math.round(color.b)+",1)",ctx.fillRect(0,0,w,h),ctx.globalCompositeOperation="lighter",ctx.drawImage(texture,texRect.x,texRect.y,w,h,0,0,w,h),ctx.restore(),buff})}(),function(){gaf.Sprite.WebGLRenderCmd=function(renderable){cc.Sprite.WebGLRenderCmd.call(this,renderable),this._defualtShader=cc.shaderCache.programForKey(cc.SHADER_POSITION_TEXTURECOLOR),this._customShader=gaf._Shaders.Alpha,this._tintMult=null,this._tintOffset=null,this._ctxMatrixBody=null,this._ctxMatrixAppendix=null};var proto=gaf.Sprite.WebGLRenderCmd.prototype=Object.create(cc.Sprite.WebGLRenderCmd.prototype);proto.constructor=gaf.Sprite.WebGLRenderCmd,proto._identityVec=[1,1,1,1],proto._zeroVec=[0,0,0,0],proto._identityMat=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],proto._disableCtx=function(){this.setShaderProgram(this._defualtShader)},proto._enableCtx=function(){this.setShaderProgram(this._customShader)},proto._applyCtxState=function(gafObject){var tintMult=gafObject._cascadeColorMult;this._tintMult=[tintMult.r/255,tintMult.g/255,tintMult.b/255,tintMult.a/255];var tintOffset=gafObject._cascadeColorOffset;this._tintOffset=[tintOffset.r/255,tintOffset.g/255,tintOffset.b/255,tintOffset.a/255];var filterStack=gafObject._filterStack;if(filterStack&&filterStack.length>0&&filterStack[0].type===gaf.EFFECT_COLOR_MATRIX){var m=filterStack[0].colorMatrix;this._ctxMatrixBody=[m.rr,m.rg,m.rb,m.ra,m.gr,m.gg,m.gb,m.ga,m.br,m.bg,m.bb,m.ba,m.ar,m.ag,m.ab,m.aa],this._ctxMatrixAppendix=[m.r/255,m.g/255,m.b/255,m.a/255]}else this._ctxMatrixBody=null,this._ctxMatrixAppendix=null},proto._setUniforms=function(){this._shaderProgram===this._customShader&&(this._shaderProgram.use(),this._shaderProgram.setUniformLocationWith4fv(gaf._Uniforms.ColorTransformMult,this._tintMult,1),this._shaderProgram.setUniformLocationWith4fv(gaf._Uniforms.ColorTransformOffset,this._tintOffset,1),this._ctxMatrixBody&&this._ctxMatrixAppendix?(this._shaderProgram.setUniformLocationWithMatrix4fv(gaf._Uniforms.ColorMatrixBody,this._ctxMatrixBody,1),this._shaderProgram.setUniformLocationWith4fv(gaf._Uniforms.ColorMatrixAppendix,this._ctxMatrixAppendix,1)):(this._shaderProgram.setUniformLocationWithMatrix4fv(gaf._Uniforms.ColorMatrixBody,this._identityMat,1),this._shaderProgram.setUniformLocationWith4fv(gaf._Uniforms.ColorMatrixAppendix,this._zeroVec,1)))},proto.rendering=function(ctx){this._setUniforms(),cc.Sprite.WebGLRenderCmd.prototype.rendering.call(this,ctx)}}(),gaf._TimeLineProto=function(asset,animationFrameCount,boundingBox,pivotPoint,id,linkageName){id=void 0!==id?id:0,linkageName=linkageName||"",this._objects=[],this.getTotalFrames=function(){return animationFrameCount},this.getBoundingBox=function(){return boundingBox},this.getId=function(){return id},this.getLinkageName=function(){return linkageName},this.getPivot=function(){return pivotPoint},this.getRect=function(){return boundingBox},this.getNamedParts=function(){return{}},this.getSequences=function(){return{}},this.getFrames=function(){return[]},this.getFps=function(){return 60},this.getObjects=function(){return this._objects},this.getAsset=function(){return asset},this._gafConstruct=function(){var usedScale=this.getAsset()._usedAtlasScale,ret=new gaf.TimeLine(this,usedScale);return ret._init(),ret}},gaf._SpriteProto=function(asset,atlasFrames,elementAtlasIdRef){this.getFrames=function(){return atlasFrames},this.getIdRef=function(){return elementAtlasIdRef},this.getAsset=function(){return asset},this._gafConstruct=function(){var usedScale=this.getAsset()._usedAtlasScale,ret=new gaf.Sprite(this,usedScale);return ret._init(),ret}},gaf._SpriteProto.prototype.getFrame=function(){var usedScale=this.getAsset()._usedAtlasScale;cc.assert(usedScale,"Error. Atlas scale zero.");var frames=this.getFrames()[usedScale];return cc.assert(frames,"Error. No frames found for used scale `"+usedScale+"`"),frames[this.getIdRef()]},gaf._SpriteProto.prototype.getAnchor=function(){return this.getFrame()._gafAnchor},gaf._MaskProto=function(asset,mask,idRef){this.getIdRef=function(){return idRef},this.getMaskNodeProto=function(){return mask},this._gafConstruct=function(){var ret=new gaf.Mask(this);return ret._init(),ret}},gaf.ReadSingleTag=function(stream){var tagId=stream.Ushort(),tag=gaf.Tags[tagId],result={};return void 0===tag?(console.log("GAF. Non implemented tag detected."),gaf.Tags.Default.parse(stream,tagId)):result=tag.parse(stream,tagId),result},gaf.ReadTags=function(stream){var tags=[];try{do{var tag=gaf.ReadSingleTag(stream);tags.push(tag)}while(0!=tag.tagId)}catch(e){if(!(e instanceof Error&&"GAF format error"==e.message))throw console.log(e.stack),e;console.log("GAF format error:\n"+e.stack)}return tags},gaf.Tag=function(){this.Default=Object.create(gaf.Tag.base),this[0]=Object.create(gaf.Tag.End),this[1]=Object.create(gaf.Tag.DefineAtlas),this[2]=Object.create(gaf.Tag.DefineAnimationMasks),this[3]=Object.create(gaf.Tag.DefineAnimationObjects),this[4]=Object.create(gaf.Tag.DefineAnimationFrames),this[5]=Object.create(gaf.Tag.DefineNamedParts),this[6]=Object.create(gaf.Tag.DefineSequences),this[7]=Object.create(gaf.Tag.DefineTextFields),this[8]=Object.create(gaf.Tag.DefineAtlas2),this[9]=Object.create(gaf.Tag.DefineStage),this[10]=Object.create(gaf.Tag.DefineAnimationObjects2),this[11]=Object.create(gaf.Tag.DefineAnimationMasks2),this[12]=Object.create(gaf.Tag.DefineAnimationFrames2),this[13]=Object.create(gaf.Tag.DefineTimeline)},gaf.Tag.base=function(){},gaf.Tag.base.parse=function(stream,tagId){var size=stream.Uint();stream.startNestedBuffer(size);var result=this.doParse(stream);return stream.endNestedBuffer(),result.tagName=this.tagName,result.tagId=tagId,result},gaf.Tag.base.doParse=function(stream){return{}},gaf.Tag.End=Object.create(gaf.Tag.base),gaf.Tag.End.tagName="TagEnd",gaf.Tag.DefineAtlas=Object.create(gaf.Tag.base),gaf.Tag.DefineAtlas.tagName="TagDefineAtlas",gaf.Tag.DefineAtlas.doParse=function(s){return{content:s.fields("scale","Float","atlases",s.array("Ubyte",s.fields("id","Uint","sources",s.array("Ubyte",s.fields("source","String","csf","Float")))),"elements",s.array("Uint",s.fields("pivot","Point","origin","Point","scale","Float","size","Point","atlasId","Uint","elementAtlasId","Uint")))()}},gaf.Tag.DefineAnimationMasks=Object.create(gaf.Tag.base),gaf.Tag.DefineAnimationMasks.tagName="TagDefineAnimationMasks",gaf.Tag.DefineAnimationMasks.doParse=function(s){return{content:s.array("Uint",s.fields("objectId","Uint","elementAtlasIdRef","Uint"))()}},gaf.Tag.DefineAnimationObjects=Object.create(gaf.Tag.base),gaf.Tag.DefineAnimationObjects.tagName="TagDefineAnimationObjects",gaf.Tag.DefineAnimationObjects.doParse=function(s){return{content:s.array("Uint",s.fields("objectId","Uint","elementAtlasIdRef","Uint"))()}},gaf.Tag.DefineAnimationFrames=Object.create(gaf.Tag.base),gaf.Tag.DefineAnimationFrames.tagName="TagDefineAnimationFrames",gaf.Tag.DefineAnimationFrames.doParse=function(s){return{content:s.array("Uint",s.fields("frame","Uint","state",s.array("Uint",s.fields("hasColorTransform","Ubyte","hasMask","Ubyte","hasEffect","Ubyte","objectIdRef","Uint","depth","Int","alpha","Float","matrix","Matrix","colorTransform",s.condition("hasColorTransform",1,s.fields("alphaOffset","Float","redMultiplier","Float","redOffset","Float","greenMultiplier","Float","greenOffset","Float","blueMultiplier","Float","blueOffset","Float")),"effect",s.condition("hasEffect",1,s.array("Ubyte",gaf.Tag._readFilter(s))),"maskObjectIdRef",s.condition("hasMask",1,s.fields("maskObjectIdRef","Uint"))))))()}},gaf.Tag.DefineNamedParts=Object.create(gaf.Tag.base),gaf.Tag.DefineNamedParts.tagName="TagDefineNamedParts",gaf.Tag.DefineNamedParts.doParse=function(s){return{content:s.array("Uint",s.fields("objectId","Uint","name","String"))()}},gaf.Tag.DefineSequences=Object.create(gaf.Tag.base),gaf.Tag.DefineSequences.tagName="TagDefineSequences",gaf.Tag.DefineSequences.doParse=function(s){return{content:s.array("Uint",s.fields("id","String","start","Ushort","end","Ushort"))()}},gaf.Tag.DefineTextFields=Object.create(gaf.Tag.base),gaf.Tag.DefineTextFields.tagName="TagDefineTextFields",gaf.Tag.DefineTextFields.doParse=function(s){return{content:s.array("Uint",s.fields("id","Uint","pivot","Point","end","Ushort","width","Float","height","Float","text","String","embedFonts","Boolean","multiline","Boolean","wordWrap","Boolean","hasRestrict","Boolean","restrict",s.condition("hasRestrict",1,function(){return s.String}),"editable","Boolean","selectable","Boolean","displayAsPassword","Boolean","maxChars","Uint","align","Uint","blockIndent","Uint","bold","Boolean","bullet","Boolean","color","color","font","String","indent","Uint","italic","Boolean","kerning","Boolean","leading","Uint","leftMargin","Uint","letterSpacing","Float","rightMargin","Uint","size","Uint","tabStops",s.array("Uint",s.fields("value","Uint")),"target","string","underline","Boolean","url","String"))()}},gaf.Tag.DefineAtlas2=Object.create(gaf.Tag.base),gaf.Tag.DefineAtlas2.tagName="TagDefineAtlas2",gaf.Tag.DefineAtlas2.doParse=function(s){return{content:s.fields("scale","Float","atlases",s.array("Ubyte",s.fields("id","Uint","sources",s.array("Ubyte",s.fields("source","String","csf","Float")))),"elements",s.array("Uint",s.fields("pivot","Point","origin","Point","scale","Float","size","Point","atlasId","Uint","elementAtlasId","Uint","hasScale9Grid","Boolean","scale9GridRect",s.condition("hasScale9Grid",1,function(){return s.Rect()}))))()}},gaf.Tag.DefineStage=Object.create(gaf.Tag.base),gaf.Tag.DefineStage.tagName="TagDefineStage",gaf.Tag.DefineStage.doParse=function(s){return{content:s.fields("fps","Ubyte","color","color","width","Ushort","height","Ushort")()}},gaf.Tag.DefineAnimationObjects2=Object.create(gaf.Tag.base),gaf.Tag.DefineAnimationObjects2.tagName="TagDefineAnimationObjects2",gaf.Tag.DefineAnimationObjects2.doParse=function(s){return{content:s.array("Uint",s.fields("objectId","Uint","elementAtlasIdRef","Uint","type","Ushort"))()}},gaf.Tag.DefineAnimationMasks2=Object.create(gaf.Tag.base),gaf.Tag.DefineAnimationMasks2.tagName="TagDefineAnimationMasks2",gaf.Tag.DefineAnimationMasks2.doParse=function(s){return{content:s.array("Uint",s.fields("objectId","Uint","elementAtlasIdRef","Uint","type","Ushort"))()}},gaf.Tag.DefineAnimationFrames2=Object.create(gaf.Tag.base),gaf.Tag.DefineAnimationFrames2.tagName="TagDefineAnimationFrames2",gaf.Tag.DefineAnimationFrames2.doParse=function(s){return{content:s.array("Uint",s.fields("frame","Uint","hasChangesInDisplayList","Boolean","hasActions","Boolean","state",s.condition("hasChangesInDisplayList",1,s.array("Uint",s.fields("hasColorTransform","Boolean","hasMask","Boolean","hasEffect","Boolean","objectIdRef","Uint","depth","Int","alpha","Float","matrix","Matrix","colorTransform",s.condition("hasColorTransform",1,s.fields("alphaOffset","Float","redMultiplier","Float","redOffset","Float","greenMultiplier","Float","greenOffset","Float","blueMultiplier","Float","blueOffset","Float")),"effect",s.condition("hasEffect",1,s.array("Ubyte",gaf.Tag._readFilter(s))),"maskObjectIdRef",s.condition("hasMask",1,function(){return s.Uint()})))),"actions",s.condition("hasActions",1,s.array("Uint",s.fields("type","Uint","scope","String","params",gaf.Tag._readActionArguments(s))))))()}},gaf.Tag.DefineTimeline=Object.create(gaf.Tag.base),gaf.Tag.DefineTimeline.tagName="TagDefineTimeline",gaf.Tag.DefineTimeline.doParse=function(s){var result={content:s.fields("id","Uint","animationFrameCount","Uint","boundingBox","Rect","pivotPoint","Point","hasLinkage","Boolean","linkageName",s.condition("hasLinkage",1,function(){return s.String()}))()};return result.content.tags=gaf.ReadTags(s),result},gaf.Tag._readActionArguments=function(s){return function(){var size=s.Uint(),ret=[];for(s.startNestedBuffer(size);s.maxOffset()<s.tell();)ret.push(s.String());return s.endNestedBuffer(),ret}},gaf.Tag._readFilter=function(s){return s.fields("type","Uint","dropShadow",s.condition("type",gaf.EFFECT_DROP_SHADOW,s.fields("color","color","blurX","Float","blurY","Float","angle","Float","distance","Float","strength","Float","inner","Boolean","knockout","Boolean")),"blur",s.condition("type",gaf.EFFECT_BLUR,s.fields("blurX","Float","blurY","Float")),"glow",s.condition("type",gaf.EFFECT_GLOW,s.fields("color","color","blurX","Float","blurY","Float","strength","Float","inner","Boolean","knockout","Boolean")),"colorMatrix",s.condition("type",gaf.EFFECT_COLOR_MATRIX,s.fields("rr","Float","gr","Float","br","Float","ar","Float","r","Float","rg","Float","gg","Float","bg","Float","ag","Float","g","Float","rb","Float","gb","Float","bb","Float","ab","Float","b","Float","ra","Float","ga","Float","ba","Float","aa","Float","a","Float")))},gaf.Tags=new gaf.Tag,(gaf=gaf||{}).Loader=function(){var readHeaderBegin=function(stream,header){header.compression=stream.Uint(),header.versionMajor=stream.Ubyte(),header.versionMinor=stream.Ubyte(),header.fileLength=stream.Uint()},readHeaderEndV3=function(stream,header){header.framesCount=stream.Ushort(),header.frameSize=stream.Rect(),header.pivot=stream.Point()},readHeaderEndV4=function(stream,header){var scaleCount=stream.Uint();header.scaleValues=[];for(i=0;i<scaleCount;++i)header.scaleValues.push(stream.Float());var csfCount=stream.Uint();header.csfValues=[];for(var i=0;i<csfCount;++i)header.csfValues.push(stream.Float())};this.LoadFile=function(filePath,onLoaded){var oReq=new XMLHttpRequest;oReq.open("GET",filePath,!0);var self=this;oReq.responseType="arraybuffer",oReq.onload=function(oEvent){var gaf_data=new gaf.DataReader(oReq.response),gafFile=self.LoadStream(gaf_data);onLoaded&&onLoaded(gafFile)},oReq.send()},this.LoadStream=function(stream){var header={};if(readHeaderBegin(stream,header),header.compression==gaf.COMPRESSION_NONE);else{if(header.compression!=gaf.COMPRESSION_ZIP)throw new Error("GAF syntax error.");var compressed=stream.dataRaw.slice(stream.tell()),decompressed=new window.Zlib.Inflate(new Uint8Array(compressed)).decompress();stream=new gaf.DataReader(decompressed.buffer)}return header.versionMajor<4?readHeaderEndV3(stream,header):readHeaderEndV4(stream,header),{header:header,tags:gaf.ReadTags(stream)}}},gaf.DataReader=function(data){this.dataRaw=data,this.buf=new DataView(data),this.offset=[0]},gaf.DataReader.prototype.constructor=gaf.DataReader,gaf.DataReader.prototype.newOffset=function(size){if(this.offset[this.offset.length-1]+=size,this.getOffset()>this.maxOffset())throw new Error("GAF format error");return this.offset[this.offset.length-1]-size},gaf.DataReader.prototype.maxOffset=function(){return 1==this.offset.length?this.buf.byteLength:this.offset[this.offset.length-2]},gaf.DataReader.prototype.getOffset=function(size){return this.offset[this.offset.length-1]},gaf.DataReader.prototype.Ubyte=function(){return this.buf.getUint8(this.newOffset(1))},gaf.DataReader.prototype.Boolean=function(){var result=this.buf.getUint8(this.newOffset(1));if(result>1)throw new Error("GAF format error");return result},gaf.DataReader.prototype.Uint=function(){return this.buf.getUint32(this.newOffset(4),!0)},gaf.DataReader.prototype.Int=function(){return this.buf.getInt32(this.newOffset(4),!0)},gaf.DataReader.prototype.color=function(){return{b:this.Ubyte(),g:this.Ubyte(),r:this.Ubyte(),a:this.Ubyte()}},gaf.DataReader.prototype.Ushort=function(){return this.buf.getUint16(this.newOffset(2),!0)},gaf.DataReader.prototype.Float=function(){return this.buf.getFloat32(this.newOffset(4),!0)},gaf.DataReader.prototype.String=function(){var strLen=this.Ushort(),from=this.newOffset(strLen),to=this.getOffset();try{var str=this.dataRaw.slice(from,to)}catch(e){if("Object doesn't support property or method 'slice'"!=e.message)throw e;str=[];for(var i=from;i<to;++i)str.push(this.buf.getUint8(i))}return decodeURIComponent(escape(String.fromCharCode.apply(null,new Uint8Array(str))))},gaf.DataReader.prototype.startNestedBuffer=function(length){this.offset.push(this.offset[this.offset.length-1]),this.offset[this.offset.length-2]+=length},gaf.DataReader.prototype.endNestedBuffer=function(){if(1==this.offset.length)throw new Error("No nested buffer available");this.offset.pop()},gaf.DataReader.prototype.Point=function(){return{x:this.Float(),y:this.Float()}},gaf.DataReader.prototype.Rect=function(){return{x:this.Float(),y:this.Float(),width:this.Float(),height:this.Float()}},gaf.DataReader.prototype.Matrix=function(){return{a:this.Float(),b:this.Float(),c:this.Float(),d:this.Float(),tx:this.Float(),ty:this.Float()}},gaf.DataReader.prototype.seek=function(pos){this.offset[this.offset.length-1]=pos},gaf.DataReader.prototype.tell=function(){return this.offset[this.offset.length-1]},gaf.DataReader.prototype.fields=function(){var self=this,arguments_=arguments;return function(){arguments.callee.result={};var i=0;if(arguments_.length%2)throw new Error("Number of arguments is not even");for(;i<arguments_.length;){var field=arguments_[i++],func=arguments_[i++];if("function"==typeof func)arguments.callee.result[field]=func();else{if(!(func in self&&"function"==typeof self[func]))throw new Error("Object DataReader has no function `"+func+"`");arguments.callee.result[field]=self[func].call(self)}}return arguments.callee.result}},gaf.DataReader.prototype.condition=function(key,value,func){var arguments_=arguments;return function(){if(3!=arguments_.length)throw new Error("Condition function");var parent=arguments.callee.caller;if(!("result"in parent))throw new Error("Condition function caller has no key `result`");var container=parent.result,field=arguments_[0],value=arguments_[1],exec=arguments_[2];return("function"==typeof value?function(){return value(container[field])}:function(){return value==container[field]})()?exec():null}},gaf.DataReader.prototype.array=function(){var self=this,arguments_=arguments;return function(){arguments.callee.result=[];for(var length=self[arguments_[0]].call(self),i=0;i<length;++i){var r=arguments_[1].call();arguments.callee.result.push(r)}return arguments.callee.result}},gaf.SHADER_GAUSSIAN_BLUR_FRAG="varying mediump vec2 v_texCoord;\nuniform mediump vec2 u_step;\nvoid main()\n{ \n    mediump vec4 sum = vec4(0.0);                                      \n    sum += texture2D(CC_Texture0, v_texCoord - u_step * 4.0) * 0.05;   \n    sum += texture2D(CC_Texture0, v_texCoord - u_step * 3.0) * 0.09;   \n    sum += texture2D(CC_Texture0, v_texCoord - u_step * 2.0) * 0.12;   \n    sum += texture2D(CC_Texture0, v_texCoord - u_step * 1.0) * 0.15;   \n    sum += texture2D(CC_Texture0, v_texCoord + u_step * 0.0) * 0.18;   \n    sum += texture2D(CC_Texture0, v_texCoord + u_step * 1.0) * 0.15;   \n    sum += texture2D(CC_Texture0, v_texCoord + u_step * 2.0) * 0.12;   \n    sum += texture2D(CC_Texture0, v_texCoord + u_step * 3.0) * 0.09;   \n    sum += texture2D(CC_Texture0, v_texCoord + u_step * 4.0) * 0.05;   \n    gl_FragColor = sum;                                                \n} \n",gaf.SHADER_GLOW_FRAG="varying mediump vec2 v_texCoord;\nuniform mediump vec2 u_step;\nuniform mediump vec4 u_glowColor;\nvoid main()\n{ \n    mediump vec4 sum = vec4(0.0);                                      \n    sum += texture2D(CC_Texture0, v_texCoord - u_step * 4.0) * 0.05;   \n    sum += texture2D(CC_Texture0, v_texCoord - u_step * 3.0) * 0.09;   \n    sum += texture2D(CC_Texture0, v_texCoord - u_step * 2.0) * 0.12;   \n    sum += texture2D(CC_Texture0, v_texCoord - u_step * 1.0) * 0.15;   \n    sum += texture2D(CC_Texture0, v_texCoord + u_step * 0.0) * 0.18;   \n    sum += texture2D(CC_Texture0, v_texCoord + u_step * 1.0) * 0.15;   \n    sum += texture2D(CC_Texture0, v_texCoord + u_step * 2.0) * 0.12;   \n    sum += texture2D(CC_Texture0, v_texCoord + u_step * 3.0) * 0.09;   \n    sum += texture2D(CC_Texture0, v_texCoord + u_step * 4.0) * 0.05;   \n    gl_FragColor = sum * u_glowColor;                                  \n} \n",gaf.SHADER_COLOR_MATRIX_FRAG="varying mediump vec2 v_texCoord;\nvarying mediump vec4 v_fragmentColor;\nuniform mediump vec4 colorTransformMult;\nuniform mediump vec4 colorTransformOffsets;\nuniform mediump mat4 colorMatrix;\nuniform mediump vec4 colorMatrix2;\nvoid main()\n{ \n    vec4 texColor = texture2D(CC_Texture0, v_texCoord);                          \n    const float kMinimalAlphaAllowed = 1.0e-8;                                   \n    if (texColor.a > kMinimalAlphaAllowed)                                       \n    {                                                                            \n        texColor = vec4(texColor.rgb / texColor.a, texColor.a);                  \n        vec4 ctxColor = texColor * colorTransformMult + colorTransformOffsets;   \n        vec4 adjustColor = colorMatrix * ctxColor + colorMatrix2;                \n        adjustColor *= v_fragmentColor;                                          \n        texColor = vec4(adjustColor.rgb * adjustColor.a, adjustColor.a);         \n    }                                                                            \n    gl_FragColor = texColor;                                                     \n}\n",gaf._glShaderInit=function(){gaf._Uniforms={ColorTransformMult:-1,ColorTransformOffset:-1,ColorMatrixBody:-1,ColorMatrixAppendix:-1,BlurTexelOffset:-1,GlowTexelOffset:-1,GlowColor:-1},gaf._shaderCreate=function(fs,vs){var program=new cc.GLProgram,result=program.initWithVertexShaderByteArray(vs,fs);return cc.assert(result,"Shader init error"),program.addAttribute(cc.ATTRIBUTE_NAME_POSITION,cc.VERTEX_ATTRIB_POSITION),program.addAttribute(cc.ATTRIBUTE_NAME_COLOR,cc.VERTEX_ATTRIB_COLOR),program.addAttribute(cc.ATTRIBUTE_NAME_TEX_COORD,cc.VERTEX_ATTRIB_TEX_COORDS),result=program.link(),cc.assert(result,"Shader linking error"),program.updateUniforms(),program},gaf._shaderCreateAlpha=function(){var program=gaf._shaderCreate(gaf.SHADER_COLOR_MATRIX_FRAG,cc.SHADER_POSITION_TEXTURE_COLOR_VERT);return gaf._Uniforms.ColorTransformMult=program.getUniformLocationForName(gaf.UNIFORM_ALPHA_TINT_MULT),gaf._Uniforms.ColorTransformOffset=program.getUniformLocationForName(gaf.UNIFORM_ALPHA_TINT_OFFSET),gaf._Uniforms.ColorMatrixBody=program.getUniformLocationForName(gaf.UNIFORM_ALPHA_COLOR_MATRIX_BODY),gaf._Uniforms.ColorMatrixAppendix=program.getUniformLocationForName(gaf.UNIFORM_ALPHA_COLOR_MATRIX_APPENDIX),program},gaf._shaderCreateBlur=function(){var program=gaf._shaderCreate(gaf.SHADER_GAUSSIAN_BLUR_FRAG,cc.SHADER_POSITION_TEXTURE_COLOR_VERT);return gaf._Uniforms.BlurTexelOffset=program._glContext.getUniformLocation(program._programObj,gaf.UNIFORM_BLUR_TEXEL_OFFSET),program},gaf._shaderCreateGlow=function(){var program=gaf._shaderCreate(gaf.SHADER_GLOW_FRAG,cc.SHADER_POSITION_TEXTURE_COLOR_VERT);return gaf._Uniforms.GlowTexelOffset=program._glContext.getUniformLocation(program._programObj,gaf.UNIFORM_GLOW_TEXEL_OFFSET),gaf._Uniforms.GlowColor=program._glContext.getUniformLocation(program._programObj,gaf.UNIFORM_GLOW_COLOR),program},gaf._Shaders={Alpha:gaf._shaderCreateAlpha(),Blur:gaf._shaderCreateBlur(),Glow:gaf._shaderCreateGlow()}},gaf._setupShaders=function(){cc._renderType===cc.game.RENDER_TYPE_WEBGL?gaf._glShaderInit():delete gaf._glShaderInit},gaf._AtlasLoader={},gaf._AtlasLoader.execute=function(condition,success,fail){condition()?success():fail()},gaf._AtlasLoader.checkAtlas=function(atlas){return function(){return atlas&&"string"!=typeof atlas&&atlas.isLoaded()}},gaf._AtlasLoader.load=function(path,success,fail){cc.textureCache.addImage(path,function(atlas){gaf._AtlasLoader.execute(gaf._AtlasLoader.checkAtlas(atlas),function(){success(atlas)},fail)})},gaf._AtlasLoader.loadFront=function(arr,success,fail){return function(){arr.length>0?gaf._AtlasLoader.load(arr[0],success,gaf._AtlasLoader.loadFront(arr.slice(1),success,fail)):fail()}},gaf._AtlasLoader.loadArray=function(array,success,fail){gaf._AtlasLoader.loadFront(array,success,fail)()};