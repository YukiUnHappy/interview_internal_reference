cc.IMAGE_FORMAT_JPEG=0,cc.IMAGE_FORMAT_PNG=1,cc.IMAGE_FORMAT_RAWDATA=9,cc.NextPOT=function(x){return x-=1,x|=x>>1,x|=x>>2,x|=x>>4,x|=x>>8,(x|=x>>16)+1},cc.RenderTexture=cc.Node.extend({sprite:null,clearFlags:0,clearDepthVal:0,autoDraw:!1,_texture:null,_pixelFormat:0,clearStencilVal:0,_clearColor:null,_className:"RenderTexture",ctor:function(width,height,format,depthStencilFormat){cc.Node.prototype.ctor.call(this),this._cascadeColorEnabled=!0,this._cascadeOpacityEnabled=!0,this._pixelFormat=cc.Texture2D.PIXEL_FORMAT_RGBA8888,this._clearColor=new cc.Color(0,0,0,255),void 0!==width&&void 0!==height&&(format=format||cc.Texture2D.PIXEL_FORMAT_RGBA8888,depthStencilFormat=depthStencilFormat||0,this.initWithWidthAndHeight(width,height,format,depthStencilFormat)),this.setAnchorPoint(0,0)},_createRenderCmd:function(){return cc._renderType===cc.game.RENDER_TYPE_CANVAS?new cc.RenderTexture.CanvasRenderCmd(this):new cc.RenderTexture.WebGLRenderCmd(this)},visit:function(parent){if(this._visible){var renderer=cc.renderer,cmd=this._renderCmd;cmd.visit(parent&&parent._renderCmd),renderer.pushRenderCommand(cmd),this.sprite.visit(this),cmd._dirtyFlag=0}},cleanup:function(){cc.Node.prototype.onExit.call(this),this._renderCmd.cleanup()},getSprite:function(){return this.sprite},setSprite:function(sprite){this.sprite=sprite},setVirtualViewport:function(rtBegin,fullRect,fullViewport){this._renderCmd.setVirtualViewport(rtBegin,fullRect,fullViewport)},initWithWidthAndHeight:function(width,height,format,depthStencilFormat){return this._renderCmd.initWithWidthAndHeight(width,height,format,depthStencilFormat)},begin:function(){cc.renderer._turnToCacheMode(this.__instanceId),this._renderCmd.begin()},beginWithClear:function(r,g,b,a,depthValue,stencilValue){var gl=cc._renderContext;depthValue=depthValue||gl.COLOR_BUFFER_BIT,stencilValue=stencilValue||gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT,this._beginWithClear(r,g,b,a,depthValue,stencilValue,gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT|gl.STENCIL_BUFFER_BIT)},_beginWithClear:function(r,g,b,a,depthValue,stencilValue,flags){this.begin(),this._renderCmd._beginWithClear(r,g,b,a,depthValue,stencilValue,flags)},end:function(){this._renderCmd.end()},clear:function(r,g,b,a){this.beginWithClear(r,g,b,a),this.end()},clearRect:function(x,y,width,height){this._renderCmd.clearRect(x,y,width,height)},clearDepth:function(depthValue){this._renderCmd.clearDepth(depthValue)},clearStencil:function(stencilValue){this._renderCmd.clearStencil(stencilValue)},getClearFlags:function(){return this.clearFlags},setClearFlags:function(clearFlags){this.clearFlags=clearFlags},getClearColor:function(){return this._clearColor},setClearColor:function(clearColor){var locClearColor=this._clearColor;locClearColor.r=clearColor.r,locClearColor.g=clearColor.g,locClearColor.b=clearColor.b,locClearColor.a=clearColor.a,this._renderCmd.updateClearColor(clearColor)},getClearDepth:function(){return this.clearDepthVal},setClearDepth:function(clearDepth){this.clearDepthVal=clearDepth},getClearStencil:function(){return this.clearStencilVal},setClearStencil:function(clearStencil){this.clearStencilVal=clearStencil},isAutoDraw:function(){return this.autoDraw},setAutoDraw:function(autoDraw){this.autoDraw=autoDraw},saveToFile:function(filePath,format){cc.log("saveToFile isn't supported on Cocos2d-Html5")},newCCImage:function(flipImage){return cc.log("saveToFile isn't supported on cocos2d-html5"),null},listenToBackground:function(obj){},listenToForeground:function(obj){}});var _p=cc.RenderTexture.prototype;_p.clearColorVal,cc.defineGetterSetter(_p,"clearColorVal",_p.getClearColor,_p.setClearColor),cc.RenderTexture.create=function(width,height,format,depthStencilFormat){return new cc.RenderTexture(width,height,format,depthStencilFormat)},function(){cc.RenderTexture.CanvasRenderCmd=function(renderableObject){this._rootCtor(renderableObject),this._needDraw=!1,this._clearColorStr="rgba(255,255,255,1)",this._cacheCanvas=document.createElement("canvas"),this._cacheContext=new cc.CanvasContextWrapper(this._cacheCanvas.getContext("2d"))};var proto=cc.RenderTexture.CanvasRenderCmd.prototype=Object.create(cc.Node.CanvasRenderCmd.prototype);proto.constructor=cc.RenderTexture.CanvasRenderCmd,proto.cleanup=function(){this._cacheContext=null,this._cacheCanvas=null},proto.clearStencil=function(stencilValue){},proto.setVirtualViewport=function(rtBegin,fullRect,fullViewport){},proto.updateClearColor=function(clearColor){this._clearColorStr="rgba("+(0|clearColor.r)+","+(0|clearColor.g)+","+(0|clearColor.b)+","+clearColor.a/255+")"},proto.initWithWidthAndHeight=function(width,height,format,depthStencilFormat){var node=this._node,locCacheCanvas=this._cacheCanvas,locScaleFactor=cc.contentScaleFactor();locCacheCanvas.width=0|width*locScaleFactor,locCacheCanvas.height=0|height*locScaleFactor;var texture=new cc.Texture2D;texture.initWithElement(locCacheCanvas),texture.handleLoadedTexture();var locSprite=node.sprite=new cc.Sprite(texture);return locSprite.setBlendFunc(cc.ONE,cc.ONE_MINUS_SRC_ALPHA),node.autoDraw=!1,node.addChild(locSprite),!0},proto.begin=function(){},proto._beginWithClear=function(r,g,b,a,depthValue,stencilValue,flags){r=r||0,g=g||0,b=b||0,a=isNaN(a)?255:a;var context=this._cacheContext.getContext(),locCanvas=this._cacheCanvas;context.setTransform(1,0,0,1,0,0),this._cacheContext.setFillStyle("rgba("+(0|r)+","+(0|g)+","+(0|b)+","+a/255+")"),context.clearRect(0,0,locCanvas.width,locCanvas.height),context.fillRect(0,0,locCanvas.width,locCanvas.height)},proto.end=function(){var node=this._node,scale=cc.contentScaleFactor();cc.renderer._renderingToCacheCanvas(this._cacheContext,node.__instanceId,scale,scale);var spriteRenderCmd=node.sprite._renderCmd;spriteRenderCmd._notifyRegionStatus&&spriteRenderCmd._notifyRegionStatus(cc.Node.CanvasRenderCmd.RegionStatus.Dirty)},proto.clearRect=function(x,y,width,height){this._cacheContext.clearRect(x,y,width,-height)},proto.clearDepth=function(depthValue){cc.log("clearDepth isn't supported on Cocos2d-Html5")}}(),function(){cc.RenderTexture.WebGLRenderCmd=function(renderableObject){this._rootCtor(renderableObject),this._needDraw=!0,this._fBO=null,this._oldFBO=null,this._textureCopy=null,this._depthRenderBuffer=null,this._rtTextureRect=new cc.Rect,this._fullRect=new cc.Rect,this._fullViewport=new cc.Rect};var proto=cc.RenderTexture.WebGLRenderCmd.prototype=Object.create(cc.Node.WebGLRenderCmd.prototype);proto.constructor=cc.RenderTexture.WebGLRenderCmd,proto.setVirtualViewport=function(rtBegin,fullRect,fullViewport){this._rtTextureRect.x=rtBegin.x,this._rtTextureRect.y=rtBegin.y,this._fullRect=fullRect,this._fullViewport=fullViewport},proto.needDraw=function(){return this._needDraw&&this._node.autoDraw},proto.rendering=function(ctx){var gl=ctx||cc._renderContext,node=this._node;if(node.autoDraw){node.begin();var locClearFlags=node.clearFlags;if(locClearFlags){var oldClearColor=[0,0,0,0],oldDepthClearValue=0,oldStencilClearValue=0;locClearFlags&gl.COLOR_BUFFER_BIT&&(oldClearColor=gl.getParameter(gl.COLOR_CLEAR_VALUE),gl.clearColor(node._clearColor.r/255,node._clearColor.g/255,node._clearColor.b/255,node._clearColor.a/255)),locClearFlags&gl.DEPTH_BUFFER_BIT&&(oldDepthClearValue=gl.getParameter(gl.DEPTH_CLEAR_VALUE),gl.clearDepth(node.clearDepthVal)),locClearFlags&gl.STENCIL_BUFFER_BIT&&(oldStencilClearValue=gl.getParameter(gl.STENCIL_CLEAR_VALUE),gl.clearStencil(node.clearStencilVal)),gl.clear(locClearFlags),locClearFlags&gl.COLOR_BUFFER_BIT&&gl.clearColor(oldClearColor[0],oldClearColor[1],oldClearColor[2],oldClearColor[3]),locClearFlags&gl.DEPTH_BUFFER_BIT&&gl.clearDepth(oldDepthClearValue),locClearFlags&gl.STENCIL_BUFFER_BIT&&gl.clearStencil(oldStencilClearValue)}node.sortAllChildren();for(var locChildren=node._children,i=0;i<locChildren.length;i++){var getChild=locChildren[i];getChild!==node.sprite&&getChild.visit(node.sprite)}node.end()}},proto.clearStencil=function(stencilValue){var gl=cc._renderContext,stencilClearValue=gl.getParameter(gl.STENCIL_CLEAR_VALUE);gl.clearStencil(stencilValue),gl.clear(gl.STENCIL_BUFFER_BIT),gl.clearStencil(stencilClearValue)},proto.cleanup=function(){this._node;this._textureCopy=null;var gl=cc._renderContext;gl.deleteFramebuffer(this._fBO),this._depthRenderBuffer&&gl.deleteRenderbuffer(this._depthRenderBuffer)},proto.updateClearColor=function(clearColor){},proto.initWithWidthAndHeight=function(width,height,format,depthStencilFormat){var node=this._node;format===cc.Texture2D.PIXEL_FORMAT_A8&&cc.log("cc.RenderTexture._initWithWidthAndHeightForWebGL() : only RGB and RGBA formats are valid for a render texture;");var gl=cc._renderContext,locScaleFactor=cc.contentScaleFactor();this._fullRect=new cc.Rect(0,0,width,height),this._fullViewport=new cc.Rect(0,0,width,height),width=0|width*locScaleFactor,height=0|height*locScaleFactor,this._oldFBO=gl.getParameter(gl.FRAMEBUFFER_BINDING);var powW,powH;cc.configuration.supportsNPOT()?(powW=width,powH=height):(powW=cc.NextPOT(width),powH=cc.NextPOT(height));for(var dataLen=powW*powH*4,data=new Uint8Array(dataLen),i=0;i<powW*powH*4;i++)data[i]=0;this._pixelFormat=format;var locTexture=node._texture=new cc.Texture2D;if(!node._texture)return!1;locTexture.initWithData(data,node._pixelFormat,powW,powH,cc.size(width,height));var oldRBO=gl.getParameter(gl.RENDERBUFFER_BINDING);if(cc.configuration.checkForGLExtension("GL_QCOM")){if(this._textureCopy=new cc.Texture2D,!this._textureCopy)return!1;this._textureCopy.initWithData(data,node._pixelFormat,powW,powH,cc.size(width,height))}this._fBO=gl.createFramebuffer(),gl.bindFramebuffer(gl.FRAMEBUFFER,this._fBO),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,locTexture._webTextureObj,0),0!==depthStencilFormat&&(this._depthRenderBuffer=gl.createRenderbuffer(),gl.bindRenderbuffer(gl.RENDERBUFFER,this._depthRenderBuffer),gl.renderbufferStorage(gl.RENDERBUFFER,depthStencilFormat,powW,powH),depthStencilFormat===gl.DEPTH_STENCIL?gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_STENCIL_ATTACHMENT,gl.RENDERBUFFER,this._depthRenderBuffer):depthStencilFormat===gl.STENCIL_INDEX||depthStencilFormat===gl.STENCIL_INDEX8?gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.STENCIL_ATTACHMENT,gl.RENDERBUFFER,this._depthRenderBuffer):depthStencilFormat===gl.DEPTH_COMPONENT16&&gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_ATTACHMENT,gl.RENDERBUFFER,this._depthRenderBuffer)),gl.checkFramebufferStatus(gl.FRAMEBUFFER)!==gl.FRAMEBUFFER_COMPLETE&&cc.log("Could not attach texture to the framebuffer"),locTexture.setAliasTexParameters();var locSprite=node.sprite=new cc.Sprite(locTexture);return locSprite.scaleY=-1,locSprite.setBlendFunc(gl.ONE,gl.ONE_MINUS_SRC_ALPHA),gl.bindRenderbuffer(gl.RENDERBUFFER,oldRBO),gl.bindFramebuffer(gl.FRAMEBUFFER,this._oldFBO),node.autoDraw=!1,node.addChild(locSprite),!0},proto.begin=function(){var node=this._node;cc.kmGLMatrixMode(cc.KM_GL_PROJECTION),cc.kmGLPushMatrix(),cc.kmGLMatrixMode(cc.KM_GL_MODELVIEW),cc.kmGLPushMatrix();var gl=cc._renderContext,director=cc.director;director.setProjection(director.getProjection());var texSize=node._texture.getContentSizeInPixels(),size=cc.director.getWinSizeInPixels(),widthRatio=size.width/texSize.width,heightRatio=size.height/texSize.height,orthoMatrix=cc.math.Matrix4.createOrthographicProjection(-1/widthRatio,1/widthRatio,-1/heightRatio,1/heightRatio,-1,1);cc.kmGLMultMatrix(orthoMatrix);var viewport=new cc.Rect(0,0,0,0);viewport.width=this._fullViewport.width,viewport.height=this._fullViewport.height;var viewPortRectWidthRatio=viewport.width/this._fullRect.width,viewPortRectHeightRatio=viewport.height/this._fullRect.height;viewport.x=(this._fullRect.x-this._rtTextureRect.x)*viewPortRectWidthRatio,viewport.y=(this._fullRect.y-this._rtTextureRect.y)*viewPortRectHeightRatio,gl.viewport(viewport.x,viewport.y,viewport.width,viewport.height),this._oldFBO=gl.getParameter(gl.FRAMEBUFFER_BINDING),gl.bindFramebuffer(gl.FRAMEBUFFER,this._fBO),cc.configuration.checkForGLExtension("GL_QCOM")&&(gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this._textureCopy._webTextureObj,0),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,node._texture._webTextureObj,0))},proto._beginWithClear=function(r,g,b,a,depthValue,stencilValue,flags){r/=255,g/=255,b/=255,a/=255;var gl=cc._renderContext,clearColor=[0,0,0,0],depthClearValue=0,stencilClearValue=0;flags&gl.COLOR_BUFFER_BIT&&(clearColor=gl.getParameter(gl.COLOR_CLEAR_VALUE),gl.clearColor(r,g,b,a)),flags&gl.DEPTH_BUFFER_BIT&&(depthClearValue=gl.getParameter(gl.DEPTH_CLEAR_VALUE),gl.clearDepth(depthValue)),flags&gl.STENCIL_BUFFER_BIT&&(stencilClearValue=gl.getParameter(gl.STENCIL_CLEAR_VALUE),gl.clearStencil(stencilValue)),gl.clear(flags),flags&gl.COLOR_BUFFER_BIT&&gl.clearColor(clearColor[0],clearColor[1],clearColor[2],clearColor[3]),flags&gl.DEPTH_BUFFER_BIT&&gl.clearDepth(depthClearValue),flags&gl.STENCIL_BUFFER_BIT&&gl.clearStencil(stencilClearValue)},proto.end=function(){var node=this._node;cc.renderer._renderingToBuffer(node.__instanceId);var gl=cc._renderContext,director=cc.director;gl.bindFramebuffer(gl.FRAMEBUFFER,this._oldFBO),director.setViewport(),cc.kmGLMatrixMode(cc.KM_GL_PROJECTION),cc.kmGLPopMatrix(),cc.kmGLMatrixMode(cc.KM_GL_MODELVIEW),cc.kmGLPopMatrix()},proto.clearRect=function(x,y,width,height){},proto.clearDepth=function(depthValue){var node=this._node;node.begin();var gl=cc._renderContext,depthClearValue=gl.getParameter(gl.DEPTH_CLEAR_VALUE);gl.clearDepth(depthValue),gl.clear(gl.DEPTH_BUFFER_BIT),gl.clearDepth(depthClearValue),node.end()}}();