cc.LabelBMFont=cc.SpriteBatchNode.extend({_opacityModifyRGB:!1,_string:"",_config:null,_fntFile:"",_initialString:"",_alignment:cc.TEXT_ALIGNMENT_CENTER,_width:-1,_lineBreakWithoutSpaces:!1,_imageOffset:null,_textureLoaded:!1,_className:"LabelBMFont",_createRenderCmd:function(){return cc._renderType===cc.game.RENDER_TYPE_WEBGL?new cc.LabelBMFont.WebGLRenderCmd(this):new cc.LabelBMFont.CanvasRenderCmd(this)},_setString:function(newString,needUpdateLabel){needUpdateLabel?this._initialString=newString:this._string=newString;var locChildren=this._children;if(locChildren)for(var i=0;i<locChildren.length;i++){var selNode=locChildren[i];selNode&&selNode.setVisible(!1)}this._textureLoaded&&(this._string&&0<this._string.length&&this.createFontChars(),needUpdateLabel&&this.updateLabel())},ctor:function(str,fntFile,width,alignment,imageOffset){cc.SpriteBatchNode.prototype.ctor.call(this),this._imageOffset=cc.p(0,0),this._cascadeColorEnabled=!0,this._cascadeOpacityEnabled=!0,this.initWithString(str,fntFile,width,alignment,imageOffset)},textureLoaded:function(){return this._textureLoaded},addLoadedEventListener:function(callback,target){this.addEventListener("load",callback,target)},isOpacityModifyRGB:function(){return this._opacityModifyRGB},setOpacityModifyRGB:function(opacityModifyRGB){this._opacityModifyRGB=opacityModifyRGB;var locChildren=this._children;if(locChildren)for(var i=0;i<locChildren.length;i++){var node=locChildren[i];node&&(node.opacityModifyRGB=this._opacityModifyRGB)}},_changeTextureColor:function(){this._renderCmd._changeTextureColor()},init:function(){return this.initWithString(null,null,null,null,null)},initWithString:function(str,fntFile,width,alignment,imageOffset){var texture,theString=str||"";if(this._config&&cc.log("cc.LabelBMFont.initWithString(): re-init is no longer supported"),fntFile){var newConf=cc.loader.getRes(fntFile);if(!newConf&&!(newConf=cc.FntFrameCache[fntFile]||cc.FntFrameCache[cc.path.basename(fntFile)]))return cc.log("cc.LabelBMFont.initWithString(): Impossible to create font. Please check file : "+fntFile.toString()),!1;this._config=newConf,this._fntFile=fntFile;var spriteFrameBaseName=newConf.atlasName,spriteFrame=cc.spriteFrameCache.getSpriteFrame(spriteFrameBaseName)||cc.spriteFrameCache.getSpriteFrame(cc.path.basename(spriteFrameBaseName));spriteFrame?(texture=spriteFrame.getTexture(),this._spriteFrame=spriteFrame):texture=cc.textureCache.addImage(newConf.atlasName);var locIsLoaded=texture.isLoaded();(this._textureLoaded=locIsLoaded)||texture.addEventListener("load",function(sender){this._textureLoaded=!0,this.initWithTexture(sender,this._initialString.length),this.setString(this._initialString,!0),this.dispatchEvent("load")},this)}else{texture=new cc.Texture2D;var image=new Image;texture.initWithElement(image),this._textureLoaded=!1}return!!this.initWithTexture(texture,theString.length)&&(this._alignment=alignment||cc.TEXT_ALIGNMENT_LEFT,this._imageOffset=imageOffset||cc.p(0,0),this._width=void 0===width?-1:width,this._realOpacity=255,this._realColor=cc.color(255,255,255,255),this._contentSize.width=0,this._contentSize.height=0,this.setAnchorPoint(.5,.5),this.setString(theString,!0),!0)},createFontChars:function(){var i,locStr=this._string,stringLen=locStr?locStr.length:0,cmd=this._renderCmd,locTexture=cmd._texture||this._texture,nextFontPositionX=0,tmpSize=cc.size(0,0),longestLine=0,quantityOfLines=1,locCfg=this._config,locKerningDict=locCfg.kerningDict,locCommonH=locCfg.commonHeight,locFontDict=locCfg.fontDefDictionary;for(i=0;i<stringLen-1;i++)10===locStr.charCodeAt(i)&&quantityOfLines++;var fontDef,totalHeight=locCommonH*quantityOfLines,nextFontPositionY=-(locCommonH-locCommonH*quantityOfLines),prev=-1;for(i=0;i<stringLen;i++){var key=locStr.charCodeAt(i);if(0!==key)if(10!==key){var kerningAmount=locKerningDict[prev<<16|65535&key]||0;(fontDef=locFontDict[key])||(cc.log("cocos2d: LabelBMFont: character not found "+locStr[i]),fontDef={rect:{x:0,y:0,width:0,height:0},xOffset:0,yOffset:0,xAdvance:0});var rect=cc.rect(fontDef.rect.x,fontDef.rect.y,fontDef.rect.width,fontDef.rect.height);(rect=cc.rectPixelsToPoints(rect)).x+=this._imageOffset.x,rect.y+=this._imageOffset.y;var isRotated=!1;if(this._spriteFrame){locTexture.width;var spriteFrameRect=this._spriteFrame._rect;if(this._spriteFrame._rotated){isRotated=!0;var originalX=rect.x;rect.x=rect.y+spriteFrameRect.x,rect.y=originalX+spriteFrameRect.y}else rect.x=rect.x+spriteFrameRect.x,rect.y=rect.y+spriteFrameRect.y}var fontChar=this.getChildByTag(i);fontChar?cmd._updateCharTexture(fontChar,rect,key,isRotated):((fontChar=new cc.Sprite).initWithTexture(locTexture,rect,isRotated),fontChar._newTextureWhenChangeColor=!0,this.addChild(fontChar,0,i)),fontChar.opacityModifyRGB=this._opacityModifyRGB,cmd._updateCharColorAndOpacity(fontChar);var yOffset=locCfg.commonHeight-fontDef.yOffset,fontPos=cc.p(nextFontPositionX+fontDef.xOffset+.5*fontDef.rect.width+kerningAmount,nextFontPositionY+yOffset-.5*rect.height*cc.contentScaleFactor());fontChar.setPosition(cc.pointPixelsToPoints(fontPos)),prev=key,longestLine<(nextFontPositionX+=fontDef.xAdvance+kerningAmount)&&(longestLine=nextFontPositionX)}else nextFontPositionX=0,nextFontPositionY-=locCfg.commonHeight}fontDef&&fontDef.xAdvance<fontDef.rect.width?tmpSize.width=longestLine-fontDef.xAdvance+fontDef.rect.width:tmpSize.width=longestLine,tmpSize.height=totalHeight,this.setContentSize(cc.sizePixelsToPoints(tmpSize))},updateString:function(fromUpdate){var locChildren=this._children;if(locChildren)for(var i=0,li=locChildren.length;i<li;i++){var node=locChildren[i];node&&(node.visible=!1)}this._config&&this._string&&0<this._string.length&&this.createFontChars(),fromUpdate||this.updateLabel()},getString:function(){return this._initialString},setString:function(newString,needUpdateLabel){void 0===needUpdateLabel&&(needUpdateLabel=!0),void 0!==(newString=String(newString))&&"string"==typeof newString||(newString+=""),this._initialString=newString,this._setString(newString,needUpdateLabel)},_setStringForSetter:function(newString){this.setString(newString,!1)},setCString:function(label){this.setString(label,!0)},_getCharsWidth:function(startIndex,endIndex){if(endIndex<=0)return 0;var curTextFirstSprite=this.getChildByTag(startIndex),curTextLastSprite=this.getChildByTag(startIndex+endIndex);return this._getLetterPosXLeft(curTextLastSprite)-this._getLetterPosXLeft(curTextFirstSprite)},_checkWarp:function(strArr,i,maxWidth,initStringWrapNum){for(var text=strArr[i],curLength=0,strArrIndex=0;strArrIndex<i;strArrIndex++)curLength+=strArr[strArrIndex].length;curLength=curLength+i-initStringWrapNum;var allWidth=this._getCharsWidth(curLength,strArr[i].length-1);if(maxWidth<allWidth&&1<text.length){for(var sLine,fuzzyLen=text.length*(maxWidth/allWidth)|0,tmpText=text.substr(fuzzyLen),width=allWidth-this._getCharsWidth(curLength+fuzzyLen,tmpText.length-1),pushNum=0,checkWhile=0;maxWidth<width&&checkWhile++<100;)fuzzyLen*=maxWidth/width,fuzzyLen|=0,tmpText=text.substr(fuzzyLen),width=allWidth-this._getCharsWidth(curLength+fuzzyLen,tmpText.length-1);for(checkWhile=0;width<maxWidth&&checkWhile++<100;){if(tmpText){var exec=cc.LabelTTF._wordRex.exec(tmpText);pushNum=exec?exec[0].length:1,sLine=tmpText}this._lineBreakWithoutSpaces&&(pushNum=0),fuzzyLen+=pushNum,tmpText=text.substr(fuzzyLen),width=allWidth-this._getCharsWidth(curLength+fuzzyLen,tmpText.length-1)}0===(fuzzyLen-=pushNum)&&(fuzzyLen=1,sLine=sLine.substr(1));var result,sText=text.substr(0,fuzzyLen);cc.LabelTTF.wrapInspection&&cc.LabelTTF._symbolRex.test(sLine||tmpText)&&(pushNum=(result=cc.LabelTTF._lastWordRex.exec(sText))?result[0].length:0,this._lineBreakWithoutSpaces&&(pushNum=0),fuzzyLen-=pushNum,sLine=text.substr(fuzzyLen),sText=text.substr(0,fuzzyLen)),cc.LabelTTF._firsrEnglish.test(sLine)&&(result=cc.LabelTTF._lastEnglish.exec(sText))&&sText!==result[0]&&(pushNum=result[0].length,this._lineBreakWithoutSpaces&&(pushNum=0),fuzzyLen-=pushNum,sLine=text.substr(fuzzyLen),sText=text.substr(0,fuzzyLen)),strArr[i]=sLine||tmpText,strArr.splice(i,0,sText)}},updateLabel:function(){var i,j,characterSprite;if(this.string=this._initialString,0<this._width){var stringArr=this.string.split("\n"),wrapString="",newWrapNum=0,oldArrLength=0;for(i=0;i<stringArr.length;i++)oldArrLength=stringArr.length,this._checkWarp(stringArr,i,this._width*this._scaleX,newWrapNum),oldArrLength<stringArr.length&&newWrapNum++,0<i&&(wrapString+="\n"),wrapString+=stringArr[i];wrapString+=String.fromCharCode(0),this._setString(wrapString,!1)}if(this._alignment!==cc.TEXT_ALIGNMENT_LEFT)for(var lineNumber=i=0,strlen=this._string.length,last_line=[],ctr=0;ctr<strlen;ctr++)if(10!==this._string[ctr].charCodeAt(0)&&0!==this._string[ctr].charCodeAt(0))last_line.push(this._string[i]);else{var lineWidth,line_length=last_line.length;if(0===line_length){lineNumber++;continue}var index=i+line_length-1+lineNumber;if(index<0)continue;var lastChar=this.getChildByTag(index);if(null==lastChar)continue;lineWidth=lastChar.getPositionX()+lastChar._getWidth()/2;var shift=0;switch(this._alignment){case cc.TEXT_ALIGNMENT_CENTER:shift=this.width/2-lineWidth/2;break;case cc.TEXT_ALIGNMENT_RIGHT:shift=this.width-lineWidth}if(0!==shift)for(j=0;j<line_length;j++)(index=i+j+lineNumber)<0||(characterSprite=this.getChildByTag(index))&&(characterSprite.x+=shift);i+=line_length,lineNumber++,last_line.length=0}},setAlignment:function(alignment){this._alignment=alignment,this.updateLabel()},_getAlignment:function(){return this._alignment},setBoundingWidth:function(width){this._width=width,this.updateLabel()},_getBoundingWidth:function(){return this._width},setLineBreakWithoutSpace:function(breakWithoutSpace){this._lineBreakWithoutSpaces=breakWithoutSpace,this.updateLabel()},setScale:function(scale,scaleY){cc.Node.prototype.setScale.call(this,scale,scaleY),this.updateLabel()},setScaleX:function(scaleX){cc.Node.prototype.setScaleX.call(this,scaleX),this.updateLabel()},setScaleY:function(scaleY){cc.Node.prototype.setScaleY.call(this,scaleY),this.updateLabel()},setFntFile:function(fntFile){if(null!=fntFile&&fntFile!==this._fntFile){var newConf=cc.loader.getRes(fntFile);if(!newConf)return void cc.log("cc.LabelBMFont.setFntFile() : Impossible to create font. Please check file : "+fntFile.toString());this._fntFile=fntFile,this._config=newConf;var texture=cc.textureCache.addImage(newConf.atlasName),locIsLoaded=texture.isLoaded();(this._textureLoaded=locIsLoaded)?(this.setTexture(texture),this._string&&0<this._string.length&&this.createFontChars()):texture.addEventListener("load",function(sender){this._textureLoaded=!0,this.setTexture(sender),this._string&&0<this._string.length&&this.createFontChars(),this._changeTextureColor(),this.updateLabel(),this.dispatchEvent("load")},this)}},getFntFile:function(){return this._fntFile},setTexture:function(texture){this._texture=texture,this._renderCmd.setTexture(texture)},setAnchorPoint:function(point,y){cc.Node.prototype.setAnchorPoint.call(this,point,y),this.updateLabel()},_setAnchorX:function(x){cc.Node.prototype._setAnchorX.call(this,x),this.updateLabel()},_setAnchorY:function(y){cc.Node.prototype._setAnchorY.call(this,y),this.updateLabel()},_atlasNameFromFntFile:function(fntFile){},_kerningAmountForFirst:function(first,second){var ret=0,key=first<<16|65535&second;if(this._configuration.kerningDictionary){var element=this._configuration.kerningDictionary[key.toString()];element&&(ret=element.amount)}return ret},_getLetterPosXLeft:function(sp){return sp.getPositionX()*this._scaleX-sp._getWidth()*this._scaleX*sp._getAnchorX()},_getLetterPosXRight:function(sp){return sp.getPositionX()*this._scaleX+sp._getWidth()*this._scaleX*sp._getAnchorX()},_isspace_unicode:function(ch){return 9<=(ch=ch.charCodeAt(0))&&ch<=13||32===ch||133===ch||160===ch||5760===ch||8192<=ch&&ch<=8202||8232===ch||8233===ch||8239===ch||8287===ch||12288===ch},_utf8_trim_ws:function(str){var len=str.length;if(!(len<=0)){var last_index=len-1;if(this._isspace_unicode(str[last_index])){for(var i=last_index-1;0<=i&&this._isspace_unicode(str[i]);--i)last_index=i;this._utf8_trim_from(str,last_index)}}},_utf8_trim_from:function(str,index){var len=str.length;len<=index||index<0||str.splice(index,len)}}),function(){var p=cc.LabelBMFont.prototype;cc.EventHelper.prototype.apply(p),p.string,cc.defineGetterSetter(p,"string",p.getString,p._setStringForSetter),p.boundingWidth,cc.defineGetterSetter(p,"boundingWidth",p._getBoundingWidth,p.setBoundingWidth),p.textAlign,cc.defineGetterSetter(p,"textAlign",p._getAlignment,p.setAlignment),cc.defineGetterSetter(p,"texture",p.getTexture,p.setTexture)}(),cc.LabelBMFont.create=function(str,fntFile,width,alignment,imageOffset){return new cc.LabelBMFont(str,fntFile,width,alignment,imageOffset)},cc.FntFrameCache={};var _fntLoader={FNT_HEAD:/fntframes [^\n]*(\n|$)/gi,FNT_FRAME_NAME:/fntframe [^\n]*(\n|$)/gi,INFO_EXP:/info [^\n]*(\n|$)/gi,COMMON_EXP:/common [^\n]*(\n|$)/gi,PAGE_EXP:/page [^\n]*(\n|$)/gi,CHAR_EXP:/char [^\n]*(\n|$)/gi,KERNING_EXP:/kerning [^\n]*(\n|$)/gi,ITEM_EXP:/\w+=[^ \r\n]+/gi,INT_EXP:/^[\-]?\d+$/,_parseStrToObj:function(str){var arr=str.match(this.ITEM_EXP),obj={};if(arr)for(var i=0,li=arr.length;i<li;i++){var tempStr=arr[i],index=tempStr.indexOf("="),key=tempStr.substring(0,index),value=tempStr.substring(index+1);value.match(this.INT_EXP)?value=parseInt(value):'"'===value[0]&&(value=value.substring(1,value.length-1)),obj[key]=value}return obj},_parseFntContent:function(fnt,fntStr,url,useAtlas){var commonObj=this._parseStrToObj(fntStr.match(this.COMMON_EXP)[0]);if(fnt.commonHeight=commonObj.lineHeight,cc._renderType===cc.game.RENDER_TYPE_WEBGL){var texSize=cc.configuration.getMaxTextureSize();(commonObj.scaleW>texSize.width||commonObj.scaleH>texSize.height)&&cc.log("cc.LabelBMFont._parseCommonArguments(): page can't be larger than supported")}1!==commonObj.pages&&cc.log("cc.LabelBMFont._parseCommonArguments(): only supports 1 page");var pageObj=this._parseStrToObj(fntStr.match(this.PAGE_EXP)[0]);0!==pageObj.id&&cc.log("cc.LabelBMFont._parseImageFileName() : file could not be found"),fnt.atlasName=useAtlas?cc.path.join(cc.path.dirname(useAtlas.path)+pageObj.file):cc.path.changeBasename(url,pageObj.file);for(var charLines=fntStr.match(this.CHAR_EXP),fontDefDictionary=fnt.fontDefDictionary={},i=0,li=charLines.length;i<li;i++){var charObj=this._parseStrToObj(charLines[i]);fontDefDictionary[charObj.id]={rect:{x:charObj.x,y:charObj.y,width:charObj.width,height:charObj.height},xOffset:charObj.xoffset,yOffset:charObj.yoffset,xAdvance:charObj.xadvance}}var kerningDict=fnt.kerningDict={},kerningLines=fntStr.match(this.KERNING_EXP);if(kerningLines)for(i=0,li=kerningLines.length;i<li;i++){var kerningObj=this._parseStrToObj(kerningLines[i]);kerningDict[kerningObj.first<<16|65535&kerningObj.second]=kerningObj.amount}return fnt},parseFnt:function(fntStr,url){var fnt={},headString=fntStr.match(this.FNT_HEAD);if(headString){var headObj=this._parseStrToObj(headString[0]);if(headObj&&headObj.count)for(var fntFrames=(fntStr=fntStr.substr(headString[0].length)).split("----"),i=0;i<headObj.count;++i){var contentString=fntFrames[i],frameNameStr=contentString.match(this.FNT_FRAME_NAME);if(frameNameStr){var frameName=this._parseStrToObj(frameNameStr[0]);if(frameName&&frameName.name){fnt={};var realFntPathKey=cc.path.join(cc.path.dirname(url),frameName.name);cc.FntFrameCache[realFntPathKey]=this._parseFntContent(fnt,contentString.substr(frameNameStr[0].length),url,{path:frameName.name})}}}}else fnt=this._parseFntContent(fnt,fntStr,url);return fnt},load:function(realUrl,url,res,cb){var self=this;cc.loader.loadTxt(realUrl,function(err,txt){if(err)return cb(err);cb(null,self.parseFnt(txt,url))})}};cc.loader.register(["fnt"],_fntLoader),function(){cc.LabelBMFont.CanvasRenderCmd=function(renderableObject){this._rootCtor(renderableObject)};var proto=cc.LabelBMFont.CanvasRenderCmd.prototype=Object.create(cc.Node.CanvasRenderCmd.prototype);proto.constructor=cc.LabelBMFont.CanvasRenderCmd,proto._updateCharTexture=function(fontChar,rect,key){32===key?fontChar.setTextureRect(rect,!1,cc.size(0,0)):(fontChar.setTextureRect(rect,!1),fontChar.visible=!0)},proto._updateCharColorAndOpacity=function(fontChar){fontChar._displayedColor=this._displayedColor,fontChar._renderCmd.setDirtyFlag(cc.Node._dirtyFlags.colorDirty),fontChar._displayedOpacity=this._displayedOpacity,fontChar._renderCmd.setDirtyFlag(cc.Node._dirtyFlags.opacityDirty)},proto.setTexture=function(texture){for(var node=this._node,locChildren=node._children,locDisplayedColor=this._displayedColor,i=0;i<locChildren.length;i++){var selChild=locChildren[i],cm=selChild._renderCmd,childDColor=cm._displayedColor;(node._texture===cm._texture||childDColor.r===locDisplayedColor.r&&childDColor.g===locDisplayedColor.g&&childDColor.b===locDisplayedColor.b)&&(selChild.texture=texture)}node._texture=texture},proto._changeTextureColor=function(){var node=this._node,texture=node._texture,contentSize=texture.getContentSize(),oTexture=node._texture,oElement=oTexture.getHtmlElementObj(),disColor=this._displayedColor,textureRect=cc.rect(0,0,oElement.width,oElement.height);if(texture&&0<contentSize.width){if(!oElement)return;var textureToRender=oTexture._generateColorTexture(disColor.r,disColor.g,disColor.b,textureRect);node.setTexture(textureToRender)}},proto._updateChildrenDisplayedOpacity=function(locChild){cc.Node.prototype.updateDisplayedOpacity.call(locChild,this._displayedOpacity)},proto._updateChildrenDisplayedColor=function(locChild){cc.Node.prototype.updateDisplayedColor.call(locChild,this._displayedColor)}}(),function(){cc.LabelBMFont.WebGLRenderCmd=function(renderableObject){this._rootCtor(renderableObject)};var proto=cc.LabelBMFont.WebGLRenderCmd.prototype=Object.create(cc.Node.WebGLRenderCmd.prototype);proto.constructor=cc.LabelBMFont.WebGLRenderCmd,proto.setTexture=function(texture){this._node.setOpacityModifyRGB(this._node._texture.hasPremultipliedAlpha())},proto._updateCharTexture=function(fontChar,rect,key,isRotated){fontChar.setTextureRect(rect,isRotated),fontChar.visible=!0},proto._changeTextureColor=function(){},proto._updateCharColorAndOpacity=function(){}}(),cc.LabelAtlas=cc.LabelBMFont.extend({_className:"LabelAtlas",ctor:function(strText,charMapFile,itemWidth,itemHeight,startCharMap){cc.SpriteBatchNode.prototype.ctor.call(this),this._imageOffset=cc.p(0,0),this._cascadeColorEnabled=!0,this._cascadeOpacityEnabled=!0,charMapFile&&cc.LabelAtlas.prototype.initWithString.call(this,strText,charMapFile,itemWidth,itemHeight,startCharMap)},_createRenderCmd:function(){return cc._renderType===cc.game.RENDER_TYPE_WEBGL?new cc.LabelBMFont.WebGLRenderCmd(this):new cc.LabelBMFont.CanvasRenderCmd(this)},_createFntConfig:function(texture,itemWidth,itemHeight,startCharMap){var fnt={};fnt.commonHeight=itemHeight;for(var fontDefDictionary=fnt.fontDefDictionary={},textureWidth=texture.pixelsWidth,textureHeight=texture.pixelsHeight,startCharCode=startCharMap.charCodeAt(0),i=0,col=itemHeight;col<=textureHeight;col+=itemHeight)for(var row=0;row<textureWidth;row+=itemWidth)fontDefDictionary[startCharCode+i]={rect:{x:row,y:col-itemHeight,width:itemWidth,height:itemHeight},xOffset:0,yOffset:0,xAdvance:itemWidth},++i;return fnt.kerningDict={},fnt},initWithString:function(strText,charMapFile,itemWidth,itemHeight,startCharMap){var textureFilename,width,height,startChar,texture,theString=strText+""||"";if(this._initialString=theString,this._string=theString,void 0===itemWidth){var dict=cc.loader.getRes(charMapFile);if(1!==parseInt(dict.version,10))return cc.log("cc.LabelAtlas.initWithString(): Unsupported version. Upgrade cocos2d version"),!1;textureFilename=cc.path.changeBasename(charMapFile,dict.textureFilename);var locScaleFactor=cc.contentScaleFactor();width=parseInt(dict.itemWidth,10)/locScaleFactor,height=parseInt(dict.itemHeight,10)/locScaleFactor,startChar=String.fromCharCode(parseInt(dict.firstChar,10))}else textureFilename=charMapFile,width=itemWidth||0,height=itemHeight||0,startChar=startCharMap||" ";if(charMapFile){this._fntFile="dummy_fnt_file:"+textureFilename;var spriteFrameBaseName=textureFilename,spriteFrame=cc.spriteFrameCache.getSpriteFrame(spriteFrameBaseName)||cc.spriteFrameCache.getSpriteFrame(cc.path.basename(spriteFrameBaseName));spriteFrame?(texture=spriteFrame.getTexture(),this._spriteFrame=spriteFrame):texture=cc.textureCache.addImage(textureFilename);var newConf=this._createFntConfig(texture,width,height,startChar);newConf.atlasName=textureFilename,this._config=newConf;var locIsLoaded=texture.isLoaded();(this._textureLoaded=locIsLoaded)||texture.addEventListener("load",function(sender){this._textureLoaded=!0,this.initWithTexture(sender,this._initialString.length),this.setString(this._initialString,!0),this.dispatchEvent("load")},this)}else{texture=new cc.Texture2D;var image=new Image;texture.initWithElement(image),this._textureLoaded=!1}return!!this.initWithTexture(texture,theString.length)&&(this._alignment=cc.TEXT_ALIGNMENT_LEFT,this._imageOffset=cc.p(0,0),this._width=-1,this._realOpacity=255,this._realColor=cc.color(255,255,255,255),this._contentSize.width=0,this._contentSize.height=0,this.setString(theString,!0),!0)},setFntFile:function(){cc.warn("setFntFile doesn't support with LabelAtlas.")}}),cc.LabelAtlas.create=function(strText,charMapFile,itemWidth,itemHeight,startCharMap){return new cc.LabelAtlas(strText,charMapFile,itemWidth,itemHeight,startCharMap)},function(){cc.LabelAtlas.CanvasRenderCmd=function(renderableObject){cc.AtlasNode.CanvasRenderCmd.call(this,renderableObject),this._needDraw=!1};var proto=cc.LabelAtlas.CanvasRenderCmd.prototype=Object.create(cc.AtlasNode.CanvasRenderCmd.prototype);proto.constructor=cc.LabelAtlas.CanvasRenderCmd,proto.setCascade=function(){var node=this._node;node._cascadeOpacityEnabled=!0,node._cascadeColorEnabled=!1},proto.updateAtlasValues=function(){for(var node=this._node,locString=node._string||"",n=locString.length,texture=this._textureToRender,locItemWidth=node._itemWidth,locItemHeight=node._itemHeight,i=0,cr=-1;i<n;i++){var a=locString.charCodeAt(i)-node._mapStartChar.charCodeAt(0),row=parseInt(a%node._itemsPerRow,10),col=parseInt(a/node._itemsPerRow,10);if(!(row<0||col<0)){var rect=cc.rect(row*locItemWidth,col*locItemHeight,locItemWidth,locItemHeight),textureContent=texture._contentSize;if(!(rect.x<0||rect.y<0||rect.x+rect.width>textureContent.width||rect.y+rect.height>textureContent.height)){cr++;var c=locString.charCodeAt(i),fontChar=node.getChildByTag(i);fontChar?32===c?(fontChar.init(),fontChar.setTextureRect(cc.rect(0,0,10,10),!1,cc.size(0,0))):(fontChar.initWithTexture(texture,rect),fontChar.visible=!0):(fontChar=new cc.Sprite,32===c?(fontChar.init(),fontChar.setTextureRect(cc.rect(0,0,10,10),!1,cc.size(0,0))):fontChar.initWithTexture(texture,rect),cc.Node.prototype.addChild.call(node,fontChar,0,i)),fontChar.setPosition(cr*locItemWidth+locItemWidth/2,locItemHeight/2)}}}this.updateContentSize(i,cr+1)},proto.updateContentSize=function(i,cr){var node=this._node,contentSize=node._contentSize;i!==cr&&i*node._itemWidth===contentSize.width&&node._itemHeight===contentSize.height&&node.setContentSize(cr*node._itemWidth,node._itemHeight)},proto.setString=function(label){var node=this._node;if(node._children)for(var locChildren=node._children,len=locChildren.length,i=0;i<len;i++){var child=locChildren[i];child&&!child._lateChild&&(child.visible=!1)}},proto._addChild=function(){child._lateChild=!0}}(),function(){cc.LabelAtlas.WebGLRenderCmd=function(renderable){cc.AtlasNode.WebGLRenderCmd.call(this,renderable),this._needDraw=!0};var proto=cc.LabelAtlas.WebGLRenderCmd.prototype=Object.create(cc.AtlasNode.WebGLRenderCmd.prototype);proto.constructor=cc.LabelAtlas.WebGLRenderCmd,proto._updateColor=function(){if(this._colorF32Array){var locDisplayedColor=this._displayedColor,a=this._displayedOpacity/255;this._node._opacityModifyRGB?(this._colorF32Array[0]=locDisplayedColor.r*a/255,this._colorF32Array[1]=locDisplayedColor.g*a/255,this._colorF32Array[2]=locDisplayedColor.b*a/255):(this._colorF32Array[0]=locDisplayedColor.r/255,this._colorF32Array[1]=locDisplayedColor.g/255,this._colorF32Array[2]=locDisplayedColor.b/255),this._colorF32Array[3]=a}},proto.setCascade=function(){var node=this._node;node._cascadeOpacityEnabled=!0,node._cascadeColorEnabled=!0},proto.rendering=function(ctx){if(cc.AtlasNode.WebGLRenderCmd.prototype.rendering.call(this,ctx),cc.LABELATLAS_DEBUG_DRAW){var node=this._node,s=node.getContentSize(),locRect=node.getBoundingBoxToWorld(),posX=locRect.x,posY=locRect.y;s.width=locRect.width,s.height=locRect.height;var vertices=[cc.p(posX,posY),cc.p(posX+s.width,posY),cc.p(s.width+posX,s.height+posY),cc.p(posX,posY+s.height)];cc._drawingUtil.drawPoly(vertices,4,!0)}},proto.updateAtlasValues=function(){var node=this._node,locString=node._string,n=locString.length,locTextureAtlas=this._textureAtlas,texture=locTextureAtlas.texture,textureWide=texture.pixelsWidth,textureHigh=texture.pixelsHeight,itemWidthInPixels=node._itemWidth,itemHeightInPixels=node._itemHeight;node._ignoreContentScaleFactor||(itemWidthInPixels=node._itemWidth*cc.contentScaleFactor(),itemHeightInPixels=node._itemHeight*cc.contentScaleFactor()),n>locTextureAtlas.getCapacity()&&cc.log("cc.LabelAtlas._updateAtlasValues(): Invalid String length");for(var quads=locTextureAtlas.quads,locItemWidth=node._itemWidth,locItemHeight=node._itemHeight,i=0,cr=-1;i<n;i++){var a=locString.charCodeAt(i)-node._mapStartChar.charCodeAt(0),row=a%node._itemsPerRow,col=0|a/node._itemsPerRow;if(!(row<0||col<0)&&!(textureWide<row*locItemWidth+locItemWidth||textureHigh<col*locItemHeight+locItemHeight)){var left,right,top,bottom;cr++,bottom=cc.FIX_ARTIFACTS_BY_STRECHING_TEXEL?(right=(left=(2*row*itemWidthInPixels+1)/(2*textureWide))+(2*itemWidthInPixels-2)/(2*textureWide),(top=(2*col*itemHeightInPixels+1)/(2*textureHigh))+(2*itemHeightInPixels-2)/(2*textureHigh)):(right=(left=row*itemWidthInPixels/textureWide)+itemWidthInPixels/textureWide,(top=col*itemHeightInPixels/textureHigh)+itemHeightInPixels/textureHigh);var quad=quads[i],locQuadTL=quad.tl,locQuadTR=quad.tr,locQuadBL=quad.bl,locQuadBR=quad.br;locQuadTL.texCoords.u=left,locQuadTL.texCoords.v=top,locQuadTR.texCoords.u=right,locQuadTR.texCoords.v=top,locQuadBL.texCoords.u=left,locQuadBL.texCoords.v=bottom,locQuadBR.texCoords.u=right,locQuadBR.texCoords.v=bottom,locQuadBL.vertices.x=cr*locItemWidth,locQuadBL.vertices.y=0,locQuadBL.vertices.z=0,locQuadBR.vertices.x=cr*locItemWidth+locItemWidth,locQuadBR.vertices.y=0,locQuadBR.vertices.z=0,locQuadTL.vertices.x=cr*locItemWidth,locQuadTL.vertices.y=node._itemHeight,locQuadTL.vertices.z=0,locQuadTR.vertices.x=cr*locItemWidth+locItemWidth,locQuadTR.vertices.y=node._itemHeight,locQuadTR.vertices.z=0}}if(this._updateColor(),this.updateContentSize(i,cr+1),0<n){locTextureAtlas.dirty=!0;var totalQuads=locTextureAtlas.totalQuads;totalQuads<n&&locTextureAtlas.increaseTotalQuadsWith(n-totalQuads)}},proto.updateContentSize=function(i,cr){var node=this._node,contentSize=node._contentSize;i!==cr&&i*node._itemWidth===contentSize.width&&node._itemHeight===contentSize.height&&node.setContentSize(cr*node._itemWidth,node._itemHeight)},proto.setString=function(label){var len=label.length;len>this._textureAtlas.totalQuads&&this._textureAtlas.resizeCapacity(len)},proto._addChild=function(){}}();