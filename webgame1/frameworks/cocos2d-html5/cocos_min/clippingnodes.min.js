cc.stencilBits=-1,cc.ClippingNode=cc.Node.extend({inverted:!1,_alphaThreshold:0,_stencil:null,_className:"ClippingNode",_originStencilProgram:null,ctor:function(stencil){stencil=stencil||null,cc.Node.prototype.ctor.call(this),(this._stencil=stencil)&&(this._originStencilProgram=stencil.getShaderProgram()),this.alphaThreshold=1,this.inverted=!1,this._renderCmd.initStencilBits()},onEnter:function(){cc.Node.prototype.onEnter.call(this),this._stencil&&this._stencil._performRecursive(cc.Node._stateCallbackType.onEnter)},onEnterTransitionDidFinish:function(){cc.Node.prototype.onEnterTransitionDidFinish.call(this),this._stencil&&this._stencil._performRecursive(cc.Node._stateCallbackType.onEnterTransitionDidFinish)},onExitTransitionDidStart:function(){this._stencil&&this._stencil._performRecursive(cc.Node._stateCallbackType.onExitTransitionDidStart),cc.Node.prototype.onExitTransitionDidStart.call(this)},onExit:function(){this._stencil&&this._stencil._performRecursive(cc.Node._stateCallbackType.onExit),cc.Node.prototype.onExit.call(this)},visit:function(parent){this._visible&&this._renderCmd.clippingVisit(parent&&parent._renderCmd)},_visitChildren:function(){cc.renderer;this._reorderChildDirty&&this.sortAllChildren();for(var child,children=this._children,i=0,len=children.length;i<len;i++)(child=children[i])&&child._visible&&child.visit(this);this._renderCmd._dirtyFlag=0},getAlphaThreshold:function(){return this._alphaThreshold},setAlphaThreshold:function(alphaThreshold){1===alphaThreshold&&alphaThreshold!==this._alphaThreshold&&this._renderCmd.resetProgramByStencil(),this._alphaThreshold=alphaThreshold},isInverted:function(){return this.inverted},setInverted:function(inverted){this.inverted=inverted},getStencil:function(){return this._stencil},setStencil:function(stencil){this._stencil!==stencil&&(stencil&&(this._originStencilProgram=stencil.getShaderProgram()),this._renderCmd.setStencil(stencil))},_createRenderCmd:function(){return cc._renderType===cc.game.RENDER_TYPE_CANVAS?new cc.ClippingNode.CanvasRenderCmd(this):new cc.ClippingNode.WebGLRenderCmd(this)}});var _p=cc.ClippingNode.prototype;_p.stencil,cc.defineGetterSetter(_p,"stencil",_p.getStencil,_p.setStencil),_p.alphaThreshold,cc.defineGetterSetter(_p,"alphaThreshold",_p.getAlphaThreshold,_p.setAlphaThreshold),cc.ClippingNode.create=function(stencil){return new cc.ClippingNode(stencil)},function(){cc.ClippingNode.CanvasRenderCmd=function(renderable){this._rootCtor(renderable),this._needDraw=!1,this._godhelpme=!1,this._clipElemType=!1,this._rendererSaveCmd=new cc.CustomRenderCmd(this,this._saveCmdCallback),this._rendererClipCmd=new cc.CustomRenderCmd(this,this._clipCmdCallback),this._rendererRestoreCmd=new cc.CustomRenderCmd(this,this._restoreCmdCallback)};var proto=cc.ClippingNode.CanvasRenderCmd.prototype=Object.create(cc.Node.CanvasRenderCmd.prototype);proto.constructor=cc.ClippingNode.CanvasRenderCmd,proto.resetProgramByStencil=function(){},proto.initStencilBits=function(){},proto.setStencil=function(stencil){if(null!=stencil)if((this._node._stencil=stencil)instanceof cc.DrawNode){if(stencil._buffer)for(var i=0;i<stencil._buffer.length;i++)stencil._buffer[i].isFill=!1,stencil._buffer[i].isStroke=!1;stencil._renderCmd.rendering=function(ctx,scaleX,scaleY){},stencil._renderCmd._canUseDirtyRegion=!0,this._rendererSaveCmd._canUseDirtyRegion=!0,this._rendererClipCmd._canUseDirtyRegion=!0,this._rendererRestoreCmd._canUseDirtyRegion=!0}else stencil._parent=this._node},proto._saveCmdCallback=function(ctx,scaleX,scaleY){var wrapper=ctx||cc._renderContext,context=wrapper.getContext();if(this._clipElemType){var locCache=cc.ClippingNode.CanvasRenderCmd._getSharedCache(),canvas=context.canvas;locCache.width=canvas.width,locCache.height=canvas.height,locCache.getContext("2d").drawImage(canvas,0,0)}else wrapper.save(),wrapper.setTransform(this._worldTransform,scaleX,scaleY),this._node.inverted&&(context.beginPath(),context.rect(0,0,context.canvas.width,-context.canvas.height),context.clip())},proto._setStencilCompositionOperation=function(stencil){if(stencil){var node=this._node;if(stencil._renderCmd&&stencil._renderCmd._blendFuncStr&&(stencil._renderCmd._blendFuncStr=node.inverted?"destination-out":"destination-in"),stencil._children)for(var children=stencil._children,i=0,len=children.length;i<len;i++)this._setStencilCompositionOperation(children[i])}},proto._clipCmdCallback=function(ctx){var node=this._node,context=(ctx||cc._renderContext).getContext();if(this._clipElemType)this._setStencilCompositionOperation(node._stencil);else{var stencil=this._node._stencil;if(stencil instanceof cc.DrawNode){context.beginPath();var t=stencil._renderCmd._transform;context.transform(t.a,t.b,t.c,t.d,t.tx,-t.ty);for(var i=0;i<stencil._buffer.length;i++){var vertices=stencil._buffer[i].verts,firstPoint=vertices[0];context.moveTo(firstPoint.x,-firstPoint.y);for(var j=vertices.length-1;0<j;j--)context.lineTo(vertices[j].x,-vertices[j].y)}}context.clip()}},proto._restoreCmdCallback=function(ctx){var locCache=cc.ClippingNode.CanvasRenderCmd._getSharedCache(),wrapper=ctx||cc._renderContext,context=wrapper.getContext();this._clipElemType?(context.save(),context.setTransform(1,0,0,1,0,0),context.globalCompositeOperation="destination-over",context.drawImage(locCache,0,0),context.restore(),this._dirtyFlag=0):wrapper.restore()},proto.transform=function(parentCmd,recursive){this.originTransform(parentCmd,recursive);var node=this._node;node._stencil&&node._stencil._renderCmd&&(node._stencil._renderCmd.transform(this,!0),node._stencil._dirtyFlag&=~cc.Node._dirtyFlags.transformDirty)},proto._cangodhelpme=function(godhelpme){return!0!==godhelpme&&!1!==godhelpme||(cc.ClippingNode.CanvasRenderCmd.prototype._godhelpme=godhelpme),cc.ClippingNode.CanvasRenderCmd.prototype._godhelpme},proto.clippingVisit=function(parentCmd){var node=this._node;if(parentCmd=parentCmd||this.getParentRenderCmd(),this.visit(parentCmd),this._clipElemType=!(!this._cangodhelpme()&&node._stencil instanceof cc.DrawNode),node._stencil&&node._stencil.visible){if(cc.renderer.pushRenderCommand(this._rendererSaveCmd),this._clipElemType?node._visitChildren():node._stencil.visit(node),cc.renderer.pushRenderCommand(this._rendererClipCmd),this._clipElemType)node._stencil.visit(node);else{this._cangodhelpme(!0);var i,children=node._children,len=children.length;if(0<len)for(node.sortAllChildren(),i=0;i<len;i++)children[i].visit(node);this._cangodhelpme(!1)}cc.renderer.pushRenderCommand(this._rendererRestoreCmd),this._dirtyFlag=0}else this.inverted&&node._visitChildren()},cc.ClippingNode.CanvasRenderCmd._sharedCache=null,cc.ClippingNode.CanvasRenderCmd._getSharedCache=function(){return cc.ClippingNode.CanvasRenderCmd._sharedCache||(cc.ClippingNode.CanvasRenderCmd._sharedCache=document.createElement("canvas"))}}(),function(){cc.ClippingNode.WebGLRenderCmd=function(renderable){this._rootCtor(renderable),this._needDraw=!1,this._beforeVisitCmd=new cc.CustomRenderCmd(this,this._onBeforeVisit),this._afterDrawStencilCmd=new cc.CustomRenderCmd(this,this._onAfterDrawStencil),this._afterVisitCmd=new cc.CustomRenderCmd(this,this._onAfterVisit),this._currentStencilEnabled=null,this._mask_layer_le=null};var proto=cc.ClippingNode.WebGLRenderCmd.prototype=Object.create(cc.Node.WebGLRenderCmd.prototype);proto.constructor=cc.ClippingNode.WebGLRenderCmd,cc.ClippingNode.WebGLRenderCmd._init_once=null,cc.ClippingNode.WebGLRenderCmd._visit_once=null,cc.ClippingNode.WebGLRenderCmd._layer=-1,proto.initStencilBits=function(){cc.ClippingNode.WebGLRenderCmd._init_once=!0,cc.ClippingNode.WebGLRenderCmd._init_once&&(cc.stencilBits=cc._renderContext.getParameter(cc._renderContext.STENCIL_BITS),cc.stencilBits<=0&&cc.log("Stencil buffer is not enabled."),cc.ClippingNode.WebGLRenderCmd._init_once=!1)},proto.transform=function(parentCmd,recursive){var node=this._node;this.originTransform(parentCmd,recursive),node._stencil&&(node._stencil._renderCmd.transform(this,!0),node._stencil._dirtyFlag&=~cc.Node._dirtyFlags.transformDirty)},proto.clippingVisit=function(parentCmd){var node=this._node;if(parentCmd=parentCmd||this.getParentRenderCmd(),this.visit(parentCmd),cc.stencilBits<1)node._visitChildren();else if(node._stencil&&node._stencil.visible){if(cc.ClippingNode.WebGLRenderCmd._layer+1===cc.stencilBits)return cc.ClippingNode.WebGLRenderCmd._visit_once=!0,cc.ClippingNode.WebGLRenderCmd._visit_once&&(cc.log("Nesting more than "+cc.stencilBits+"stencils is not supported. Everything will be drawn without stencil for this node and its children."),cc.ClippingNode.WebGLRenderCmd._visit_once=!1),void node._visitChildren();cc.renderer.pushRenderCommand(this._beforeVisitCmd),node._stencil.visit(node),cc.renderer.pushRenderCommand(this._afterDrawStencilCmd);var locChildren=node._children;if(locChildren&&0<locChildren.length){var childLen=locChildren.length;node.sortAllChildren();for(var i=0;i<childLen;i++)locChildren[i].visit(node)}cc.renderer.pushRenderCommand(this._afterVisitCmd),this._dirtyFlag=0}else node.inverted&&node._visitChildren()},proto.setStencil=function(stencil){var node=this._node;node._stencil&&(node._stencil._parent=null),node._stencil=stencil,node._stencil&&(node._stencil._parent=node)},proto.resetProgramByStencil=function(){var node=this._node;if(node._stencil){var program=node._originStencilProgram;cc.setProgram(node._stencil,program)}},proto._onBeforeVisit=function(ctx){var gl=ctx||cc._renderContext,node=this._node;cc.ClippingNode.WebGLRenderCmd._layer++;var mask_layer=1<<cc.ClippingNode.WebGLRenderCmd._layer,mask_layer_l=mask_layer-1;if(this._mask_layer_le=mask_layer|mask_layer_l,this._currentStencilEnabled=gl.isEnabled(gl.STENCIL_TEST),gl.clear(gl.DEPTH_BUFFER_BIT),gl.enable(gl.STENCIL_TEST),gl.depthMask(!1),gl.stencilFunc(gl.NEVER,mask_layer,mask_layer),gl.stencilOp(gl.REPLACE,gl.KEEP,gl.KEEP),gl.stencilMask(mask_layer),gl.clear(gl.STENCIL_BUFFER_BIT),node.alphaThreshold<1){var program=cc.shaderCache.programForKey(cc.SHADER_POSITION_TEXTURECOLORALPHATEST);cc.glUseProgram(program.getProgram()),program.setUniformLocationWith1f(cc.UNIFORM_ALPHA_TEST_VALUE_S,node.alphaThreshold),program.setUniformLocationWithMatrix4fv(cc.UNIFORM_MVMATRIX_S,cc.renderer.mat4Identity.mat),cc.setProgram(node._stencil,program)}},proto._onAfterDrawStencil=function(ctx){var gl=ctx||cc._renderContext;gl.depthMask(!0),gl.stencilFunc(this._node.inverted?gl.NOTEQUAL:gl.EQUAL,this._mask_layer_le,this._mask_layer_le),gl.stencilOp(gl.KEEP,gl.KEEP,gl.KEEP)},proto._onAfterVisit=function(ctx){var gl=ctx||cc._renderContext;if(cc.ClippingNode.WebGLRenderCmd._layer--,this._currentStencilEnabled){var mask_layer=1<<cc.ClippingNode.WebGLRenderCmd._layer,mask_layer_le=mask_layer|mask_layer-1;gl.stencilMask(mask_layer),gl.stencilFunc(gl.EQUAL,mask_layer_le,mask_layer_le)}else gl.disable(gl.STENCIL_TEST)}}();