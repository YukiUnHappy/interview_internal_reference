var _p;cc.PNGReader=cc.Class.extend({ctor:function(data){var chunkSize,colors,delayDen,delayNum,frame,index,key,section,ccshort,text,_i,_j,_ref;for(this.data=data,this.pos=8,this.palette=[],this.imgData=[],this.transparency={},this.animation=null,this.text={},frame=null;;){switch(chunkSize=this.readUInt32(),section=function(){var _i,_results;for(_results=[],_i=0;_i<4;++_i)_results.push(String.fromCharCode(this.data[this.pos++]));return _results}.call(this).join("")){case"IHDR":this.width=this.readUInt32(),this.height=this.readUInt32(),this.bits=this.data[this.pos++],this.colorType=this.data[this.pos++],this.compressionMethod=this.data[this.pos++],this.filterMethod=this.data[this.pos++],this.interlaceMethod=this.data[this.pos++];break;case"acTL":this.animation={numFrames:this.readUInt32(),numPlays:this.readUInt32()||1/0,frames:[]};break;case"PLTE":this.palette=this.read(chunkSize);break;case"fcTL":frame&&this.animation.frames.push(frame),this.pos+=4,frame={width:this.readUInt32(),height:this.readUInt32(),xOffset:this.readUInt32(),yOffset:this.readUInt32()},delayNum=this.readUInt16(),delayDen=this.readUInt16()||100,frame.delay=1e3*delayNum/delayDen,frame.disposeOp=this.data[this.pos++],frame.blendOp=this.data[this.pos++],frame.data=[];break;case"IDAT":case"fdAT":for("fdAT"===section&&(this.pos+=4,chunkSize-=4),data=(null!=frame?frame.data:void 0)||this.imgData,_i=0;0<=chunkSize?_i<chunkSize:chunkSize<_i;0<=chunkSize?++_i:--_i)data.push(this.data[this.pos++]);break;case"tRNS":switch(this.transparency={},this.colorType){case 3:if(this.transparency.indexed=this.read(chunkSize),0<(ccshort=255-this.transparency.indexed.length))for(_j=0;0<=ccshort?_j<ccshort:ccshort<_j;0<=ccshort?++_j:--_j)this.transparency.indexed.push(255);break;case 0:this.transparency.grayscale=this.read(chunkSize)[0];break;case 2:this.transparency.rgb=this.read(chunkSize)}break;case"tEXt":index=(text=this.read(chunkSize)).indexOf(0),key=String.fromCharCode.apply(String,text.slice(0,index)),this.text[key]=String.fromCharCode.apply(String,text.slice(index+1));break;case"IEND":return frame&&this.animation.frames.push(frame),this.colors=function(){switch(this.colorType){case 0:case 3:case 4:return 1;case 2:case 6:return 3}}.call(this),this.hasAlphaChannel=4===(_ref=this.colorType)||6===_ref,colors=this.colors+(this.hasAlphaChannel?1:0),this.pixelBitlength=this.bits*colors,this.colorSpace=function(){switch(this.colors){case 1:return"DeviceGray";case 3:return"DeviceRGB"}}.call(this),void(Uint8Array!=Array&&(this.imgData=new Uint8Array(this.imgData)));default:this.pos+=chunkSize}if(this.pos+=4,this.pos>this.data.length)throw new Error("Incomplete or corrupt PNG file")}},read:function(bytes){var _i,_results;for(_results=[],_i=0;0<=bytes?_i<bytes:bytes<_i;0<=bytes?++_i:--_i)_results.push(this.data[this.pos++]);return _results},readUInt32:function(){return this.data[this.pos++]<<24|this.data[this.pos++]<<16|this.data[this.pos++]<<8|this.data[this.pos++]},readUInt16:function(){return this.data[this.pos++]<<8|this.data[this.pos++]},decodePixels:function(data){var ccbyte,c,col,i,left,length,p,pa,paeth,pb,pc,pixelBytes,pixels,pos,row,scanlineLength,upper,upperLeft,_i,_j,_k,_l,_m;if(null==data&&(data=this.imgData),0===data.length)return new Uint8Array(0);for(data=new Zlib.Inflate(data,{index:0,verify:!1}).decompress(),scanlineLength=(pixelBytes=this.pixelBitlength/8)*this.width,pixels=new Uint8Array(scanlineLength*this.height),length=data.length,c=pos=row=0;pos<length;){switch(data[pos++]){case 0:for(i=_i=0;_i<scanlineLength;i=_i+=1)pixels[c++]=data[pos++];break;case 1:for(i=_j=0;_j<scanlineLength;i=_j+=1)ccbyte=data[pos++],left=i<pixelBytes?0:pixels[c-pixelBytes],pixels[c++]=(ccbyte+left)%256;break;case 2:for(i=_k=0;_k<scanlineLength;i=_k+=1)ccbyte=data[pos++],col=(i-i%pixelBytes)/pixelBytes,upper=row&&pixels[(row-1)*scanlineLength+col*pixelBytes+i%pixelBytes],pixels[c++]=(upper+ccbyte)%256;break;case 3:for(i=_l=0;_l<scanlineLength;i=_l+=1)ccbyte=data[pos++],col=(i-i%pixelBytes)/pixelBytes,left=i<pixelBytes?0:pixels[c-pixelBytes],upper=row&&pixels[(row-1)*scanlineLength+col*pixelBytes+i%pixelBytes],pixels[c++]=(ccbyte+Math.floor((left+upper)/2))%256;break;case 4:for(i=_m=0;_m<scanlineLength;i=_m+=1)ccbyte=data[pos++],col=(i-i%pixelBytes)/pixelBytes,left=i<pixelBytes?0:pixels[c-pixelBytes],0===row?upper=upperLeft=0:(upper=pixels[(row-1)*scanlineLength+col*pixelBytes+i%pixelBytes],upperLeft=col&&pixels[(row-1)*scanlineLength+(col-1)*pixelBytes+i%pixelBytes]),p=left+upper-upperLeft,pa=Math.abs(p-left),pb=Math.abs(p-upper),pc=Math.abs(p-upperLeft),paeth=pa<=pb&&pa<=pc?left:pb<=pc?upper:upperLeft,pixels[c++]=(ccbyte+paeth)%256;break;default:throw new Error("Invalid filter algorithm: "+data[pos-1])}row++}return pixels},copyToImageData:function(imageData,pixels){var alpha,colors,data,i,input,j,k,length,palette,v,_ref;if(colors=this.colors,palette=null,alpha=this.hasAlphaChannel,this.palette.length&&(palette=null!=(_ref=this._decodedPalette)?_ref:this._decodedPalette=this.decodePalette(),colors=4,alpha=!0),length=(data=imageData.data||imageData).length,input=palette||pixels,i=j=0,1===colors)for(;i<length;)k=palette?4*pixels[i/4]:j,v=input[k++],data[i++]=v,data[i++]=v,data[i++]=v,data[i++]=alpha?input[k++]:255,j=k;else for(;i<length;)k=palette?4*pixels[i/4]:j,data[i++]=input[k++],data[i++]=input[k++],data[i++]=input[k++],data[i++]=alpha?input[k++]:255,j=k},decodePalette:function(){var c,i,palette,pos,ret,transparency,_i,_ref,_ref1;for(palette=this.palette,transparency=this.transparency.indexed||[],ret=new Uint8Array((transparency.length||0)+palette.length),i=_i=c=pos=0,_ref=palette.length;_i<_ref;i=_i+=3)ret[pos++]=palette[i],ret[pos++]=palette[i+1],ret[pos++]=palette[i+2],ret[pos++]=null!=(_ref1=transparency[c++])?_ref1:255;return ret},render:function(canvas){var ctx,data;return canvas.width=this.width,canvas.height=this.height,data=(ctx=canvas.getContext("2d")).createImageData(this.width,this.height),this.copyToImageData(data,this.decodePixels()),ctx.putImageData(data,0,0)}}),cc.tiffReader={_littleEndian:!1,_tiffData:null,_fileDirectories:[],getUint8:function(offset){return this._tiffData[offset]},getUint16:function(offset){return this._littleEndian?this._tiffData[offset+1]<<8|this._tiffData[offset]:this._tiffData[offset]<<8|this._tiffData[offset+1]},getUint32:function(offset){var a=this._tiffData;return this._littleEndian?a[offset+3]<<24|a[offset+2]<<16|a[offset+1]<<8|a[offset]:a[offset]<<24|a[offset+1]<<16|a[offset+2]<<8|a[offset+3]},checkLittleEndian:function(){var BOM=this.getUint16(0);if(18761===BOM)this.littleEndian=!0;else{if(19789!==BOM)throw console.log(BOM),TypeError("Invalid byte order value.");this.littleEndian=!1}return this.littleEndian},hasTowel:function(){if(42!==this.getUint16(2))throw RangeError("You forgot your towel!");return!0},getFieldTypeName:function(fieldType){var typeNames=this.fieldTypeNames;return fieldType in typeNames?typeNames[fieldType]:null},getFieldTagName:function(fieldTag){var tagNames=this.fieldTagNames;return fieldTag in tagNames?tagNames[fieldTag]:(console.log("Unknown Field Tag:",fieldTag),"Tag"+fieldTag)},getFieldTypeLength:function(fieldTypeName){return-1!==["BYTE","ASCII","SBYTE","UNDEFINED"].indexOf(fieldTypeName)?1:-1!==["SHORT","SSHORT"].indexOf(fieldTypeName)?2:-1!==["LONG","SLONG","FLOAT"].indexOf(fieldTypeName)?4:-1!==["RATIONAL","SRATIONAL","DOUBLE"].indexOf(fieldTypeName)?8:null},getFieldValues:function(fieldTagName,fieldTypeName,typeCount,valueOffset){var fieldValues=[],fieldTypeLength=this.getFieldTypeLength(fieldTypeName);if(fieldTypeLength*typeCount<=4)!1===this.littleEndian?fieldValues.push(valueOffset>>>8*(4-fieldTypeLength)):fieldValues.push(valueOffset);else for(var i=0;i<typeCount;i++){var indexOffset=fieldTypeLength*i;8<=fieldTypeLength?-1!==["RATIONAL","SRATIONAL"].indexOf(fieldTypeName)?(fieldValues.push(this.getUint32(valueOffset+indexOffset)),fieldValues.push(this.getUint32(valueOffset+indexOffset+4))):cc.log("Can't handle this field type or size"):fieldValues.push(this.getBytes(fieldTypeLength,valueOffset+indexOffset))}return"ASCII"===fieldTypeName&&fieldValues.forEach(function(e,i,a){a[i]=String.fromCharCode(e)}),fieldValues},getBytes:function(numBytes,offset){if(numBytes<=0)cc.log("No bytes requested");else{if(numBytes<=1)return this.getUint8(offset);if(numBytes<=2)return this.getUint16(offset);if(numBytes<=3)return this.getUint32(offset)>>>8;if(numBytes<=4)return this.getUint32(offset);cc.log("Too many bytes requested")}},getBits:function(numBits,byteOffset,bitOffset){bitOffset=bitOffset||0;var shiftLeft,rawBits,newByteOffset=byteOffset+Math.floor(bitOffset/8),totalBits=bitOffset+numBits,shiftRight=32-numBits;return totalBits<=0?console.log("No bits requested"):totalBits<=8?(shiftLeft=24+bitOffset,rawBits=this.getUint8(newByteOffset)):totalBits<=16?(shiftLeft=16+bitOffset,rawBits=this.getUint16(newByteOffset)):totalBits<=32?(shiftLeft=bitOffset,rawBits=this.getUint32(newByteOffset)):console.log("Too many bits requested"),{bits:rawBits<<shiftLeft>>>shiftRight,byteOffset:newByteOffset+Math.floor(totalBits/8),bitOffset:totalBits%8}},parseFileDirectory:function(byteOffset){for(var numDirEntries=this.getUint16(byteOffset),tiffFields=[],i=byteOffset+2,entryCount=0;entryCount<numDirEntries;i+=12,entryCount++){var fieldTag=this.getUint16(i),fieldType=this.getUint16(i+2),typeCount=this.getUint32(i+4),valueOffset=this.getUint32(i+8),fieldTagName=this.getFieldTagName(fieldTag),fieldTypeName=this.getFieldTypeName(fieldType),fieldValues=this.getFieldValues(fieldTagName,fieldTypeName,typeCount,valueOffset);tiffFields[fieldTagName]={type:fieldTypeName,values:fieldValues}}this._fileDirectories.push(tiffFields);var nextIFDByteOffset=this.getUint32(i);0!==nextIFDByteOffset&&this.parseFileDirectory(nextIFDByteOffset)},clampColorSample:function(colorSample,bitsPerSample){var multiplier=Math.pow(2,8-bitsPerSample);return Math.floor(colorSample*multiplier+(multiplier-1))},parseTIFF:function(tiffData,canvas){if(canvas=canvas||document.createElement("canvas"),this._tiffData=tiffData,this.canvas=canvas,this.checkLittleEndian(),this.hasTowel()){var firstIFDByteOffset=this.getUint32(4);this._fileDirectories.length=0,this.parseFileDirectory(firstIFDByteOffset);var fileDirectory=this._fileDirectories[0],imageWidth=fileDirectory.ImageWidth.values[0],imageLength=fileDirectory.ImageLength.values[0];this.canvas.width=imageWidth,this.canvas.height=imageLength;var strips=[],compression=fileDirectory.Compression?fileDirectory.Compression.values[0]:1,samplesPerPixel=fileDirectory.SamplesPerPixel.values[0],sampleProperties=[],bitsPerPixel=0,hasBytesPerPixel=!1;if(fileDirectory.BitsPerSample.values.forEach(function(bitsPerSample,i,bitsPerSampleValues){sampleProperties[i]={bitsPerSample:bitsPerSample,hasBytesPerSample:!1,bytesPerSample:void 0},bitsPerSample%8==0&&(sampleProperties[i].hasBytesPerSample=!0,sampleProperties[i].bytesPerSample=bitsPerSample/8),bitsPerPixel+=bitsPerSample},this),bitsPerPixel%8==0){hasBytesPerPixel=!0;var bytesPerPixel=bitsPerPixel/8}var stripOffsetValues=fileDirectory.StripOffsets.values,numStripOffsetValues=stripOffsetValues.length;if(fileDirectory.StripByteCounts)var stripByteCountValues=fileDirectory.StripByteCounts.values;else{if(cc.log("Missing StripByteCounts!"),1!==numStripOffsetValues)throw Error("Cannot recover from missing StripByteCounts");stripByteCountValues=[Math.ceil(imageWidth*imageLength*bitsPerPixel/8)]}for(var i=0;i<numStripOffsetValues;i++){var stripOffset=stripOffsetValues[i];strips[i]=[];for(var stripByteCount=stripByteCountValues[i],byteOffset=0,bitOffset=0,jIncrement=1,getHeader=!0,pixel=[],numBytes=0,sample=0,currentSample=0;byteOffset<stripByteCount;byteOffset+=jIncrement)switch(compression){case 1:var m=0;for(pixel=[];m<samplesPerPixel;m++){if(!sampleProperties[m].hasBytesPerSample){var sampleInfo=this.getBits(sampleProperties[m].bitsPerSample,stripOffset+byteOffset,bitOffset);throw pixel.push(sampleInfo.bits),byteOffset=sampleInfo.byteOffset-stripOffset,bitOffset=sampleInfo.bitOffset,RangeError("Cannot handle sub-byte bits per sample")}var sampleOffset=sampleProperties[m].bytesPerSample*m;pixel.push(this.getBytes(sampleProperties[m].bytesPerSample,stripOffset+byteOffset+sampleOffset))}if(strips[i].push(pixel),!hasBytesPerPixel)throw jIncrement=0,RangeError("Cannot handle sub-byte bits per pixel");jIncrement=bytesPerPixel;break;case 2:case 3:case 4:case 5:case 6:case 7:break;case 32773:if(getHeader){getHeader=!1;var blockLength=1,iterations=1,header=this.getInt8(stripOffset+byteOffset);0<=header&&header<=127?blockLength=header+1:-127<=header&&header<=-1?iterations=1-header:getHeader=!0}else{var currentByte=this.getUint8(stripOffset+byteOffset);for(m=0;m<iterations;m++){if(!sampleProperties[sample].hasBytesPerSample)throw RangeError("Cannot handle sub-byte bits per sample");currentSample=currentSample<<8*numBytes|currentByte,++numBytes===sampleProperties[sample].bytesPerSample&&(pixel.push(currentSample),currentSample=numBytes=0,sample++),sample===samplesPerPixel&&(strips[i].push(pixel),pixel=[],sample=0)}0===--blockLength&&(getHeader=!0)}jIncrement=1}}if(canvas.getContext){var ctx=this.canvas.getContext("2d");ctx.fillStyle="rgba(255, 255, 255, 0)";var rowsPerStrip=fileDirectory.RowsPerStrip?fileDirectory.RowsPerStrip.values[0]:imageLength,numStrips=strips.length,imageLengthModRowsPerStrip=imageLength%rowsPerStrip,rowsInLastStrip=0===imageLengthModRowsPerStrip?rowsPerStrip:imageLengthModRowsPerStrip,numRowsInStrip=rowsPerStrip,numRowsInPreviousStrip=0,photometricInterpretation=fileDirectory.PhotometricInterpretation.values[0],extraSamplesValues=[],numExtraSamples=0;if(fileDirectory.ExtraSamples&&(numExtraSamples=(extraSamplesValues=fileDirectory.ExtraSamples.values).length),fileDirectory.ColorMap)var colorMapValues=fileDirectory.ColorMap.values,colorMapSampleSize=Math.pow(2,sampleProperties[0].bitsPerSample);for(i=0;i<numStrips;i++){i+1===numStrips&&(numRowsInStrip=rowsInLastStrip);for(var numPixels=strips[i].length,yPadding=numRowsInPreviousStrip*i,y=0,j=0;j<numPixels;y++)for(var x=0;x<imageWidth;x++,j++){var pixelSamples=strips[i][j],red=0,green=0,blue=0,opacity=1;if(0<numExtraSamples)for(var k=0;k<numExtraSamples;k++)if(1===extraSamplesValues[k]||2===extraSamplesValues[k]){opacity=pixelSamples[3+k]/256;break}switch(photometricInterpretation){case 0:if(sampleProperties[0].hasBytesPerSample)var invertValue=Math.pow(16,2*sampleProperties[0].bytesPerSample);pixelSamples.forEach(function(sample,index,samples){samples[index]=invertValue-sample});case 1:red=green=blue=this.clampColorSample(pixelSamples[0],sampleProperties[0].bitsPerSample);break;case 2:red=this.clampColorSample(pixelSamples[0],sampleProperties[0].bitsPerSample),green=this.clampColorSample(pixelSamples[1],sampleProperties[1].bitsPerSample),blue=this.clampColorSample(pixelSamples[2],sampleProperties[2].bitsPerSample);break;case 3:if(void 0===colorMapValues)throw Error("Palette image missing color map");var colorMapIndex=pixelSamples[0];red=this.clampColorSample(colorMapValues[colorMapIndex],16),green=this.clampColorSample(colorMapValues[colorMapSampleSize+colorMapIndex],16),blue=this.clampColorSample(colorMapValues[2*colorMapSampleSize+colorMapIndex],16);break;default:throw RangeError("Unknown Photometric Interpretation:",photometricInterpretation)}ctx.fillStyle="rgba("+red+", "+green+", "+blue+", "+opacity+")",ctx.fillRect(x,yPadding+y,1,1)}numRowsInPreviousStrip=numRowsInStrip}}return this.canvas}},fieldTagNames:{315:"Artist",258:"BitsPerSample",265:"CellLength",264:"CellWidth",320:"ColorMap",259:"Compression",33432:"Copyright",306:"DateTime",338:"ExtraSamples",266:"FillOrder",289:"FreeByteCounts",288:"FreeOffsets",291:"GrayResponseCurve",290:"GrayResponseUnit",316:"HostComputer",270:"ImageDescription",257:"ImageLength",256:"ImageWidth",271:"Make",281:"MaxSampleValue",280:"MinSampleValue",272:"Model",254:"NewSubfileType",274:"Orientation",262:"PhotometricInterpretation",284:"PlanarConfiguration",296:"ResolutionUnit",278:"RowsPerStrip",277:"SamplesPerPixel",305:"Software",279:"StripByteCounts",273:"StripOffsets",255:"SubfileType",263:"Threshholding",282:"XResolution",283:"YResolution",326:"BadFaxLines",327:"CleanFaxData",343:"ClipPath",328:"ConsecutiveBadFaxLines",433:"Decode",434:"DefaultImageColor",269:"DocumentName",336:"DotRange",321:"HalftoneHints",346:"Indexed",347:"JPEGTables",285:"PageName",297:"PageNumber",317:"Predictor",319:"PrimaryChromaticities",532:"ReferenceBlackWhite",339:"SampleFormat",559:"StripRowCounts",330:"SubIFDs",292:"T4Options",293:"T6Options",325:"TileByteCounts",323:"TileLength",324:"TileOffsets",322:"TileWidth",301:"TransferFunction",318:"WhitePoint",344:"XClipPathUnits",286:"XPosition",529:"YCbCrCoefficients",531:"YCbCrPositioning",530:"YCbCrSubSampling",345:"YClipPathUnits",287:"YPosition",37378:"ApertureValue",40961:"ColorSpace",36868:"DateTimeDigitized",36867:"DateTimeOriginal",34665:"Exif IFD",36864:"ExifVersion",33434:"ExposureTime",41728:"FileSource",37385:"Flash",40960:"FlashpixVersion",33437:"FNumber",42016:"ImageUniqueID",37384:"LightSource",37500:"MakerNote",37377:"ShutterSpeedValue",37510:"UserComment",33723:"IPTC",34675:"ICC Profile",700:"XMP",42112:"GDAL_METADATA",42113:"GDAL_NODATA",34377:"Photoshop"},fieldTypeNames:{1:"BYTE",2:"ASCII",3:"SHORT",4:"LONG",5:"RATIONAL",6:"SBYTE",7:"UNDEFINED",8:"SSHORT",9:"SLONG",10:"SRATIONAL",11:"FLOAT",12:"DOUBLE"}},cc.Particle=function(pos,startPos,color,deltaColor,size,deltaSize,rotation,deltaRotation,timeToLive,atlasIndex,modeA,modeB){this.pos=pos||cc.p(0,0),this.startPos=startPos||cc.p(0,0),this.color=color||{r:0,g:0,b:0,a:255},this.deltaColor=deltaColor||{r:0,g:0,b:0,a:255},this.size=size||0,this.deltaSize=deltaSize||0,this.rotation=rotation||0,this.deltaRotation=deltaRotation||0,this.timeToLive=timeToLive||0,this.atlasIndex=atlasIndex||0,this.modeA=modeA||new cc.Particle.ModeA,this.modeB=modeB||new cc.Particle.ModeB,this.isChangeColor=!1,this.drawPos=cc.p(0,0)},cc.Particle.ModeA=function(dir,radialAccel,tangentialAccel){this.dir=dir||cc.p(0,0),this.radialAccel=radialAccel||0,this.tangentialAccel=tangentialAccel||0},cc.Particle.ModeB=function(angle,degreesPerSecond,radius,deltaRadius){this.angle=angle||0,this.degreesPerSecond=degreesPerSecond||0,this.radius=radius||0,this.deltaRadius=deltaRadius||0},cc.Particle.TemporaryPoints=[cc.p(),cc.p(),cc.p(),cc.p()],cc.ParticleSystem=cc.Node.extend({_className:"ParticleSystem",_plistFile:"",_elapsed:0,_dontTint:!1,modeA:null,modeB:null,_pointZeroForParticle:cc.p(0,0),_particles:null,_emitCounter:0,_particleIdx:0,_batchNode:null,atlasIndex:0,_transformSystemDirty:!1,_allocatedParticles:0,_isActive:!1,particleCount:0,duration:0,_sourcePosition:null,_posVar:null,life:0,lifeVar:0,angle:0,angleVar:0,startSize:0,startSizeVar:0,endSize:0,endSizeVar:0,_startColor:null,_startColorVar:null,_endColor:null,_endColorVar:null,startSpin:0,startSpinVar:0,endSpin:0,endSpinVar:0,emissionRate:0,_totalParticles:0,_texture:null,_blendFunc:null,_opacityModifyRGB:!1,positionType:null,autoRemoveOnFinish:!1,emitterMode:0,_textureLoaded:null,ctor:function(plistFile){if(cc.Node.prototype.ctor.call(this),this.emitterMode=cc.ParticleSystem.MODE_GRAVITY,this.modeA=new cc.ParticleSystem.ModeA,this.modeB=new cc.ParticleSystem.ModeB,this._blendFunc={src:cc.BLEND_SRC,dst:cc.BLEND_DST},this._particles=[],this._sourcePosition=cc.p(0,0),this._posVar=cc.p(0,0),this._startColor=cc.color(255,255,255,255),this._startColorVar=cc.color(255,255,255,255),this._endColor=cc.color(255,255,255,255),this._endColorVar=cc.color(255,255,255,255),this._plistFile="",this._elapsed=0,this._dontTint=!1,this._pointZeroForParticle=cc.p(0,0),this._emitCounter=0,this._particleIdx=0,this._batchNode=null,this.atlasIndex=0,this._transformSystemDirty=!1,this._allocatedParticles=0,this._isActive=!1,this.particleCount=0,this.duration=0,this.life=0,this.lifeVar=0,this.angle=0,this.angleVar=0,this.startSize=0,this.startSizeVar=0,this.endSize=0,this.endSizeVar=0,this.startSpin=0,this.startSpinVar=0,this.endSpin=0,this.endSpinVar=0,this.emissionRate=0,this._totalParticles=0,this._texture=null,this._opacityModifyRGB=!1,this.positionType=cc.ParticleSystem.TYPE_FREE,this.autoRemoveOnFinish=!1,this._textureLoaded=!0,!plistFile||cc.isNumber(plistFile)){var ton=plistFile||100;this.setDrawMode(cc.ParticleSystem.TEXTURE_MODE),this.initWithTotalParticles(ton)}else cc.isString(plistFile)?this.initWithFile(plistFile):cc.isObject(plistFile)&&this.initWithDictionary(plistFile,"")},_createRenderCmd:function(){return cc._renderType===cc.game.RENDER_TYPE_CANVAS?new cc.ParticleSystem.CanvasRenderCmd(this):new cc.ParticleSystem.WebGLRenderCmd(this)},ignoreColor:function(ignore){this._dontTint=ignore},initTexCoordsWithRect:function(pointRect){this._renderCmd.initTexCoordsWithRect(pointRect)},getBatchNode:function(){return this._batchNode},setBatchNode:function(batchNode){this._renderCmd.setBatchNode(batchNode)},getAtlasIndex:function(){return this.atlasIndex},setAtlasIndex:function(atlasIndex){this.atlasIndex=atlasIndex},getDrawMode:function(){return this._renderCmd.getDrawMode()},setDrawMode:function(drawMode){this._renderCmd.setDrawMode(drawMode)},getShapeType:function(){return this._renderCmd.getShapeType()},setShapeType:function(shapeType){this._renderCmd.setShapeType(shapeType)},isActive:function(){return this._isActive},getParticleCount:function(){return this.particleCount},setParticleCount:function(particleCount){this.particleCount=particleCount},getDuration:function(){return this.duration},setDuration:function(duration){this.duration=duration},getSourcePosition:function(){return{x:this._sourcePosition.x,y:this._sourcePosition.y}},setSourcePosition:function(sourcePosition){this._sourcePosition.x=sourcePosition.x,this._sourcePosition.y=sourcePosition.y},getPosVar:function(){return{x:this._posVar.x,y:this._posVar.y}},setPosVar:function(posVar){this._posVar.x=posVar.x,this._posVar.y=posVar.y},getLife:function(){return this.life},setLife:function(life){this.life=life},getLifeVar:function(){return this.lifeVar},setLifeVar:function(lifeVar){this.lifeVar=lifeVar},getAngle:function(){return this.angle},setAngle:function(angle){this.angle=angle},getAngleVar:function(){return this.angleVar},setAngleVar:function(angleVar){this.angleVar=angleVar},getGravity:function(){this.emitterMode!==cc.ParticleSystem.MODE_GRAVITY&&cc.log("cc.ParticleBatchNode.getGravity() : Particle Mode should be Gravity");var locGravity=this.modeA.gravity;return cc.p(locGravity.x,locGravity.y)},setGravity:function(gravity){this.emitterMode!==cc.ParticleSystem.MODE_GRAVITY&&cc.log("cc.ParticleBatchNode.setGravity() : Particle Mode should be Gravity"),this.modeA.gravity=gravity},getSpeed:function(){return this.emitterMode!==cc.ParticleSystem.MODE_GRAVITY&&cc.log("cc.ParticleBatchNode.getSpeed() : Particle Mode should be Gravity"),this.modeA.speed},setSpeed:function(speed){this.emitterMode!==cc.ParticleSystem.MODE_GRAVITY&&cc.log("cc.ParticleBatchNode.setSpeed() : Particle Mode should be Gravity"),this.modeA.speed=speed},getSpeedVar:function(){return this.emitterMode!==cc.ParticleSystem.MODE_GRAVITY&&cc.log("cc.ParticleBatchNode.getSpeedVar() : Particle Mode should be Gravity"),this.modeA.speedVar},setSpeedVar:function(speedVar){this.emitterMode!==cc.ParticleSystem.MODE_GRAVITY&&cc.log("cc.ParticleBatchNode.setSpeedVar() : Particle Mode should be Gravity"),this.modeA.speedVar=speedVar},getTangentialAccel:function(){return this.emitterMode!==cc.ParticleSystem.MODE_GRAVITY&&cc.log("cc.ParticleBatchNode.getTangentialAccel() : Particle Mode should be Gravity"),this.modeA.tangentialAccel},setTangentialAccel:function(tangentialAccel){this.emitterMode!==cc.ParticleSystem.MODE_GRAVITY&&cc.log("cc.ParticleBatchNode.setTangentialAccel() : Particle Mode should be Gravity"),this.modeA.tangentialAccel=tangentialAccel},getTangentialAccelVar:function(){return this.emitterMode!==cc.ParticleSystem.MODE_GRAVITY&&cc.log("cc.ParticleBatchNode.getTangentialAccelVar() : Particle Mode should be Gravity"),this.modeA.tangentialAccelVar},setTangentialAccelVar:function(tangentialAccelVar){this.emitterMode!==cc.ParticleSystem.MODE_GRAVITY&&cc.log("cc.ParticleBatchNode.setTangentialAccelVar() : Particle Mode should be Gravity"),this.modeA.tangentialAccelVar=tangentialAccelVar},getRadialAccel:function(){return this.emitterMode!==cc.ParticleSystem.MODE_GRAVITY&&cc.log("cc.ParticleBatchNode.getRadialAccel() : Particle Mode should be Gravity"),this.modeA.radialAccel},setRadialAccel:function(radialAccel){this.emitterMode!==cc.ParticleSystem.MODE_GRAVITY&&cc.log("cc.ParticleBatchNode.setRadialAccel() : Particle Mode should be Gravity"),this.modeA.radialAccel=radialAccel},getRadialAccelVar:function(){return this.emitterMode!==cc.ParticleSystem.MODE_GRAVITY&&cc.log("cc.ParticleBatchNode.getRadialAccelVar() : Particle Mode should be Gravity"),this.modeA.radialAccelVar},setRadialAccelVar:function(radialAccelVar){this.emitterMode!==cc.ParticleSystem.MODE_GRAVITY&&cc.log("cc.ParticleBatchNode.setRadialAccelVar() : Particle Mode should be Gravity"),this.modeA.radialAccelVar=radialAccelVar},getRotationIsDir:function(){return this.emitterMode!==cc.ParticleSystem.MODE_GRAVITY&&cc.log("cc.ParticleBatchNode.getRotationIsDir() : Particle Mode should be Gravity"),this.modeA.rotationIsDir},setRotationIsDir:function(t){this.emitterMode!==cc.ParticleSystem.MODE_GRAVITY&&cc.log("cc.ParticleBatchNode.setRotationIsDir() : Particle Mode should be Gravity"),this.modeA.rotationIsDir=t},getStartRadius:function(){return this.emitterMode!==cc.ParticleSystem.MODE_RADIUS&&cc.log("cc.ParticleBatchNode.getStartRadius() : Particle Mode should be Radius"),this.modeB.startRadius},setStartRadius:function(startRadius){this.emitterMode!==cc.ParticleSystem.MODE_RADIUS&&cc.log("cc.ParticleBatchNode.setStartRadius() : Particle Mode should be Radius"),this.modeB.startRadius=startRadius},getStartRadiusVar:function(){return this.emitterMode!==cc.ParticleSystem.MODE_RADIUS&&cc.log("cc.ParticleBatchNode.getStartRadiusVar() : Particle Mode should be Radius"),this.modeB.startRadiusVar},setStartRadiusVar:function(startRadiusVar){this.emitterMode!==cc.ParticleSystem.MODE_RADIUS&&cc.log("cc.ParticleBatchNode.setStartRadiusVar() : Particle Mode should be Radius"),this.modeB.startRadiusVar=startRadiusVar},getEndRadius:function(){return this.emitterMode!==cc.ParticleSystem.MODE_RADIUS&&cc.log("cc.ParticleBatchNode.getEndRadius() : Particle Mode should be Radius"),this.modeB.endRadius},setEndRadius:function(endRadius){this.emitterMode!==cc.ParticleSystem.MODE_RADIUS&&cc.log("cc.ParticleBatchNode.setEndRadius() : Particle Mode should be Radius"),this.modeB.endRadius=endRadius},getEndRadiusVar:function(){return this.emitterMode!==cc.ParticleSystem.MODE_RADIUS&&cc.log("cc.ParticleBatchNode.getEndRadiusVar() : Particle Mode should be Radius"),this.modeB.endRadiusVar},setEndRadiusVar:function(endRadiusVar){this.emitterMode!==cc.ParticleSystem.MODE_RADIUS&&cc.log("cc.ParticleBatchNode.setEndRadiusVar() : Particle Mode should be Radius"),this.modeB.endRadiusVar=endRadiusVar},getRotatePerSecond:function(){return this.emitterMode!==cc.ParticleSystem.MODE_RADIUS&&cc.log("cc.ParticleBatchNode.getRotatePerSecond() : Particle Mode should be Radius"),this.modeB.rotatePerSecond},setRotatePerSecond:function(degrees){this.emitterMode!==cc.ParticleSystem.MODE_RADIUS&&cc.log("cc.ParticleBatchNode.setRotatePerSecond() : Particle Mode should be Radius"),this.modeB.rotatePerSecond=degrees},getRotatePerSecondVar:function(){return this.emitterMode!==cc.ParticleSystem.MODE_RADIUS&&cc.log("cc.ParticleBatchNode.getRotatePerSecondVar() : Particle Mode should be Radius"),this.modeB.rotatePerSecondVar},setRotatePerSecondVar:function(degrees){this.emitterMode!==cc.ParticleSystem.MODE_RADIUS&&cc.log("cc.ParticleBatchNode.setRotatePerSecondVar() : Particle Mode should be Radius"),this.modeB.rotatePerSecondVar=degrees},setScale:function(scale,scaleY){this._transformSystemDirty=!0,cc.Node.prototype.setScale.call(this,scale,scaleY)},setRotation:function(newRotation){this._transformSystemDirty=!0,cc.Node.prototype.setRotation.call(this,newRotation)},setScaleX:function(newScaleX){this._transformSystemDirty=!0,cc.Node.prototype.setScaleX.call(this,newScaleX)},setScaleY:function(newScaleY){this._transformSystemDirty=!0,cc.Node.prototype.setScaleY.call(this,newScaleY)},getStartSize:function(){return this.startSize},setStartSize:function(startSize){this.startSize=startSize},getStartSizeVar:function(){return this.startSizeVar},setStartSizeVar:function(startSizeVar){this.startSizeVar=startSizeVar},getEndSize:function(){return this.endSize},setEndSize:function(endSize){this.endSize=endSize},getEndSizeVar:function(){return this.endSizeVar},setEndSizeVar:function(endSizeVar){this.endSizeVar=endSizeVar},getStartColor:function(){return cc.color(this._startColor.r,this._startColor.g,this._startColor.b,this._startColor.a)},setStartColor:function(startColor){this._startColor.r=startColor.r,this._startColor.g=startColor.g,this._startColor.b=startColor.b,this._startColor.a=startColor.a},getStartColorVar:function(){return cc.color(this._startColorVar.r,this._startColorVar.g,this._startColorVar.b,this._startColorVar.a)},setStartColorVar:function(startColorVar){this._startColorVar.r=startColorVar.r,this._startColorVar.g=startColorVar.g,this._startColorVar.b=startColorVar.b,this._startColorVar.a=startColorVar.a},getEndColor:function(){return cc.color(this._endColor.r,this._endColor.g,this._endColor.b,this._endColor.a)},setEndColor:function(endColor){this._endColor.r=endColor.r,this._endColor.g=endColor.g,this._endColor.b=endColor.b,this._endColor.a=endColor.a},getEndColorVar:function(){return cc.color(this._endColorVar.r,this._endColorVar.g,this._endColorVar.b,this._endColorVar.a)},setEndColorVar:function(endColorVar){this._endColorVar.r=endColorVar.r,this._endColorVar.g=endColorVar.g,this._endColorVar.b=endColorVar.b,this._endColorVar.a=endColorVar.a},getStartSpin:function(){return this.startSpin},setStartSpin:function(startSpin){this.startSpin=startSpin},getStartSpinVar:function(){return this.startSpinVar},setStartSpinVar:function(startSpinVar){this.startSpinVar=startSpinVar},getEndSpin:function(){return this.endSpin},setEndSpin:function(endSpin){this.endSpin=endSpin},getEndSpinVar:function(){return this.endSpinVar},setEndSpinVar:function(endSpinVar){this.endSpinVar=endSpinVar},getEmissionRate:function(){return this.emissionRate},setEmissionRate:function(emissionRate){this.emissionRate=emissionRate},getTotalParticles:function(){return this._totalParticles},setTotalParticles:function(tp){this._renderCmd.setTotalParticles(tp)},getTexture:function(){return this._texture},setTexture:function(texture){texture&&(texture.isLoaded()?this.setTextureWithRect(texture,cc.rect(0,0,texture.width,texture.height)):(this._textureLoaded=!1,texture.addEventListener("load",function(sender){this._textureLoaded=!0,this.setTextureWithRect(sender,cc.rect(0,0,sender.width,sender.height))},this)))},getBlendFunc:function(){return this._blendFunc},setBlendFunc:function(src,dst){void 0===dst?this._blendFunc!==src&&(this._blendFunc=src,this._updateBlendFunc()):this._blendFunc.src===src&&this._blendFunc.dst===dst||(this._blendFunc={src:src,dst:dst},this._updateBlendFunc())},isOpacityModifyRGB:function(){return this._opacityModifyRGB},setOpacityModifyRGB:function(newValue){this._opacityModifyRGB=newValue},isBlendAdditive:function(){return this._blendFunc.src===cc.SRC_ALPHA&&this._blendFunc.dst===cc.ONE||this._blendFunc.src===cc.ONE&&this._blendFunc.dst===cc.ONE},setBlendAdditive:function(isBlendAdditive){var locBlendFunc=this._blendFunc;isBlendAdditive?(locBlendFunc.src=cc.SRC_ALPHA,locBlendFunc.dst=cc.ONE):this._renderCmd._setBlendAdditive()},getPositionType:function(){return this.positionType},setPositionType:function(positionType){this.positionType=positionType},isAutoRemoveOnFinish:function(){return this.autoRemoveOnFinish},setAutoRemoveOnFinish:function(isAutoRemoveOnFinish){this.autoRemoveOnFinish=isAutoRemoveOnFinish},getEmitterMode:function(){return this.emitterMode},setEmitterMode:function(emitterMode){this.emitterMode=emitterMode},init:function(){return this.initWithTotalParticles(150)},initWithFile:function(plistFile){this._plistFile=plistFile;var dict=cc.loader.getRes(plistFile);return dict?this.initWithDictionary(dict,""):(cc.log("cc.ParticleSystem.initWithFile(): Particles: file not found"),!1)},getBoundingBoxToWorld:function(){return cc.rect(0,0,cc._canvas.width,cc._canvas.height)},initWithDictionary:function(dictionary,dirname){var ret=!1,buffer=null,locValueForKey=this._valueForKey,maxParticles=parseInt(locValueForKey("maxParticles",dictionary));if(this.initWithTotalParticles(maxParticles)){this.angle=parseFloat(locValueForKey("angle",dictionary)),this.angleVar=parseFloat(locValueForKey("angleVariance",dictionary)),this.duration=parseFloat(locValueForKey("duration",dictionary)),this._blendFunc.src=parseInt(locValueForKey("blendFuncSource",dictionary)),this._blendFunc.dst=parseInt(locValueForKey("blendFuncDestination",dictionary));var locStartColor=this._startColor;locStartColor.r=255*parseFloat(locValueForKey("startColorRed",dictionary)),locStartColor.g=255*parseFloat(locValueForKey("startColorGreen",dictionary)),locStartColor.b=255*parseFloat(locValueForKey("startColorBlue",dictionary)),locStartColor.a=255*parseFloat(locValueForKey("startColorAlpha",dictionary));var locStartColorVar=this._startColorVar;locStartColorVar.r=255*parseFloat(locValueForKey("startColorVarianceRed",dictionary)),locStartColorVar.g=255*parseFloat(locValueForKey("startColorVarianceGreen",dictionary)),locStartColorVar.b=255*parseFloat(locValueForKey("startColorVarianceBlue",dictionary)),locStartColorVar.a=255*parseFloat(locValueForKey("startColorVarianceAlpha",dictionary));var locEndColor=this._endColor;locEndColor.r=255*parseFloat(locValueForKey("finishColorRed",dictionary)),locEndColor.g=255*parseFloat(locValueForKey("finishColorGreen",dictionary)),locEndColor.b=255*parseFloat(locValueForKey("finishColorBlue",dictionary)),locEndColor.a=255*parseFloat(locValueForKey("finishColorAlpha",dictionary));var locEndColorVar=this._endColorVar;if(locEndColorVar.r=255*parseFloat(locValueForKey("finishColorVarianceRed",dictionary)),locEndColorVar.g=255*parseFloat(locValueForKey("finishColorVarianceGreen",dictionary)),locEndColorVar.b=255*parseFloat(locValueForKey("finishColorVarianceBlue",dictionary)),locEndColorVar.a=255*parseFloat(locValueForKey("finishColorVarianceAlpha",dictionary)),this.startSize=parseFloat(locValueForKey("startParticleSize",dictionary)),this.startSizeVar=parseFloat(locValueForKey("startParticleSizeVariance",dictionary)),this.endSize=parseFloat(locValueForKey("finishParticleSize",dictionary)),this.endSizeVar=parseFloat(locValueForKey("finishParticleSizeVariance",dictionary)),this.setPosition(parseFloat(locValueForKey("sourcePositionx",dictionary)),parseFloat(locValueForKey("sourcePositiony",dictionary))),this._posVar.x=parseFloat(locValueForKey("sourcePositionVariancex",dictionary)),this._posVar.y=parseFloat(locValueForKey("sourcePositionVariancey",dictionary)),this.startSpin=parseFloat(locValueForKey("rotationStart",dictionary)),this.startSpinVar=parseFloat(locValueForKey("rotationStartVariance",dictionary)),this.endSpin=parseFloat(locValueForKey("rotationEnd",dictionary)),this.endSpinVar=parseFloat(locValueForKey("rotationEndVariance",dictionary)),this.emitterMode=parseInt(locValueForKey("emitterType",dictionary)),this.emitterMode===cc.ParticleSystem.MODE_GRAVITY){var locModeA=this.modeA;locModeA.gravity.x=parseFloat(locValueForKey("gravityx",dictionary)),locModeA.gravity.y=parseFloat(locValueForKey("gravityy",dictionary)),locModeA.speed=parseFloat(locValueForKey("speed",dictionary)),locModeA.speedVar=parseFloat(locValueForKey("speedVariance",dictionary));var pszTmp=locValueForKey("radialAcceleration",dictionary);locModeA.radialAccel=pszTmp?parseFloat(pszTmp):0,pszTmp=locValueForKey("radialAccelVariance",dictionary),locModeA.radialAccelVar=pszTmp?parseFloat(pszTmp):0,pszTmp=locValueForKey("tangentialAcceleration",dictionary),locModeA.tangentialAccel=pszTmp?parseFloat(pszTmp):0,pszTmp=locValueForKey("tangentialAccelVariance",dictionary),locModeA.tangentialAccelVar=pszTmp?parseFloat(pszTmp):0;var locRotationIsDir=locValueForKey("rotationIsDir",dictionary);locModeA.rotationIsDir=null!==locRotationIsDir&&("true"===(locRotationIsDir=locRotationIsDir.toString().toLowerCase())||"1"===locRotationIsDir)}else{if(this.emitterMode!==cc.ParticleSystem.MODE_RADIUS)return cc.log("cc.ParticleSystem.initWithDictionary(): Invalid emitterType in config file"),!1;var locModeB=this.modeB;locModeB.startRadius=parseFloat(locValueForKey("maxRadius",dictionary)),locModeB.startRadiusVar=parseFloat(locValueForKey("maxRadiusVariance",dictionary)),locModeB.endRadius=parseFloat(locValueForKey("minRadius",dictionary)),locModeB.endRadiusVar=0,locModeB.rotatePerSecond=parseFloat(locValueForKey("rotatePerSecond",dictionary)),locModeB.rotatePerSecondVar=parseFloat(locValueForKey("rotatePerSecondVariance",dictionary))}if(this.life=parseFloat(locValueForKey("particleLifespan",dictionary)),this.lifeVar=parseFloat(locValueForKey("particleLifespanVariance",dictionary)),this.emissionRate=this._totalParticles/this.life,!this._batchNode){this._opacityModifyRGB=!1;var textureName=locValueForKey("textureFileName",dictionary),imgPath=cc.path.changeBasename(this._plistFile,textureName),tex=cc.textureCache.getTextureForKey(imgPath);if(tex)this.setTexture(tex);else{var textureData=locValueForKey("textureImageData",dictionary);if(textureData&&0!==textureData.length){if(!(buffer=cc.unzipBase64AsArray(textureData,1)))return cc.log("cc.ParticleSystem: error decoding or ungzipping textureImageData"),!1;var imageFormat=cc.getImageFormatByData(buffer);if(imageFormat!==cc.FMT_TIFF&&imageFormat!==cc.FMT_PNG)return cc.log("cc.ParticleSystem: unknown image format with Data"),!1;var canvasObj=document.createElement("canvas");if(imageFormat===cc.FMT_PNG)new cc.PNGReader(buffer).render(canvasObj);else cc.tiffReader.parseTIFF(buffer,canvasObj);cc.textureCache.cacheImage(imgPath,canvasObj);var addTexture=cc.textureCache.getTextureForKey(imgPath);addTexture||cc.log("cc.ParticleSystem.initWithDictionary() : error loading the texture"),this.setTexture(addTexture)}else{if(!(tex=cc.textureCache.addImage(imgPath)))return!1;this.setTexture(tex)}}}ret=!0}return ret},initWithTotalParticles:function(numberOfParticles){this._totalParticles=numberOfParticles;var i,locParticles=this._particles;for(i=locParticles.length=0;i<numberOfParticles;i++)locParticles[i]=new cc.Particle;if(!locParticles)return cc.log("Particle system: not enough memory"),!1;if(this._allocatedParticles=numberOfParticles,this._batchNode)for(i=0;i<this._totalParticles;i++)locParticles[i].atlasIndex=i;return this._isActive=!0,this._blendFunc.src=cc.BLEND_SRC,this._blendFunc.dst=cc.BLEND_DST,this.positionType=cc.ParticleSystem.TYPE_FREE,this.emitterMode=cc.ParticleSystem.MODE_GRAVITY,this.autoRemoveOnFinish=!1,this._transformSystemDirty=!1,this.scheduleUpdateWithPriority(1),this._renderCmd._initWithTotalParticles(numberOfParticles),!0},destroyParticleSystem:function(){this.unscheduleUpdate()},addParticle:function(){if(this.isFull())return!1;var particle=this._renderCmd.addParticle();return this.initParticle(particle),++this.particleCount,!0},initParticle:function(particle){var start,end,locRandomMinus11=cc.randomMinus1To1;particle.timeToLive=this.life+this.lifeVar*locRandomMinus11(),particle.timeToLive=Math.max(0,particle.timeToLive),particle.pos.x=this._sourcePosition.x+this._posVar.x*locRandomMinus11(),particle.pos.y=this._sourcePosition.y+this._posVar.y*locRandomMinus11();var locStartColor=this._startColor,locStartColorVar=this._startColorVar,locEndColor=this._endColor,locEndColorVar=this._endColorVar;start={r:cc.clampf(locStartColor.r+locStartColorVar.r*locRandomMinus11(),0,255),g:cc.clampf(locStartColor.g+locStartColorVar.g*locRandomMinus11(),0,255),b:cc.clampf(locStartColor.b+locStartColorVar.b*locRandomMinus11(),0,255),a:cc.clampf(locStartColor.a+locStartColorVar.a*locRandomMinus11(),0,255)},end={r:cc.clampf(locEndColor.r+locEndColorVar.r*locRandomMinus11(),0,255),g:cc.clampf(locEndColor.g+locEndColorVar.g*locRandomMinus11(),0,255),b:cc.clampf(locEndColor.b+locEndColorVar.b*locRandomMinus11(),0,255),a:cc.clampf(locEndColor.a+locEndColorVar.a*locRandomMinus11(),0,255)},particle.color=start;var locParticleDeltaColor=particle.deltaColor,locParticleTimeToLive=particle.timeToLive;locParticleDeltaColor.r=(end.r-start.r)/locParticleTimeToLive,locParticleDeltaColor.g=(end.g-start.g)/locParticleTimeToLive,locParticleDeltaColor.b=(end.b-start.b)/locParticleTimeToLive,locParticleDeltaColor.a=(end.a-start.a)/locParticleTimeToLive;var startS=this.startSize+this.startSizeVar*locRandomMinus11();if(startS=Math.max(0,startS),particle.size=startS,this.endSize===cc.ParticleSystem.START_SIZE_EQUAL_TO_END_SIZE)particle.deltaSize=0;else{var endS=this.endSize+this.endSizeVar*locRandomMinus11();endS=Math.max(0,endS),particle.deltaSize=(endS-startS)/locParticleTimeToLive}var startA=this.startSpin+this.startSpinVar*locRandomMinus11(),endA=this.endSpin+this.endSpinVar*locRandomMinus11();particle.rotation=startA,particle.deltaRotation=(endA-startA)/locParticleTimeToLive,this.positionType===cc.ParticleSystem.TYPE_FREE?particle.startPos=this.convertToWorldSpace(this._pointZeroForParticle):this.positionType===cc.ParticleSystem.TYPE_RELATIVE&&(particle.startPos.x=this._position.x,particle.startPos.y=this._position.y);var a=cc.degreesToRadians(this.angle+this.angleVar*locRandomMinus11());if(this.emitterMode===cc.ParticleSystem.MODE_GRAVITY){var locModeA=this.modeA,locParticleModeA=particle.modeA,s=locModeA.speed+locModeA.speedVar*locRandomMinus11();locParticleModeA.dir.x=Math.cos(a),locParticleModeA.dir.y=Math.sin(a),cc.pMultIn(locParticleModeA.dir,s),locParticleModeA.radialAccel=locModeA.radialAccel+locModeA.radialAccelVar*locRandomMinus11(),locParticleModeA.tangentialAccel=locModeA.tangentialAccel+locModeA.tangentialAccelVar*locRandomMinus11(),locModeA.rotationIsDir&&(particle.rotation=-cc.radiansToDegrees(cc.pToAngle(locParticleModeA.dir)))}else{var locModeB=this.modeB,locParitlceModeB=particle.modeB,startRadius=locModeB.startRadius+locModeB.startRadiusVar*locRandomMinus11(),endRadius=locModeB.endRadius+locModeB.endRadiusVar*locRandomMinus11();locParitlceModeB.radius=startRadius,locParitlceModeB.deltaRadius=locModeB.endRadius===cc.ParticleSystem.START_RADIUS_EQUAL_TO_END_RADIUS?0:(endRadius-startRadius)/locParticleTimeToLive,locParitlceModeB.angle=a,locParitlceModeB.degreesPerSecond=cc.degreesToRadians(locModeB.rotatePerSecond+locModeB.rotatePerSecondVar*locRandomMinus11())}},stopSystem:function(){this._isActive=!1,this._elapsed=this.duration,this._emitCounter=0},resetSystem:function(){this._isActive=!0,this._elapsed=0;var locParticles=this._particles;for(this._particleIdx=0;this._particleIdx<this.particleCount;++this._particleIdx)locParticles[this._particleIdx].timeToLive=0},isFull:function(){return this.particleCount>=this._totalParticles},updateQuadWithParticle:function(particle,newPosition){this._renderCmd.updateQuadWithParticle(particle,newPosition)},postStep:function(){this._renderCmd.postStep()},update:function(dt){if(this._isActive&&this.emissionRate){var rate=1/this.emissionRate;for(this.particleCount<this._totalParticles&&(this._emitCounter+=dt);this.particleCount<this._totalParticles&&this._emitCounter>rate;)this.addParticle(),this._emitCounter-=rate;this._elapsed+=dt,-1!==this.duration&&this.duration<this._elapsed&&this.stopSystem()}this._particleIdx=0;var currentPosition=cc.Particle.TemporaryPoints[0];if(this.positionType===cc.ParticleSystem.TYPE_FREE?cc.pIn(currentPosition,this.convertToWorldSpace(this._pointZeroForParticle)):this.positionType===cc.ParticleSystem.TYPE_RELATIVE&&(currentPosition.x=this._position.x,currentPosition.y=this._position.y),this._visible){for(var tpa=cc.Particle.TemporaryPoints[1],tpb=cc.Particle.TemporaryPoints[2],tpc=cc.Particle.TemporaryPoints[3],locParticles=this._particles;this._particleIdx<this.particleCount;){cc.pZeroIn(tpa),cc.pZeroIn(tpb),cc.pZeroIn(tpc);var selParticle=locParticles[this._particleIdx];if(selParticle.timeToLive-=dt,0<selParticle.timeToLive){if(this.emitterMode===cc.ParticleSystem.MODE_GRAVITY){var tmp=tpc,radial=tpa,tangential=tpb;selParticle.pos.x||selParticle.pos.y?(cc.pIn(radial,selParticle.pos),cc.pNormalizeIn(radial)):cc.pZeroIn(radial),cc.pIn(tangential,radial),cc.pMultIn(radial,selParticle.modeA.radialAccel);var newy=tangential.x;tangential.x=-tangential.y,tangential.y=newy,cc.pMultIn(tangential,selParticle.modeA.tangentialAccel),cc.pIn(tmp,radial),cc.pAddIn(tmp,tangential),cc.pAddIn(tmp,this.modeA.gravity),cc.pMultIn(tmp,dt),cc.pAddIn(selParticle.modeA.dir,tmp),cc.pIn(tmp,selParticle.modeA.dir),cc.pMultIn(tmp,dt),cc.pAddIn(selParticle.pos,tmp)}else{var selModeB=selParticle.modeB;selModeB.angle+=selModeB.degreesPerSecond*dt,selModeB.radius+=selModeB.deltaRadius*dt,selParticle.pos.x=-Math.cos(selModeB.angle)*selModeB.radius,selParticle.pos.y=-Math.sin(selModeB.angle)*selModeB.radius}this._renderCmd._updateDeltaColor(selParticle,dt),selParticle.size+=selParticle.deltaSize*dt,selParticle.size=Math.max(0,selParticle.size),selParticle.rotation+=selParticle.deltaRotation*dt;var newPos=tpa;if(this.positionType===cc.ParticleSystem.TYPE_FREE||this.positionType===cc.ParticleSystem.TYPE_RELATIVE){var diff=tpb;cc.pIn(diff,currentPosition),cc.pSubIn(diff,selParticle.startPos),cc.pIn(newPos,selParticle.pos),cc.pSubIn(newPos,diff)}else cc.pIn(newPos,selParticle.pos);this._batchNode&&(newPos.x+=this._position.x,newPos.y+=this._position.y),this._renderCmd.updateParticlePosition(selParticle,newPos),++this._particleIdx}else{var currentIndex=selParticle.atlasIndex;if(this._particleIdx!==this.particleCount-1){var deadParticle=locParticles[this._particleIdx];locParticles[this._particleIdx]=locParticles[this.particleCount-1],locParticles[this.particleCount-1]=deadParticle}if(this._batchNode&&(this._batchNode.disableParticle(this.atlasIndex+currentIndex),locParticles[this.particleCount-1].atlasIndex=currentIndex),--this.particleCount,0===this.particleCount&&this.autoRemoveOnFinish)return this.unscheduleUpdate(),void this._parent.removeChild(this,!0)}}this._transformSystemDirty=!1}this._batchNode||this.postStep()},updateWithNoTime:function(){this.update(0)},_valueForKey:function(key,dict){if(dict){var pString=dict[key];return null!=pString?pString:""}return""},_updateBlendFunc:function(){if(this._batchNode)cc.log("Can't change blending functions when the particle is being batched");else{var locTexture=this._texture;if(locTexture&&locTexture instanceof cc.Texture2D){this._opacityModifyRGB=!1;var locBlendFunc=this._blendFunc;locBlendFunc.src===cc.BLEND_SRC&&locBlendFunc.dst===cc.BLEND_DST&&(locTexture.hasPremultipliedAlpha()?this._opacityModifyRGB=!0:(locBlendFunc.src=cc.SRC_ALPHA,locBlendFunc.dst=cc.ONE_MINUS_SRC_ALPHA))}}},clone:function(){var retParticle=new cc.ParticleSystem;if(retParticle.initWithTotalParticles(this.getTotalParticles())){retParticle.setAngle(this.getAngle()),retParticle.setAngleVar(this.getAngleVar()),retParticle.setDuration(this.getDuration());var blend=this.getBlendFunc();if(retParticle.setBlendFunc(blend.src,blend.dst),retParticle.setStartColor(this.getStartColor()),retParticle.setStartColorVar(this.getStartColorVar()),retParticle.setEndColor(this.getEndColor()),retParticle.setEndColorVar(this.getEndColorVar()),retParticle.setStartSize(this.getStartSize()),retParticle.setStartSizeVar(this.getStartSizeVar()),retParticle.setEndSize(this.getEndSize()),retParticle.setEndSizeVar(this.getEndSizeVar()),retParticle.setPosition(cc.p(this.x,this.y)),retParticle.setPosVar(cc.p(this.getPosVar().x,this.getPosVar().y)),retParticle.setPositionType(this.getPositionType()),retParticle.setStartSpin(this.getStartSpin()||0),retParticle.setStartSpinVar(this.getStartSpinVar()||0),retParticle.setEndSpin(this.getEndSpin()||0),retParticle.setEndSpinVar(this.getEndSpinVar()||0),retParticle.setEmitterMode(this.getEmitterMode()),this.getEmitterMode()===cc.ParticleSystem.MODE_GRAVITY){var gra=this.getGravity();retParticle.setGravity(cc.p(gra.x,gra.y)),retParticle.setSpeed(this.getSpeed()),retParticle.setSpeedVar(this.getSpeedVar()),retParticle.setRadialAccel(this.getRadialAccel()),retParticle.setRadialAccelVar(this.getRadialAccelVar()),retParticle.setTangentialAccel(this.getTangentialAccel()),retParticle.setTangentialAccelVar(this.getTangentialAccelVar())}else this.getEmitterMode()===cc.ParticleSystem.MODE_RADIUS&&(retParticle.setStartRadius(this.getStartRadius()),retParticle.setStartRadiusVar(this.getStartRadiusVar()),retParticle.setEndRadius(this.getEndRadius()),retParticle.setEndRadiusVar(this.getEndRadiusVar()),retParticle.setRotatePerSecond(this.getRotatePerSecond()),retParticle.setRotatePerSecondVar(this.getRotatePerSecondVar()));if(retParticle.setLife(this.getLife()),retParticle.setLifeVar(this.getLifeVar()),retParticle.setEmissionRate(this.getEmissionRate()),!this.getBatchNode()){retParticle.setOpacityModifyRGB(this.isOpacityModifyRGB());var texture=this.getTexture();if(texture){var size=texture.getContentSize();retParticle.setTextureWithRect(texture,cc.rect(0,0,size.width,size.height))}}}return retParticle},setDisplayFrame:function(spriteFrame){if(spriteFrame){var locOffset=spriteFrame.getOffsetInPixels();0===locOffset.x&&0===locOffset.y||cc.log("cc.ParticleSystem.setDisplayFrame(): QuadParticle only supports SpriteFrames with no offsets");var texture=spriteFrame.getTexture();this._texture!==texture&&this.setTexture(texture)}},setTextureWithRect:function(texture,rect){this._texture!==texture&&(this._texture=texture,this._updateBlendFunc()),this.initTexCoordsWithRect(rect)},listenBackToForeground:function(obj){}}),(_p=cc.ParticleSystem.prototype).opacityModifyRGB,cc.defineGetterSetter(_p,"opacityModifyRGB",_p.isOpacityModifyRGB,_p.setOpacityModifyRGB),_p.batchNode,cc.defineGetterSetter(_p,"batchNode",_p.getBatchNode,_p.setBatchNode),_p.drawMode,cc.defineGetterSetter(_p,"drawMode",_p.getDrawMode,_p.setDrawMode),_p.shapeType,cc.defineGetterSetter(_p,"shapeType",_p.getShapeType,_p.setShapeType),_p.active,cc.defineGetterSetter(_p,"active",_p.isActive),_p.sourcePos,cc.defineGetterSetter(_p,"sourcePos",_p.getSourcePosition,_p.setSourcePosition),_p.posVar,cc.defineGetterSetter(_p,"posVar",_p.getPosVar,_p.setPosVar),_p.gravity,cc.defineGetterSetter(_p,"gravity",_p.getGravity,_p.setGravity),_p.speed,cc.defineGetterSetter(_p,"speed",_p.getSpeed,_p.setSpeed),_p.speedVar,cc.defineGetterSetter(_p,"speedVar",_p.getSpeedVar,_p.setSpeedVar),_p.tangentialAccel,cc.defineGetterSetter(_p,"tangentialAccel",_p.getTangentialAccel,_p.setTangentialAccel),_p.tangentialAccelVar,cc.defineGetterSetter(_p,"tangentialAccelVar",_p.getTangentialAccelVar,_p.setTangentialAccelVar),_p.radialAccel,cc.defineGetterSetter(_p,"radialAccel",_p.getRadialAccel,_p.setRadialAccel),_p.radialAccelVar,cc.defineGetterSetter(_p,"radialAccelVar",_p.getRadialAccelVar,_p.setRadialAccelVar),_p.rotationIsDir,cc.defineGetterSetter(_p,"rotationIsDir",_p.getRotationIsDir,_p.setRotationIsDir),_p.startRadius,cc.defineGetterSetter(_p,"startRadius",_p.getStartRadius,_p.setStartRadius),_p.startRadiusVar,cc.defineGetterSetter(_p,"startRadiusVar",_p.getStartRadiusVar,_p.setStartRadiusVar),_p.endRadius,cc.defineGetterSetter(_p,"endRadius",_p.getEndRadius,_p.setEndRadius),_p.endRadiusVar,cc.defineGetterSetter(_p,"endRadiusVar",_p.getEndRadiusVar,_p.setEndRadiusVar),_p.rotatePerS,cc.defineGetterSetter(_p,"rotatePerS",_p.getRotatePerSecond,_p.setRotatePerSecond),_p.rotatePerSVar,cc.defineGetterSetter(_p,"rotatePerSVar",_p.getRotatePerSecondVar,_p.setRotatePerSecondVar),_p.startColor,cc.defineGetterSetter(_p,"startColor",_p.getStartColor,_p.setStartColor),_p.startColorVar,cc.defineGetterSetter(_p,"startColorVar",_p.getStartColorVar,_p.setStartColorVar),_p.endColor,cc.defineGetterSetter(_p,"endColor",_p.getEndColor,_p.setEndColor),_p.endColorVar,cc.defineGetterSetter(_p,"endColorVar",_p.getEndColorVar,_p.setEndColorVar),_p.totalParticles,cc.defineGetterSetter(_p,"totalParticles",_p.getTotalParticles,_p.setTotalParticles),_p.texture,cc.defineGetterSetter(_p,"texture",_p.getTexture,_p.setTexture),cc.ParticleSystem.create=function(plistFile){return new cc.ParticleSystem(plistFile)},cc.ParticleSystem.createWithTotalParticles=cc.ParticleSystem.create,cc.ParticleSystem.ModeA=function(gravity,speed,speedVar,tangentialAccel,tangentialAccelVar,radialAccel,radialAccelVar,rotationIsDir){this.gravity=gravity||cc.p(0,0),this.speed=speed||0,this.speedVar=speedVar||0,this.tangentialAccel=tangentialAccel||0,this.tangentialAccelVar=tangentialAccelVar||0,this.radialAccel=radialAccel||0,this.radialAccelVar=radialAccelVar||0,this.rotationIsDir=rotationIsDir||!1},cc.ParticleSystem.ModeB=function(startRadius,startRadiusVar,endRadius,endRadiusVar,rotatePerSecond,rotatePerSecondVar){this.startRadius=startRadius||0,this.startRadiusVar=startRadiusVar||0,this.endRadius=endRadius||0,this.endRadiusVar=endRadiusVar||0,this.rotatePerSecond=rotatePerSecond||0,this.rotatePerSecondVar=rotatePerSecondVar||0},cc.ParticleSystem.SHAPE_MODE=0,cc.ParticleSystem.TEXTURE_MODE=1,cc.ParticleSystem.STAR_SHAPE=0,cc.ParticleSystem.BALL_SHAPE=1,cc.ParticleSystem.DURATION_INFINITY=-1,cc.ParticleSystem.START_SIZE_EQUAL_TO_END_SIZE=-1,cc.ParticleSystem.START_RADIUS_EQUAL_TO_END_RADIUS=-1,cc.ParticleSystem.MODE_GRAVITY=0,cc.ParticleSystem.MODE_RADIUS=1,cc.ParticleSystem.TYPE_FREE=0,cc.ParticleSystem.TYPE_RELATIVE=1,cc.ParticleSystem.TYPE_GROUPED=2,function(){cc.ParticleSystem.CanvasRenderCmd=function(renderable){this._rootCtor(renderable),this._needDraw=!0,this._drawMode=cc.ParticleSystem.TEXTURE_MODE,this._shapeType=cc.ParticleSystem.BALL_SHAPE,this._pointRect=cc.rect(0,0,0,0),this._tintCache=null};var proto=cc.ParticleSystem.CanvasRenderCmd.prototype=Object.create(cc.Node.CanvasRenderCmd.prototype);proto.constructor=cc.ParticleSystem.CanvasRenderCmd,proto.getDrawMode=function(){return this._drawMode},proto.setDrawMode=function(drawMode){this._drawMode=drawMode},proto.getShapeType=function(){return this._shapeType},proto.setShapeType=function(shapeType){this._shapeType=shapeType},proto.setBatchNode=function(batchNode){this._batchNode!==batchNode&&(this._node._batchNode=batchNode)},proto.updateQuadWithParticle=function(particle,newPosition){},proto.updateParticlePosition=function(particle,position){cc.pIn(particle.drawPos,position)},proto.rendering=function(ctx,scaleX,scaleY){var i,particle,lpx,alpha,wrapper=ctx||cc._renderContext,context=wrapper.getContext(),node=this._node,pointRect=this._pointRect;wrapper.setTransform(this._worldTransform,scaleX,scaleY),wrapper.save(),node.isBlendAdditive()?context.globalCompositeOperation="lighter":context.globalCompositeOperation="source-over";var particleCount=this._node.particleCount,particles=this._node._particles;if(node.drawMode!==cc.ParticleSystem.SHAPE_MODE&&node._texture){if(!node._texture._textureLoaded)return void wrapper.restore();var element=node._texture.getHtmlElementObj();if(!element.width||!element.height)return void wrapper.restore();var drawElement=element;for(i=0;i<particleCount;i++)if(lpx=0|.5*(particle=particles[i]).size,0!==(alpha=particle.color.a/255)){context.globalAlpha=alpha,context.save(),context.translate(0|particle.drawPos.x,-(0|particle.drawPos.y));var size=4*Math.floor(particle.size/4),w=pointRect.width,h=pointRect.height;context.scale(Math.max(1/w*size,1e-6),Math.max(1/h*size,1e-6)),particle.rotation&&context.rotate(cc.degreesToRadians(particle.rotation)),drawElement=particle.isChangeColor?this._changeTextureColor(node._texture,particle.color,this._pointRect):element,context.drawImage(drawElement,-(0|w/2),-(0|h/2)),context.restore()}}else{var drawTool=cc._drawingUtil;for(i=0;i<particleCount;i++)lpx=0|.5*(particle=particles[i]).size,0!==(alpha=particle.color.a/255)&&(context.globalAlpha=alpha,context.save(),context.translate(0|particle.drawPos.x,-(0|particle.drawPos.y)),node.shapeType===cc.ParticleSystem.STAR_SHAPE?(particle.rotation&&context.rotate(cc.degreesToRadians(particle.rotation)),drawTool.drawStar(wrapper,lpx,particle.color)):drawTool.drawColorBall(wrapper,lpx,particle.color),context.restore())}wrapper.restore(),cc.g_NumberOfDraws++},proto._changeTextureColor=function(texture,color,rect){this._tintCache||(this._tintCache=document.createElement("canvas"));var tintCache=this._tintCache,textureContentSize=texture.getContentSize();return tintCache.width=textureContentSize.width,tintCache.height=textureContentSize.height,texture._generateColorTexture(color.r,color.g,color.b,rect,tintCache)},proto.initTexCoordsWithRect=function(pointRect){this._pointRect=pointRect},proto.setTotalParticles=function(tp){this._node._totalParticles=tp<200?tp:200},proto.addParticle=function(){var particle,node=this._node,particles=node._particles;return node.particleCount<particles.length?particle=particles[node.particleCount]:(particle=new cc.Particle,particles.push(particle)),particle},proto._setupVBO=function(){},proto._allocMemory=function(){return!0},proto.postStep=function(){},proto._setBlendAdditive=function(){var locBlendFunc=this._node._blendFunc;locBlendFunc.src=cc.BLEND_SRC,locBlendFunc.dst=cc.BLEND_DST},proto._initWithTotalParticles=function(totalParticles){},proto._updateDeltaColor=function(selParticle,dt){this._node._dontTint||(selParticle.color.r+=selParticle.deltaColor.r*dt,selParticle.color.g+=selParticle.deltaColor.g*dt,selParticle.color.b+=selParticle.deltaColor.b*dt,selParticle.color.a+=selParticle.deltaColor.a*dt,selParticle.isChangeColor=!0)}}(),function(){cc.ParticleSystem.WebGLRenderCmd=function(renderable){this._rootCtor(renderable),this._needDraw=!0,this._matrix=null,this._buffersVBO=[0,0],this._quads=[],this._indices=[],this._quadsArrayBuffer=null};var proto=cc.ParticleSystem.WebGLRenderCmd.prototype=Object.create(cc.Node.WebGLRenderCmd.prototype);proto.constructor=cc.ParticleSystem.WebGLRenderCmd,proto.getDrawMode=function(){},proto.setDrawMode=function(drawMode){},proto.getShapeType=function(){},proto.setShapeType=function(shapeType){},proto.setBatchNode=function(batchNode){var node=this._node;if(node._batchNode!==batchNode){var oldBatch=node._batchNode;if(node._batchNode=batchNode)for(var locParticles=node._particles,i=0;i<node._totalParticles;i++)locParticles[i].atlasIndex=i;batchNode?oldBatch||(node._batchNode.textureAtlas._copyQuadsToTextureAtlas(this._quads,node.atlasIndex),cc._renderContext.deleteBuffer(this._buffersVBO[1])):(this._allocMemory(),this.initIndices(node._totalParticles),node.setTexture(oldBatch.getTexture()),this._setupVBO())}},proto.initIndices=function(totalParticles){for(var locIndices=this._indices,i=0,len=totalParticles;i<len;++i){var i6=6*i,i4=4*i;locIndices[i6+0]=i4+0,locIndices[i6+1]=i4+1,locIndices[i6+2]=i4+2,locIndices[i6+5]=i4+1,locIndices[i6+4]=i4+2,locIndices[i6+3]=i4+3}},proto.isDifferentTexture=function(texture1,texture2){return texture1===texture2},proto.updateParticlePosition=function(particle,position){this.updateQuadWithParticle(particle,position)},proto.updateQuadWithParticle=function(particle,newPosition){var r,g,b,a,quad=null,node=this._node;node._batchNode?(quad=node._batchNode.textureAtlas.quads[node.atlasIndex+particle.atlasIndex],node._batchNode.textureAtlas.dirty=!0):quad=this._quads[node._particleIdx];b=node._opacityModifyRGB?(r=0|particle.color.r*particle.color.a/255,g=0|particle.color.g*particle.color.a/255,0|particle.color.b*particle.color.a/255):(r=0|particle.color.r,g=0|particle.color.g,0|particle.color.b),a=0|particle.color.a;var blColors=quad.bl.colors,brColors=quad.br.colors,tlColors=quad.tl.colors,trColors=quad.tr.colors;blColors.r=brColors.r=tlColors.r=trColors.r=r,blColors.g=brColors.g=tlColors.g=trColors.g=g,blColors.b=brColors.b=tlColors.b=trColors.b=b,blColors.a=brColors.a=tlColors.a=trColors.a=a;var size_2=particle.size/2;if(particle.rotation){var x1=-size_2,y1=-size_2,x2=size_2,y2=size_2,x=newPosition.x,y=newPosition.y,rad=-cc.degreesToRadians(particle.rotation),cr=Math.cos(rad),sr=Math.sin(rad),ax=x1*cr-y1*sr+x,ay=x1*sr+y1*cr+y,bx=x2*cr-y1*sr+x,by=x2*sr+y1*cr+y,cx=x2*cr-y2*sr+x,cy=x2*sr+y2*cr+y,dx=x1*cr-y2*sr+x,dy=x1*sr+y2*cr+y;quad.bl.vertices.x=ax,quad.bl.vertices.y=ay,quad.br.vertices.x=bx,quad.br.vertices.y=by,quad.tl.vertices.x=dx,quad.tl.vertices.y=dy,quad.tr.vertices.x=cx,quad.tr.vertices.y=cy}else quad.bl.vertices.x=newPosition.x-size_2,quad.bl.vertices.y=newPosition.y-size_2,quad.br.vertices.x=newPosition.x+size_2,quad.br.vertices.y=newPosition.y-size_2,quad.tl.vertices.x=newPosition.x-size_2,quad.tl.vertices.y=newPosition.y+size_2,quad.tr.vertices.x=newPosition.x+size_2,quad.tr.vertices.y=newPosition.y+size_2},proto.rendering=function(ctx){var node=this._node;if(node._texture){var gl=ctx||cc._renderContext;this._matrix||(this._matrix=new cc.math.Matrix4,this._matrix.identity());var wt=this._worldTransform;this._matrix.mat[0]=wt.a,this._matrix.mat[4]=wt.c,this._matrix.mat[12]=wt.tx,this._matrix.mat[1]=wt.b,this._matrix.mat[5]=wt.d,this._matrix.mat[13]=wt.ty,this._shaderProgram.use(),this._shaderProgram._setUniformForMVPMatrixWithMat4(this._matrix),cc.glBindTexture2D(node._texture),cc.glBlendFuncForParticle(node._blendFunc.src,node._blendFunc.dst),gl.enableVertexAttribArray(cc.VERTEX_ATTRIB_POSITION),gl.enableVertexAttribArray(cc.VERTEX_ATTRIB_COLOR),gl.enableVertexAttribArray(cc.VERTEX_ATTRIB_TEX_COORDS),gl.bindBuffer(gl.ARRAY_BUFFER,this._buffersVBO[0]),gl.vertexAttribPointer(cc.VERTEX_ATTRIB_POSITION,3,gl.FLOAT,!1,24,0),gl.vertexAttribPointer(cc.VERTEX_ATTRIB_COLOR,4,gl.UNSIGNED_BYTE,!0,24,12),gl.vertexAttribPointer(cc.VERTEX_ATTRIB_TEX_COORDS,2,gl.FLOAT,!1,24,16),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this._buffersVBO[1]),gl.drawElements(gl.TRIANGLES,6*node._particleIdx,gl.UNSIGNED_SHORT,0)}},proto.initTexCoordsWithRect=function(pointRect){var left,bottom,right,top,node=this._node,texture=node.texture,scaleFactor=cc.contentScaleFactor(),rect=cc.rect(pointRect.x*scaleFactor,pointRect.y*scaleFactor,pointRect.width*scaleFactor,pointRect.height*scaleFactor),wide=pointRect.width,high=pointRect.height;texture&&(wide=texture.pixelsWidth,high=texture.pixelsHeight);var quads,temp=top=cc.FIX_ARTIFACTS_BY_STRECHING_TEXEL?(left=(2*rect.x+1)/(2*wide),bottom=(2*rect.y+1)/(2*high),right=left+(2*rect.width-2)/(2*wide),bottom+(2*rect.height-2)/(2*high)):(left=rect.x/wide,bottom=rect.y/high,right=left+rect.width/wide,bottom+rect.height/high);top=bottom,bottom=temp;var start=0,end=0;end=node._batchNode?(quads=node._batchNode.textureAtlas.quads,start=node.atlasIndex,node.atlasIndex+node._totalParticles):(quads=this._quads,start=0,node._totalParticles);for(var i=start;i<end;i++){quads[i]||(quads[i]=cc.V3F_C4B_T2F_QuadZero());var selQuad=quads[i];selQuad.bl.texCoords.u=left,selQuad.bl.texCoords.v=bottom,selQuad.br.texCoords.u=right,selQuad.br.texCoords.v=bottom,selQuad.tl.texCoords.u=left,selQuad.tl.texCoords.v=top,selQuad.tr.texCoords.u=right,selQuad.tr.texCoords.v=top}},proto.setTotalParticles=function(tp){var node=this._node;if(tp>node._allocatedParticles){var quadSize=cc.V3F_C4B_T2F_Quad.BYTES_PER_ELEMENT;this._indices=new Uint16Array(6*tp);var locQuadsArrayBuffer=new ArrayBuffer(tp*quadSize),locParticles=node._particles;locParticles.length=0;for(var locQuads=this._quads,j=locQuads.length=0;j<tp;j++)locParticles[j]=new cc.Particle,locQuads[j]=new cc.V3F_C4B_T2F_Quad(null,null,null,null,locQuadsArrayBuffer,j*quadSize);if(node._allocatedParticles=tp,node._totalParticles=tp,node._batchNode)for(var i=0;i<tp;i++)locParticles[i].atlasIndex=i;this._quadsArrayBuffer=locQuadsArrayBuffer,this.initIndices(tp),this._setupVBO(),node._texture&&this.initTexCoordsWithRect(cc.rect(0,0,node._texture.width,node._texture.height))}else node._totalParticles=tp;node.resetSystem()},proto.addParticle=function(){var node=this._node;return node._particles[node.particleCount]},proto._setupVBO=function(){var gl=cc._renderContext;this._buffersVBO[0]=gl.createBuffer(),gl.bindBuffer(gl.ARRAY_BUFFER,this._buffersVBO[0]),gl.bufferData(gl.ARRAY_BUFFER,this._quadsArrayBuffer,gl.DYNAMIC_DRAW),this._buffersVBO[1]=gl.createBuffer(),gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this._buffersVBO[1]),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,this._indices,gl.STATIC_DRAW)},proto._allocMemory=function(){var node=this._node;if(node._batchNode)return cc.log("cc.ParticleSystem._allocMemory(): Memory should not be allocated when not using batchNode"),!1;var quadSize=cc.V3F_C4B_T2F_Quad.BYTES_PER_ELEMENT,totalParticles=node._totalParticles,locQuads=this._quads;locQuads.length=0,this._indices=new Uint16Array(6*totalParticles);for(var locQuadsArrayBuffer=new ArrayBuffer(quadSize*totalParticles),i=0;i<totalParticles;i++)locQuads[i]=new cc.V3F_C4B_T2F_Quad(null,null,null,null,locQuadsArrayBuffer,i*quadSize);return locQuads&&this._indices?(this._quadsArrayBuffer=locQuadsArrayBuffer,!0):(cc.log("cocos2d: Particle system: not enough memory"),!1)},proto.postStep=function(){var gl=cc._renderContext;gl.bindBuffer(gl.ARRAY_BUFFER,this._buffersVBO[0]),gl.bufferSubData(gl.ARRAY_BUFFER,0,this._quadsArrayBuffer)},proto._setBlendAdditive=function(){var locBlendFunc=this._node._blendFunc;this._texture&&!this._texture.hasPremultipliedAlpha()?(locBlendFunc.src=cc.SRC_ALPHA,locBlendFunc.dst=cc.ONE_MINUS_SRC_ALPHA):(locBlendFunc.src=cc.BLEND_SRC,locBlendFunc.dst=cc.BLEND_DST)},proto._initWithTotalParticles=function(totalParticles){if(!this._allocMemory())return!1;this.initIndices(totalParticles),this._setupVBO(),this._shaderProgram=cc.shaderCache.programForKey(cc.SHADER_POSITION_TEXTURECOLOR)},proto._updateDeltaColor=function(selParticle,dt){selParticle.color.r+=selParticle.deltaColor.r*dt,selParticle.color.g+=selParticle.deltaColor.g*dt,selParticle.color.b+=selParticle.deltaColor.b*dt,selParticle.color.a+=selParticle.deltaColor.a*dt,selParticle.isChangeColor=!0}}(),cc.ParticleFire=cc.ParticleSystem.extend({ctor:function(){cc.ParticleSystem.prototype.ctor.call(this,cc._renderType===cc.game.RENDER_TYPE_WEBGL?300:150)},initWithTotalParticles:function(numberOfParticles){if(cc.ParticleSystem.prototype.initWithTotalParticles.call(this,numberOfParticles)){this.setDuration(cc.ParticleSystem.DURATION_INFINITY),this.setEmitterMode(cc.ParticleSystem.MODE_GRAVITY),this.setGravity(cc.p(0,0)),this.setRadialAccel(0),this.setRadialAccelVar(0),this.setSpeed(60),this.setSpeedVar(20),this.setAngle(90),this.setAngleVar(10);var winSize=cc.director.getWinSize();return this.setPosition(winSize.width/2,60),this.setPosVar(cc.p(40,20)),this.setLife(3),this.setLifeVar(.25),this.setStartSize(54),this.setStartSizeVar(10),this.setEndSize(cc.ParticleSystem.START_SIZE_EQUAL_TO_END_SIZE),this.setEmissionRate(this.getTotalParticles()/this.getLife()),this.setStartColor(cc.color(194,64,31,255)),this.setStartColorVar(cc.color(0,0,0,0)),this.setEndColor(cc.color(0,0,0,255)),this.setEndColorVar(cc.color(0,0,0,0)),this.setBlendAdditive(!0),!0}return!1}}),cc.ParticleFire.create=function(){return new cc.ParticleFire},cc.ParticleFireworks=cc.ParticleSystem.extend({ctor:function(){cc.ParticleSystem.prototype.ctor.call(this,cc._renderType===cc.game.RENDER_TYPE_WEBGL?1500:150)},initWithTotalParticles:function(numberOfParticles){if(cc.ParticleSystem.prototype.initWithTotalParticles.call(this,numberOfParticles)){this.setDuration(cc.ParticleSystem.DURATION_INFINITY),this.setEmitterMode(cc.ParticleSystem.MODE_GRAVITY),this.setGravity(cc.p(0,-90)),this.setRadialAccel(0),this.setRadialAccelVar(0),this.setSpeed(180),this.setSpeedVar(50);var winSize=cc.director.getWinSize();return this.setPosition(winSize.width/2,winSize.height/2),this.setAngle(90),this.setAngleVar(20),this.setLife(3.5),this.setLifeVar(1),this.setEmissionRate(this.getTotalParticles()/this.getLife()),this.setStartColor(cc.color(128,128,128,255)),this.setStartColorVar(cc.color(128,128,128,255)),this.setEndColor(cc.color(26,26,26,51)),this.setEndColorVar(cc.color(26,26,26,51)),this.setStartSize(8),this.setStartSizeVar(2),this.setEndSize(cc.ParticleSystem.START_SIZE_EQUAL_TO_END_SIZE),this.setBlendAdditive(!1),!0}return!1}}),cc.ParticleFireworks.create=function(){return new cc.ParticleFireworks},cc.ParticleSun=cc.ParticleSystem.extend({ctor:function(){cc.ParticleSystem.prototype.ctor.call(this,cc._renderType===cc.game.RENDER_TYPE_WEBGL?350:150)},initWithTotalParticles:function(numberOfParticles){if(cc.ParticleSystem.prototype.initWithTotalParticles.call(this,numberOfParticles)){this.setBlendAdditive(!0),this.setDuration(cc.ParticleSystem.DURATION_INFINITY),this.setEmitterMode(cc.ParticleSystem.MODE_GRAVITY),this.setGravity(cc.p(0,0)),this.setRadialAccel(0),this.setRadialAccelVar(0),this.setSpeed(20),this.setSpeedVar(5),this.setAngle(90),this.setAngleVar(360);var winSize=cc.director.getWinSize();return this.setPosition(winSize.width/2,winSize.height/2),this.setPosVar(cc.p(0,0)),this.setLife(1),this.setLifeVar(.5),this.setStartSize(30),this.setStartSizeVar(10),this.setEndSize(cc.ParticleSystem.START_SIZE_EQUAL_TO_END_SIZE),this.setEmissionRate(this.getTotalParticles()/this.getLife()),this.setStartColor(cc.color(194,64,31,255)),this.setStartColorVar(cc.color(0,0,0,0)),this.setEndColor(cc.color(0,0,0,255)),this.setEndColorVar(cc.color(0,0,0,0)),!0}return!1}}),cc.ParticleSun.create=function(){return new cc.ParticleSun},cc.ParticleGalaxy=cc.ParticleSystem.extend({ctor:function(){cc.ParticleSystem.prototype.ctor.call(this,cc._renderType===cc.game.RENDER_TYPE_WEBGL?200:100)},initWithTotalParticles:function(numberOfParticles){if(cc.ParticleSystem.prototype.initWithTotalParticles.call(this,numberOfParticles)){this.setDuration(cc.ParticleSystem.DURATION_INFINITY),this.setEmitterMode(cc.ParticleSystem.MODE_GRAVITY),this.setGravity(cc.p(0,0)),this.setSpeed(60),this.setSpeedVar(10),this.setRadialAccel(-80),this.setRadialAccelVar(0),this.setTangentialAccel(80),this.setTangentialAccelVar(0),this.setAngle(90),this.setAngleVar(360);var winSize=cc.director.getWinSize();return this.setPosition(winSize.width/2,winSize.height/2),this.setPosVar(cc.p(0,0)),this.setLife(4),this.setLifeVar(1),this.setStartSize(37),this.setStartSizeVar(10),this.setEndSize(cc.ParticleSystem.START_SIZE_EQUAL_TO_END_SIZE),this.setEmissionRate(this.getTotalParticles()/this.getLife()),this.setStartColor(cc.color(31,64,194,255)),this.setStartColorVar(cc.color(0,0,0,0)),this.setEndColor(cc.color(0,0,0,255)),this.setEndColorVar(cc.color(0,0,0,0)),this.setBlendAdditive(!0),!0}return!1}}),cc.ParticleGalaxy.create=function(){return new cc.ParticleGalaxy},cc.ParticleFlower=cc.ParticleSystem.extend({ctor:function(){cc.ParticleSystem.prototype.ctor.call(this,cc._renderType===cc.game.RENDER_TYPE_WEBGL?250:100)},initWithTotalParticles:function(numberOfParticles){if(cc.ParticleSystem.prototype.initWithTotalParticles.call(this,numberOfParticles)){this.setDuration(cc.ParticleSystem.DURATION_INFINITY),this.setEmitterMode(cc.ParticleSystem.MODE_GRAVITY),this.setGravity(cc.p(0,0)),this.setSpeed(80),this.setSpeedVar(10),this.setRadialAccel(-60),this.setRadialAccelVar(0),this.setTangentialAccel(15),this.setTangentialAccelVar(0),this.setAngle(90),this.setAngleVar(360);var winSize=cc.director.getWinSize();return this.setPosition(winSize.width/2,winSize.height/2),this.setPosVar(cc.p(0,0)),this.setLife(4),this.setLifeVar(1),this.setStartSize(30),this.setStartSizeVar(10),this.setEndSize(cc.ParticleSystem.START_SIZE_EQUAL_TO_END_SIZE),this.setEmissionRate(this.getTotalParticles()/this.getLife()),this.setStartColor(cc.color(128,128,128,255)),this.setStartColorVar(cc.color(128,128,128,128)),this.setEndColor(cc.color(0,0,0,255)),this.setEndColorVar(cc.color(0,0,0,0)),this.setBlendAdditive(!0),!0}return!1}}),cc.ParticleFlower.create=function(){return new cc.ParticleFlower},cc.ParticleMeteor=cc.ParticleSystem.extend({ctor:function(){cc.ParticleSystem.prototype.ctor.call(this,cc._renderType===cc.game.RENDER_TYPE_WEBGL?150:100)},initWithTotalParticles:function(numberOfParticles){if(cc.ParticleSystem.prototype.initWithTotalParticles.call(this,numberOfParticles)){this.setDuration(cc.ParticleSystem.DURATION_INFINITY),this.setEmitterMode(cc.ParticleSystem.MODE_GRAVITY),this.setGravity(cc.p(-200,200)),this.setSpeed(15),this.setSpeedVar(5),this.setRadialAccel(0),this.setRadialAccelVar(0),this.setTangentialAccel(0),this.setTangentialAccelVar(0),this.setAngle(90),this.setAngleVar(360);var winSize=cc.director.getWinSize();return this.setPosition(winSize.width/2,winSize.height/2),this.setPosVar(cc.p(0,0)),this.setLife(2),this.setLifeVar(1),this.setStartSize(60),this.setStartSizeVar(10),this.setEndSize(cc.ParticleSystem.START_SIZE_EQUAL_TO_END_SIZE),this.setEmissionRate(this.getTotalParticles()/this.getLife()),this.setStartColor(cc.color(51,102,179)),this.setStartColorVar(cc.color(0,0,51,26)),this.setEndColor(cc.color(0,0,0,255)),this.setEndColorVar(cc.color(0,0,0,0)),this.setBlendAdditive(!0),!0}return!1}}),cc.ParticleMeteor.create=function(){return new cc.ParticleMeteor},cc.ParticleSpiral=cc.ParticleSystem.extend({ctor:function(){cc.ParticleSystem.prototype.ctor.call(this,cc._renderType===cc.game.RENDER_TYPE_WEBGL?500:100)},initWithTotalParticles:function(numberOfParticles){if(cc.ParticleSystem.prototype.initWithTotalParticles.call(this,numberOfParticles)){this.setDuration(cc.ParticleSystem.DURATION_INFINITY),this.setEmitterMode(cc.ParticleSystem.MODE_GRAVITY),this.setGravity(cc.p(0,0)),this.setSpeed(150),this.setSpeedVar(0),this.setRadialAccel(-380),this.setRadialAccelVar(0),this.setTangentialAccel(45),this.setTangentialAccelVar(0),this.setAngle(90),this.setAngleVar(0);var winSize=cc.director.getWinSize();return this.setPosition(winSize.width/2,winSize.height/2),this.setPosVar(cc.p(0,0)),this.setLife(12),this.setLifeVar(0),this.setStartSize(20),this.setStartSizeVar(0),this.setEndSize(cc.ParticleSystem.START_SIZE_EQUAL_TO_END_SIZE),this.setEmissionRate(this.getTotalParticles()/this.getLife()),this.setStartColor(cc.color(128,128,128,255)),this.setStartColorVar(cc.color(128,128,128,0)),this.setEndColor(cc.color(128,128,128,255)),this.setEndColorVar(cc.color(128,128,128,0)),this.setBlendAdditive(!1),!0}return!1}}),cc.ParticleSpiral.create=function(){return new cc.ParticleSpiral},cc.ParticleExplosion=cc.ParticleSystem.extend({ctor:function(){cc.ParticleSystem.prototype.ctor.call(this,cc._renderType===cc.game.RENDER_TYPE_WEBGL?700:300)},initWithTotalParticles:function(numberOfParticles){if(cc.ParticleSystem.prototype.initWithTotalParticles.call(this,numberOfParticles)){this.setDuration(.1),this.setEmitterMode(cc.ParticleSystem.MODE_GRAVITY),this.setGravity(cc.p(0,0)),this.setSpeed(70),this.setSpeedVar(40),this.setRadialAccel(0),this.setRadialAccelVar(0),this.setTangentialAccel(0),this.setTangentialAccelVar(0),this.setAngle(90),this.setAngleVar(360);var winSize=cc.director.getWinSize();return this.setPosition(winSize.width/2,winSize.height/2),this.setPosVar(cc.p(0,0)),this.setLife(5),this.setLifeVar(2),this.setStartSize(15),this.setStartSizeVar(10),this.setEndSize(cc.ParticleSystem.START_SIZE_EQUAL_TO_END_SIZE),this.setEmissionRate(this.getTotalParticles()/this.getDuration()),this.setStartColor(cc.color(179,26,51,255)),this.setStartColorVar(cc.color(128,128,128,0)),this.setEndColor(cc.color(128,128,128,0)),this.setEndColorVar(cc.color(128,128,128,0)),this.setBlendAdditive(!1),!0}return!1}}),cc.ParticleExplosion.create=function(){return new cc.ParticleExplosion},cc.ParticleSmoke=cc.ParticleSystem.extend({ctor:function(){cc.ParticleSystem.prototype.ctor.call(this,cc._renderType===cc.game.RENDER_TYPE_WEBGL?200:100)},initWithTotalParticles:function(numberOfParticles){if(cc.ParticleSystem.prototype.initWithTotalParticles.call(this,numberOfParticles)){this.setDuration(cc.ParticleSystem.DURATION_INFINITY),this.setEmitterMode(cc.ParticleSystem.MODE_GRAVITY),this.setGravity(cc.p(0,0)),this.setRadialAccel(0),this.setRadialAccelVar(0),this.setSpeed(25),this.setSpeedVar(10),this.setAngle(90),this.setAngleVar(5);var winSize=cc.director.getWinSize();return this.setPosition(winSize.width/2,0),this.setPosVar(cc.p(20,0)),this.setLife(4),this.setLifeVar(1),this.setStartSize(60),this.setStartSizeVar(10),this.setEndSize(cc.ParticleSystem.START_SIZE_EQUAL_TO_END_SIZE),this.setEmissionRate(this.getTotalParticles()/this.getLife()),this.setStartColor(cc.color(204,204,204,255)),this.setStartColorVar(cc.color(5,5,5,0)),this.setEndColor(cc.color(0,0,0,255)),this.setEndColorVar(cc.color(0,0,0,0)),this.setBlendAdditive(!1),!0}return!1}}),cc.ParticleSmoke.create=function(){return new cc.ParticleSmoke},cc.ParticleSnow=cc.ParticleSystem.extend({ctor:function(){cc.ParticleSystem.prototype.ctor.call(this,cc._renderType===cc.game.RENDER_TYPE_WEBGL?700:250)},initWithTotalParticles:function(numberOfParticles){if(cc.ParticleSystem.prototype.initWithTotalParticles.call(this,numberOfParticles)){this.setDuration(cc.ParticleSystem.DURATION_INFINITY),this.setEmitterMode(cc.ParticleSystem.MODE_GRAVITY),this.setGravity(cc.p(0,-1)),this.setSpeed(5),this.setSpeedVar(1),this.setRadialAccel(0),this.setRadialAccelVar(1),this.setTangentialAccel(0),this.setTangentialAccelVar(1);var winSize=cc.director.getWinSize();return this.setPosition(winSize.width/2,winSize.height+10),this.setPosVar(cc.p(winSize.width/2,0)),this.setAngle(-90),this.setAngleVar(5),this.setLife(45),this.setLifeVar(15),this.setStartSize(10),this.setStartSizeVar(5),this.setEndSize(cc.ParticleSystem.START_SIZE_EQUAL_TO_END_SIZE),this.setEmissionRate(10),this.setStartColor(cc.color(255,255,255,255)),this.setStartColorVar(cc.color(0,0,0,0)),this.setEndColor(cc.color(255,255,255,0)),this.setEndColorVar(cc.color(0,0,0,0)),this.setBlendAdditive(!1),!0}return!1}}),cc.ParticleSnow.create=function(){return new cc.ParticleSnow},cc.ParticleRain=cc.ParticleSystem.extend({ctor:function(){cc.ParticleSystem.prototype.ctor.call(this,cc._renderType===cc.game.RENDER_TYPE_WEBGL?1e3:300)},initWithTotalParticles:function(numberOfParticles){if(cc.ParticleSystem.prototype.initWithTotalParticles.call(this,numberOfParticles)){this.setDuration(cc.ParticleSystem.DURATION_INFINITY),this.setEmitterMode(cc.ParticleSystem.MODE_GRAVITY),this.setGravity(cc.p(10,-10)),this.setRadialAccel(0),this.setRadialAccelVar(1),this.setTangentialAccel(0),this.setTangentialAccelVar(1),this.setSpeed(130),this.setSpeedVar(30),this.setAngle(-90),this.setAngleVar(5);var winSize=cc.director.getWinSize();return this.setPosition(winSize.width/2,winSize.height),this.setPosVar(cc.p(winSize.width/2,0)),this.setLife(4.5),this.setLifeVar(0),this.setStartSize(4),this.setStartSizeVar(2),this.setEndSize(cc.ParticleSystem.START_SIZE_EQUAL_TO_END_SIZE),this.setEmissionRate(20),this.setStartColor(cc.color(179,204,255,255)),this.setStartColorVar(cc.color(0,0,0,0)),this.setEndColor(cc.color(179,204,255,128)),this.setEndColorVar(cc.color(0,0,0,0)),this.setBlendAdditive(!1),!0}return!1}}),cc.ParticleRain.create=function(){return new cc.ParticleRain},cc.PARTICLE_DEFAULT_CAPACITY=500,cc.ParticleBatchNode=cc.Node.extend({textureAtlas:null,_blendFunc:null,_className:"ParticleBatchNode",ctor:function(fileImage,capacity){cc.Node.prototype.ctor.call(this),this._blendFunc={src:cc.BLEND_SRC,dst:cc.BLEND_DST},cc.isString(fileImage)?this.init(fileImage,capacity):fileImage instanceof cc.Texture2D&&this.initWithTexture(fileImage,capacity)},_createRenderCmd:function(){return cc._renderType===cc.game.RENDER_TYPE_CANVAS?new cc.ParticleBatchNode.CanvasRenderCmd(this):new cc.ParticleBatchNode.WebGLRenderCmd(this)},initWithTexture:function(texture,capacity){return this.textureAtlas=new cc.TextureAtlas,this.textureAtlas.initWithTexture(texture,capacity),this._children.length=0,this._renderCmd._initWithTexture(),!0},initWithFile:function(fileImage,capacity){var tex=cc.textureCache.addImage(fileImage);return this.initWithTexture(tex,capacity)},init:function(fileImage,capacity){var tex=cc.textureCache.addImage(fileImage);return this.initWithTexture(tex,capacity)},visit:function(parent){if(this._visible){var cmd=this._renderCmd;cmd.visit(parent&&parent._renderCmd),cc.renderer.pushRenderCommand(cmd),cmd._dirtyFlag=0}},addChild:function(child,zOrder,tag){if(!child)throw new Error("cc.ParticleBatchNode.addChild() : child should be non-null");if(!(child instanceof cc.ParticleSystem))throw new Error("cc.ParticleBatchNode.addChild() : only supports cc.ParticleSystem as children");if(zOrder=null==zOrder?child.zIndex:zOrder,tag=null==tag?child.tag:tag,child.getTexture()!==this.textureAtlas.texture)throw new Error("cc.ParticleSystem.addChild() : the child is not using the same texture id");var childBlendFunc=child.getBlendFunc();if(0===this._children.length)this.setBlendFunc(childBlendFunc);else if(childBlendFunc.src!==this._blendFunc.src||childBlendFunc.dst!==this._blendFunc.dst)return void cc.log("cc.ParticleSystem.addChild() : Can't add a ParticleSystem that uses a different blending function");var pos=this._addChildHelper(child,zOrder,tag),atlasIndex=0;if(0!==pos){var p=this._children[pos-1];atlasIndex=p.getAtlasIndex()+p.getTotalParticles()}else atlasIndex=0;this.insertChild(child,atlasIndex),child.setBatchNode(this)},insertChild:function(pSystem,index){var totalParticles=pSystem.getTotalParticles(),locTextureAtlas=this.textureAtlas,totalQuads=locTextureAtlas.totalQuads;pSystem.setAtlasIndex(index),totalQuads+totalParticles>locTextureAtlas.getCapacity()&&(this._increaseAtlasCapacityTo(totalQuads+totalParticles),locTextureAtlas.fillWithEmptyQuadsFromIndex(locTextureAtlas.getCapacity()-totalParticles,totalParticles)),pSystem.getAtlasIndex()+totalParticles!==totalQuads&&locTextureAtlas.moveQuadsFromIndex(index,index+totalParticles),locTextureAtlas.increaseTotalQuadsWith(totalParticles),this._updateAllAtlasIndexes()},removeChild:function(child,cleanup){if(null!=child){if(!(child instanceof cc.ParticleSystem))throw new Error("cc.ParticleBatchNode.removeChild(): only supports cc.ParticleSystem as children");if(-1!==this._children.indexOf(child)){cc.Node.prototype.removeChild.call(this,child,cleanup);var locTextureAtlas=this.textureAtlas;locTextureAtlas.removeQuadsAtIndex(child.getAtlasIndex(),child.getTotalParticles()),locTextureAtlas.fillWithEmptyQuadsFromIndex(locTextureAtlas.totalQuads,child.getTotalParticles()),child.setBatchNode(null),this._updateAllAtlasIndexes()}else cc.log("cc.ParticleBatchNode.removeChild(): doesn't contain the sprite. Can't remove it")}},reorderChild:function(child,zOrder){if(!child)throw new Error("cc.ParticleBatchNode.reorderChild(): child should be non-null");if(!(child instanceof cc.ParticleSystem))throw new Error("cc.ParticleBatchNode.reorderChild(): only supports cc.QuadParticleSystems as children");if(-1!==this._children.indexOf(child)){if(zOrder!==child.zIndex){if(1<this._children.length){var getIndexes=this._getCurrentIndex(child,zOrder);if(getIndexes.oldIndex!==getIndexes.newIndex){this._children.splice(getIndexes.oldIndex,1),this._children.splice(getIndexes.newIndex,0,child);var oldAtlasIndex=child.getAtlasIndex();this._updateAllAtlasIndexes();for(var newAtlasIndex=0,locChildren=this._children,i=0;i<locChildren.length;i++){if(locChildren[i]===child){newAtlasIndex=child.getAtlasIndex();break}}this.textureAtlas.moveQuadsFromIndex(oldAtlasIndex,child.getTotalParticles(),newAtlasIndex),child.updateWithNoTime()}}child._setLocalZOrder(zOrder)}}else cc.log("cc.ParticleBatchNode.reorderChild(): Child doesn't belong to batch")},removeChildAtIndex:function(index,doCleanup){this.removeChild(this._children[i],doCleanup)},removeAllChildren:function(doCleanup){for(var locChildren=this._children,i=0;i<locChildren.length;i++)locChildren[i].setBatchNode(null);cc.Node.prototype.removeAllChildren.call(this,doCleanup),this.textureAtlas.removeAllQuads()},disableParticle:function(particleIndex){var quad=this.textureAtlas.quads[particleIndex];quad.br.vertices.x=quad.br.vertices.y=quad.tr.vertices.x=quad.tr.vertices.y=quad.tl.vertices.x=quad.tl.vertices.y=quad.bl.vertices.x=quad.bl.vertices.y=0,this.textureAtlas._setDirty(!0)},getTexture:function(){return this.textureAtlas.texture},setTexture:function(texture){this.textureAtlas.texture=texture;var locBlendFunc=this._blendFunc;texture&&!texture.hasPremultipliedAlpha()&&locBlendFunc.src===cc.BLEND_SRC&&locBlendFunc.dst===cc.BLEND_DST&&(locBlendFunc.src=cc.SRC_ALPHA,locBlendFunc.dst=cc.ONE_MINUS_SRC_ALPHA)},setBlendFunc:function(src,dst){void 0===dst?(this._blendFunc.src=src.src,this._blendFunc.dst=src.dst):(this._blendFunc.src=src,this._blendFunc.src=dst)},getBlendFunc:function(){return new cc.BlendFunc(this._blendFunc.src,this._blendFunc.dst)},_updateAllAtlasIndexes:function(){for(var index=0,locChildren=this._children,i=0;i<locChildren.length;i++){var child=locChildren[i];child.setAtlasIndex(index),index+=child.getTotalParticles()}},_increaseAtlasCapacityTo:function(quantity){cc.log("cocos2d: cc.ParticleBatchNode: resizing TextureAtlas capacity from ["+this.textureAtlas.getCapacity()+"] to ["+quantity+"]."),this.textureAtlas.resizeCapacity(quantity)||cc.log("cc.ParticleBatchNode._increaseAtlasCapacityTo() : WARNING: Not enough memory to resize the atlas")},_searchNewPositionInChildrenForZ:function(z){for(var locChildren=this._children,count=locChildren.length,i=0;i<count;i++)if(locChildren[i].zIndex>z)return i;return count},_getCurrentIndex:function(child,z){for(var foundCurrentIdx=!1,foundNewIdx=!1,newIndex=0,oldIndex=0,minusOne=0,locChildren=this._children,count=locChildren.length,i=0;i<count;i++){var pNode=locChildren[i];if(pNode.zIndex>z&&!foundNewIdx&&(newIndex=i,foundNewIdx=!0,foundCurrentIdx&&foundNewIdx))break;if(child===pNode&&(oldIndex=i,foundNewIdx||(minusOne=-1),(foundCurrentIdx=!0)&&foundNewIdx))break}return foundNewIdx||(newIndex=count),{newIndex:newIndex+=minusOne,oldIndex:oldIndex}},_addChildHelper:function(child,z,aTag){if(!child)throw new Error("cc.ParticleBatchNode._addChildHelper(): child should be non-null");if(child.parent)return cc.log("cc.ParticleBatchNode._addChildHelper(): child already added. It can't be added again"),null;this._children||(this._children=[]);var pos=this._searchNewPositionInChildrenForZ(z);return this._children.splice(pos,0,child),child.tag=aTag,child._setLocalZOrder(z),(child.parent=this)._running&&(child._performRecursive(cc.Node._stateCallbackType.onEnter),child._performRecursive(cc.Node._stateCallbackType.onEnterTransitionDidFinish)),pos},_updateBlendFunc:function(){this.textureAtlas.texture.hasPremultipliedAlpha()||(this._blendFunc.src=cc.SRC_ALPHA,this._blendFunc.dst=cc.ONE_MINUS_SRC_ALPHA)},getTextureAtlas:function(){return this.textureAtlas},setTextureAtlas:function(textureAtlas){this.textureAtlas=textureAtlas}}),(_p=cc.ParticleBatchNode.prototype).texture,cc.defineGetterSetter(_p,"texture",_p.getTexture,_p.setTexture),cc.ParticleBatchNode.create=function(fileImage,capacity){return new cc.ParticleBatchNode(fileImage,capacity)},function(){cc.ParticleBatchNode.CanvasRenderCmd=function(renderable){this._rootCtor(renderable),this._needDraw=!1};var proto=cc.ParticleBatchNode.CanvasRenderCmd.prototype=Object.create(cc.Node.CanvasRenderCmd.prototype);proto.constructor=cc.ParticleBatchNode.CanvasRenderCmd,proto._initWithTexture=function(){}}(),function(){cc.ParticleBatchNode.WebGLRenderCmd=function(renderable){this._rootCtor(renderable),this._needDraw=!0,this._matrix=new cc.math.Matrix4,this._matrix.identity()};var proto=cc.ParticleBatchNode.WebGLRenderCmd.prototype=Object.create(cc.Node.WebGLRenderCmd.prototype);proto.constructor=cc.ParticleBatchNode.WebGLRenderCmd,proto.rendering=function(ctx){var _t=this._node;if(0!==_t.textureAtlas.totalQuads){var wt=this._worldTransform;this._matrix.mat[0]=wt.a,this._matrix.mat[4]=wt.c,this._matrix.mat[12]=wt.tx,this._matrix.mat[1]=wt.b,this._matrix.mat[5]=wt.d,this._matrix.mat[13]=wt.ty,this._shaderProgram.use(),this._shaderProgram._setUniformForMVPMatrixWithMat4(this._matrix),cc.glBlendFuncForParticle(_t._blendFunc.src,_t._blendFunc.dst),_t.textureAtlas.drawQuads()}},proto._initWithTexture=function(){this._shaderProgram=cc.shaderCache.programForKey(cc.SHADER_POSITION_TEXTURECOLOR)}}();