var BattleTeamMng=cc.Layer.extend({_loadTeamMemberComplete:null,_loadGeneralLoadComplete:null,_generalEventListenerForFieldMng:null,_generalAddBattleFxNode:null,m_game_type:null,m_friend_effect:null,m_team_type:BattleGeneral_TeamType.Left,m_gnrl_parent:null,m_weekly_dungeon:null,m_once_a_day_dungeon:null,m_world_war_npc_dungeon:null,m_mussang_boss_dungeon:null,m_story_hard_mode_mission:null,m_new_raid_boss_dungeon:null,m_troops_number:0,m_position_list:null,m_cutin_position_list:null,m_friend_general:null,m_load_ready_generals:[],m_load_ready_generals_service:null,m_is_load_complete:!1,m_is_initial_special_leader_skill:!1,m_team_members:null,m_mussang:null,m_target_team:null,m_battle_formations:null,m_event_dungeon:null,m_daily_dungeon:null,temp_num:1,m_stage_npc:null,m_stage_npc_vector:null,m_main_mission:null,m_is_inserted_friend:!1,m_battle_state:BattleState.GameReady,m_is_enable_friend_special_leader_skill:!1,m_friend_special_leader_skill:null,m_event_dungeon_cutin_accum_damage:0,m_event_dungeon_cutin_boss_max_life:0,m_event_dungeon_mussang_boss_accum_damage:0,m_Reader_Gnrl_Group_id:0,battleObserver:null,m_great_wall_dungeon:null,m_map_general_damage_log:null,m_map_general_debug_log:null,m_mussang_tower_dungeon:null,winSize:null,m_castle_special_func_list:null,is_basic_idle:!1,m_evnet_dungeon_raid_boss_max_life:0,m_event_dungeon_raid_accum_damage:0,m_new_raid_boss_damage_data:null,ctor:function(aa){return this._super(),this.temp_num=aa,this.winSize=cc.director.getWinSize(),this.battleObserver=MainObserver.getInstance(),this.m_map_general_damage_log=new Map,this.m_map_general_debug_log=new Map,this.m_new_raid_boss_damage_data=new Map,this.m_Reader_Gnrl_Group_id=0,this.m_special_leader_skill=[],this.m_world_war_npc_dungeon=new database.BattleWorldWarNpcDungeon,this.m_friend_effect={friend_num:240,content:"",attk:240,def:175,hp:162,cri_percent:245,cri_damage:41,skill_cooltime:241,skil_damage:162,group_num:226},this.init(),!0},onEnter:function(){this._super()},onExit:function(){if(!BATTLE_TO_SHOP&&(this._super(),1==BATTLE_SCENE_MEMORY_CLEAR)){cc.log("BattleTeamMng onExit Clear"),this.removeAllChildrenWithCleanup(!0),this.m_gnrl_parent.removeAllChildrenWithCleanup(!0);var stage_map=this.m_stage_npc.map;stage_map.forEach(function(npc_list){npc_list.forEach(function(battleGeneral){battleGeneral.onExit()})}),stage_map=null,this._loadTeamMemberComplete=null,this._loadGeneralLoadComplete=null,this._generalEventListenerForFieldMng=null,this._generalAddBattleFxNode=null,this.m_game_type=null,this.m_friend_effect=null,this.m_gnrl_parent=null,this.m_weekly_dungeon=null,this.m_once_a_day_dungeon=null,this.m_world_war_npc_dungeon=null,this.m_mussang_boss_dungeon=null,this.m_story_hard_mode_mission=null,this.m_new_raid_boss_dungeon=null,this.m_position_list=null,this.m_cutin_position_list=null,this.m_friend_general=null,this.m_load_ready_generals=null,this.m_load_ready_generals_service=null,this.m_team_members=null,this.m_mussang=null,this.m_target_team=null,this.m_battle_formations=null,this.m_event_dungeon=null,this.m_daily_dungeon=null,this.m_stage_npc=null,this.m_stage_npc_vector=null,this.m_main_mission=null,this.m_special_leader_skill=null,this.m_friend_special_leader_skill=null,this.battleObserver=null,this.m_great_wall_dungeon=null,this.m_map_general_damage_log=null,this.m_map_general_debug_log=null,this.m_mussang_tower_dungeon=null,this.winSize=null,delete this._loadTeamMemberComplete,delete this._loadGeneralLoadComplete,delete this._generalEventListenerForFieldMng,delete this._generalAddBattleFxNode,delete this.m_game_type,delete this.m_friend_effect,delete this.m_gnrl_parent,delete this.m_weekly_dungeon,delete this.m_world_war_npc_dungeon,delete this.m_mussang_boss_dungeon,delete this.m_story_hard_mode_mission,delete this.m_new_raid_boss_dungeon,delete this.m_once_a_day_dungeon,delete this.m_position_list,delete this.m_cutin_position_list,delete this.m_friend_general,delete this.m_load_ready_generals,delete this.m_load_ready_generals_service,delete this.m_team_members,delete this.m_mussang,delete this.m_target_team,delete this.m_battle_formations,delete this.m_event_dungeon,delete this.m_daily_dungeon,delete this.m_stage_npc,delete this.m_stage_npc_vector,delete this.m_main_mission,delete this.m_special_leader_skill,delete this.m_friend_special_leader_skill,delete this.battleObserver,delete this.m_great_wall_dungeon,delete this.m_map_general_damage_log,delete this.m_map_general_debug_log,delete this.m_mussang_tower_dungeon,delete this.winSize,delete this.m_team_type,delete this.m_troops_number,delete this.m_is_load_complete,delete this.m_is_initial_special_leader_skill,delete this.temp_num,delete this.m_is_inserted_friend,delete this.m_battle_state,delete this.m_is_enable_friend_special_leader_skill,delete this.m_event_dungeon_cutin_accum_damage,delete this.m_event_dungeon_cutin_boss_max_life,delete this.m_event_dungeon_mussang_boss_accum_damage}},init:function(){this.m_friend_effect.friend_num=0;var context=BattleContext._getInstance();return this.m_game_type=context.getGameType(),this.m_position_list=new Array,this.m_cutin_position_list=new Array,this.m_load_ready_generals_service=new Array,this.m_load_ready_generals=[],this.m_team_members=[],this.m_battle_formations=new Map,this.m_stage_npc=new Map_Vector,this.m_main_mission=new database.BattleMainMission2,this.m_story_hard_mode_mission=$.extend({},database.BattleStoryHardModeMission),this.m_new_raid_boss_dungeon=$.extend({},database.BattleNewRaidBossDungeon),this.m_mussang=$.extend({},database.BattleMussang),!0},generateTroopsGenerals:function(){for(var i=0;i<this.m_load_ready_generals_service.size();i++){var general=this.m_load_ready_generals_service.at(i).general;this.m_load_ready_generals[i]=new database.BattleGeneral2,this.m_load_ready_generals[i].gnrl_id=this.m_load_ready_generals_service.at(i).gnrl_id,this.m_load_ready_generals[i].gnrl_num=this.m_load_ready_generals_service.at(i).gnrl_num,this.m_load_ready_generals[i].exp=this.m_load_ready_generals_service.at(i).exp,this.m_load_ready_generals[i].gnrl_level=this.m_load_ready_generals_service.at(i).gnrl_level,this.m_load_ready_generals[i].level_id=this.m_load_ready_generals_service.at(i).level_id,this.m_load_ready_generals[i].position=this.m_load_ready_generals_service.at(i).position,this.m_load_ready_generals[i].normal_hit_count=this.m_load_ready_generals_service.at(i).normal_hit_count,this.m_load_ready_generals[i].display_class=this.m_load_ready_generals_service.at(i).display_class,this.m_load_ready_generals[i].npc_id=this.m_load_ready_generals_service.at(i).npc_id,this.m_load_ready_generals[i].battle_stage=this.m_load_ready_generals_service.at(i).battle_stage,this.m_load_ready_generals[i].is_zoom=this.m_load_ready_generals_service.at(i).is_zoom,this.m_load_ready_generals[i].is_new_entry=this.m_load_ready_generals_service.at(i).is_new_entry,this.m_load_ready_generals[i].cri_percent=this.m_load_ready_generals_service.at(i).cri_percent,this.m_load_ready_generals[i].cri_attk_damage=this.m_load_ready_generals_service.at(i).cri_attk_damage,this.m_load_ready_generals[i].cri_resist=this.m_load_ready_generals_service.at(i).cri_resist,this.m_load_ready_generals[i].skill_attk_damage_inc=this.m_load_ready_generals_service.at(i).skill_attk_damage_inc,this.m_load_ready_generals[i].skill_def_damage_dec=this.m_load_ready_generals_service.at(i).skill_def_damage_dec,this.m_load_ready_generals[i].adv_attk_damage_inc=this.m_load_ready_generals_service.at(i).adv_attk_damage_inc,this.m_load_ready_generals[i].adv_def_damage_dec=this.m_load_ready_generals_service.at(i).adv_def_damage_dec,this.m_load_ready_generals[i].set_equipment_effect=this.m_load_ready_generals_service.at(i).set_equipment_effect,this.m_load_ready_generals[i].resistance=this.m_load_ready_generals_service.at(i).resistance,this.m_load_ready_generals[i].special_ability=this.m_load_ready_generals_service.at(i).special_ability,this.m_load_ready_generals[i].love_level=this.m_load_ready_generals_service.at(i).love_level,this.m_load_ready_generals[i].love_exp=this.m_load_ready_generals_service.at(i).love_exp,this.m_load_ready_generals[i].castle_id=this.m_load_ready_generals_service.at(i).castle_id,this.m_load_ready_generals[i].velocity=this.m_load_ready_generals_service.at(i).velocity,this.m_load_ready_generals[i].limit_step_id=this.m_load_ready_generals_service.at(i).limit_step_id,this.m_load_ready_generals[i].accum_damage=this.m_load_ready_generals_service.at(i).accum_damage,this.m_load_ready_generals[i].remain_skill_count=this.m_load_ready_generals_service.at(i).remain_skill_count,this.m_load_ready_generals[i].remain_hp_rate=this.m_load_ready_generals_service.at(i).remain_hp_rate,this.m_load_ready_generals[i].attack_action.action_id=this.m_load_ready_generals_service.at(i).attack_action.action_id,this.m_load_ready_generals[i].attack_action.range_style=this.m_load_ready_generals_service.at(i).attack_action.range_style,this.m_load_ready_generals[i].attack_action.our_enemy=this.m_load_ready_generals_service.at(i).attack_action.our_enemy,this.m_load_ready_generals[i].attack_action.self_other=this.m_load_ready_generals_service.at(i).attack_action.self_other,this.m_load_ready_generals[i].attack_action.target_count=this.m_load_ready_generals_service.at(i).attack_action.target_count,this.m_load_ready_generals[i].attack_action.hit_count=this.m_load_ready_generals_service.at(i).attack_action.hit_count,this.m_load_ready_generals[i].attack_action.priority_position=this.m_load_ready_generals_service.at(i).attack_action.priority_position,this.m_load_ready_generals[i].attack_action.damages=this.m_load_ready_generals_service.at(i).attack_action.damages,this.m_load_ready_generals[i].attack_action.hit_sound=this.m_load_ready_generals_service.at(i).attack_action.hit_sound,this.m_load_ready_generals[i].attack_action.action_sound=this.m_load_ready_generals_service.at(i).attack_action.action_sound,this.m_load_ready_generals[i].attack_action.enemy_action_sound=this.m_load_ready_generals_service.at(i).attack_action.enemy_action_sound,this.m_load_ready_generals[i].attack2_action.action_id=this.m_load_ready_generals_service.at(i).attack2_action.action_id,this.m_load_ready_generals[i].attack2_action.range_style=this.m_load_ready_generals_service.at(i).attack2_action.range_style,this.m_load_ready_generals[i].attack2_action.our_enemy=this.m_load_ready_generals_service.at(i).attack2_action.our_enemy,this.m_load_ready_generals[i].attack2_action.self_other=this.m_load_ready_generals_service.at(i).attack2_action.self_other,this.m_load_ready_generals[i].attack2_action.target_count=this.m_load_ready_generals_service.at(i).attack2_action.target_count,this.m_load_ready_generals[i].attack2_action.hit_count=this.m_load_ready_generals_service.at(i).attack2_action.hit_count,this.m_load_ready_generals[i].attack2_action.priority_position=this.m_load_ready_generals_service.at(i).attack2_action.priority_position,this.m_load_ready_generals[i].attack2_action.damages=this.m_load_ready_generals_service.at(i).attack2_action.damages,this.m_load_ready_generals[i].attack2_action.hit_sound=this.m_load_ready_generals_service.at(i).attack2_action.hit_sound,this.m_load_ready_generals[i].attack2_action.action_sound=this.m_load_ready_generals_service.at(i).attack2_action.action_sound,this.m_load_ready_generals[i].attack2_action.enemy_action_sound=this.m_load_ready_generals_service.at(i).attack2_action.enemy_action_sound,this.m_load_ready_generals[i].attack3_action.action_id=this.m_load_ready_generals_service.at(i).attack3_action.action_id,this.m_load_ready_generals[i].attack3_action.range_style=this.m_load_ready_generals_service.at(i).attack3_action.range_style,this.m_load_ready_generals[i].attack3_action.our_enemy=this.m_load_ready_generals_service.at(i).attack3_action.our_enemy,this.m_load_ready_generals[i].attack3_action.self_other=this.m_load_ready_generals_service.at(i).attack3_action.self_other,this.m_load_ready_generals[i].attack3_action.target_count=this.m_load_ready_generals_service.at(i).attack3_action.target_count,this.m_load_ready_generals[i].attack3_action.hit_count=this.m_load_ready_generals_service.at(i).attack3_action.hit_count,this.m_load_ready_generals[i].attack3_action.priority_position=this.m_load_ready_generals_service.at(i).attack3_action.priority_position,this.m_load_ready_generals[i].attack3_action.damages=this.m_load_ready_generals_service.at(i).attack3_action.damages,this.m_load_ready_generals[i].attack3_action.hit_sound=this.m_load_ready_generals_service.at(i).attack3_action.hit_sound,this.m_load_ready_generals[i].attack3_action.action_sound=this.m_load_ready_generals_service.at(i).attack3_action.action_sound,this.m_load_ready_generals[i].attack3_action.enemy_action_sound=this.m_load_ready_generals_service.at(i).attack3_action.enemy_action_sound,this.m_load_ready_generals[i].active_skill=this.m_load_ready_generals_service.at(i).active_skill,this.m_load_ready_generals[i].active_sub_skill=this.m_load_ready_generals_service.at(i).active_sub_skill,this.m_load_ready_generals[i].trans_passive_skill=this.m_load_ready_generals_service.at(i).trans_passive_skill,this.m_load_ready_generals[i].passive_skill=this.m_load_ready_generals_service.at(i).passive_skill,this.m_load_ready_generals[i].fx_parts=this.m_load_ready_generals_service.at(i).fx_parts,this.m_load_ready_generals[i].evt_dungeon_buff=this.m_load_ready_generals_service.at(i).evt_dungeon_buff,this.m_load_ready_generals[i].equipments=this.m_load_ready_generals_service.at(i).equipments,this.m_load_ready_generals[i].general=general,this.m_load_ready_generals[i].general.gnrl_id=general.gnrl_id,this.m_load_ready_generals[i].general.name=general.name,this.m_load_ready_generals[i].general.gnrl_type=general.gnrl_type,this.m_load_ready_generals[i].general.state_type=general.state_type,this.m_load_ready_generals[i].general.gnrl_class=general.gnrl_class,this.m_load_ready_generals[i].general.gnrl_group=general.gnrl_group,this.m_load_ready_generals[i].general.max_level=general.max_level,this.m_load_ready_generals[i].general.arm_service_type=general.arm_service_type,this.m_load_ready_generals[i].general.fight_type=general.fight_type,this.m_load_ready_generals[i].general.cost=general.cost,this.m_load_ready_generals[i].general.attk=general.attk,this.m_load_ready_generals[i].general.def=general.def,this.m_load_ready_generals[i].general.hp=general.hp,this.m_load_ready_generals[i].general.sp=general.sp,this.m_load_ready_generals[i].general.cri_percent=general.cri_percent,this.m_load_ready_generals[i].general.cri_ratio=general.cri_ratio,this.m_load_ready_generals[i].general.action_id1=general.action_id1,this.m_load_ready_generals[i].general.action_id2=general.action_id2,this.m_load_ready_generals[i].general.active_skill_id=general.active_skill_id,this.m_load_ready_generals[i].general.master_type=general.master_type,this.m_load_ready_generals[i].general.friend_num=general.friend_num,this.m_load_ready_generals[i].general.skin_id=general.skin_id,this.m_load_ready_generals[i].general.bone_id=general.bone_id,this.m_load_ready_generals[i].general.evolution_max_class_type=general.evolution_max_class_type,this.m_load_ready_generals[i].general.evolution_group_num=general.evolution_group_num,this.m_load_ready_generals[i].general.combo_group_num=general.combo_group_num,this.m_load_ready_generals[i].general.love_stat_group=general.love_stat_group,this.m_load_ready_generals[i].general.evolution_mtrl_num=general.evolution_mtrl_num,this.m_load_ready_generals[i].general.rare_type=general.rare_type,this.m_load_ready_generals[i].general.sell_gold=general.sell_gold,this.m_load_ready_generals[i].general.sell_yhpt=general.sell_yhpt,this.m_load_ready_generals[i].general.love_cg_num=general.love_cg_num,this.m_load_ready_generals[i].general.level_exp_group=general.level_exp_group,this.m_load_ready_generals[i].general.breakthrough=general.breakthrough,this.m_load_ready_generals[i].general.passive_skill_id=general.passive_skill_id,this.m_load_ready_generals[i].general.leader_skill_id=general.leader_skill_id,this.m_load_ready_generals[i].general.guard_rate=general.guard_rate,this.m_load_ready_generals[i].general.guard_value=general.guard_value,this.m_load_ready_generals[i].general.trans_passive_skill_id=general.trans_passive_skill_id,this.m_load_ready_generals[i].general.element_type=general.element_type,this.m_load_ready_generals[i].general.special_leader_skill_id=general.special_leader_skill_id,this.m_load_ready_generals[i].general.active_sub_skill_id=general.active_sub_skill_id,this.m_load_ready_generals[i].new_equipments=this.m_load_ready_generals_service.at(i).new_equipments,this.m_load_ready_generals[i].new_equipment_set=this.m_load_ready_generals_service.at(i).new_equipment_set}},initWithWeeklyTroopsGenerals:function(team_type,weekly,troops_num,parent){this.m_team_type=team_type,this.m_gnrl_parent=parent,this.m_weekly_dungeon=weekly,this.m_troops_number=troops_num,this.m_battle_formations.clear(),this.m_battle_formations=GeneralService.getInstance().getUserBattleFormationList();var service=BattleService.getInstance();this.m_load_ready_generals.length=0,service.getTroopsGenerals(this.m_troops_number,this.m_load_ready_generals_service),this.m_load_ready_generals_service.sort(function(a,b){return b.position-a.position}),this.generateTroopsGenerals();var m=MasterTable.getInstance();if(this.m_game_type==db.BattleGameType.WeeklyDungeon)for(var i=0;i<this.m_load_ready_generals_service.size();i++)this.m_load_ready_generals_service[i].evt_dungeon_buff=m.get_EventDungeonGeneralBufList(EVENT_DUNGEON_TYPE_WEEKLY,this.m_weekly_dungeon.weekly_difficulty.weekly_idx,this.m_load_ready_generals_service[i].general.gnrl_group);if(this.m_team_type==BattleGeneral_TeamType.Left){var position_list=[370,234];this.m_position_list.push_back(position_list),position_list=[300,318],this.m_position_list.push_back(position_list),position_list=[240,150],this.m_position_list.push_back(position_list),position_list=[170,276],this.m_position_list.push_back(position_list),position_list=[100,192],this.m_position_list.push_back(position_list)}else{position_list=[this.winSize.width-370,234];this.m_position_list.push_back(position_list),position_list=[this.winSize.width-300,318],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-240,150],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-170,276],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-100,192],this.m_position_list.push_back(position_list)}this.schedule(this.resourceLoading,UPDATE_SCHEDULE_INTERVAL)},initWithWorldWarTroopsGenerals:function(team_type,troops,parent){this.m_team_type=team_type,this.m_gnrl_parent=parent,this.m_battle_formations.clear(),this.m_battle_formations=GeneralService.getInstance().getUserBattleFormationList(),this.m_castle_special_func_list={},this.m_castle_special_func_list=NetServiceV3.getInstance().getCastleSpecialFuncList(eCastleSpecialTalent.est_increase_stat),this.m_castle_special_func_list=NetServiceV3.getInstance().getCastleSpecialFuncList(eCastleSpecialTalent.est_increase_enemy_damage);var service=WorldWarService.getInstance();this.m_load_ready_generals.clear(),service.getWorldWarTroopsGenerals(troops,this.m_load_ready_generals_service,!1),BattleContext._getInstance().setBeforeWorldWarNpcDungeonUserInfoByTroops(this.m_load_ready_generals_service),this.m_load_ready_generals_service.sort(function(l,r){return l.position-r.position}),this.generateTroopsGenerals();var position_list=[370,234];this.m_position_list.push_back(position_list),position_list=[300,318],this.m_position_list.push_back(position_list),position_list=[240,150],this.m_position_list.push_back(position_list),position_list=[170,276],this.m_position_list.push_back(position_list),position_list=[100,192],this.m_position_list.push_back(position_list),this.schedule(this.resourceLoading,UPDATE_SCHEDULE_INTERVAL)},initWithGreatWallTroopsGenerals:function(team_type,troops_num,parent){this.m_team_type=team_type,this.m_gnrl_parent=parent,this.m_troops_number=troops_num,this.m_battle_formations.clear(),this.m_battle_formations=GeneralService.getInstance().getUserBattleFormationList();var gw_service=GreatWallService.getInstance();this.m_load_ready_generals.clear(),gw_service.getGreatWallTroopsGenerals(this.m_troops_number,this.m_load_ready_generals_service),this.m_load_ready_generals_service.sort(function(a,b){return b.position-a.position}),this.generateTroopsGenerals();for(var m=MasterTable.getInstance(),context=BattleContext._getInstance(),idx=0;idx<this.m_load_ready_generals.length;idx++)this.m_game_type==db.BattleGameType.GreatWallDungeon&&(this.m_great_wall_dungeon=context.getGreatWallDungeonData(),this.m_load_ready_generals[idx].evt_dungeon_buff=m.get_EventDungeonGeneralBufList(EVENT_DUNGEON_TYPE_GREAT_WALL_DUNGEON,this.m_great_wall_dungeon.great_wall_dungeon.great_wall_dungeon_idx,this.m_load_ready_generals[idx].general.gnrl_group));var position_list=[370,234];this.m_position_list.push_back(position_list),position_list=[300,318],this.m_position_list.push_back(position_list),position_list=[240,150],this.m_position_list.push_back(position_list),position_list=[170,276],this.m_position_list.push_back(position_list),position_list=[100,192],this.m_position_list.push_back(position_list),this.schedule(this.resourceLoading,UPDATE_SCHEDULE_INTERVAL)},resourceLoading:function(dt){var m=MasterManager.getInstance();if(0!=this.m_load_ready_generals.length){var position_index=(gnrl=this.m_load_ready_generals.pop()).position,hero=null;(hero=1001==gnrl.general.gnrl_group?new BattleGeneral(1):1002==gnrl.general.gnrl_group?new BattleGeneral(2):1003==gnrl.general.gnrl_group?new BattleGeneral(3):new BattleGeneral(0)).lazyInitialize(gnrl,this.m_team_type);var pos=this.m_position_list.at(position_index-1),pos_x=pos[0],pos_y=pos[1];if(this.m_team_type==BattleGeneral_TeamType.Left)hero.setGeneralPosition(cc.p(pos_x,pos_y));else{var position=ZERO(),position_x=position[0],position_y=position[1];if(this.m_game_type==db.BattleGameType.EventDungeon)position_y=(position_x=this.m_event_dungeon.cutin_stage==gnrl.battle_stage?(position=this.m_cutin_position_list.at(position_index-1))[0]:(position=this.m_position_list.at(position_index-1))[0],position[1]);else if(this.m_game_type==db.BattleGameType.NewRaidBossDungeon){var arrange_info=MasterManager.getInstance().get_NewRaidBossNpcArrangeInfo(this.m_new_raid_boss_dungeon.dungeon_data.new_raid_boss_npc_arrange_info_idx),npc_found=this.m_new_raid_boss_dungeon.dungeon.boss_data_list.findIndex(function(b){return b.boss_idx==gnrl.npc_id});switch(-1!=npc_found&&hero.setNewRaidBossStateData(this.m_new_raid_boss_dungeon.dungeon.boss_data_list[npc_found]),gnrl.position){case db.BattlePosition.Head:position_x=arrange_info.head_x,position_y=arrange_info.head_y;break;case db.BattlePosition.Body_1:position_x=arrange_info.body_top_x,position_y=arrange_info.body_top_y;break;case db.BattlePosition.Body_2:position_x=arrange_info.body_bottom_x,position_y=arrange_info.body_bottom_y;break;case db.BattlePosition.Tail_1:position_x=arrange_info.tail_top_x,position_y=arrange_info.tail_top_y;break;case db.BattlePosition.Tail_2:position_x=arrange_info.tail_bottom_x,position_y=arrange_info.tail_bottom_y;break;default:position_x=arrange_info.head_x,position_y=arrange_info.head_y}}else position_x=(position=this.m_position_list.at(position_index-1))[0],position_y=position[1];hero.setGeneralPosition(cc.p(position_x,position_y))}hero._findEnemyTarget=this,hero._cbEventListenerFieldMng=this._generalEventListenerForFieldMng,hero._addBattleFxNode=this._generalAddBattleFxNode,hero._req_team_cooltime=this,hero.setMyTeamManager(this),this.m_game_type==db.BattleGameType.DailyDungeon&&this.m_team_type==BattleGeneral_TeamType.Right&&hero.setSandbag(!0),this.m_stage_npc.insert(gnrl.battle_stage,hero),null!=this._loadGeneralLoadComplete&&this._loadGeneralLoadComplete.cbLoadGeneralComplete(hero),hero=null}else{if(this.IsLoadMemberComplete())return this.m_is_initial_special_leader_skill||(this.initCheckSpecialLeaderSkillBuf(),this.m_is_initial_special_leader_skill=!0),void this.calcGeneralsStat();var context=BattleContext._getInstance();if(this.m_game_type==db.BattleGameType.Mission||this.m_game_type==db.BattleGameType.EventDungeon||this.m_game_type==db.BattleGameType.StoryHardMode){if(this.m_team_type==BattleGeneral_TeamType.Left&&""!=context.getFriendID()){this.m_friend_general=new BattleGeneral(0);var gnrl=$.extend({},context.getFriendPartnerGeneral());null==context.getBattleHelperInfo()&&context.setBattleHelperInfo({user_id:context.getFriendID(),nickname:"",last_login_dt:"7/12/2017 1:08:33 PM",partner_gnrl_id:gnrl.gnrl_id,partner_gnrl_num:0,partner_gnrl_lv:gnrl.gnrl_level,partner_gnrl_class:3,use_enable_yn:"y",refresh_time:"",helper_type:2,partner_gnrl_love_lv:0,partner_gnrl_limit_step_id:1}),this.m_friend_effect=m.get_FriendEffect(gnrl.general.friend_num),this.m_game_type==db.BattleGameType.Mission?BattleMissionTaskManager._getInstance().setFriendBuf():this.m_game_type==db.BattleGameType.StoryHardMode?BattleStoryHardModeMissionTaskManager._getInstance().setFriendBuf():this.m_game_type==db.BattleGameType.EventDungeon&&(BattleEventDungeonTaskManager.getInstance().setFriendBuff(),USE_FRIEND_SPEICAL_EFFECT&&(gnrl.evt_dungeon_buff=MasterTable.getInstance().get_EventDungeonGeneralBufList(EVENT_DUNGEON_TYPE_EVENT_DUNGEON,this.m_event_dungeon.event_dungeon.event_dungeon_idx,gnrl.general.gnrl_group))),this.m_friend_general.lazyInitialize(gnrl,this.m_team_type),(this.m_friend_general._findEnemyTarget=this).m_friend_general.setMyTeamManager(this),this.m_friend_general.retain(),this.m_friend_general.setFriend(!0),this.m_friend_general._cbEventListenerFieldMng=this._generalEventListenerForFieldMng,this.m_friend_general._addBattleFxNode=this._generalAddBattleFxNode,(this.m_friend_general._req_team_cooltime=this).m_friend_general.friend_id=context.getFriendID()}this.m_game_type==db.BattleGameType.Mission?this.m_team_members=this.m_stage_npc.at(this.m_main_mission.current_stage):this.m_game_type==db.BattleGameType.EventDungeon?this.m_team_members=this.m_stage_npc.at(this.m_event_dungeon.current_stage):this.m_game_type==db.BattleGameType.StoryHardMode&&(this.m_team_members=this.m_stage_npc.at(this.m_story_hard_mode_mission.current_stage)),this.m_stage_npc.erase(this.m_main_mission.current_stage)}else if(this.m_game_type==db.BattleGameType.WeeklyDungeon)this.m_team_members=this.m_stage_npc.at(this.m_weekly_dungeon.current_stage),this.m_stage_npc.erase(this.m_weekly_dungeon.current_stage);else if(this.m_game_type==db.BattleGameType.Mussang)this.m_team_members=this.m_stage_npc.at(this.m_mussang.current_stage),this.m_stage_npc.erase(this.m_mussang.current_stage);else if(this.m_game_type==db.BattleGameType.OnceADayDungeon)this.m_team_members=this.m_stage_npc.at(this.m_once_a_day_dungeon.current_stage),this.m_stage_npc.erase(this.m_once_a_day_dungeon.current_stage);else if(this.m_game_type==db.BattleGameType.DailyDungeon)this.m_team_members=this.m_stage_npc.at(this.m_daily_dungeon.current_stage),this.m_stage_npc.erase(this.m_daily_dungeon.current_stage);else if(this.m_game_type==db.BattleGameType.RaidDungeon){var dungeon=context.getRaidDungeonData();this.m_team_members=this.m_stage_npc.at(dungeon.current_stage),this.m_stage_npc.erase(dungeon.current_stage)}else if(this.m_game_type==db.BattleGameType.NewRaidBossDungeon){dungeon=context.getBattleNewRaidBossDungeonData();this.m_team_members=this.m_stage_npc.at(dungeon.current_stage),this.m_stage_npc.erase(dungeon.current_stage)}else if(this.m_game_type==db.BattleGameType.GreatWallDungeon)this.m_team_members=this.m_stage_npc.at(this.m_great_wall_dungeon.current_stage),this.m_stage_npc.erase(this.m_great_wall_dungeon.current_stage);else if(this.m_game_type==db.BattleGameType.TowerDungeon)this.m_team_members=this.m_stage_npc.at(this.m_mussang_tower_dungeon.current_stage),this.m_stage_npc.erase(this.m_mussang_tower_dungeon.current_stage);else if(this.m_game_type==db.BattleGameType.EventMussangBossDungeon){dungeon=context.getEventMussangBossDungeonData();this.m_team_members=this.m_stage_npc.at(dungeon.current_stage),this.m_stage_npc.erase(dungeon.current_stage)}else this.m_game_type==db.BattleGameType.WorldWarNpcDungeon?(this.m_team_members=this.m_stage_npc.at(this.m_world_war_npc_dungeon.current_stage),this.m_stage_npc.erase(this.m_world_war_npc_dungeon.current_stage)):this.m_game_type==db.BattleGameType.EventRaidDungeon&&(this.m_team_members=this.m_stage_npc.at(1),this.m_stage_npc.erase(1));this.m_is_load_complete=!0,this.m_is_initial_special_leader_skill||(this.initCheckSpecialLeaderSkillBuf(),this.m_is_initial_special_leader_skill=!0),null!=this._loadTeamMemberComplete&&this._loadTeamMemberComplete.cbLoadTeamMemberComplete(this),this.calcGeneralsStat();try{for(var i=0,len=this.m_team_members.length;i<len;i++){var tm=this.m_team_members[i];this.m_gnrl_parent.addChild(tm),tm.IsAlive()||tm.setVisible(!1)}}catch(e){}this.unschedule(this.resourceLoading)}},getLoadReadyGeneralCount:function(){return this.m_load_ready_generals.length},enableInsertFriend:function(){return null!=this.m_friend_general},IsInsertedFriend:function(){return this.m_is_inserted_friend},chkIsSkeletonReady:function(){if(null==this.m_team_members)return!1;for(var idx=0;idx<this.m_team_members.length;idx++)if(null==this.m_team_members[idx].m_sk)return!1;return null==this.m_friend_general||null!=this.m_friend_general.m_sk},getFriendGeneral:function(){return this.m_friend_general},initWithTroopsGenerals:function(team_type,troops_num,parent){this.m_team_type=team_type,this.m_gnrl_parent=parent,this.m_troops_number=troops_num,this.m_battle_formations.clear(),this.m_battle_formations=GeneralService.getInstance().getUserBattleFormationList();var service=BattleService.getInstance();this.m_load_ready_generals.length=0,service.getTroopsGenerals(this.m_troops_number,this.m_load_ready_generals_service),this.m_load_ready_generals_service.sort(function(a,b){return b.position-a.position}),this.generateTroopsGenerals();for(var m=MasterTable.getInstance(),context=BattleContext._getInstance(),i=0;i<this.m_load_ready_generals.length;i++){var g=this.m_load_ready_generals[i];if(this.m_game_type==db.BattleGameType.Mission){var mission_id=context.getMissionID();g.evt_dungeon_buff=m.get_EventDungeonGeneralBufList(EVENT_DUNGEON_TYPE_MISSION,mission_id,g.general.gnrl_group)}else if(this.m_game_type==db.BattleGameType.StoryHardMode){var main_story_hard_mode_mission_idx=context.getStoryHardModeMissionId();g.evt_dungeon_buff=m.get_EventDungeonGeneralBuf(EVENT_DUNGEON_TYPE_STORY_HARD_MODE,main_story_hard_mode_mission_idx,g.general.gnrl_group)}else if(this.m_game_type==db.BattleGameType.Mussang){var mussang_id=context.getMussangId();g.evt_dungeon_buff=m.get_EventDungeonGeneralBufList(EVENT_DUNGEON_TYPE_MUSSANG,mussang_id,g.general.gnrl_group)}else this.m_game_type==db.BattleGameType.EventDungeon?(this.m_event_dungeon=context.getEventDungeonData(),g.evt_dungeon_buff=m.get_EventDungeonGeneralBufList(EVENT_DUNGEON_TYPE_EVENT_DUNGEON,this.m_event_dungeon.event_dungeon.event_dungeon_idx,g.general.gnrl_group)):this.m_game_type==db.BattleGameType.DailyDungeon?(this.m_daily_dungeon=context.getDailyDungeonData(),g.evt_dungeon_buff=m.get_EventDungeonGeneralBufList(EVENT_DUNGEON_TYPE_DAILY_DUNGEON,this.m_daily_dungeon.daily_dungeon.daily_dungeon_idx,g.general.gnrl_group)):this.m_game_type==db.BattleGameType.RaidDungeon||this.m_game_type==db.BattleGameType.GreatWallDungeon||(this.m_game_type==db.BattleGameType.TowerDungeon?(this.m_mussang_tower_dungeon=context.getMussangTowerDungeonData(),g.evt_dungeon_buff=m.get_EventDungeonGeneralBufList(EVENT_DUNGEON_TYPE_MUSSANG_TOWER,this.m_mussang_tower_dungeon.mussang_tower.mussang_tower_id,g.general.gnrl_group)):this.m_game_type==db.BattleGameType.OnceADayDungeon?(this.m_once_a_day_dungeon=context.getEventOnceADayDungeonData(),g.evt_dungeon_buff=m.get_EventDungeonGeneralBufList(EVENT_DUNGEON_TYPE_EVENT_ONCE_A_DAY_DUNGEON,this.m_once_a_day_dungeon.dungeon.event_dungeon_once_a_day_idx,g.general.gnrl_group)):this.m_game_type==db.BattleGameType.EventMussangBossDungeon?(this.m_mussang_boss_dungeon=context.getEventMussangBossDungeonData(),g.evt_dungeon_buff=m.get_EventDungeonGeneralBufList(EVENT_DUNGEON_TYPE_MUSSANG_BOSS,this.m_mussang_boss_dungeon.data.boss_dungeon_idx,g.general.gnrl_group)):(this.m_game_type,db.BattleGameType.NewRaidBossDungeon));this.m_load_ready_generals[i]=g}if(this.m_team_type==BattleGeneral_TeamType.Left){if(this.m_game_type==db.BattleGameType.Mission)for((task_mng=BattleMissionTaskManager._getInstance()).setStartBattleGeneralCount(this.m_load_ready_generals.length),i=0;i<this.m_load_ready_generals.length;i++)task_mng.addTroopsGeneral(this.m_load_ready_generals[i].general.gnrl_group),task_mng.addArmServiceType(this.m_load_ready_generals[i].arm_service_type);else if(this.m_game_type==db.BattleGameType.StoryHardMode){for((task_mng=BattleStoryHardModeMissionTaskManager._getInstance()).setStartBattleGeneralCount(this.m_load_ready_generals.length),i=0;i<this.m_load_ready_generals.length;i++)task_mng.addTroopsGeneral(this.m_load_ready_generals[i].general.gnrl_group),task_mng.addArmServiceType(this.m_load_ready_generals[i].arm_service_type)}else if(this.m_game_type==db.BattleGameType.TowerDungeon){var task_mng;for((task_mng=BattleTowerTaskManager._getInstance()).setStartBattleGeneralCount(this.m_load_ready_generals.length),i=0;i<this.m_load_ready_generals.length;i++)task_mng.addTroopsGeneral(this.m_load_ready_generals[i].general.gnrl_group),task_mng.addArmServiceType(this.m_load_ready_generals[i].arm_service_type)}var position_list=[370,234];this.m_position_list.push_back(position_list),position_list=[300,318],this.m_position_list.push_back(position_list),position_list=[240,150],this.m_position_list.push_back(position_list),position_list=[170,276],this.m_position_list.push_back(position_list),position_list=[100,192],this.m_position_list.push_back(position_list)}else{position_list=[this.winSize.width-370,234];this.m_position_list.push_back(position_list),position_list=[this.winSize.width-300,318],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-240,150],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-170,276],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-100,192],this.m_position_list.push_back(position_list)}this.schedule(this.resourceLoading,UPDATE_SCHEDULE_INTERVAL)},initWithMussangBossGenerals:function(team_type,raid_dungeon,parent){this.m_team_type=team_type,this.m_gnrl_parent=parent,this.m_battle_formations.clear(),this.m_battle_formations=GeneralService.getInstance().getUserBattleFormationList();BattleService.getInstance();var stage_npc=raid_dungeon.stage_npc;if(this.m_team_type==BattleGeneral_TeamType.Left){var position_list=[370,234];this.m_position_list.push_back(position_list),position_list=[300,318],this.m_position_list.push_back(position_list),position_list=[240,150],this.m_position_list.push_back(position_list),position_list=[170,276],this.m_position_list.push_back(position_list),position_list=[100,192],this.m_position_list.push_back(position_list)}else{position_list=[this.winSize.width-370,234];this.m_position_list.push_back(position_list),position_list=[this.winSize.width-300,318],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-240,150],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-170,276],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-100,192],this.m_position_list.push_back(position_list)}this.m_load_ready_generals.length=0,stage_npc.foreach(function(iter){cc.log(iter);for(var it=0;it<iter.length;it++){var g=iter[it];this.m_load_ready_generals.push(g)}0}.bind(this)),this.schedule(this.resourceLoading,UPDATE_SCHEDULE_INTERVAL)},IsLoadMemberComplete:function(){return this.m_is_load_complete},getTeamMembers:function(){return this.m_team_members},getAllNpcTeamMembers:function(){return this.m_stage_npc},getBattleState:function(){return this.m_battle_state},initWithDailyDungeonNpcGeneral:function(team_type,daily_dungeon,parent){this.m_team_type=team_type,this.m_gnrl_parent=parent,this.m_daily_dungeon=daily_dungeon;var stage_npc=this.m_daily_dungeon.stage_npc,position_list=[this.winSize.width-330,140];this.m_position_list.push_back(position_list),position_list=[this.winSize.width-300,318],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-240,150],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-170,276],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-100,192],this.m_position_list.push_back(position_list);this.m_load_ready_generals.length=0,stage_npc.foreach(function(iter){cc.log(iter);for(var it=0;it<iter.length;it++){var g=iter[it];this.m_load_ready_generals.push(g)}0}.bind(this)),this.schedule(this.resourceLoading,UPDATE_SCHEDULE_INTERVAL)},initWithWorldWarNpcDungeonGeneral:function(team_type,dungeon,parent){this.m_team_type=team_type,this.m_gnrl_parent=parent,this.m_world_war_npc_dungeon=dungeon;var stage_npc=this.m_world_war_npc_dungeon.stage_npc,position_list=[this.winSize.width-370,234];this.m_position_list.push_back(position_list),position_list=[this.winSize.width-300,318],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-240,150],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-170,276],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-100,192],this.m_position_list.push_back(position_list);this.m_load_ready_generals.clear(),stage_npc.foreach(function(iter){for(var it=0;it<iter.length;it++){var g=iter[it];this.m_load_ready_generals.push(g)}0}.bind(this)),this.schedule(this.resourceLoading,UPDATE_SCHEDULE_INTERVAL)},initWithGreatWallDungeonNpcGeneral:function(team_type,great_wall_dungeon,parent){this.m_team_type=team_type,this.m_gnrl_parent=parent,this.m_great_wall_dungeon=great_wall_dungeon;var stage_npc=this.m_great_wall_dungeon.stage_npc,position_list=[this.winSize.width-370,234];this.m_position_list.push_back(position_list),position_list=[this.winSize.width-300,318],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-240,150],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-170,276],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-100,192],this.m_position_list.push_back(position_list);this.m_load_ready_generals.clear(),stage_npc.foreach(function(iter){cc.log(iter);for(var it=0;it<iter.length;it++){var g=iter[it];this.m_load_ready_generals.push(g)}0}.bind(this)),this.schedule(this.resourceLoading,UPDATE_SCHEDULE_INTERVAL)},initWithEventRaidDungeonTroopsGeneral:function(team_type,troops_num,parent){this.m_team_type=team_type,this.m_gnrl_parent=parent,this.m_troops_number=troops_num,this.m_battle_formations=null,this.m_battle_formations=new Map,this.m_battle_formations=GeneralService.getInstance().getUserBattleFormationList();var service=BattleService.getInstance();this.m_load_ready_generals.length=0,service.getTroopsGenerals(this.m_troops_number,this.m_load_ready_generals_service),this.m_load_ready_generals_service.sort(function(a,b){return b.position-a.position}),this.generateTroopsGenerals();var position_list=[370,234];this.m_position_list.push_back(position_list),position_list=[300,318],this.m_position_list.push_back(position_list),position_list=[240,150],this.m_position_list.push_back(position_list),position_list=[170,276],this.m_position_list.push_back(position_list),position_list=[100,192],this.m_position_list.push_back(position_list),this.schedule(this.resourceLoading,UPDATE_SCHEDULE_INTERVAL)},initWithEventRaidDungeonNpcGeneral:function(team_type,parent){this.m_team_type=team_type,this.m_gnrl_parent=parent,this.m_battle_formations=null,this.m_battle_formations=new Map,this.m_battle_formations=GeneralService.getInstance().getUserBattleFormationList();var position_list=[winSize.width-370,234];this.m_position_list.push_back(position_list),position_list=[winSize.width-300,318],this.m_position_list.push_back(position_list),position_list=[winSize.width-240,150],this.m_position_list.push_back(position_list),position_list=[winSize.width-170,276],this.m_position_list.push_back(position_list),position_list=[winSize.width-100,192],this.m_position_list.push_back(position_list);var hero=$.extend({},database.BattleGeneral),dungeon_data=BattleContext._getInstance().getEventRaidDungeonData(),npc_boss=MasterManager.getInstance().get_EventRaidDungeonNpc(dungeon_data.event_raid_dungeon_idx,1),npc_general=MasterManager.getInstance().get_NpcGeneral(npc_boss.npc1_idx);BattleService.getInstance().setNpcGeneralData(hero,npc_general),hero.is_zoom=!0,this.m_load_ready_generals.length=0,this.m_load_ready_generals.push(hero),this.schedule(this.resourceLoading,UPDATE_SCHEDULE_INTERVAL)},initWithEventOnceADayDungeonNpcGeneral:function(team_type,dungeon,parent){this.m_team_type=team_type,this.m_gnrl_parent=parent,this.m_once_a_day_dungeon=dungeon;var stage_npc=this.m_once_a_day_dungeon.stage_npc;if(this.m_team_type==BattleGeneral_TeamType.Left){var position_list=[370,234];this.m_position_list.push_back(position_list),position_list=[300,318],this.m_position_list.push_back(position_list),position_list=[240,150],this.m_position_list.push_back(position_list),position_list=[170,276],this.m_position_list.push_back(position_list),position_list=[100,192],this.m_position_list.push_back(position_list)}else{position_list=[this.winSize.width-370,234];this.m_position_list.push_back(position_list),position_list=[this.winSize.width-300,318],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-240,150],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-170,276],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-100,192],this.m_position_list.push_back(position_list)}this.m_load_ready_generals.length=0,stage_npc.foreach(function(iter){cc.log(iter);for(var it=0;it<iter.length;it++){var g=iter[it];this.m_load_ready_generals.push(g)}0}.bind(this)),this.m_load_ready_generals.sort(function(a,b){return b.position-a.position}),this.schedule(this.resourceLoading,UPDATE_SCHEDULE_INTERVAL)},initWithEventdungeonNpcGeneral:function(team_type,event_dungeon,parent){this.m_team_type=team_type,this.m_gnrl_parent=parent,this.m_event_dungeon=event_dungeon;var stage_npc=$.extend({},this.m_event_dungeon.stage_npc);if(this.m_team_type==BattleGeneral_TeamType.Left){var position_list=[370,234];this.m_position_list.push_back(position_list),position_list=[300,318],this.m_position_list.push_back(position_list),position_list=[240,150],this.m_position_list.push_back(position_list),position_list=[170,276],this.m_position_list.push_back(position_list),position_list=[100,192],this.m_position_list.push_back(position_list)}else{position_list=[this.winSize.width-330,140];this.m_cutin_position_list.push_back(position_list),position_list=[this.winSize.width-300,318],this.m_cutin_position_list.push_back(position_list),position_list=[this.winSize.width-240,150],this.m_cutin_position_list.push_back(position_list),position_list=[this.winSize.width-170,276],this.m_cutin_position_list.push_back(position_list),position_list=[this.winSize.width-100,192],this.m_cutin_position_list.push_back(position_list),position_list=[this.winSize.width-370,234],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-300,318],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-240,150],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-170,276],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-100,192],this.m_position_list.push_back(position_list)}this.m_load_ready_generals.length=0,stage_npc.foreach(function(iter){cc.log(iter);for(var it=0;it<iter.length;it++){var g=iter[it];this.m_load_ready_generals.push(g)}0}.bind(this)),this.m_load_ready_generals.sort(function(a,b){return b.position-a.position}),this.schedule(this.resourceLoading,UPDATE_SCHEDULE_INTERVAL)},initWithMussangTowerNpcGenerals:function(team_type,tower,parent){this.m_team_type=team_type,this.m_gnrl_parent=parent,this.m_mussang_tower_dungeon=tower;var stage_npc=new Map;if(stage_npc=this.m_mussang_tower_dungeon.stage_npc,this.m_team_type==BattleGeneral_TeamType.Left){var position_list=[370,234];this.m_position_list.push_back(position_list),position_list=[300,318],this.m_position_list.push_back(position_list),position_list=[240,150],this.m_position_list.push_back(position_list),position_list=[170,276],this.m_position_list.push_back(position_list),position_list=[100,192],this.m_position_list.push_back(position_list)}else{position_list=[this.winSize.width-370,234];this.m_position_list.push_back(position_list),position_list=[this.winSize.width-300,318],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-240,150],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-170,276],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-100,192],this.m_position_list.push_back(position_list)}this.m_load_ready_generals.length=0,stage_npc.foreach(function(iter){cc.log(iter);for(var it=0;it<iter.length;it++){var g=iter[it];this.m_load_ready_generals.push(g)}0}.bind(this)),this.m_load_ready_generals.sort(function(a,b){return b.position-a.position}),this.schedule(this.resourceLoading,UPDATE_SCHEDULE_INTERVAL)},initWithMussangNpcGenerals:function(team_type,mussang,parent){this.m_team_type=team_type,this.m_gnrl_parent=parent,this.m_mussang=mussang;var stage_npc=new Map;if(stage_npc=this.m_mussang.stage_npc,this.m_team_type==BattleGeneral_TeamType.Left){var position_list=[370,234];this.m_position_list.push_back(position_list),position_list=[300,318],this.m_position_list.push_back(position_list),position_list=[240,150],this.m_position_list.push_back(position_list),position_list=[170,276],this.m_position_list.push_back(position_list),position_list=[100,192],this.m_position_list.push_back(position_list)}else{position_list=[this.winSize.width-370,234];this.m_position_list.push_back(position_list),position_list=[this.winSize.width-300,318],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-240,150],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-170,276],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-100,192],this.m_position_list.push_back(position_list)}this.m_load_ready_generals.length=0,stage_npc.foreach(function(iter){cc.log(iter);for(var it=0;it<iter.length;it++){var g=iter[it];this.m_load_ready_generals.push(g)}0}.bind(this)),this.m_load_ready_generals.sort(function(a,b){return b.position-a.position}),this.schedule(this.resourceLoading,UPDATE_SCHEDULE_INTERVAL)},initWithWeeklyNpcGenerals:function(team_type,weekly,parent){this.m_team_type=team_type,this.m_gnrl_parent=parent,this.m_weekly_dungeon=weekly;var stage_npc=this.m_weekly_dungeon.stage_npc;if(this.m_team_type==BattleGeneral_TeamType.Left){var position_list=[370,234];this.m_position_list.push_back(position_list),position_list=[300,318],this.m_position_list.push_back(position_list),position_list=[240,150],this.m_position_list.push_back(position_list),position_list=[170,276],this.m_position_list.push_back(position_list),position_list=[100,192],this.m_position_list.push_back(position_list)}else{position_list=[this.winSize.width-370,234];this.m_position_list.push_back(position_list),position_list=[this.winSize.width-300,318],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-240,150],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-170,276],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-100,192],this.m_position_list.push_back(position_list)}this.m_load_ready_generals.length=0,stage_npc.foreach(function(iter){cc.log(iter);for(var it=0;it<iter.length;it++){var g=iter[it];this.m_load_ready_generals.push(g)}0}.bind(this)),this.m_load_ready_generals.sort(function(a,b){return b.position-a.position}),this.schedule(this.resourceLoading,UPDATE_SCHEDULE_INTERVAL)},initWithNewRaidBossDungeonNpcGeneral:function(team_type,dungeon,parent){this.m_team_type=team_type,this.m_gnrl_parent=parent,this.m_new_raid_boss_dungeon=dungeon;var stage_npc=this.m_new_raid_boss_dungeon.stage_npc,arrange_info=MasterManager.getInstance().get_NewRaidBossNpcArrangeInfo(this.m_new_raid_boss_dungeon.dungeon_data.new_raid_boss_npc_arrange_info_idx),position_list=[arrange_info.head_x,arrange_info.head_y];this.m_position_list.push_back(position_list);position_list=[arrange_info.body_top_x,arrange_info.body_top_y];this.m_position_list.push_back(position_list);position_list=[arrange_info.body_bottom_x,arrange_info.body_bottom_y];this.m_position_list.push_back(position_list);position_list=[arrange_info.tail_top_x,arrange_info.tail_top_y];this.m_position_list.push_back(position_list);position_list=[arrange_info.tail_bottom_x,arrange_info.tail_bottom_y];this.m_position_list.push_back(position_list);this.m_load_ready_generals.length=0,stage_npc.foreach(function(iter){cc.log(iter);for(var it=0;it<iter.length;it++){var g=iter[it];this.m_load_ready_generals.push(g)}0}.bind(this)),this.schedule(this.resourceLoading,UPDATE_SCHEDULE_INTERVAL)},initWithRaidDungeonNpcGeneral:function(team_type,raid_dungeon,parent){this.m_team_type=team_type,this.m_gnrl_parent=parent;var stage_npc=raid_dungeon.stage_npc;if(this.m_team_type==BattleGeneral_TeamType.Left){var position_list=[370,234];this.m_position_list.push_back(position_list),position_list=[300,318],this.m_position_list.push_back(position_list),position_list=[240,150],this.m_position_list.push_back(position_list),position_list=[170,276],this.m_position_list.push_back(position_list),position_list=[100,192],this.m_position_list.push_back(position_list)}else{position_list=[this.winSize.width-370,154];this.m_position_list.push_back(position_list),position_list=[300,318],this.m_position_list.push_back(position_list),position_list=[240,150],this.m_position_list.push_back(position_list),position_list=[170,276],this.m_position_list.push_back(position_list),position_list=[100,192],this.m_position_list.push_back(position_list)}this.m_load_ready_generals.length=0,stage_npc.foreach(function(iter){cc.log(iter);for(var it=0;it<iter.length;it++){var g=iter[it];this.m_load_ready_generals.push(g)}0}.bind(this)),this.schedule(this.resourceLoading,UPDATE_SCHEDULE_INTERVAL)},initWithStoryHardModeDungeonNpcGeneral:function(team_type,dungeon,parent){this.m_team_type=team_type,this.m_gnrl_parent=parent,this.m_story_hard_mode_mission=dungeon;var stage_npc=this.m_story_hard_mode_mission.stage_npc;if(this.m_team_type==BattleGeneral_TeamType.Left){var position_list=[370,234];this.m_position_list.push_back(position_list),position_list=[300,318],this.m_position_list.push_back(position_list),position_list=[240,150],this.m_position_list.push_back(position_list),position_list=[170,276],this.m_position_list.push_back(position_list),position_list=[100,192],this.m_position_list.push_back(position_list)}else{position_list=[this.winSize.width-370,234];this.m_position_list.push_back(position_list),position_list=[this.winSize.width-300,318],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-240,150],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-170,276],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-100,192],this.m_position_list.push_back(position_list)}this.m_load_ready_generals.length=0,stage_npc.foreach(function(iter){cc.log(iter);for(var it=0;it<iter.length;it++){var g=iter[it];this.m_load_ready_generals.push(g)}0}.bind(this)),this.m_load_ready_generals.sort(function(a,b){return b.position-a.position}),this.schedule(this.resourceLoading,UPDATE_SCHEDULE_INTERVAL)},initWithNpcGenerals:function(team_type,mission,parent){this.m_team_type=team_type,this.m_gnrl_parent=parent,this.m_main_mission=mission;var stage_npc=this.m_main_mission.stage_npc;if(this.m_team_type==BattleGeneral_TeamType.Left){var position_list=[370,234];this.m_position_list.push_back(position_list),position_list=[300,318],this.m_position_list.push_back(position_list),position_list=[240,150],this.m_position_list.push_back(position_list),position_list=[170,276],this.m_position_list.push_back(position_list),position_list=[100,192],this.m_position_list.push_back(position_list)}else{position_list=[this.winSize.width-370,234];this.m_position_list.push_back(position_list),position_list=[this.winSize.width-300,318],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-240,150],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-170,276],this.m_position_list.push_back(position_list),position_list=[this.winSize.width-100,192],this.m_position_list.push_back(position_list)}this.m_load_ready_generals.length=0,stage_npc.foreach(function(iter){cc.log(iter);for(var it=0;it<iter.length;it++){var g=iter[it];this.m_load_ready_generals.push(g)}0}.bind(this)),this.m_load_ready_generals.sort(function(a,b){return b.position-a.position}),this.schedule(this.resourceLoading,UPDATE_SCHEDULE_INTERVAL)},IsAllDead:function(){return 0==this.getAliveMemberCount()},setTargetTeam:function(target_team){this.m_target_team=target_team},getTargetTeam:function(){return this.m_target_team},getTeamTotalLifePoint:function(){for(var sum=0,i=0;i<this.m_team_members.length;i++){sum+=this.m_team_members[i].getMaxHealthPoint()}return sum+0},getCurrentTeamTotalLifePoint:function(){for(var sum=0,i=0;i<this.m_team_members.length;i++){sum+=this.m_team_members[i].getOriginCurrentLifePoint()}return sum+0},getAliveFreezeCount:function(){for(var count=0,i=0;i<this.m_team_members.length;i++){var g=this.m_team_members[i];g.IsAlive()&&g.IsFreezeCheck()&&count++}return count},getAliveMemberCount:function(){for(var count=0,i=0;i<this.m_team_members.length;i++){var g=this.m_team_members[i];(g.IsAlive()||g.IsRebornReserved())&&count++}return count},battleAllRemoveDurationEffects:function(){for(var i=0;i<this.m_team_members.length;i++){var hero=this.m_team_members[i];hero.findTransType(database.BattleEffectTrans.Freeze)&&hero.unfreeze(),hero.removeAllDurabilityEffects(),hero.removeAllEffects(),hero.removeAllTransCommonFxNode()}},battleEnd:function(){for(var i=0;i<this.m_team_members.length;i++){var hero=this.m_team_members[i];this.battleAllRemoveDurationEffects(),hero.setGeneralState(BattleGeneral_GeneralState.End),hero.playAction(ActionType.Attack_Idle)}},preBattleDungeonSkillExec:function(){for(var i=0;i<this.m_team_members.length;i++)0<this.m_new_raid_boss_dungeon.dungeon_skill_data.size()&&this.m_team_members[i].playDungeonSkill()},battleStart:function(){for(var i=0,len=this.m_team_members.length;i<len;i++){var hero=this.m_team_members[i];hero.IsAlive()&&(hero.firstEnableSkillCooltime(),hero.findTransType(database.BattleEffectTrans.Motion_Singing,hero.IsFriend())?(hero.setGeneralState(BattleGeneral_GeneralState.Idle2),hero.playAction(ActionType.Idle2)):hero.findTransType(database.BattleEffectTrans.FeverMode,hero.IsFriend())&&(479==hero.getBattleGeneral().general.gnrl_group||504==hero.getBattleGeneral().general.gnrl_group)?(hero.setGeneralState(BattleGeneral_GeneralState.Idle),hero.playAction(ActionType.Idle2)):hero.setGeneralState(BattleGeneral_GeneralState.Find),hero.updateLifeBar(),hero.momentShowInfoBar(2))}this.m_team_type==BattleGeneral_TeamType.Right&&this.IsCutinStage()&&(this.m_event_dungeon_cutin_boss_max_life=this.getTeamTotalLifePoint())},battleCutinBackCourt:function(){for(var i=0,len=this.m_team_members.length;i<len;i++){var hero=this.m_team_members[i];hero.is_pause()&&(hero.m_focus_state==FOCUS_STATE.UNFOCUS?hero.unfocusEnd():hero.generalResume()),hero.IsAlive()&&(hero.cancelActiveSkillForCutin(),hero.cancelUsedEffect(),hero.releaseTransGeneral(database.BattleEffectTrans.Freeze),hero.setReservedBackCourt(!0),hero.calcDurabilityEffect(0))}},battleBackCourt:function(){for(var i=0,len=this.m_team_members.length;i<len;i++){var hero=this.m_team_members[i];hero.IsAnimationPause()&&(hero.m_focus_state==FOCUS_STATE.UNFOCUS?hero.unfocusEnd():hero.generalResume()),hero.IsAlive()&&(hero.releaseTransGeneral(database.BattleEffectTrans.Freeze),hero.setReservedBackCourt(!0))}},battleRun:function(){for(var i=0;i<this.m_team_members.length;i++){var hero=this.m_team_members[i];hero.is_pause&&(hero.m_focus_state==FOCUS_STATE.UNFOCUS?hero.unfocusEnd():hero.generalResume()),hero.setGeneralState(BattleGeneral_GeneralState.Run),hero.playAction(ActionType.Run)}},setBattleState:function(state){this.m_team_type==BattleGeneral_TeamType.Right&&BattleState.GameReady,this.m_battle_state!=state&&(this.m_battle_state=state)},IsCutinStage:function(){return this.m_game_type==db.BattleGameType.EventDungeon&&this.m_event_dungeon.cutin_stage==this.m_event_dungeon.current_stage},getCutinStageBossGnrlGroup:function(){var gnrl_group=0;if(this.IsCutinStage())for(var i=0,len=this.m_team_members.length;i<len;i++){var m=this.m_team_members[i];if(m.getGeneral().is_zoom&&m.getGeneral().is_cutin_npc){gnrl_group=m.getGeneral().general.gnrl_group;break}}return gnrl_group},battleAppear:function(){for(var i=0,len=this.m_team_members.length;i<len;i++){var hero=this.m_team_members[i];hero.IsAlive()&&hero.appearEffect()}},battleReady:function(){for(var i=0,len=this.m_team_members.length;i<len;i++){var hero=this.m_team_members[i];hero.pause()&&(hero.m_focus_state==FOCUS_STATE.UNFOCUS?hero.unfocusEnd():hero.generalResume()),hero.playAction(ActionType.Basic_Idle);var dur_list=[];hero.findTransPassiveSkillDurationEffectFind(database.BattleInvokeType.BattleInvokeType_Dummy30,dur_list);for(var jdx=0;jdx<dur_list.length;jdx++)dur_list[jdx].trans_type==database.BattleEffectTrans.Use_Active_Skill_Angel_Stack_Up?hero.addDurabilityEffect(dur_list[jdx],hero):dur_list[jdx].trans_type==database.BattleEffectTrans.Use_Active_Skill_Glitter_Beach_Stack_Up?hero.addDurabilityEffect(dur_list[jdx],hero):dur_list[jdx].trans_type==database.BattleEffectTrans.Timer_Passed_Stack_Up&&hero.addDurabilityEffect(dur_list[jdx],hero)}if(this.m_team_type==BattleGeneral_TeamType.Right&&this.m_game_type==db.BattleGameType.EventRaidDungeon)for(var idx=0;idx<this.m_team_members.length;idx++)this.m_evnet_dungeon_raid_boss_max_life+=this.m_team_members[idx].getMaxHealthPoint()},battleStopRun:function(){for(var i=0;i<this.m_team_members.length;i++){var hero=this.m_team_members[i];hero.clearTargetEnemy(),hero.cancelActiveSkill(),hero.findTransType(database.BattleEffectTrans.FeverMode,hero.IsFriend())&&(479==hero.getGeneral().general.gnrl_group||504==hero.getGeneral().general.gnrl_group)?hero.playAction(ActionType.Idle2):hero.playAction(ActionType.Attack_Idle),hero.setGeneralState(BattleGeneral_GeneralState.Wait)}},HasNextStage:function(){var has_next=!1;return this.m_team_type==BattleGeneral_TeamType.Right&&(this.m_game_type==db.BattleGameType.Mission?this.m_main_mission.current_stage<this.m_main_mission.stage_count&&(has_next=!0):this.m_game_type==db.BattleGameType.StoryHardMode?this.m_story_hard_mode_mission.current_stage<this.m_story_hard_mode_mission.stage_count&&(has_next=!0):this.m_game_type==db.BattleGameType.WeeklyDungeon?this.m_weekly_dungeon.current_stage<this.m_weekly_dungeon.stage_count&&(has_next=!0):this.m_game_type==db.BattleGameType.Mussang?this.m_mussang.current_stage<this.m_mussang.stage_count&&(has_next=!0):this.m_game_type==db.BattleGameType.EventDungeon?this.m_event_dungeon.current_stage<this.m_event_dungeon.stage_count&&(has_next=!0):this.m_game_type==db.BattleGameType.OnceADayDungeon?this.m_once_a_day_dungeon.current_stage<this.m_once_a_day_dungeon.stage_count&&(has_next=!0):this.m_game_type==db.BattleGameType.DailyDungeon?this.m_daily_dungeon.current_stage<this.m_daily_dungeon.stage_count&&(has_next=!0):this.m_game_type==db.BattleGameType.GreatWallDungeon?this.m_great_wall_dungeon.current_stage<this.m_great_wall_dungeon.stage_count&&(has_next=!0):this.m_game_type==db.BattleGameType.TowerDungeon?this.m_mussang_tower_dungeon.current_stage<this.m_mussang_tower_dungeon.stage_count&&(has_next=!0):this.m_game_type==db.BattleGameType.WorldWarNpcDungeon&&this.m_world_war_npc_dungeon.current_stage<this.m_world_war_npc_dungeon.stage_count&&(has_next=!0)),has_next},battleNextTeam:function(stage_number){if(this.m_team_type==BattleGeneral_TeamType.Right){for(var i=0;i<this.m_team_members.length;i++)this.m_team_members[i].removeFromParent(),this.m_team_members[i]._parent=null;this.m_team_members.length=0,this.m_game_type==db.BattleGameType.Mission?(this.m_main_mission.current_stage=stage_number,this.m_team_members=this.m_stage_npc.at(this.m_main_mission.current_stage),this.m_stage_npc.erase(this.m_main_mission.current_stage)):this.m_game_type==db.BattleGameType.StoryHardMode?(this.m_story_hard_mode_mission.current_stage=stage_number,this.m_team_members=this.m_stage_npc.at(this.m_story_hard_mode_mission.current_stage),this.m_stage_npc.erase(this.m_story_hard_mode_mission.current_stage)):this.m_game_type==db.BattleGameType.WeeklyDungeon?(this.m_weekly_dungeon.current_stage=stage_number,this.m_team_members=this.m_stage_npc.at(this.m_weekly_dungeon.current_stage),this.m_stage_npc.erase(this.m_weekly_dungeon.current_stage)):this.m_game_type==db.BattleGameType.Mussang?(this.m_mussang.current_stage=stage_number,this.m_team_members=this.m_stage_npc.at(this.m_mussang.current_stage),this.m_stage_npc.erase(this.m_mussang.current_stage)):this.m_game_type==db.BattleGameType.EventDungeon?(this.m_event_dungeon.current_stage=stage_number,this.m_team_members=this.m_stage_npc.at(this.m_event_dungeon.current_stage),this.m_stage_npc.erase(this.m_event_dungeon.current_stage)):this.m_game_type==db.BattleGameType.OnceADayDungeon?(this.m_once_a_day_dungeon.current_stage=stage_number,this.m_team_members=this.m_stage_npc.at(this.m_once_a_day_dungeon.current_stage),this.m_stage_npc.erase(this.m_once_a_day_dungeon.current_stage)):this.m_game_type==db.BattleGameType.DailyDungeon?(this.m_daily_dungeon.current_stage=stage_number,this.m_team_members=this.m_stage_npc.at(this.m_daily_dungeon.current_stage),this.m_stage_npc.erase(this.m_daily_dungeon.current_stage)):this.m_game_type==db.BattleGameType.GreatWallDungeon?(this.m_great_wall_dungeon.current_stage=stage_number,this.m_team_members=this.m_stage_npc.at(this.m_great_wall_dungeon.current_stage),this.m_stage_npc.erase(this.m_great_wall_dungeon.current_stage)):this.m_game_type==db.BattleGameType.TowerDungeon?(this.m_mussang_tower_dungeon.current_stage=stage_number,this.m_team_members=this.m_stage_npc.at(this.m_mussang_tower_dungeon.current_stage),this.m_stage_npc.erase(this.m_mussang_tower_dungeon.current_stage)):this.m_game_type==db.BattleGameType.WorldWarNpcDungeon&&(this.m_world_war_npc_dungeon.current_stage=stage_number,this.m_team_members=this.m_stage_npc.at(this.m_world_war_npc_dungeon.current_stage),this.m_stage_npc.erase(this.m_world_war_npc_dungeon.current_stage))}try{for(i=0;i<this.m_team_members.length;i++){var m=this.m_team_members[i];m.setGeneralTimeScale(this.m_cur_time_scale),m.setAutoSkill(!0),this.m_gnrl_parent.addChild(m),m.appearGeneral(),m.setGeneralState(BattleGeneral_GeneralState.Wait),m.calcGeneralStat()}}catch(e){}if(3==stage_number)try{for(i=0;i<this.m_team_members.length;i++){var gnrl=this.m_team_members[i].getGeneral();if(gnrl.is_zoom){this.playVoicePart(gnrl.gnrl_id,voice_battle_init_leader);break}}}catch(e){}},playVoicePart:function(gnrl_id,voice_type){},step:function(dt){for(var i=0,len=this.m_team_members.length;i<len;i++){this.m_team_members[i].step(dt)}},findOurTarget:function(base,target_count,priority_position){for(var position=base.getBattlePosition(),temp_list=[],idx=0;idx<base.m_durability_effects.length;idx++)base.m_durability_effects[idx].trans_type==database.BattleEffectTrans.Target_Count_Change_One&&(target_count=1);for(var targets=[],add_pos=function(list,pos){-1==list.findIndex(function(obj){return obj==pos})&&list.push_back(pos)},members=this.getTeamMembers(),sort_data=[],i=0;i<members.size();i++){if((member=members.at(i)).IsAlive())(sd={}).is_alive=member.IsAlive(),sd.position=member.getBattlePosition(),sd.max_life_point=member.getMaxHealthPoint(),sd.life_point=member.getCurrentLifePoint(),sd.attk_point=member.getAttackPoint(),sd.def_point=member.getDefencePoint(),sd.gnrl_id=member.getGeneral().general.gnrl_id,sd.service_type=member.getGeneral().general.arm_service_type,null!=member.getGeneral().general.element_type&&null!=member.getGeneral().general.element_type?sd.element_type=member.getGeneral().general.element_type:sd.element_type=0,sort_data.push_back(sd)}if(1==priority_position)add_pos(temp_list,db.BattlePosition.Head);else if(2==priority_position||3==priority_position)position==db.BattlePosition.Body_2||position==db.BattlePosition.Tail_2?(add_pos(temp_list,db.BattlePosition.Body_2),add_pos(temp_list,db.BattlePosition.Body_1)):(add_pos(temp_list,db.BattlePosition.Body_1),add_pos(temp_list,db.BattlePosition.Body_2));else if(4==priority_position||5==priority_position)position==db.BattlePosition.Body_2||position==db.BattlePosition.Tail_2?(add_pos(temp_list,db.BattlePosition.Tail_2),add_pos(temp_list,db.BattlePosition.Tail_1)):(add_pos(temp_list,db.BattlePosition.Tail_1),add_pos(temp_list,db.BattlePosition.Tail_2));else if(6==priority_position)add_pos(temp_list,db.BattlePosition.Head),add_pos(temp_list,db.BattlePosition.Body_1),add_pos(temp_list,db.BattlePosition.Body_2),add_pos(temp_list,db.BattlePosition.Tail_1),add_pos(temp_list,db.BattlePosition.Tail_2),temp_list.shuffle();else if(7==priority_position)for(i=0;i<members.size();i++){var member;if((member=members.at(i)).getGeneral().is_zoom){add_pos(temp_list,member.getBattlePosition());break}}else if(8==priority_position){sort_data=stable(sort_data,function(l,r){return l.life_point/l.max_life_point<r.life_point/r.max_life_point}.bind(this));for(i=0;i<sort_data.size();i++){(sd=sort_data.at(i)).is_alive&&add_pos(temp_list,sd.position)}}else if(9==priority_position){sort_data=stable(sort_data,function(l,r){var l_p=l.life_point/l.max_life_point;return r.life_point/r.max_life_point<l_p}.bind(this));for(i=0;i<sort_data.size();i++){(sd=sort_data.at(i)).is_alive&&add_pos(temp_list,sd.position)}}else if(10==priority_position);else if(11==priority_position);else if(12==priority_position){sort_data=stable(sort_data,function(l,r){return l.attk_point<r.attk_point}.bind(this));for(i=0;i<sort_data.size();i++){(sd=sort_data.at(i)).is_alive&&add_pos(temp_list,sd.position)}}else if(13==priority_position){sort_data=stable(sort_data,function(l,r){return l.attk_point>r.attk_point}.bind(this));for(i=0;i<sort_data.size();i++){(sd=sort_data.at(i)).is_alive&&add_pos(temp_list,sd.position)}}else if(14==priority_position){sort_data=stable(sort_data,function(l,r){return l.def_point<r.def_point}.bind(this));for(i=0;i<sort_data.size();i++){(sd=sort_data.at(i)).is_alive&&add_pos(temp_list,sd.position)}}else if(15==priority_position){sort_data=stable(sort_data,function(l,r){return l.def_point>r.def_point}.bind(this));for(i=0;i<sort_data.size();i++){var sd;(sd=sort_data.at(i)).is_alive&&add_pos(temp_list,sd.position),sd=null}}else{if(16==priority_position)return void this.findRandomTeamFormation(this.m_target_team,targets,target_count);if(23==priority_position)for(var battleposition=1;6!=battleposition;++battleposition)for(var sort_data_idx=0;sort_data_idx<sort_data.length;sort_data_idx++){(general=$.extend({},sort_data.at(sort_data_idx))).position==battleposition&&1==general.service_type&&general.is_alive&&add_pos(temp_list,general.position),general=null}else if(24==priority_position)for(battleposition=1;6!=battleposition;++battleposition)for(sort_data_idx=0;sort_data_idx<sort_data.length;sort_data_idx++){(general=$.extend({},sort_data.at(sort_data_idx))).position==battleposition&&2==general.service_type&&general.is_alive&&add_pos(temp_list,general.position),general=null}else if(25==priority_position)for(battleposition=1;6!=battleposition;++battleposition)for(sort_data_idx=0;sort_data_idx<sort_data.length;sort_data_idx++){(general=$.extend({},sort_data.at(sort_data_idx))).position==battleposition&&3==general.service_type&&general.is_alive&&add_pos(temp_list,general.position),general=null}else if(26==priority_position)for(battleposition=1;6!=battleposition;++battleposition)for(sort_data_idx=0;sort_data_idx<sort_data.length;sort_data_idx++){(general=$.extend({},sort_data.at(sort_data_idx))).position==battleposition&&1==general.element_type&&general.is_alive&&add_pos(temp_list,general.position),general=null}else if(27==priority_position)for(battleposition=1;6!=battleposition;++battleposition)for(sort_data_idx=0;sort_data_idx<sort_data.length;sort_data_idx++){(general=$.extend({},sort_data.at(sort_data_idx))).position==battleposition&&2==general.element_type&&general.is_alive&&add_pos(temp_list,general.position),general=null}else if(28==priority_position)for(battleposition=1;6!=battleposition;++battleposition)for(sort_data_idx=0;sort_data_idx<sort_data.length;sort_data_idx++){(general=$.extend({},sort_data.at(sort_data_idx))).position==battleposition&&3==general.element_type&&general.is_alive&&add_pos(temp_list,general.position),general=null}else if(29==priority_position)for(battleposition=1;6!=battleposition;++battleposition)for(sort_data_idx=0;sort_data_idx<sort_data.length;sort_data_idx++){(general=$.extend({},sort_data.at(sort_data_idx))).position==battleposition&&4==general.element_type&&general.is_alive&&add_pos(temp_list,general.position),general=null}else if(30==priority_position)for(battleposition=1;6!=battleposition;++battleposition)for(sort_data_idx=0;sort_data_idx<sort_data.length;sort_data_idx++){(general=$.extend({},sort_data.at(sort_data_idx))).position==battleposition&&5==general.element_type&&general.is_alive&&add_pos(temp_list,general.position),general=null}else if(31==priority_position){for(sort_data_idx=0;sort_data_idx<sort_data.length;sort_data_idx++){(general=$.extend({},sort_data.at(sort_data_idx))).position!=position&&general.is_alive&&add_pos(temp_list,general.position),general=null}temp_list.shuffle()}else if(32==priority_position){sort_data=stable(sort_data,function(l,r){return l.attk_point<r.attk_point}.bind(this));for(sort_data_idx=0;sort_data_idx<sort_data.length;sort_data_idx++){var general;(general=$.extend({},sort_data.at(sort_data_idx))).position!=position&&general.is_alive&&add_pos(temp_list,general.position),general=null}}}return position==db.BattlePosition.Head?(add_pos(temp_list,db.BattlePosition.Head),add_pos(temp_list,db.BattlePosition.Body_1),add_pos(temp_list,db.BattlePosition.Body_2),add_pos(temp_list,db.BattlePosition.Tail_1),add_pos(temp_list,db.BattlePosition.Tail_2),targets=this.findTeamFormation(this,temp_list,target_count,!0)):position==db.BattlePosition.Body_1?(add_pos(temp_list,db.BattlePosition.Body_1),add_pos(temp_list,db.BattlePosition.Head),add_pos(temp_list,db.BattlePosition.Body_2),add_pos(temp_list,db.BattlePosition.Tail_1),add_pos(temp_list,db.BattlePosition.Tail_2),targets=this.findTeamFormation(this,temp_list,target_count,!0)):position==db.BattlePosition.Body_2?(add_pos(temp_list,db.BattlePosition.Body_2),add_pos(temp_list,db.BattlePosition.Head),add_pos(temp_list,db.BattlePosition.Body_1),add_pos(temp_list,db.BattlePosition.Tail_2),add_pos(temp_list,db.BattlePosition.Tail_1),targets=this.findTeamFormation(this,temp_list,target_count,!0)):position==db.BattlePosition.Tail_1?(add_pos(temp_list,db.BattlePosition.Body_1),add_pos(temp_list,db.BattlePosition.Head),add_pos(temp_list,db.BattlePosition.Body_2),add_pos(temp_list,db.BattlePosition.Tail_1),add_pos(temp_list,db.BattlePosition.Tail_2),targets=this.findTeamFormation(this,temp_list,target_count,!0)):position==db.BattlePosition.Tail_2&&(add_pos(temp_list,db.BattlePosition.Body_2),add_pos(temp_list,db.BattlePosition.Head),add_pos(temp_list,db.BattlePosition.Body_1),add_pos(temp_list,db.BattlePosition.Tail_2),add_pos(temp_list,db.BattlePosition.Tail_1),targets=this.findTeamFormation(this,temp_list,target_count,!0)),targets},findRandomTeamFormation:function(team,target_list,target_count){team.getAliveMemberCount();var count=target_count;0==count&&(count=5);for(var members=team.getTeamMembers(),form_list=[];form_list.length!=count;){var ran=parseInt(Math.random()*members.length);if(ran<members.length){var pos=(g=members[ran]).getBattlePosition();form_list.push(pos)}}for(var invisible_generals=new Array,i=0,len=members.length;i<len;i++){var g;(g=members[i]).findTransType(database.BattleEffectTrans.Invisibility,g.IsFriend())&&g.findTransType(database.BattleEffectTrans.Invincibility_Non_Alpha,g.IsFriend())&&invisible_generals.push_back(g)}if(0<invisible_generals.size()&&(0==target_count||1<target_count));if(0<count){for(i=0;i<form_list.size();i++){var p=form_list[i],t=this.findPositionGeneral(team,p);if(null!=t&&t.IsAlive()&&!t.IsFreezeCheck()&&!t.findTransType(database.BattleEffectTrans.Invisibility,t.IsFriend())&&!t.findTransType(database.BattleEffectTrans.Invincibility_Non_Alpha,t.IsFriend())&&(target_list.push_back(t),0==--count))break}if(0==target_list.length&&0<invisible_generals.size()){var func=function(pos){for(var found=0,found_is=!1,i=0;i<invisible_generals.size();i++){var gnrl=invisible_generals.at(i);if(found=i,gnrl.IsAlive()){if(gnrl.getBattlePosition()==pos){found_is=!0;break}found_is=!1;break}found_is=!0;break}return 1==found_is?found:null}.bind(this);for(i=0;i<form_list.size();i++){var gnrl=func(p=form_list.at(i));if(null!=gnrl&&(target_list.push(gnrl),0==--count))break}}}},add_pos:function(list,pos){list.find_obj(pos)||list.push_back(pos)},findEnemyTarget:function(base,target_count,priority_position){for(var target_enemy_list=[],position=base.getBattlePosition(),temp_list=new Array,idx=0;idx<base.m_durability_effects.length;idx++)base.m_durability_effects[idx].trans_type==database.BattleEffectTrans.Target_Count_Change_One&&(target_count=1);for(var members=this.m_target_team.getTeamMembers(),sort_data=[],i=0;i<members.length;i++){if((member=members[i]).IsAlive())member.findTransType(database.BattleEffectTrans.Provocation,member.IsFriend())&&this.add_pos(temp_list,member.getBattlePosition()),(sd={}).is_alive=member.IsAlive(),sd.position=member.getBattlePosition(),sd.max_life_point=member.getMaxHealthPoint(),sd.life_point=member.getCurrentLifePoint(),sd.attk_point=member.getAttackPoint(),sd.def_point=member.getDefencePoint(),sd.gnrl_id=member.getGeneral().general.gnrl_id,sd.service_type=member.getGeneral().general.arm_service_type,sd.element_type=member.getGeneral().general.element_type,sort_data.push_back(sd)}if(0!=priority_position&&cc.log(priority_position),1==priority_position)this.add_pos(temp_list,db.BattlePosition.Head);else if(2==priority_position||3==priority_position)position==db.BattlePosition.Body_2||position==db.BattlePosition.Tail_2?(this.add_pos(temp_list,db.BattlePosition.Body_2),this.add_pos(temp_list,db.BattlePosition.Body_1)):(this.add_pos(temp_list,db.BattlePosition.Body_1),this.add_pos(temp_list,db.BattlePosition.Body_2));else if(4==priority_position||5==priority_position)position==db.BattlePosition.Body_2||position==db.BattlePosition.Tail_2?(this.add_pos(temp_list,db.BattlePosition.Tail_2),this.add_pos(temp_list,db.BattlePosition.Tail_1)):(this.add_pos(temp_list,db.BattlePosition.Tail_1),this.add_pos(temp_list,db.BattlePosition.Tail_2));else if(6==priority_position)this.add_pos(temp_list,db.BattlePosition.Head),this.add_pos(temp_list,db.BattlePosition.Body_1),this.add_pos(temp_list,db.BattlePosition.Body_2),this.add_pos(temp_list,db.BattlePosition.Tail_1),this.add_pos(temp_list,db.BattlePosition.Tail_2),temp_list.shuffle();else if(7==priority_position)for(i=0;i<members.length;i++){var member;if((member=members[i]).getGeneral().is_zoom){this.add_pos(temp_list,member.getBattlePosition());break}}else if(8==priority_position){sort_data=stable(sort_data,function(l,r){return l.life_point/l.max_life_point<r.life_point/r.max_life_point}.bind(this));for(i=0;i<sort_data.length;i++){(sd=sort_data[i]).is_alive&&this.add_pos(temp_list,sd.position)}}else if(9==priority_position){sort_data=stable(sort_data,function(l,r){var l_p=l.life_point/l.max_life_point;return r.life_point/r.max_life_point<l_p}.bind(this));for(i=0;i<sort_data.length;i++){(sd=sort_data[i]).is_alive&&this.add_pos(temp_list,sd.position)}}else if(10==priority_position);else if(11==priority_position);else if(12==priority_position){sort_data=stable(sort_data,function(l,r){return l.attk_point<r.attk_point}.bind(this));for(i=0;i<sort_data.length;i++){(sd=sort_data[i]).is_alive&&this.add_pos(temp_list,sd.position)}}else if(13==priority_position){sort_data=stable(sort_data,function(l,r){return l.attk_point>r.attk_point}.bind(this));for(i=0;i<sort_data.length;i++){(sd=sort_data[i]).is_alive&&this.add_pos(temp_list,sd.position)}}else if(14==priority_position){sort_data=stable(sort_data,function(l,r){return l.def_point<r.def_point}.bind(this));for(i=0;i<sort_data.length;i++){(sd=sort_data[i]).is_alive&&this.add_pos(temp_list,sd.position)}}else if(15==priority_position){sort_data=stable(sort_data,function(l,r){return l.def_point>r.def_point}.bind(this));for(i=0;i<sort_data.length;i++){var sd;(sd=sort_data[i]).is_alive&&this.add_pos(temp_list,sd.position)}}else{if(16==priority_position)return void this.findRandomTeamFormation(this.m_target_team,targets,target_count);if(23==priority_position)for(var battleposition=1;6!=battleposition;++battleposition)for(i=0;i<sort_data.length;i++){(general=$.extend({},sort_data.at(i))).position==battleposition&&1==general.service_type&&general.is_alive&&this.add_pos(temp_list,general.position),general=null}else if(24==priority_position)for(battleposition=1;6!=battleposition;++battleposition)for(i=0;i<sort_data.length;i++){(general=$.extend({},sort_data.at(i))).position==battleposition&&2==general.service_type&&general.is_alive&&this.add_pos(temp_list,general.position),general=null}else if(25==priority_position)for(battleposition=1;6!=battleposition;++battleposition)for(i=0;i<sort_data.length;i++){(general=$.extend({},sort_data[i])).position==battleposition&&3==general.service_type&&general.is_alive&&this.add_pos(temp_list,general.position),general=null}else if(26==priority_position)for(battleposition=1;6!=battleposition;++battleposition)for(i=0;i<sort_data.length;i++){(general=$.extend({},sort_data[i])).position==battleposition&&1==general.element_type&&general.is_alive&&this.add_pos(temp_list,general.position),general=null}else if(27==priority_position)for(battleposition=1;6!=battleposition;++battleposition)for(i=0;i<sort_data.length;i++){(general=$.extend({},sort_data[i])).position==battleposition&&2==general.element_type&&general.is_alive&&this.add_pos(temp_list,general.position),general=null}else if(28==priority_position)for(battleposition=1;6!=battleposition;++battleposition)for(i=0;i<sort_data.length;i++){(general=$.extend({},sort_data[i])).position==battleposition&&3==general.element_type&&general.is_alive&&this.add_pos(temp_list,general.position),general=null}else if(29==priority_position)for(battleposition=1;6!=battleposition;++battleposition)for(i=0;i<sort_data.length;i++){(general=$.extend({},sort_data[i])).position==battleposition&&4==general.element_type&&general.is_alive&&this.add_pos(temp_list,general.position),general=null}else if(30==priority_position)for(battleposition=1;6!=battleposition;++battleposition)for(i=0;i<sort_data.length;i++){var general;(general=$.extend({},sort_data[i])).position==battleposition&&5==general.element_type&&general.is_alive&&this.add_pos(temp_list,general.position),general=null}}return position==db.BattlePosition.Head?(0==this.add_pos(temp_list,db.BattlePosition.Head)&&temp_list.push_back(db.BattlePosition.Head),0==this.add_pos(temp_list,db.BattlePosition.Body_1)&&temp_list.push_back(db.BattlePosition.Body_1),0==this.add_pos(temp_list,db.BattlePosition.Body_2)&&temp_list.push_back(db.BattlePosition.Body_2),0==this.add_pos(temp_list,db.BattlePosition.Tail_1)&&temp_list.push_back(db.BattlePosition.Tail_1),0==this.add_pos(temp_list,db.BattlePosition.Tail_2)&&temp_list.push_back(db.BattlePosition.Tail_2),target_enemy_list=this.findTeamFormation(this.m_target_team,temp_list,target_count,!1)):position==db.BattlePosition.Body_1?(0==this.add_pos(temp_list,db.BattlePosition.Body_1)&&temp_list.push_back(db.BattlePosition.Body_1),0==this.add_pos(temp_list,db.BattlePosition.Head)&&temp_list.push_back(db.BattlePosition.Head),0==this.add_pos(temp_list,db.BattlePosition.Body_2)&&temp_list.push_back(db.BattlePosition.Body_2),0==this.add_pos(temp_list,db.BattlePosition.Tail_1)&&temp_list.push_back(db.BattlePosition.Tail_1),0==this.add_pos(temp_list,db.BattlePosition.Tail_2)&&temp_list.push_back(db.BattlePosition.Tail_2),target_enemy_list=this.findTeamFormation(this.m_target_team,temp_list,target_count,!1)):position==db.BattlePosition.Body_2?(0==this.add_pos(temp_list,db.BattlePosition.Body_2)&&temp_list.push_back(db.BattlePosition.Body_2),0==this.add_pos(temp_list,db.BattlePosition.Head)&&temp_list.push_back(db.BattlePosition.Head),0==this.add_pos(temp_list,db.BattlePosition.Body_1)&&temp_list.push_back(db.BattlePosition.Body_1),0==this.add_pos(temp_list,db.BattlePosition.Tail_2)&&temp_list.push_back(db.BattlePosition.Tail_2),0==this.add_pos(temp_list,db.BattlePosition.Tail_1)&&temp_list.push_back(db.BattlePosition.Tail_1),target_enemy_list=this.findTeamFormation(this.m_target_team,temp_list,target_count,!1)):position==db.BattlePosition.Tail_1?(0==this.add_pos(temp_list,db.BattlePosition.Body_1)&&temp_list.push_back(db.BattlePosition.Body_1),0==this.add_pos(temp_list,db.BattlePosition.Head)&&temp_list.push_back(db.BattlePosition.Head),0==this.add_pos(temp_list,db.BattlePosition.Body_2)&&temp_list.push_back(db.BattlePosition.Body_2),0==this.add_pos(temp_list,db.BattlePosition.Tail_1)&&temp_list.push_back(db.BattlePosition.Tail_1),0==this.add_pos(temp_list,db.BattlePosition.Tail_2)&&temp_list.push_back(db.BattlePosition.Tail_2),target_enemy_list=this.findTeamFormation(this.m_target_team,temp_list,target_count,!1)):position==db.BattlePosition.Tail_2&&(0==this.add_pos(temp_list,db.BattlePosition.Body_2)&&temp_list.push_back(db.BattlePosition.Body_2),0==this.add_pos(temp_list,db.BattlePosition.Head)&&temp_list.push_back(db.BattlePosition.Head),0==this.add_pos(temp_list,db.BattlePosition.Body_1)&&temp_list.push_back(db.BattlePosition.Body_1),0==this.add_pos(temp_list,db.BattlePosition.Tail_2)&&temp_list.push_back(db.BattlePosition.Tail_2),0==this.add_pos(temp_list,db.BattlePosition.Tail_1)&&temp_list.push_back(db.BattlePosition.Tail_1),target_enemy_list=this.findTeamFormation(this.m_target_team,temp_list,target_count,!1)),target_enemy_list},findPositionGeneral:function(team,pos){for(var _team=team.getTeamMembers(),i=0;i<_team.length;i++){var e=_team[i];if(e.IsAlive()&&e.getBattlePosition()==pos)return e}return null},findTeamFormation:function(team,form_list,target_count,is_our){null==is_our&&(is_our=!1);var is_ourteam=is_our,target_list=[],alive_enemys=team.getAliveMemberCount(),count=target_count;0==count?count=alive_enemys:alive_enemys<count&&(count=alive_enemys);for(var invisible_generals=new Array,members=team.getTeamMembers(),i=0,len=members.length;i<len;i++){var member=members[i];member.findTransType(database.BattleEffectTrans.Invisibility,member.IsFriend())&&member.findTransType(database.BattleEffectTrans.Invincibility_Non_Alpha,member.IsFriend())&&invisible_generals.push_back(member)}if(0<invisible_generals.size()&&(0==target_count||1<target_count));if(0<count){for(i=0;i<form_list.size();i++){var p=form_list.at(i),t=this.findPositionGeneral(team,p);if(is_ourteam){if(null!=t&&t.IsAlive()&&!t.IsFreezeCheck())if(-1==target_list.indexOf(t)&&(target_list.push(t),0==--count))break}else if(null!=t&&t.IsAlive()&&!t.IsFreezeCheck())if(!t.findTransType(database.BattleEffectTrans.Invisibility,t.IsFriend())&&!t.findTransType(database.BattleEffectTrans.Invincibility_Non_Alpha,t.IsFriend()))if(-1==target_list.indexOf(t)&&(target_list.push(t),0==--count))break}if(0<count&&(0==target_count||alive_enemys<=target_count&&1<target_count)&&0<invisible_generals.size()){var func=function(pos){for(var found_is=!1,i=0;i<invisible_generals.size();i++){var gnrl=invisible_generals.at(i);if(i,gnrl.IsAlive()){if(gnrl.getBattlePosition()==pos){found_is=!0;break}found_is=!1;break}found_is=!0;break}return 1==found_is?gnrl:null}.bind(this);for(i=0;i<form_list.size();i++){var gnrl=func(p=form_list.at(i));if(null!=gnrl&&(target_list.push(gnrl),0==--count))break}}}return target_list},setSkillCutinShow:function(){},setAutoSkill:function(isAuto){for(var i=0;i<this.m_team_members.length;i++){this.m_team_members[i].setAutoSkill(isAuto)}},insertFriendGeneral:function(){if(null!=this.m_friend_general&&!this.m_is_inserted_friend){for(var func=function(pos){for(var found_is=!1,i=0;i<this.m_team_members.length;i++){var gnrl=this.m_team_members[i];if(i,gnrl.IsAlive()&&gnrl.getBattlePosition()==pos){found_is=!0;break}}return 1==found_is}.bind(this),i=1;i<=5;i++){var pos=this.retBattlePosition(i);if(!func(pos)){var position=this.m_position_list.at(i-1);if(this.m_friend_general.setGeneralPosition(cc.p(position[0],position[1])),this.m_friend_general.m_battle_general.position=pos,this.m_gnrl_parent.addChild(this.m_friend_general),this.m_friend_general.setAutoSkill(GameDefault.getInstance().getUserAutoSkill()),this.m_friend_general.setGeneralState(BattleGeneral_GeneralState.Find),this.m_friend_general.playAction(ActionType.Attack_Idle),this.m_team_type==BattleGeneral_TeamType.Left)for(var right_team=this.m_target_team.getTeamMembers(),member_idx=0;member_idx<right_team.length;member_idx++)right_team[member_idx].getGeneral().is_zoom&&right_team[member_idx].playVoicePart(voice_npc_boss_partner_general_appear);break}}this.m_friend_general.setGeneralTimeScale(this.m_cur_time_scale),this.m_friend_general.firstEnableSkillCooltime(),this.m_team_members.push(this.m_friend_general),this.m_friend_general.calcGeneralStat(),this.m_is_inserted_friend=!0,BattleMissionTaskManager._getInstance().setFriendCall()}},getFriendLeaderSkillTransResistBufPoint:function(trans_type,general){var point=0;return point},getFriendLeaderSkillBuf:function(stat_type,general){var point=0;return point},getBattleFormationBufPoint:function(position,stat_type,general){for(var point=0,service=GeneralService.getInstance(),keys=this.m_battle_formations.keys(),i=0;i<keys.length;i++){var f=this.m_battle_formations.at(keys[i]),b_stat_type=f.combo_stat,b_pos=f.position_type;b_stat_type==stat_type&&b_pos==position&&(point+=service.getBattleFormationValue(f.formation_id))}return point},getLeaderSkillTransResistBufPoint:function(trans_type,general){for(var point=0,m=MasterManager.getInstance(),i=0;i<this.m_team_members.length;i++){var gnrl=this.m_team_members[i].getGeneral();if(gnrl.is_zoom){if(0==gnrl.general.leader_skill_id||99999==gnrl.general.leader_skill_id)continue;var is_enable_leader_skill=!1,leader=m.get_LeaderSkill(gnrl.general.leader_skill_id),trans_type3=leader.stat_type3;leader.leader_skill_type==LEADER_SKILL_TYPE_ALL?is_enable_leader_skill=!0:leader.leader_skill_type==LEADER_SKILL_TYPE_STATE?leader.leader_skill_value==general.general.state_type&&(is_enable_leader_skill=!0):leader.leader_skill_type==LEADER_SKILL_TYPE_FORCE_TYPE?leader.leader_skill_value==general.general.arm_service_type&&(is_enable_leader_skill=!0):leader.leader_skill_type==LEADER_SKILL_TYPE_FIGHT_TYPE?leader.leader_skill_value==general.general.fight_type&&(is_enable_leader_skill=!0):leader.leader_skill_type==LEADER_SKILL_TYPE_CLASS_TYPE?leader.leader_skill_value==general.general.gnrl_class&&(is_enable_leader_skill=!0):leader.leader_skill_type==LEADER_SKILL_TYPE_RARE_TYPE?leader.leader_skill_value==general.general.rare_type&&(is_enable_leader_skill=!0):leader.leader_skill_type==LEADER_SKILL_TYPE_ELEMENT_TYPE&&leader.leader_skill_value==general.general.element_type&&(is_enable_leader_skill=!0),is_enable_leader_skill&&(trans_type3!=trans_type&&trans_type3!=database.BattleEffectTrans.Resistance_All_Trans||trans_type!=database.BattleEffectTrans.Stun&&trans_type!=database.BattleEffectTrans.Silence&&trans_type!=database.BattleEffectTrans.Poison&&trans_type!=database.BattleEffectTrans.Freeze&&trans_type!=database.BattleEffectTrans.After_Recv_Damage_Inc_Rate&&trans_type!=database.BattleEffectTrans.Damage_Reduce&&trans_type!=database.BattleEffectTrans.New_Poison_Dmg_Rate&&trans_type!=database.BattleEffectTrans.Wound_Obstruct_Heal&&trans_type!=database.BattleEffectTrans.Blind_Darkness||(point+=leader.stat_value3));break}}return point},initCheckFriendSpecialLeaderSkillBuf:function(){if(null!=this.m_friend_general){MasterManager.getInstance();for(var gnrl=this.m_friend_general.getGeneral(),leader_skills=gnrl.general.special_leader_skill_id.split(","),idx=0;idx<leader_skills.length;idx++){var leader_skill_id=1*leader_skills[idx];if(0!=leader_skill_id&&99999!=leader_skill_id){var ls={onetime_effects:[],durability_effects:[]};this.makeSpecialLeaderSkill(leader_skill_id,ls,gnrl.gnrl_id),this.m_friend_special_leader_skill.push_back(ls),ls.enable_leader_skill=!0}}}},makeSpecialLeaderSkill:function(leader_skill_id,leader_skill,gnrl_id){null==gnrl_id&&(gnrl_id=0);var m=MasterManager.getInstance();leader_skill.leader_skill_id=leader_skill_id,leader_skill.leader_skill=m.get_SpecialLeaderSkill(leader_skill_id);var service=BattleService.getInstance();if(""!=leader_skill.leader_skill.onetime_effect&&"99999"!=leader_skill.leader_skill.onetime_effect)for(var list=leader_skill.leader_skill.onetime_effect.split(","),i=0;i<list.size();i++){var ot_id=list.at(i),one=m.get_OnetimeEffect(ot_id);if(null!=one){var onetime={};service.convertOneTimeEffect(one,onetime),onetime.gnrl_id=gnrl_id,leader_skill.onetime_effects.push_back(onetime)}}if(""!=leader_skill.leader_skill.durability_effect&&"99999"!=leader_skill.leader_skill.durability_effect)for(list=leader_skill.leader_skill.durability_effect.split(","),i=0;i<list.size();i++){var dur_id=list.at(i),dur=m.get_DurabilityEffect(dur_id);if(null!=dur){var dur_eff={};service.convertDurabilityEffect(dur,dur_eff),dur_eff.gnrl_id=gnrl_id,leader_skill.durability_effects.push_back(dur_eff)}}},getFriendSpecialLeaderSkillBufPoint:function(stat_type,general){var point=0;return point},getFriendSpecialLeaderSkillTransResistBufPoint:function(trans_type,general){var point=0;return point},func_check_leader_skill:function(cond_type,target_type,target_count){for(var i=0;i<this.m_team_members.length;i++){var g=this.m_team_members[i];if(!g.IsFriend()){var gnrl=g.getGeneral();switch(this.m_special_leader_skill.cond_type1){case LEADER_SKILL_TYPE_STATE:gnrl.general.state_type==target_type&&target_count--;break;case LEADER_SKILL_TYPE_FORCE_TYPE:gnrl.general.arm_service_type==target_type&&target_count--;break;case LEADER_SKILL_TYPE_RARE_TYPE:gnrl.general.rare_type==target_type&&target_count--;break;case LEADER_SKILL_TYPE_CLASS_TYPE:gnrl.general.gnrl_class==target_type&&target_count--;break;case LEADER_SKILL_TYPE_FIGHT_TYPE:gnrl.general.fight_type==target_type&&target_count--;break;case LEADER_SKILL_TYPE_ELEMENT_TYPE:gnrl.general.element_type==target_type&&target_count--;break;case LEADER_SKILL_TYPE_GNRL_GROUP:gnrl.general.gnrl_group==target_type&&target_count--}}}return target_count<=0},initCheckSpecialLeaderSkillBuf:function(){for(var is_exist_leader_skill=!1,len=(MasterManager.getInstance(),this.m_team_members.length),i=0;i<len;i++){if((gnrl=(g=this.m_team_members[i]).getGeneral()).is_zoom){gnrl.general.special_leader_skill_id=gnrl.general.special_leader_skill_id+"";for(var leader_skills=gnrl.general.special_leader_skill_id.split(","),idx=0;idx<leader_skills.length;idx++){var leader_skill_id=1*leader_skills[idx];if(0!=leader_skill_id&&99999!=leader_skill_id){var ls=new database.BattleSpecialLeaderSkill;this.makeSpecialLeaderSkill(leader_skill_id,ls,gnrl.gnrl_id),this.m_special_leader_skill.push_back(ls),is_exist_leader_skill=!0,this.set_Reader_Gnrl_Group_id(gnrl.general.gnrl_group)}}break}}if(is_exist_leader_skill)for(var func_check_leader_skill=function(cond_type,target_type,target_count){for(var idx=0;idx<this.m_team_members.length;idx++){var g=this.m_team_members[idx];if(!g.IsFriend()){var gnrl=g.getGeneral();switch(cond_type){case LEADER_SKILL_TYPE_STATE:gnrl.general.state_type==target_type&&target_count--;break;case LEADER_SKILL_TYPE_FORCE_TYPE:gnrl.general.arm_service_type==target_type&&target_count--;break;case LEADER_SKILL_TYPE_RARE_TYPE:gnrl.general.rare_type==target_type&&target_count--;break;case LEADER_SKILL_TYPE_CLASS_TYPE:gnrl.general.gnrl_class==target_type&&target_count--;break;case LEADER_SKILL_TYPE_FIGHT_TYPE:gnrl.general.fight_type==target_type&&target_count--;break;case LEADER_SKILL_TYPE_ELEMENT_TYPE:gnrl.general.element_type==target_type&&target_count--;break;case LEADER_SKILL_TYPE_GNRL_GROUP:gnrl.general.gnrl_group==target_type&&target_count--}}}return target_count<=0}.bind(this),jdx=0;jdx<this.m_special_leader_skill.length;jdx++){var leader_skill=this.m_special_leader_skill[jdx];if(leader_skill.enable_leader_skill=!0,0==leader_skill.leader_skill.leader_skill_multiple_type)if(0<leader_skill.leader_skill.cond_type1){if(0<leader_skill.leader_skill.cond_type1){var cond_type=leader_skill.leader_skill.cond_type1,target_count=leader_skill.leader_skill.target_need_count1;func_check_leader_skill(cond_type,target_type=leader_skill.leader_skill.target_type1,target_count)||(leader_skill.enable_leader_skill=!1)}if(0<leader_skill.leader_skill.cond_type2){cond_type=leader_skill.leader_skill.cond_type2,target_count=leader_skill.leader_skill.target_need_count2;func_check_leader_skill(cond_type,target_type=leader_skill.leader_skill.target_type2,target_count)||(leader_skill.enable_leader_skill=!1)}if(0<leader_skill.leader_skill.cond_type3){cond_type=leader_skill.leader_skill.cond_type3,target_count=leader_skill.leader_skill.target_need_count3;func_check_leader_skill(cond_type,target_type=leader_skill.leader_skill.target_type3,target_count)||(leader_skill.enable_leader_skill=!1)}if(0<leader_skill.leader_skill.cond_type4){cond_type=leader_skill.leader_skill.cond_type4,target_count=leader_skill.leader_skill.target_need_count4;func_check_leader_skill(cond_type,target_type=leader_skill.leader_skill.target_type4,target_count)||(leader_skill.enable_leader_skill=!1)}if(0<leader_skill.leader_skill.cond_type5){cond_type=leader_skill.leader_skill.cond_type5,target_count=leader_skill.leader_skill.target_need_count5;func_check_leader_skill(cond_type,target_type=leader_skill.leader_skill.target_type5,target_count)||(leader_skill.enable_leader_skill=!1)}}else 0==leader_skill.leader_skill.cond_type1&&0==leader_skill.leader_skill.cond_type2&&0==leader_skill.leader_skill.cond_type3&&0==leader_skill.leader_skill.cond_type4&&0==leader_skill.leader_skill.cond_type5?leader_skill.enable_leader_skill=!0:leader_skill.enable_leader_skill=!1;else if(0<leader_skill.leader_skill.cond_type1){cond_type=leader_skill.leader_skill.cond_type1;for(var target_type=leader_skill.leader_skill.target_type1,team_idx=0;team_idx<this.m_team_members.length;team_idx++){var g;if(!(g=this.m_team_members[team_idx]).IsFriend()){var gnrl=g.getGeneral();switch(cond_type){case LEADER_SKILL_TYPE_STATE:gnrl.general.state_type==target_type&&null!=leader_skill.multiple_count&&leader_skill.multiple_count++;break;case LEADER_SKILL_TYPE_FORCE_TYPE:gnrl.general.arm_service_type==target_type&&null!=leader_skill.multiple_count&&leader_skill.multiple_count++;break;case LEADER_SKILL_TYPE_RARE_TYPE:gnrl.general.rare_type==target_type&&null!=leader_skill.multiple_count&&leader_skill.multiple_count++;break;case LEADER_SKILL_TYPE_CLASS_TYPE:gnrl.general.gnrl_class==target_type&&null!=leader_skill.multiple_count&&leader_skill.multiple_count++;break;case LEADER_SKILL_TYPE_FIGHT_TYPE:gnrl.general.fight_type==target_type&&null!=leader_skill.multiple_count&&leader_skill.multiple_count++;break;case LEADER_SKILL_TYPE_ELEMENT_TYPE:gnrl.general.element_type==target_type&&null!=leader_skill.multiple_count&&leader_skill.multiple_count++;break;case LEADER_SKILL_TYPE_GNRL_GROUP:gnrl.general.gnrl_group==target_type&&null!=leader_skill.multiple_count&&leader_skill.multiple_count++}}}0==leader_skill.multiple_count&&(leader_skill.enable_leader_skill=!1)}else 0==leader_skill.leader_skill.cond_type1&&0==leader_skill.leader_skill.cond_type2&&0==leader_skill.leader_skill.cond_type3&&0==leader_skill.leader_skill.cond_type4&&0==leader_skill.leader_skill.cond_type5?leader_skill.enable_leader_skill=!0:leader_skill.enable_leader_skill=!1}},getTargetTeamSpecialLeaderSkillBufPoint:function(stat_type,general){return this.m_target_team.getSpecialLeaderSkillBufPoint(stat_type,general)},IsSpecialLeaderSkillExecTargetCheck:function(self_enemy,exec_target_type,exec_target_value,gnrl){if(self_enemy==database.BattleSelfOther.Self)switch(exec_target_type){case LEADER_SKILL_TYPE_ALL:return!0;case LEADER_SKILL_TYPE_STATE:return gnrl.general.state_type==exec_target_value;case LEADER_SKILL_TYPE_FORCE_TYPE:return gnrl.general.arm_service_type==exec_target_value;case LEADER_SKILL_TYPE_RARE_TYPE:return gnrl.general.rare_type==exec_target_value;case LEADER_SKILL_TYPE_CLASS_TYPE:return gnrl.general.gnrl_class==exec_target_value;case LEADER_SKILL_TYPE_FIGHT_TYPE:return gnrl.general.fight_type==exec_target_value;case LEADER_SKILL_TYPE_ELEMENT_TYPE:return gnrl.general.element_type==exec_target_value;case LEADER_SKILL_TYPE_GNRL_GROUP:return gnrl.general.gnrl_group==exec_target_value}else switch(exec_target_type){case LEADER_SKILL_TYPE_ALL:return!0;case LEADER_SKILL_TYPE_STATE:return gnrl.general.state_type==exec_target_value;case LEADER_SKILL_TYPE_FORCE_TYPE:return gnrl.general.arm_service_type==exec_target_value;case LEADER_SKILL_TYPE_RARE_TYPE:return gnrl.general.rare_type==exec_target_value;case LEADER_SKILL_TYPE_CLASS_TYPE:return gnrl.general.gnrl_class==exec_target_value;case LEADER_SKILL_TYPE_FIGHT_TYPE:return gnrl.general.fight_type==exec_target_value;case LEADER_SKILL_TYPE_ELEMENT_TYPE:return gnrl.general.element_type==exec_target_value;case LEADER_SKILL_TYPE_GNRL_GROUP:return gnrl.general.gnrl_group==exec_target_value}return!1},getSpecialLeaderSkillOneTimeEffects:function(invoke_type,general,list){MasterManager.getInstance();for(var ldx=0;ldx<this.m_special_leader_skill.length;ldx++){var leader_skill=this.m_special_leader_skill[ldx];if(leader_skill.enable_leader_skill){var self_enemy=leader_skill.leader_skill.enemy_me_type,exec_target_type=leader_skill.leader_skill.exec_target_type,exec_target_value=leader_skill.leader_skill.exec_target_value;if(this.IsSpecialLeaderSkillExecTargetCheck(self_enemy,exec_target_type,exec_target_value,general)){var invoke_type_one=invoke_type;if(leader_skill.leader_skill.invoke_type_one==invoke_type_one)for(var jdx=0;jdx<leader_skill.onetime_effects.length;jdx++)list.push(leader_skill.onetime_effects[jdx])}}}},getSpecialLeaderSkillDurabilityEffects:function(invoke_type,general,list){MasterManager.getInstance();for(var ldx=0;ldx<this.m_special_leader_skill.length;ldx++){var leader_skill=this.m_special_leader_skill[ldx];if(leader_skill.enable_leader_skill){var self_enemy=leader_skill.leader_skill.enemy_me_type,exec_target_type=leader_skill.leader_skill.exec_target_type,exec_target_value=leader_skill.leader_skill.exec_target_value;if(this.IsSpecialLeaderSkillExecTargetCheck(self_enemy,exec_target_type,exec_target_value,general)){var invoke_type_dur=invoke_type;if(leader_skill.leader_skill.invoke_type_dur==invoke_type_dur)for(var jdx=0;jdx<leader_skill.durability_effects.length;jdx++)list.push(leader_skill.durability_effects[jdx])}}}},getSpecialLeaderSkillBufPoint:function(stat_type,general){for(var point=0,idx=0;idx<this.m_special_leader_skill.length;idx++){var leader_skill=this.m_special_leader_skill[idx];if(leader_skill.enable_leader_skill){var self_enemy=leader_skill.leader_skill.enemy_me_type,exec_target_type=leader_skill.leader_skill.exec_target_type,exec_target_value=leader_skill.leader_skill.exec_target_value;if(this.IsSpecialLeaderSkillExecTargetCheck(self_enemy,exec_target_type,exec_target_value,general)){var stat_type1=leader_skill.leader_skill.stat_type1,stat_type2=leader_skill.leader_skill.stat_type2;stat_type1==stat_type?0==leader_skill.leader_skill.leader_skill_multiple_type?point+=leader_skill.leader_skill.stat_value1:point+=leader_skill.leader_skill.stat_value1*leader_skill.multiple_count:stat_type2==stat_type&&(0==leader_skill.leader_skill.leader_skill_multiple_type?point+=leader_skill.leader_skill.stat_value2:point+=leader_skill.leader_skill.stat_value2*leader_skill.multiple_count)}}}return point},getSpecialLeaderSkillTransResistBufPoint:function(trans_type,general){for(var point=0,idx=0;idx<this.m_special_leader_skill.length;idx++){var leader_skill=this.m_special_leader_skill[idx];if(leader_skill.enable_leader_skill){var self_enemy=leader_skill.leader_skill.enemy_me_type,exec_target_type=leader_skill.leader_skill.exec_target_type,exec_target_value=leader_skill.leader_skill.exec_target_value;if(this.IsSpecialLeaderSkillExecTargetCheck(self_enemy,exec_target_type,exec_target_value,general)){var trans_type3=leader_skill.leader_skill.trans_type;trans_type3!=trans_type&&trans_type3!=database.BattleEffectTrans.Resistance_All_Trans||trans_type!=database.BattleEffectTrans.Stun&&trans_type!=database.BattleEffectTrans.Silence&&trans_type!=database.BattleEffectTrans.Poison&&trans_type!=database.BattleEffectTrans.Freeze&&trans_type!=database.BattleEffectTrans.After_Recv_Damage_Inc_Rate&&trans_type!=database.BattleEffectTrans.Damage_Reduce&&trans_type!=database.BattleEffectTrans.New_Poison_Dmg_Rate&&trans_type!=database.BattleEffectTrans.Wound_Obstruct_Heal&&trans_type!=database.BattleEffectTrans.Blind_Darkness||(0==leader_skill.leader_skill.leader_skill_multiple_type?point+=leader_skill.leader_skill.trans_value:point+=leader_skill.leader_skill.trans_value*leader_skill.multiple_count)}}}return point},getLeaderSkillBufPoint:function(stat_type,general){for(var point=0,m=MasterManager.getInstance(),i=0;i<this.m_team_members.length;i++){var gnrl=this.m_team_members[i].getGeneral();if(gnrl.is_zoom){if(0==gnrl.general.leader_skill_id||99999==gnrl.general.leader_skill_id)continue;var is_enable_leader_skill=!1,leader=m.get_LeaderSkill(gnrl.general.leader_skill_id),stat_type1=leader.stat_type1,stat_type2=leader.stat_type2;leader.leader_skill_type==LEADER_SKILL_TYPE_ALL?is_enable_leader_skill=!0:leader.leader_skill_type==LEADER_SKILL_TYPE_STATE?leader.leader_skill_value==general.general.state_type&&(is_enable_leader_skill=!0):leader.leader_skill_type==LEADER_SKILL_TYPE_FORCE_TYPE?leader.leader_skill_value==general.general.arm_service_type&&(is_enable_leader_skill=!0):leader.leader_skill_type==LEADER_SKILL_TYPE_FIGHT_TYPE?leader.leader_skill_value==general.general.fight_type&&(is_enable_leader_skill=!0):leader.leader_skill_type==LEADER_SKILL_TYPE_CLASS_TYPE?leader.leader_skill_value==general.general.gnrl_class&&(is_enable_leader_skill=!0):leader.leader_skill_type==LEADER_SKILL_TYPE_RARE_TYPE?leader.leader_skill_value==general.general.rare_type&&(is_enable_leader_skill=!0):leader.leader_skill_type==LEADER_SKILL_TYPE_ELEMENT_TYPE&&leader.leader_skill_value==general.general.element_type&&(is_enable_leader_skill=!0),is_enable_leader_skill&&(stat_type1==stat_type?point+=leader.stat_value1:stat_type2==stat_type&&(point+=leader.stat_value2));break}}return point},getPassiveSkillBufPoint:function(stat_type,general){for(var point=0,i=(MasterManager.getInstance(),0);i<this.m_team_members.length;i++)for(var is_passive_enable=!1,gnrl=this.m_team_members[i].getGeneral(),j=0;j<gnrl.passive_skill.length;j++){var p=gnrl.passive_skill[j],enemy_me_type=p.enemy_me_type,me_other_type=p.me_other_type,stat_type1=p.stat_type1,stat_type2=p.stat_type2,stat_type3=p.stat_type3;enemy_me_type==database.BattleSelfOther.Self&&(me_other_type==database.BattleSelfOther.Self?gnrl.gnrl_id==general.gnrl_id&&gnrl.gnrl_num==general.gnrl_num&&(is_passive_enable=!0):me_other_type==database.BattleSelfOther.Other&&(is_passive_enable=!0)),is_passive_enable&&(stat_type1==stat_type?point+=p.stat_value1:stat_type2==stat_type?point+=p.stat_value2:stat_type3==stat_type&&(point+=p.stat_value3))}return point},getTargetTeamPassiveSkillDebufPoint:function(stat_type){for(var point=0,team_member=(MasterManager.getInstance(),this.m_target_team.getTeamMembers()),i=0;i<team_member.length;i++)for(var is_passive_enable=!1,gnrl=team_member[i].getGeneral(),j=0;j<gnrl.passive_skill.length;j++){var p=gnrl.passive_skill[j],enemy_me_type=p.enemy_me_type,me_other_type=p.me_other_type,stat_type1=p.stat_type1,stat_type2=p.stat_type2,stat_type3=p.stat_type3;enemy_me_type==database.BattleSelfOther.Other&&me_other_type==database.BattleSelfOther.Other&&(is_passive_enable=!0),is_passive_enable&&(database.BattleChainStatType.ChainStatType_Def_Rate,stat_type1==stat_type?point+=p.stat_value1:stat_type2==stat_type?point+=p.stat_value2:stat_type3==stat_type&&(point+=p.stat_value3))}return point},setBattleTimeScale:function(time_scale){this.m_cur_time_scale=time_scale;for(var i=0,len=this.m_team_members.length;i<len;i++)this.m_team_members[i].setGeneralTimeScale(time_scale)},battleContinue:function(){var context=BattleContext._getInstance();if(this.m_team_type==BattleGeneral_TeamType.Left){for(var i=0;i<this.m_team_members.length;i++){(g=this.m_team_members[i]).battleContinue(),g.appearGeneral(),g.setOpacity(255),g.setVisible(!0),g.m_battle_general.m_Reborn_count=0,g.m_battle_general.m_Is_Reborn_Active_Max_Charge=!1}if(null!=this.m_friend_general){if(this.m_is_inserted_friend){this.m_is_inserted_friend=!1;var found=this.m_team_members.indexOf(this.m_friend_general);-1!=found&&this.m_team_members.splice(found,1),null!=this.m_friend_general.getParent()&&this.m_friend_general.removeFromParent(),BattleMissionTaskManager._getInstance().clearFriendCall()}var is_first_enable_skill_cooltime=this.m_friend_general.m_is_first_enable_skill_cooltime;this.m_friend_general=new BattleGeneral(0);var gnrl=$.extend({},context.getFriendPartnerGeneral());this.m_friend_general.lazyInitialize(gnrl,this.m_team_type),(this.m_friend_general._findEnemyTarget=this).m_friend_general.setMyTeamManager(this),this.m_friend_general.retain(),this.m_friend_general.setFriend(!0),this.m_friend_general._cbEventListenerFieldMng=this._generalEventListenerForFieldMng,this.m_friend_general._addBattleFxNode=this._generalAddBattleFxNode,(this.m_friend_general._req_team_cooltime=this).m_friend_general.friend_id=context.getFriendID(),this.m_friend_general.m_is_first_enable_skill_cooltime=is_first_enable_skill_cooltime;var m=MasterManager.getInstance();this.m_friend_effect=m.get_FriendEffect(gnrl.general.friend_num),BattleMissionTaskManager._getInstance().setFriendBuf()}}else if(this.m_team_type==BattleGeneral_TeamType.Right)for(i=0;i<this.m_team_members.length;i++){var g;(g=this.m_team_members[i]).battleContinue()}},battleClearTeamDisplay:function(){cc.log("Debug TeamMng battleClearTeamDisplay");BattleGeneral_GeneralState.None;for(var i=0,len=this.m_team_members.length;i<len;i++){var hero=this.m_team_members[i];if(hero.getCurrentState()<=BattleGeneral_GeneralState.Death_Ready){var fade=cc.fadeOut(.3);this.runAction(fade),hero.setGeneralState(BattleGeneral_GeneralState.Death),0}}},pauseTeam:function(){for(var i=0,len=this.m_team_members.length;i<len;i++){this.m_team_members[i].allPause()}},resumeTeam:function(){for(var i=0,len=this.m_team_members.length;i<len;i++){this.m_team_members[i].allResume()}},skillCutPauseTeam:function(gnrl){for(var i=0,len=this.m_team_members.length;i<len;i++){var m=this.m_team_members[i];gnrl==m?(m.focusBegin(),m.setPlaySkill(!0)):m.unfocusBegin(!0)}},skillCutResumeTeam:function(gnrl){gnrl.focusEnd()},skillEndResumeTeam:function(gnrl){for(var i=0,len=this.m_team_members.length;i<len;i++){var m=this.m_team_members[i];gnrl==m?m.setPlaySkill(!1):(m.unfocusEnd(),m.checkTransShader())}},requestTeamCoolTime:function(gnrl){for(var i=0,len=this.m_team_members.length;i<len;i++){var g=this.m_team_members[i];g!=gnrl&&g.teamSkillCooltime()}},IsPreparedBackcourt:function(){for(var is_prepared=!0,i=0;i<this.m_team_members.length;i++){var g=this.m_team_members[i];if(g.IsAlive()&&(g.IsAnimationPause()&&(g.m_focus_state==FOCUS_STATE.UNFOCUS?g.unfocusEnd():g.generalResume()),g.m_cur_state<BattleGeneral_GeneralState.Wait&&g.is_reserved_backcourt)){is_prepared=!1;break}}return is_prepared},voiceLeader:function(){for(var i=0;i<this.m_team_members.length;i++){var member=this.m_team_members[i];if(this.m_team_type==BattleGeneral_TeamType.Left){if(member.getGeneral().is_zoom){var ref={};(voice=MasterTable.getInstance().get_Voice(member.getGeneral().general.gnrl_id,voice_battle_init_leader,ref).voice)&&""!=voice&&AudioEngine.getInstance().playVoice(RES_CDN_SOUND+SND_TYPE+"voice_etc/"+voice+".mp3");break}}else if(member.getGeneral().position==db.BattlePosition.Head){var voice;ref={};(voice=MasterTable.getInstance().get_Voice(member.getGeneral().general.gnrl_id,voice_battle_init_leader,ref).voice)&&""!=voice&&AudioEngine.getInstance().playVoice(RES_CDN_SOUND+SND_TYPE+"voice_etc/"+voice+".mp3");break}}},calcGeneralsStat:function(){for(var i=0,len=this.m_team_members.length;i<len;i++){this.m_team_members[i].calcGeneralStat()}},addDamageLogGeneral:function(gnrl,dmg){if(this.m_team_type==BattleGeneral_TeamType.Left){var position=gnrl.position,key=[gnrl.gnrl_id,gnrl.gnrl_num,position];null==(logs=this.m_map_general_damage_log.at(key))&&(logs=[]),logs.push_back(dmg),this.m_map_general_damage_log.insert(key,logs)}else{var logs;position=gnrl.position,key=[gnrl.gnrl_id,gnrl.battle_stage,position];null==(logs=this.m_map_general_damage_log.at(key))&&(logs=[]),logs.push_back(dmg),this.m_map_general_damage_log.insert(key,logs)}},addGeneralDebugLog:function(gnrl,debug){if(this.m_team_type==BattleGeneral_TeamType.Left){var position=gnrl.position,key=[gnrl.gnrl_id,gnrl.gnrl_num,position];null==(logs=this.m_map_general_debug_log.at(key))&&(logs=[]),logs.push_back(debug),this.m_map_general_debug_log[key]=logs}else{var logs;position=gnrl.position,key=[gnrl.gnrl_id,gnrl.battle_stage,position];null==(logs=this.m_map_general_debug_log.at(key))&&(logs=[]),logs.push_back(debug),this.m_map_general_debug_log.insert(key,logs)}},showGenerals:function(is_show){for(var i=0;i<this.m_team_members.length;i++){var m=this.m_team_members[i];m.IsAlive()&&m.setVisible(is_show)}},retBattlePosition:function(num){var pos=db.BattlePosition.Head;switch(num){case 1:pos=db.BattlePosition.Head;break;case 2:pos=db.BattlePosition.Body_1;break;case 3:pos=db.BattlePosition.Body_2;break;case 4:pos=db.BattlePosition.Tail_1;break;case 5:pos=db.BattlePosition.Tail_2}return pos},teamAwayReady:function(){if(this.m_team_type==BattleGeneral_TeamType.Right)for(var i=0,len=this.m_team_members.length;i<len;i++){var m=this.m_team_members[i];m.IsAlive()&&(m.is_pause()&&(m.m_focus_state==FOCUS_STATE.UNFOCUS?m.unfocusEnd():m.generalResume()),m.releaseTransGeneral(database.BattleEffectTrans.Freeze),m.releaseTransGeneral(database.BattleEffectTrans.Stun),m.releaseTransGeneral(database.BattleEffectTrans.Petrification),m.calcDurabilityEffect(0),m.generalAwayReady())}},teamAway:function(){if(this.m_team_type==BattleGeneral_TeamType.Right)for(var i=0,len=this.m_team_members.length;i<len;i++){var m=this.m_team_members[i];m.IsAlive()&&m.generalAway()}},worldWarNpcDungeonTimeoutReady:function(){for(var i=0;i<this.m_team_members.length;i++){var hero=this.m_team_members[i];hero.is_pause()&&(hero.m_focus_state==FOCUS_STATE.UNFOCUS?hero.unfocusEnd():hero.generalResume()),hero.IsAlive()&&(this.m_team_type==BattleGeneral_TeamType.Left?(null!=hero._skillEnable&&hero._skillEnable.skillEnable(!1),hero.cancelActiveSkillForCutin(),hero.cancelUsedEffect(),hero.releaseTransGeneral(database.BattleEffectTrans.Freeze),hero.releaseTransGeneral(database.BattleEffectTrans.Stun),hero.releaseTransGeneral(database.BattleEffectTrans.Petrification),hero.setReservedBackCourt(!0)):(hero.releaseTransGeneral(database.BattleEffectTrans.Freeze),hero.releaseTransGeneral(database.BattleEffectTrans.Stun),hero.releaseTransGeneral(database.BattleEffectTrans.Petrification)),hero.calcDurabilityEffect(0),hero.setGeneralState(BattleGeneral_GeneralState.RaidTimeover))}},MussangBossTimeOutReady:function(){for(var i=0;i<this.m_team_members.length;i++){var hero=this.m_team_members[i];hero.is_pause()&&(hero.m_focus_state==FOCUS_STATE.UNFOCUS?hero.unfocusEnd():hero.generalResume()),hero.IsAlive()&&(this.m_team_type==BattleGeneral_TeamType.Left?(null!=hero._skillEnable&&hero._skillEnable.skillEnable(!1),hero.cancelActiveSkillForCutin(),hero.cancelUsedEffect(),hero.releaseTransGeneral(database.BattleEffectTrans.Freeze),hero.releaseTransGeneral(database.BattleEffectTrans.Stun),hero.releaseTransGeneral(database.BattleEffectTrans.Petrification),hero.setReservedBackCourt(!0)):(hero.releaseTransGeneral(database.BattleEffectTrans.Freeze),hero.releaseTransGeneral(database.BattleEffectTrans.Stun),hero.releaseTransGeneral(database.BattleEffectTrans.Petrification)),hero.calcDurabilityEffect(0),hero.setGeneralState(BattleGeneral_GeneralState.MussangBossTimeOver))}},newRaidBossTimeoutReady:function(){for(var i=0,len=this.m_team_members.length;i<len;i++){var hero=this.m_team_members[i];hero.is_pause()&&(hero.m_focus_state==FOCUS_STATE.UNFOCUS?hero.unfocusEnd():hero.generalResume()),hero.IsAlive()&&(this.m_team_type==BattleGeneral_TeamType.Left?(null!=hero._skillEnable&&hero._skillEnable.skillEnable(!1),hero.cancelActiveSkillForCutin(),hero.cancelUsedEffect(),hero.releaseTransGeneral(database.BattleEffectTrans.Freeze),hero.releaseTransGeneral(database.BattleEffectTrans.Stun),hero.releaseTransGeneral(database.BattleEffectTrans.Petrification),hero.setReservedBackCourt(!0)):(hero.releaseTransGeneral(database.BattleEffectTrans.Freeze),hero.releaseTransGeneral(database.BattleEffectTrans.Stun),hero.releaseTransGeneral(database.BattleEffectTrans.Petrification)),hero.calcDurabilityEffect(0),hero.setGeneralState(BattleGeneral_GeneralState.NewRaidBossTimeOver))}},raidTimeoutReady:function(){for(var i=0,len=this.m_team_members.length;i<len;i++){var hero=this.m_team_members[i];hero.is_pause()&&(hero.m_focus_state==FOCUS_STATE.UNFOCUS?hero.unfocusEnd():hero.generalResume()),hero.IsAlive()&&(this.m_team_type==BattleGeneral_TeamType.Left?(null!=hero._skillEnable&&hero._skillEnable.skillEnable(!1),hero.cancelActiveSkillForCutin(),hero.cancelUsedEffect(),hero.releaseTransGeneral(database.BattleEffectTrans.Freeze),hero.releaseTransGeneral(database.BattleEffectTrans.Stun),hero.releaseTransGeneral(database.BattleEffectTrans.Petrification),hero.setReservedBackCourt(!0)):(hero.releaseTransGeneral(database.BattleEffectTrans.Freeze),hero.releaseTransGeneral(database.BattleEffectTrans.Stun),hero.releaseTransGeneral(database.BattleEffectTrans.Petrification)),hero.calcDurabilityEffect(0),hero.setGeneralState(BattleGeneral_GeneralState.RaidTimeover))}},raidEnd:function(){if(this.m_team_type==BattleGeneral_TeamType.Left)for(var i=0,len=this.m_team_members.length;i<len;i++){(m=this.m_team_members[i]).IsAlive()&&(null!=m._skillEnable&&m._skillEnable.skillEnable(!1),m.setGeneralState(BattleGeneral_GeneralState.Wait),m.playAction(ActionType.Attack_Idle),m.forceKill())}else for(i=0;i<this.m_team_members.length;i++){var m;(m=this.m_team_members[i]).IsAlive()&&m.generalFinishSkill()}},MussangBossEnd:function(){if(this.m_team_type==BattleGeneral_TeamType.Left)for(var i=0;i<this.m_team_members.length;i++){(m=this.m_team_members[i]).IsAlive()&&(null!=m._skillEnable&&m._skillEnable.skillEnable(!1),m.setGeneralState(BattleGeneral_GeneralState.End),m.playAction(ActionType.Attack_Idle))}else for(i=0;i<this.m_team_members.length;i++){var m;(m=this.m_team_members[i]).IsAlive()&&(m.setGeneralState(BattleGeneral_GeneralState.Wait),m.playAction(ActionType.Attack_Idle))}},awayCompleteMember:function(gnrl){var found=this.m_team_members.indexOf(gnrl);-1!=found&&this.m_team_members.splice(found,1),0==this.m_team_members.length&&this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.battle_vs_next_stage)},addNewRaidBossAccumDamage:function(boss_idx,damage){for(var keys=this.m_new_raid_boss_damage_data.keys(),dmg_info=-1,idx=0;idx<keys.length;idx++)keys[idx]==boss_idx&&(dmg_info=keys[idx]);if(-1!=dmg_info){var dmg=this.m_new_raid_boss_damage_data.at(dmg_info);dmg+=damage,this.m_new_raid_boss_damage_data.insert(dmg_info,dmg)}else this.m_new_raid_boss_damage_data.insert(boss_idx,damage)},addEventDungeonCutinAccumDamage:function(damage){this.m_event_dungeon_cutin_accum_damage+=damage},addEventDungeonMusssangBossAccumDamage:function(damage){this.m_event_dungeon_mussang_boss_accum_damage+=damage},addEventRaidAccumDamage:function(damage){cc.log("############### Event Raid AccumDamage : "+damage),this.m_event_dungeon_raid_accum_damage+=parseInt(damage),cc.log("############### Event Raid AccumDamage2 : "+this.m_event_dungeon_raid_accum_damage)},getEventDungeonCutinAccumDamage:function(){return cc.log("################    :   "+this.m_event_dungeon_cutin_accum_damage),cc.log("@@@@@@@@@@@@@@@@    :   "+parseInt(this.m_event_dungeon_cutin_accum_damage)),2<this.m_event_dungeon_cutin_accum_damage-parseInt(this.m_event_dungeon_cutin_accum_damage)&&cc.log("################    :   "+this.m_event_dungeon_cutin_accum_damage),parseInt(this.m_event_dungeon_cutin_accum_damage)},getEventDungeonCutinBossMaxLife:function(){return this.m_event_dungeon_cutin_boss_max_life},getEventRaidDungeonBossMaxLife:function(){return this.m_evnet_dungeon_raid_boss_max_life},getEventRaidDungeonAccumLife:function(){return this.m_event_dungeon_raid_accum_damage},battleGeneralDead:function(dead_gnrl){for(var idx=0;idx<this.m_team_members.length;idx++)this.m_team_members[idx].deadElseGeneral(dead_gnrl);if(this.m_team_type==BattleGeneral_TeamType.Right&&dead_gnrl.getTeamType()==BattleGeneral_TeamType.Left){for(var left_team=this.m_target_team.getTeamMembers(),left_team_alive_cnt=0,l_idx=0;l_idx<left_team.length;l_idx++)left_team[l_idx].IsAlive()&&++left_team_alive_cnt;for(var m_idx=0;m_idx<this.m_team_members.length;m_idx++)if(this.m_team_members[m_idx].getGeneral().is_zoom)switch(left_team_alive_cnt){case 4:this.m_team_members[m_idx].find_voice_use(voice_npc_boss_player_general_alive_4)||this.m_team_members[m_idx].playVoicePart(voice_npc_boss_player_general_alive_4);break;case 3:this.m_team_members[m_idx].find_voice_use(voice_npc_boss_player_general_alive_3)||this.m_team_members[m_idx].playVoicePart(voice_npc_boss_player_general_alive_3);break;case 2:this.m_team_members[m_idx].find_voice_use(voice_npc_boss_player_general_alive_2)||this.m_team_members[m_idx].playVoicePart(voice_npc_boss_player_general_alive_2);break;case 1:this.m_team_members[m_idx].find_voice_use(voice_npc_boss_player_general_alive_1)||this.m_team_members[m_idx].playVoicePart(voice_npc_boss_player_general_alive_1)}}},getMapDamageLogGeneral:function(){return this.m_map_general_damage_log},getMapGeneralDebugLog:function(){return this.m_map_general_debug_log},get_Reader_Gnrl_Group_id:function(){return this.m_Reader_Gnrl_Group_id},set_Reader_Gnrl_Group_id:function(gnrl_group_id){this.m_Reader_Gnrl_Group_id=gnrl_group_id},IsAliveTargetGeneral:function(key){for(var found=0,found_is=!1,i=0;i<this.m_team_members.length;i++){var g=this.m_team_members[i].getGeneral();if(found=i,g.gnrl_id==key.gnrl_id&&g.gnrl_num==key.gnrl_num){found_is=!0;break}}return 1==found_is&&this.m_team_members[found].IsAlive()},IsPlaySkill:function(){for(var idx=0;idx<this.m_team_members.length;idx++){if(this.m_team_members[idx].getPlaySkill())return!0}return!1},getGnrlName:function(gnrl_id){for(var idx=0;idx<this.m_team_members.length;idx++){var m=this.m_team_members[idx];if(gnrl_id==m.getGeneral().general.gnrl_id)return m.getGeneral().general.name}return"Not_Find"},getDBBattleGeneral:function(gnrl_id){for(var idx=0;idx<this.m_team_members.length;idx++){var m=this.m_team_members[idx];if(gnrl_id==m.getGeneral().general.gnrl_id)return m.getGeneral()}return null},FindTeamUseActiveSkillAddDurabilityEffect:function(){for(var mt=MasterManager.getInstance(),idx=0;idx<this.m_team_members.length;idx++)for(var jdx=0;jdx<this.m_team_members[idx].getBattleGeneral().trans_passive_skill.length;jdx++){for(var passive=$.extend({},this.m_team_members[idx].getBattleGeneral().trans_passive_skill[jdx]),action=mt.get_ActionImplementation(passive.trans_passive.action_id),tdx=0;tdx<passive.durability_effects.length;tdx++)if(passive.trans_passive.invoke_type2==database.BattleInvokeType.BattleInvokeType_OurTeam_Skill_Attack){for(var activeskill_damage_cnt_by_passive_effect=0,vdx=0;vdx<this.m_team_members[idx].m_durability_effects.length;vdx++)this.m_team_members[idx].m_durability_effects[vdx].trans_type!=database.BattleEffectTrans.Passive_Duration_Active_Skill_Damage_Inc&&this.m_team_members[idx].m_durability_effects[vdx].trans_type!=database.BattleEffectTrans.Caster_Lv_Skill_Attack_Inc_Dup_Limit||++activeskill_damage_cnt_by_passive_effect;if(0==action.action_id)(passive.durability_effects[tdx].trans_type==database.BattleEffectTrans.Passive_Duration_Active_Skill_Damage_Inc||passive.durability_effects[tdx].trans_type==database.BattleEffectTrans.Caster_Lv_Skill_Attack_Inc_Dup_Limit)&&activeskill_damage_cnt_by_passive_effect<passive.durability_effects[tdx].durability.dura_end_effect&&0!=passive.durability_effects[tdx].durability.dura_end_effect?this.m_team_members[idx].addDurabilityEffect(passive.durability_effects[tdx],this.m_team_members[idx]):0==passive.durability_effects[tdx].durability.dura_end_effect&&this.m_team_members[idx].addDurabilityEffect(passive.durability_effects[tdx],this.m_team_members[idx]);else{var target_list=[];passive.durability_effects[tdx].our_enemy==database.BattleSelfOther.Other?target_list=this.findEnemyTarget(this.m_team_members[idx],action.target_count,action.priority_position):passive.durability_effects[tdx].our_enemy==database.BattleSelfOther.Self&&(target_list=this.findOurTarget(this.m_team_members[idx],action.target_count,action.priority_position));for(var zdx=0;zdx<target_list.length;zdx++)target_list[zdx].addDurabilityEffect(passive.durability_effects[tdx],this.m_team_members[idx])}}passive=null}},Find_Team_Use_Active_Skill_Team_Onetime_Effect:function(){for(var idx=0;idx<this.m_team_members.length;idx++)for(var jdx=0;jdx<this.m_team_members[idx].getBattleGeneral().trans_passive_skill.length;jdx++){var passive=$.extend({},this.m_team_members[idx].getBattleGeneral().trans_passive_skill[jdx]);if(passive.trans_passive.invoke_type1==database.BattleInvokeType.BattleInvokeType_OurTeam_Skill_Attack){var action=MasterManager.getInstance().get_ActionImplementation(passive.trans_passive.action_id);if(null!=passive.onetime_effects)for(var tdx=0;tdx<passive.onetime_effects.length;tdx++)if(0==action.action_id)this.m_team_members[idx].addOnetimeEffect(passive.onetime_effects[tdx]);else{var target_list=[];passive.action.our_enemy==database.BattleSelfOther.Other?target_list=this.findEnemyTarget(this.m_team_members[idx],action.target_count,action.priority_position):passive.action.our_enemy==database.BattleSelfOther.Self&&(target_list=this.findOurTarget(this.m_team_members[idx],action.target_count,action.priority_position));for(var zdx=0;zdx<target_list.length;zdx++)target_list[zdx].addOnetimeEffect(passive.onetime_effects[tdx])}}}},add_Onetime_Effect_Invoke_Wave_Begin:function(){for(var idx=0;idx<this.m_team_members.length;idx++)this.m_team_members[idx].add_OneTime_Effect_Call_Wave_Begin()},getBattleGeneral:function(gnrl_id){for(var found=0,found_is=!1,i=0;i<this.m_team_members.length;i++){if(found=i,this.m_team_members[i].getGeneral().general.gnrl_id==gnrl_id){found_is=!0;break}}return 1==found_is?this.m_team_members[found]:null},getWorldWarCastleSpecialFuncIncStat:function(gnrl,func_type,stat_type){for(var point=0,idx=0;idx<this.m_castle_special_func_list.length;idx++)if(this.m_castle_special_func_list[idx].world_war_special_func_type==func_type)if(func_type==eCastleSpecialTalent.est_increase_stat)switch(this.m_castle_special_func_list[idx].value_1){case 1:this.m_castle_special_func_list[idx].value_2==gnrl.element_type&&this.m_castle_special_func_list[idx].value_3==stat_type&&(point+=this.m_castle_special_func_list[idx].value_4);break;case 2:this.m_castle_special_func_list[idx].value_2==gnrl.arm_service_type&&this.m_castle_special_func_list[idx].value_3==stat_type&&(point+=this.m_castle_special_func_list[idx].value_4);break;case 3:this.m_castle_special_func_list[idx].value_2==gnrl.state_type&&this.m_castle_special_func_list[idx].value_3==stat_type&&(point+=this.m_castle_special_func_list[idx].value_4)}else if(func_type==eCastleSpecialTalent.est_increase_enemy_damage)switch(this.m_castle_special_func_list[idx].value_1){case 1:6!=this.m_castle_special_func_list[idx].value_2&&this.m_castle_special_func_list[idx].value_2!=gnrl.element_type||this.m_castle_special_func_list[idx].value_3!=stat_type||(point+=this.m_castle_special_func_list[idx].value_4);break;case 2:this.m_castle_special_func_list[idx].value_2==gnrl.arm_service_type&&this.m_castle_special_func_list[idx].value_3==stat_type&&(point+=this.m_castle_special_func_list[idx].value_4);break;case 3:this.m_castle_special_func_list[idx].value_2==gnrl.state_type&&this.m_castle_special_func_list[idx].value_3==stat_type&&(point+=this.m_castle_special_func_list[idx].value_4)}return point},getEventDungeonMusssangBossAccumDamage:function(){return this.m_event_dungeon_mussang_boss_accum_damage},getNewRaidBossDamageInfo:function(){return this.m_new_raid_boss_damage_data},getNewRaidBossDungeonData:function(){return this.m_new_raid_boss_dungeon}}),_Layer=cc.Layer.extend({init:function(){return this._super(),!0}}),STAGE_CLEAR_WAIT_TIME=.5,STAGE_LOSE_WAIT_TIME=1,BattleFieldLayer=cc.Layer.extend({m_root_layer:null,m_base_layer:null,m_damage_layer:null,m_dark_layer:null,m_color_layer:null,m_ground_buf_layer:null,m_ground_layer:null,m_emergency_layer:null,m_added_effect_layer:null,m_skill_effect_layer:null,m_bg:null,m_audio:null,m_delta_time:0,m_main_mission:null,m_weekly_dungeon:null,m_mussang:null,m_event_dungeon:null,m_daily_dungeon:null,m_great_wall_dungeon:null,m_mussang_tower_dungeon:null,m_battle_scene:null,m_left_team:null,m_right_team:null,m_is_script_ready:!1,m_is_auto_skill:!1,m_is_loadcomplete:!1,m_warning_layer:null,m_is_game_pause:!1,m_after_effect_interval:.1,m_after_effect_fadeout:1,is_after_effect:!1,m_zoom_delta:0,m_background_layer:null,m_change_bg:null,_idx:0,last_state:0,m_game_type:null,battleObserver:null,m_stage_drop_items:[],m_is_initial_special_leader_skill:!1,m_zoom_points:new Array,m_cur_battle_timescale:!1,m_state:BattleState.GameReady,m_drop_items:[],m_recycled_damage:[],m_used_damage:[],m_main_mission_service:null,m_background_res:[],m_BackgroundDungeon_res:{},m_worker:null,intervalID:null,m_dt:0,m_hide_begin_end:!1,m_once_a_day_dungeon:null,m_etc_effect_layer:null,m_world_war_npc_dungeon:null,m_story_hard_mode_mission:null,ctor:function(scene){return this.m_drop_items=[],this.m_stage_drop_items=[],this._super(cc.color(0,0,0,255),cc.color(70,130,180,255)),this.winSize=cc.director.getWinSize(),this.m_main_mission=new database.BattleMainMission2,this.m_main_mission_service=$.extend({},database.BattleMainMission),this.m_story_hard_mode_mission=$.extend({},database.BattleStoryHardModeMission),this.battleObserver=MainObserver.getInstance(),this.m_battle_scene=scene,this.m_mussang={},!0},init:function(){this.initLayout()},callWorker:function(){window.Worker&&(cc.log("this browser support web worker"),this.m_worker&&this.m_worker.terminate(),this.m_worker=new Worker("worker.js"),this.m_worker.onmessage=function(event){cc.log(event.data)},this.m_worker.postMessage("!"))},stopWorker:function(){this.m_worker&&this.m_worker.terminate()},onEnter:function(){BATTLE_TO_SHOP||(this._super(),this.init(),this.scheduleUpdate())},initFieldObject:function(){null!=this.m_weekly_dungeon&&(this.m_weekly_dungeon.current_stage=1),null!=this.m_main_mission&&(this.m_main_mission.current_stage=1),null!=this.m_event_dungeon&&(this.m_event_dungeon.current_stage=1)},onExit:function(){if(!BATTLE_TO_SHOP){this._super();var i=0;if(1==BATTLE_SCENE_MEMORY_CLEAR){for(i=0;i<this.m_background_res.length;i++)cc.loader.release(this.m_background_res[i]);for(this.m_background_res=null,i=0;i<this.m_BackgroundDungeon_res.length;i++)cc.loader.release(this.m_BackgroundDungeon_res[i]);this.m_BackgroundDungeon_res=null,this.m_root_layer.removeAllChildrenWithCleanup(!0),this.m_base_layer.removeAllChildrenWithCleanup(!0),this.m_ground_buf_layer.removeAllChildrenWithCleanup(!0),this.m_root_layer.removeAllChildrenWithCleanup(!0),this.m_damage_layer.removeAllChildrenWithCleanup(!0),this.m_right_team.removeAllChildrenWithCleanup(!0),this.m_right_team.removeAllChildrenWithCleanup(!0),this.m_bg.removeAllChildrenWithCleanup(!0),this.removeAllChildrenWithCleanup(!0),this.removeChild(this.m_base_layer),this.removeChild(this.m_root_layer),this.removeChild(this.m_right_team),this.removeChild(this.m_left_team),this.removeChild(this.m_bg),this.m_left_team._loadTeamMemberComplete=null,this.m_right_team._loadTeamMemberComplete=null,this.m_left_team._loadGeneralLoadComplete=null,this.m_right_team._loadGeneralLoadComplete=null,this.m_left_team._generalEventListenerForFieldMng=null,this.m_right_team._generalEventListenerForFieldMng=null,this.m_left_team._generalAddBattleFxNode=null,this.m_right_team._generalAddBattleFxNode=null,this.m_left_team=null,this.m_right_team=null,this.winSize=null,this.m_root_layer=null,this.m_base_layer=null,this.m_damage_layer=null,this.m_dark_layer=null,this.m_color_layer=null,this.m_ground_buf_layer=null,this.m_ground_layer=null,this.m_emergency_layer=null,this.m_added_effect_layer=null,this.m_skill_effect_layer=null,this.m_bg=null,this.m_audio=null,this.m_battle_scene=null,this.m_left_team=null,this.m_right_team=null,this.m_warning_layer=null,this.m_background_layer=null,this.m_change_bg=null,this.m_game_type=null,this.battleObserver=null,this.m_stage_drop_items=null,this.m_zoom_points=null,this.m_state=null,this.m_drop_items=null,this.m_recycled_damage=null,this.m_used_damage=null,this.m_main_mission=null,this.m_main_mission_service=null,this.m_etc_effect_layer=null,delete this.m_background_res,delete this.m_BackgroundDungeon_res,delete this.m_left_team,delete this.m_right_team,delete this.winSize,delete this.m_root_layer,delete this.m_base_layer,delete this.m_damage_layer,delete this.m_dark_layer,delete this.m_color_layer,delete this.m_ground_buf_layer,delete this.m_ground_layer,delete this.m_emergency_layer,delete this.m_added_effect_layer,delete this.m_skill_effect_layer,delete this.m_bg,delete this.m_audio,delete this.m_battle_scene,delete this.m_warning_layer,delete this.m_background_layer,delete this.m_change_bg,delete this.m_game_type,delete this.battleObserver,delete this.m_stage_drop_items,delete this.m_zoom_points,delete this.m_state,delete this.m_drop_items,delete this.m_recycled_damage,delete this.m_used_damage,delete this.m_main_mission,delete this.m_main_mission_service,delete this.m_etc_effect_layer}}},initLayout:function(){var context=BattleContext._getInstance();if(this.m_game_type=BattleContext._getInstance().getGameType(),this.m_game_type==db.BattleGameType.Mission){var mission_id=BattleContext._getInstance().getMissionID();BattleMissionTaskManager._getInstance().setMissionID(mission_id),this.m_stage_drop_items=BattleContext._getInstance().getDungeonDropItemCount()}else if(this.m_game_type==db.BattleGameType.StoryHardMode){var main_story_hard_mode_mission_idx=BattleContext._getInstance().getStoryHardModeMissionId();BattleStoryHardModeMissionTaskManager._getInstance().setMainStoryHardModeMissionId(main_story_hard_mode_mission_idx),this.m_stage_drop_items=context.getDungeonDropItemCount()}else if(this.m_game_type==db.BattleGameType.WeeklyDungeon){var dungeon=BattleContext._getInstance().getWeeklyDungeonDifficulty();BattleWeeklyDungeonTaskManager.getInstance().setWeeklyDungeonData(dungeon),this.m_stage_drop_items=BattleContext._getInstance().getDungeonDropItemCount()}else if(this.m_game_type==db.BattleGameType.EventDungeon){dungeon=BattleContext._getInstance().getEventDungeonData();BattleEventDungeonTaskManager.getInstance().setEventDungeonData(dungeon),this.m_stage_drop_items=BattleContext._getInstance().getDungeonDropItemCount()}else if(this.m_game_type==db.BattleGameType.TowerDungeon){dungeon=BattleContext._getInstance().getMussangTowerDungeonData();BattleTowerTaskManager._getInstance().setTowerDungeonData(dungeon)}this.m_is_auto_skill=GameDefault.getInstance().getUserAutoSkill();var position_list=[370,270];this.m_zoom_points.push_back(position_list),position_list=[370,420],this.m_zoom_points.push_back(position_list),position_list=[.5*this.winSize.width,270],this.m_zoom_points.push_back(position_list),position_list=[.5*this.winSize.width,420],this.m_zoom_points.push_back(position_list),position_list=[this.winSize.width-370,270],this.m_zoom_points.push_back(position_list),position_list=[this.winSize.width-370,420],this.m_zoom_points.push_back(position_list),this.scheduleOnce(this.resourceLoading,.5)},resourceLoading:function(dt){var context=BattleContext._getInstance(),service=BattleService.getInstance();context.setGameOverFlag(!1),this.m_root_layer=new _Layer,this.m_root_layer.ignoreAnchorPointForPosition(!1),this.m_root_layer.setAnchorPoint(.5,.5),this.m_root_layer.setPosition(cc.p(this.winSize.width/2,this.winSize.height/2)),this.m_root_layer.width=this.winSize.width,this.m_root_layer.height=this.winSize.height,this.addChild(this.m_root_layer),this.m_change_bg=new cc.Sprite,USE_SP_SKILL_BG&&this.m_change_bg.setScale(2),this.m_change_bg.setAnchorPoint(.5,.5),this.m_change_bg.setPosition(cc.p(this.winSize.width/2,this.winSize.height/2)),this.m_change_bg.setTag(999999),this.m_root_layer.addChild(this.m_change_bg,0),this.m_ground_layer=new _Layer,this.m_ground_layer.width=this.winSize.width,this.m_ground_layer.height=this.winSize.height,this.m_ground_layer.ignoreAnchorPointForPosition(!1),this.m_ground_layer.setAnchorPoint(.5,.5),this.m_ground_layer.setPosition(cc.p(this.winSize.width/2,this.winSize.height/2)),this.m_root_layer.addChild(this.m_ground_layer,0),this.m_color_layer=new cc.LayerColor(cc.color.BLACK,1.5*this.winSize.width,1.5*this.winSize.height),this.m_color_layer.anchorX=.5,this.m_color_layer.anchorY=.5,this.m_color_layer.opacity=0,this.m_color_layer.x=this.winSize.width/2,this.m_color_layer.y=this.winSize.height/2,this.m_color_layer.ignoreAnchorPointForPosition(!1),this.m_root_layer.addChild(this.m_color_layer,2),this.m_ground_buf_layer=new _Layer,this.m_ground_buf_layer.width=this.winSize.width,this.m_ground_buf_layer.height=this.winSize.height,this.m_ground_buf_layer.ignoreAnchorPointForPosition(!1),this.m_ground_buf_layer.setAnchorPoint(.5,.5),this.m_ground_buf_layer.setPosition(cc.p(this.winSize.width/2,this.winSize.height/2)),this.m_root_layer.addChild(this.m_ground_buf_layer,3),this.m_base_layer=new _Layer,this.m_base_layer.ignoreAnchorPointForPosition(!1),this.m_base_layer.setAnchorPoint(.5,.5),this.m_base_layer.setPosition(cc.p(this.winSize.width/2,this.winSize.height/2)),this.m_base_layer.width=this.winSize.width,this.m_base_layer.height=this.winSize.height,this.m_root_layer.addChild(this.m_base_layer,4),this.m_added_effect_layer=new _Layer,this.m_added_effect_layer.setContentSize(this.winSize),this.m_added_effect_layer.ignoreAnchorPointForPosition(!1),this.m_added_effect_layer.setAnchorPoint(.5,.5),this.m_added_effect_layer.setPosition(cc.p(this.winSize.width/2,this.winSize.height/2)),this.m_root_layer.addChild(this.m_added_effect_layer,5),this.m_skill_effect_layer=new _Layer,this.m_skill_effect_layer.setContentSize(this.winSize),this.m_skill_effect_layer.ignoreAnchorPointForPosition(!1),this.m_skill_effect_layer.setAnchorPoint(.5,.5),this.m_skill_effect_layer.setPosition(cc.p(this.winSize.width/2,this.winSize.height/2)),this.m_root_layer.addChild(this.m_skill_effect_layer,9),this.m_damage_layer=new _Layer,this.m_damage_layer.setContentSize(this.winSize),this.m_damage_layer.ignoreAnchorPointForPosition(!1),this.m_damage_layer.setAnchorPoint(.5,.5),this.m_damage_layer.setPosition(cc.p(this.winSize.width/2,this.winSize.height/2)),this.m_root_layer.addChild(this.m_damage_layer,10),this.m_emergency_layer=new _Layer,this.m_emergency_layer.setContentSize(this.winSize),this.m_emergency_layer.ignoreAnchorPointForPosition(!1),this.m_emergency_layer.setAnchorPoint(.5,.5),this.m_emergency_layer.setPosition(cc.p(this.winSize.width/2,this.winSize.height/2)),this.m_root_layer.addChild(this.m_emergency_layer,2100),this.m_warning_layer=new cc.LayerColor,this.m_warning_layer.setContentSize(this.winSize),this.m_warning_layer.ignoreAnchorPointForPosition(!1),this.m_warning_layer.setAnchorPoint(.5,.5),this.m_warning_layer.setPosition(cc.p(this.winSize.width/2,this.winSize.height/2)),this.m_warning_layer.setVisible(!1),this.m_root_layer.addChild(this.m_warning_layer,2101),this.m_etc_effect_layer=new _Layer,this.m_etc_effect_layer.setContentSize(this.winSize),this.m_etc_effect_layer.ignoreAnchorPointForPosition(!1),this.m_etc_effect_layer.setAnchorPoint(ANCHOR_MIDDLE()),this.m_etc_effect_layer.setPosition(ccCenter(this.winSize)),this.m_root_layer.addChild(this.m_etc_effect_layer,2102);var gd=GameDefault.getInstance();1==USE_LOCAL_STORAGE_TROOPS_OFF?troops_num=gd.getUserTroopsNum():gd.getUserTroopsNum().done(function(rVal){troops_num=rVal});if(this.m_left_team=new BattleTeamMng(1),this.m_right_team=new BattleTeamMng(2),((((((((this.m_left_team._loadTeamMemberComplete=this).m_right_team._loadTeamMemberComplete=this).m_left_team._loadGeneralLoadComplete=this).m_right_team._loadGeneralLoadComplete=this).m_left_team._generalEventListenerForFieldMng=this).m_right_team._generalEventListenerForFieldMng=this).m_left_team._generalAddBattleFxNode=this).m_right_team._generalAddBattleFxNode=this).m_game_type==db.BattleGameType.Mission){if(1==USE_LOCAL_STORAGE_TROOPS_OFF)troops_num=gd.getUserTroopsNum();else gd.getUserTroopsNum().done(function(_d_num){troops_num=_d_num});var mission_id=context.getMissionID();service.getMainMissionAndNpc(mission_id,this.m_main_mission_service),this.setMainMissionData(),this.m_left_team.initWithTroopsGenerals(BattleGeneral_TeamType.Left,troops_num,this.m_base_layer),this.m_right_team.initWithNpcGenerals(BattleGeneral_TeamType.Right,this.m_main_mission,this.m_base_layer)}if(this.m_game_type==db.BattleGameType.StoryHardMode)gd.getUserTroopsNum().done(function(_d_num){troops_num=_d_num;var main_story_hard_mode_mission_idx=context.getStoryHardModeMissionId();service.getStoryHardModeMissionAndNpc(main_story_hard_mode_mission_idx,this.m_story_hard_mode_mission),this.m_left_team.initWithTroopsGenerals(BattleGeneral_TeamType.Left,troops_num,this.m_base_layer),this.m_right_team.initWithStoryHardModeDungeonNpcGeneral(BattleGeneral_TeamType.Right,this.m_story_hard_mode_mission,this.m_base_layer)}.bind(this));else if(this.m_game_type==db.BattleGameType.WeeklyDungeon){this.m_weekly_dungeon=context.getWeeklyDungeonDifficulty(),gd.getUserWeeklyTroopsNum().done(function(rVal){troops_num=rVal,this.m_left_team.initWithWeeklyTroopsGenerals(BattleGeneral_TeamType.Left,this.m_weekly_dungeon,troops_num,this.m_base_layer),this.m_right_team.initWithWeeklyNpcGenerals(BattleGeneral_TeamType.Right,this.m_weekly_dungeon,this.m_base_layer)}.bind(this))}else if(this.m_game_type==db.BattleGameType.Mussang){var mussang_id=context.getMussangId();this.m_mussang=$.extend({},database.BattleMussang),service.getMasterMussangStepStageNpc(mussang_id,this.m_mussang),gd.getUserMussangTroopsNum().done(function(rVal){troops_num=rVal,this.m_left_team.initWithTroopsGenerals(BattleGeneral_TeamType.Left,troops_num,this.m_base_layer),this.m_right_team.initWithMussangNpcGenerals(BattleGeneral_TeamType.Right,this.m_mussang,this.m_base_layer)}.bind(this))}else if(this.m_game_type==db.BattleGameType.TowerDungeon){this.m_event_dungeon=context.getEventDungeonData(),this.m_mussang_tower_dungeon=context.getMussangTowerDungeonData(),gd.getUserTowerDungeonTroopsNum().done(function(rVal){troops_num=rVal,this.m_left_team.initWithTroopsGenerals(BattleGeneral_TeamType.Left,troops_num,this.m_base_layer),this.m_right_team.initWithMussangTowerNpcGenerals(BattleGeneral_TeamType.Right,this.m_mussang_tower_dungeon,this.m_base_layer)}.bind(this))}else if(this.m_game_type==db.BattleGameType.EventDungeon){this.m_event_dungeon=context.getEventDungeonData(),gd.getUserEventDungeonTroopsNum().done(function(rVal){troops_num=rVal,this.m_left_team.initWithTroopsGenerals(BattleGeneral_TeamType.Left,troops_num,this.m_base_layer),this.m_right_team.initWithEventdungeonNpcGeneral(BattleGeneral_TeamType.Right,this.m_event_dungeon,this.m_base_layer)}.bind(this))}else if(this.m_game_type==db.BattleGameType.OnceADayDungeon){this.m_once_a_day_dungeon=context.getEventOnceADayDungeonData(),gd.getUserOnceADayDungeonTroopsNum().done(function(rVal){troops_num=rVal,this.m_left_team.initWithTroopsGenerals(BattleGeneral_TeamType.Left,troops_num,this.m_base_layer),this.m_right_team.initWithEventOnceADayDungeonNpcGeneral(BattleGeneral_TeamType.Right,this.m_once_a_day_dungeon,this.m_base_layer)}.bind(this))}else if(this.m_game_type==db.BattleGameType.DailyDungeon){this.m_daily_dungeon=context.getDailyDungeonData(),gd.getUserDailyDungeonTroopsNum().done(function(rVal){troops_num=rVal,this.m_left_team.initWithTroopsGenerals(BattleGeneral_TeamType.Left,troops_num,this.m_base_layer),this.m_right_team.initWithDailyDungeonNpcGeneral(BattleGeneral_TeamType.Right,this.m_daily_dungeon,this.m_base_layer)}.bind(this))}else if(this.m_game_type==db.BattleGameType.RaidDungeon){var dungeon=context.getRaidDungeonData(),raid_boss=context.getRaidBossData();gd.getUserRaidBossElementTroopsNum(raid_boss.raid_boss_info_idx).done(function(rVal){troops_num=rVal,this.m_left_team.initWithTroopsGenerals(BattleGeneral_TeamType.Left,troops_num,this.m_base_layer),this.m_right_team.initWithRaidDungeonNpcGeneral(BattleGeneral_TeamType.Right,dungeon,this.m_base_layer)}.bind(this))}else if(this.m_game_type==db.BattleGameType.NewRaidBossDungeon){dungeon=context.getBattleNewRaidBossDungeonData();gd.getUserTroopsNum().done(function(_d_num){troops_num=_d_num,this.m_left_team.initWithTroopsGenerals(BattleGeneral_TeamType.Left,troops_num,this.m_base_layer),this.m_right_team.initWithNewRaidBossDungeonNpcGeneral(BattleGeneral_TeamType.Right,dungeon,this.m_base_layer)}.bind(this))}else if(this.m_game_type==db.BattleGameType.GreatWallDungeon){this.m_great_wall_dungeon=context.getGreatWallDungeonData(),gd.getUserGreatWallTroopsNum().done(function(rVal){troops_num=rVal,this.m_left_team.initWithGreatWallTroopsGenerals(BattleGeneral_TeamType.Left,troops_num,this.m_base_layer),this.m_right_team.initWithGreatWallDungeonNpcGeneral(BattleGeneral_TeamType.Right,this.m_great_wall_dungeon,this.m_base_layer)}.bind(this))}else if(this.m_game_type==db.BattleGameType.EventMussangBossDungeon){dungeon=context.getEventMussangBossDungeonData();gd.getUserEventMussangBossTroopsNum().done(function(rVal){troops_num=rVal,this.m_left_team.initWithTroopsGenerals(BattleGeneral_TeamType.Left,troops_num,this.m_base_layer),this.m_right_team.initWithMussangBossGenerals(BattleGeneral_TeamType.Right,dungeon,this.m_base_layer)}.bind(this))}else if(this.m_game_type==db.BattleGameType.WorldWarNpcDungeon)this.m_world_war_npc_dungeon=context.getWorldWarNpcBattleData(),this.m_left_team.initWithWorldWarTroopsGenerals(BattleGeneral_TeamType.Left,this.m_world_war_npc_dungeon.troops,this.m_base_layer),this.m_right_team.initWithWorldWarNpcDungeonGeneral(BattleGeneral_TeamType.Right,this.m_world_war_npc_dungeon,this.m_base_layer);else if(this.m_game_type==db.BattleGameType.EventRaidDungeon){gd.getUserEventRaidDungeonTroopsNum().done(function(rVal){troops_num=rVal,this.m_left_team.initWithEventRaidDungeonTroopsGeneral(BattleGeneral_TeamType.Left,troops_num,this.m_base_layer),this.m_right_team.initWithEventRaidDungeonNpcGeneral(BattleGeneral_TeamType.Right,this.m_base_layer)}.bind(this))}var total_resource_count=this.m_left_team.getLoadReadyGeneralCount()+this.m_right_team.getLoadReadyGeneralCount();if(this.m_battle_scene.setTotalLoadResourceCount(total_resource_count),this.m_game_type==db.BattleGameType.WeeklyDungeon)this.createBackgrounDungeon(db.BattleGameType.WeeklyDungeon,0);else if(this.m_game_type==db.BattleGameType.Mission)this.createBackgrounDungeon(db.BattleGameType.Mission,0);else if(this.m_game_type==db.BattleGameType.StoryHardMode)this.createBackgrounDungeon(db.BattleGameType.StoryHardMode,0);else if(this.m_game_type==db.BattleGameType.Mussang)this.createBackgrounDungeon(db.BattleGameType.Mussang,0);else if(this.m_game_type==db.BattleGameType.EventDungeon)this.m_event_dungeon.event_dungeon.event_dungeon_idx==PRESENT_DUNGEON_IDX?this.createBackgrounDungeon(db.BattleGameType.EventDungeon,9999):this.createBackgrounDungeon(db.BattleGameType.EventDungeon,Math.floor(this.m_event_dungeon.event_dungeon_period.event_dungeon_period_idx));else if(this.m_game_type==db.BattleGameType.DailyDungeon)this.createBackgrounDungeonBG(this.m_game_type);else if(this.m_game_type==db.BattleGameType.RaidDungeon)this.createBackgrounDungeonBG(this.m_game_type);else if(this.m_game_type==db.BattleGameType.NewRaidBossDungeon)this.createBackgrounDungeonBG(this.m_game_type);else if(this.m_game_type==db.BattleGameType.GreatWallDungeon)this.createBackgrounDungeonBG(this.m_game_type);else if(this.m_game_type==db.BattleGameType.TowerDungeon)this.createBackgrounDungeonBG(this.m_game_type);else if(this.m_game_type==db.BattleGameType.OnceADayDungeon){var Sub_Type=GameContext.getInstance().getSubDungeonType();Sub_Type==EVENT_DUNGEON_SUB_TYPE_ONCE?this.createBackgrounDungeon(db.BattleGameType.OnceADayDungeon,EVENT_DUNGEON_SUB_TYPE_ONCE):Sub_Type==EVENT_DUNGEON_SUB_TYPE_ONCE_A_DAY&&this.createBackgrounDungeon(db.BattleGameType.OnceADayDungeon,EVENT_DUNGEON_SUB_TYPE_ONCE_A_DAY)}else this.m_game_type==db.BattleGameType.WorldWarNpcDungeon?this.createBackgrounDungeonBG(this.m_game_type):this.createBackground(this.m_game_type);this.m_left_team.setTargetTeam(this.m_right_team),this.m_right_team.setTargetTeam(this.m_left_team),this.addChild(this.m_left_team),this.addChild(this.m_right_team),this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.battle_ui_loading)},cbLoadGeneralComplete:function(gnrl){null!=gnrl&&this.m_battle_scene.addLoadedResourceCount(1)},chkSkeletonLoadFinish:function(){return null!=this.m_left_team&&null!=this.m_right_team&&(1==this.m_left_team.chkIsSkeletonReady()&&1==this.m_right_team.chkIsSkeletonReady())},cbLoadTeamMemberComplete:function(team){if(this.m_left_team.IsLoadMemberComplete()&&this.m_right_team.IsLoadMemberComplete()){if(this.m_is_loadcomplete)return;this.m_is_loadcomplete=!0,this.schedule(function(dt){this.chkSkeletonLoadFinish()&&(this.m_left_team.setAutoSkill(this.m_is_auto_skill),this.m_right_team.setAutoSkill(!0),this.m_is_script_ready?this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.battle_hide_loading):(this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.battle_hide_loading),this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.battle_vs_start)},.5,"start_animation"),this.scheduleUpdate()),this.unschedule("TEAMREADY"))}.bind(this),0,cc.REPEAT_FOREVER,0,"TEAMREADY")}},getLeftTeam:function(){return this.m_left_team},getRightTeam:function(){return this.m_right_team},setScriptViewReady:function(isReady){this.m_is_script_ready=isReady},scriptHideAndVSStart:function(){this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.battle_vs_start)},.5,"start_animation"),this.scheduleUpdate()},createBackground:function(game_type){this.m_bg=new ParallaxNode,this.m_base_layer.addChild(this.m_bg),game_type==db.BattleGameType.EventMussangBossDungeon?(this.m_background_res.push(RES_CDN_DEFULT+"menu_vs/bg_vs_boss_ground.jpg"),this.m_background_res.push(RES_CDN_DEFULT+"menu_vs/bg_vs_boss_close.png")):game_type==db.BattleGameType.EventRaidDungeon&&(this.m_background_res.push(RES_CDN_DEFULT+"menu_vs/bg_vs_boss_ground.jpg"),this.m_background_res.push(RES_CDN_DEFULT+"menu_vs/bg_vs_boss_close.png")),resourceLoader(this.m_background_res,function(){(s=new ScrollableNode).setAnchorPoint(0,0),s.setPosition(0,0),s.setRatio(cc.p(-700,0));var bg=null;game_type==db.BattleGameType.Prologue||(game_type==db.BattleGameType.EventMussangBossDungeon?bg=new cc.Sprite(RES_CDN_DEFULT+"menu_vs/bg_vs_boss_ground.jpg"):game_type==db.BattleGameType.EventRaidDungeon&&(bg=new cc.Sprite(RES_CDN_DEFULT+"menu_vs/bg_vs_boss_ground.jpg"))),null!=bg&&(bg.setAnchorPoint(0,0),USE_BATTLE_STAGE_FIELD&&(bg.setContentSize(2*cc.size(bg).width,2*cc.size(bg).height),bg.setScale(2)),bg.getTexture().setAliasTexParameters(),s.addScrollableObject(bg)),bg=null,0<s.getScrollableObjectsLength()&&(this.m_ground_layer.addChild(s,-10),this.m_bg.addParallaxObject(s)),s=null,(s=new ScrollableNode).setAnchorPoint(0,0),s.setPosition(0,0),s.setRatio(cc.p(-750,0));var s;bg=null;game_type==db.BattleGameType.Prologue||(game_type==db.BattleGameType.EventMussangBossDungeon?bg=new cc.Sprite(RES_CDN_DEFULT+"menu_vs/bg_vs_boss_close.png"):db.BattleGameType.EventRaidDungeon),null!=bg&&(bg.setAnchorPoint(0,0),USE_BATTLE_STAGE_FIELD&&(bg.setContentSize(2*cc.size(bg).width,2*cc.size(bg).height),bg.setScale(2)),bg.getTexture().setAliasTexParameters(),s.addScrollableObject(bg)),bg=null,0<s.getScrollableObjectsLength()&&(this.m_root_layer.addChild(s,2e3),this.m_bg.addParallaxObject(s)),s=null,(s=new ScrollableNode).setAnchorPoint(0,0),s.setPosition(0,0),s.setRatio(cc.p(-750,0));bg=null;game_type==db.BattleGameType.Prologue||game_type==db.BattleGameType.EventMussangBossDungeon||game_type==db.BattleGameType.EventRaidDungeon&&(bg=new cc.Sprite(RES_CDN_DEFULT+"menu_vs/bg_vs_boss_close.png")),null!=bg&&(bg.setAnchorPoint(0,0),USE_BATTLE_STAGE_FIELD&&(bg.setContentSize(2*cc.size(bg).width,2*cc.size(bg).height),bg.setScale(2)),bg.getTexture().setAliasTexParameters(),s.addScrollableObject(bg)),bg=null,0<s.getScrollableObjectsLength()&&(this.m_root_layer.addChild(s,2001),this.m_bg.addParallaxObject(s)),s=null}.bind(this))},takeUpDropItems:function(){if(null!=this.m_bg&&this.m_bg.show(!0),0!=this.m_drop_items.length)for(var i=0;i<this.m_drop_items.length;i++){this.m_drop_items[i].takeUp()}},update:function(dt){if(this.m_is_game_pause)return this.m_left_team.pauseTeam(),void this.m_right_team.pauseTeam();switch(this.m_state>=BattleState.GamePlaying&&(this.m_left_team.step(dt),this.m_right_team.step(dt)),this.last_state!=this.m_state&&(this.last_state=this.m_state,cc.log("== current BattleState="+this.m_state)),this.m_state){case BattleState.GameReady:case BattleState.GameStart:case BattleState.GameAppear:case BattleState.GameCounting:case BattleState.GameBeforeStageTerm:break;case BattleState.GamePlaying:if(this.m_right_team.IsAllDead()){if(this.m_delta_time=0,null!=this.m_bg&&this.m_bg.show(!0),this.m_right_team.IsCutinStage()){BattleContext._getInstance().setEventDungeonCutinComplete(!0),this.m_state=BattleState.GameRightCutinClearWait;for(var bossteam=this.m_right_team.getTeamMembers(),member_idx=0;member_idx<bossteam.length;member_idx++)bossteam[member_idx].getGeneral().is_zoom&&bossteam[member_idx].playVoicePart(voice_npc_boss_battle_win)}else this.m_state=BattleState.GameRightDeathWait;return this.m_right_team.HasNextStage()||this.m_left_team.battleAllRemoveDurationEffects(),this.m_left_team.battleBackCourt(),this.ChangeBGEnd(),void this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.battle_stop_timer)}if(this.m_left_team.IsAllDead()){this.m_delta_time=0,this.m_state=BattleState.GameLeftDeathWait,null!=this.m_bg&&this.m_bg.show(!0);for(var bossteam2=this.m_right_team.getTeamMembers(),member_idx2=0;member_idx2<bossteam2.length;member_idx2++)bossteam2[member_idx2].getGeneral().is_zoom&&bossteam2[member_idx2].playVoicePart(voice_npc_boss_battle_lose);return this.m_right_team.battleBackCourt(),this.ChangeBGEnd(),void this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.battle_stop_timer)}break;case BattleState.GameLeftDeathWait:this.m_right_team.IsPreparedBackcourt()&&(this.takeUpDropItems(),this.m_delta_time=0,this.m_state=BattleState.GameBackCourt);break;case BattleState.GameRightDeathWait:this.m_left_team.IsPreparedBackcourt()?(this.takeUpDropItems(),this.m_delta_time=0,this.m_state=BattleState.GameBackCourt):(this.m_delta_time+=dt*this.m_cur_battle_timescale,3<this.m_delta_time&&(this.m_delta_time=0,this.takeUpDropItems(),this.m_delta_time=0,this.m_state=BattleState.GameBackCourt));break;case BattleState.GameRightCutinClearWait:case BattleState.GameRightTimeOutWait:break;case BattleState.GameRightAwayWait:this.m_left_team.IsPreparedBackcourt()&&(this.takeUpDropItems(),this.m_delta_time=0,this.m_state=BattleState.GameEventCutinBackCourt);break;case BattleState.GameAllDeathWait:break;case BattleState.GameTimeOut:this.m_left_team.IsPreparedBackcourt()&&this.m_right_team.IsPreparedBackcourt()&&(this.takeUpDropItems(),this.m_delta_time=0,this.m_game_type==db.BattleGameType.DailyDungeon?this.m_state=BattleState.GameDailyBackCourt:this.m_game_type==db.BattleGameType.WorldWarNpcDungeon?this.m_state=BattleState.GameWorldWarNpcDungeonBackCourt:this.m_game_type==db.BattleGameType.EventRaidDungeon&&(this.m_state=BattleState.GameEventRaidTimeOver,BattleContext._getInstance().setEventRaidTimeOut(!0)));break;case BattleState.GameDailyBackCourt:this.dailyGameBackCourt(dt);break;case BattleState.GameEventCutinBackCourt:this.eventDungeonCutinBackCourt(dt);break;case BattleState.GameWorldWarNpcDungeonBackCourt:this.worldWarNpcDungeonBackCourt(dt);break;case BattleState.GameEventRaidTimeOver:this.EventRaidBackCourt(dt);break;case BattleState.GameBackCourt:this.gameBackCourt(dt);break;case BattleState.GameWait:break;case BattleState.GameWait_Trasition:this.m_delta_time=0,this.m_bg.startParallax(this.m_cur_battle_timescale),this.m_color_layer.isRunning()&&this.m_color_layer.stopAllActions(),this.m_color_layer.setOpacity(0),this.m_left_team.battleRun(),this.m_right_team.battleClearTeamDisplay(),this.m_state=BattleState.GameNextMoving;break;case BattleState.GameNextMoving:break;case BattleState.GameAppearEnemy:var right_team_members=this.m_right_team.getTeamMembers(),left_team_members=this.m_left_team.getTeamMembers();this.m_state=BattleState.GamePlaying;for(var boss=null,friend_general=null,member_idx3=0;member_idx3<right_team_members.length;member_idx3++)right_team_members[member_idx3].getGeneral().is_zoom&&(boss=right_team_members[member_idx3]);if(null!=boss){for(var member_idx4=0;member_idx4<left_team_members.length;member_idx4++)left_team_members[member_idx4].IsFriend()&&(friend_general=left_team_members[member_idx4]);null==friend_general?boss.find_voice_use(voice_npc_boss_appear)||boss.playVoicePart(voice_npc_boss_appear):null!=friend_general&&(boss.find_voice_use(voice_npc_boss_partner_general_appear)||boss.playVoicePart(voice_npc_boss_partner_general_appear))}break;case BattleState.GameVSShow:case BattleState.GameBattleRestart:case BattleState.GamePause:case BattleState.GameOver:case BattleState.GameOver_Winner:case BattleState.GameOver_Winner_Networking:case BattleState.GameOver_Loser:case BattleState.GameOver_Loser_Networking:break;case BattleState.GameStoryTimeOver:case BattleState.GameRaidTimeOver:this.m_left_team.IsPreparedBackcourt()&&(this.m_delta_time=0,this.m_state=BattleState.GameRaidFinish);break;case BattleState.GameRaidFinish:this.m_delta_time+=dt*this.m_cur_battle_timescale,1<this.m_delta_time&&(this.m_delta_time=0,this.m_left_team.raidEnd(),this.m_right_team.raidEnd(),this.m_state=BattleState.GamePlaying);break;case BattleState.GameNewRaidBossTimeOver:this.newRaidBossBackCourt(dt);break;case BattleState.GameNewRaidBossFinish:break;case BattleState.GameWorldWarNpcDungeonTimeOver:this.m_left_team.IsPreparedBackcourt()&&(this.m_delta_time=0);break;case BattleState.GameMussangBossTimeOver:this.m_delta_time+=dt*this.m_cur_battle_timescale,2<this.m_delta_time&&(this.m_delta_time=0,this.m_left_team.MussangBossEnd(),this.m_right_team.MussangBossEnd(),this.m_state=BattleState.GamePlaying)}null!=this.m_left_team&&this.m_left_team.setBattleState(this.m_state),null!=this.m_right_team&&this.m_right_team.setBattleState(this.m_state),this.reorderingFieldObjects()},eventDungeonCutinBackCourt:function(dt){if(this.m_delta_time+=dt*this.m_cur_battle_timescale,1<this.m_delta_time){this.m_delta_time=0,this.m_right_team.teamAway(),this.m_state=BattleState.GameWait;for(var team=this.m_left_team.getTeamMembers(),idx=0;idx<team.length;idx++)team[idx].init_OneTime_Effect_Call_Wave_Begin()}},dailyGameBackCourt:function(dt){this.m_delta_time+=dt*this.m_cur_battle_timescale,1<this.m_delta_time&&(this.m_delta_time=0,this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.daily_dungeon_game_over_result)},STAGE_CLEAR_WAIT_TIME,"daily_dungeon_game_over_win"),this.m_left_team.battleEnd(),this.m_right_team.battleEnd(),this.m_state=BattleState.GameOver_Winner_Networking)},EventRaidBackCourt:function(dt){this.m_delta_time+=dt*this.m_cur_battle_timescale,1<=this.m_delta_time&&(this.m_delta_time=0,this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.event_raid_dungeon_game_over_timeout)},STAGE_CLEAR_WAIT_TIME,"event_raid_dungeon_game_over_timeout"),this.m_left_team.battleEnd(),this.m_right_team.battleEnd(),this.m_state=BattleState.GameOver_Loser_Networking)},newRaidBossBackCourt:function(dt){this.m_delta_time+=dt*this.m_cur_battle_timescale,1<=this.m_delta_time&&(this.m_delta_time=0,this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.new_raid_boss_game_over_result)},STAGE_CLEAR_WAIT_TIME,"new_raid_boss_game_over_result"),this.m_left_team.battleEnd(),this.m_right_team.battleEnd(),this.m_state=BattleState.GameOver_Loser_Networking)},worldWarNpcDungeonBackCourt:function(dt){this.m_delta_time+=dt*this.m_cur_battle_timescale,1<this.m_delta_time&&(this.m_delta_time=0,this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.world_war_npc_dungeon_game_over_timeout)},STAGE_CLEAR_WAIT_TIME,"world_war_npc_dungeon_game_over_timeout"),this.m_left_team.battleEnd(),this.m_right_team.battleEnd(),this.m_state=BattleState.GameOver_Winner_Networking)},gameBackCourt:function(dt){if(this.m_delta_time+=dt*this.m_cur_battle_timescale,1<this.m_delta_time){this.m_delta_time=0;for(var left_general_team=this.m_left_team.getTeamMembers(),lg_idx=0;lg_idx<left_general_team.length;lg_idx++)left_general_team[lg_idx].init_OneTime_Effect_Call_Wave_Begin();this.m_right_team.IsAllDead()&&(this.m_game_type==db.BattleGameType.Mission?this.m_main_mission.current_stage<this.m_main_mission.stage_count?(this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.battle_vs_next_stage)},STAGE_CLEAR_WAIT_TIME,"main_stage_clear"),this.m_state=BattleState.GameWait):(BattleMissionTaskManager._getInstance().addMIssionClearCount(),this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.game_over_win)},STAGE_CLEAR_WAIT_TIME,"main_mission_win"),this.m_left_team.battleEnd(),this.m_state=BattleState.GameOver_Winner_Networking):this.m_game_type==db.BattleGameType.StoryHardMode?this.m_story_hard_mode_mission.current_stage<this.m_story_hard_mode_mission.stage_count?(this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.battle_vs_next_stage)},STAGE_CLEAR_WAIT_TIME,"main_stage_clear"),this.m_state=BattleState.GameWait):(BattleStoryHardModeMissionTaskManager._getInstance().addMIssionClearCount(),this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.story_hard_mode_over_win)},STAGE_CLEAR_WAIT_TIME,"story_hard_mode_mission_win"),this.m_left_team.battleEnd(),this.m_state=BattleState.GameOver_Winner_Networking):this.m_game_type==db.BattleGameType.Mussang?this.m_mussang.current_stage<this.m_mussang.stage_count?(this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.battle_vs_next_stage)},STAGE_CLEAR_WAIT_TIME,"main_stage_clear"),this.m_state=BattleState.GameWait):(this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.mussang_step_game_over_win)},STAGE_CLEAR_WAIT_TIME,"mussang_step_game_over_win"),this.m_left_team.battleEnd(),this.m_state=BattleState.GameOver_Winner_Networking):this.m_game_type==db.BattleGameType.EventDungeon?this.m_event_dungeon.current_stage<this.m_event_dungeon.stage_count?(this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.battle_vs_next_stage)},STAGE_CLEAR_WAIT_TIME,"main_stage_clear"),this.m_state=BattleState.GameWait):(this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.event_dungeon_game_over_win)},STAGE_CLEAR_WAIT_TIME,"event_dungeon_game_over_win"),this.m_left_team.battleEnd(),this.m_state=BattleState.GameOver_Winner_Networking):this.m_game_type==db.BattleGameType.OnceADayDungeon?this.m_once_a_day_dungeon.current_stage<this.m_once_a_day_dungeon.stage_count?(this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.battle_vs_next_stage)},STAGE_CLEAR_WAIT_TIME,"main_stage_clear"),this.m_state=BattleState.GameWait):(this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.event_once_a_day_dungeon_game_over_win)},STAGE_CLEAR_WAIT_TIME,"event_once_a_day_dungeon_game_over_win"),this.m_left_team.battleEnd(),this.m_state=BattleState.GameOver_Winner_Networking):this.m_game_type==db.BattleGameType.DailyDungeon?this.m_daily_dungeon.current_stage<this.m_daily_dungeon.stage_count?(this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.battle_vs_next_stage)},STAGE_CLEAR_WAIT_TIME,"daily_dungeon_stage_clear"),this.m_state=BattleState.GameWait):(this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.daily_dungeon_game_over_result)},STAGE_CLEAR_WAIT_TIME,"event_dungeon_game_over_win"),this.m_left_team.battleEnd(),this.m_state=BattleState.GameOver_Winner_Networking):this.m_game_type==db.BattleGameType.TowerDungeon?this.m_mussang_tower_dungeon.current_stage<this.m_mussang_tower_dungeon.stage_count?(this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.battle_vs_next_stage)},STAGE_CLEAR_WAIT_TIME,"tower_dungeon_stage_clear"),this.m_state=BattleState.GameWait):(BattleTowerTaskManager._getInstance().addMussangTowerClearCount(),this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.mussang_tower_game_over_win)},STAGE_CLEAR_WAIT_TIME,"tower_dungeon_stage_game_over_win"),this.m_left_team.battleEnd(),this.m_state=BattleState.GameOver_Winner_Networking):this.m_game_type==db.BattleGameType.WeeklyDungeon?this.m_weekly_dungeon.current_stage<this.m_weekly_dungeon.stage_count?(this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.battle_vs_next_stage)},STAGE_CLEAR_WAIT_TIME,"main_stage_clear"),this.m_state=BattleState.GameWait):(this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.weekly_game_over_win)},STAGE_CLEAR_WAIT_TIME,"weekly_game_over_win"),this.m_left_team.battleEnd(),this.m_state=BattleState.GameOver_Winner_Networking):this.m_game_type==db.BattleGameType.GreatWallDungeon?this.m_great_wall_dungeon.current_stage<this.m_great_wall_dungeon.stage_count?(this.scheduleOnce(function(float){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.battle_vs_next_stage)},STAGE_CLEAR_WAIT_TIME,"main_stage_clear"),this.m_state=BattleState.GameWait):(this.scheduleOnce(function(float){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.great_wall_dungeon_game_over_win)},STAGE_CLEAR_WAIT_TIME,"great_wall_dungeon_game_over_win"),this.m_left_team.battleEnd(),this.m_state=BattleState.GameOver_Winner_Networking):this.m_game_type==db.BattleGameType.Prologue||(this.m_game_type==db.BattleGameType.RaidDungeon?this.setBattleStateForRaidDungeonClear():this.m_game_type==db.BattleGameType.NewRaidBossDungeon?this.setBattleStateForNewRaidBossDungeonEnd():this.m_game_type==db.BattleGameType.EventMussangBossDungeon||(this.m_game_type==db.BattleGameType.WorldWarNpcDungeon?(this.scheduleOnce(function(float){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.world_war_npc_dungeon_game_over_win)},STAGE_CLEAR_WAIT_TIME,"world_war_npc_dungeon_game_over_win"),this.m_state=BattleState.GameOver_Winner_Networking):this.m_game_type==db.BattleGameType.EventRaidDungeon&&(this.scheduleOnce(function(float){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.event_raid_dungeon_game_over_win)},STAGE_CLEAR_WAIT_TIME,"event_raid_dungeon_game_over_win"),this.m_state=BattleState.GameOver_Winner_Networking))))}else if(this.m_left_team.IsAllDead()){BattleContext._getInstance();var is_win=!1;if(this.m_game_type==db.BattleGameType.Mission){var is_mission_win=BattleContext._getInstance().getMissionWin();this.m_main_mission.main_mission_id==YEOWA_STAGE_ID&&is_mission_win&&(BattleContext._getInstance().setMissionWin(!1),is_win=!0),is_win?(BattleMissionTaskManager._getInstance().addMIssionClearCount(),this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.game_over_win)},STAGE_LOSE_WAIT_TIME,"main_mission_win"),this.m_left_team.battleEnd(),this.m_state=BattleState.GameOver_Winner_Networking):this.m_right_team.IsAllDead()?this.m_main_mission.current_stage<this.m_main_mission.stage_count?this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.game_over_lose)},STAGE_LOSE_WAIT_TIME,"main_mission_lose"):(BattleMissionTaskManager._getInstance().addMIssionClearCount(),this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.game_over_win)},STAGE_CLEAR_WAIT_TIME,"main_mission_win"),this.m_left_team.battleEnd(),this.m_state=BattleState.GameOver_Winner_Networking):this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.game_over_lose)},STAGE_LOSE_WAIT_TIME,"main_mission_lose")}else this.m_game_type==db.BattleGameType.StoryHardMode?this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.story_hard_mode_over_lose)},STAGE_LOSE_WAIT_TIME,"story_hard_mode_dungeon_lose"):this.m_game_type==db.BattleGameType.WeeklyDungeon?this.m_right_team.IsAllDead()?this.m_weekly_dungeon.current_stage<this.m_weekly_dungeon.stage_count?this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.weekly_game_over_lose)},STAGE_LOSE_WAIT_TIME,"weekly_dungeon_lose"):(this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.weekly_game_over_win)},STAGE_CLEAR_WAIT_TIME,"weekly_game_over_win"),this.m_left_team.battleEnd(),this.m_state=BattleState.GameOver_Winner_Networking):this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.weekly_game_over_lose)},STAGE_LOSE_WAIT_TIME,"weekly_dungeon_lose"):this.m_game_type==db.BattleGameType.Mussang?this.m_right_team.IsAllDead()?this.m_mussang.current_stage<this.m_mussang.stage_count?this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.mussang_step_game_over_lose)},STAGE_LOSE_WAIT_TIME,"mussang_step_game_over_lose"):(this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.mussang_step_game_over_win)},STAGE_CLEAR_WAIT_TIME,"mussang_step_game_over_win"),this.m_left_team.battleEnd(),this.m_state=BattleState.GameOver_Winner_Networking):this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.mussang_step_game_over_lose)},STAGE_LOSE_WAIT_TIME,"mussang_step_game_over_lose"):this.m_game_type==db.BattleGameType.EventDungeon?this.m_right_team.IsAllDead()?this.m_event_dungeon.current_stage<this.m_event_dungeon.stage_count?this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.event_dungeon_game_over_lose)},STAGE_LOSE_WAIT_TIME,"event_dungeon_game_over_lose"):(this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.event_dungeon_game_over_win)},STAGE_CLEAR_WAIT_TIME,"event_dungeon_game_over_win"),this.m_left_team.battleEnd(),this.m_state=BattleState.GameOver_Winner_Networking):this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.event_dungeon_game_over_lose)},STAGE_LOSE_WAIT_TIME,"event_dungeon_game_over_lose"):this.m_game_type==db.BattleGameType.OnceADayDungeon?this.m_right_team.IsAllDead()?this.m_once_a_day_dungeon.current_stage<this.m_once_a_day_dungeon.stage_count?this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.event_once_a_day_dungeon_game_over_lose)},STAGE_LOSE_WAIT_TIME,"event_once_a_day_dungeon_game_over_lose"):(this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.event_once_a_day_dungeon_game_over_win)},STAGE_CLEAR_WAIT_TIME,"event_once_a_day_dungeon_game_over_win"),this.m_left_team.battleEnd(),this.m_state=BattleState.GameOver_Winner_Networking):this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.event_once_a_day_dungeon_game_over_lose)},STAGE_LOSE_WAIT_TIME,"event_once_a_day_dungeon_game_over_lose"):this.m_game_type==db.BattleGameType.DailyDungeon||(this.m_game_type==db.BattleGameType.Prologue?this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.prologue_game_over_lose)},STAGE_LOSE_WAIT_TIME,"prologue_lose"):this.m_game_type==db.BattleGameType.RaidDungeon?this.setBattleStateForRaidDungeonClear():this.m_game_type==db.BattleGameType.NewRaidBossDungeon?this.setBattleStateForNewRaidBossDungeonEnd():this.m_game_type==db.BattleGameType.GreatWallDungeon?this.m_right_team.IsAllDead()?this.m_great_wall_dungeon.current_stage<this.m_great_wall_dungeon.stage_count?this.scheduleOnce(function(float){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.great_wall_dungeon_game_over_lose)},STAGE_LOSE_WAIT_TIME,"great_wall_dungeon_game_over_lose"):(this.scheduleOnce(function(float){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.great_wall_dungeon_game_over_win)},STAGE_CLEAR_WAIT_TIME,"great_wall_dungeon_game_over_win"),this.m_left_team.battleEnd(),this.m_state=BattleState.GameOver_Winner_Networking):this.scheduleOnce(function(float){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.great_wall_dungeon_game_over_lose)},STAGE_LOSE_WAIT_TIME,"great_wall_dungeon_game_over_lose"):this.m_game_type==db.BattleGameType.TowerDungeon?this.m_right_team.IsAllDead()?this.m_mussang_tower_dungeon.current_stage<this.m_mussang_tower_dungeon.stage_count?this.scheduleOnce(function(float){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.mussang_tower_game_over_lose)},STAGE_LOSE_WAIT_TIME,"mussang_tower_game_over_lose"):(BattleTowerTaskManager._getInstance().addMussangTowerClearCount(),this.scheduleOnce(function(){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.mussang_tower_game_over_win)},STAGE_CLEAR_WAIT_TIME,"tower_dungeon_stage_game_over_win"),this.m_left_team.battleEnd(),this.m_state=BattleState.GameOver_Winner_Networking):this.scheduleOnce(function(float){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.mussang_tower_game_over_lose)},STAGE_LOSE_WAIT_TIME,"mussang_tower_game_over_lose"):this.m_game_type==db.BattleGameType.EventMussangBossDungeon?this.m_right_team.IsAllDead()?(this.scheduleOnce(function(float){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.mussang_boss_game_over_win)},STAGE_CLEAR_WAIT_TIME,"mussang_boss_game_over_win"),this.m_state=BattleState.GameOver_Winner_Networking):this.scheduleOnce(function(float){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.mussang_boss_game_over_lose)},STAGE_LOSE_WAIT_TIME,"mussang_boss_game_over_lose"):this.m_game_type==db.BattleGameType.WorldWarNpcDungeon?this.m_right_team.IsAllDead()?(this.scheduleOnce(function(float){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.world_war_npc_dungeon_game_over_win)},STAGE_CLEAR_WAIT_TIME,"world_war_npc_dungeon_game_over_win"),this.m_state=BattleState.GameOver_Winner_Networking):this.scheduleOnce(function(float){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.world_war_npc_dungeon_game_ove_lose)},STAGE_LOSE_WAIT_TIME,"world_war_npc_dungeon_game_ove_lose"):this.m_game_type==db.BattleGameType.EventRaidDungeon&&(this.m_right_team.IsAllDead()?(this.scheduleOnce(function(float){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.event_raid_dungeon_game_over_win)},STAGE_CLEAR_WAIT_TIME,"event_raid_dungeon_game_over_win"),this.m_state=BattleState.GameOver_Winner_Networking):(this.scheduleOnce(function(float){this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.event_raid_dungeon_game_over_lose)},STAGE_LOSE_WAIT_TIME,"event_raid_dungeon_game_over_lose"),this.m_state=BattleState.GameOver_Loser_Networking)));is_win||(this.m_right_team.battleEnd(),this.m_left_team.battleClearTeamDisplay(),this.m_state=BattleState.GameOver_Loser_Networking)}else;},reorderingFieldObjects:function(){if(null!=this.m_base_layer){for(var children=this.m_base_layer._children,i=0;i<children.length;i++)if(null!=children[i])try{if(children[i].IsExReordering()){var zorder=winSize.height;this.m_base_layer.reorderChild(children[i],zorder)}else{zorder=parseInt(winSize.height-children[i].getPositionY()+children[i].getOrderingOffsetY());this.m_base_layer.reorderChild(children[i],zorder)}}catch(e){if(999999!=children[i].getTag())if(null!=children[i].m_skeleton)if(null!=children[i].m_skeleton){zorder=parseInt(winSize.height-children[i].getPositionY()+children[i].getOrderingOffsetY());this.m_base_layer.reorderChild(children[i],zorder)}else{zorder=parseInt(winSize.height-children[i].getPositionY());this.m_base_layer.reorderChild(children[i],zorder)}else{zorder=parseInt(winSize.height-children[i].getPositionY());this.m_base_layer.reorderChild(children[i],zorder)}}else if(999999!=children[i].getTag())if(null!=children[i].m_skeleton)if(null!=children[i].m_skeleton){zorder=parseInt(winSize.height-children[i].getPositionY()+children[i].getOrderingOffsetY());this.m_base_layer.reorderChild(children[i],zorder)}else{zorder=parseInt(winSize.height-children[i].getPositionY());this.m_base_layer.reorderChild(children[i],zorder)}else{zorder=parseInt(winSize.height-children[i].getPositionY());this.m_base_layer.reorderChild(children[i],zorder)}children=null}},hideVSLayer:function(){var snd,audio=AudioEngine.getInstance();if(this.m_game_type==db.BattleGameType.Mission);else if(this.m_game_type==db.BattleGameType.StoryHardMode);else if(this.m_game_type==db.BattleGameType.WeeklyDungeon)snd="BGM_Battle_Mid_Boss_New_Ver_Master_loop.mp3";else if(this.m_game_type==db.BattleGameType.EventDungeon)if(USE_EVENT_DUNGEON_BGM){var period=MasterManager.getInstance().get_EventDungeonPeriod(this.m_event_dungeon.event_dungeon_period.event_dungeon_period_idx);snd=""!=period.bgm&&null!=period.bgm&&null!=period.bgm?period.bgm+".mp3":"BGM_Battle_marathon_"+this.m_event_dungeon.event_dungeon.event_dungeon_period_idx+".mp3"}else snd="BGM_Battle_marathon_"+this.m_event_dungeon.event_dungeon.event_dungeon_period_idx+".mp3";else if(this.m_game_type==db.BattleGameType.DailyDungeon)snd="BGM_Battle.mp3";else if(this.m_game_type==db.BattleGameType.GreatWallDungeon)snd="BGM_Battle.mp3";else if(this.m_game_type==db.BattleGameType.TowerDungeon)snd="BGM_Battle_Stage_Master_loop.mp3";else if(this.m_game_type==db.BattleGameType.OnceADayDungeon)snd="BGM_Battle_Stage_Master_loop.mp3";else if(this.m_game_type==db.BattleGameType.WorldWarNpcDungeon)snd="BGM_Battle_world_war.mp3";else if(this.m_game_type==db.BattleGameType.NewRaidBossDungeon){snd=MasterTable.getInstance().get_Bgm_v2(BGM_TYPE_NEW_RAID_BOSS_BATTLE_BGM).sound_file_name}else snd="BGM_Battle_Stage_Master_loop.mp3";if(this.m_game_type!=db.BattleGameType.Mission&&this.m_game_type!=db.BattleGameType.StoryHardMode){var path=RES_CDN_SOUND+SND_TYPE+"sound/"+snd;audio.m_bgmPath!=path&&audio.playBackgroundMusic(path,!0)}},setGamePlaying:function(){this.m_state=BattleState.GamePlaying,this.m_left_team.battleStart(),this.m_right_team.battleStart()},setNewRaidDungeonSkill:function(){this.setBattleState(BattleState.GameBeforeStageTerm),this.m_right_team.preBattleDungeonSkillExec()},dropItem:function(gnrl){var target_pos=cc.p(ccWidth(this)-160,ccHeight(this)-30),drop_item=new BattleDropItem(target_pos,this.cbGainDropItem.bind(this),this.m_right_team.IsCutinStage());drop_item.setPosition(gnrl.getPosition()),this.m_base_layer.addChild(drop_item),drop_item.dropItem(),this.m_drop_items.push(drop_item)},dropItemCheck:function(gnrl){var current_stage=0;if(this.m_game_type==db.BattleGameType.Mission?current_stage=this.m_main_mission.current_stage:this.m_game_type==db.BattleGameType.StoryHardMode?current_stage=this.m_story_hard_mode_mission.current_stage:this.m_game_type==db.BattleGameType.WeeklyDungeon?current_stage=this.m_weekly_dungeon.current_stage:this.m_game_type==db.BattleGameType.EventDungeon&&(current_stage=1),!(this.m_stage_drop_items.length<current_stage)){var remain_count=this.m_stage_drop_items[current_stage-1];if(0!=remain_count)if(this.m_right_team.IsCutinStage()){for(var i=0;i<remain_count;i++)this.dropItem(gnrl);this.m_stage_drop_items[current_stage-1]=0}else{if(remain_count<this.m_right_team.getAliveMemberCount()+1)parseInt(100*Math.random())<40&&(this.dropItem(gnrl),remain_count--,this.m_stage_drop_items[current_stage-1]=remain_count);else this.dropItem(gnrl),remain_count--,this.m_stage_drop_items[current_stage-1]=remain_count}}},cbGainDropItem:function(item){for(var i=0;i<this.m_drop_items.length;i++)this.m_drop_items[i]==item&&this.m_drop_items.splice(i,1);this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.gain_item_add_count)},newStageBattleStart:function(){this.m_bg.stopParallax(),this.m_state=BattleState.GameVSShow,this.m_left_team.battleStopRun(),this.m_game_type==db.BattleGameType.Mission?(this.m_right_team.battleNextTeam(this.m_main_mission.current_stage),this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.battle_vs_start+this.m_main_mission.current_stage)):this.m_game_type==db.BattleGameType.StoryHardMode?(this.m_right_team.battleNextTeam(this.m_story_hard_mode_mission.current_stage),this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.battle_vs_start+this.m_story_hard_mode_mission.current_stage)):this.m_game_type==db.BattleGameType.Mussang?(this.m_right_team.battleNextTeam(this.m_mussang.current_stage),this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.battle_vs_start+this.m_mussang.current_stage)):this.m_game_type==db.BattleGameType.EventDungeon?(this.m_right_team.battleNextTeam(this.m_event_dungeon.current_stage),this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.battle_vs_start+this.m_event_dungeon.current_stage)):this.m_game_type==db.BattleGameType.OnceADayDungeon?(this.m_right_team.battleNextTeam(this.m_once_a_day_dungeon.current_stage),this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.battle_vs_start+this.m_once_a_day_dungeon.current_stage)):this.m_game_type==db.BattleGameType.WeeklyDungeon?(this.m_right_team.battleNextTeam(this.m_weekly_dungeon.current_stage),this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.battle_vs_start+this.m_weekly_dungeon.current_stage)):this.m_game_type==db.BattleGameType.GreatWallDungeon?(this.m_right_team.battleNextTeam(this.m_great_wall_dungeon.current_stage),this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.battle_vs_start+this.m_great_wall_dungeon.current_stage)):this.m_game_type==db.BattleGameType.DailyDungeon||(this.m_game_type,db.BattleGameType.WorldWarNpcDungeon)},nextStageMoving:function(){this.m_change_bg.isVisible()&&this.m_change_bg.setVisible(!1),this.m_right_team.showGenerals(!0),this.m_left_team.showGenerals(!0),this.m_hide_begin_end=!1,this.m_state!=BattleState.GameWait&&this.m_state!=BattleState.GameEventCutinBackCourt&&this.m_state!=BattleState.GameRightAwayWait&&this.m_state!=BattleState.GameRightTimeOutWait&&this.m_state!=BattleState.GameRightCutinClearWait||(this.m_game_type==db.BattleGameType.Mission?this.m_main_mission.current_stage<this.m_main_mission.stage_count?(this.m_main_mission.current_stage++,this.m_state=BattleState.GameWait_Trasition):this.m_state=BattleState.GameOver:this.m_game_type==db.BattleGameType.StoryHardMode?this.m_story_hard_mode_mission.current_stage<this.m_story_hard_mode_mission.stage_count?(this.m_story_hard_mode_mission.current_stage++,this.m_state=BattleState.GameWait_Trasition):this.m_state=BattleState.GameOver:this.m_game_type==db.BattleGameType.WeeklyDungeon?this.m_weekly_dungeon.current_stage<this.m_weekly_dungeon.stage_count?(this.m_weekly_dungeon.current_stage++,this.m_state=BattleState.GameWait_Trasition):this.m_state=BattleState.GameOver:this.m_game_type==db.BattleGameType.Mussang?this.m_mussang.current_stage<this.m_mussang.stage_count?(this.m_mussang.current_stage++,this.m_state=BattleState.GameWait_Trasition):this.m_state=BattleState.GameOver:this.m_game_type==db.BattleGameType.TowerDungeon?this.m_mussang_tower_dungeon.current_stage<this.m_mussang_tower_dungeon.stage_count?(this.m_mussang_tower_dungeon.current_stage++,this.m_state=BattleState.GameWait_Trasition):this.m_state=BattleState.GameOver:this.m_game_type==db.BattleGameType.EventDungeon?this.m_event_dungeon.current_stage<this.m_event_dungeon.stage_count?(this.m_event_dungeon.current_stage++,this.m_state=BattleState.GameWait_Trasition):this.m_state=BattleState.GameOver:this.m_game_type==db.BattleGameType.OnceADayDungeon?this.m_once_a_day_dungeon.current_stage<this.m_once_a_day_dungeon.stage_count?(this.m_once_a_day_dungeon.current_stage++,this.m_state=BattleState.GameWait_Trasition):this.m_state=BattleState.GameOver:this.m_game_type==db.BattleGameType.GreatWallDungeon?this.m_great_wall_dungeon.current_stage<this.m_great_wall_dungeon.stage_count?(this.m_great_wall_dungeon.current_stage++,this.m_state=BattleState.GameWait_Trasition):this.m_state=BattleState.GameOver:this.m_game_type==db.BattleGameType.WorldWarNpcDungeon?this.m_world_war_npc_dungeon.current_stage<this.m_world_war_npc_dungeon.stage_count?(this.m_world_war_npc_dungeon.current_stage++,this.m_state=BattleState.GameWait_Trasition):this.m_state=BattleState.GameOver:this.m_game_type==db.BattleGameType.DailyDungeon||(this.m_game_type,db.BattleGameType.Prologue,this.m_state=BattleState.GameOver))},DamageShow:function(damage_type,damage,target,hit_point){var loc=cc.p(0,0);loc.x=target.getPositionX(),loc.y=target.getPositionY();var loc_hitpoint=target.hitPoint(hit_point);loc.x=loc.x+loc_hitpoint.x,loc.y=loc.y+loc_hitpoint.y,loc.y+=40;var label=this.recycledDamage(damage_type);label.setPosition(loc);var str="";str=damage_type==database.DamageType.Dot_Bleeding||damage_type==database.DamageType.Dot_Electric||damage_type==database.DamageType.Dot_Poison||damage_type==database.DamageType.Dot_Freeze?"-"+parseInt(damage):damage_type==database.DamageType.Heal||damage_type==database.DamageType.Reborn_Heal?"+"+parseInt(damage):damage_type==database.DamageType.Miss?"":""+parseInt(damage),label.setLabelString(str),label.playAnimation()},cbDamageShowEnded:function(sender){null},recycledDamage:function(d_type){var dmg=new BattleDamage(d_type);return this.m_damage_layer.addChild(dmg),dmg._call_func=this,dmg},EventListenerFromGeneral:function(action,evt){switch(action){case EventCode.EVT_FIELD_MNG_CHANGE_BG_BEGIN:this.ChangeBGBegin(evt.stringValue,evt.intValue);break;case EventCode.EVT_FIELD_MNG_CHANGE_BG_END:this.ChangeBGEnd();break;case EventCode.EVT_FIELD_MNG_ENEMY_HIDE_BEGIN:this.hideEnemeyBegin(evt.intValue);break;case EventCode.EVT_FIELD_MNG_ENEMY_HIDE_END:this.hideEnemeyEnd(evt.intValue);break;case EventCode.EVT_FIELD_MNG_START:break;case EventCode.EVT_FIELD_MNG_DAMAGE_SHOW:var damage_type=evt.intValue,gnrl=evt.dataValue1;this.DamageShow(damage_type,evt.floatValue,gnrl,1);break;case EventCode.EVT_FIELD_MNG_SHAKE:var strength=cc.size(evt.intValue,evt.intValue);this.ScreenShake(strength,evt.floatValue);break;case EventCode.EVT_FIELD_MNG_EMERGENCY:this.ScreenEmergency(evt.floatValue);break;case EventCode.EVT_FIELD_MNG_CHANGE_BG_COLOR:if(null!=evt.stringValue){var rgb=evt.stringValue.split(",");if(3==rgb.length){var color=cc.color(rgb[0],rgb[1],rgb[2]);this.ScreenChangeColor(evt.floatValue,200,color)}else this.ScreenChangeColor(evt.floatValue,140,cc.color(0,0,0))}break;case EventCode.EVT_FIELD_MNG_GNRL_DEATH_AT:null!=evt.dataValue1&&(this.m_left_team.battleGeneralDead(evt.dataValue1),this.m_right_team.battleGeneralDead(evt.dataValue1));break;case EventCode.EVT_TEAM_MNG_START:case EventCode.EVT_UI_MNG_START:break;case EventCode.EVT_FIELD_MNG_DROP_ITEM:this.dropItemCheck(evt.dataValue1);break;case EventCode.EVT_FIELD_MNG_GAME_PLAYING_FROM_DUNGEON_SKILL:this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.battle_start_from_dungeon_skill)}},ChangeBGBegin:function(bg_img,flip_x){null==flip_x&&(flip_x=0),this.m_change_bg.setVisible(!0);var frame=RES_CDN_DEFULT+"skill_bg/"+bg_img+".png",frame1_texture=cc.textureCache.getTextureForKey(frame);null!=frame1_texture&&null!=frame1_texture||(frame1_texture=cc.textureCache.addImage(frame));var frame1=new cc.SpriteFrame(frame1_texture,cc.rect(0,0,frame1_texture.getContentSize().width,frame1_texture.getContentSize().height));this.m_change_bg.setSpriteFrame(frame1),this.m_change_bg.setFlippedX(0!=flip_x),this.m_change_bg.opacity=0;var fi=cc.fadeIn(.4);this.m_change_bg.runAction(fi),this.m_bg.show(!1)},ChangeBGEnd:function(){this.m_change_bg.setVisible(!1),this.m_bg.show(!0)},hideEnemeyBegin:function(_team_type){this.m_left_team.showGenerals(!1),this.m_right_team.showGenerals(!1),this.m_hide_begin_end=!1},hideEnemeyEnd:function(_team_type){this.m_right_team.showGenerals(!0),this.m_left_team.showGenerals(!0),this.m_hide_begin_end=!0},ScreenShake:function(strength,duration){this.m_base_layer.isRunning()&&(this.m_base_layer.stopAllActions(),this.m_base_layer.setPosition(ccCenter(this)));var shake=new Shake(duration/this.m_cur_battle_timescale,strength.width,strength.height);this.m_base_layer.runAction(shake)},ScreenWarning:function(times){this.m_warning_layer.isRunning()&&(this.m_warning_layer.stopAllActions(),this.m_warning_layer.setVisible(!1)),this.m_warning_layer.setVisible(!0),this.m_warning_layer.setOpacity(0),this.m_warning_layer.setColor(cc.color(255,0,0));var fade1=cc.fadeTo(.35,200),fade2=cc.fadeTo(.35,0),fade_seq=cc.sequence(fade1,fade2),repeat=cc.repeat(fade_seq,times),cb=cc.callFunc(this.cbScreenWarning,this),seq=cc.sequence(repeat,cb);this.m_warning_layer.runAction(seq)},cbScreenWarning:function(){this.m_warning_layer.setVisible(!1)},ScreenEmergency:function(duration){this.m_warning_layer.isRunning()&&(this.m_warning_layer.stopAllActions(),this.m_warning_layer.setVisible(!1)),this.m_warning_layer.setVisible(!0),this.m_warning_layer.setOpacity(0),this.m_warning_layer.setColor(cc.color(255,255,255));var fade1=cc.fadeTo(.1,200),fade2=cc.fadeTo(.1,0),fade_seq=cc.sequence(fade1,fade2),times=Math.ceil(duration/this.m_cur_battle_timescale*.2),repeat=cc.repeat(fade_seq,times),cb=cc.callFunc(this.cbScreenWarning,this),seq=cc.sequence(repeat,cb);this.m_warning_layer.runAction(seq)},ScreenChangeColor:function(duration,opacity,color){duration+=2.8,this.m_color_layer.isRunning()&&this.m_color_layer.stopAllActions(),this.m_color_layer.setVisible(!0),this.m_color_layer.setOpacity(0),this.m_color_layer.setColor(cc.color(color.r,color.g,color.b));var fadein=cc.fadeTo(.2,opacity),d=(duration-.4)/this.m_cur_battle_timescale,delay=cc.delayTime(d),fadeout=cc.fadeOut(.2),cb=cc.callFunc(this.cbScreenChangeColor,this),seq=cc.sequence(fadein,delay,fadeout,cb);this.m_color_layer.runAction(seq),null!=this.m_bg&&this.m_bg.nearChangeBackgroundColor(color,opacity,duration/this.m_cur_battle_timescale)},cbScreenChangeColor:function(sender){this.m_color_layer.setVisible(!1)},autoSkillValueChanged:function(){this.m_is_auto_skill=GameDefault.getInstance().getUserAutoSkill(),this.m_left_team.setAutoSkill(this.m_is_auto_skill)},setBattleTimeScale:function(timescale){this.m_cur_battle_timescale=timescale,this.m_left_team.setBattleTimeScale(timescale),this.m_right_team.setBattleTimeScale(timescale)},addFxNode:function(node){switch(node.getFxLayerType()){case database.FxLayerType.FxLayer_BGLayer:case database.FxLayerType.FxLayer_ColorLayer:break;case database.FxLayerType.FxLayer_GroundLayer:if(-1!=node.getPart().fx_id.search("_bottom"))-1!=node.getPart().fx_id.search("all_round")&&node.setPosition(ccCenter(this).x,ccCenter(this).y),this.m_ground_buf_layer.addChild(node);else this.m_ground_layer.addChild(node);break;case database.FxLayerType.FxLayer_GroundBufLayer:this.m_ground_buf_layer.addChild(node);break;case database.FxLayerType.FxLayer_AllRoundEffectCenterLayer:node.setPosition(ccCenter(this)),this.m_skill_effect_layer.addChild(node);break;case database.FxLayerType.FxLayer_HeroLayer:this.m_base_layer.addChild(node);break;case database.FxLayerType.FxLayer_AllRoundEffectLayer:this.m_skill_effect_layer.addChild(node);break;case database.FxLayerType.FxLayer_DamageLayer:case database.FxLayerType.FxLayer_EmergencyLayer:break;case database.FxLayerType.FxLayer_PersnalSkillHitLayer:this.m_skill_effect_layer.addChild(node)}},battleReady:function(stage){stage<2&&this.m_left_team.battleReady(),this.m_right_team.battleReady(),this.m_left_team.add_Onetime_Effect_Invoke_Wave_Begin(),this.m_right_team.add_Onetime_Effect_Invoke_Wave_Begin();var snd,audio=AudioEngine.getInstance();if(this.m_game_type==db.BattleGameType.Mission){if(stage<=2){snd=this.m_main_mission.mission.main_mission_num%10==0?"BGM_Battle_Last_Boss_Master_loop.mp3":this.m_main_mission.mission.main_mission_num%10==5?"BGM_Battle_Mid_Boss_Master_loop.mp3":"BGM_Battle_Stage_Master_loop.mp3";var path=RES_CDN_SOUND+SND_TYPE+"sound/"+snd;audio.m_bgmPath!=path&&audio.playBackgroundMusic(path,!0)}}else if(this.m_game_type==db.BattleGameType.StoryHardMode&&stage<=2){snd=1==this.m_story_hard_mode_mission.mission.npc_mark?"BGM_Battle_Last_Boss_Master_loop.mp3":"BGM_Battle_Stage_Master_loop.mp3";path=RES_CDN_SOUND+SND_TYPE+"sound/"+snd;audio.m_bgmPath!=path&&audio.playBackgroundMusic(path,!0)}},battleContinue:function(){this.m_left_team.battleContinue(),this.m_right_team.battleContinue(),this.m_game_type==db.BattleGameType.Mission?this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.battle_vs_start+this.m_main_mission.current_stage):this.m_game_type==db.BattleGameType.StoryHardMode?this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.battle_vs_start+this.m_story_hard_mode_mission.current_stage):this.m_game_type==db.BattleGameType.WeeklyDungeon?this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.battle_vs_start+this.m_weekly_dungeon.current_stage):this.m_game_type==db.BattleGameType.EventDungeon?this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.battle_vs_start+this.m_event_dungeon.current_stage):this.m_game_type==db.BattleGameType.OnceADayDungeon?this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.battle_vs_start+this.m_once_a_day_dungeon.current_stage):this.m_game_type==db.BattleGameType.GreatWallDungeon?this.battleObserver.postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.battle_vs_start+this.m_great_wall_dungeon.current_stage):this.m_game_type==db.BattleGameType.DailyDungeon||this.m_game_type==db.BattleGameType.TowerDungeon||(this.m_game_type,db.BattleGameType.WorldWarNpcDungeon)},pauseField:function(){this.m_is_game_pause=!0,this.m_left_team.pauseTeam(),this.m_right_team.pauseTeam(),AudioEngine.getInstance().pauseEffectsAll(),null!=this.m_bg&&this.m_bg.pauseParallax(),this.m_color_layer.pause(),this.m_warning_layer.pause(),this.m_base_layer.pause()},resumeField:function(){this.m_is_game_pause=!1,this.m_left_team.resumeTeam(),this.m_right_team.resumeTeam(),null!=this.m_bg&&this.m_bg.resumeParallax(),this.m_color_layer.resume(),this.m_warning_layer.resume(),this.m_base_layer.resume()},tutorialResumeField:function(){this.m_is_game_pause=!1},addDebug:function(d){},dailyDungeonTimeOverComplete:function(){this.m_delta_time=0,this.m_state=BattleState.GameTimeOut,null!=this.m_bg&&this.m_bg.show(!0),this.m_left_team.battleBackCourt(),this.m_right_team.battleBackCourt()},setTimeOutForWorldWarNpcDungeon:function(){this.m_delta_time=0,this.m_state=BattleState.GameTimeOut,null!=this.m_bg&&this.m_bg.show(!0),this.m_left_team.battleBackCourt(),this.m_right_team.battleBackCourt()},getBattleState:function(){return this.m_state},setBattleGameOver:function(){this.m_state=BattleState.GameOver},setMainMissionData:function(){this.m_main_mission.main_mission_id=this.m_main_mission_service.main_mission_id,this.m_main_mission.stage_count=this.m_main_mission_service.stage_count,this.m_main_mission.current_stage=this.m_main_mission_service.current_stage,this.m_main_mission.victory_count=this.m_main_mission_service.victory_count,this.m_main_mission.complete_yn=this.m_main_mission_service.complete_yn,this.m_main_mission.new_yn=this.m_main_mission_service.new_yn,this.m_main_mission.task_list=this.m_main_mission_service.task_list,this.m_main_mission.drop_gnrl_list=this.m_main_mission_service.drop_gnrl_list,this.m_main_mission.mission.main_mission_id=this.m_main_mission_service.mission.main_mission_id,this.m_main_mission.mission.comment=this.m_main_mission_service.mission.comment,this.m_main_mission.mission.complete_yn=this.m_main_mission_service.mission.complete_yn,this.m_main_mission.mission.difficulty_type=this.m_main_mission_service.mission.difficulty_type,this.m_main_mission.mission.gnrl_id1=this.m_main_mission_service.mission.gnrl_id1,this.m_main_mission.mission.gnrl_id2=this.m_main_mission_service.mission.gnrl_id2,this.m_main_mission.mission.gnrl_id3=this.m_main_mission_service.mission.gnrl_id3,this.m_main_mission.mission.gnrl_id4=this.m_main_mission_service.mission.gnrl_id4,this.m_main_mission.mission.gnrl_id5=this.m_main_mission_service.mission.gnrl_id5,this.m_main_mission.mission.gnrl_id6=this.m_main_mission_service.mission.gnrl_id6,this.m_main_mission.mission.main_mission_bonus_id=this.m_main_mission_service.mission.main_mission_bonus_id,this.m_main_mission.mission.main_mission_num=this.m_main_mission_service.mission.main_mission_num,this.m_main_mission.mission.main_scene_id=this.m_main_mission_service.mission.main_scene_id,this.m_main_mission.mission.main_story_id=this.m_main_mission_service.mission.main_story_id,this.m_main_mission.mission.name=this.m_main_mission_service.mission.name,this.m_main_mission.mission.new_yn=this.m_main_mission_service.mission.new_yn,this.m_main_mission.mission.need_key=this.m_main_mission_service.mission.need_key,this.m_main_mission.stage_npc=this.m_main_mission_service.stage_npc},setBattleStateForEventDungeonCutinTimeOut:function(){this.m_delta_time=0,this.m_state=BattleState.GameRightTimeOutWait,null!=this.m_bg&&this.m_bg.show(!0),this.m_left_team.battleCutinBackCourt(),this.m_right_team.teamAwayReady()},setBattleStateForEventDungeonAway:function(){this.m_delta_time=0,null!=this.m_bg&&this.m_bg.show(!0),this.m_state=BattleState.GameRightAwayWait},setBattleStateForEventDungeonCutinClear:function(){this.m_delta_time=0,null!=this.m_bg&&this.m_bg.show(!0),this.m_state=BattleState.GameRightDeathWait},setTimeOutForMission:function(){this.m_delta_time=0,this.m_state=BattleState.GameStoryTimeOver,null!=this.m_bg&&this.m_bg.show(!0),this.m_left_team.raidTimeoutReady(),this.m_right_team.raidTimeoutReady()},setTimeOutForNewRaidBossDungeon:function(){this.m_delta_time=0,this.m_state=BattleState.GameNewRaidBossTimeOver,null!=this.m_bg&&this.m_bg.show(!0),this.m_left_team.newRaidBossTimeoutReady(),this.m_right_team.newRaidBossTimeoutReady()},setTimeOutForRaidDungeon:function(){this.m_delta_time=0,this.m_state=BattleState.GameRaidTimeOver,null!=this.m_bg&&this.m_bg.show(!0),this.m_left_team.raidTimeoutReady(),this.m_right_team.raidTimeoutReady()},setTimeOutForMussangBoss:function(){this.m_delta_time=0,this.m_state=BattleState.GameMussangBossTimeOver,null!=this.m_bg&&this.m_bg.show(!0),this.m_left_team.MussangBossTimeOutReady(),this.m_right_team.MussangBossTimeOutReady()},setTimeOutForEventRaidDungeon:function(){this.m_delta_time=0,this.m_state=BattleState.GameTimeOut,null!=this.m_bg&&this.m_bg.show(!0),this.m_left_team.battleBackCourt(),this.m_right_team.battleBackCourt()},setBattleStateForNewRaidBossDungeonEnd:function(){this.scheduleOnce(function(float){MainObserver.getInstance().postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.new_raid_boss_game_over_result)},STAGE_CLEAR_WAIT_TIME,"new_raid_game_over_win"),this.m_left_team.battleEnd(),this.m_state=BattleState.GameOver_Winner_Networking},setBattleStateForRaidDungeonClear:function(){this.scheduleOnce(function(float){MainObserver.getInstance().postNotification(sceneStr[scene_BattleScene],BattleSceneFlag.raid_boss_game_over_result)},STAGE_CLEAR_WAIT_TIME,"raid_game_over_win"),this.m_state=BattleState.GameOver_Winner_Networking},particle_snow:function(){var size=cc.director.getWinSize(),m_emitter=new cc.ParticleSystem(900);m_emitter.texture=cc.textureCache.addImage(RES_CDN_DEFULT+"env_effect/hscene_snow_front.png"),m_emitter.angle=120,m_emitter.angleVar=360,m_emitter.duration=-1,m_emitter.emitterMode=cc.ParticleSystem.MODE_GRAVITY,m_emitter.endColor=cc.color(176,205,255,255),m_emitter.endColorVar=cc.color(0,0,0,0),m_emitter.endSize=20,m_emitter.endSizeVar=0,m_emitter.gravity=cc.p(0,-9),m_emitter.life=6,m_emitter.lifeVar=0,m_emitter.radialAccel=0,m_emitter.radialAccelVar=0,m_emitter.tangentialAccel=30,m_emitter.tangentialAccelVar=0,m_emitter.x=size.width,m_emitter.y=size.height+20,m_emitter.posVar=cc.p(size.width/.1,0),m_emitter.speed=60,m_emitter.speedVar=20,m_emitter.startSpin=30,m_emitter.startSpinVar=60,m_emitter.endSpin=60,m_emitter.endSpinVar=60,m_emitter.startColor=cc.color(176,205,255,205),m_emitter.startColorVar=cc.color(0,0,0,52),m_emitter.startSize=42,m_emitter.startSizeVar=2,m_emitter.emissionRate=100,this.m_etc_effect_layer.addChild(m_emitter,10)},getFieldId:function(_gametype){switch(_gametype){case db.BattleGameType.Mission:return this.m_main_mission.main_mission_id}return 0},setBattleState:function(_state){this.m_state=_state},resumeDureffect:function(){var l_member=this.m_left_team.getTeamMembers(),r_member=this.m_right_team.getTeamMembers();if(null!=l_member)for(var idx=0;idx<l_member.length;idx++)l_member[idx].reasumeDureffect();if(null!=r_member)for(var jdx=0;jdx<r_member.length;jdx++)r_member[jdx].reasumeDureffect()},createBackgrounDungeon:function(dungeon_type,period_idx){this.m_bg=new ParallaxNode,this.m_base_layer.addChild(this.m_bg);var winSize=cc.director.getWinSize();this.m_BackgroundDungeon_res=[];var i=0,res_folder="",sky_type=!1,distant_type=!0,jpg_type=!1;for(dungeon_type==db.BattleGameType.EventDungeon?(res_folder=9999==period_idx?"menu_battle_eventvs_present/bg_1":"menu_battle_eventvs_"+period_idx+"/bg_1",sky_type=!1,IS_SP_BROWSER&&(jpg_type=!(sky_type=distant_type=!1))):dungeon_type==db.BattleGameType.OnceADayDungeon?(period_idx==EVENT_DUNGEON_SUB_TYPE_ONCE?res_folder="menu_battle_eventvs_daily_stage/bg_1":period_idx==EVENT_DUNGEON_SUB_TYPE_ONCE_A_DAY&&(res_folder="menu_battle_eventvs_once_a_day_stage/bg_1"),sky_type=!1,IS_SP_BROWSER&&(jpg_type=!(distant_type=!1))):dungeon_type==db.BattleGameType.WeeklyDungeon?(res_folder="menu_battle_stages/bg_"+this.m_weekly_dungeon.weekly_difficulty.bg_map_type,sky_type=!0,IS_SP_BROWSER&&(jpg_type=!(sky_type=distant_type=!1))):dungeon_type==db.BattleGameType.StoryHardMode?(res_folder="new_menu_battle_hard_stages/bg_"+this.m_story_hard_mode_mission.mission.main_story_id,sky_type=!1,IS_SP_BROWSER&&(jpg_type=!(sky_type=distant_type=!1))):dungeon_type==db.BattleGameType.Mission?(res_folder="menu_battle_main_stages/bg_"+this.m_main_mission.mission.main_story_id,sky_type=2==this.m_main_mission.mission.main_story_id,IS_SP_BROWSER&&(jpg_type=!(sky_type=distant_type=!1))):dungeon_type==db.BattleGameType.Mussang&&(res_folder="menu_vs/bg_vs",sky_type=!0),i=1;i<=4;i++)1==sky_type&&this.m_BackgroundDungeon_res.push(RES_CDN_DEFULT+res_folder+"_sky_"+i+".png"),distant_type&&this.m_BackgroundDungeon_res.push(RES_CDN_DEFULT+res_folder+"_distant_"+i+".png"),jpg_type?this.m_BackgroundDungeon_res.push(RES_CDN_DEFULT+res_folder+"_ground_"+i+".jpg"):this.m_BackgroundDungeon_res.push(RES_CDN_DEFULT+res_folder+"_ground_"+i+".png"),this.m_BackgroundDungeon_res.push(RES_CDN_DEFULT+res_folder+"_closerange_"+i+".png");resourceLoader(this.m_BackgroundDungeon_res,function(){if(1==sky_type){for((s=new ScrollableNode).setAnchorPoint(ANCHOR_BOTTOM_LEFT()),s.setRatio(cc.p(-50,0)),s.setPosition(0,winSize.height),i=1;i<=4;i++){var bg=null;null!=(bg=new cc.Sprite(RES_CDN_DEFULT+res_folder+"_sky_"+i+".png"))&&(bg.setAnchorPoint(0,1),USE_BATTLE_STAGE_FIELD&&(bg.setContentSize(2*cc.size(bg).width,2*cc.size(bg).height),bg.setScale(2)),bg.texture.setAliasTexParameters(),s.addScrollableObject(bg)),bg=null}0<s.getScrollableObjectsLength()&&(this.m_ground_layer.addChild(s,-100),this.m_bg.addParallaxObject(s)),s=null}if(distant_type){for((s=new ScrollableNode).setAnchorPoint(ANCHOR_BOTTOM_LEFT()),s.setPosition(0,winSize.height),s.setRatio(cc.p(-120,0)),i=1;i<=4;i++){bg=null;null!=(bg=new cc.Sprite(RES_CDN_DEFULT+res_folder+"_distant_"+i+".png"))&&(bg.setAnchorPoint(ANCHOR_TOP_LEFT()),USE_BATTLE_STAGE_FIELD&&(bg.setContentSize(2*cc.size(bg).width,2*cc.size(bg).height),bg.setScale(2)),bg.getTexture().setAliasTexParameters(),s.addScrollableObject(bg)),bg=null}0<s.getScrollableObjectsLength()&&(this.m_ground_layer.addChild(s,-50),this.m_bg.addParallaxObject(s)),s=null}var s;for((s=new ScrollableNode).setAnchorPoint(ANCHOR_BOTTOM_LEFT()),s.setPosition(0,0),s.setRatio(cc.p(-700,0)),i=1;i<=4;i++){bg=null;null!=(bg=jpg_type?new cc.Sprite(RES_CDN_DEFULT+res_folder+"_ground_"+i+".jpg"):new cc.Sprite(RES_CDN_DEFULT+res_folder+"_ground_"+i+".png"))&&(bg.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),USE_BATTLE_STAGE_FIELD&&(bg.setContentSize(2*cc.size(bg).width,2*cc.size(bg).height),bg.setScale(2)),bg.getTexture().setAliasTexParameters(),s.addScrollableObject(bg)),bg=null}for(0<s.getScrollableObjectsLength()&&(this.m_ground_layer.addChild(s,-10),this.m_bg.addParallaxObject(s)),s=null,(s=new ScrollableNode).setAnchorPoint(ANCHOR_BOTTOM_LEFT()),s.setPosition(0,0),s.setRatio(cc.p(-750,0)),i=1;i<=4;i++){bg=null;null!=(bg=new cc.Sprite(RES_CDN_DEFULT+res_folder+"_closerange_"+i+".png"))&&(bg.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),USE_BATTLE_STAGE_FIELD&&(bg.setContentSize(2*cc.size(bg).width,2*cc.size(bg).height),bg.setScale(2)),bg.getTexture().setAliasTexParameters(),s.addScrollableObject(bg)),bg=null}for(0<s.getScrollableObjectsLength()&&(this.m_root_layer.addChild(s,2e3),this.m_bg.addParallaxObject(s)),s=null,(s=new ScrollableNode).setAnchorPoint(ANCHOR_BOTTOM_LEFT()),s.setPosition(0,0),s.setRatio(cc.p(-750,0)),i=1;i<=4;i++){bg=null;null!=(bg=new cc.Sprite(RES_CDN_DEFULT+res_folder+"_closerange_"+i+".png"))&&(bg.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),USE_BATTLE_STAGE_FIELD&&(bg.setContentSize(2*cc.size(bg).width,2*cc.size(bg).height),bg.setScale(2)),bg.getTexture().setAliasTexParameters(),s.addScrollableObject(bg)),bg=null}0<s.getScrollableObjectsLength()&&(this.m_root_layer.addChild(s,2001),this.m_bg.addParallaxObject(s)),s=null}.bind(this))},createBackgrounDungeonBG:function(dungeon_type){this.m_bg=new ParallaxNode,this.m_base_layer.addChild(this.m_bg),this.m_BackgroundDungeon_res=[];var i=0,res_folder=[],bg_type=!1,field_type=!1;if(dungeon_type==db.BattleGameType.DailyDungeon)res_folder.push("menu_dailyvs/bg_daily_dungeon.png"),res_folder.push("menu_dailyvs/bg_daily_dungeon_close.png"),bg_type=!0;else if(dungeon_type==db.BattleGameType.RaidDungeon)res_folder.push("menu_raid/bg_raid_ground.png"),res_folder.push("menu_raid/bg_raid_closerange.png"),bg_type=!0;else if(dungeon_type==db.BattleGameType.NewRaidBossDungeon)res_folder.push("new_menu_raid2/bg_raid2_ground.png"),res_folder.push("new_menu_raid2/bg_raid2_closerange.png"),bg_type=!0;else if(dungeon_type==db.BattleGameType.GreatWallDungeon)res_folder.push("menu_battle_great_wall_stage/bg_great_wall_dungeon_"+this.m_great_wall_dungeon.great_wall_dungeon.bg_type+".jpg"),res_folder.push("menu_battle_great_wall_stage/bg_great_wall_dungeon_close_"+this.m_great_wall_dungeon.great_wall_dungeon.bg_type+".png"),field_type=!0;else if(dungeon_type==db.BattleGameType.TowerDungeon)res_folder.push("menu_battle_tower_stage/bg_tower_dungeon.jpg"),res_folder.push("menu_battle_tower_stage/bg_tower_dungeon_close.png"),field_type=!0;else if(dungeon_type==db.BattleGameType.WorldWarNpcDungeon){var dungeon=MasterManager.getInstance().get_WorldWarCellInfo(this.m_world_war_npc_dungeon.world_war_cell_info_idx,this.m_world_war_npc_dungeon.period.world_war_group_idx);4==this.m_world_war_npc_dungeon.event_type?12==dungeon.world_war_move_cell_type?(res_folder.push("menu_battle_world_stage/bg_world_2.jpg"),res_folder.push("menu_battle_world_stage/bg_world_2_close.png")):(res_folder.push("menu_battle_world_stage/bg_world_3.jpg"),res_folder.push("menu_battle_world_stage/bg_world_3_close.png")):(res_folder.push("menu_battle_world_stage/bg_world_1.jpg"),res_folder.push("menu_battle_world_stage/bg_world_1_close.png")),bg_type=!0}for(i=0;i<res_folder.length;i++)this.m_BackgroundDungeon_res.push(RES_CDN_DEFULT+res_folder[i]);resourceLoader(this.m_BackgroundDungeon_res,function(){if(1==bg_type){(s=new ScrollableNode).setAnchorPoint(ANCHOR_BOTTOM_LEFT()),s.setRatio(cc.p(0,0)),s.setPosition(0,0);var bg=cc.Sprite.create(RES_CDN_DEFULT+res_folder[0]);USE_BATTLE_STAGE_FIELD&&(bg.setContentSize(2*cc.size(bg).width,2*cc.size(bg).height),bg.setScale(2)),bg.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),bg.getTexture().setAliasTexParameters(),s.addScrollableObject(bg),bg=null,0<s.getScrollableObjectsLength()&&(this.m_ground_layer.addChild(s,-100),this.m_bg.addParallaxObject(s)),s=null}1==field_type&&((s=new ScrollableNode).setAnchorPoint(ANCHOR_BOTTOM_LEFT()),s.setPosition(0,0),s.setRatio(cc.p(-700,0)),(bg=cc.Sprite.create(RES_CDN_DEFULT+res_folder[0])).setAnchorPoint(ANCHOR_BOTTOM_LEFT()),USE_BATTLE_STAGE_FIELD&&bg.setScale(2),bg.getTexture().setAliasTexParameters(),s.addScrollableObject(bg),0<s.getScrollableObjectsLength()&&(this.m_ground_layer.addChild(s,-10),this.m_bg.addParallaxObject(s)),s=bg=null);(s=new ScrollableNode).setAnchorPoint(ANCHOR_BOTTOM_LEFT()),s.setPosition(0,0),s.setRatio(cc.p(-750,0));var s;bg=cc.Sprite.create(RES_CDN_DEFULT+res_folder[1]);USE_BATTLE_STAGE_FIELD&&(bg.setContentSize(2*cc.size(bg).width,2*cc.size(bg).height),bg.setScale(2)),bg.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),bg.getTexture().setAliasTexParameters(),s.addScrollableObject(bg),0<s.getScrollableObjectsLength()&&(this.m_root_layer.addChild(s,2e3),this.m_bg.addParallaxObject(s)),s=bg=null,(s=new ScrollableNode).setAnchorPoint(ANCHOR_BOTTOM_LEFT()),s.setPosition(0,0),s.setRatio(cc.p(-750,0));bg=cc.Sprite.create(RES_CDN_DEFULT+res_folder[1]);USE_BATTLE_STAGE_FIELD&&(bg.setContentSize(2*cc.size(bg).width,2*cc.size(bg).height),bg.setScale(2)),bg.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),bg.getTexture().setAliasTexParameters(),s.addScrollableObject(bg),0<s.getScrollableObjectsLength()&&(this.m_root_layer.addChild(s,2001),this.m_bg.addParallaxObject(s)),s=bg=null}.bind(this))}}),BattleUITimer=cc.Node.extend({m_current_time:0,m_time_label:null,m_is_pause:!1,m_is_updating:!1,m_time_scale:1,m_time_inc_type:TIME_INC_TYPE.TIME_INC,_complete_callback:null,_callback_map:null,m_is_main_misson_timer_start:!1,m_main_mission_time:60,ctor:function(){this._super(),this.m_is_main_misson_timer_start=!1,this.m_main_mission_time=60,this.init()},onExit:function(){BATTLE_TO_SHOP||(this._super(),this.removeAllChildrenWithCleanup(!0),this.m_time_label=null,this.m_time_inc_type=null,this._complete_callback=null,this._callback_map=null,delete this.m_current_time,delete this.m_is_pause,delete this.m_is_updating,delete this.m_time_scale,delete this.m_time_inc_type,delete this._complete_callback,delete this._callback_map)},init:function(){return this._callback_map=new Map,this.setAnchorPoint(.5,.5),this.m_time_label=cmLabel.getLabel("00:00",LABEL_FONT_INDEX.FONT_201),this.m_time_label.enableOutline(cc.color(0,0,0),1),this.m_time_label.setAnchorPoint(.5,.5),this.m_time_label.setPosition(0,-5),this.addChild(this.m_time_label),!0},setTimerFontSize:function(size){},timerStart:function(tscale){this.setTimeScale(tscale),this.m_is_updating||(this.m_is_updating=!0,this.scheduleUpdate())},timerStop:function(){this.m_is_updating&&(this.unscheduleUpdate(),this.m_is_updating=!1)},setTimeScale:function(tscale){tscale>BATTLE_TIME_SCALE_1X?this.m_time_scale=tscale:this.m_time_scale=BATTLE_TIME_SCALE_1X},setPause:function(){this.m_is_pause=!0},setResume:function(){this.m_is_pause=!1},getTime:function(){return this.m_current_time},setMissiontimerStart:function(){this.m_is_main_misson_timer_start=!0},setMissiontimerStop:function(){this.m_is_main_misson_timer_start=!1},update:function(dt){if(!this.m_is_pause){this.m_time_inc_type==TIME_INC_TYPE.TIME_INC?(dt*=this.m_time_scale,this.m_current_time+=dt,this.m_is_main_misson_timer_start&&(this.m_main_mission_time-=dt,this.m_main_mission_time<=0&&null!=this._complete_callback&&(this._complete_callback(),this.m_main_mission_time=0,this.m_is_main_misson_timer_start=!1))):(dt*=this.m_time_scale,this.m_current_time-=dt,this.m_current_time<0&&(null!=this._complete_callback&&this._complete_callback(),this.timerStop())),this.m_current_time<0&&(this.m_current_time=0);var min=this.m_current_time/60,sec=this.m_current_time%60,str=leadingZeros(parseInt(min),2),str2=leadingZeros(parseInt(sec),2);if(this.m_time_label.setString(str+":"+str2),0<this._callback_map.size())if(this.m_time_inc_type==TIME_INC_TYPE.TIME_INC)for(var first=this._callback_map.keys(),idx=0;idx<first.length;idx++){var key_num=first[idx],second=this._callback_map.at(key_num);if(key_num<=this.m_current_time){this._callback_map.erase_value(second);break}}else for(first=this._callback_map.keys(),idx=0;idx<first.length;idx++){key_num=first[idx],second=this._callback_map.at(key_num);if(key_num>=this.m_current_time){this._callback_map.erase_value(second);break}}}},setStartTime:function(time,_type){this.m_current_time=time,this.m_time_inc_type=_type;var min=this.m_current_time/60,sec=this.m_current_time%60,str=leadingZeros(parseInt(min),2),str2=leadingZeros(parseInt(sec),2);this.m_time_label.setString(str+":"+str2)}});