var MAX_BOX_GACHA_COUNT=80,btn_item_list_popup=510011e3,btn_open_gacha_start=510011001,btn_box_gacha_moving=510011002,btn_extra_box_init=510011003,btn_golden_barrel_list_popup=510011004,BoxGachaBoardItemLayer=cc.Layer.extend({m_select_img:null,m_icon:null,m_user_box_gacha_info:null,m_animation_img:null,m_layer:null,ctor:function(user_box_gacha_info){this._super(),this.init(user_box_gacha_info)},init:function(user_box_gacha_info){this._super(),this.m_layer=new cc.Layer,this.m_layer.setAnchorPoint(ZERO()),this.m_layer.setPosition(ZERO()),this.m_layer.setContentSize(68,68),this.addChild(this.m_layer),this.setContentSize(ccSize(this.m_layer)),0!=(this.m_user_box_gacha_info=user_box_gacha_info).item_idx&&this.updateItemLayerIcon(),this.m_select_box=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_select_2.png",RectZero()),this.m_select_img.setAnchorPoint(ZERO()),this.m_select_img.setPosition(ZERO()),this.m_select_img.setPreferredSize(cc.size(60,60)),this.addChild(this.m_select_img),this.m_select_img.setVisible(!1);var fadeIn=new cc.FadeIn(1),fadeOut=new cc.FadeOut(1),seq=new cc.Sequence(fadeIn,fadeOut),repeat=new cc.RepeatForever(seq);return this.m_select_img.runAction(repeat),!0},selectItem:function(){this.m_select_img.setVisible(!0)},unSelectItem:function(){this.m_select_img.setVisible(!1)},getGachaBoxItemIcon:function(item_idx){var mt=MasterManager.getInstance(),box_gacha_item=mt.get_EventDungeonBoxGachaItem(item_idx),icon=cc.Sprite.create();if(USE_SP_TUBM_SUM&&icon.setScale(1),box_gacha_item.bonus_type==BONUS_TYPE_YUNHEE_FIX){var general=mt.get_General(box_gacha_item.min_value);if(general.gnrl_type==GENERAL_TYPE_MATERIAL||general.gnrl_type==GENERAL_TYPE_EVOLVE_MATERIAL){if(USE_SP_TUBM_SUM){var frame=cc.spriteFrameCache.getSpriteFrame("m_"+general.bone_id+".png");return icon.setSpriteFrame(frame),icon}frame=cc.spriteFrameCache.getSpriteFrame(general.bone_id+".png");return icon.setSpriteFrame(frame),icon}if(USE_SP_TUBM_SUM){frame=cc.spriteFrameCache.getSpriteFrame("m_"+general.gnrl_id+".png");return icon.setSpriteFrame(frame),icon}frame=cc.spriteFrameCache.getSpriteFrame(general.gnrl_id+".png");return icon.setSpriteFrame(frame),icon}frame=cc.spriteFrameCache.getSpriteFrame("img_reward_"+leadingZeros(box_gacha_item.bonus_type,2)+".png");return icon.setSpriteFrame(frame),icon},getUserBoxGachaInfo:function(){return this.m_user_box_gacha_info},updateItemLayerIconClick:function(user_box_gacha_info){this.m_user_box_gacha_info=user_box_gacha_info;var animation=MainAnimation.getInstance().getAnimate(MAIN_ANI_TYPE.EventDungeonBoxGachaOpenEffect),callback=new cc.CallFunc(this.updateItemLayerIcon,this),seq=new cc.Sequence(animation,callback);this.m_animation_img=cc.Sprite.create(),this.m_animation_img.setAnchorPoint(ANCHOR_MIDDLE()),this.m_animation_img.setPosition(ccCenter(this)),this.m_layer.addChild(this.m_animation_img),this.m_animation_img.runAction(seq)},updateBoxGachaInfo:function(user_box_gacha_info){this.m_user_box_gacha_info=user_box_gacha_info,this.updateItemLayerIcon()},updateItemLayerIcon:function(){if(0!=this.m_user_box_gacha_info.item_idx){var box_gacha_info_idx=GameContext.getInstance().getEventDungeonBoxGachaInfoIdx(),mt=MasterManager.getInstance();this.m_icon=this.getGachaBoxItemIcon(this.m_user_box_gacha_info.item_idx),this.m_icon.setAnchorPoint(ZERO()),this.m_icon.setPosition(ZERO()),this.m_layer.addChild(this.m_icon);for(var b=mt.get_EventDungeonBoxGachaInfo(box_gacha_info_idx),main_item_list=MasterTable.getInstance().get_EventDungeonBoxGachaMainItemGroup(b.main_item_group_idx),is_main_item=!1,idx=0;idx<main_item_list.length;idx++){if(main_item_list[idx].main_item_idx==this.m_user_box_gacha_info.item_idx){is_main_item=!0;break}}if(is_main_item){var main_item_bonus_type=0;main_item_bonus_type=(box_gacha_item=mt.get_EventDungeonBoxGachaItem(b.main_item_group_idx)).bonus_type==BONUS_TYPE_YUNHEE_FIX?box_gacha_item.min_value:box_gacha_item.bonus_type;var img=cc.Sprite.create();img.setAnchorPoint(ZERO()),img.setPosition(-3,-3),this.m_icon.addChild(img);for(var animation=new cc.Animation,i=1;i<=8;i++){var frame=cc.spriteFrameCache.getSpriteFrame("effect_boxgacha_"+main_item_bonus_type+"_"+leadingZeros(i,2)+".png");animation.addSpriteFrame(frame)}animation.setDelayPerUnit(.05),animation.setRestoreOriginalFrame(!1);var animate=new cc.Animate(animation),action=new cc.RepeatForever(animate);img.runAction(action)}var box_gacha_item=mt.get_EventDungeonBoxGachaItem(this.m_user_box_gacha_info.item_idx),count_label=cmLabel.getLabel(cmString("x%s",box_gacha_item.max_value.toLocaleString("en")),LABEL_FONT_INDEX.FONT_143);count_label.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),count_label.setPosition(ccCenter(this.m_icon).x,0),count_label.enableOutline(cc.color.BLACK,1),this.m_icon.addChild(count_label)}else this.removeIcon()},removeIcon:function(){null!=this.m_icon&&(this.m_icon.removeAllChildren(),this.m_icon.removeFromParent(),this.m_icon=null,this.unSelectItem()),null!=this.m_animation_img&&(this.m_animation_img.stopAllActions(),this.m_animation_img.removeAllChildren(),this.m_animation_img.removeFromParent(),this.m_animation_img=null),null!=this.m_layer&&this.m_layer.removeAllChildrenWithCleanup(!0)}}),EventDungeonBoxGachaBoardLayer=cc.Layer.extend({m_table_layer:null,m_select_item_num:0,m_is_table_layer_touch:!0,m_gacha_count_label:null,m_event_dungeon_point_label:null,m_next_gacha_btn:null,m_init_gacha_btn:null,m_period:null,m_is_prv_event_dungeon:!1,m_first_period_idx:0,m_second_period_idx:0,m_user_box_gacha_info_list:[],itemLayers:[],m_gnrl_img:[],ctor:function(){this._super(),this.m_period={},this.m_user_box_gacha_info_list=[],this.itemLayers=[],this.m_gnrl_img=[],this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+EVENT_DUNGEON_FIRST_HALF_IDX+"/bg_eventvs_sub.jpg"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+EVENT_DUNGEON_FIRST_HALF_IDX+"/btn_eventvs_default_list_off.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+EVENT_DUNGEON_FIRST_HALF_IDX+"/btn_eventvs_default_list_on.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+EVENT_DUNGEON_FIRST_HALF_IDX+"/btn_eventvs_open_off.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+EVENT_DUNGEON_FIRST_HALF_IDX+"/btn_eventvs_open_on.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+EVENT_DUNGEON_FIRST_HALF_IDX+"/btn_eventvs_open_none.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+EVENT_DUNGEON_FIRST_HALF_IDX+"/btn_eventvs_next_off.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+EVENT_DUNGEON_FIRST_HALF_IDX+"/btn_eventvs_next_on.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+EVENT_DUNGEON_FIRST_HALF_IDX+"/btn_eventvs_next_none.png"),resourceLoader(this.m_gnrl_img,function(){this.init()}.bind(this))},init:function(){this._super();var service=EventDungeonService.getInstance(),mt=MasterTable.getInstance().getMasterTable(),event_dungeon_period_idx=0;this.m_is_prv_event_dungeon=BattleContext._getInstance().getIsPrvEventDungeon(),event_dungeon_period_idx=this.m_is_prv_event_dungeon?BattleContext._getInstance().getPrvEventDungeonPeriodIdx():BattleContext._getInstance().getEventDungeonPeriodIdx(),this.m_period=mt.get_EventDungeonPeriod(event_dungeon_period_idx),this.m_first_period_idx=service.getEventDungeonFirstHalfPeriodIdx(this.m_period.event_dungeon_group_idx),this.m_second_period_idx=service.getEventDungeonSecondHalfPeriodIdx(this.m_period.event_dungeon_group_idx);var bg=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_group_idx+"/bg_eventvs_sub.jpg");this.addChild(bg),this.setUserEventDungeonBoxGachaInfoList();var right_layer=this.getRightLayer();return right_layer.setAnchorPoint(ZERO()),right_layer.setPosition(250,-320),this.addChild(right_layer),this.m_table_layer=this.getTableLayer(),this.m_table_layer.setAnchorPoint(ZERO()),this.m_table_layer.setPosition(-455,-306),this.addChild(this.m_table_layer),this.updateUserGachaInfo(),!0},setUserEventDungeonBoxGachaInfoList:function(){this.m_user_box_gacha_info_list.clear();var box_gacha_info_idx=GameContext.getInstance().getEventDungeonBoxGachaInfoIdx();this.m_user_box_gacha_info_list=NetService().get_User_Event_Dungeon_Box_Gacha_Info_List(box_gacha_info_idx),this.m_user_box_gacha_info_list.sort(function(l,r){return l.item_num-r.item_num})},updateUserGachaInfo:function(){null!=this.m_init_gacha_btn&&this.m_init_gacha_btn.setEnabled(!1),null!=this.m_next_gacha_btn&&this.m_next_gacha_btn.setEnabled(!1);for(var box_gacha_info_idx=GameContext.getInstance().getEventDungeonBoxGachaInfoIdx(),box_gacha_info=MasterTable.getInstance().getMasterTable().get_EventDungeonBoxGachaInfo(box_gacha_info_idx),count=0,idx=0;idx<this.m_user_box_gacha_info_list.length;idx++){var box_info=this.m_user_box_gacha_info_list[idx];if(box_info.box_gacha_info_idx==box_gacha_info_idx)count++,MasterTable.getInstance().get_EventDungeonBoxGachaMainItemGroup(box_gacha_info.main_item_group_idx).forEach(function(main_item){1==box_gacha_info.extra_box?main_item.main_item_idx==box_info.item_idx&&this.m_init_gacha_btn.setEnabled(!0):main_item.main_item_idx==box_info.item_idx&&this.m_next_gacha_btn.setEnabled(!0)}.bind(this))}this.m_gacha_count_label.setString(count+"/"+EVENT_DUNGEON_BOX_GACHA_CELL_COUNT);var event_dungeon_point={};EventDungeonService.getInstance().getUserEventDungeonPoint(box_gacha_info.event_dungeon_period_idx,event_dungeon_point),this.m_event_dungeon_point_label.setString(event_dungeon_point.event_point.toLocaleString("en"))},getRightLayer:function(){var layer=new cc.Layer;layer.setContentSize(ccWidth(this)-728,ccHeight(this));var mt=MasterTable.getInstance().getMasterTable(),box_gacha_info_idx=GameContext.getInstance().getEventDungeonBoxGachaInfoIdx(),box_gacha_info=mt.get_EventDungeonBoxGachaInfo(box_gacha_info_idx),box_gacha_item=mt.get_EventDungeonBoxGachaItem(box_gacha_info.main_item_group_idx),icon_idx=0;icon_idx=box_gacha_item.bonus_type==BONUS_TYPE_YUNHEE_FIX?box_gacha_item.min_value:box_gacha_item.bonus_type;var icon=cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_main_item_%d.png",this.m_period.event_dungeon_group_idx,icon_idx));icon.setAnchorPoint(ZERO()),icon.setPosition(61,339),layer.addChild(icon);var title_img=cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_text_title.png",box_gacha_info.event_dungeon_period_idx));title_img.setAnchorPoint(ZERO()),title_img.setPosition(-3,465),layer.addChild(title_img);var name_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_165);if(name_label.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),name_label.setPosition(123,295),layer.addChild(name_label),box_gacha_item.bonus_type==BONUS_TYPE_YUNHEE_FIX){var general=mt.get_General(box_gacha_item.min_value);name_label.setString(general.name)}else{var bonus_type=mt.get_BonusType(box_gacha_item.bonus_type);name_label.setString(bonus_type.name)}var event_box_img=cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_point_box.png",this.m_period.event_dungeon_period_idx));event_box_img.setAnchorPoint(ZERO()),event_box_img.setPosition(-5,232),layer.addChild(event_box_img),1==box_gacha_info.extra_box&&event_box_img.setTexture(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_point_exbox.png",this.m_period.event_dungeon_period_idx));var event_point_img=cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_point.png",box_gacha_info.event_dungeon_period_idx));event_point_img.setAnchorPoint(ZERO()),event_point_img.setPosition(-5,193),layer.addChild(event_point_img),this.m_gacha_count_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_165),this.m_gacha_count_label.setAnchorPoint(ANCHOR_MIDDLE_RIGHT()),this.m_gacha_count_label.setPosition(228,250),layer.addChild(this.m_gacha_count_label),this.m_event_dungeon_point_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_165),this.m_event_dungeon_point_label.setAnchorPoint(ANCHOR_MIDDLE_RIGHT()),this.m_event_dungeon_point_label.setPosition(228,212),layer.addChild(this.m_event_dungeon_point_label);var item_list_btn=new ccui.Button(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_group_idx+"/btn_eventvs_default_list_off.png",RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_group_idx+"/btn_eventvs_default_list_on.png");if(item_list_btn.setAnchorPoint(ZERO()),item_list_btn.setPosition(9,148),layer.addChild(item_list_btn),item_list_btn.addClickEventListener(function(sender){MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonBoxGachaBoardScene],btn_item_list_popup)}),1==box_gacha_info.extra_box){this.m_init_gacha_btn=new ccui.Button(RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_period_idx+"/btn_eventvs_extra_box_init_off.png",RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_period_idx+"/btn_eventvs_extra_box_init_on.png",RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_period_idx+"/btn_eventvs_extra_box_init_none.png"),this.m_init_gacha_btn.setAnchorPoint(ZERO()),this.m_init_gacha_btn.setPosition(0,29),layer.addChild(this.m_init_gacha_btn),this.m_init_gacha_btn.addClickEventListener(function(sender){MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonBoxGachaBoardScene],btn_extra_box_init)}),this.m_init_gacha_btn.setEnabled(!1);var golden_barrel_list_btn=new ccui.Button("btn_help_off.png","btn_help_on.png","",ccui.Widget.PLIST_TEXTURE);golden_barrel_list_btn.setAnchorPoint(ZERO()),golden_barrel_list_btn.setPosition(199,327),layer.addChild(golden_barrel_list_btn),golden_barrel_list_btn.addClickEventListener(function(sender){MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonBoxGachaBoardScene],btn_golden_barrel_list_popup)})}else this.m_next_gacha_btn=new ccui.Button(RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_period_idx+"/btn_eventvs_next_off.png",RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_period_idx+"/btn_eventvs_next_on.png",RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_period_idx+"/btn_eventvs_next_none.png"),this.m_next_gacha_btn.setAnchorPoint(ZERO()),this.m_next_gacha_btn.setPosition(0,29),layer.addChild(this.m_next_gacha_btn),this.m_next_gacha_btn.addClickEventListener(function(sender){MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonBoxGachaBoardScene],btn_box_gacha_moving)}),this.m_next_gacha_btn.setEnabled(!1);var expense=EventDungeonService.getInstance().getEventDungeonBoxGachaNeedPoint(),open_need_point_label=cmLabel.getLabel(cmString(res_str("label_event_dungeon_box_gacha_open_need_point"),expense.need_count_1),LABEL_FONT_INDEX.FONT_161);return open_need_point_label.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),open_need_point_label.setPosition(122,9),layer.addChild(open_need_point_label),layer},getTableLayer:function(){this.itemLayers.clear();var tableLayer=new TableViewLayer;return tableLayer.setContentSize(cc.size(682,546)),tableLayer.setItemCount(EVENT_DUNGEON_BOX_GACHA_CELL_COUNT),tableLayer.setColumnCount(10),tableLayer.getItemNode=function(index,contentSize,margin){var info=this.m_user_box_gacha_info_list.at(index),layer=new BoxGachaBoardItemLayer(info);return this.itemLayers.push(layer),layer}.bind(this),tableLayer.initLayout(),tableLayer.setTouchScrollEnabled(!1),tableLayer.setEnableMouseScroll(!1),tableLayer.onItemTouchBegin=function(index){return this.m_select_item_num=0,!!this.m_is_table_layer_touch&&(this.m_select_item_num=index+1,!EventDungeonService.getInstance().isBoxGachaOpenItem(this.m_select_item_num))}.bind(this),tableLayer.onItemTouchMoved=function(isScroll){},tableLayer.onItemTouchCancel=function(index){return!0},tableLayer.onItemTouchEnd=function(index){for(var layer=this.itemLayers[index],idx=0;idx<this.itemLayers.length;idx++)this.itemLayers[idx].unSelectItem();return layer.selectItem(),MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonBoxGachaBoardScene],btn_open_gacha_start),!0}.bind(this),tableLayer},getUserBoxGachaInfo:function(item_idx,info){var service=NetService(),box_gacha_info_idx=GameContext.getInstance().getEventDungeonBoxGachaInfoIdx(),init_info=service.get_User_Event_Dungeon_Extra_Box_Init_Info(box_gacha_info_idx),found=this.m_user_box_gacha_info_list.findIndex(function(r){return r.item_idx==item_idx&&r.init_count==init_info.init_count});return-1!=found&&(info=this.m_user_box_gacha_info_list[found]),info},updateBoardLayer:function(item_idx){this.setUserEventDungeonBoxGachaInfoList();var user_info=this.getUserBoxGachaInfo(item_idx);if(null!=this.m_table_layer){for(var idx=0;idx<this.itemLayers.length;idx++){var layer=this.itemLayers[idx];layer.getUserBoxGachaInfo().item_num==user_info.item_num&&layer.updateItemLayerIconClick(user_info),layer.unSelectItem()}this.updateUserGachaInfo(),this.m_select_item_num=0}},reloadBoardLayer:function(){if(this.setUserEventDungeonBoxGachaInfoList(),null!=this.m_table_layer){for(var index=0,idx=0;idx<this.itemLayers.length;idx++){var layer=this.itemLayers[idx],info=$.extend({},this.m_user_box_gacha_info_list.at(index));layer.updateBoxGachaInfo(info),layer.unSelectItem(),index++}this.updateUserGachaInfo(),this.m_select_item_num=0}},resetBoardLayer:function(){if(this.setUserEventDungeonBoxGachaInfoList(),null!=this.m_table_layer){for(var index=1,idx=0;idx<this.itemLayers.length;idx++){var layer=this.itemLayers[idx],user_info={event_dungeon_period_idx:0,item_idx:0,item_num:0,box_gacha_info_idx:0,random_bonus_type:0,random_bonus_count:0,random_bonus_item_idx:0,init_count:0};user_info.item_num=index,layer.updateBoxGachaInfo(user_info),layer.unSelectItem(),index++}this.updateUserGachaInfo()}},setEnableTableLayer:function(is_enabled){this.m_is_table_layer_touch=is_enabled},getSelectItemNum:function(){return this.m_select_item_num},onEnter:function(){this._super()},onExit:function(){this._super()}}),EventDungeonBoxGachaBoardScene=GameScene.extend({m_board_layer:null,m_is_effect_layer_touch:!1,m_item_list_popup:null,m_golden_barrel_list_popup:null,m_effect_modal_layer:null,m_first_period_idx:0,m_second_period_idx:0,m_is_prv_event_dungeon:!1,m_normal_voice_list:[],m_main_voice_list:[],ctor:function(){this.m_normal_voice_list=[],this.m_main_voice_list=[],this._super(scene_EventDungeonBoxGachaBoardScene)},init:function(){var event_dungeon_period_idx=0;this.m_is_prv_event_dungeon=BattleContext._getInstance().getIsPrvEventDungeon(),event_dungeon_period_idx=this.m_is_prv_event_dungeon?BattleContext._getInstance().getPrvEventDungeonPeriodIdx():BattleContext._getInstance().getEventDungeonPeriodIdx(),this.m_board_layer=new EventDungeonBoxGachaBoardLayer,this.m_board_layer.setPosition(ccCenter(winSize)),this.addChild(this.m_board_layer);var statusLayer=new StatusLayer(INVOKER_TYPE.normal);statusLayer.initLayout(),statusLayer.ignoreAnchorPointForPosition(!1),statusLayer.setAnchorPoint(ANCHOR_TOP_RIGHT()),statusLayer.setPosition(ccWidth(this),ccHeight(this)),this.addChild(statusLayer);var title=cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_text_event.png",event_dungeon_period_idx));title.setAnchorPoint(ZERO()),title.setPosition(90,585),this.addChild(title);var back_btn=new ccui.Button;return back_btn.loadTextures("btn_home_off.png","btn_home_on.png","",ccui.Widget.PLIST_TEXTURE),back_btn.setAnchorPoint(ZERO()),back_btn.setPosition(10,559),back_btn.addClickEventListener(function(){this.sendGachaProgreeInfo()}.bind(this)),this.addChild(back_btn),this.m_item_list_popup=new GameModalLayer,this.addChild(this.m_item_list_popup),this.m_golden_barrel_list_popup=new GameModalLayer,this.addChild(this.m_golden_barrel_list_popup),this.m_effect_modal_layer=new GameModalLayer,this.addChild(this.m_effect_modal_layer,1e4),this.m_normal_voice_list.clear(),this.m_normal_voice_list.push_back("yue_kunsyu_0001.mp3"),this.m_normal_voice_list.push_back("yue_kunsyu_0002.mp3"),this.m_normal_voice_list.push_back("yue_kunsyu_0003.mp3"),this.m_normal_voice_list.push_back("yue_kunsyu_0025.mp3"),this.m_main_voice_list.clear(),this.m_main_voice_list.push_back("yue_kunsyu_0023.mp3"),this.m_main_voice_list.push_back("yue_kunsyu_0024.mp3"),this.m_main_voice_list.push_back("yue_kunsyu_0028.mp3"),!0},showItemListPopup:function(){this.m_item_list_popup.setContentSize(ccSize(this)),this.m_item_list_popup._contentNode=function(contentsSize,m){return this.getItemListPopupLayer()}.bind(this),this.m_item_list_popup.show()},getMainItemGoldenBarrelEffectLayer:function(main_bonus_type,bonus_type,count,min_value){var layer=new cc.Layer,img=cc.Sprite.create();img.setAnchorPoint(ANCHOR_MIDDLE()),img.setPosition(LP(this,350,ccCenter(layer).y)),layer.addChild(img,1);for(var animation=new cc.Animation,i=1;i<=12;i++){var ani_img="#effect_boxgacha_"+main_bonus_type+"_large_"+leadingZeros(i,2)+".png";animation.addSpriteFrameWithFile(ani_img)}animation.setDelayPerUnit(.08),animation.setRestoreOriginalFrame(!0);var animate=new cc.Animate(animation);return img.runAction(new cc.Sequence(animate,new cc.FadeOut(.1))),this.scheduleOnce(function(float){var effect_layer=this.getMainItemEffectLayer(bonus_type,count,min_value);layer.addChild(effect_layer)},1,"getMainItemEffectLayer"),layer},getMainItemEffectLayer:function(bonus_type,count,min_value){var layer=new cc.Layer,mt=MasterManager.getInstance(),box_gacha_info_idx=GameContext.getInstance().getEventDungeonBoxGachaInfoIdx(),back_effect=cc.Sprite.create("#img_attend_effect.png");back_effect.setPosition(LP(this,350,ccCenter(layer).y)),layer.addChild(back_effect),back_effect.setScale(1.7);mt.get_EventDungeonBoxGachaInfo(box_gacha_info_idx);var action=new cc.RotateBy(1,180),repeat=new cc.RepeatForever(action);back_effect.runAction(repeat);var audio=AudioEngine.getInstance();audio.stopEffectMusicAll(),audio.playEffect(RES_CDN_SOUND+SND_TYPE+"sound/SE_all_win_popularity.mp3",!1),audio.playEffect(RES_CDN_SOUND+SND_TYPE+"sound/SE_gacha_back.mp3",!0);var bonus_icon=new cc.Sprite.create;bonus_icon.setPosition(LP(this,350,ccCenter(layer).y)),layer.addChild(bonus_icon);var bonus_name_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_503);if(bonus_name_label.setAnchorPoint(ANCHOR_MIDDLE_TOP()),bonus_name_label.enableOutline(cc.color.BLACK,3),bonus_name_label.setPosition(LP(this,350,ccHeight(layer)-180)),layer.addChild(bonus_name_label),bonus_type==BONUS_TYPE_YUNHEE_FIX){var general=mt.get_General(min_value),frame=cc.spriteFrameCache.getSpriteFrame("img_reward_"+leadingZeros(min_value,2)+"_d.png");bonus_icon.setSpriteFrame(frame),bonus_name_label.setString(general.name)}else{var bonus=mt.get_BonusType(bonus_type);frame=cc.spriteFrameCache.getSpriteFrame("img_reward_"+leadingZeros(bonus_type,2)+"_d.png");bonus_icon.setSpriteFrame(frame),bonus_name_label.setString(bonus.name)}var bonus_count_label=cmLabel.getLabel(cmString("x %s",count.toLocaleString("en")),LABEL_FONT_INDEX.FONT_503);return bonus_count_label.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),bonus_count_label.enableOutline(cc.color.BLACK,3),bonus_count_label.setPosition(LP(this,350,180)),layer.addChild(bonus_count_label),layer},showGoldenBarrelListPopup:function(){this.m_golden_barrel_list_popup.setContentSize(ccSize(this)),this.m_golden_barrel_list_popup._contentNode=function(contentsSize,m){return this.getGoldenBarrelListPopupLayer()}.bind(this),this.m_golden_barrel_list_popup.show()},showEffectLayer:function(bonus_type,min_value,count,item_idx,random_bonus_type,random_bonus_count,random_item_idx){this.m_is_effect_layer_touch=!1,this.m_effect_modal_layer.setContentSize(ccSize(this)),this.m_effect_modal_layer._contentNode=function(contentsSize,m){var layer=new cc.Layer,mt=MasterManager.getInstance(),box_gacha_info_idx=GameContext.getInstance().getEventDungeonBoxGachaInfoIdx(),back_effect=cc.Sprite.create("#img_attend_effect.png");back_effect.setPosition(LP(this,350,ccCenter(layer).y)),layer.addChild(back_effect),mt.get_EventDungeonBoxGachaInfo(box_gacha_info_idx).main_item_group_idx==item_idx&&back_effect.setScale(1.7);var action=new cc.RotateBy(1,180),repeat=new cc.RepeatForever(action);back_effect.runAction(repeat);var audio=AudioEngine.getInstance();audio.stopEffectsAll(),audio.playEffect(RES_CDN_SOUND+SND_TYPE+"sound/SE_all_win_popularity.mp3",!1),audio.playEffect(RES_CDN_SOUND+SND_TYPE+"sound/SE_gacha_back.mp3",!1);var bonus_icon=cc.Sprite.create();bonus_icon.setPosition(LP(this,350,ccCenter(layer).y)),layer.addChild(bonus_icon);var bonus_name_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_503);if(bonus_name_label.setAnchorPoint(ANCHOR_MIDDLE_TOP()),bonus_name_label.enableOutline(cc.color.BLACK,3),bonus_name_label.setPosition(LP(this,350,ccHeight(layer)-180)),layer.addChild(bonus_name_label),bonus_type==BONUS_TYPE_YUNHEE_FIX){var general=mt.get_General(min_value),frame=cc.spriteFrameCache.getSpriteFrame("img_reward_"+leadingZeros(min_value,2)+"_d.png");bonus_icon.setSpriteFrame(frame),bonus_name_label.setString(general.name)}else if(bonus_type==BONUS_TYPE_GOLDEN_BARREL)if(random_bonus_type==BONUS_TYPE_YUNHEE_FIX){general=mt.get_General(random_item_idx),frame=cc.spriteFrameCache.getSpriteFrame("img_reward_"+leadingZeros(random_item_idx,2)+"_d.png");bonus_icon.setSpriteFrame(frame),bonus_name_label.setString(general.name)}else{var bonus=mt.get_BonusType(random_bonus_type);frame=cc.spriteFrameCache.getSpriteFrame("img_reward_"+leadingZeros(bonus_type,2)+"_d.png");bonus_icon.setSpriteFrame(frame)}else{bonus=mt.get_BonusType(bonus_type),frame=cc.spriteFrameCache.getSpriteFrame("img_reward_"+leadingZeros(bonus_type,2)+"_d.png");bonus_icon.setSpriteFrame(frame),bonus_name_label.setString(bonus.name)}var bonus_count_label=cmLabel.getLabel(cmString("x %s",count.toLocaleString("en")),LABEL_FONT_INDEX.FONT_503);return bonus_count_label.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),bonus_name_label.enableOutline(cc.color.BLACK,3),bonus_count_label.setPosition(LP(this,350,180)),layer.addChild(bonus_count_label),layer},this.m_effect_modal_layer.show(),this.m_effect_modal_layer.onItemTouchBegin=function(bool){return!0}.bind(this),this.m_effect_modal_layer.onItemTouchEnd=function(){this.m_is_effect_layer_touch&&(AudioEngine.getInstance().stopEffectsAll(),this.m_board_layer.setEnableTableLayer(!0),this.m_effect_modal_layer.hide())}.bind(this)},showNormalEffectLayer:function(bonus_type,count,min_value){this.m_is_effect_layer_touch=!1,this.m_effect_modal_layer.setContentSize(ccSize(this)),this.m_effect_modal_layer._contentNode=function(contentsSize,m){return this.getMainItemEffectLayer(bonus_type,count,min_value)}.bind(this),this.m_effect_modal_layer.show(),this.m_effect_modal_layer.onItemTouchBegin=function(){return!0},this.m_effect_modal_layer.onItemTouchEnd=function(){this.m_is_effect_layer_touch&&(AudioEngine.getInstance().stopEffectsAll(),this.m_board_layer.setEnableTableLayer(!0),this.m_effect_modal_layer.hide())}.bind(this)},showGoldenBarrelEffectLayer:function(main_bonus_type,bonus_type,count,min_value){this.m_is_effect_layer_touch=!1,this.m_effect_modal_layer.setContentSize(ccSize(this)),this.m_effect_modal_layer._contentNode=function(contentsSize,m){return this.getMainItemGoldenBarrelEffectLayer(main_bonus_type,bonus_type,count,min_value)}.bind(this),this.m_effect_modal_layer.show(),this.m_effect_modal_layer.onItemTouchBegin=function(){return!0},this.m_effect_modal_layer.onItemTouchEnd=function(){this.m_is_effect_layer_touch&&(AudioEngine.getInstance().stopEffectsAll(),this.m_board_layer.setEnableTableLayer(!0),this.m_effect_modal_layer.hide())}.bind(this)},getGoldenBarrelListPopupLayer:function(){var layer=new cc.Layer,box=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_script_box_2.png",cc.Rect(40,40,10,10));box.setPreferredSize(cc.size(478,581)),box.setPosition(ccCenter(layer)),layer.addChild(box);var navi=cc.Sprite.create(RES_CDN_DEFULT+"common/img_navi_center_2.png");navi.setAnchorPoint(ANCHOR_MIDDLE_TOP()),navi.setPosition(ccCenter(box).x,ccHeight(box)-11),box.addChild(navi);var navi_title=cmLabel.getLabel(res_str("label_event_dungeon_box_gacha_item_list_title"),LABEL_FONT_INDEX.FONT_261);navi_title.setAnchorPoint(ANCHOR_MIDDLE()),navi_title.setPosition(ccCenter(navi).x,ccCenter(navi).y+3),navi.addChild(navi_title);var btn=new ccui.Button("btn_cancel_off.png","btn_cancel_on.png","",ccui.Widget.PLIST_TEXTURE);btn.setAnchorPoint(ANCHOR_MIDDLE_RIGHT()),btn.setPosition(ccWidth(navi)-16,ccCenter(navi).y+2),btn.addClickEventListener(function(sender){this.m_golden_barrel_list_popup.hide()}.bind(this)),navi.addChild(btn);var list_layer=this.getGoldenBarrelListLayer();return list_layer.setAnchorPoint(ZERO()),list_layer.setPosition(17,18),box.addChild(list_layer),layer},getItemListPopupLayer:function(){var layer=new cc.Layer,box=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_script_box_2.png",cc.Rect(40,40,10,10));box.setPreferredSize(cc.size(478,581)),box.setPosition(ccCenter(layer)),layer.addChild(box);var navi=cc.Sprite.create(RES_CDN_DEFULT+"common/img_navi_center_2.png");navi.setAnchorPoint(ANCHOR_MIDDLE_TOP()),navi.setPosition(ccCenter(box).x,ccHeight(box)-11),box.addChild(navi);var navi_title=cmLabel.getLabel(MasterManager.getInstance().get_LanguageData("label_event_dungeon_box_gacha_item_list_title"),LABEL_FONT_INDEX.FONT_261);navi_title.setAnchorPoint(ANCHOR_MIDDLE()),navi_title.setPosition(ccCenter(navi).x,ccCenter(navi).y+3),navi.addChild(navi_title);var btn=new ccui.Button("btn_cancel_off.png","btn_cancel_on.png","",ccui.Widget.PLIST_TEXTURE);btn.setAnchorPoint(ANCHOR_MIDDLE_RIGHT()),btn.setPosition(ccWidth(navi)-16,ccCenter(navi).y+2),btn.addClickEventListener(function(sender){this.m_item_list_popup.hide()}.bind(this)),navi.addChild(btn);var list_layer=this.getItemListLayer();return list_layer.setAnchorPoint(ZERO()),list_layer.setPosition(17,18),box.addChild(list_layer),layer},getGoldenBarrelListLayer:function(){MasterManager.getInstance();var box_gacha_info_idx=GameContext.getInstance().getEventDungeonBoxGachaInfoIdx(),list=EventDungeonService.getInstance().getUserEventDungeonBoxGachaGoldenBarrelCountInfo(box_gacha_info_idx),list_layer=new VListLayer;return list_layer.setContentSize(444,492),list_layer.setItemCount(list.size()),list_layer.setAnimationType(kListAnimationNone),list_layer.getItemNode=function(index,contentSize,m){var item=list.at(index);return this.getGoldenBarrelListCellLayer(item)}.bind(this),list_layer.onItemTouchBegin=function(index){return cc.log("getItemListCellLayer Touch Begin"),!0},list_layer.onItemTouchScrollEnd=function(index){cc.log("getItemListCellLayer Touch onItemTouchScrollEnd")}.bind(this),list_layer.onItemTouchMoved=function(){return cc.log("getItemListCellLayer Touch Move"),!0},list_layer.onItemTouchEnd=function(index){cc.log("getItemListCellLayer Touch End")}.bind(this),list_layer.initLayout(),list_layer},getGoldenBarrelListCellLayer:function(info){var layer=new cc.Layer,size=cc.size(444,78);layer.setContentSize(size);var box=cc.Scale9Sprite.create(RES_CDN_DEFULT+"menu_yh/img_yh_info_box.png",cc.Rect(20,20,20,20));box.setPreferredSize(size),box.setAnchorPoint(ZERO()),box.setPosition(ZERO()),layer.addChild(box);var icon_frame=cc.Sprite.create(RES_CDN_DEFULT+"icon/img_icon_frame.png");icon_frame.setAnchorPoint(ANCHOR_MIDDLE_LEFT()),icon_frame.setPosition(4,.5*size.height),box.addChild(icon_frame);var icon=cc.Sprite.create();icon.setAnchorPoint(ANCHOR_MIDDLE()),icon.setPosition(ccCenter(icon_frame)),icon_frame.addChild(icon);var reward_name=cmLabel.getLabel("STEP",LABEL_FONT_INDEX.FONT_2013);reward_name.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),reward_name.setPosition(80,43),box.addChild(reward_name);var mt=MasterManager.getInstance();if(info.bonus_type==BONUS_TYPE_YUNHEE_FIX){var general=mt.get_General(info.item_id);if(USE_SP_TUBM_SUM){var frame=cc.spriteFrameCache.getSpriteFrame("m_"+general.gnrl_id+".png");icon.setSpriteFrame(frame),USE_SP_TUMB_SCALE&&icon.setScale(DEF_TUMB_SCALE)}else{frame=cc.spriteFrameCache.getSpriteFrame(general.gnrl_id+".png");icon.setSpriteFrame(frame)}reward_name.setString(cmString("%s x%s",general.name,info.bonus_count))}else{var bonus_type=mt.get_BonusType(info.bonus_type);frame=cc.spriteFrameCache.getSpriteFrame("img_reward_"+leadingZeros(info.bonus_type,2)+".png");icon.setSpriteFrame(frame),reward_name.setString(cmString("%s x%s",bonus_type.name,info.bonus_count))}var reward_count=cmLabel.getLabel(res_str("label_golden_barrel_item_always"),LABEL_FONT_INDEX.FONT_181);if(reward_count.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),reward_count.setPosition(80,16),box.addChild(reward_count),0<info.max_count){var user_count=parseInt((info.max_count-info.user_count)/info.bonus_count),max_count=parseInt(info.max_count/info.bonus_count);reward_count.setString(cmString(res_str("label_golden_barrel_item_limit_count"),user_count,max_count))}return layer},getItemListLayer:function(){var box_gacha_info_idx=GameContext.getInstance().getEventDungeonBoxGachaInfoIdx(),service=EventDungeonService.getInstance(),list=[];service.getUserEventDungeonBoxGachaCountInfo(box_gacha_info_idx,list);var list_layer=new VListLayer;return list_layer.setContentSize(444,492),list_layer.setItemCount(list.length),list_layer.getItemNode=function(index,contentSize,m){var item=list[index];return this.getItemListCellLayer(item)}.bind(this),list_layer.onItemTouchBegin=function(index){return cc.log("getItemListCellLayer Touch Begin"),!0},list_layer.onItemTouchScrollEnd=function(index){cc.log("getItemListCellLayer Touch onItemTouchScrollEnd")}.bind(this),list_layer.onItemTouchMoved=function(){return cc.log("getItemListCellLayer Touch Move"),!0},list_layer.onItemTouchEnd=function(index){cc.log("getItemListCellLayer Touch End")}.bind(this),list_layer.initLayout(),list_layer},getItemListCellLayer:function(info){var layer=new cc.Layer,size=cc.size(444,78);layer.setContentSize(size);var box=cc.Scale9Sprite.create(RES_CDN_DEFULT+"menu_yh/img_yh_info_box.png",cc.Rect(20,20,20,20));box.setPreferredSize(size),box.setAnchorPoint(ZERO()),box.setPosition(ZERO()),layer.addChild(box);var icon_frame=new cc.Sprite(RES_CDN_DEFULT+"icon/img_icon_frame.png");icon_frame.setAnchorPoint(ANCHOR_MIDDLE_LEFT()),icon_frame.setPosition(4,.5*size.height),box.addChild(icon_frame);var icon=new cc.Sprite;icon.setAnchorPoint(ANCHOR_MIDDLE()),icon.setPosition(ccCenter(icon_frame)),icon_frame.addChild(icon);var reward_name=cmLabel.getLabel("STEP",LABEL_FONT_INDEX.FONT_2013);reward_name.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),reward_name.setPosition(80,43),box.addChild(reward_name);var mt=MasterTable.getInstance().getMasterTable();if(info.bonus_type==BONUS_TYPE_YUNHEE_FIX){var general=mt.get_General(info.item_id),frame=cc.spriteFrameCache.getSpriteFrame(general.gnrl_id+".png");icon.setSpriteFrame(frame),reward_name.setString(general.name+" x"+info.bonus_count)}else{var bonus_type=mt.get_BonusType(info.bonus_type);frame=cc.spriteFrameCache.getSpriteFrame("img_reward_"+leadingZeros(info.bonus_type,2)+".png");icon.setSpriteFrame(frame),reward_name.setString(bonus_type.name+" x"+info.bonus_count)}var user_count=info.max_count-info.user_count,reward_count=cmLabel.getLabel(cmString(res_str("label_event_dungeon_box_gacha_count"),user_count,info.max_count),LABEL_FONT_INDEX.FONT_181);return reward_count.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),reward_count.setPosition(80,16),box.addChild(reward_count),layer},onEnter:function(){this._super(),MainObserver.getInstance().addObserver(this.onNotification,this,sceneStr[scene_EventDungeonBoxGachaBoardScene]);var event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx(),period=MasterManager.getInstance().get_EventDungeonPeriod(event_dungeon_period_idx),b_path=RES_CDN_SOUND+SND_TYPE+"sound/"+cmString(BGM_EVENT_DUNGEON_SCENE,period.event_dungeon_point_period_idx),audio=AudioEngine.getInstance();audio.m_bgmPath!=b_path&&(audio.stopBackgroundMusic(),audio.playBackgroundMusic(b_path,!0));var voice_list=[];voice_list.push_back("yue_kunsyu_0023.mp3"),voice_list.push_back("yue_kunsyu_0024.mp3"),voice_list.push_back("yue_kunsyu_0028.mp3"),audio.stopEffectsAll();var r=Math.floor(Math.random()*voice_list.length),voice_path=RES_CDN_SOUND+SND_TYPE+"voice_etc/"+voice_list.at(r);audio.playVoice(voice_path)},onExit:function(){this._super(),AudioEngine.getInstance().stopVoice(),MainObserver.getInstance().removeObserver(sceneStr[scene_EventDungeonBoxGachaBoardScene])},back:function(){this.onKeyBack(!0)},onNotification:function(msg){if(this._super(msg),msg==btn_item_list_popup)this.showItemListPopup();else if(msg==btn_golden_barrel_list_popup)this.showGoldenBarrelListPopup();else if(msg==btn_open_gacha_start){var service=EventDungeonService.getInstance(),expense=(MasterTable.getInstance().getMasterTable(),service.getEventDungeonBoxGachaNeedPoint());if(this.m_board_layer.setEnableTableLayer(!1),0!=expense.event_dungeon_period_idx_1){var user_point_1={};if(service.getUserEventDungeonPoint(expense.event_dungeon_period_idx_1,user_point_1),expense.need_count_1>user_point_1.event_point)return this.showInfoPopup(res_str("label_shop_buy_jade_omission_title"),res_str("label_event_dungeon_point_lack")),this.m_board_layer.setEnableTableLayer(!0),!0}else if(0!=expense.event_dungeon_period_idx_2){var user_point_2={};if(service.getUserEventDungeonPoint(expense.event_dungeon_period_idx_2,user_point_2),expense.need_count_2>user_point_2.event_point)return this.showInfoPopup(res_str("label_shop_buy_jade_omission_title"),res_str("label_event_dungeon_point_lack")),this.m_board_layer.setEnableTableLayer(!0),!0}this.sendPacketBoxGachaOpen()}else msg==btn_box_gacha_moving?this.showBoxGachaMoving():msg==btn_extra_box_init&&this.showExtraBoxInit()},showExtraBoxInit:function(){this.m_ctbox.setTitle(res_str("label_shop_buy_jade_omission_title")),this.m_ctbox.setText(res_str("label_extra_box_init_text_1"),LABEL_FONT_INDEX.FONT_261),this.m_ctbox.setText("\n"),this.m_ctbox.setText(res_str("label_extra_box_init_text_2"),LABEL_FONT_INDEX.FONT_261),this.m_ctbox.setText("\n"),this.m_ctbox.setText(res_str("label_extra_box_init_text_3"),LABEL_FONT_INDEX.FONT_261),this.m_ctbox.setText("\n"),this.m_ctbox.setText(res_str("label_extra_box_init_text_4"),LABEL_FONT_INDEX.FONT_2617),this.m_ctbox.setText("\n"),this.m_ctbox.setText(res_str("label_extra_box_init_text_5"),LABEL_FONT_INDEX.FONT_2617),this.m_ctbox.setText("\n"),this.m_ctbox.setText(res_str("label_extra_box_init_text_6"),LABEL_FONT_INDEX.FONT_2617),this.m_ctbox.addButtonInfo(new MessageButtonInfo("いいえ",MessageBoxButtonType.ButtonTypeRed,0,function(){this.m_ctbox.hide()}.bind(this))),this.m_ctbox.addButtonInfo(new MessageButtonInfo("はい",MessageBoxButtonType.ButtonTypeNormal,0,function(){this.scheduleOnce(function(float){this.sendPacketExtraBoxInit()},0,"sendPacketExtraBoxInit"),this.m_ctbox.hide()}.bind(this))),this.m_ctbox.show()},showExtraBoxInitComplete:function(){this.m_box.setTitle(res_str("label_shop_buy_jade_omission_title")),this.m_box.setText(res_str("label_extra_box_init_complete_text")),this.m_box.setText("\n"),this.m_box.addButtonInfo(new MessageButtonInfo(res_str("btn_label_confirm"),MessageBoxButtonType.ButtonTypeNormal,0,function(){this.m_box.hide(!1)}.bind(this))),this.m_box.show()},showBoxGachaMoving:function(){this.m_box.setTitle(res_str("label_buy_goods_fail_title")),this.m_box.setText(res_str("label_event_dungeon_box_gacha_moving_text_1")),this.m_box.setText("\n"),this.m_box.setText(res_str("label_event_dungeon_box_gacha_moving_text_2")),this.m_box.setText("\n"),this.m_box.setText(res_str("label_event_dungeon_box_gacha_moving_text_3")),this.m_box.setText("\n"),this.m_box.setText(res_str("label_event_dungeon_box_gacha_moving_text_4")),this.m_box.setText("\n"),this.m_box.setText(res_str("label_event_dungeon_box_gacha_moving_text_5")),this.m_box.addButtonInfo(new MessageButtonInfo("いいえ",MessageBoxButtonType.ButtonTypeRed,0,function(){this.m_box.hide()}.bind(this))),this.m_box.addButtonInfo(new MessageButtonInfo("はい",MessageBoxButtonType.ButtonTypeNormal,0,function(){this.scheduleOnce(function(float){this.sendPacketBoxGachaMoving()},0,"sendPacketBoxGachaMoving"),this.m_box.hide()}.bind(this))),this.m_box.show()},showBoxGachaOpen:function(event_dungeon_period_idx_1,need_count_1,event_dungeon_period_idx_2,need_count_2){this.m_ctbox.setTitle(res_str("label_buy_goods_fail_title"));var mt=MasterTable.getInstance().getMasterTable(),box_gacha_info_idx=GameContext.getInstance().getEventDungeonBoxGachaInfoIdx(),period=(mt.get_EventDungeonBoxGachaInfo(box_gacha_info_idx),mt.get_EventDungeonPeriod(event_dungeon_period_idx_1)),unit=mt.get_EventPointUnitType(period.event_point_unit_type);if(0!=event_dungeon_period_idx_2){period=mt.get_EventDungeonPeriod(event_dungeon_period_idx_2);mt.get_EventPointUnitType(period.event_point_unit_type);this.m_ctbox.setText(res_str("label_event_dungeon_box_gacha_open_text_1"),LABEL_FONT_INDEX.FONT_261),this.m_ctbox.setText("\n"),this.m_ctbox.setText(unit.name+""+need_count_1,LABEL_FONT_INDEX.FONT_262),this.m_ctbox.setText("と",LABEL_FONT_INDEX.FONT_261),this.m_ctbox.setText(unit.name+""+need_count_2,LABEL_FONT_INDEX.FONT_262),this.m_ctbox.setText("で",LABEL_FONT_INDEX.FONT_261),this.m_ctbox.setText("\n"),this.m_ctbox.setText(res_str("label_event_dungeon_box_gacha_open_text_4"),LABEL_FONT_INDEX.FONT_261)}else this.m_ctbox.setText(res_str("label_event_dungeon_box_gacha_open_text_1"),LABEL_FONT_INDEX.FONT_261),this.m_ctbox.setText("\n"),this.m_ctbox.setText(unit.name+""+need_count_1,LABEL_FONT_INDEX.FONT_262),this.m_ctbox.setText("を消費します。",LABEL_FONT_INDEX.FONT_261),this.m_ctbox.setText("\n");this.m_ctbox.addButtonInfo(new MessageButtonInfo("いいえ",MessageBoxButtonType.ButtonTypeRed,0,function(){this.m_board_layer.setEnableTableLayer(!0),this.m_ctbox.hide()}.bind(this))),this.m_ctbox.addButtonInfo(new MessageButtonInfo("はい",MessageBoxButtonType.ButtonTypeNormal,0,function(){this.scheduleOnce(function(float){this.sendPacketBoxGachaOpen()}.bind(this),0,"sendPacketBoxGachaOpen"),this.m_ctbox.hide()}.bind(this))),this.m_ctbox.show()},sendPacketExtraBoxInit:function(){var mt=MasterManager.getInstance(),box_gacha_info_idx=GameContext.getInstance().getEventDungeonBoxGachaInfoIdx(),box_gacha_info=mt.get_EventDungeonBoxGachaInfo(box_gacha_info_idx),req={};req.opcode=net.OP.op_event_dungeon_box_gacha_extra_box_init,req.event_dungeon_period_idx=box_gacha_info.event_dungeon_period_idx,req.box_gacha_info_idx=box_gacha_info_idx,this.network_write(req)},sendPacketBoxGachaMoving:function(){var mt=MasterTable.getInstance().getMasterTable(),box_gacha_info_idx=GameContext.getInstance().getEventDungeonBoxGachaInfoIdx(),box_gacha_info=mt.get_EventDungeonBoxGachaInfo(box_gacha_info_idx),next_box_gacha_idx=EventDungeonService.getInstance().getEventDungeonNextBoxGachaIdx(),req={};req.opcode=net.OP.op_event_dungeon_box_gacha_moving,req.event_dungeon_period_idx=box_gacha_info.event_dungeon_period_idx,req.box_gacha_info_idx=box_gacha_info_idx,req.next_box_gacha_info_idx=next_box_gacha_idx,this.network_write(req)},sendPacketBoxGachaOpen:function(){var mt=MasterTable.getInstance().getMasterTable(),item_num=this.m_board_layer.getSelectItemNum();if(0==item_num)return this.m_board_layer.reloadBoardLayer(),void this.m_board_layer.setEnableTableLayer(!0);if(EventDungeonService.getInstance().isBoxGachaOpenItem(item_num))return(req={}).opcode=net.OP.op_get_user_event_dungeon_box_gacha_info,void this.network_write(req);var req,box_gacha_info_idx=GameContext.getInstance().getEventDungeonBoxGachaInfoIdx(),box_gacha_info=mt.get_EventDungeonBoxGachaInfo(box_gacha_info_idx);(req={}).opcode=net.OP.op_open_event_dungeon_box_gacha,req.box_gacha_info_idx=box_gacha_info_idx,req.event_dungeon_period_idx=box_gacha_info.event_dungeon_period_idx,req.item_num=item_num,this.network_write(req)},sendGachaProgreeInfo:function(){var register={};register.opcode=net.OP.op_get_user_event_dungeon_box_gacha_progress_info,this.network_write(register)},onNetworkEvent:function(opcode,state,body){if(opcode==net.OP.op_open_event_dungeon_box_gacha)if(body.error==net.ERROR.NET_E_LACK_EVENT_DUNGEON_POINT)this.showInfoPopup(res_str("label_shop_buy_jade_omission_title"),res_str("label_event_dungeon_point_lack")),this.m_board_layer.setEnableTableLayer(!0);else if(body.error==net.ERROR.NET_E_EVENT_DUNGEON_BOX_GACHA_ALREDY_OPEN){var req={};req.opcode=net.OP.op_get_user_event_dungeon_box_gacha_info,this.network_write(req)}else if(body.error!=net.ERROR.NET_E_SUCCESS)this.m_board_layer.setEnableTableLayer(!0);else{var service=EventDungeonService.getInstance(),mt=MasterTable.getInstance().getMasterTable(),audio=AudioEngine.getInstance(),box_gacha_info_idx=GameContext.getInstance().getEventDungeonBoxGachaInfoIdx(),box_gacha_item=mt.get_EventDungeonBoxGachaItem(body.item_idx);if(box_gacha_item.bonus_type==BONUS_TYPE_GOLDEN_BARREL?this.showGoldenBarrelEffectLayer(box_gacha_item.bonus_type,body.random_bonus_type,body.random_bonus_count,body.random_item_idx):this.showNormalEffectLayer(box_gacha_item.bonus_type,body.item_count,box_gacha_item.min_value),this.showEffectLayer(box_gacha_item.bonus_type,box_gacha_item.min_value,body.item_count,body.item_idx),this.scheduleOnce(function(float){this.m_is_effect_layer_touch=!0}.bind(this),1,"showEffectLayer"),audio.stopVoice(),service.isBoxGachaMainItem(box_gacha_info_idx,body.item_idx)){var r=parseInt(Math.random()*this.m_main_voice_list.size());audio.playVoice(RES_CDN_SOUND+SND_TYPE+"voice_etc/"+this.m_main_voice_list.at(r),!1)}else{audio.stopVoice();r=parseInt(Math.random()*this.m_normal_voice_list.size());audio.playVoice(RES_CDN_SOUND+SND_TYPE+"voice_etc/"+this.m_normal_voice_list.at(r),!1)}this.m_board_layer.updateBoardLayer(body.item_idx)}else opcode==net.OP.op_event_dungeon_box_gacha_moving?(body.error,net.ERROR.NET_E_EVENT_DUNGEON_BOX_GACHA_ALREDY_MOVING,this.back()):opcode==net.OP.op_event_dungeon_box_gacha_extra_box_init?body.error==net.ERROR.NET_E_IMPOSSIBEL_EVENT_DUNGEON_BOX_GACHA_EXTRA_BOX_INIT?this.m_board_layer.reloadBoardLayer():body.error==net.ERROR.NET_E_SUCCESS&&(this.showExtraBoxInitComplete(),this.m_board_layer.resetBoardLayer()):opcode==net.OP.op_get_user_event_dungeon_box_gacha_progress_info?this.back():opcode==net.OP.op_get_user_event_dungeon_box_gacha_info&&body.error==net.ERROR.NET_E_SUCCESS&&(this.m_board_layer.reloadBoardLayer(),this.m_board_layer.setEnableTableLayer(!0))}}),btn_box_gacha_board=1e5,btn_box_gacha_show_info=100001,btn_help_popup=100002,btn_show_event_script=100003,EventDungeonBoxGachaEntranceLayer=cc.Layer.extend({m_guage_bar:null,m_cutin_info_btn:null,m_achv_new_icon:null,m_is_prv_event_dungeon:null,m_user_box_gacha_info_list:null,m_event_dungeon_cutin_accum_rate_point:null,m_gnrl_img:[],m_first_period_idx:0,m_second_period_idx:0,ctor:function(){this._super(),this.m_user_box_gacha_info_list=[],this.m_event_dungeon_cutin_accum_rate_point={},this.m_gnrl_img=[];var service=EventDungeonService.getInstance(),event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx();this.m_period=MasterManager.getInstance().get_EventDungeonPeriod(event_dungeon_period_idx),this.m_first_period_idx=service.getEventDungeonFirstHalfPeriodIdx(this.m_period.event_dungeon_group_idx),this.m_second_period_idx=service.getEventDungeonSecondHalfPeriodIdx(this.m_period.event_dungeon_group_idx),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_period_idx+"/btn_eventvs_box_1_off.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_period_idx+"/btn_eventvs_box_1_lock.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_period_idx+"/btn_eventvs_box_1_none.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_extra_box_1_lock.png",this.m_first_period_idx)),this.m_gnrl_img.push(RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_extra_box_1_lock.png",this.m_first_period_idx)),this.m_gnrl_img.push(RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_extra_box_1_lock.png",this.m_first_period_idx)),this.m_gnrl_img.push(RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_extra_box_1_lock.png",this.m_first_period_idx)),this.m_gnrl_img.push(RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_extra_box_1_lock.png",this.m_first_period_idx)),this.m_gnrl_img.push(RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_extra_box_1_lock.png",this.m_first_period_idx)),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_period_idx+"/btn_eventvs_extra_box_1_off.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_period_idx+"/btn_eventvs_extra_box_1_off.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_period_idx+"/btn_eventvs_extra_box_1_off.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_extra_box_1_none.png",this.m_first_period_idx)),this.m_gnrl_img.push(RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_extra_box_1_none.png",this.m_first_period_idx)),this.m_gnrl_img.push(RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_extra_box_1_none.png",this.m_first_period_idx)),this.m_gnrl_img.push(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_boxflow.png",this.m_first_period_idx)),this.m_gnrl_img.push(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_text_first.png",this.m_first_period_idx)),this.m_gnrl_img.push(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_text_second.png",this.m_first_period_idx)),this.m_gnrl_img.push(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_cut_cloud.png",this.m_first_period_idx)),this.m_gnrl_img.push(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_cut_gauge_back.png",this.m_first_period_idx)),this.m_gnrl_img.push(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_cut_gauge_red.png",this.m_first_period_idx)),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_period_idx+"/img_eventvs_cut_gauge_front.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_period_idx+"/img_eventvs_cut_gauge_on.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_cut_gauge_ef.png",this.m_first_period_idx)),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_period_idx+"/btn_eventvs_extra_box_init_off.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_period_idx+"/btn_eventvs_extra_box_init_on.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_period_idx+"/btn_eventvs_extra_box_init_none.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_info.png",this.m_first_period_idx)),this.m_gnrl_img.push(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_info.png",this.m_second_period_idx)),resourceLoader(this.m_gnrl_img,function(){this.init()}.bind(this))},init:function(){this._super();var winSize=ccSize(this),service=EventDungeonService.getInstance(),m=MasterManager.getInstance();this.m_is_prv_event_dungeon=BattleContext._getInstance().getIsPrvEventDungeon();var period_info={},event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx();this.m_period=m.get_EventDungeonPeriod(event_dungeon_period_idx);for(var event_priod=NetService()._event_dungeon_open_period_info.event_dungeon_open_period,idx=0;idx<event_priod.length;idx++){var p=event_priod[idx];if(this.m_period.event_dungeon_point_period_idx==p.event_dungeon_period_idx){period_info=p;break}}service.getUserEventDungeonCutinAccumRatePoint(period_info.event_dungeon_period_idx,this.m_event_dungeon_cutin_accum_rate_point);var _NetService=NetService();this.m_user_box_gacha_info_list=_NetService.get_User_Event_Dungeon_Box_Gacha_Info_List();var bg=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_period_idx+"/bg_eventvs_main.jpg");bg.setPosition(ccCenter(this)),this.addChild(bg);var help_btn=new ccui.Button("btn_help_off.png","btn_help_on.png","",ccui.Widget.PLIST_TEXTURE);help_btn.setAnchorPoint(ZERO()),help_btn.setPosition(10,476),this.addChild(help_btn),help_btn.addClickEventListener(function(sender){GameContext.getInstance().setHelpInfoIndexByCallIndex(2);var scene=new HelpContentScene;SceneManager.getInstance().pushScene(scene)}.bind(this));var cutin_layer=this.getCutinInfo();cutin_layer.ignoreAnchorPointForPosition(!1),cutin_layer.setAnchorPoint(ANCHOR_TOP_RIGHT()),cutin_layer.setPosition(ccWidth(this),ccHeight(this)),this.addChild(cutin_layer);var gacha_box_layer=this.getBoxGachaLayer();gacha_box_layer.setPosition(0,130),this.addChild(gacha_box_layer);var right_layer=this.getRightLayer();right_layer.ignoreAnchorPointForPosition(!1),right_layer.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),right_layer.setPosition(ccWidth(this),0),this.addChild(right_layer);var is_dungeon_open=service.IsOpenDungeon(this.m_second_period_idx);idx=this.m_first_period_idx;is_dungeon_open&&(idx=this.m_second_period_idx);var info_text_2=cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_info_2.png",idx));info_text_2.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),is_dungeon_open?info_text_2.setPosition(winSize.width,210):info_text_2.setPosition(winSize.width,163),this.addChild(info_text_2);var is_exist_prev_dungeon=service.IsExistPrevEventDungeon(this.m_period.event_dungeon_group_idx);is_exist_prev_dungeon=service.IsExistPrevEventDungeon(this.m_period.event_dungeon_group_idx);if(!this.m_is_prv_event_dungeon&&is_exist_prev_dungeon){var prv_event_dungeon_btn=new LabelButton("btn_39_off.png","btn_39_on.png","",ccui.Widget.PLIST_TEXTURE);prv_event_dungeon_btn.setFont(LABEL_FONT_INDEX.FONT_181),prv_event_dungeon_btn.setString(res_str("btn_label_prev_event_reward")),prv_event_dungeon_btn.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),prv_event_dungeon_btn.setPosition(winSize.width-150,220),prv_event_dungeon_btn.addClickEventListener(function(sender){BattleContext._getInstance().setPrvEventDungeonPeriodIdx(this.m_period.prev_event_dungeon_group_idx),MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonBoxGachaEntranceScene],NOTIFY_MENU_PRV_EVENT_DUNGEON_ENTRANCE)}.bind(this)),this.addChild(prv_event_dungeon_btn)}var info_text_img_text=cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_info_text.png",idx));return info_text_img_text.setAnchorPoint(ZERO()),info_text_img_text.setPosition(ZERO()),this.addChild(info_text_img_text),!0},getBoxGachaLayer:function(){var layer=new cc.Layer;layer.setContentSize(604,292);for(var service=EventDungeonService.getInstance(),mt=MasterManager.getInstance(),first_box_gacha_info_idx=service.getEventDungeonBoxGachaFirstBoxGachaInfoIdx(this.m_first_period_idx),x=15,y=191,i=0;i<8;++i){4==i&&(x=15,y=26);var box_gacha_info_idx=i+first_box_gacha_info_idx,box_gacha_info=mt.get_EventDungeonBoxGachaInfo(box_gacha_info_idx),off_img="",on_img="",none_img="",is_all_open=!1,is_not_open=!1,is_open_gacha=!1;1==box_gacha_info.extra_box?(off_img=RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_period_idx+"/btn_eventvs_extra_box_1_off.png",on_img=RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_period_idx+"/btn_eventvs_extra_box_1_off.png",none_img=RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_period_idx+"/btn_eventvs_extra_box_1_off.png",is_all_open=service.isBoxGachaAllOpen(box_gacha_info_idx),is_not_open=service.isBoxGachaNotOpen(box_gacha_info_idx),is_open_gacha=this.isOpenBoxGacha(box_gacha_info_idx),is_not_open&&!is_open_gacha?(off_img=RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_extra_box_1_lock.png",this.m_first_period_idx),on_img=RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_extra_box_1_lock.png",this.m_first_period_idx),none_img=RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_extra_box_1_lock.png",this.m_first_period_idx)):is_all_open&&(off_img=RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_extra_box_1_none.png",this.m_first_period_idx),on_img=RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_extra_box_1_none.png",this.m_first_period_idx),none_img=RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_extra_box_1_none.png",this.m_first_period_idx))):(off_img=RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_period_idx+"/btn_eventvs_box_1_off.png",on_img=RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_period_idx+"/btn_eventvs_box_1_off.png",none_img=RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_period_idx+"/btn_eventvs_box_1_off.png",is_all_open=service.isBoxGachaAllOpen(box_gacha_info_idx),is_not_open=service.isBoxGachaNotOpen(box_gacha_info_idx),is_open_gacha=this.isOpenBoxGacha(box_gacha_info_idx),is_not_open&&!is_open_gacha?(off_img=RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_box_1_lock.png",this.m_first_period_idx),on_img=RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_box_1_lock.png",this.m_first_period_idx),none_img=RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_box_1_lock.png",this.m_first_period_idx)):is_all_open&&(off_img=RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_box_1_none.png",this.m_first_period_idx),on_img=RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_box_1_none.png",this.m_first_period_idx),none_img=RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_box_1_none.png",this.m_first_period_idx)));var gacha_box_btn=new ccui.Button(off_img,on_img,none_img);if(gacha_box_btn.setAnchorPoint(ZERO()),gacha_box_btn.setPosition(x,y),gacha_box_btn.setTag({idx:box_gacha_info_idx,isOpen:is_open_gacha}),layer.addChild(gacha_box_btn),x+=110,gacha_box_btn.addClickEventListener(function(sender){var obj=sender.getTag();GameContext.getInstance().setEventDungeonBoxGachaInfoIdx(Number(obj.idx));var is_not_open_btn=service.isBoxGachaNotOpen(Number(obj.idx));obj.isOpen?MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonBoxGachaEntranceScene],btn_box_gacha_board):is_not_open_btn&&MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonBoxGachaEntranceScene],btn_box_gacha_show_info)}.bind(this)),is_open_gacha){var img=cc.Sprite.create();if(img.setAnchorPoint(ANCHOR_MIDDLE()),img.setPosition(ccCenter(gacha_box_btn)),gacha_box_btn.addChild(img),1==box_gacha_info.extra_box){var animation=MainAnimation.getInstance().getAnimate(MAIN_ANI_TYPE.EventDungeonExtraBoxGachaCurrentBox),repeat=new cc.RepeatForever(animation);img.runAction(repeat)}else if(is_all_open){animation=MainAnimation.getInstance().getAnimate(MAIN_ANI_TYPE.EventDungeonBoxGachaCompleteBox);repeat=new cc.RepeatForever(animation);img.runAction(repeat)}else{animation=MainAnimation.getInstance().getAnimate(MAIN_ANI_TYPE.EventDungeonBoxGachaCurrentBox);repeat=new cc.RepeatForever(animation);img.runAction(repeat)}}}var flow_img=cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_boxflow.png",this.m_first_period_idx));return flow_img.setAnchorPoint(ZERO()),flow_img.setPosition(ZERO()),layer.addChild(flow_img),layer},isOpenBoxGacha:function(box_gacha_info_idx){var mt=MasterManager.getInstance(),service=EventDungeonService.getInstance(),box_gacha_info=mt.get_EventDungeonBoxGachaInfo(box_gacha_info_idx);if(!service.IsOpenDungeon(box_gacha_info.event_dungeon_period_idx))return!1;var progress_list=NetService().get_User_Event_Dungeon_Box_Gacha_Info_Progress_List();if(1==box_gacha_info.extra_box)for(var prev_box_gacha_idx=box_gacha_info.prev_box_gacha_idx_1,prev_box_gacha_info=mt.get_EventDungeonBoxGachaInfo(prev_box_gacha_idx),idx=0;idx<this.m_user_box_gacha_info_list.length;idx++){if(this.m_user_box_gacha_info_list[idx].item_idx==prev_box_gacha_info.main_item_group_idx)return!0}else for(idx=0;idx<progress_list.length;idx++){var l=progress_list[idx];if(l.event_dungeon_period_idx==box_gacha_info.event_dungeon_period_idx&&l.box_gacha_info_idx==box_gacha_info_idx)return!0}return!1},getRightLayer:function(){var layer=new cc.Layer;layer.setContentSize(cc.size(454,217));var service=EventDungeonService.getInstance(),idx=this.m_first_period_idx,is_second=!1;service.IsOpenDungeon(this.m_second_period_idx)&&(idx=this.m_second_period_idx,is_second=!0);var info_box=cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_info.png",idx));info_box.setAnchorPoint(ZERO()),info_box.setPosition(0,76),layer.addChild(info_box);var y=25;if(is_second){var period=(mt=MasterManager.getInstance()).get_EventDungeonPeriod(this.m_second_period_idx),event_dungeon_point={};service.getUserEventDungeonPoint(period.event_dungeon_period_idx,event_dungeon_point),(event_point_count=cmLabel.getLabel(cmString(res_str("label_event_dungeon_own_point"),event_dungeon_point.event_point.toLocaleString("en")),LABEL_FONT_INDEX.FONT_247)).setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),event_point_count.setPosition(410,y),info_box.addChild(event_point_count),y+=50}var mt,event_point_count;period=(mt=MasterManager.getInstance()).get_EventDungeonPeriod(this.m_first_period_idx),event_dungeon_point={};service.getUserEventDungeonPoint(period.event_dungeon_period_idx,event_dungeon_point),(event_point_count=cmLabel.getLabel(cmString(res_str("label_event_dungeon_own_point"),event_dungeon_point.event_point.toLocaleString("en")),LABEL_FONT_INDEX.FONT_247)).setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),event_point_count.setPosition(410,y),info_box.addChild(event_point_count);ccWidth(layer),ccPosY(info_box),ccHeight(info_box);var help_popup_btn=new LabelButton("btn_36_off.png","btn_36_on.png","",ccui.Widget.PLIST_TEXTURE);help_popup_btn.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),help_popup_btn.setFont(LABEL_FONT_INDEX.FONT_181),help_popup_btn.setString(res_str("btn_label_event_dungeon_gacha_detail")),help_popup_btn.setPosition(176,38),help_popup_btn.addClickEventListener(function(sender){MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonBoxGachaEntranceScene],btn_help_popup)}),this.addChild(help_popup_btn);var achv_btn=new LabelButton("btn_36_off.png","btn_36_on.png","",ccui.Widget.PLIST_TEXTURE);(achv_btn.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),achv_btn.setFont(LABEL_FONT_INDEX.FONT_161),achv_btn.setString(res_str("btn_label_event_mission")),achv_btn.setPosition(10,38),achv_btn.addClickEventListener(function(sender){GameContext.getInstance().setAchievementTap(ACHIEVEMENT_EVENTDUNGEON),MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonBoxGachaEntranceScene],NOTIFY_MENU_ACHIEV)}),this.addChild(achv_btn),166,this.m_achv_new_icon=cc.Sprite.create(RES_CDN_DEFULT+"common/ic_new.png"),this.m_achv_new_icon.setAnchorPoint(ANCHOR_MIDDLE()),this.m_achv_new_icon.setPosition(5,35),achv_btn.addChild(this.m_achv_new_icon),null!=this.m_achv_new_icon)&&(AchievementService.getInstance().isNewCompleteAchievementEventDungeon(this.m_first_period_idx)?this.m_achv_new_icon.setVisible(!0):this.m_achv_new_icon.setVisible(!1));this.m_is_prv_event_dungeon&&(achv_btn.setEnabled(!1),this.m_achv_new_icon.setVisible(!1)),RaidBossService.getInstance().IsOpenRaidBoss();var first_half_btn=new LabelButton("btn_07_off.png","btn_07_on.png","btn_07_none.png",ccui.Widget.PLIST_TEXTURE);first_half_btn.setFont(LABEL_FONT_INDEX.FONT_221),first_half_btn.setString(mt.get_LanguageData("label_event_dungeon_first_half_enter_text")),first_half_btn.setAnchorPoint(ZERO()),first_half_btn.setPosition(0,16),layer.addChild(first_half_btn),first_half_btn.addClickEventListener(function(sender){this.entranceDungeonList(this.m_first_period_idx)}.bind(this)),first_half_btn.setEnabled(service.IsOpenDungeon(this.m_first_period_idx));var second_half_btn=new LabelButton("btn_07_off.png","btn_07_on.png","btn_07_none.png",ccui.Widget.PLIST_TEXTURE);return second_half_btn.setFont(LABEL_FONT_INDEX.FONT_221),second_half_btn.setString(mt.get_LanguageData("label_event_dungeon_second_half_enter_text")),second_half_btn.setAnchorPoint(ZERO()),second_half_btn.setPosition(ccWidth(first_half_btn),16),layer.addChild(second_half_btn),second_half_btn.addClickEventListener(function(sender){this.entranceDungeonList(this.m_second_period_idx)}.bind(this)),second_half_btn.setEnabled(service.IsOpenDungeon(this.m_second_period_idx)),layer},entranceDungeonList:function(event_dungeon_point_period_idx){if(!EventDungeonService.getInstance().IsOpenDungeon(event_dungeon_point_period_idx))return!1;BattleContext._getInstance().setEventDungeonPeriodIdX(event_dungeon_point_period_idx);var scene=new EventDungeonListScene;return SceneManager.getInstance().replaceScene(scene),!0},getCutinInfo:function(){var layer=new cc.Layer,winSize=(EventDungeonService.getInstance(),ccSize(this)),cloud_bg=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_sample/img_eventvs_cut_cloud.png");cloud_bg.setAnchorPoint(ANCHOR_TOP_RIGHT()),cloud_bg.setPosition(winSize.width,winSize.height-55),this.addChild(cloud_bg),layer.setContentSize(ccSize(cloud_bg));var progress_bg=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_gauge_frame.png",RectZero());progress_bg.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),progress_bg.setPreferredSize(cc.size(146,12)),progress_bg.setPosition(22,44),cloud_bg.addChild(progress_bg);var bar=new cc.Sprite(cmString(RES_CDN_DEFULT+"common/img_9p_gauge_red_3.png"));bar.setContentSize(cc.size(140,6)),bar._rect=cc.rect(0,0,140,6);var cutin_progress=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_gauge_red_3.png",RectZero());cutin_progress.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),cutin_progress.setPreferredSize(cc.size(0,6)),cutin_progress.setPosition(25,47),cloud_bg.addChild(cutin_progress);var off=RES_CDN_DEFULT+"menu_eventvs_sample/img_eventvs_cut_gauge_front.png",on=RES_CDN_DEFULT+"menu_eventvs_sample/img_eventvs_cut_gauge_on.png";if(this.m_cutin_info_btn=new ccui.Button(off,on),this.m_cutin_info_btn.setAnchorPoint(ANCHOR_TOP_RIGHT()),this.m_cutin_info_btn.setPosition(winSize.width,winSize.height-55),this.addChild(this.m_cutin_info_btn),this.m_cutin_info_btn.setEnabled(!this.m_is_prv_event_dungeon),this.m_cutin_info_btn.addClickEventListener(function(){var scene=new EventDungeonCutinBossInfoScene;SceneManager.getInstance().replaceScene(scene)}),this.m_is_prv_event_dungeon){var btn_mask=cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_cut_cloud_none.png",this.m_first_period_idx));btn_mask.setPosition(ccCenter(cloud_bg)),cloud_bg.addChild(btn_mask)}var blink_eff=cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_cut_gauge_ef.png",this.m_first_period_idx));blink_eff.setAnchorPoint(ANCHOR_MIDDLE()),blink_eff.setPosition(ccCenter(progress_bg)),blink_eff.setVisible(!1),blink_eff.setBlendFunc(GL_ONE,GL_ONE_MINUS_SRC_COLOR),progress_bg.addChild(blink_eff);var fo=cc.fadeOut(1),fi=cc.fadeIn(1),seq=cc.sequence(fo,fi),repeat=cc.repeatForever(seq);blink_eff.runAction(repeat);var cf=MasterManager.getInstance().get_CountFunction(4),per=this.m_event_dungeon_cutin_accum_rate_point.cutin_accum_rate/cf.value*100;100<per&&(per=100),0!=per?(cutin_progress.setPreferredSize(cc.size(1.4*per,6)),cutin_progress.setScaleX(1)):cutin_progress.setScaleX(0),blink_eff.setVisible(100<=per);var cutin_text=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_sample/img_eventvs_cut_text.png");return cutin_text.setAnchorPoint(ANCHOR_TOP_RIGHT()),cutin_text.setPosition(winSize.width-73,winSize.height-55),this.addChild(cutin_text),layer},onEnter:function(){this._super()},onExit:function(){this._super()}}),EventDungeonBoxGachaEntranceScene=GameScene.extend({m_entrance_layer:null,m_help_modal_layer:!1,m_script_modal:null,m_first_period_idx:0,m_second_period_idx:0,m_is_prv_event_dungeon:!1,ctor:function(){this._super(scene_EventDungeonBoxGachaEntranceScene)},init:function(){this.initLayoutProgress2();var m=MasterManager.getInstance(),event_dungeon_period_idx=0;this.m_is_prv_event_dungeon=BattleContext._getInstance().getIsPrvEventDungeon(),event_dungeon_period_idx=this.m_is_prv_event_dungeon?BattleContext._getInstance().getPrvEventDungeonPeriodIdx():BattleContext._getInstance().getEventDungeonPeriodIdx();var period=m.get_EventDungeonPeriod(event_dungeon_period_idx);this.m_first_period_idx=EventDungeonService.getInstance().getEventDungeonFirstHalfPeriodIdx(period.event_dungeon_group_idx),this.m_entrance_layer=new EventDungeonBoxGachaEntranceLayer,this.addChild(this.m_entrance_layer);var statusLayer=new StatusLayer;statusLayer.ignoreAnchorPointForPosition(!1),statusLayer.setAnchorPoint(ANCHOR_TOP_RIGHT()),statusLayer.setPosition(ccWidth(this),ccHeight(this)),this.addChild(statusLayer);var title=cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_text_event.png",this.m_first_period_idx));title.setAnchorPoint(ZERO()),title.setPosition(90,585),this.addChild(title);var back_btn=new ccui.Button;return back_btn.loadTextures("btn_home_off.png","btn_home_on.png","",ccui.Widget.PLIST_TEXTURE),back_btn.setAnchorPoint(ZERO()),back_btn.setPosition(10,559),back_btn.addClickEventListener(function(sender){this.back()}.bind(this)),this.addChild(back_btn),this.m_help_modal_layer=new GameModalLayer,this.addChild(this.m_help_modal_layer,99999),this.m_script_modal=new GameModalLayer,this.addChild(this.m_script_modal,99999),this.scheduleOnce(this.removeProgressEnd,1.5),!0},removeProgressEnd:function(){this.removeLayerProgress2()},showBoxGachaNotOpenInfo:function(){this.m_box.setTitle(res_str("label_shop_buy_jade_omission_title")),this.m_box.setText("1つ前のBOXで目玉報酬を獲得すると"),this.m_box.setText("\n"),this.m_box.setText("移動できるようになります。"),this.m_box.setText("\n"),this.m_box.setText("後半のBOX1は、前半のBOX1で目玉報酬を獲得すると、"),this.m_box.setText("\n"),this.m_box.setText("後半期間の開始後に開放されます。"),this.m_box.addButtonInfo(new MessageButtonInfo(res_str("btn_label_confirm"),MessageBoxButtonType.ButtonTypeNormal,0,function(){this.m_box.hide()}.bind(this))),this.m_box.show()},showHelpPopup:function(){this.m_help_modal_layer.setContentSize(ccSize(this)),this.m_help_modal_layer._contentNode=function(contentSize,m){var layer=new cc.Layer,bg_help=cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/bg_eventvs_help.png",this.m_first_period_idx));bg_help.setAnchorPoint(ANCHOR_MIDDLE()),bg_help.setPosition(ccCenter(layer)),layer.addChild(bg_help);var bg_btn=cc.Sprite.create(RES_CDN_DEFULT+"common/img_state_cloud.png");bg_btn.setAnchorPoint(ANCHOR_TOP_RIGHT()),bg_btn.setPosition(ccWidth(layer),ccHeight(layer)),layer.addChild(bg_btn);var btn=new ccui.Button("btn_cancel_off.png","btn_cancel_on.png","",ccui.Widget.PLIST_TEXTURE);return btn.setAnchorPoint(ANCHOR_TOP_RIGHT()),btn.setPosition(ccWidth(layer)-10,ccHeight(layer)-10),layer.addChild(btn),btn.addClickEventListener(function(sender){this.scheduleOnce(function(float){this.m_help_modal_layer.hide()},0,"btn")}.bind(this)),layer}.bind(this),this.m_help_modal_layer.show()},onEnter:function(){this._super();var event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx(),period=MasterManager.getInstance().get_EventDungeonPeriod(event_dungeon_period_idx),b_path=RES_CDN_SOUND+SND_TYPE+"sound/"+cmString(BGM_EVENT_DUNGEON_SCENE,period.event_dungeon_point_period_idx);MainObserver.getInstance().addObserver(this.onNotification,this,sceneStr[scene_EventDungeonBoxGachaEntranceScene]);var audio=AudioEngine.getInstance();audio.m_bgmPath!=b_path&&(audio.stopBackgroundMusic(),audio.playBackgroundMusic(b_path,!0))},onExit:function(){this._super(),MainObserver.getInstance().removeObserver(sceneStr[scene_EventDungeonBoxGachaEntranceScene])},back:function(){BattleContext._getInstance().setIsPrvEventDungeon(!1);var cur=0;if(0!=(cur=SceneManager.getInstance().getTopSceneId())){cur==scene_BattleScene&&(cur=scene_MainHomeScene);var scene=this.replace_scene(cur);SceneManager.getInstance().replaceScene(scene,!1)}},onNotification:function(msg){if(this._super(msg))return!1;if(msg==btn_box_gacha_board){var scene=new EventDungeonBoxGachaBoardScene;SceneManager.getInstance().replaceScene(scene)}else if(msg==btn_box_gacha_show_info)this.showBoxGachaNotOpenInfo();else if(msg==btn_help_popup)this.showHelpPopup();else if(msg==NOTIFY_MENU_SHOW_EVENT_SCRIPT){UserService.getInstance().getUserInfo().done(function(user_data){this.showEventScript(31001,user_data)}.bind(this))}return!0},showEventScript:function(event_dungeon_idx,user_data){this.m_script_modal.setContentSize(ccSize(this)),this.m_script_modal._contentNode=function(contentSize,m){var layer=new cc.Layer,script=new BattleEventDungeonScriptLayer(user_data);return script._scriptViewComplete=this,script.loadScript(event_dungeon_idx,1,function(){script.typingBattleScript()}.bind(this)),layer.setContentSize(ccSize(this)),layer.setPosition(ccCenter(this)),layer.ignoreAnchorPointForPosition(!1),layer.setAnchorPoint(ANCHOR_MIDDLE()),layer.addChild(script),layer}.bind(this),this.m_script_modal.is_show()||this.m_script_modal.show()},scriptEventDungeonComplete:function(){this.m_script_modal.is_show()&&this.m_script_modal.hide();var event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx(),period=MasterManager.getInstance().get_EventDungeonPeriod(event_dungeon_period_idx),b_path=RES_CDN_SOUND+SND_TYPE+"sound/"+cmString(BGM_EVENT_DUNGEON_SCENE,period.event_dungeon_point_period_idx),audio=AudioEngine.getInstance();audio.m_bgmPath!=b_path&&(audio.stopBackgroundMusic(),audio.playBackgroundMusic(b_path,!0))},onNetworkEvent:function(opcode,state,body){this._super(opcode,state,body)}}),EventDungeonBoxGachaEntranceSceneV2=GameScene.extend({m_entrance_layer:null,m_help_modal_layer:null,m_script_modal:null,m_first_period_idx:0,ctor:function(){this._super(scene_EventDungeonBoxGachaEntranceSceneV2)},init:function(){var m=MasterManager.getInstance(),context=BattleContext._getInstance(),event_dungeon_period_idx=0;event_dungeon_period_idx=context.getIsPrvEventDungeon()?context.getPrvEventDungeonPeriodIdx():context.getEventDungeonPeriodIdx();var period=m.get_EventDungeonPeriod(event_dungeon_period_idx);this.m_first_period_idx=EventDungeonService.getInstance().getEventDungeonFirstHalfPeriodIdx(period.event_dungeon_group_idx),this.m_entrance_layer=new EventDungeonBoxGachaEntranceLayerV2,this.addChild(this.m_entrance_layer);var statusLayer=new StatusLayer;statusLayer.initLayout(),statusLayer.ignoreAnchorPointForPosition(!1),statusLayer.setAnchorPoint(ANCHOR_TOP_RIGHT()),statusLayer.setPosition(ccWidth(this),ccHeight(this)),this.addChild(statusLayer);var title=cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_text_event.png",this.m_first_period_idx));title.setAnchorPoint(ZERO()),title.setPosition(90,585),this.addChild(title);var back_btn=new ccui.Button;return back_btn.loadTextures("btn_home_off.png","btn_home_on.png","",ccui.Widget.PLIST_TEXTURE),back_btn.setAnchorPoint(ZERO()),back_btn.setPosition(10,559),back_btn.addClickEventListener(function(){this.back()}.bind(this)),this.addChild(back_btn),this.m_help_modal_layer=new GameModalLayer,this.addChild(this.m_help_modal_layer),this.m_script_modal=new GameModalLayer,this.addChild(this.m_script_modal,99999),!0},onEnter:function(){this._super();var event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx(),b_path=RES_CDN_SOUND+SND_TYPE+"sound/"+cmString(BGM_EVENT_DUNGEON_SCENE,event_dungeon_period_idx);MainObserver.getInstance().addObserver(this.onNotification,this,sceneStr[scene_EventDungeonBoxGachaEntranceSceneV2]);var audio=AudioEngine.getInstance();audio.m_bgmPath!=b_path&&(audio.stopBackgroundMusic(),audio.playBackgroundMusic(b_path,!0))},onExit:function(){this._super()},onEnterTransitionDidFinish:function(){if(this._super(),USE_EVENT_DUNGEON_ACHIEVEMENT){var context=BattleContext._getInstance(),event_dungeon_period_idx=0;if(!context.getIsPrvEventDungeon()){event_dungeon_period_idx=context.getEventDungeonPeriodIdx();var period=MasterManager.getInstance().get_EventDungeonPeriod(event_dungeon_period_idx),req={};req.opcode=net.OP.op_user_event_dungeon_achv_list,req.event_dungeon_period_idx=period.event_dungeon_group_idx,this.network_write(req)}}},back:function(){BattleContext._getInstance().setIsPrvEventDungeon(!1),this.onKeyBack(!0)},onNotification:function(msg){if(this._super(msg),msg==NOTIFY_MENU_SHOW_EVENT_SCRIPT){var event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx(),prev_event_dungeon_idx=(period=MasterManager.getInstance().get_EventDungeonPeriod(event_dungeon_period_idx)).prev_event_dungeon_group_idx;this.showPrevEventScript(prev_event_dungeon_idx)}else if(msg==NOTIFY_MENU_SHOW_EVENT_EPILOGUE){event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx();var period=MasterManager.getInstance().get_EventDungeonPeriod(event_dungeon_period_idx);this.showEventEpilogue(period.event_dungeon_group_idx)}return!0},showPrevEventScript:function(event_dungeon_idx){this.m_script_modal.setContentSize(ccSize(this)),this.m_script_modal._contentNode=function(contentSize,m){var layer=new cc.Layer,script=new BattleEventDungeonScriptLayer;return script._scriptViewComplete=this,script.loadScript(event_dungeon_idx,1,function(){script.typingBattleScript()}.bind(this)),layer.setContentSize(ccSize(this)),layer.setPosition(ccCenter(this)),layer.ignoreAnchorPointForPosition(!1),layer.setAnchorPoint(ANCHOR_MIDDLE()),layer.addChild(script),layer},this.m_script_modal.is_show()||this.m_script_modal.show()},showEventEpilogue:function(event_dungeon_group_idx){this.m_script_modal.setContentSize(ccSize(this)),this.m_script_modal._contentNode=function(contentSize,m){this.initLayoutProgress();var layer=new cc.Layer,script=new EventDungeonEpilogueLayer;return script._scriptViewCompleteNotBattle=this,script.loadScript(event_dungeon_group_idx,4,function(){this.removeLayerProgress(),script.typingBattleScript()}.bind(this)),layer.setContentSize(ccSize(this)),layer.setPosition(ccCenter(this)),layer.ignoreAnchorPointForPosition(!1),layer.setAnchorPoint(ANCHOR_MIDDLE()),layer.addChild(script),layer}.bind(this),this.m_script_modal.is_show()||this.m_script_modal.show()},cbHideEventScript:function(){this.m_script_modal.is_show()&&this.m_script_modal.hide();var event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx(),period=MasterManager.getInstance().get_EventDungeonPeriod(event_dungeon_period_idx),b_path=RES_CDN_SOUND+SND_TYPE+"sound/"+cmString(BGM_EVENT_DUNGEON_SCENE,period.event_dungeon_point_period_idx),audio=AudioEngine.getInstance();audio.m_bgmPath!=b_path&&(audio.stopBackgroundMusic(),audio.playBackgroundMusic(b_path,!0))},onNetworkEvent:function(opcode,state,body){this._super(opcode,state,body),opcode==net.OP.op_user_event_dungeon_achv_list&&USE_EVENT_DUNGEON_ACHIEVEMENT&&this.m_entrance_layer.refreshEventDungeonAchvNewIcon()},showHelpPopup:function(){},showBoxGachaNotOpenInfo:function(){},scriptEventDungeonComplete:function(){this.m_script_modal.is_show()&&this.m_script_modal.hide();var event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx(),period=MasterManager.getInstance().get_EventDungeonPeriod(event_dungeon_period_idx),b_path=RES_CDN_SOUND+SND_TYPE+"sound/"+cmString(BGM_EVENT_DUNGEON_SCENE,period.event_dungeon_point_period_idx),audio=AudioEngine.getInstance();audio.m_bgmPath!=b_path&&(audio.stopBackgroundMusic(),audio.playBackgroundMusic(b_path,!0))}}),EventDungeonBoxGachaEntranceLayerV2=cc.Layer.extend({m_guage_bar:null,m_cutin_info_btn:null,m_cutin_progress:null,m_achv_new_icon:null,m_first_period_idx:0,m_second_period_idx:0,m_is_prv_event_dungeon:!1,m_epilogue_btn:null,m_epilogue_btn_img:null,m_event_dungeon_cutin_accum_rate_point:{},m_gnrl_img:null,ctor:function(){this._super(),this.m_event_dungeon_cutin_accum_rate_point={},this.m_gnrl_img=[],this.init()},init:function(){ccSize(this);var service=EventDungeonService.getInstance(),m=MasterManager.getInstance(),event_dungeon_period_idx=0;this.m_is_prv_event_dungeon=BattleContext._getInstance().getIsPrvEventDungeon(),event_dungeon_period_idx=this.m_is_prv_event_dungeon?BattleContext._getInstance().getPrvEventDungeonPeriodIdx():BattleContext._getInstance().getEventDungeonPeriodIdx();var period_info={};this.m_period=m.get_EventDungeonPeriod(event_dungeon_period_idx);for(var event_dungeon_open_period=NetService()._event_dungeon_open_period_info.event_dungeon_open_period,idx=0;idx<event_dungeon_open_period.length;idx++){var p=event_dungeon_open_period[idx];if(this.m_period.event_dungeon_point_period_idx==p.event_dungeon_period_idx){period_info=p;break}}this.m_first_period_idx=service.getEventDungeonFirstHalfPeriodIdx(this.m_period.event_dungeon_group_idx),this.m_second_period_idx=service.getEventDungeonSecondHalfPeriodIdx(this.m_period.event_dungeon_group_idx),service.getUserEventDungeonCutinAccumRatePoint(period_info.event_dungeon_period_idx,this.m_event_dungeon_cutin_accum_rate_point);for(var event_dungeon_box_gacha_info=NetService()._event_box_gacha_info_v2.event_dungeon_box_gacha_info,jdx=0;jdx<event_dungeon_box_gacha_info.length;jdx++){var box=event_dungeon_box_gacha_info[jdx];if(box.event_dungeon_period_idx==this.m_period.event_dungeon_point_period_idx){this.m_user_event_box_gacha_info=box;break}}this.m_gnrl_img.push(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_info_text.png",this.m_first_period_idx)),resourceLoader(this.m_gnrl_img,function(){var bg=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_period_idx+"/bg_eventvs_main.jpg");bg.setPosition(ccCenter(this)),this.addChild(bg);var help_btn=new ccui.Button("btn_help_off.png","btn_help_on.png","",ccui.Widget.PLIST_TEXTURE);help_btn.setAnchorPoint(ZERO()),help_btn.setPosition(10,476),this.addChild(help_btn),help_btn.addClickEventListener(function(sender){GameContext.getInstance().setHelpInfoIndexByCallIndex(2);var scene=new HelpContentScene;SceneManager.getInstance().pushScene(scene)}.bind(this));var info_layer=this.getInfoLayer();this.addChild(info_layer);var right_layer=this.getRightLayer();return right_layer.ignoreAnchorPointForPosition(!1),right_layer.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),right_layer.setPosition(ccWidth(this),0),this.addChild(right_layer),!0}.bind(this))},onEnter:function(){this._super()},onExit:function(){this._super()},getInfoLayer:function(){var layer=new cc.Layer,winSize=ccSize(this),service=(MasterTable.getInstance(),EventDungeonService.getInstance()),pos_y=8,is_dungeon_open=!1,idx=this.m_first_period_idx;if(this.m_is_prv_event_dungeon?service.IsOpenEventPointPeriod(this.m_second_period_idx)&&(idx=this.m_second_period_idx,is_dungeon_open=!0):service.IsOpenDungeon(this.m_second_period_idx)&&(idx=this.m_second_period_idx,is_dungeon_open=!0),!this.m_is_prv_event_dungeon){var info_text_img_text,info_text_2=cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_info_2.png",idx));info_text_2.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),is_dungeon_open?info_text_2.setPosition(winSize.width,212):info_text_2.setPosition(winSize.width,162),layer.addChild(info_text_2),(info_text_img_text=cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_info_text.png",idx))).setAnchorPoint(ZERO()),info_text_img_text.setPosition(10,pos_y),layer.addChild(info_text_img_text),pos_y+=ccHeight(info_text_img_text)+22}this.m_is_prv_event_dungeon;var achv_btn=new LabelButton("btn_36_off.png","btn_36_on.png","btn_36_none.png",ccui.Widget.PLIST_TEXTURE);(achv_btn.setFont(LABEL_FONT_INDEX.FONT_161),achv_btn.setColor(cc.color(238,238,238)),achv_btn.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),achv_btn.setString(res_str("btn_label_event_mission")),achv_btn.setPosition(10,pos_y),layer.addChild(achv_btn),achv_btn.addClickEventListener(function(sender){if(USE_EVENT_DUNGEON_ACHIEVEMENT){var scene=new EventDungeonAchievementScene_V2;SceneManager.getInstance().replaceScene(scene)}else GameContext.getInstance().setAchievementTap(ACHIEVEMENT_EVENTDUNGEON),MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonBoxGachaEntranceSceneV2],NOTIFY_MENU_ACHIEV)}),pos_y+=ccHeight(achv_btn)+10,this.m_achv_new_icon=cc.Sprite.create(RES_CDN_DEFULT+"common/ic_new.png"),this.m_achv_new_icon.setAnchorPoint(ANCHOR_MIDDLE()),this.m_achv_new_icon.setPosition(5,ccHeight(achv_btn)-5),achv_btn.addChild(this.m_achv_new_icon),this.m_achv_new_icon.setVisible(!1),null!=this.m_achv_new_icon)&&(USE_EVENT_DUNGEON_ACHIEVEMENT?this.m_achv_new_icon.setVisible(!1):AchievementService.getInstance().isNewCompleteAchievementEventDungeon(this.m_first_period_idx)?this.m_achv_new_icon.setVisible(!0):this.m_achv_new_icon.setVisible(!1));var is_exist_prev_dungeon=service.IsExistPrevEventDungeon(this.m_period.event_dungeon_group_idx);if(!this.m_is_prv_event_dungeon&&is_exist_prev_dungeon){var prv_event_dungeon_btn=new LabelButton("btn_36_off.png","btn_36_on.png","",ccui.Widget.PLIST_TEXTURE);prv_event_dungeon_btn.setFont(LABEL_FONT_INDEX.FONT_181),prv_event_dungeon_btn.setString(res_str("btn_label_prev_event_reward")),prv_event_dungeon_btn.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),prv_event_dungeon_btn.setPosition(10,pos_y),layer.addChild(prv_event_dungeon_btn),prv_event_dungeon_btn.addClickEventListener(function(sender){BattleContext._getInstance().setPrvEventDungeonPeriodIdx(this.m_period.prev_event_dungeon_group_idx),MainObserver.getInstance().postNotification(NOTIFY_MENU_PRV_EVENT_DUNGEON_ENTRANCE)}.bind(this))}return this.m_is_prv_event_dungeon&&(achv_btn.setEnabled(!1),this.m_achv_new_icon.setVisible(!1)),layer},getRightLayer:function(){var layer=new cc.Layer;layer.setContentSize(cc.size(454,217));var service=EventDungeonService.getInstance(),idx=this.m_first_period_idx,is_second=!1;this.m_is_prv_event_dungeon?service.IsOpenEventPointPeriod(this.m_second_period_idx)&&(idx=this.m_second_period_idx,is_second=!0):service.IsOpenDungeon(this.m_second_period_idx)&&(idx=this.m_second_period_idx,is_second=!0);var info_box=cc.Sprite.create(cmString(RES_CDN_DEFULT+"menu_eventvs_%d/img_eventvs_info.png",idx));info_box.setAnchorPoint(ZERO()),info_box.setPosition(0,81),layer.addChild(info_box);var y=25;if(is_second){var period=MasterManager.getInstance().get_EventDungeonPeriod(this.m_second_period_idx),event_dungeon_point={};service.getUserEventDungeonPoint(period.event_dungeon_period_idx,event_dungeon_point),(event_point_count=cmLabel.getLabel(cmString(res_str("label_event_dungeon_own_point"),Number(event_dungeon_point.event_point).toLocaleString("en")),LABEL_FONT_INDEX.FONT_2011)).setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),event_point_count.setPosition(266,y),info_box.addChild(event_point_count);var second_gacha_half_btn=new LabelButton("btn_36_off.png","btn_36_on.png","",ccui.Widget.PLIST_TEXTURE);second_gacha_half_btn.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),second_gacha_half_btn.setFont(LABEL_FONT_INDEX.FONT_181),second_gacha_half_btn.setString(res_str("event_dungeon_box_gacha_second_half_entrance_btn_title")),second_gacha_half_btn.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),second_gacha_half_btn.setPosition(430,y-8),info_box.addChild(second_gacha_half_btn),second_gacha_half_btn.addClickEventListener(function(sender){this.entranceBoxGacha(this.m_second_period_idx)}.bind(this)),this.m_is_prv_event_dungeon?second_gacha_half_btn.setEnabled(service.IsOpenEventPointPeriod(this.m_second_period_idx)):second_gacha_half_btn.setEnabled(service.IsOpenDungeon(this.m_second_period_idx)),y+=50}var event_point_count;period=MasterManager.getInstance().get_EventDungeonPeriod(this.m_first_period_idx),event_dungeon_point={};service.getUserEventDungeonPoint(period.event_dungeon_period_idx,event_dungeon_point),(event_point_count=cmLabel.getLabel(cmString(res_str("label_event_dungeon_own_point"),Number(event_dungeon_point.event_point).toLocaleString()),LABEL_FONT_INDEX.FONT_2011)).setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),event_point_count.setPosition(266,y),info_box.addChild(event_point_count);var first_gacha_half_btn=new LabelButton("btn_36_off.png","btn_36_on.png","",ccui.Widget.PLIST_TEXTURE);first_gacha_half_btn.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),first_gacha_half_btn.setFont(LABEL_FONT_INDEX.FONT_181),first_gacha_half_btn.setString(res_str("event_dungeon_box_gacha_first_half_entrance_btn_title")),first_gacha_half_btn.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),first_gacha_half_btn.setPosition(430,y-8),info_box.addChild(first_gacha_half_btn),first_gacha_half_btn.addClickEventListener(function(sender){this.entranceBoxGacha(this.m_first_period_idx)}.bind(this)),this.m_is_prv_event_dungeon?first_gacha_half_btn.setEnabled(service.IsOpenEventPointPeriod(this.m_first_period_idx)):first_gacha_half_btn.setEnabled(service.IsOpenDungeon(this.m_first_period_idx));ccWidth(layer),ccPosY(info_box),ccHeight(info_box);var first_half_btn=new LabelButton("btn_07_off.png","btn_07_on.png","",ccui.Widget.PLIST_TEXTURE);first_half_btn.setFont(LABEL_FONT_INDEX.FONT_221),first_half_btn.setString(res_str("label_event_dungeon_first_half_enter_text")),first_half_btn.setAnchorPoint(ZERO()),first_half_btn.setPosition(0,16),layer.addChild(first_half_btn),first_half_btn.addClickEventListener(function(sender){this.entranceDungeonList(this.m_first_period_idx)}.bind(this)),first_half_btn.setEnabled(service.IsOpenDungeon(this.m_first_period_idx));var second_half_btn=new LabelButton("btn_07_off.png","btn_07_on.png","",ccui.Widget.PLIST_TEXTURE);return second_half_btn.setFont(LABEL_FONT_INDEX.FONT_221),second_half_btn.setString(res_str("label_event_dungeon_second_half_enter_text")),second_half_btn.setAnchorPoint(ZERO()),second_half_btn.setPosition(ccWidth(first_half_btn),16),layer.addChild(second_half_btn),second_half_btn.addClickEventListener(function(sender){this.entranceDungeonList(this.m_second_period_idx)}.bind(this)),second_half_btn.setEnabled(service.IsOpenDungeon(this.m_second_period_idx)),layer},entranceDungeonList:function(event_dungeon_point_period_idx){if(!EventDungeonService.getInstance().IsOpenDungeon(event_dungeon_point_period_idx))return!1;BattleContext._getInstance().setEventDungeonPeriodIdX(event_dungeon_point_period_idx);var scene=new EventDungeonListScene;return SceneManager.getInstance().replaceScene(scene),!0},entranceBoxGacha:function(event_dungeon_point_period_idx){var service=EventDungeonService.getInstance();if(this.m_is_prv_event_dungeon){if(!service.IsOpenEventPointPeriod(event_dungeon_point_period_idx))return!1;BattleContext._getInstance().setPrvEventDungeonPeriodIdx(event_dungeon_point_period_idx)}else{if(!service.IsOpenDungeon(event_dungeon_point_period_idx))return!1;BattleContext._getInstance().setEventDungeonPeriodIdX(event_dungeon_point_period_idx)}this.getParent().initLayoutProgress2();var scene=new EventDungeonBoxGachaSceneV2;return scene.get_story_deferred().done(function(){this.scheduleOnce(function(dt){SceneManager.getInstance().replaceScene(scene,!0)},.5,"main_layer_ready")}.bind(this)),!0},refreshEventDungeonAchvNewIcon:function(){for(var service=EventDungeonService.getInstance(),period_list=MasterTable.getInstance().get_EventDungeonPeriodList(this.m_period.event_dungeon_group_idx),is_new=!1,i=0;i<period_list.length;i++){var p=period_list[i];if(service.IsOpenDungeon(p.event_dungeon_period_idx)&&service.IsEnableGainEventDungeonAchvReward(p.event_dungeon_period_idx)){is_new=!0;break}}this.m_achv_new_icon.setVisible(is_new)}}),EventDungeonBoxGachaSceneV2=GameScene.extend({m_board_layer:null,m_boxgacha_detail_popup:null,m_is_effect_layer_touch:!1,m_statusLayer:null,m_isLineupPopupShow:!1,m_deferred:$.Deferred(),ctor:function(){this._super(scene_EventDungeonBoxGachaSceneV2),this.init2()},get_story_deferred:function(){return this.m_deferred},init2:function(){var m=MasterManager.getInstance(),context=BattleContext._getInstance(),event_dungeon_period_idx=0;event_dungeon_period_idx=context.getIsPrvEventDungeon()?context.getPrvEventDungeonPeriodIdx():context.getEventDungeonPeriodIdx();var period=m.get_EventDungeonPeriod(event_dungeon_period_idx),first_idx=EventDungeonService.getInstance().getEventDungeonFirstHalfPeriodIdx(period.event_dungeon_group_idx);this.m_isLineupPopupShow=!1,this.m_board_layer=new EventDungeonBoxGachaLayerV2(this.m_deferred),this.addChild(this.m_board_layer),this.m_statusLayer=new StatusLayer,this.m_statusLayer.initLayout(),this.m_statusLayer.ignoreAnchorPointForPosition(!1),this.m_statusLayer.setAnchorPoint(ANCHOR_TOP_RIGHT()),this.m_statusLayer.setPosition(ccWidth(this),ccHeight(this)),this.addChild(this.m_statusLayer);var title=cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_text_event.png",first_idx));title.setAnchorPoint(ZERO()),title.setPosition(90,585),this.addChild(title);var back_btn=new ccui.Button;return back_btn.loadTextures("btn_home_off.png","btn_home_on.png","",ccui.Widget.PLIST_TEXTURE),back_btn.setAnchorPoint(ZERO()),back_btn.setPosition(10,559),back_btn.addClickEventListener(function(){1!=RAID_BOSS_MODAL_OPEN_FLAG&&1!=this.m_isLineupPopupShow&&this.back()}.bind(this)),this.addChild(back_btn),this.m_boxgacha_detail_popup=new GameModalLayer,this.addChild(this.m_boxgacha_detail_popup,1e4),this.m_normal_voice_list=[],this.m_normal_voice_list.push_back("yue_kunsyu_0001.mp3"),this.m_normal_voice_list.push_back("yue_kunsyu_0002.mp3"),this.m_normal_voice_list.push_back("yue_kunsyu_0003.mp3"),this.m_normal_voice_list.push_back("yue_kunsyu_0025.mp3"),this.m_main_voice_list=[],this.m_main_voice_list.push_back("yue_kunsyu_0023.mp3"),this.m_main_voice_list.push_back("yue_kunsyu_0024.mp3"),this.m_main_voice_list.push_back("yue_kunsyu_0028.mp3"),!0},onEnter:function(){this._super(),MainObserver.getInstance().addObserver(this.onNotification,this,sceneStr[scene_EventDungeonBoxGachaSceneV2]);var event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx(),period=MasterManager.getInstance().get_EventDungeonPeriod(event_dungeon_period_idx),b_path=RES_CDN_SOUND+SND_TYPE+"sound/"+cmString(BGM_EVENT_DUNGEON_SCENE,period.event_dungeon_point_period_idx),audio=AudioEngine.getInstance();audio.m_bgmPath!=b_path&&(audio.stopBackgroundMusic(),audio.playBackgroundMusic(b_path,!0))},onExit:function(){this._super(),AudioEngine.getInstance().stopVoice(),MainObserver.getInstance().removeObserver(sceneStr[scene_EventDungeonBoxGachaSceneV2])},back:function(){this.onKeyBack(!0)},onNotification:function(msg){return!this._super(msg)&&(msg==btn_box_gacha_detail_popup&&this.showBoxGachaDetailPopup(),msg==btn_box_gacha_lineup_popup_on&&(this.m_board_layer.showLineupPopup(),this.m_statusLayer.setStatusDisable(!0),this.m_isLineupPopupShow=!0),msg==btn_box_gacha_lineup_popup_off?(this.m_board_layer.hideLineupPopupV2(),this.m_statusLayer.setStatusDisable(!1),this.m_isLineupPopupShow=!1):msg==btn_epilogue_open_view&&this.back(),!0)},onNetworkEvent:function(opcode,state,body){if(this._super(opcode,body,state),body.error==net.ERROR.NET_E_SUCCESS)if(opcode==net.OP.op_event_dungeon_box_gacha_buy_v2)this.m_board_layer.recvBoxGachaBuyResult(body);else if(opcode==net.OP.op_event_dungeon_box_gacha_reset_v2){var box_gacha=MasterManager.getInstance().get_EventDungeonBoxGachaV2(body.open_box_gacha_idx,body.event_dungeon_period_idx);if(body.event_dungeon_box_gacha_idx==body.open_box_gacha_idx)(msg=[]).push_back(cmString(res_str("label_event_dungeno_box_gacha_reset_msg_2"),box_gacha.name)),this.showMsgBox(msg);else(msg=[]).push_back(cmString(res_str("label_event_dungeno_box_gacha_reset_msg_1"),box_gacha.name)),this.showMsgBox(msg);var p=MasterManager.getInstance().get_EventDungeonPeriod(body.event_dungeon_period_idx),req={};req.opcode=net.OP.op_event_dungeon_box_gacha_info_v2,req.event_dungeon_group_idx=p.event_dungeon_group_idx,EVENT_BOX_GACHA_RESET=!0,this.network_write(req)}else opcode==net.OP.op_event_dungeon_box_gacha_info_v2&&1==EVENT_BOX_GACHA_RESET&&(EVENT_BOX_GACHA_RESET=!1,this.m_board_layer.recvBoxGachaResetResult(body));else if(opcode==net.OP.op_event_dungeon_box_gacha_buy_v2){if(body.error==net.ERROR.NET_E_BAD_PARAMETER)var msg=[];else if(body.error==net.ERROR.NET_E_LACK_EVENT_DUNGEON_POINT){(msg=[]).push_back(res_str("label_event_dungeon_point_lack")),this.showMsgBox(msg)}else if(body.error==net.ERROR.NET_E_OVER_MAX_COUNT){(msg=[]).push_back(res_str("label_event_dungeon_box_gacha_next_open_1")),msg.push_back(res_str("label_event_dungeon_box_gacha_next_open_2")),this.showMsgBox(msg)}}else if(opcode==net.OP.op_event_dungeon_box_gacha_reset_v2){if(body.error==net.ERROR.NET_E_NOT_RECEIVE_MAIN_REWARD)(msg=[]).push_back(res_str("label_event_dungeon_box_gacha_reset_error_1")),msg.push_back(res_str("label_event_dungeon_box_gacha_reset_error_2")),msg.push_back(res_str("label_event_dungeon_box_gacha_reset_error_3")),msg.push_back(res_str("label_event_dungeon_box_gacha_reset_error_4")),this.showMsgBox(msg)}else opcode==net.OP.op_event_dungeon_box_gacha_info_v2&&1==EVENT_BOX_GACHA_RESET&&(EVENT_BOX_GACHA_RESET=!1)},showBoxGachaDetailPopup:function(){this.m_boxgacha_detail_popup.setContentSize(ccSize(this)),this.m_boxgacha_detail_popup._contentNode=function(contentSize,m){var context=BattleContext._getInstance(),event_dungeon_period_idx=0;event_dungeon_period_idx=context.getIsPrvEventDungeon()?context.getPrvEventDungeonPeriodIdx():context.getEventDungeonPeriodIdx();var mt=MasterManager.getInstance(),period=mt.get_EventDungeonPeriod(event_dungeon_period_idx),service=EventDungeonService.getInstance(),first_idx=service.getEventDungeonFirstHalfPeriodIdx(period.event_dungeon_group_idx),second_idx=service.getEventDungeonSecondHalfPeriodIdx(period.event_dungeon_group_idx),is_second=!1;event_dungeon_period_idx==second_idx&&(is_second=!0);var layer=new cc.Layer,bg_mask=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_normal.png",RectZero());bg_mask.setPosition(ccCenter(this)),bg_mask.setContentSize(ccSize(this)),layer.addChild(bg_mask);var bg=new cc.Scale9Sprite(RES_CDN_DEFULT+"common/img_9p_script_box_2.png",RectZero());bg.setInsetLeft(44),bg.setInsetRight(44),bg.setInsetTop(44),bg.setInsetBottom(44),bg.setPreferredSize(cc.size(958,555)),bg.setAnchorPoint(ANCHOR_MIDDLE()),bg.setPosition(ccCenter(this)),layer.addChild(bg);var navi=new cc.Scale9Sprite(RES_CDN_DEFULT+"common/img_9p_navi.png",RectZero());navi.setInsetLeft(46),navi.setInsetRight(46),navi.setPreferredSize(cc.size(942,48)),navi.setAnchorPoint(ANCHOR_MIDDLE_TOP()),navi.setPosition(ccCenter(bg).x,ccHeight(bg)-11),bg.addChild(navi);var title_label=cmLabel.getLabel(res_str("label_event_dungeon_box_gacha_notice_btn"),LABEL_FONT_INDEX.FONT_241);title_label.setAnchorPoint(ANCHOR_MIDDLE()),title_label.setPosition(ccCenter(navi)),navi.addChild(title_label);var first_period=mt.get_EventDungeonPeriod(first_idx),second_period=mt.get_EventDungeonPeriod(second_idx),first_name=mt.get_EventPointUnitType(first_period.event_point_unit_type).name,second_name=mt.get_EventPointUnitType(second_period.event_point_unit_type).name,content_label=cmLabel.getLabel(is_second?cmString(res_str("label_event_dungeon_box_gacha_detail_msg2"),second_name,second_name):cmString(res_str("label_event_dungeon_box_gacha_detail_msg1"),first_name,first_name),LABEL_FONT_INDEX.FONT_181);content_label.setAnchorPoint(ANCHOR_TOP_LEFT());var viewSize=cc.size(858,470),content_height=ccHeight(content_label)+20;content_height<viewSize.height&&(content_height=viewSize.height);var container=new cc.Layer;container.ignoreAnchorPointForPosition(!1),container.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),container.setContentSize(viewSize.width,content_height),container.setPosition(ZERO());var scroll_view=new cc.ScrollView(viewSize,container);scroll_view.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),scroll_view.setPosition(50,17),scroll_view.setDirection(cc.SCROLLVIEW_DIRECTION_VERTICAL),bg.addChild(scroll_view),scroll_view.setContentOffset(cc.p(0,viewSize.height-content_height),!1),content_label.setPosition(0,ccHeight(container)),container.addChild(content_label);var back_btn=new ccui.Button("btn_cancel_off.png","btn_cancel_on.png","",ccui.Widget.PLIST_TEXTURE);return back_btn.setAnchorPoint(ANCHOR_TOP_RIGHT()),back_btn.setPosition(ccWidth(bg)-10,ccHeight(bg)-10),back_btn.addClickEventListener(function(sender){this.hideBoxGachaDetailPopup()}.bind(this)),bg.addChild(back_btn),layer}.bind(this),this.m_boxgacha_detail_popup.show()},hideBoxGachaDetailPopup:function(){this.m_boxgacha_detail_popup.is_show()&&this.m_boxgacha_detail_popup.hide()}}),SELECTED_IMAGE_TAG=99999,COUNT_LABEL_TAG=88888,TOOLTIP_BTN_TAG=77777,box_gacha_in=7,box_gacha_buy=8,btn_box_gacha_detail_popup=789842,btn_epilogue_open_view=789843,GACHA_COST_LABEL_TAG=66666,btn_box_gacha_lineup_popup_on=789844,btn_box_gacha_lineup_popup_off=789845,EventDungeonBoxGachaLayerV2=cc.Layer.extend({m_left_layer:null,m_right_layer:null,m_next_box_gacha_btn:null,m_next_box_gacha_btn_dis:null,m_main_item_icon:null,m_event_point_label:null,m_item_lineup_popup:null,m_recv_item_list_popup:null,m_gacha_count_label:null,tooltip_box:null,tooltip_content:null,m_effect_popup:null,m_is_effect_layer_touch:!1,m_gacha_count_title:null,m_main_item_count:null,m_gacha_title:null,m_is_prv_event_dungeon:!1,m_message_box:null,m_tooltip_box:null,m_tooltip_content:null,m_position_list:null,m_content_view_btn:null,m_golden_barrel_popup:null,m_golden_barrel_help_btn:null,m_btn:null,m_btn1:null,m_btn2:null,m_icon:null,m_icon1:null,m_icon2:null,m_cnt_label:null,m_cnt_label1:null,m_cnt_label2:null,m_cost_label:null,m_cost_label1:null,m_cost_label2:null,m_first_event_period_idx:0,m_second_event_period_idx:0,m_box_gacha_proc:[],m_sub_main_items:[],m_user_event_box_gacha_info:[],m_sub_main_item_icons:[],m_main_item_data:[],m_box_gacha_buy_result:null,m_sub_pos_list:[],m_gacha_btns:[],m_enter_voice:[],m_gacha_voice:[],m_event_dungeon_point:{},m_gnrl_img:null,m_deferred:null,ctor:function(deferred){this._super(),this.m_box_gacha_proc=[],this.m_sub_main_items=[],this.m_user_event_box_gacha_info=[],this.m_sub_main_item_icons=[],this.m_main_item_data=[],this.m_box_gacha_buy_result=null,this.m_sub_pos_list=[],this.m_gacha_btns=[],this.m_enter_voice=[],this.m_gacha_voice=[],this.m_event_dungeon_point={},this.m_deferred=deferred,this.init()},init:function(){RAID_BOSS_MODAL_OPEN_FLAG=!1,this.m_position_list=new Array;var service=EventDungeonService.getInstance(),m=MasterManager.getInstance(),context=BattleContext._getInstance();this.m_is_prv_event_dungeon=context.getIsPrvEventDungeon();var event_dungeon_period_idx=0;event_dungeon_period_idx=this.m_is_prv_event_dungeon?BattleContext._getInstance().getPrvEventDungeonPeriodIdx():BattleContext._getInstance().getEventDungeonPeriodIdx();this.m_period=m.get_EventDungeonPeriod(event_dungeon_period_idx);for(var netService=new NetService,event_dungeon_open_period=netService._event_dungeon_open_period_info.event_dungeon_open_period,idx=0;idx<event_dungeon_open_period.length;idx++){var p=event_dungeon_open_period[idx];if(this.m_period.event_dungeon_point_period_idx==p.event_dungeon_period_idx){this.m_period_info=p;break}}service.getUserEventDungeonPoint(this.m_period.event_dungeon_point_period_idx,this.m_event_dungeon_point),this.m_first_event_period_idx=service.getEventDungeonFirstHalfPeriodIdx(this.m_period.event_dungeon_group_idx),this.m_second_event_period_idx=service.getEventDungeonSecondHalfPeriodIdx(this.m_period.event_dungeon_group_idx);for(var event_dungeon_box_gacha_info=netService._event_box_gacha_info_v2.event_dungeon_box_gacha_info,jdx=0;jdx<event_dungeon_box_gacha_info.length;jdx++){var box=event_dungeon_box_gacha_info[jdx];if(box.event_dungeon_period_idx==this.m_period.event_dungeon_point_period_idx){this.m_user_event_box_gacha_info=box;break}}this.m_gnrl_img=[],this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_group_idx+"/bg_eventvs_sub.jpg"),this.m_gnrl_img.push(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_panel.png",this.m_period.event_dungeon_group_idx)),this.m_gnrl_img.push(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_panel_text.png",this.m_period.event_dungeon_point_period_idx));for(var box_gacha_list=MasterTable.getInstance().get_EventDungeonBoxGachaV2List(this.m_period.event_dungeon_point_period_idx),i=0;i<box_gacha_list.length;i++)this.m_gnrl_img.push(RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_box_%d_off.png",this.m_period.event_dungeon_group_idx,i+1)),this.m_gnrl_img.push(RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_box_%d_none.png",this.m_period.event_dungeon_group_idx,i+1));this.m_gnrl_img.push(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_boxgacha.png",this.m_period.event_dungeon_group_idx)),this.m_recv_item_list_popup=new GameModalLayer,this.addChild(this.m_recv_item_list_popup,1e4),this.m_item_lineup_popup=new GameModalLayer,this.addChild(this.m_item_lineup_popup,1e4),this.m_effect_popup=new GameModalLayer,this.addChild(this.m_effect_popup,1e4),this.m_message_box=new GameMessageBox,this.addChild(this.m_message_box,1e4),this.m_golden_barrel_popup=new GameMessageBox,this.addChild(this.m_golden_barrel_popup,1e4),resourceLoader(this.m_gnrl_img,function(){var winSize=ccSize(this),bg=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_group_idx+"/bg_eventvs_sub.jpg");bg.setAnchorPoint(ANCHOR_MIDDLE()),bg.setPosition(ccCenter(this)),this.addChild(bg),this.m_left_layer=this.createLeftBoxLayer(),this.m_left_layer.setPosition(LP(this,-53,0)),this.addChild(this.m_left_layer),this.m_right_layer=this.createRightBoxLayer(),this.m_right_layer.setPosition(winSize.width-ccWidth(this.m_right_layer)-10,0),this.addChild(this.m_right_layer),this.m_tooltip_box=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_result_box.png",cc.Rect(20,20,20,20)),this.m_tooltip_box.setAnchorPoint(ANCHOR_MIDDLE()),this.m_tooltip_box.setPosition(ZERO()),this.m_tooltip_box.setVisible(!1),this.m_right_layer.addChild(this.m_tooltip_box),this.m_tooltip_content=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_181),this.m_tooltip_content.setAnchorPoint(ANCHOR_MIDDLE()),this.m_tooltip_content.setPosition(ccCenter(this.m_tooltip_box)),this.m_tooltip_box.addChild(this.m_tooltip_content),this.getParent().removeLayerProgress2(),this.m_deferred.resolve(!0)}.bind(this))},onEnter:function(){this._super()},onExit:function(){if(this._super(),null!=this.m_gnrl_img){for(var idx=0;idx<this.m_gnrl_img.length;idx++)cc.loader.release(this.m_gnrl_img[idx]);this.m_gnrl_img=null,AudioEngine.getInstance().stopEffectsAll()}},onEnterTransitionDidFinish:function(){this._super(),this.playStateVoicePlay(box_gacha_in)},playStateVoicePlay:function(voice_type){var audio=AudioEngine.getInstance(),voice_list=MasterTable.getInstance().get_EventDungeonVoiceList(this.m_period.event_dungeon_period_idx,voice_type);if(0<voice_list.length){var r=parseInt(Math.random()*voice_list.length);audio.stopEffectsAll();var voice_path=RES_CDN_SOUND+SND_TYPE+"voice_etc/"+voice_list[r].voice_name+".mp3";audio.playVoice(voice_path)}},createLeftBoxLayer:function(){var layer=new cc.Layer,m=MasterManager.getInstance(),mt=MasterTable.getInstance(),frame_box=cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_panel.png",this.m_period.event_dungeon_group_idx));frame_box.setAnchorPoint(ANCHOR_TOP_LEFT()),frame_box.setPosition(0,ccHeight(this)),layer.addChild(frame_box),layer.setContentSize(ccSize(frame_box));var box_title=cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_panel_text.png",this.m_period.event_dungeon_point_period_idx));box_title.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),box_title.setPosition(ccCenter(frame_box).x,513),frame_box.addChild(box_title);for(var box_gacha_list=mt.get_EventDungeonBoxGachaV2List(this.m_period.event_dungeon_point_period_idx),btn_offset_y=(mt.get_EventDungeonBoxGachaItemListV2(this.m_user_event_box_gacha_info.event_dungeon_period_idx,this.m_user_event_box_gacha_info.event_dungeon_box_gacha_idx),397),is_selected=!1,i=0;i<box_gacha_list.length;i++){var box_info=box_gacha_list[i],box_img=null;is_selected=box_info.event_dungeon_box_gacha_idx==this.m_user_event_box_gacha_info.event_dungeon_box_gacha_idx&&box_info.event_dungeon_period_idx==this.m_user_event_box_gacha_info.event_dungeon_period_idx?(box_img=cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_box_%d_off.png",this.m_period.event_dungeon_group_idx,i+1)),!0):(box_img=cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_box_%d_none.png",this.m_period.event_dungeon_group_idx,i+1)),!1),box_img.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),box_img.setPosition(ccCenter(frame_box).x,btn_offset_y),frame_box.addChild(box_img);var selecting_img=cc.Sprite.create("#img_shop_box_arrow.png");selecting_img.setAnchorPoint(ANCHOR_MIDDLE_RIGHT()),selecting_img.setPosition(-5,ccCenter(box_img).y),selecting_img.setTag(SELECTED_IMAGE_TAG),box_img.addChild(selecting_img),selecting_img.setVisible(is_selected);var m1=new cc.MoveTo(.5,cc.p(0,ccCenter(box_img).y)),m2=new cc.MoveTo(.5,cc.p(-5,ccCenter(box_img).y)),seq=new cc.Sequence(m1,m2),repeat=new cc.RepeatForever(seq);if(selecting_img.runAction(repeat),i<box_gacha_list.length-1){var arrow=cc.Sprite.create("#img_shop_box_arrow_blue.png");arrow.setAnchorPoint(ANCHOR_MIDDLE_TOP()),arrow.setPosition(ccCenter(frame_box).x,btn_offset_y+12),frame_box.addChild(arrow,100)}this.m_box_gacha_proc.push_back(box_img),btn_offset_y-=80}var noti=cmLabel.getLabel(res_str("label_event_dungeon_box_gacha_notice_msg"),LABEL_FONT_INDEX.FONT_161);noti.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),noti.setPosition(.5*ccWidth(frame_box),123),noti.enableOutline(cc.color.BLACK,1),frame_box.addChild(noti);var cur_box_gacha=m.get_EventDungeonBoxGachaV2(this.m_user_event_box_gacha_info.event_dungeon_box_gacha_idx,this.m_user_event_box_gacha_info.event_dungeon_period_idx),next_box_gacha=m.get_EventDungeonBoxGachaV2(cur_box_gacha.next_box_gacha_idx,cur_box_gacha.event_dungeon_period_idx);return this.m_next_box_gacha_btn=new LabelButton(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_group_idx+"/btn_eventvs_box_5_off.png",RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_group_idx+"/btn_eventvs_box_5_on.png",RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_group_idx+"/btn_eventvs_box_5_none.png"),this.m_next_box_gacha_btn.setFont(LABEL_FONT_INDEX.FONT_241),this.m_next_box_gacha_btn.setOffFont(LABEL_FONT_INDEX.FONT_242),cur_box_gacha.name==next_box_gacha.name?this.m_next_box_gacha_btn.setString(cmString(res_str("label_event_dungeon_ed_box_reset_btn"),next_box_gacha.name)):this.m_next_box_gacha_btn.setString(cmString(res_str("label_event_dungeon_gacha_next_box_move"),next_box_gacha.name)),this.m_next_box_gacha_btn.addClickEventListener(function(){this.showNextBoxPopup()}.bind(this)),this.m_next_box_gacha_btn.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_next_box_gacha_btn.setPosition(ccCenter(frame_box).x,40),frame_box.addChild(this.m_next_box_gacha_btn),this.m_next_box_gacha_btn.setVisible(!1),this.m_next_box_gacha_btn.setEnabled(!1),this.m_next_box_gacha_btn_dis=new LabelButton(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_group_idx+"/btn_eventvs_box_5_none.png",RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_group_idx+"/btn_eventvs_box_5_none.png",RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_group_idx+"/btn_eventvs_box_5_none.png"),this.m_next_box_gacha_btn_dis.setFont(LABEL_FONT_INDEX.FONT_241),this.m_next_box_gacha_btn_dis.setOffFont(LABEL_FONT_INDEX.FONT_242),cur_box_gacha.name==next_box_gacha.name?this.m_next_box_gacha_btn_dis.setString(cmString(res_str("label_event_dungeon_ed_box_reset_btn"),next_box_gacha.name)):this.m_next_box_gacha_btn_dis.setString(cmString(res_str("label_event_dungeon_gacha_next_box_move"),next_box_gacha.name)),this.m_next_box_gacha_btn_dis.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_next_box_gacha_btn_dis.setPosition(ccCenter(frame_box).x,40),this.m_next_box_gacha_btn_dis.setEnabled(!1),this.m_next_box_gacha_btn_dis.setVisible(!1),frame_box.addChild(this.m_next_box_gacha_btn_dis),layer},createRightBoxLayer:function(){var layer=new cc.Layer;layer.setContentSize(666,498);var m=MasterTable.getInstance(),mt=MasterManager.getInstance(),bg=(EventDungeonService.getInstance(),cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_boxgacha.png",this.m_period.event_dungeon_group_idx)));bg.setAnchorPoint(ZERO()),bg.setPosition(0,107),layer.addChild(bg);var bgSize=cc.size(ccSize(bg)),cur_box_gacha=mt.get_EventDungeonBoxGachaV2(this.m_user_event_box_gacha_info.event_dungeon_box_gacha_idx,this.m_user_event_box_gacha_info.event_dungeon_period_idx);"BOX 1"==cur_box_gacha.name?this.m_gacha_title=cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_box_text_1.png",this.m_period.event_dungeon_group_idx)):"BOX 2"==cur_box_gacha.name?this.m_gacha_title=cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_box_text_2.png",this.m_period.event_dungeon_group_idx)):"BOX 3"==cur_box_gacha.name?this.m_gacha_title=cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_box_text_3.png",this.m_period.event_dungeon_group_idx)):"EX BOX"==cur_box_gacha.name&&(this.m_gacha_title=cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_box_text_4.png",this.m_period.event_dungeon_group_idx))),this.m_gacha_title.setAnchorPoint(ANCHOR_TOP_LEFT()),this.m_gacha_title.setPosition(0,bgSize.height-14),bg.addChild(this.m_gacha_title);var item_list=m.get_EventDungeonBoxGachaItemListV2(cur_box_gacha.event_dungeon_period_idx,cur_box_gacha.event_dungeon_box_gacha_idx),remain=item_list.length-this.m_user_event_box_gacha_info.buy_log.length;this.m_gacha_count_label=cmLabel.getLabel(cmString("%d/%d",remain,item_list.length),LABEL_FONT_INDEX.FONT_247),this.m_gacha_count_label.setAnchorPoint(ANCHOR_MIDDLE_RIGHT()),this.m_gacha_count_label.setPosition(bgSize.width-26,bgSize.height-36),bg.addChild(this.m_gacha_count_label),this.m_gacha_count_title=cmLabel.getLabel(res_str("label_event_dungeon_box_gacha_remain_title_v2"),LABEL_FONT_INDEX.FONT_2013),this.m_gacha_count_title.setAnchorPoint(ANCHOR_MIDDLE_RIGHT()),this.m_gacha_count_title.setPosition(this.m_gacha_count_label.getPositionX()-ccWidth(this.m_gacha_count_label)-10,bgSize.height-36),bg.addChild(this.m_gacha_count_title),this.m_sub_main_items=[];for(var idx=0;idx<item_list.length;idx++){1==(item=item_list[idx]).main_bonus_type?this.m_main_item_data=item:2==item.main_bonus_type&&9999!=item.display_id&&this.m_sub_main_items.push(item)}if(this.m_sub_main_items.sort(function(l,r){return l.display_id>r.display_id?1:l.display_id<r.display_id?-1:0}),this.m_main_item_data.bonus_type==BONUS_TYPE_YUNHEE_FIX){var card={};card.gnrl_id=this.m_main_item_data.min_value,card.level=1,this.m_main_item_icon=(new Card).createCard(card,CARD_TYPE.type_common_card),this.m_main_item_icon.setAnchorPoint(ANCHOR_MIDDLE()),this.m_main_item_icon.setPosition(179,195),bg.addChild(this.m_main_item_icon)}else this.m_main_item_data.bonus_type==BONUS_TYPE_GOLDEN_BARREL&&(this.m_main_item_icon=cc.Sprite.create(cmString("#img_reward_%d_d.png",this.m_main_item_data.bonus_type)),this.m_main_item_icon.setContentSize(140,140),this.m_main_item_icon.setAnchorPoint(ANCHOR_MIDDLE()),this.m_main_item_icon.setPosition(179,195),this.m_main_item_icon.setScale(.8),bg.addChild(this.m_main_item_icon),this.m_golden_barrel_help_btn=new ccui.Button("btn_help_off.png","btn_help_on.png","",ccui.Widget.PLIST_TEXTURE),this.m_golden_barrel_help_btn.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),this.m_golden_barrel_help_btn.setPosition(227,244),bg.addChild(this.m_golden_barrel_help_btn,100),this.m_golden_barrel_help_btn.addClickEventListener(function(sender){this.showGoldenBarrelLineupPopup()}.bind(this)));if(null!=this.m_main_item_icon){this.m_main_item_icon.setTag(this.m_main_item_data.event_dungeon_box_gacha_item_idx),(tooltip_btn=new cc.ControlButton(cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_transbox.png",cc.Rect(1,1,1,1)))).setAnchorPoint(ANCHOR_MIDDLE()),tooltip_btn.setPreferredSize(ccSize(this.m_main_item_icon)),tooltip_btn.setPosition(ccCenter(this.m_main_item_icon)),tooltip_btn.setTag(TOOLTIP_BTN_TAG),this.m_main_item_icon.addChild(tooltip_btn),tooltip_btn.addTargetWithActionForControlEvents(this,this.onItemToolTipTouch,cc.CONTROL_EVENT_TOUCH_DOWN),tooltip_btn.addTargetWithActionForControlEvents(this,this.onItemToolTipTouch,cc.CONTROL_EVENT_TOUCH_UP_INSIDE),tooltip_btn.addTargetWithActionForControlEvents(this,this.onItemToolTipTouch,cc.CONTROL_EVENT_TOUCH_UP_OUTSIDE),tooltip_btn.addTargetWithActionForControlEvents(this,this.onItemToolTipTouch,cc.CONTROL_EVENT_TOUCH_CANCEL),this.m_main_item_count=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_161),this.m_main_item_count.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_main_item_count.setPosition(181,100),this.m_main_item_count.setTag(COUNT_LABEL_TAG),bg.addChild(this.m_main_item_count);for(var total_count=0,gain_count=0,i=0;i<item_list.length;i++){(it=item_list[i]).event_dungeon_period_idx==this.m_main_item_data.event_dungeon_period_idx&&it.event_dungeon_box_gacha_idx==this.m_main_item_data.event_dungeon_box_gacha_idx&&it.bonus_type==this.m_main_item_data.bonus_type&&it.main_bonus_type==this.m_main_item_data.main_bonus_type&&total_count++}for(var jdx=0;jdx<this.m_user_event_box_gacha_info.buy_log.length;jdx++){(item=mt.get_EventDungeonBoxGachaItemV2(this.m_user_event_box_gacha_info.buy_log[jdx].event_dungeon_box_gacha_item_idx,this.m_user_event_box_gacha_info.buy_log[jdx].event_dungeon_box_gacha_idx,this.m_user_event_box_gacha_info.buy_log[jdx].event_dungeon_period_idx)).event_dungeon_period_idx==this.m_main_item_data.event_dungeon_period_idx&&item.event_dungeon_box_gacha_idx==this.m_main_item_data.event_dungeon_box_gacha_idx&&item.bonus_type==this.m_main_item_data.bonus_type&&item.main_bonus_type==this.m_main_item_data.main_bonus_type&&gain_count++}remain=total_count-gain_count;this.m_main_item_count.setString(cmString(res_str("label_event_dungeon_box_gacha_remain_item_count_v2"),remain))}var event_point_icon,sub_pos_list=[];sub_pos_list.push_back([394,270]),sub_pos_list.push_back([531,270]),sub_pos_list.push_back([394,136]),sub_pos_list.push_back([531,136]);for(i=0;i<this.m_sub_main_items.length;i++){var sub=this.m_sub_main_items[i];if(i<sub_pos_list.length){var tooltip_btn,pos=sub_pos_list.at(i),sub_item=null;(sub_item=sub.bonus_type==BONUS_TYPE_YUNHEE_FIX?cc.Sprite.create(cmString("#img_reward_%02d_%d.png",parseInt(sub.bonus_type),parseInt(sub.min_value))):cc.Sprite.create(cmString("#img_reward_%02d.png",parseInt(sub.bonus_type)))).setAnchorPoint(ANCHOR_MIDDLE()),sub_item.setPosition(pos[0],pos[1]),bg.addChild(sub_item),sub_item.setTag(sub.event_dungeon_box_gacha_item_idx),(tooltip_btn=new cc.ControlButton(cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_transbox.png",cc.Rect(1,1,1,1)))).setAnchorPoint(ANCHOR_MIDDLE()),tooltip_btn.setPreferredSize(ccSize(sub_item)),tooltip_btn.setPosition(ccCenter(sub_item)),tooltip_btn.setTag(TOOLTIP_BTN_TAG),sub_item.addChild(tooltip_btn),tooltip_btn.addTargetWithActionForControlEvents(this,this.onItemToolTipTouch,cc.CONTROL_EVENT_TOUCH_DOWN),tooltip_btn.addTargetWithActionForControlEvents(this,this.onItemToolTipTouch,cc.CONTROL_EVENT_TOUCH_UP_INSIDE),tooltip_btn.addTargetWithActionForControlEvents(this,this.onItemToolTipTouch,cc.CONTROL_EVENT_TOUCH_UP_OUTSIDE),tooltip_btn.addTargetWithActionForControlEvents(this,this.onItemToolTipTouch,cc.CONTROL_EVENT_TOUCH_CANCEL);var cnt_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_161);cnt_label.setAnchorPoint(ANCHOR_MIDDLE_TOP()),cnt_label.setPosition(ccCenter(sub_item).x,-25),cnt_label.setTag(COUNT_LABEL_TAG),sub_item.addChild(cnt_label);for(total_count=0,gain_count=0,idx=0;idx<item_list.length;idx++){var it;(it=item_list[idx]).event_dungeon_period_idx==sub.event_dungeon_period_idx&&it.event_dungeon_box_gacha_idx==sub.event_dungeon_box_gacha_idx&&it.bonus_type==sub.bonus_type&&it.main_bonus_type==sub.main_bonus_type&&total_count++}for(jdx=0;jdx<this.m_user_event_box_gacha_info.buy_log.length;jdx++){var item;(item=mt.get_EventDungeonBoxGachaItemV2(this.m_user_event_box_gacha_info.buy_log[jdx].event_dungeon_box_gacha_item_idx,this.m_user_event_box_gacha_info.buy_log[jdx].event_dungeon_box_gacha_idx,this.m_user_event_box_gacha_info.buy_log[jdx].event_dungeon_period_idx)).event_dungeon_period_idx==sub.event_dungeon_period_idx&&item.event_dungeon_box_gacha_idx==sub.event_dungeon_box_gacha_idx&&item.bonus_type==sub.bonus_type&&item.main_bonus_type==sub.main_bonus_type&&gain_count++}remain=total_count-gain_count;cnt_label.setString(cmString(res_str("label_event_dungeon_box_gacha_remain_item_count_v2"),remain)),this.m_sub_main_item_icons.push(sub_item)}}103001==this.m_period.event_dungeon_point_period_idx?((event_point_icon=cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_point.png",this.m_period.event_dungeon_point_period_idx))).setAnchorPoint(ANCHOR_MIDDLE_RIGHT()),event_point_icon.setPosition(ccWidth(bg)-112+14,24),bg.addChild(event_point_icon)):((event_point_icon=cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_point.png",this.m_period.event_dungeon_point_period_idx))).setAnchorPoint(ANCHOR_MIDDLE_RIGHT()),event_point_icon.setPosition(ccWidth(bg)-112,24),bg.addChild(event_point_icon));this.m_event_point_label=cmLabel.getLabel(cmString(res_str("label_event_dungeon_own_point"),Number(this.m_event_dungeon_point.event_point).toLocaleString()),LABEL_FONT_INDEX.FONT_181),this.m_event_point_label.setAnchorPoint(ANCHOR_MIDDLE_RIGHT()),this.m_event_point_label.setPosition(ccWidth(bg)-24,24),bg.addChild(this.m_event_point_label);var cost_list=m.get_EventDungeonBoxGachaCostInfoListV2(cur_box_gacha.event_dungeon_period_idx,cur_box_gacha.event_dungeon_box_gacha_idx),cnt_strings=[];cnt_strings.push_back("N"),cnt_strings.push_back("O"),cnt_strings.push_back("P");var cost_btn_offset_x=43,cost=cost_list;this.m_btn=new LabelButton("btn_gacha_small_off.png","btn_gacha_small_on.png","btn_gacha_small_none.png",ccui.Widget.PLIST_TEXTURE),this.m_btn.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),this.m_btn.setPosition(cost_btn_offset_x,19),layer.addChild(this.m_btn),this.m_btn.addClickEventListener(function(sender){this.reqBoxGachaV2(cost[0].event_dungeon_box_gacha_cost_info_idx)}.bind(this)),this.m_icon=cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_point.png",this.m_period.event_dungeon_point_period_idx)),this.m_icon.setAnchorPoint(ANCHOR_MIDDLE_LEFT()),this.m_icon.setPosition(0,.5*ccHeight(this.m_btn)),this.m_btn.addChild(this.m_icon),this.m_cnt_label=cmLabel.createWithBMFont(RES_CDN_DEFULT+"fonts/img_eventvs_btn_text.fnt",cnt_strings.at(0),cc.TEXT_ALIGNMENT_CENTER),this.m_cnt_label.setAnchorPoint(ANCHOR_MIDDLE_TOP()),this.m_cnt_label.setPosition(.5*ccWidth(this.m_btn),ccHeight(this.m_btn)-18),this.m_btn.addChild(this.m_cnt_label),this.m_cost_label=cmLabel.createWithBMFont(RES_CDN_DEFULT+"fonts/img_eventvs_btn_text.fnt",cmString("%sM",Number(cost[0].need_point).toLocaleString()),cc.TEXT_ALIGNMENT_CENTER),this.m_cost_label.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_cost_label.setPosition(.5*ccWidth(this.m_btn),2),this.m_cost_label.setTag(GACHA_COST_LABEL_TAG),this.m_btn.addChild(this.m_cost_label),cost_btn_offset_x+=ccWidth(this.m_btn)+9,this.m_gacha_btns.push_back(this.m_btn),this.m_btn1=new LabelButton("btn_gacha_small_off.png","btn_gacha_small_on.png","btn_gacha_small_none.png",ccui.Widget.PLIST_TEXTURE),this.m_btn1.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),this.m_btn1.setPosition(cost_btn_offset_x,19),layer.addChild(this.m_btn1),this.m_btn1.addClickEventListener(function(sender){this.reqBoxGachaV2(cost[1].event_dungeon_box_gacha_cost_info_idx)}.bind(this)),this.m_icon1=cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_point.png",this.m_period.event_dungeon_point_period_idx)),this.m_icon1.setAnchorPoint(ANCHOR_MIDDLE_LEFT()),this.m_icon1.setPosition(0,.5*ccHeight(this.m_btn1)),this.m_btn1.addChild(this.m_icon1),this.m_cnt_label1=cmLabel.createWithBMFont(RES_CDN_DEFULT+"fonts/img_eventvs_btn_text.fnt",cnt_strings.at(1),cc.TEXT_ALIGNMENT_CENTER),this.m_cnt_label1.setAnchorPoint(ANCHOR_MIDDLE_TOP()),this.m_cnt_label1.setPosition(.5*ccWidth(this.m_btn1),ccHeight(this.m_btn1)-18),this.m_btn1.addChild(this.m_cnt_label1),this.m_cost_label1=cmLabel.createWithBMFont(RES_CDN_DEFULT+"fonts/img_eventvs_btn_text.fnt",cmString("%sM",Number(cost[1].need_point).toLocaleString()),cc.TEXT_ALIGNMENT_CENTER),this.m_cost_label1.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_cost_label1.setPosition(.5*ccWidth(this.m_btn1),2),this.m_cost_label1.setTag(GACHA_COST_LABEL_TAG+1),this.m_btn1.addChild(this.m_cost_label1),cost_btn_offset_x+=ccWidth(this.m_btn1)+9,this.m_gacha_btns.push_back(this.m_btn1),this.m_btn2=new LabelButton("btn_gacha_small_off.png","btn_gacha_small_on.png","btn_gacha_small_none.png",ccui.Widget.PLIST_TEXTURE),this.m_btn2.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),this.m_btn2.setPosition(cost_btn_offset_x,19),layer.addChild(this.m_btn2),this.m_btn2.addClickEventListener(function(sender){this.reqBoxGachaV2(cost[2].event_dungeon_box_gacha_cost_info_idx)}.bind(this)),this.m_icon2=cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_point.png",this.m_period.event_dungeon_point_period_idx)),this.m_icon2.setAnchorPoint(ANCHOR_MIDDLE_LEFT()),this.m_icon2.setPosition(0,.5*ccHeight(this.m_btn2)),this.m_btn2.addChild(this.m_icon2),this.m_cnt_label2=cmLabel.createWithBMFont(RES_CDN_DEFULT+"fonts/img_eventvs_btn_text.fnt",cnt_strings.at(2),cc.TEXT_ALIGNMENT_CENTER),this.m_cnt_label2.setAnchorPoint(ANCHOR_MIDDLE_TOP()),this.m_cnt_label2.setPosition(.5*ccWidth(this.m_btn2),ccHeight(this.m_btn2)-18),this.m_btn2.addChild(this.m_cnt_label2),this.m_cost_label2=cmLabel.createWithBMFont(RES_CDN_DEFULT+"fonts/img_eventvs_btn_text.fnt",cmString("%sM",Number(cost[2].need_point).toLocaleString()),cc.TEXT_ALIGNMENT_CENTER),this.m_cost_label2.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_cost_label2.setPosition(.5*ccWidth(this.m_btn2),2),this.m_cost_label2.setTag(GACHA_COST_LABEL_TAG+2),this.m_btn2.addChild(this.m_cost_label2),cost_btn_offset_x+=ccWidth(this.m_btn2)+9,this.m_gacha_btns.push_back(this.m_btn2),this.m_content_view_btn=new LabelButton("btn_29_off.png","btn_29_on.png","",ccui.Widget.PLIST_TEXTURE),this.m_content_view_btn.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),this.m_content_view_btn.setPosition(0,508),this.m_content_view_btn.setFont(LABEL_FONT_INDEX.FONT_181),this.m_content_view_btn.setOffFont(LABEL_FONT_INDEX.FONT_188),this.m_content_view_btn.setString(cmString(res_str("label_event_dungeon_box_gacha_lineup_btn"),cur_box_gacha.name)),this.m_content_view_btn.addClickEventListener(function(sender){MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonBoxGachaSceneV2],btn_box_gacha_lineup_popup_on)}.bind(this)),layer.addChild(this.m_content_view_btn);var notice_btn=new LabelButton("btn_29_off.png","btn_29_on.png","",ccui.Widget.PLIST_TEXTURE);return notice_btn.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),notice_btn.setPosition(260,508),notice_btn.setFont(LABEL_FONT_INDEX.FONT_181),notice_btn.setOffFont(LABEL_FONT_INDEX.FONT_188),notice_btn.setString(res_str("label_event_dungeon_box_gacha_notice_btn")),notice_btn.addClickEventListener(function(sender){MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonBoxGachaSceneV2],btn_box_gacha_detail_popup)}),layer.addChild(notice_btn),this.checkEnableResetBtn(),layer},reqBoxGachaV2:function(cost_info_idx){var cost=MasterManager.getInstance().get_EventDungeonBoxGachaCostInfoV2(cost_info_idx);if(0!=cost.event_dungeon_box_gacha_cost_info_idx){if(this.m_event_dungeon_point.event_point<cost.need_point){var scene=SceneManager.getInstance().getRunningScene(),msg=[];return msg.push_back(res_str("label_event_dungeon_point_lack")),void scene.showMsgBox(msg)}var req={};req.opcode=net.OP.op_event_dungeon_box_gacha_buy_v2,req.event_dungeon_period_idx=this.m_user_event_box_gacha_info.event_dungeon_period_idx,req.event_dungeon_box_gacha_idx=this.m_user_event_box_gacha_info.event_dungeon_box_gacha_idx,req.event_dungeon_box_gacha_cost_info_idx=cost.event_dungeon_box_gacha_cost_info_idx,SceneManager.getInstance().getRunningScene().network_write(req),this.playStateVoicePlay(box_gacha_buy)}},reqNextBoxGachaV2:function(){var req={};req.opcode=net.OP.op_event_dungeon_box_gacha_reset_v2,req.event_dungeon_period_idx=this.m_user_event_box_gacha_info.event_dungeon_period_idx,req.event_dungeon_box_gacha_idx=this.m_user_event_box_gacha_info.event_dungeon_box_gacha_idx,SceneManager.getInstance().getRunningScene().network_write(req)},recvBoxGachaBuyResult:function(res){this.m_box_gacha_buy_result=res;var netService=new NetService;EventDungeonService.getInstance().getUserEventDungeonPoint(this.m_period.event_dungeon_point_period_idx,this.m_event_dungeon_point);for(var event_dungeon_box_gacha_info=netService._event_box_gacha_info_v2.event_dungeon_box_gacha_info,idx=0;idx<event_dungeon_box_gacha_info.length;idx++){var box=event_dungeon_box_gacha_info[idx];if(box.event_dungeon_period_idx==this.m_period.event_dungeon_point_period_idx){this.m_user_event_box_gacha_info=box;break}}this.updateLayout(),this.checkEnableResetBtn(),1==res.reward_items.size()?this.showRewardItemEffectPopup(res.buy_log.at(0),res.reward_items.at(0)):(RAID_BOSS_MODAL_OPEN_FLAG=!0,this.showRecvItemListPopup(res))},recvBoxGachaResetResult:function(res){for(var event_dungeon_box_gacha_info=(new NetService)._event_box_gacha_info_v2.event_dungeon_box_gacha_info,idx=0;idx<event_dungeon_box_gacha_info.length;idx++){var box=event_dungeon_box_gacha_info[idx];if(box.event_dungeon_period_idx==this.m_period.event_dungeon_point_period_idx){this.m_user_event_box_gacha_info=box;break}}this.resetLayout()},updateLayout:function(){for(var total_count=0,gain_count=0,m=MasterTable.getInstance(),mt=MasterManager.getInstance(),cur_box_gacha=mt.get_EventDungeonBoxGachaV2(this.m_user_event_box_gacha_info.event_dungeon_box_gacha_idx,this.m_user_event_box_gacha_info.event_dungeon_period_idx),item_list=m.get_EventDungeonBoxGachaItemListV2(cur_box_gacha.event_dungeon_period_idx,cur_box_gacha.event_dungeon_box_gacha_idx),idx=0;idx<item_list.length;idx++){(it=item_list[idx]).event_dungeon_period_idx==this.m_main_item_data.event_dungeon_period_idx&&it.event_dungeon_box_gacha_idx==this.m_main_item_data.event_dungeon_box_gacha_idx&&it.bonus_type==this.m_main_item_data.bonus_type&&it.main_bonus_type==this.m_main_item_data.main_bonus_type&&total_count++}for(var jdx=0;jdx<this.m_user_event_box_gacha_info.buy_log.length;jdx++){(item=mt.get_EventDungeonBoxGachaItemV2(this.m_user_event_box_gacha_info.buy_log[jdx].event_dungeon_box_gacha_item_idx,this.m_user_event_box_gacha_info.buy_log[jdx].event_dungeon_box_gacha_idx,this.m_user_event_box_gacha_info.buy_log[jdx].event_dungeon_period_idx)).event_dungeon_period_idx==this.m_main_item_data.event_dungeon_period_idx&&item.event_dungeon_box_gacha_idx==this.m_main_item_data.event_dungeon_box_gacha_idx&&item.bonus_type==this.m_main_item_data.bonus_type&&item.main_bonus_type==this.m_main_item_data.main_bonus_type&&gain_count++}var remain=total_count-gain_count;this.m_main_item_count.setString(cmString(res_str("label_event_dungeon_box_gacha_remain_item_count_v2"),remain));for(var i=0;i<this.m_sub_main_items.length;i++){var sub=this.m_sub_main_items[i];if(i<this.m_sub_main_item_icons.length){for(var found=0,found_is=!1,idx2=0;idx2<this.m_sub_main_item_icons.length;idx2++){if(found=idx2,this.m_sub_main_item_icons[idx2].getTag()==sub.event_dungeon_box_gacha_item_idx){found_is=!0;break}}if(1==found_is){for(var icon=this.m_sub_main_item_icons[found],idx3=gain_count=total_count=0;idx3<item_list.length;idx3++){var it;(it=item_list[idx3]).event_dungeon_period_idx==sub.event_dungeon_period_idx&&it.event_dungeon_box_gacha_idx==sub.event_dungeon_box_gacha_idx&&it.bonus_type==sub.bonus_type&&it.main_bonus_type==sub.main_bonus_type&&total_count++}for(var jdx3=0;jdx3<this.m_user_event_box_gacha_info.buy_log.length;jdx3++){var item;(item=mt.get_EventDungeonBoxGachaItemV2(this.m_user_event_box_gacha_info.buy_log[jdx3].event_dungeon_box_gacha_item_idx,this.m_user_event_box_gacha_info.buy_log[jdx3].event_dungeon_box_gacha_idx,this.m_user_event_box_gacha_info.buy_log[jdx3].event_dungeon_period_idx)).event_dungeon_period_idx==sub.event_dungeon_period_idx&&item.event_dungeon_box_gacha_idx==sub.event_dungeon_box_gacha_idx&&item.bonus_type==sub.bonus_type&&item.main_bonus_type==sub.main_bonus_type&&gain_count++}remain=total_count-gain_count;icon.getChildByTag(COUNT_LABEL_TAG).setString(cmString(res_str("label_event_dungeon_box_gacha_remain_item_count_v2"),remain))}}}remain=item_list.size()-this.m_user_event_box_gacha_info.buy_log.size();this.m_gacha_count_label.setString(cmString("%d/%d",remain,item_list.size())),this.m_gacha_count_title.setPositionX(this.m_gacha_count_label.getPositionX()-ccWidth(this.m_gacha_count_label)-10),this.m_event_point_label.setString(cmString(res_str("label_event_dungeon_own_point"),Number(this.m_event_dungeon_point.event_point).toLocaleString()))},resetLayout:function(){this.resetRightBox(),this.resetLeftBox()},resetRightBox:function(){var m=MasterTable.getInstance(),mt=MasterManager.getInstance(),total_count=(EventDungeonService.getInstance(),0),gain_count=0,cur_box_gacha=mt.get_EventDungeonBoxGachaV2(this.m_user_event_box_gacha_info.event_dungeon_box_gacha_idx,this.m_user_event_box_gacha_info.event_dungeon_period_idx);"BOX 1"==cur_box_gacha.name?this.m_gacha_title.setTexture(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_box_text_1.png",this.m_period.event_dungeon_group_idx)):"BOX 2"==cur_box_gacha.name?this.m_gacha_title.setTexture(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_box_text_2.png",this.m_period.event_dungeon_group_idx)):"BOX 3"==cur_box_gacha.name?this.m_gacha_title.setTexture(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_box_text_3.png",this.m_period.event_dungeon_group_idx)):"EX BOX"==cur_box_gacha.name&&this.m_gacha_title.setTexture(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_box_text_4.png",this.m_period.event_dungeon_group_idx)),this.m_content_view_btn.setString(cmString(res_str("label_event_dungeon_box_gacha_lineup_btn"),cur_box_gacha.name));var item_list=m.get_EventDungeonBoxGachaItemListV2(cur_box_gacha.event_dungeon_period_idx,cur_box_gacha.event_dungeon_box_gacha_idx);this.m_sub_main_items=[];for(var idx=0;idx<item_list.length;idx++){1==(item=item_list[idx]).main_bonus_type?this.m_main_item_data=item:2==item.main_bonus_type&&9999!=item.display_id&&this.m_sub_main_items.push(item)}this.m_sub_main_items.sort(function(l,r){return l.display_id>r.display_id?1:l.display_id<r.display_id?-1:0});var parent=this.m_main_item_icon.getParent();if(null!=parent&&(this.m_main_item_icon.removeFromParentAndCleanup(!0),this.m_main_item_icon=null),this.m_main_item_data.bonus_type==BONUS_TYPE_YUNHEE_FIX){var card=new Card;card.gnrl_id=this.m_main_item_data.min_value,card.level=1,this.m_main_item_icon=(new Card).createCard(card,CARD_TYPE.type_common_card),this.m_main_item_icon.setAnchorPoint(ANCHOR_MIDDLE()),this.m_main_item_icon.setPosition(179,195),parent.addChild(this.m_main_item_icon)}else this.m_main_item_data.bonus_type==BONUS_TYPE_GOLDEN_BARREL&&(this.m_main_item_icon=cc.Sprite.create(cmString("#img_reward_%d_d.png",this.m_main_item_data.bonus_type)),this.m_main_item_icon.setContentSize(140,140),this.m_main_item_icon.setAnchorPoint(ANCHOR_MIDDLE()),this.m_main_item_icon.setPosition(179,195),this.m_main_item_icon.setScale(.8),parent.addChild(this.m_main_item_icon),null==this.m_golden_barrel_help_btn&&(this.m_golden_barrel_help_btn=new ccui.Button("btn_help_off.png","btn_help_on.png","",ccui.Widget.PLIST_TEXTURE),this.m_golden_barrel_help_btn.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),this.m_golden_barrel_help_btn.setPosition(200,216),parent.addChild(this.m_golden_barrel_help_btn,100),this.m_golden_barrel_help_btn.addClickEventListener(function(sender){this.showGoldenBarrelLineupPopup()}.bind(this))));if(null!=this.m_main_item_icon){this.m_main_item_icon.setTag(this.m_main_item_data.event_dungeon_box_gacha_item_idx),(tooltip_btn=new cc.ControlButton(cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_transbox.png",cc.Rect(1,1,1,1)))).setAnchorPoint(ANCHOR_MIDDLE()),tooltip_btn.setPreferredSize(ccSize(this.m_main_item_icon)),tooltip_btn.setPosition(ccCenter(this.m_main_item_icon)),tooltip_btn.setTag(TOOLTIP_BTN_TAG),this.m_main_item_icon.addChild(tooltip_btn),tooltip_btn.addTargetWithActionForControlEvents(this,this.onItemToolTipTouch,cc.CONTROL_EVENT_TOUCH_DOWN),tooltip_btn.addTargetWithActionForControlEvents(this,this.onItemToolTipTouch,cc.CONTROL_EVENT_TOUCH_UP_INSIDE),tooltip_btn.addTargetWithActionForControlEvents(this,this.onItemToolTipTouch,cc.CONTROL_EVENT_TOUCH_UP_OUTSIDE),tooltip_btn.addTargetWithActionForControlEvents(this,this.onItemToolTipTouch,cc.CONTROL_EVENT_TOUCH_CANCEL);for(idx=gain_count=total_count=0;idx<item_list.length;idx++){(it=item_list[idx]).event_dungeon_period_idx==this.m_main_item_data.event_dungeon_period_idx&&it.event_dungeon_box_gacha_idx==this.m_main_item_data.event_dungeon_box_gacha_idx&&it.bonus_type==this.m_main_item_data.bonus_type&&it.main_bonus_type==this.m_main_item_data.main_bonus_type&&total_count++}for(var jdx=0;jdx<this.m_user_event_box_gacha_info.buy_log.length;jdx++){(item=mt.get_EventDungeonBoxGachaItemV2(this.m_user_event_box_gacha_info.buy_log[jdx].event_dungeon_box_gacha_item_idx,this.m_user_event_box_gacha_info.buy_log[jdx].event_dungeon_box_gacha_idx,this.m_user_event_box_gacha_info.buy_log[jdx].event_dungeon_period_idx)).event_dungeon_period_idx==this.m_main_item_data.event_dungeon_period_idx&&item.event_dungeon_box_gacha_idx==this.m_main_item_data.event_dungeon_box_gacha_idx&&item.bonus_type==this.m_main_item_data.bonus_type&&item.main_bonus_type==this.m_main_item_data.main_bonus_type&&gain_count++}var remain=total_count-gain_count;this.m_main_item_count.setString(cmString(res_str("label_event_dungeon_box_gacha_remain_item_count_v2"),remain))}var sub_pos_list=[];sub_pos_list.push_back([394,270]),sub_pos_list.push_back([531,270]),sub_pos_list.push_back([394,136]),sub_pos_list.push_back([531,136]);for(var i=0;i<this.m_sub_main_item_icons.length;i++){(sub_item=this.m_sub_main_item_icons[i]).removeFromParent()}this.m_sub_main_item_icons=[];for(i=0;i<this.m_sub_main_items.length;i++){var sub=this.m_sub_main_items[i];if(i<sub_pos_list.length){var tooltip_btn,pos=sub_pos_list.at(i),sub_item=null;(sub_item=sub.bonus_type==BONUS_TYPE_YUNHEE_FIX?cc.Sprite.create(cmString("#img_reward_%02d_%d.png",parseInt(sub.bonus_type),parseInt(sub.min_value))):cc.Sprite.create(cmString("#img_reward_%02d.png",parseInt(sub.bonus_type)))).setAnchorPoint(ANCHOR_MIDDLE()),sub_item.setPosition(pos[0],pos[1]),parent.addChild(sub_item),sub_item.setTag(sub.event_dungeon_box_gacha_item_idx),(tooltip_btn=new cc.ControlButton(cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_transbox.png",cc.Rect(1,1,1,1)))).setAnchorPoint(ANCHOR_MIDDLE()),tooltip_btn.setPreferredSize(ccSize(sub_item)),tooltip_btn.setPosition(ccCenter(sub_item)),tooltip_btn.setTag(TOOLTIP_BTN_TAG),sub_item.addChild(tooltip_btn),tooltip_btn.addTargetWithActionForControlEvents(this,this.onItemToolTipTouch,cc.CONTROL_EVENT_TOUCH_DOWN),tooltip_btn.addTargetWithActionForControlEvents(this,this.onItemToolTipTouch,cc.CONTROL_EVENT_TOUCH_UP_INSIDE),tooltip_btn.addTargetWithActionForControlEvents(this,this.onItemToolTipTouch,cc.CONTROL_EVENT_TOUCH_UP_OUTSIDE),tooltip_btn.addTargetWithActionForControlEvents(this,this.onItemToolTipTouch,cc.CONTROL_EVENT_TOUCH_CANCEL);var cnt_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_161);cnt_label.setAnchorPoint(ANCHOR_MIDDLE_TOP()),cnt_label.setPosition(ccCenter(sub_item).x,-25),cnt_label.setTag(COUNT_LABEL_TAG),sub_item.addChild(cnt_label);for(idx=gain_count=total_count=0;idx<item_list.length;idx++){var it;(it=item_list[idx]).event_dungeon_period_idx==sub.event_dungeon_period_idx&&it.event_dungeon_box_gacha_idx==sub.event_dungeon_box_gacha_idx&&it.bonus_type==sub.bonus_type&&it.main_bonus_type==sub.main_bonus_type&&total_count++}for(jdx=0;jdx<this.m_user_event_box_gacha_info.buy_log.length;jdx++){var item;(item=mt.get_EventDungeonBoxGachaItemV2(this.m_user_event_box_gacha_info.buy_log[jdx].event_dungeon_box_gacha_item_idx,this.m_user_event_box_gacha_info.buy_log[jdx].event_dungeon_box_gacha_idx,this.m_user_event_box_gacha_info.buy_log[jdx].event_dungeon_period_idx)).event_dungeon_period_idx==sub.event_dungeon_period_idx&&item.event_dungeon_box_gacha_idx==sub.event_dungeon_box_gacha_idx&&item.bonus_type==sub.bonus_type&&item.main_bonus_type==sub.main_bonus_type&&gain_count++}remain=total_count-gain_count;cnt_label.setString(cmString(res_str("label_event_dungeon_box_gacha_remain_item_count_v2"),remain)),this.m_sub_main_item_icons.push_back(sub_item)}}remain=item_list.length-this.m_user_event_box_gacha_info.buy_log.length;this.m_gacha_count_label.setString(cmString("%d/%d",remain,item_list.length)),this.m_gacha_count_title.setPositionX(this.m_gacha_count_label.getPositionX()-ccWidth(this.m_gacha_count_label)-10),this.m_event_point_label.setString(cmString(res_str("label_event_dungeon_point_count_v2"),Number(this.m_event_dungeon_point.event_point).toLocaleString()));var cost_list=m.get_EventDungeonBoxGachaCostInfoListV2(cur_box_gacha.event_dungeon_period_idx,cur_box_gacha.event_dungeon_box_gacha_idx);this.m_cost_label.setString(cmString("%sM",Number(cost_list[0].need_point).toLocaleString())),this.m_btn.addClickEventListener(function(sender){this.reqBoxGachaV2(cost_list[0].event_dungeon_box_gacha_cost_info_idx)}.bind(this)),this.m_cost_label1.setString(cmString("%sM",Number(cost_list[1].need_point).toLocaleString())),this.m_btn1.addClickEventListener(function(sender){this.reqBoxGachaV2(cost_list[1].event_dungeon_box_gacha_cost_info_idx)}.bind(this)),this.m_cost_label2.setString(cmString("%sM",Number(cost_list[2].need_point).toLocaleString())),this.m_btn2.addClickEventListener(function(sender){this.reqBoxGachaV2(cost_list[2].event_dungeon_box_gacha_cost_info_idx)}.bind(this))},resetLeftBox:function(){for(var m=MasterManager.getInstance(),mt=MasterTable.getInstance(),box_gacha_list=(EventDungeonService.getInstance(),mt.get_EventDungeonBoxGachaV2List(this.m_period.event_dungeon_point_period_idx)),is_selected=!1,i=0;i<box_gacha_list.length;i++){var box_info=box_gacha_list[i];if(is_selected=!1,i<this.m_box_gacha_proc.length){var img=this.m_box_gacha_proc[i];if(box_info.event_dungeon_box_gacha_idx==this.m_user_event_box_gacha_info.event_dungeon_box_gacha_idx&&box_info.event_dungeon_period_idx==this.m_user_event_box_gacha_info.event_dungeon_period_idx){var image=RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_box_%d_off.png",parseInt(this.m_period.event_dungeon_group_idx),i+1),frame_texture=cc.textureCache.addImage(image),frame=new cc.SpriteFrame(frame_texture,cc.rect(0,0,frame_texture.getContentSize().width,frame_texture.getContentSize().height));img.setSpriteFrame(frame),is_selected=!0}else{image=RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_box_%d_none.png",parseInt(this.m_period.event_dungeon_group_idx),i+1),frame_texture=cc.textureCache.addImage(image);var frame1=new cc.SpriteFrame(frame_texture,cc.rect(0,0,frame_texture.getContentSize().width,frame_texture.getContentSize().height));img.setSpriteFrame(frame1),is_selected=!1}var selected_img=img.getChildByTag(SELECTED_IMAGE_TAG);null!=selected_img&&selected_img.setVisible(is_selected)}}var cur_box_gacha=m.get_EventDungeonBoxGachaV2(this.m_user_event_box_gacha_info.event_dungeon_box_gacha_idx,this.m_user_event_box_gacha_info.event_dungeon_period_idx),next_box_gacha=m.get_EventDungeonBoxGachaV2(cur_box_gacha.next_box_gacha_idx,cur_box_gacha.event_dungeon_period_idx);cur_box_gacha.name==next_box_gacha.name?(this.m_next_box_gacha_btn.setString(cmString(res_str("label_event_dungeon_ed_box_reset_btn"),next_box_gacha.name)),this.m_next_box_gacha_btn_dis.setString(cmString(res_str("label_event_dungeon_ed_box_reset_btn"),next_box_gacha.name))):(this.m_next_box_gacha_btn.setString(cmString(res_str("label_event_dungeon_gacha_next_box_move"),next_box_gacha.name)),this.m_next_box_gacha_btn_dis.setString(cmString(res_str("label_event_dungeon_gacha_next_box_move"),next_box_gacha.name))),this.checkEnableResetBtn()},checkEnableResetBtn:function(){for(var m=MasterTable.getInstance(),mt=MasterManager.getInstance(),cur_box_gacha=mt.get_EventDungeonBoxGachaV2(this.m_user_event_box_gacha_info.event_dungeon_box_gacha_idx,this.m_user_event_box_gacha_info.event_dungeon_period_idx),item_list=m.get_EventDungeonBoxGachaItemListV2(cur_box_gacha.event_dungeon_period_idx,cur_box_gacha.event_dungeon_box_gacha_idx),total_count=0,gain_count=0,i=0;i<item_list.length;i++){var it=item_list[i];it.event_dungeon_period_idx==this.m_main_item_data.event_dungeon_period_idx&&it.event_dungeon_box_gacha_idx==this.m_main_item_data.event_dungeon_box_gacha_idx&&it.bonus_type==this.m_main_item_data.bonus_type&&it.main_bonus_type==this.m_main_item_data.main_bonus_type&&total_count++}for(var jdx=0;jdx<this.m_user_event_box_gacha_info.buy_log.length;jdx++){var item=mt.get_EventDungeonBoxGachaItemV2(this.m_user_event_box_gacha_info.buy_log[jdx].event_dungeon_box_gacha_item_idx,this.m_user_event_box_gacha_info.buy_log[jdx].event_dungeon_box_gacha_idx,this.m_user_event_box_gacha_info.buy_log[jdx].event_dungeon_period_idx);item.event_dungeon_period_idx==this.m_main_item_data.event_dungeon_period_idx&&item.event_dungeon_box_gacha_idx==this.m_main_item_data.event_dungeon_box_gacha_idx&&item.bonus_type==this.m_main_item_data.bonus_type&&item.main_bonus_type==this.m_main_item_data.main_bonus_type&&gain_count++}total_count<=gain_count?(this.m_next_box_gacha_btn.setEnabled(!0),this.m_next_box_gacha_btn.setVisible(!0),this.m_next_box_gacha_btn_dis.setVisible(!1)):(this.m_next_box_gacha_btn.setEnabled(!1),this.m_next_box_gacha_btn.setVisible(!1),this.m_next_box_gacha_btn_dis.setVisible(!0))},showRecvItemListPopup:function(res){this.m_recv_item_list_popup.setContentSize(ccSize(this)),this.m_recv_item_list_popup._contentNode=function(contentSize,m){return new EventDungeonBoxGachaRecvItemPopupV2(res,this.hideRecvItemListPopup.bind(this))}.bind(this),this.m_recv_item_list_popup.show()},hideRecvItemListPopup:function(){RAID_BOSS_MODAL_OPEN_FLAG=!1,this.m_recv_item_list_popup.is_show()&&this.m_recv_item_list_popup.hide(),this.checkEpilogueOpen()},checkEpilogueOpen:function(){var m=MasterManager.getInstance();if(this.m_box_gacha_buy_result.event_dungeon_period_idx==this.m_first_event_period_idx&&"BOX 1"==m.get_EventDungeonBoxGachaV2(this.m_box_gacha_buy_result.event_dungeon_box_gacha_idx,this.m_box_gacha_buy_result.event_dungeon_period_idx).name){for(var is_enable_epilogue=!1,i=0;i<this.m_box_gacha_buy_result.buy_log.length;i++){var log=this.m_box_gacha_buy_result.buy_log[i];if(log.event_dungeon_period_idx==this.m_main_item_data.event_dungeon_period_idx&&log.event_dungeon_box_gacha_idx==this.m_main_item_data.event_dungeon_box_gacha_idx&&log.event_dungeon_box_gacha_item_idx==this.m_main_item_data.event_dungeon_box_gacha_item_idx){is_enable_epilogue=!0;break}}is_enable_epilogue&&this.m_is_prv_event_dungeon,0}},showNextBoxPopup:function(){var m=MasterManager.getInstance(),cur_box_gacha=m.get_EventDungeonBoxGachaV2(this.m_user_event_box_gacha_info.event_dungeon_box_gacha_idx,this.m_user_event_box_gacha_info.event_dungeon_period_idx),next_box_gacha=m.get_EventDungeonBoxGachaV2(cur_box_gacha.next_box_gacha_idx,cur_box_gacha.event_dungeon_period_idx);cur_box_gacha.event_dungeon_box_gacha_idx!=next_box_gacha.event_dungeon_box_gacha_idx?(this.m_message_box.setTitle(res_str("label_shop_buy_jade_omission_title")),this.m_message_box.setText(res_str("label_event_dungeon_box_next_box_open_msg_1")),this.m_message_box.setText("\n"),this.m_message_box.setText(res_str("label_event_dungeon_box_next_box_open_msg_2")),this.m_message_box.addButtonInfo(new MessageButtonInfo(res_str("btn_label_cancel"),MessageBoxButtonType.ButtonTypeRed,0,function(){this.m_message_box.hide()}.bind(this))),this.m_message_box.addButtonInfo(new MessageButtonInfo(res_str("btn_label_confirm"),MessageBoxButtonType.ButtonTypeNormal,0,function(){this.scheduleOnce(function(){this.reqNextBoxGachaV2()},.1,"reqNextBoxGachaV2"),this.m_message_box.hide(!1)}.bind(this))),this.m_message_box.show()):this.reqNextBoxGachaV2()},showEnableEpiloguePopup:function(){this.m_message_box.setTitle(res_str("label_event_dungeon_epilogue_title")),this.m_message_box.setText(res_str("label_event_dungeon_open_epilogue_message_1")),this.m_message_box.setText("\n"),this.m_message_box.setText(res_str("label_event_dungeon_open_epilogue_message_2")),this.m_message_box.addButtonInfo(new MessageButtonInfo(res_str("btn_label_no"),MessageBoxButtonType.ButtonTypeRed,0,function(){this.m_message_box.hide()}.bind(this))),this.m_message_box.addButtonInfo(new MessageButtonInfo(res_str("label_shortcuts_move"),MessageBoxButtonType.ButtonTypeNormal,0,function(){this.scheduleOnce(function(){MainObserver.getInstance().postNotification(sceneStr[EventDungeonBoxGachaSceneV2],btn_epilogue_open_view)},.1,"open_epilogue"),this.m_message_box.hide(!1)}.bind(this))),this.m_message_box.show()},showGoldenBarrelLineupPopup:function(){this.m_golden_barrel_popup.setContentSize(ccSize(this)),this.m_golden_barrel_popup._contentNode=function(contentSize,m){return new EventDungeonBoxGachaGoldenBarrelPopupV2(this.m_user_event_box_gacha_info,this.hideGoldenBarrelLineupPopup.bind(this))}.bind(this),this.m_golden_barrel_popup.show()},hideGoldenBarrelLineupPopup:function(){this.m_golden_barrel_popup.is_show()&&this.m_golden_barrel_popup.hide()},showLineupPopup:function(){this.m_item_lineup_popup.setContentSize(ccSize(this)),this.m_item_lineup_popup._contentNode=function(contentSize,m){return new EventDungeonBoxGachaLineUpPopupV2(this.m_user_event_box_gacha_info,this.hideLineupPopup.bind(this))}.bind(this),this.m_item_lineup_popup.show()},hideLineupPopup:function(){this.m_item_lineup_popup.is_show()&&MainObserver.getInstance().postNotification(sceneStr[EventDungeonBoxGachaSceneV2],btn_box_gacha_lineup_popup_off)},hideLineupPopupV2:function(){this.m_item_lineup_popup.is_show()&&this.m_item_lineup_popup.hide()},showRewardItemEffectPopup:function(log,bonus){this.m_is_effect_layer_touch=!1,this.m_effect_popup.setContentSize(ccSize(this)),this.m_effect_popup._contentNode=function(contentSize,margin){var gacha_item=MasterManager.getInstance().get_EventDungeonBoxGachaItemV2(log.event_dungeon_box_gacha_item_idx,log.event_dungeon_box_gacha_idx,log.event_dungeon_period_idx);return 1!=gacha_item.main_bonus_type||gacha_item.bonus_type!=BONUS_TYPE_GOLDEN_BARREL?(this.getParent().m_statusLayer.setStatusDisable(!0),this.getParent().m_isLineupPopupShow=!0,this.getRewardItemEffectLayer(log,bonus)):this.getRewardGoldenBarrelEFfectLayer(log,bonus)}.bind(this),this.m_effect_popup.onItemTouchBegin=function(index){return!0},this.m_effect_popup.onItemTouchEnd=function(index){this.m_is_effect_layer_touch&&(AudioEngine.getInstance().stopEffectsAll(),this.m_is_effect_layer_touch=!1,this.m_effect_popup.hide(),this.getParent().m_statusLayer.setStatusDisable(!1),this.getParent().m_isLineupPopupShow=!1,this.checkEpilogueOpen())}.bind(this),this.m_effect_popup.show()},getRewardGoldenBarrelEFfectLayer:function(log,bonus){var layer=new cc.Layer,m=MasterManager.getInstance(),gacha_item=(cc.size(ccSize(layer)),m.get_EventDungeonBoxGachaItemV2(log.event_dungeon_box_gacha_item_idx,log.event_dungeon_box_gacha_idx,log.event_dungeon_period_idx)),img=cc.Sprite.create();img.setAnchorPoint(ANCHOR_MIDDLE()),img.setPosition(ccCenter(layer)),layer.addChild(img,1);var animation=new cc.Animation;if(gacha_item.bonus_type==BONUS_TYPE_GOLDEN_BARREL)for(var i=1;i<=12;i++)try{var frame=cc.spriteFrameCache.getSpriteFrame(cmString("effect_boxgacha_%d_large_%02d.png",gacha_item.bonus_type,i));animation.addSpriteFrame(frame)}catch(e){cc.log("gacha_item.bonus_type error :"+e)}else for(i=1;i<=8;i++)try{var frame1=cc.spriteFrameCache.getSpriteFrame(cmString("effect_boxgacha_%d_%02d.png",gacha_item.min_value,i));animation.addSpriteFrame(frame1)}catch(e){cc.log("gacha_item.bonus_type error :"+e)}animation.setDelayPerUnit(.08),animation.setRestoreOriginalFrame(!0);var animate=new cc.Animate(animation);return img.runAction(animate),this.scheduleOnce(function(){var effect_layer=this.getRewardItemEffectLayer(log,bonus);layer.addChild(effect_layer,2)},1,"getRewardItemEffectLayer"),layer},getRewardItemEffectLayer:function(log,bonus){var layer=new cc.Layer,m=MasterManager.getInstance(),winSize=cc.size(ccSize(layer)),audio=AudioEngine.getInstance();audio.playEffect(RES_CDN_SOUND+SND_TYPE+"sound/SE_all_win_popularity.mp3",!1),audio.playEffect(RES_CDN_SOUND+SND_TYPE+"sound/SE_gacha_back.mp3",!0);var back_effect=cc.Sprite.create("#img_attend_effect.png");back_effect.setPosition(ccCenter(layer)),layer.addChild(back_effect,1),back_effect.setScale(1.7);var action=new cc.RotateBy(1,180),repeat=new cc.RepeatForever(action);back_effect.runAction(repeat);var bonus_icon=cc.Sprite.create();bonus_icon.setPosition(ccCenter(layer)),layer.addChild(bonus_icon,1);var bonus_name_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_503);bonus_name_label.setAnchorPoint(ANCHOR_MIDDLE_TOP()),bonus_name_label.enableOutline(cc.color.BLACK,3),bonus_name_label.setPosition(.5*winSize.width,winSize.height-180),layer.addChild(bonus_name_label,1);var count=0;if(bonus.bonus_type==BONUS_TYPE_YUNHEE_FIX){var general=m.get_General(bonus.bonus_idx),frame=cc.spriteFrameCache.getSpriteFrame("img_reward_"+leadingZeros(bonus.bonus_idx,2)+"_d.png");bonus_icon.setSpriteFrame(frame),bonus_name_label.setString(general.name),count=bonus.bonus_level}else if(bonus.bonus_type==BONUS_TYPE_EQUIPMENT){var b=m.get_BonusType(bonus.bonus_type),equip=m.get_EquipmentItem(bonus.equipment.equipment_item_idx);frame=cc.spriteFrameCache.getSpriteFrame("img_reward_"+leadingZeros(b.bonus_type,2)+"_d.png");bonus_icon.setSpriteFrame(frame),bonus_name_label.setString(equip.name),count=1}else{b=m.get_BonusType(bonus.bonus_type),frame=cc.spriteFrameCache.getSpriteFrame("img_reward_"+leadingZeros(bonus.bonus_type,2)+"_d.png");bonus_icon.setSpriteFrame(frame),bonus_name_label.setString(b.name),count=bonus.bonus_idx}var bonus_count_label=cmLabel.getLabel(cmString("x %s",Number(count).toLocaleString("en")),LABEL_FONT_INDEX.FONT_503);bonus_count_label.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),bonus_count_label.enableOutline(cc.color.BLACK,3),bonus_count_label.setPosition(.5*winSize.width,180),layer.addChild(bonus_count_label,1);var boss=cc.Sprite.create(RES_CDN_DEFULT+"card_war_boss/392.png");return boss.setScale(2),boss.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),boss.setPosition(winSize.width,0),layer.addChild(boss),this.scheduleOnce(function(float){this.m_is_effect_layer_touch=!0}.bind(this),1,"showEffectLayer"),layer},onItemToolTipTouch:function(sender,_event){if(_event==cc.CONTROL_EVENT_TOUCH_DOWN){var parent=sender.getParent();if(null!=parent){var tag=parent.getTag();0!=tag&&this.showTooltip(parent,tag)}}else this.hideTooltip()},showTooltip:function(parent,event_dungeon_box_gacha_item_idx){var winSize=cc.size(ccSize(this)),item_data=MasterManager.getInstance().get_EventDungeonBoxGachaItemV2(event_dungeon_box_gacha_item_idx,this.m_user_event_box_gacha_info.event_dungeon_box_gacha_idx,this.m_user_event_box_gacha_info.event_dungeon_period_idx);this.m_tooltip_box.setVisible(!0),this.m_tooltip_content.setString(item_data.tooltip);var bSize=cc.size(0,0);bSize.width=Math.max(64,ccWidth(this.m_tooltip_content)+20),bSize.height=Math.max(54,ccHeight(this.m_tooltip_content)+20),this.m_tooltip_box.setPreferredSize(bSize),this.m_tooltip_content.setPosition(ccCenter(bSize));var pos=parent.getPosition();if(pos.y+=.5*bSize.height+147,pos.x+.5*bSize.width+10>winSize.width){var left=winSize.width-(pos.x+.5*bSize.width+10);pos.x-=left}if(pos.y+.5*bSize.height>winSize.height-55){var top=pos.y+.5*bSize.height-(winSize.height-55-20);pos.y-=top}this.m_tooltip_box.setPosition(pos)},hideTooltip:function(){this.m_tooltip_box.setVisible(!1)}}),EventDungeonBoxGachaLineUpCellV2=cc.TableViewCell.extend({m_item_count:null,m_item_title:null,m_item_icon:null,m_icon_frame:null,m_equip_jewelry:null,m_equip_step:null,m_showtootip:null,m_item_data:[],ctor:function(_cb_tooltip){this._super(),this.init(_cb_tooltip)},init:function(_cb_tooltip){this.m_showtootip=_cb_tooltip;var cellSize=cc.size(444,78);this.setContentSize(cellSize);var box=cc.Scale9Sprite.create(RES_CDN_DEFULT+"menu_yh/img_yh_info_box.png",cc.Rect(20,20,20,20));return box.setPreferredSize(cellSize),box.setAnchorPoint(ZERO()),box.setPosition(ZERO()),this.addChild(box),this.m_icon_frame=cc.Sprite.create(RES_CDN_DEFULT+"icon/img_icon_frame.png"),this.m_icon_frame.setAnchorPoint(ANCHOR_MIDDLE_LEFT()),this.m_icon_frame.setPosition(4,.5*cellSize.height),box.addChild(this.m_icon_frame),this.m_item_title=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_2013),this.m_item_title.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),this.m_item_title.setPosition(80,43),box.addChild(this.m_item_title),this.m_item_count=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_181),this.m_item_count.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),this.m_item_count.setPosition(80,16),box.addChild(this.m_item_count),this.m_equip_jewelry=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_144),this.m_equip_jewelry.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),this.m_equip_jewelry.setPosition(cellSize.width-10,13),box.addChild(this.m_equip_jewelry),this.m_equip_step=cc.Sprite.create("#img_equip_text_plus.png"),this.m_equip_step.setAnchorPoint(ANCHOR_TOP_RIGHT()),this.m_equip_step.setPosition(72,73),box.addChild(this.m_equip_step),!0},setData:function(data){this.m_item_data=data,this.updateCell(this.m_item_data)},updateCell:function(data){var m=MasterManager.getInstance();if(null!=this.m_item_icon&&this.m_item_icon.getParent()&&(this.m_item_icon.removeFromParentAndCleanup(!0),this.m_item_icon=null),this.m_equip_jewelry.setVisible(!1),this.m_equip_step.setVisible(!1),data.item.bonus_type==BONUS_TYPE_YUNHEE_FIX){(card=new db.CardInfo).gnrl_id=data.item.min_value,this.m_item_icon=(new Card).createCard(card,CARD_TYPE.type_card_thumb);var gnrl=m.get_General(data.item.min_value);this.m_item_title.setString(gnrl.name+" x"+data.item.max_value),cmLabel.autoSizeFit(this.m_item_title,350,20)}else if(data.item.bonus_type==BONUS_TYPE_EQUIPMENT){var card,arm_service_type=0,equip=m.get_EquipmentItem(data.item.min_value);101==equip.arm_service_idx&&(arm_service_type=ARMSERVICETYPE_INFANTRY),102==equip.arm_service_idx&&(arm_service_type=ARMSERVICETYPE_SPEAR),103==equip.arm_service_idx&&(arm_service_type=ARMSERVICETYPE_ARCHER),(card={}).equip_id=equip.equipment_item_idx,card.arm_service_type=arm_service_type,card.equip_parts_type=equip.equipment_parts_type,card.equip_rare_type=equip.equipment_rare_type,card.equip_type=equip.equipment_type,card.image=equip.img,card.is_equip=!1,card.is_lock=!1,card.level=1,card.equip_group=equip.equip_group_idx,card.property_img=equip.property_img,card.is_same_gnrl_group=!1;var step_list=[];if((card.gnrl_group=0)!=equip.equip_step_idx&&0<(step_list=m.get_EquipmentStepRateList(equip.equip_step_idx)).length&&(card.step=step_list[0].step),1==data.item.main_bonus_type){this.m_item_icon=CardEquipment.getInstance().createCardEquipment(card,EQUIPMENT_CARD_TYPE.type_card_small_ficto);for(var option_idx=step_list[0].option1_idx,option_list=MasterTable.getInstance().get_EquipmentItemOptionList(option_idx),name="",equip_name=equip.name,index=0,i=0;i<option_list.length;i++){name+=option_list[i].equip_name+equip_name,index++,option_list.length>index&&(name+="/")}this.m_item_title.setString(name+" x"+data.item.max_value),cmLabel.autoSizeFit(this.m_item_title,350,20)}else this.m_item_icon=CardEquipment.getInstance().createCardEquipment(card,EQUIPMENT_CARD_TYPE.type_card_common),this.m_item_icon.setScale(.65),5!=card.step&&this.m_equip_step.setVisible(!0),this.m_item_title.setString(equip.name+" x"+data.item.max_value),cmLabel.autoSizeFit(this.m_item_title,350,20);if(equip.equipment_parts_type==EQUIPMENT_JEWELRY&&5==card.step){this.m_equip_jewelry.setVisible(!0);var comba_stat_idx=equip.equip_step_idx%10,combo_stat=m.get_ComboStat(comba_stat_idx);this.m_equip_jewelry.setString(cmString("%s : %s",res_str("label_equipment_box_gacha_jewelry_status"),combo_stat.name))}}else{this.m_item_icon=cc.Sprite.create(cmString("#img_reward_%02d.png",data.item.bonus_type));var bonus=m.get_BonusType(data.item.bonus_type);this.m_item_title.setString(bonus.name+" x"+data.item.min_value),cmLabel.autoSizeFit(this.m_item_title,350,20)}this.m_item_icon.setAnchorPoint(ANCHOR_MIDDLE()),this.m_item_icon.setPosition(ccCenter(this.m_icon_frame)),this.m_icon_frame.addChild(this.m_item_icon);var remain_count=data.total_count-data.gain_count;this.m_item_count.setString(cmString(res_str("label_event_dungeon_box_gacha_count"),remain_count,data.total_count))},highlightPosInCell:function(pos){var r=this.m_icon_frame.getBoundingBox();cc.rectContainsPoint(r,pos)&&null!=this.m_showtootip&&this.m_showtootip(this.m_item_data,this.getTouchTablePos())}}),EventDungeonBoxGachaLineUpPopupV2=cc.Layer.extend({m_table_view:null,m_close_callback:null,tooltip_box:null,tooltip_content:null,m_box_gacha_info:null,m_lineup_data_list:[],ctor:function(box_gacha_info,_close_callback){this._super(),this.init(box_gacha_info,_close_callback)},init:function(box_gacha_info,_close_callback){this.m_close_callback=_close_callback,this.m_box_gacha_info=box_gacha_info;var m=MasterTable.getInstance(),mt=MasterManager.getInstance(),item_list=m.get_EventDungeonBoxGachaItemListV2(this.m_box_gacha_info.event_dungeon_period_idx,this.m_box_gacha_info.event_dungeon_box_gacha_idx);this.m_lineup_data_list=[];for(var i=0;i<item_list.length;i++){if(9999!=(item=item_list[i]).display_id){var data={};data.item=item,data.total_count=0,data.gain_count=0,this.m_lineup_data_list.push(data)}}for(var j=0;j<this.m_lineup_data_list.length;j++)for(var k=0;k<item_list.length;k++){var item=item_list[k];this.m_lineup_data_list[j].item.bonus_type==item.bonus_type&&this.m_lineup_data_list[j].item.min_value==item.min_value&&(this.m_lineup_data_list[j].total_count+=1)}for(var idx=0;idx<this.m_lineup_data_list.length;idx++)for(var jdx=0;jdx<this.m_box_gacha_info.buy_log.length;jdx++){item=this.m_box_gacha_info.buy_log[jdx];var d=mt.get_EventDungeonBoxGachaItemV2(item.event_dungeon_box_gacha_item_idx,item.event_dungeon_box_gacha_idx,item.event_dungeon_period_idx);this.m_lineup_data_list[idx].item.bonus_type==d.bonus_type&&this.m_lineup_data_list[idx].item.min_value==d.min_value&&(this.m_lineup_data_list[idx].gain_count+=1)}this.m_lineup_data_list=stable(this.m_lineup_data_list,function(l,r){return l.item.display_id>r.item.display_id});var winSize=ccSize(this),boxSize=(cc.Rect(40,40,10,10),cc.size(478,541)),box=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_script_box_2.png",cc.Rect(40,40,10,10));box.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),box.setPreferredSize(cc.size(478,541)),box.setPosition(.5*winSize.width,10),this.addChild(box);var navi=cc.Sprite.create(RES_CDN_DEFULT+"common/img_navi_center_2.png");navi.setAnchorPoint(ANCHOR_MIDDLE_TOP()),navi.setPosition(ccCenter(box).x,ccHeight(box)-11),box.addChild(navi);var navi_title=cmLabel.getLabel(res_str("label_equipment_box_gacha_item_list_title"),LABEL_FONT_INDEX.FONT_261);navi_title.setAnchorPoint(ANCHOR_MIDDLE()),navi_title.setPosition(ccCenter(navi).x,ccCenter(navi).y+3),navi.addChild(navi_title);var btn=new ccui.Button("btn_cancel_off.png","btn_cancel_on.png","",ccui.Widget.PLIST_TEXTURE);btn.setAnchorPoint(ANCHOR_MIDDLE_RIGHT()),btn.setPosition(ccWidth(navi)-16,ccCenter(navi).y+2),btn.addClickEventListener(function(sender){null!=this.m_close_callback&&this.m_close_callback()}.bind(this)),navi.addChild(btn);var tableSize=cc.size(444,boxSize.height-90);return this.m_table_view=new cc.TableView(this,tableSize),this.m_table_view.ignoreAnchorPointForPosition(!1),this.m_table_view.setDirection(cc.SCROLLVIEW_DIRECTION_VERTICAL),this.m_table_view.setVerticalFillOrder(cc.TABLEVIEW_FILL_TOPDOWN),this.m_table_view.scrollBarEnable(!0),this.m_table_view.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),this.m_table_view.setPosition(17,18),box.addChild(this.m_table_view),this.m_table_view.setDelegate(this),this.m_table_view.reloadData(),this.tooltip_box=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_result_box.png",cc.Rect(20,20,20,20)),this.tooltip_box.setAnchorPoint(ANCHOR_MIDDLE_LEFT()),this.tooltip_box.setPosition(ZERO()),this.tooltip_box.setVisible(!1),box.addChild(this.tooltip_box,100),this.tooltip_content=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_181),this.tooltip_content.setAnchorPoint(ANCHOR_MIDDLE()),this.tooltip_content.setPosition(ccCenter(this.tooltip_box)),this.tooltip_box.addChild(this.tooltip_content),!0},tableCellSizeForIndex:function(table,idx){return cc.size(444,78)},cellSizeForTable:function(table){return cc.size(444,78)},tableCellAtIndex:function(table,idx){var c=table.dequeueCell(),cell=null;return(cell=null!=c?c:new EventDungeonBoxGachaLineUpCellV2(this.showTooltip.bind(this))).setData(this.m_lineup_data_list[idx]),cell},numberOfCellsInTableView:function(table){return this.m_lineup_data_list.length},tableCellTouched:function(table,cell){},tableCellHighlight:function(table,cell){null!=cell&&cell.highlightPosInCell(cell.getTouchPos())},tableCellUnhighlight:function(table,cell){this.hideTooltip()},tableCellEnded:function(){},tableCellSelectedCallback:function(){},showTooltip:function(data,pos){var winSize=ccSize(this);this.tooltip_box.setVisible(!0),this.tooltip_content.setString(data.item.tooltip);var cSize=ccSize(this.tooltip_content),width=Math.max(64,cSize.width+20),height=Math.max(54,cSize.height+20),bSize=cc.size(width,height);this.tooltip_box.setPreferredSize(bSize),this.tooltip_content.setPosition(ccCenter(bSize));var t_pos=this.m_table_view.getPosition();if(t_pos.y+=pos.y,t_pos.y+.5*bSize.height>winSize.height-55){var top=t_pos.y+.5*bSize.height-(winSize.height-55-20);t_pos.y-=top}this.tooltip_box.setPosition(t_pos.x+80,t_pos.y)},hideTooltip:function(){this.tooltip_box.setVisible(!1)}}),EventDungeonBoxGachaRecvItemCellV2=cc.TableViewCell.extend({m_item_desc:null,cellSize:null,ctor:function(){this._super(),this.init()},init:function(){return this.cellSize=cc.size(440,50),this.setContentSize(this.cellSize),!0},setData:function(data){this.updateCell(data)},updateCell:function(data){var m=MasterManager.getInstance();if(0!=data.castle_id)if(2==data.castle_id)if("EX BOX"==m.get_EventDungeonBoxGachaV2(data.event_dungeon_box_gacha_idx,data.event_dungeon_period_idx).name){var main=m.get_BonusType(BONUS_TYPE_GOLDEN_BARREL);if(data.bonus_type==BONUS_TYPE_YUNHEE_FIX){null!=this.m_item_desc&&null!=this.m_item_desc.getParent()&&(this.removeChild(this.m_item_desc),this.m_item_desc=null);var gnrl=m.get_General(data.bonus_idx);this.m_item_desc=cmLabel.getLabel(cmString(res_str("label_event_dungeon_box_gacha_recv_main_item"),main.name,gnrl.name,data.bonus_count),LABEL_FONT_INDEX.FONT_227),this.m_item_desc.setAnchorPoint(ANCHOR_MIDDLE()),this.m_item_desc.setPosition(ccCenter(this.cellSize)),this.addChild(this.m_item_desc)}else if(data.bonus_type==BONUS_TYPE_EQUIPMENT){null!=this.m_item_desc&&null!=this.m_item_desc.getParent()&&(this.removeChild(this.m_item_desc),this.m_item_desc=null);var equip=m.get_EquipmentItem(data.bonus_idx);this.m_item_desc=cmLabel.getLabel(cmString(res_str("label_event_dungeon_box_gacha_recv_main_item"),main.name,equip.name,data.bonus_count),LABEL_FONT_INDEX.FONT_227),this.m_item_desc.setAnchorPoint(ANCHOR_MIDDLE()),this.m_item_desc.setPosition(ccCenter(this.cellSize)),this.addChild(this.m_item_desc)}else{var bonus=m.get_BonusType(data.bonus_type);null!=this.m_item_desc&&null!=this.m_item_desc.getParent()&&(this.removeChild(this.m_item_desc),this.m_item_desc=null),this.m_item_desc=cmLabel.getLabel(cmString(res_str("label_event_dungeon_box_gacha_recv_main_item"),main.name,bonus.name,data.bonus_count),LABEL_FONT_INDEX.FONT_227),this.m_item_desc.setAnchorPoint(ANCHOR_MIDDLE()),this.m_item_desc.setPosition(ccCenter(this.cellSize)),this.addChild(this.m_item_desc)}}else if(data.bonus_type==BONUS_TYPE_YUNHEE_FIX){null!=this.m_item_desc&&null!=this.m_item_desc.getParent()&&(this.removeChild(this.m_item_desc),this.m_item_desc=null);gnrl=m.get_General(data.bonus_idx);this.m_item_desc=cmLabel.getLabel(cmString(res_str("label_event_dungeon_box_gacha_recv_accent_item"),gnrl.name,data.bonus_count),LABEL_FONT_INDEX.FONT_227),this.m_item_desc.setAnchorPoint(ANCHOR_MIDDLE()),this.m_item_desc.setPosition(ccCenter(this.cellSize)),this.addChild(this.m_item_desc)}else if(data.bonus_type==BONUS_TYPE_EQUIPMENT){null!=this.m_item_desc&&null!=this.m_item_desc.getParent()&&(this.removeChild(this.m_item_desc),this.m_item_desc=null);equip=m.get_EquipmentItem(data.bonus_idx);this.m_item_desc=cmLabel.getLabel(cmString(res_str("label_event_dungeon_box_gacha_recv_accent_item"),equip.name,data.bonus_count),LABEL_FONT_INDEX.FONT_227),this.m_item_desc.setAnchorPoint(ANCHOR_MIDDLE()),this.m_item_desc.setPosition(ccCenter(this.cellSize)),this.addChild(this.m_item_desc)}else{bonus=m.get_BonusType(data.bonus_type);null!=this.m_item_desc&&null!=this.m_item_desc.getParent()&&(this.removeChild(this.m_item_desc),this.m_item_desc=null),this.m_item_desc=cmLabel.getLabel(cmString(res_str("label_event_dungeon_box_gacha_recv_accent_item"),bonus.name,data.bonus_count),LABEL_FONT_INDEX.FONT_227),this.m_item_desc.setAnchorPoint(ANCHOR_MIDDLE()),this.m_item_desc.setPosition(ccCenter(this.cellSize)),this.addChild(this.m_item_desc)}else if(data.bonus_type==BONUS_TYPE_YUNHEE_FIX){null!=this.m_item_desc&&null!=this.m_item_desc.getParent()&&(this.removeChild(this.m_item_desc),this.m_item_desc=null);gnrl=m.get_General(data.bonus_idx);this.m_item_desc=cmLabel.getLabel(cmString(res_str("label_event_dungeon_box_gacha_recv_accent_item"),gnrl.name,data.bonus_count),LABEL_FONT_INDEX.FONT_227),this.m_item_desc.setAnchorPoint(ANCHOR_MIDDLE()),this.m_item_desc.setPosition(ccCenter(this.cellSize)),this.addChild(this.m_item_desc)}else if(data.bonus_type==BONUS_TYPE_EQUIPMENT){if(data.bonus_type==BONUS_TYPE_YUNHEE_FIX){null!=this.m_item_desc&&null!=this.m_item_desc.getParent()&&(this.removeChild(this.m_item_desc),this.m_item_desc=null);equip=m.get_EquipmentItem(data.bonus_idx);this.m_item_desc=cmLabel.getLabel(cmString(res_str("label_event_dungeon_box_gacha_recv_accent_item"),equip.name,data.bonus_count),LABEL_FONT_INDEX.FONT_227),this.m_item_desc.setAnchorPoint(ANCHOR_MIDDLE()),this.m_item_desc.setPosition(ccCenter(this.cellSize)),this.addChild(this.m_item_desc)}}else{null!=this.m_item_desc&&null!=this.m_item_desc.getParent()&&(this.removeChild(this.m_item_desc),this.m_item_desc=null);bonus=m.get_BonusType(data.bonus_type);this.m_item_desc=cmLabel.getLabel(cmString(res_str("label_event_dungeon_box_gacha_recv_accent_item"),bonus.name,data.bonus_count),LABEL_FONT_INDEX.FONT_227),this.m_item_desc.setAnchorPoint(ANCHOR_MIDDLE()),this.m_item_desc.setPosition(ccCenter(this.cellSize)),this.addChild(this.m_item_desc)}else if(data.bonus_type==BONUS_TYPE_YUNHEE_FIX){gnrl=m.get_General(data.bonus_idx);null!=this.m_item_desc&&null!=this.m_item_desc.getParent()&&(this.removeChild(this.m_item_desc),this.m_item_desc=null),this.m_item_desc=cmLabel.getLabel(cmString(res_str("label_event_dungeon_box_gacha_recv_item"),gnrl.name,data.bonus_count),LABEL_FONT_INDEX.FONT_221),this.m_item_desc.setAnchorPoint(ANCHOR_MIDDLE()),this.m_item_desc.setPosition(ccCenter(this.cellSize)),this.addChild(this.m_item_desc)}else if(data.bonus_type==BONUS_TYPE_EQUIPMENT){equip=m.get_EquipmentItem(data.bonus_idx);null!=this.m_item_desc&&null!=this.m_item_desc.getParent()&&(this.removeChild(this.m_item_desc),this.m_item_desc=null),this.m_item_desc=cmLabel.getLabel(cmString(res_str("label_event_dungeon_box_gacha_recv_item"),equip.name,data.bonus_count),LABEL_FONT_INDEX.FONT_221),this.m_item_desc.setAnchorPoint(ANCHOR_MIDDLE()),this.m_item_desc.setPosition(ccCenter(this.cellSize)),this.addChild(this.m_item_desc)}else if(data.bonus_type==BONUS_TYPE_HR_RARE_TYPE_ENGAGE||data.bonus_type==BONUS_TYPE_SUPER_CHOCO_CAKE||data.bonus_type==BONUS_TYPE_REBIRTH_MTRL_TYPE_7||data.bonus_type==BONUS_TYPE_SR_LIMIT_OVER_MTRL||data.bonus_type==BONUS_TYPE_JADE||data.bonus_type==BONUS_TYPE_EVOLVE_ORB||data.bonus_type==BONUS_TYPE_SR_RARE_TYPE_ENGAGE||data.bonus_type==BONUS_TYPE_REBIRTH_MTRL_TYPE_EVENT_5||data.bonus_type==BONUS_TYPE_REBIRTH_MTRL_TYPE_EVENT_6){bonus=m.get_BonusType(data.bonus_type);null!=this.m_item_desc&&null!=this.m_item_desc.getParent()&&(this.removeChild(this.m_item_desc),this.m_item_desc=null),this.m_item_desc=cmLabel.getLabel(cmString(res_str("label_event_dungeon_box_gacha_recv_accent_item"),bonus.name,data.bonus_count),LABEL_FONT_INDEX.FONT_227),this.m_item_desc.setAnchorPoint(ANCHOR_MIDDLE()),this.m_item_desc.setPosition(ccCenter(this.cellSize)),this.addChild(this.m_item_desc)}else{bonus=m.get_BonusType(data.bonus_type);null!=this.m_item_desc&&null!=this.m_item_desc.getParent()&&(this.removeChild(this.m_item_desc),this.m_item_desc=null),this.m_item_desc=cmLabel.getLabel(cmString(res_str("label_event_dungeon_box_gacha_recv_item"),bonus.name,data.bonus_count),LABEL_FONT_INDEX.FONT_221),this.m_item_desc.setAnchorPoint(ANCHOR_MIDDLE()),this.m_item_desc.setPosition(ccCenter(this.cellSize)),this.addChild(this.m_item_desc)}cmLabel.autoSizeFit(this.m_item_desc,430,22)}}),EventDungeonBoxGachaRecvItemPopupV2=cc.Layer.extend({m_close_callback:null,m_table_view:null,m_recv_item_list:[],ctor:function(res_2,_close_callback){this._super(),this.m_recv_item_list=[],this.init(res_2,_close_callback)},init:function(res_2,_close_callback){this.m_close_callback=_close_callback;cc.Rect(40,40,10,10);var boxSize=cc.size(478,541),winSize=ccSize(this),box=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_script_box_2.png",cc.Rect(40,40,10,10));box.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),box.setPreferredSize(cc.size(478,541)),box.setPosition(.5*winSize.width,10),this.addChild(box);var navi=cc.Sprite.create(RES_CDN_DEFULT+"common/img_navi_center_2.png");navi.setAnchorPoint(ANCHOR_MIDDLE_TOP()),navi.setPosition(ccCenter(box).x,ccHeight(box)-11),box.addChild(navi);var navi_title=cmLabel.getLabel(res_str("label_event_dungeon_box_gacha_item_list_title"),LABEL_FONT_INDEX.FONT_261);navi_title.setAnchorPoint(ANCHOR_MIDDLE()),navi_title.setPosition(ccCenter(navi).x,ccCenter(navi).y+3),navi.addChild(navi_title);var btn=new ccui.Button("btn_cancel_off.png","btn_cancel_on.png","",ccui.Widget.PLIST_TEXTURE);btn.setAnchorPoint(ANCHOR_MIDDLE_RIGHT()),btn.setPosition(ccWidth(navi)-16,ccCenter(navi).y+2),btn.addClickEventListener(function(sender){null!=this.m_close_callback&&this.m_close_callback()}.bind(this)),navi.addChild(btn);for(var is_gain_main_item=!1,i=0;i<res_2.reward_items.length;i++){for(var item=res_2.reward_items[i],found=!1,foundIdx=0,idx=0;idx<this.m_recv_item_list.length;idx++){var d=this.m_recv_item_list[idx];if(item.bonus_type==BONUS_TYPE_YUNHEE_FIX){if(d.bonus_type==item.bonus_type&&d.bonus_idx==item.bonus_idx&&d.castle_id==item.castle_id){foundIdx=idx,found=!0;break}}else if(item.bonus_type==BONUS_TYPE_EQUIPMENT){if(d.bonus_type==item.bonus_type&&d.bonus_idx==item.equipment.equipment_item_idx&&d.castle_id==item.castle_id){foundIdx=idx,found=!0;break}}else if(d.bonus_type==item.bonus_type&&d.castle_id==item.castle_id){foundIdx=idx,found=!0;break}}if(found)item.bonus_type==BONUS_TYPE_YUNHEE_FIX?this.m_recv_item_list[foundIdx].bonus_count+=item.bonus_level:item.bonus_type==BONUS_TYPE_EQUIPMENT?this.m_recv_item_list[foundIdx].bonus_count+=1:this.m_recv_item_list[foundIdx].bonus_count+=item.bonus_idx;else{var data={};data.event_dungeon_period_idx=res_2.event_dungeon_period_idx,data.event_dungeon_box_gacha_idx=res_2.event_dungeon_box_gacha_idx,item.bonus_type==BONUS_TYPE_YUNHEE_FIX?(data.bonus_type=item.bonus_type,data.bonus_idx=item.bonus_idx,data.bonus_count=item.bonus_level,55555==item.bonus_idx?1==item.castle_id?data.castle_id=2:data.castle_id=1:1==item.castle_id?data.castle_id=2:data.castle_id=0):item.bonus_type==BONUS_TYPE_EQUIPMENT?(data.bonus_type=item.bonus_type,data.bonus_count=1,data.bonus_idx=item.equipment.equipment_item_idx,1==item.castle_id?data.castle_id=2:data.castle_id=1):item.bonus_type==BONUS_TYPE_HR_RARE_TYPE_ENGAGE||item.bonus_type==BONUS_TYPE_SUPER_CHOCO_CAKE||item.bonus_type==BONUS_TYPE_REBIRTH_MTRL_TYPE_7||item.bonus_type==BONUS_TYPE_SR_LIMIT_OVER_MTRL||item.bonus_type==BONUS_TYPE_JADE||item.bonus_type==BONUS_TYPE_EVOLVE_ORB||item.bonus_type==BONUS_TYPE_SR_RARE_TYPE_ENGAGE||item.bonus_type==BONUS_TYPE_REBIRTH_MTRL_TYPE_EVENT_5||item.bonus_type==BONUS_TYPE_REBIRTH_MTRL_TYPE_EVENT_6?(data.bonus_type=item.bonus_type,data.bonus_count=item.bonus_idx,1==item.castle_id?data.castle_id=2:data.castle_id=1):(data.bonus_type=item.bonus_type,data.bonus_count=item.bonus_idx,1==item.castle_id?data.castle_id=2:data.castle_id=0),this.m_recv_item_list.push(data)}1==item.castle_id&&(is_gain_main_item=!0)}this.m_recv_item_list=stable(this.m_recv_item_list,function(l,r){return l.castle_id<r.castle_id});var recv_title=cmLabel.getLabel(res_str("label_event_dungeno_box_gacha_result_text_always"),LABEL_FONT_INDEX.FONT_201);if(recv_title.setAnchorPoint(ANCHOR_MIDDLE()),is_gain_main_item?recv_title.setPosition(ccCenter(box).x,ccHeight(box)-ccHeight(navi)-20):recv_title.setPosition(ccCenter(box).x,ccHeight(box)-ccHeight(navi)-30),box.addChild(recv_title),is_gain_main_item){var main_item_title=cmLabel.getLabel(res_str("label_event_dungeno_box_gacha_result_text_main_reward"),LABEL_FONT_INDEX.FONT_203);main_item_title.setAnchorPoint(ANCHOR_MIDDLE_TOP()),main_item_title.setPosition(ccCenter(box).x,ccHeight(box)-ccHeight(navi)-37),box.addChild(main_item_title),cmLabel.autoSizeFit(main_item_title,410,20)}var tableSize=cc.size(444,boxSize.height-130);return this.m_table_view=new cc.TableView(this,tableSize),this.m_table_view.ignoreAnchorPointForPosition(!1),this.m_table_view.setDirection(cc.SCROLLVIEW_DIRECTION_VERTICAL),this.m_table_view.setVerticalFillOrder(cc.TABLEVIEW_FILL_TOPDOWN),this.m_table_view.scrollBarEnable(!0),this.m_table_view.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),this.m_table_view.setPosition(17,18),box.addChild(this.m_table_view),this.m_table_view.setDelegate(this),!0},cellSizeForTable:function(table){return cc.size(444,50)},tableCellSizeForIndex:function(table,idx){return cc.size(444,50)},tableCellAtIndex:function(table,idx){var c=table.dequeueCell(),cell=null;cell=null!=c?c:new EventDungeonBoxGachaRecvItemCellV2;var data=this.m_recv_item_list[idx];return cell.setData(data),cell},numberOfCellsInTableView:function(){return this.m_recv_item_list.length},tableCellTouched:function(table,cell){},tableCellHighlight:function(table,cell){},tableCellUnhighlight:function(table,cell){},tableCellEnded:function(){},tableCellSelectedCallback:function(){}}),EventDungeonBoxGachaGoldenBarrelCellV2=cc.TableViewCell.extend({m_showtooltip:null,m_item_title:null,m_icon_frame:null,m_item_count:null,m_equip_jewelry:null,m_equip_step:null,m_item_icon:null,m_item_data:[],ctor:function(_cb_tooltip){this._super(),this.init(_cb_tooltip)},init:function(_cb_tooltip){this.m_showtooltip=_cb_tooltip;var cellSize=cc.size(444,78);this.setContentSize(cellSize);var box=cc.Scale9Sprite.create(RES_CDN_DEFULT+"menu_yh/img_yh_info_box.png",cc.rect(20,20,20,20));return box.setPreferredSize(cellSize),box.setAnchorPoint(ZERO()),box.setPosition(ZERO()),this.addChild(box),this.m_icon_frame=cc.Sprite.create(RES_CDN_DEFULT+"icon/img_icon_frame.png"),this.m_icon_frame.setAnchorPoint(ANCHOR_MIDDLE_LEFT()),this.m_icon_frame.setPosition(4,.5*cellSize.height),box.addChild(this.m_icon_frame),this.m_item_title=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_2013),this.m_item_title.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),this.m_item_title.setPosition(80,43),box.addChild(this.m_item_title),this.m_item_count=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_181),this.m_item_count.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),this.m_item_count.setPosition(80,16),box.addChild(this.m_item_count),this.m_equip_jewelry=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_144),this.m_equip_jewelry.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),this.m_equip_jewelry.setPosition(cellSize.width-10,13),box.addChild(this.m_equip_jewelry),this.m_equip_step=cc.Sprite.create("#img_equip_text_plus.png"),this.m_equip_step.setAnchorPoint(ANCHOR_TOP_RIGHT()),this.m_equip_step.setPosition(72,73),box.addChild(this.m_equip_step),!0},setData:function(data){this.m_item_data=data,this.updateCell(this.m_item_data)},highLightPosInCell:function(pos){var r=this.m_icon_frame.getBoundingBox();cc.rectContainsPoint(r,pos)&&null!=this.m_showtooltip&&this.m_showtooltip(this.m_item_data,this.getTouchTablePos())},updateCell:function(data){var m=MasterManager.getInstance();if(null!=this.m_item_icon&&this.m_item_icon.getParent()&&this.m_item_icon.removeFromParentAndCleanup(!0),this.m_equip_jewelry.setVisible(!1),this.m_equip_step.setVisible(!1),data.item.bonus_type==BONUS_TYPE_YUNHEE_FIX){var card=new Card;card.gnrl_id=data.item.min_value,this.m_item_icon=(new Card).createCard(card,CARD_TYPE.type_card_thumb);var gnrl=m.get_General(data.item.min_value);this.m_item_title.setString(cmString("%s x%d",gnrl.name,data.item.max_value)),cmLabel.autoSizeFit(this.m_item_title,350,20)}else if(data.item.bonus_type==BONUS_TYPE_EQUIPMENT);else{this.m_item_icon=cc.Sprite.create(cmString("#img_reward_%02d.png",data.item.bonus_type));var bonus=m.get_BonusType(data.item.bonus_type);this.m_item_title.setString(cmString("%s x%d",bonus.name,data.item.min_value)),cmLabel.autoSizeFit(this.m_item_title,350,20)}if(this.m_item_icon.setAnchorPoint(ANCHOR_MIDDLE()),this.m_item_icon.setPosition(ccCenter(this.m_icon_frame)),this.m_icon_frame.addChild(this.m_item_icon),0==data.item.count)this.m_item_count.setString(res_str("label_event_dungeon_treasure_box_count_3"));else{var remain_count=data.item.count-data.gain_count;this.m_item_count.setString(cmString(res_str("label_event_dungeon_box_gacha_count"),remain_count,data.item.count))}}}),EventDungeonBoxGachaGoldenBarrelPopupV2=cc.Layer.extend({m_close_callback:null,m_table_view:null,tooltip_box:null,tooltip_title:null,tooltip_content:null,m_box_gacha_info:null,m_golden_barrel_data_list:[],ctor:function(box_gacha_info,_close_callback){this._super(),this.m_golden_barrel_data_list=[],this.init(box_gacha_info,_close_callback)},init:function(box_gacha_info,_close_callback){this.m_close_callback=_close_callback,this.m_box_gacha_info=box_gacha_info;for(var m=MasterTable.getInstance(),mt=MasterManager.getInstance(),item_list=m.get_EventDungeonBoxGachaGoldenBarrelList(this.m_box_gacha_info.event_dungeon_period_idx),i=0;i<item_list.length;i++){var item=item_list[i],data={};data.item=item,data.gain_count=0,this.m_golden_barrel_data_list.push(data)}try{for(var j=0;j<this.m_golden_barrel_data_list.length;j++)for(var k=0;k<this.m_box_gacha_info.golden_barrel_log.length;k++){item=this.m_box_gacha_info.golden_barrel_log[k];var d=mt.get_EventDungeonBoxGachaGoldenBarrel(item.event_dungeon_period_idx,item.bonus_type);this.m_golden_barrel_data_list[j].item.bonus_type==d.bonus_type&&this.m_golden_barrel_data_list[j].item.min_value==d.min_value&&(this.m_golden_barrel_data_list[j].gain_count+=1)}}catch(e){}this.m_golden_barrel_data_list=stable(this.m_golden_barrel_data_list,function(l,r){return l.item.sort_num>r.item.sort_num});var winSize=ccSize(this),boxSize=cc.size(478,541),box=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_script_box_2.png",cc.Rect(40,40,10,10));box.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),box.setPreferredSize(cc.size(478,541)),box.setPosition(.5*winSize.width,10),this.addChild(box);var navi=cc.Sprite.create(RES_CDN_DEFULT+"common/img_navi_center_2.png");navi.setAnchorPoint(ANCHOR_MIDDLE_TOP()),navi.setPosition(ccCenter(box).x,ccHeight(box)-11),box.addChild(navi);var navi_title=cmLabel.getLabel(res_str("label_event_dungeon_golden_barrel_title"),LABEL_FONT_INDEX.FONT_261);navi_title.setAnchorPoint(ANCHOR_MIDDLE()),navi_title.setPosition(ccCenter(navi).x,ccCenter(navi).y+3),navi.addChild(navi_title);var btn=new ccui.Button("btn_cancel_off.png","btn_cancel_on.png","",ccui.Widget.PLIST_TEXTURE);btn.setAnchorPoint(ANCHOR_MIDDLE_RIGHT()),btn.setPosition(ccWidth(navi)-16,ccCenter(navi).y+2),btn.addClickEventListener(function(sender){null!=this.m_close_callback&&this.m_close_callback()}.bind(this)),navi.addChild(btn);var tableSize=cc.size(444,boxSize.height-90);return this.m_table_view=new cc.TableView(this,tableSize),this.m_table_view.ignoreAnchorPointForPosition(!1),this.m_table_view.setDirection(cc.SCROLLVIEW_DIRECTION_VERTICAL),this.m_table_view.setVerticalFillOrder(cc.TABLEVIEW_FILL_TOPDOWN),this.m_table_view.scrollBarEnable(!0),this.m_table_view.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),this.m_table_view.setPosition(17,18),box.addChild(this.m_table_view),this.m_table_view.setDelegate(this),this.m_table_view.reloadData(),this.tooltip_box=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_result_box.png",cc.Rect(20,20,20,20)),this.tooltip_box.setAnchorPoint(ANCHOR_MIDDLE_LEFT()),this.tooltip_box.setPosition(ZERO()),this.tooltip_box.setVisible(!1),box.addChild(this.tooltip_box,100),this.tooltip_title=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_1810),this.tooltip_title.setAnchorPoint(ANCHOR_TOP_LEFT()),this.tooltip_box.addChild(this.tooltip_title),this.tooltip_content=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_181),this.tooltip_content.setAnchorPoint(ANCHOR_MIDDLE),this.tooltip_content.setPosition(ccCenter(this.tooltip_box)),this.tooltip_box.addChild(this.tooltip_content),!0},cellSizeForTable:function(table){return cc.size(444,78)},tableCellSizeForIndex:function(table){return cc.size(444,78)},tableCellAtIndex:function(table,idx){var c=table.dequeueCell(),cell=null;return(cell=null!=c?c:new EventDungeonBoxGachaGoldenBarrelCellV2(this.showTooltip.bind(this))).setData(this.m_golden_barrel_data_list[idx]),cell},numberOfCellsInTableView:function(table){return this.m_golden_barrel_data_list.length},tableCellTouched:function(table,cell){},tableCellHighlight:function(table,cell){null!=cell&&cell.highLightPosInCell(cell.getTouchPos())},tableCellUnhighlight:function(table,cell){this.hideTooltip()},showTooltip:function(data,pos){var winSize=cc.size(ccSize(this));this.tooltip_box.setVisible(!0);var m=MasterTable.getInstance(),mt=MasterManager.getInstance();if(data.item.bonus_type==BONUS_TYPE_YUNHEE_FIX){var gnrl=mt.get_General(data.item.min_value);if(""==(tooltip=m.get_TooltipGeneral(data.item.min_value)).content||null==tooltip.content){this.tooltip_title.setString(gnrl.name),this.tooltip_title.setAnchorPoint(ANCHOR_MIDDLE()),this.tooltip_content.setString("");var tSize=ccSize(this.tooltip_title);(bSize=cc.size(tSize.width+20,tSize.height+20)).width=Math.max(64,tSize.width+20),bSize.height=Math.max(54,bSize.height+10),this.tooltip_box.setPreferredSize(bSize),this.tooltip_title.setPosition(ccCenter(bSize))}else{this.tooltip_title.setString(gnrl.name),this.tooltip_title.setAnchorPoint(ANCHOR_TOP_LEFT()),this.tooltip_content.setString(tooltip.content);tSize=ccSize(this.tooltip_title);var cSize=ccSize(this.tooltip_content);(bSize=cc.size(tSize.width+20,tSize.height+20)).width=Math.max(tSize.width+20,cSize.width+20),bSize.height=Math.max(64,bSize.height+cSize.height+5),this.tooltip_box.setPreferredSize(bSize),this.tooltip_title.setPosition(10,bSize.height-10),this.tooltip_content.setPosition(10,bSize.height-15-tSize.height)}var bSize=this.tooltip_box.getPreferredSize();if((t_pos=this.m_table_view.getPosition()).y+=pos.y,t_pos.y+.5*bSize.height>winSize.height-55){var top=t_pos.y+.5*bSize.height-(winSize.height-55-20);t_pos.y-=top}this.tooltip_box.setPosition(t_pos.x+80,t_pos.y),this.tooltip_content.setPosition(10,12)}else if(data.item.bonus_type==BONUS_TYPE_EQUIPMENT);else{var tooltip,bonus=mt.get_BonusType(data.item.bonus_type);if(""==(tooltip=m.get_TooltipItem(data.item.bonus_type)).content||null==tooltip.content){this.tooltip_title.setString(bonus.name),this.tooltip_title.setAnchorPoint(ANCHOR_MIDDLE()),this.tooltip_content.setString("");tSize=ccSize(this.tooltip_title);(bSize=cc.size(tSize.width+20,tSize.height+20)).width=Math.max(64,tSize.width+20),bSize.height=Math.max(54,bSize.height+10),this.tooltip_box.setPreferredSize(bSize),this.tooltip_title.setPosition(ccCenter(bSize))}else{this.tooltip_title.setString(bonus.name),this.tooltip_title.setAnchorPoint(ANCHOR_TOP_LEFT()),this.tooltip_content.setString(tooltip.content);tSize=ccSize(this.tooltip_title),cSize=ccSize(this.tooltip_content);(bSize=cc.size(tSize.width+20,tSize.height+20)).width=Math.max(tSize.width+20,cSize.width+20),bSize.height=Math.max(64,bSize.height+cSize.height+5),this.tooltip_box.setPreferredSize(bSize),this.tooltip_title.setPosition(10,bSize.height-10),this.tooltip_content.setPosition(10,bSize.height-15-tSize.height)}var t_pos;bSize=this.tooltip_box.getPreferredSize();if((t_pos=this.m_table_view.getPosition()).y+=pos.y,t_pos.y+.5*bSize.height>winSize.height-55){top=t_pos.y+.5*bSize.height-(winSize.height-55-20);t_pos.y-=top}this.tooltip_box.setPosition(t_pos.x+80,t_pos.y),this.tooltip_content.setPosition(10,12)}},hideTooltip:function(){this.tooltip_box.setVisible(!1)},scrollViewDidScroll:function(view){},scrollViewDidZoom:function(view){},tableCellEnded:function(){},tableCellSelectedCallback:function(){}}),EventDungeonEpilogueLayer=cc.Layer.extend({m_label:null,m_script_index:0,m_bg_frame:null,m_name_label:null,m_finger:null,m_left_hero:null,m_middle_hero:null,m_right_hero:null,m_is_complete:!1,m_script_bg:null,m_left_emotion:null,m_middle_emotion:null,m_right_emotion:null,m_is_doing_transition_scene:!1,m_script_cover:null,m_is_doing_attack_scene:!1,m_attack_cover:null,m_cliper:null,m_stencil_node:null,_scriptViewCompleteNotBattle:null,m_user_info:{},m_body_img:null,m_hero_left_script:null,m_hero_middle_script:null,m_hero_right_script:null,m_hero_left_script_texture:null,m_hero_middle_script_texture:null,m_hero_right_script_texture:null,winSize:null,m_resource_list:null,ctor:function(){return this._super(),this.m_script_list=[],this.init(),!0},init:function(){BattleAni._getInstance().Is_loaded()||BattleAni._getInstance().loadAnimate(),this.winSize=cc.director.getWinSize(),UserService.getInstance().getUserInfo(this.m_user_info).done(function(data){this.m_user_info=data}.bind(this)),this.ignoreAnchorPointForPosition(!1),this.setContentSize(this.winSize),this.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),this.setPosition(ZERO()),this.m_script_bg=new cc.Sprite(RES_CDN_DEFULT+"card_script_bg/116.jpg"),USE_SP_SCRIPT_BG_SCALE&&this.m_script_bg.setScale(2),this.m_script_bg.setAnchorPoint(.5,.5),this.m_script_bg.setPosition(this.winSize.width/2,this.winSize.height/2),this.addChild(this.m_script_bg),this.m_left_hero=new cc.Sprite,this.m_left_hero.setAnchorPoint(.5,0),this.m_left_hero.setPosition(.5*ccWidth(this.m_left_hero)*1.4,0),this.m_left_hero.setScale(1.4),this.addChild(this.m_left_hero);var l_size=ccSize(this.m_left_hero);this.m_left_emotion=new cc.Sprite,this.m_left_emotion.setAnchorPoint(.5,.5),this.m_left_emotion.setPosition(.5*l_size.width,l_size.height-70),this.m_left_hero.addChild(this.m_left_emotion,-1),this.m_middle_hero=new cc.Sprite,this.m_middle_hero.setAnchorPoint(.5,0),this.m_middle_hero.setPosition(.5*this.winSize.width,0),this.m_middle_hero.setScale(1.4),this.addChild(this.m_middle_hero);var m_size=ccSize(this.m_middle_hero);this.m_middle_emotion=new cc.Sprite,this.m_middle_emotion.setAnchorPoint(.5,.5),this.m_middle_emotion.setPosition(.5*m_size.width,m_size.height-70),this.m_middle_hero.addChild(this.m_middle_emotion,-1),this.m_right_hero=new cc.Sprite,this.m_right_hero.setAnchorPoint(.5,0),this.m_right_hero.setPosition(this.winSize.width-.5*this.m_right_hero.getContentSize().width*1.4,0),this.m_right_hero.setScale(1.4),this.addChild(this.m_right_hero);var r_size=ccSize(this.m_right_hero);this.m_right_emotion=new cc.Sprite,this.m_right_emotion.setAnchorPoint(.5,.5),this.m_right_emotion.setPosition(.5*r_size.width,r_size.height-70),this.m_right_hero.addChild(this.m_right_emotion,-1);var boxSize=cc.size(this.winSize.width,172);this.m_bg_frame=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_script_line_1.png",cc.rect(1,0,1,0)),this.m_bg_frame.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),this.m_bg_frame.setPreferredSize(boxSize),this.m_bg_frame.setPosition(ZERO()),this.addChild(this.m_bg_frame),this.m_name_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_261),this.m_name_label.setAnchorPoint(ANCHOR_TOP_LEFT()),this.m_name_label.setPosition(30,boxSize.height-15),this.m_bg_frame.addChild(this.m_name_label),this.m_finger=new cc.Sprite,this.m_finger.setAnchorPoint(1,0),this.m_finger.setPosition(boxSize.width,10),this.m_bg_frame.addChild(this.m_finger);var repeat=BattleAni._getInstance().getAnimate(BattleAni_.EffectFinger).repeatForever();this.m_finger.runAction(repeat),this.m_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_221),this.m_label.setAnchorPoint(ANCHOR_TOP_LEFT()),this.m_label.setPosition(30,this.m_bg_frame.getContentSize().height-50),this.m_label.setTextVerticalAlignment(cc.VERTICAL_TEXT_ALIGNMENT_TOP),this.m_label.setTextHorizontalAlignment(cc.TEXT_ALIGNMENT_LEFT),this.m_bg_frame.addChild(this.m_label);var touch_button_sc9=new cc.Scale9Sprite(RES_CDN_DEFULT+"common/img_9p_transbox.png",cc.rect(1,0,1,0)),touch_button=new cc.ControlButton(touch_button_sc9);touch_button.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),touch_button.setPreferredSize(this.winSize),touch_button.setPosition(ZERO()),this.addChild(touch_button),touch_button.addTargetWithActionForControlEvents(this,this.onTouchTalkBox,cc.CONTROL_EVENT_TOUCH_UP_INSIDE),this.m_script_cover=new cc.Sprite(RES_CDN_DEFULT+"card_script_bg/116.jpg"),USE_SP_SCRIPT_BG_SCALE&&this.m_script_cover.setScale(2),this.m_script_cover.setAnchorPoint(.5,.5),this.m_script_cover.setPosition(this.winSize.width/2,this.winSize.height/2),this.m_script_cover.opacity=0,this.addChild(this.m_script_cover);var container=new cc.Layer;container.ignoreAnchorPointForPosition(!1),container.setContentSize(this.winSize),container.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),container.setPosition(0,0),this.addChild(container),this.m_cliper=new cc.ClippingNode,this.m_cliper.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),this.m_cliper.alphaThreshold=.5,this.m_cliper.setPosition(ZERO()),container.addChild(this.m_cliper),this.m_stencil_node=new cc.Node,this.m_stencil_node.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),this.m_stencil_node.setPosition(this.winSize.width,0),this.m_cliper.stencil=this.m_stencil_node;var spot=new cc.Sprite(RES_CDN_DEFULT+"card_script_bg/116.jpg");USE_SP_SCRIPT_BG_SCALE&&spot.setScale(2),spot.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),spot.setPosition(ZERO()),this.m_stencil_node.addChild(spot),this.m_stencil_node.setContentSize(spot.getContentSize()),this.m_attack_cover=new cc.Sprite(RES_CDN_DEFULT+"uieffect/attack_1.png"),this.m_attack_cover.setAnchorPoint(ANCHOR_MIDDLE()),this.m_attack_cover.setPosition(ccCenter(this.winSize)),this.m_cliper.addChild(this.m_attack_cover);var skip=new ccui.Button;skip.loadTextures(RES_CDN_DEFULT+"menu_battle/btn/btn_skip_off.png",RES_CDN_DEFULT+"menu_battle/btn/btn_skip_on.png",""),skip.setAnchorPoint(ANCHOR_TOP_RIGHT()),skip.setPosition(this.winSize.width-10,this.winSize.height-10),this.addChild(skip),skip.addClickEventListener(function(sender){null!=this._scriptViewCompleteNotBattle&&(AudioEngine.getInstance().stopBackgroundMusic(),this._scriptViewCompleteNotBattle.scriptEventDungeonComplete(this))}.bind(this))},onEnter:function(){this._super()},onExit:function(){if(this._super(),null!=this.m_resource_list&&null!=this.m_resource_list)for(var i=0;i<this.m_resource_list.length;i++)cc.loader.release(this.m_resource_list[i]);null!=this.m_body_img&&null!=this.m_body_img&&cc.loader.release(this.m_body_img),this.removeAllChildrenWithCleanup(!0),this.m_label=null,this.m_script_index=0,this.m_bg_frame=null,this.m_name_label=null,this.m_finger=null,this.m_left_hero=null,this.m_middle_hero=null,this.m_right_hero=null,this.m_script_bg=null,this.m_left_emotion=null,this.m_middle_emotion=null,this.m_right_emotion=null,this.m_script_cover=null,this.m_attack_cover=null,this.m_cliper=null,this.m_stencil_node=null,this._scriptViewCompleteNotBattle=null,this.m_user_info=null,this.m_body_img=null,this.m_hero_left_script=null,this.m_hero_middle_script=null,this.m_hero_right_script=null,this.m_hero_left_script_texture=null,this.m_hero_middle_script_texture=null,this.m_hero_right_script_texture=null,this.winSize=null,this.m_resource_list=null,delete this.m_label,delete this.m_script_index,delete this.m_bg_frame,delete this.m_name_label,delete this.m_finger,delete this.m_left_hero,delete this.m_middle_hero,delete this.m_right_hero,delete this.m_script_bg,delete this.m_left_emotion,delete this.m_middle_emotion,delete this.m_right_emotion,delete this.m_script_cover,delete this.m_attack_cover,delete this.m_cliper,delete this.m_stencil_node,delete this._scriptViewCompleteNotBattle,delete this.m_user_info,delete this.m_body_img,delete this.m_hero_left_script,delete this.m_hero_middle_script,delete this.m_hero_right_script,delete this.m_hero_left_script_texture,delete this.m_hero_middle_script_texture,delete this.m_hero_right_script_texture,delete this.winSize,delete this.m_resource_list},loadScript_1:function(prologue_event_dungeon_period_idx,epilogue_event_dungeon_period_idx,occured_type,_callback){var m=MasterTable.getInstance();if(this.reset(),0!=prologue_event_dungeon_period_idx&&(this.m_script_list=m.get_EventDungeonEpilogue(prologue_event_dungeon_period_idx,occured_type)),0!=epilogue_event_dungeon_period_idx)for(var script_list=m.get_EventDungeonEpilogue(epilogue_event_dungeon_period_idx,occured_type),i=0;i<script_list.length;i++)this.m_script_list.push(script_list[i]);null!=this.m_resource_list&&null!=this.m_resource_list||(this.m_resource_list=[]);var resource_list=[];this.m_hero_left_script=[],this.m_hero_middle_script=[],this.m_hero_right_script=[],this.m_hero_left_script_texture=[],this.m_hero_middle_script_texture=[],this.m_hero_right_script_texture=[];for(var idx=0;idx<this.m_script_list.length;idx++){if(this.m_script_list[idx].voice,"0"!=this.m_script_list[idx].r_filename)if(resource_list.push(RES_CDN_DEFULT+"card_script_body/"+this.m_script_list[idx].r_filename+".png"),0!=this.m_hero_right_script.length)-1==this.m_hero_right_script.indexOf(this.m_script_list[idx].r_filename)&&(this.m_hero_right_script.push(this.m_script_list[idx].r_filename),this.m_hero_right_script_texture.push(cc.textureCache.addImage(RES_CDN_DEFULT+"card_script_body/"+this.m_script_list[idx].r_filename+".png")));else this.m_hero_right_script.push(this.m_script_list[idx].r_filename),this.m_hero_right_script_texture.push(cc.textureCache.addImage(RES_CDN_DEFULT+"card_script_body/"+this.m_script_list[idx].r_filename+".png"));if("0"!=this.m_script_list[idx].m_filename)if(resource_list.push(RES_CDN_DEFULT+"card_script_body/"+this.m_script_list[idx].m_filename+".png"),0!=this.m_hero_middle_script.length)-1==this.m_hero_middle_script.indexOf(this.m_script_list[idx].m_filename)&&(this.m_hero_middle_script.push(this.m_script_list[idx].m_filename),this.m_hero_middle_script_texture.push(cc.textureCache.addImage(RES_CDN_DEFULT+"card_script_body/"+this.m_script_list[idx].m_filename+".png")));else this.m_hero_middle_script.push(this.m_script_list[idx].m_filename),this.m_hero_middle_script_texture.push(cc.textureCache.addImage(RES_CDN_DEFULT+"card_script_body/"+this.m_script_list[idx].m_filename+".png"));if("0"!=this.m_script_list[idx].l_filename)if(resource_list.push(RES_CDN_DEFULT+"card_script_body/"+this.m_script_list[idx].l_filename+".png"),0!=this.m_hero_left_script.length)-1==this.m_hero_left_script.indexOf(this.m_script_list[idx].m_filename)&&(this.m_hero_left_script.push(this.m_script_list[idx].l_filename),this.m_hero_left_script_texture.push(cc.textureCache.addImage(RES_CDN_DEFULT+"card_script_body/"+this.m_script_list[idx].l_filename+".png")));else this.m_hero_left_script.push(this.m_script_list[idx].l_filename),this.m_hero_left_script_texture.push(cc.textureCache.addImage(RES_CDN_DEFULT+"card_script_body/"+this.m_script_list[idx].l_filename+".png"));"0"!=this.m_script_list[idx].bg_num&&resource_list.push(RES_CDN_DEFULT+"card_script_bg/"+this.m_script_list[idx].bg_num+".jpg")}return this.m_resource_list=resource_list.reduce(function(a,b){if(0==a.length)return a.push(b),a;for(var is_chk=!1,idx=0;idx<a.length;idx++)a[idx]==b&&(is_chk=!0);return 0==is_chk&&a.push(b),a},[]),resourceLoader(this.m_resource_list,function(){null!=_callback&&_callback()}.bind(this)),!(this.m_script_list.length<=0)},loadScript:function(event_dungeon_period_idx,occured_type,_callback){var m=MasterTable.getInstance();this.reset(),this.m_script_list=m.get_EventDungeonEpilogue(event_dungeon_period_idx,occured_type),null!=this.m_resource_list&&null!=this.m_resource_list||(this.m_resource_list=[]);var resource_list=[];this.m_hero_left_script=[],this.m_hero_middle_script=[],this.m_hero_right_script=[],this.m_hero_left_script_texture=[],this.m_hero_middle_script_texture=[],this.m_hero_right_script_texture=[];for(var idx=0;idx<this.m_script_list.length;idx++){if(this.m_script_list[idx].voice,"0"!=this.m_script_list[idx].r_filename)if(resource_list.push(RES_CDN_DEFULT+"card_script_body/"+this.m_script_list[idx].r_filename+".png"),0!=this.m_hero_right_script.length)-1==this.m_hero_right_script.indexOf(this.m_script_list[idx].r_filename)&&(this.m_hero_right_script.push(this.m_script_list[idx].r_filename),this.m_hero_right_script_texture.push(cc.textureCache.addImage(RES_CDN_DEFULT+"card_script_body/"+this.m_script_list[idx].r_filename+".png")));else this.m_hero_right_script.push(this.m_script_list[idx].r_filename),this.m_hero_right_script_texture.push(cc.textureCache.addImage(RES_CDN_DEFULT+"card_script_body/"+this.m_script_list[idx].r_filename+".png"));if("0"!=this.m_script_list[idx].m_filename)if(resource_list.push(RES_CDN_DEFULT+"card_script_body/"+this.m_script_list[idx].m_filename+".png"),0!=this.m_hero_middle_script.length)-1==this.m_hero_middle_script.indexOf(this.m_script_list[idx].m_filename)&&(this.m_hero_middle_script.push(this.m_script_list[idx].m_filename),this.m_hero_middle_script_texture.push(cc.textureCache.addImage(RES_CDN_DEFULT+"card_script_body/"+this.m_script_list[idx].m_filename+".png")));else this.m_hero_middle_script.push(this.m_script_list[idx].m_filename),this.m_hero_middle_script_texture.push(cc.textureCache.addImage(RES_CDN_DEFULT+"card_script_body/"+this.m_script_list[idx].m_filename+".png"));if("0"!=this.m_script_list[idx].l_filename)if(resource_list.push(RES_CDN_DEFULT+"card_script_body/"+this.m_script_list[idx].l_filename+".png"),0!=this.m_hero_left_script.length)-1==this.m_hero_left_script.indexOf(this.m_script_list[idx].l_filename)&&(this.m_hero_left_script.push(this.m_script_list[idx].l_filename),this.m_hero_left_script_texture.push(cc.textureCache.addImage(RES_CDN_DEFULT+"card_script_body/"+this.m_script_list[idx].l_filename+".png")));else this.m_hero_left_script.push(this.m_script_list[idx].l_filename),this.m_hero_left_script_texture.push(cc.textureCache.addImage(RES_CDN_DEFULT+"card_script_body/"+this.m_script_list[idx].l_filename+".png"));"0"!=this.m_script_list[idx].bg_num&&resource_list.push(RES_CDN_DEFULT+"card_script_bg/"+this.m_script_list[idx].bg_num+".jpg")}return this.m_resource_list=resource_list.reduce(function(a,b){if(0==a.length)return a.push(b),a;for(var is_chk=!1,idx=0;idx<a.length;idx++)a[idx]==b&&(is_chk=!0);return 0==is_chk&&a.push(b),a},[]),resourceLoader(this.m_resource_list,function(){null!=_callback&&_callback()}.bind(this)),!(this.m_script_list.length<=0)},IsReady:function(){return 0!=this.m_script_list.length},typingBattleScript:function(){if(this.m_is_complete)null!=this._scriptViewCompleteNotBattle&&(AudioEngine.getInstance().stopBackgroundMusic(),this._scriptViewCompleteNotBattle.scriptEventDungeonComplete(this));else if(this.m_script_index<this.m_script_list.length){var script=this.m_script_list[this.m_script_index];if(script.scene_type==SCENE_TYPE_ATTACK)return void this.startAttackEffect(script.scene_desc);if(script.scene_type==SCENE_TYPE_TRANSITION){this.m_is_doing_transition_scene=!0;var fadeout=cc.fadeIn(1),cb=cc.callFunc(this.cbMiddleSceneTransition.bind(this)),seq=cc.sequence(fadeout,cb);return void this.m_script_cover.runAction(seq)}if(script.scene_type==SCENE_TYPE_SHAKE){script.scene_desc;var shake=new Shake(APPEAR_DURATION,15);this.runAction(shake)}this.updateScript(script)}},reset:function(){this.m_script_index=0,this.m_is_complete=!1,this.m_script_list.length=0,this.m_script_list=[]},updateBG:function(bg_num){this.m_body_img=RES_CDN_DEFULT+"card_script_bg/"+bg_num+".jpg",resourceLoader(this.m_body_img,function(){var frame2_texture=cc.textureCache.addImage(this.m_body_img),frame2=new cc.SpriteFrame(frame2_texture,cc.rect(0,0,frame2_texture.getContentSize().width,frame2_texture.getContentSize().height));this.m_script_bg.setSpriteFrame(frame2)}.bind(this))},updateScript:function(script){if(0<script.bg_num&&this.updateBG(script.bg_num),"0"==script.name?this.m_name_label.setString(""):"1"==script.name?this.m_name_label.setString(this.m_user_info.nickname):this.m_name_label.setString(script.name),"0"==script.l_filename)this.m_left_hero.setVisible(!1);else{this.m_left_hero.setVisible(!0),this.m_left_hero.setOpacity(255);var body_l_check=this.m_hero_left_script.indexOf(script.l_filename);if(-1!=body_l_check){var frame2_texture_left=this.m_hero_left_script_texture[body_l_check],frame2_left=new cc.SpriteFrame(frame2_texture_left,cc.rect(0,0,frame2_texture_left.getContentSize().width,frame2_texture_left.getContentSize().height));this.m_left_hero.setSpriteFrame(frame2_left)}1==script.onoff||4==script.onoff?this.m_left_hero.setColor(cc.color(255,255,255)):0!=script.onoff&&2!=script.onoff&&3!=script.onoff||this.m_left_hero.setColor(cc.color(166,166,166)),this.m_left_hero.setPosition(.5*ccWidth(this.m_left_hero)*1.4,0),this.m_left_hero.isRunning()&&(this.m_left_hero.stopAllActions(),this.m_left_hero.setPosition(.5*ccWidth(this.m_left_hero)*1.4,0),this.m_left_hero.setOpacity(255),this.m_left_hero.setScale(1.4)),this.appearHero(script.l_appear_type,this.m_left_hero),this.heroEmotion(script.l_emotion,this.m_left_hero,this.m_left_emotion),1==script.l_reverse?this.m_left_hero.setFlippedX(!0):this.m_left_hero.setFlippedX(!1)}if("0"==script.m_filename)this.m_middle_hero.setVisible(!1);else{this.m_middle_hero.setVisible(!0),this.m_middle_hero.setOpacity(255);var body_m_check=this.m_hero_middle_script.indexOf(script.m_filename);if(-1!=body_m_check){var frame2_texture_middle=this.m_hero_middle_script_texture[body_m_check],frame2_middle=new cc.SpriteFrame(frame2_texture_middle,cc.rect(0,0,frame2_texture_middle.getContentSize().width,frame2_texture_middle.getContentSize().height));this.m_middle_hero.setSpriteFrame(frame2_middle)}3==script.onoff||4==script.onoff?this.m_middle_hero.setColor(cc.color(255,255,255)):0!=script.onoff&&1!=script.onoff&&2!=script.onoff||this.m_middle_hero.setColor(cc.color(166,166,166)),this.m_middle_hero.setPosition(.5*this.winSize.width,0),this.m_middle_hero.isRunning()&&(this.m_middle_hero.stopAllActions(),this.m_middle_hero.setPosition(.5*this.winSize.width,0),this.m_middle_hero.setOpacity(255),this.m_middle_hero.setScale(1.4)),this.appearHero(script.m_appear_type,this.m_middle_hero),this.heroEmotion(script.m_emotion,this.m_middle_hero,this.m_middle_emotion)}if("0"==script.r_filename)this.m_right_hero.setVisible(!1);else{this.m_right_hero.setVisible(!0),this.m_right_hero.setOpacity(255);var body_r_check=this.m_hero_right_script.indexOf(script.r_filename);if(-1!=body_r_check){var frame2_texture_right=this.m_hero_right_script_texture[body_r_check],frame2_right=new cc.SpriteFrame(frame2_texture_right,cc.rect(0,0,frame2_texture_right.getContentSize().width,frame2_texture_right.getContentSize().height));this.m_right_hero.setSpriteFrame(frame2_right)}2==script.onoff||4==script.onoff?this.m_right_hero.setColor(cc.color(255,255,255)):0!=script.onoff&&1!=script.onoff&&3!=script.onoff||this.m_right_hero.setColor(cc.color(166,166,166)),this.m_right_hero.setPosition(this.winSize.width-.5*ccWidth(this.m_right_hero)*1.4,0),this.m_right_hero.isRunning()&&(this.m_right_hero.stopAllActions(),this.m_right_hero.setPosition(this.winSize.width-.5*ccWidth(this.m_right_hero)*1.4,0),this.m_right_hero.setOpacity(255),this.m_right_hero.setScale(1.4)),this.appearHero(script.r_appear_type,this.m_right_hero),this.heroEmotion(script.r_emotion,this.m_right_hero,this.m_right_emotion),1==script.r_reverse?this.m_right_hero.setFlippedX(!0):this.m_right_hero.setFlippedX(!1)}if(1==script.name_type?this.m_label.setString(cmString(script.content,this.m_user_info.nickname)):this.m_label.setString(script.content),"0"!=script.sound){var audio=AudioEngine.getInstance(),path=RES_CDN_SOUND+SND_TYPE+"voice_etc/"+script.sound+".mp3";audio.playVoice(path)}this.isRunning()&&(this.stopAllActions(),this.setPosition(ZERO())),this.m_script_index++,this.m_script_index>=this.m_script_list.length&&(this.m_script_index=this.m_script_list.length-1,this.m_is_complete=!0)},appearHero:function(type,hero){if(type==APPEAR_TYPE_FADE_IN){hero.setOpacity(0);var fadein=cc.fadeIn(APPEAR_DURATION);hero.runAction(fadein)}else if(type==APPEAR_TYPE_SHAKE){var shake=new Shake(APPEAR_DURATION,15);hero.runAction(shake)}else if(type==APPEAR_TYPE_BOMB){hero.setScale(3);var ease=cc.scaleTo(.1,1.4).clone().easing(cc.easeBounceOut());hero.runAction(ease)}},heroEmotion:function(type,hero,emotion){if(0==type)emotion.setVisible(!1);else{var n_size=ccSize(hero);emotion.setVisible(!0),emotion.setPosition(.5*n_size.width,n_size.height-70),emotion.isRunning()&&emotion.stopAllActions();var animate=BattleAni._getInstance().getAnimate(BattleAni_.EffectEmotion_1+(type-1));emotion.runAction(new cc.RepeatForever(animate))}},cbMiddleSceneTransition:function(){var fadein=cc.fadeOut(1),cb=cc.callFunc(this.cbEndSceneTransition.bind(this)),seq=cc.sequence(fadein,cb);this.m_script_cover.runAction(seq),this.m_script_index++,this.m_script_index>=this.m_script_list.length&&(this.m_script_index=this.m_script_list.length-1,this.m_is_complete=!0),this.typingBattleScript()},cbEndSceneTransition:function(){this.m_is_doing_transition_scene=!1},startAttackEffect:function(scene_desc){this.m_is_doing_attack_scene=!0;var body_img=RES_CDN_DEFULT+"uieffect/attack_"+scene_desc+".png",frame2_texture=cc.textureCache.addImage(body_img),frame2=new cc.SpriteFrame(frame2_texture,cc.rect(0,0,frame2_texture.getContentSize().width,frame2_texture.getContentSize().height));if(this.m_attack_cover.setSpriteFrame(frame2),scene_desc==ATTACK_TYPE_CUT?this.m_stencil_node.setPosition(0,this.winSize.height):scene_desc==ATTACK_TYPE_STRING?this.m_stencil_node.setPosition(0,-this.winSize.height):scene_desc==ATTACK_TYPE_FIST?this.m_stencil_node.setPosition(ZERO()):scene_desc==ATTACK_TYPE_ARROW?this.m_stencil_node.setPosition(this.winSize.width,0):scene_desc==ATTACK_TYPE_UP_DOWN&&this.m_stencil_node.setPosition(0,this.winSize.height),scene_desc==ATTACK_TYPE_FIST){this.m_attack_cover.setOpacity(0);var fadein=new cc.FadeIn(ATTACK_DURATION),delay=new cc.DelayTime(.5),cb=new cc.CallFunc(this.cbMiddleAttackEffect.bind(this)),seq=new cc.Sequence(fadein,delay,cb);this.m_attack_cover.runAction(seq)}else{this.m_attack_cover.setOpacity(255);var ease=new cc.MoveTo(ATTACK_DURATION,cc.p(0,0)).clone().easing(cc.easeOut(ATTACK_DURATION-.1));delay=cc.delayTime(.5),cb=cc.callFunc(this.cbMiddleAttackEffect.bind(this)),seq=cc.sequence(ease,delay,cb);this.m_stencil_node.runAction(seq)}},cbMiddleAttackEffect:function(){var fade=cc.fadeOut(APPEAR_DURATION),cb=cc.callFunc(this.cbEndAttackEffect.bind(this)),seq=cc.sequence(fade,cb);this.m_attack_cover.runAction(seq),this.m_script_index++,this.m_script_index>=this.m_script_list.length&&(this.m_script_index=this.m_script_list.length-1,this.m_is_complete=!0),this.typingBattleScript()},cbEndAttackEffect:function(){this.m_is_doing_attack_scene=!1},onTouchTalkBox:function(sender,_event){this.isVisible()&&(this.m_is_doing_transition_scene||this.m_is_doing_attack_scene||this.typingBattleScript())}}),EventDungeonAchieveListItemCell=cc.TableViewCell.extend({m_name_label:null,m_reward_label:null,m_content:null,m_gauge:null,m_count_label:null,m_bonus_icon:null,m_callback:null,m_list_bg:null,m_complete_btn_mask:null,m_complete_mask:null,m_btn_sprites:[],ctor:function(_callback){this._super(),this.m_btn_sprites=[],this.init(_callback)},init:function(_callback){this.m_callback=_callback,this.m_list_bg=new cc.Scale9Sprite(RES_CDN_DEFULT+"menu_yh/img_yh_info_box.png",RectZero()),this.m_list_bg.setAnchorPoint(ZERO()),this.m_list_bg.setPosition(ZERO()),this.m_list_bg.setContentSize(cc.size(924,94)),this.addChild(this.m_list_bg),this.setContentSize(ccSize(this.m_list_bg)),this.m_name_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_2013),this.m_name_label.setAnchorPoint(ZERO()),this.m_name_label.setPosition(80,59),this.m_list_bg.addChild(this.m_name_label),this.m_reward_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_1810),this.m_reward_label.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),this.m_reward_label.setPosition(790,59),this.m_list_bg.addChild(this.m_reward_label),this.m_content=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_181),this.m_content.setAnchorPoint(ZERO()),this.m_content.setPosition(80,33),this.m_list_bg.addChild(this.m_content);var gauge_bg=new cc.Scale9Sprite(RES_CDN_DEFULT+"common/img_9p_gauge_frame.png",cc.Rect(0,0,0,0));gauge_bg.setAnchorPoint(ZERO()),gauge_bg.setPosition(4,5),gauge_bg.setContentSize(cc.size(916,16)),this.m_list_bg.addChild(gauge_bg),this.m_gauge=cc.Sprite.create(RES_CDN_DEFULT+"common/img_9p_gauge_green.png"),this.m_gauge.setAnchorPoint(ANCHOR_MIDDLE_LEFT()),this.m_gauge.setPosition(3,ccCenter(gauge_bg).y),gauge_bg.addChild(this.m_gauge),this.m_count_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_143),this.m_count_label.setAnchorPoint(ANCHOR_MIDDLE()),this.m_count_label.setPosition(ccCenter(gauge_bg)),this.m_count_label.enableOutline(cc.color.BLACK,1),gauge_bg.addChild(this.m_count_label);var bonus_bg=cc.Sprite.create(RES_CDN_DEFULT+"icon/img_icon_frame.png");bonus_bg.setAnchorPoint(ZERO()),bonus_bg.setPosition(4,21),this.m_list_bg.addChild(bonus_bg),this.m_bonus_icon=cc.Sprite.create(),this.m_bonus_icon.setAnchorPoint(ANCHOR_MIDDLE()),this.m_bonus_icon.setPosition(ccCenter(bonus_bg)),bonus_bg.addChild(this.m_bonus_icon),this.m_complete_btn_mask=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_normal.png",RectZero()),this.m_complete_btn_mask.setAnchorPoint(ZERO()),this.m_complete_btn_mask.setPosition(ZERO()),this.m_complete_btn_mask.setContentSize(cc.size(924,94)),this.m_list_bg.addChild(this.m_complete_btn_mask),this.m_complete_btn_mask.setVisible(!1),this.m_complete_mask=cc.Sprite.create(RES_CDN_DEFULT+"menu_achievement/img_achievement_complete.png"),this.m_complete_mask.setAnchorPoint(ANCHOR_MIDDLE()),this.m_complete_mask.setPosition(ccCenter(this.m_list_bg)),this.m_complete_mask.setVisible(!1),this.m_list_bg.addChild(this.m_complete_mask);var nor=cc.Sprite.create("#btn_05_off.png");nor.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),nor.setPosition(ccWidth(this.m_list_bg)-13,30);var nor_label=cmLabel.getLabel("報酬受取",LABEL_FONT_INDEX.FONT_241);nor_label.setAnchorPoint(ANCHOR_MIDDLE()),nor_label.setPosition(ccCenter(nor)),nor.addChild(nor_label),this.m_list_bg.addChild(nor),this.m_btn_sprites.push(nor);var on=cc.Sprite.create("#btn_05_on.png");on.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),on.setPosition(ccWidth(this.m_list_bg)-13,30);var on_label=cmLabel.getLabel("報酬受取",LABEL_FONT_INDEX.FONT_242);on_label.setAnchorPoint(ANCHOR_MIDDLE()),on_label.setPosition(ccCenter(on)),on.addChild(on_label),this.m_list_bg.addChild(on),on.setVisible(!1),this.m_btn_sprites.push(on);var none=cc.Sprite.create("#btn_04_none.png");none.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),none.setPosition(ccWidth(this.m_list_bg)-13,30);var none_label=cmLabel.getLabel("報酬受取",LABEL_FONT_INDEX.FONT_242);return none_label.setAnchorPoint(ANCHOR_MIDDLE()),none_label.setPosition(ccCenter(none)),none.addChild(none_label),this.m_list_bg.addChild(none),none.setVisible(!1),this.m_btn_sprites.push(none),!0},setUserAchievement:function(achieve){this.m_achieve=achieve,this.updateLayout()},updateLayout:function(){var m=MasterManager.getInstance();if(this.m_name_label.setString(this.m_achieve.achv_name),this.m_achieve.bonus_type==BONUS_TYPE_YUNHEE_FIX){var gnrl=m.get_General(this.m_achieve.key_id);this.m_reward_label.setString(cmString("報酬:%s%s",gnrl.name,Number(this.m_achieve.bonus_count).toLocaleString("en")))}else this.m_reward_label.setString(cmString("報酬:%s%s",this.m_achieve.bonus_name,Number(this.m_achieve.bonus_count).toLocaleString("en")));this.m_content.setString(this.m_achieve.content);var complete_count=this.m_achieve.complete_count;if(this.m_achieve.count<complete_count&&(complete_count=this.m_achieve.count),0==this.m_achieve.count)this.m_gauge.setScaleX(0);else{var _gauge=complete_count/this.m_achieve.count;_gauge*=910,this.m_gauge.setScaleX(_gauge)}if(this.m_count_label.setString(cmString("%d/%d",this.m_achieve.complete_count,this.m_achieve.count)),this.m_achieve.bonus_type==BONUS_TYPE_YUNHEE_FIX||this.m_achieve.bonus_type==BONUS_TYPE_JIN_FIX){var general=m.get_General(this.m_achieve.key_id),card_img="";if(""!=(card_img=general.gnrl_type==GENERAL_TYPE_MATERIAL||general.gnrl_type==GENERAL_TYPE_EVOLVE_MATERIAL?"#"+general.bone_id+".png":"#"+general.gnrl_id+".png"))resourceLoader(card_img,function(){if(general.gnrl_type==GENERAL_TYPE_MATERIAL||general.gnrl_type==GENERAL_TYPE_EVOLVE_MATERIAL){var frame=cc.spriteFrameCache.getSpriteFrame(general.bone_id+".png");this.m_bonus_icon.setSpriteFrame(frame)}else{frame=cc.spriteFrameCache.getSpriteFrame(general.gnrl_id+".png");this.m_bonus_icon.setSpriteFrame(frame)}}.bind(this));else if(general.gnrl_type==GENERAL_TYPE_MATERIAL||general.gnrl_type==GENERAL_TYPE_EVOLVE_MATERIAL){var frame=cc.spriteFrameCache.getSpriteFrame(general.bone_id+".png");this.m_bonus_icon.setSpriteFrame(frame)}else{frame=cc.spriteFrameCache.getSpriteFrame(general.gnrl_id+".png");this.m_bonus_icon.setSpriteFrame(frame)}}else if(this.m_achieve.bonus_type<=BONUS_TYPE_SSR_RARE_TYPE_SELECT||this.m_achieve.bonus_type>=BONUS_TYPE_HWANDAN_1&&this.m_achieve.bonus_type<=BONUS_TYPE_HWANDAN_6||this.m_achieve.bonus_type>=BONUS_TYPE_EVENT_POINT){frame=cc.spriteFrameCache.getSpriteFrame("img_reward_"+leadingZeros(this.m_achieve.bonus_type,2)+".png");this.m_bonus_icon.setSpriteFrame(frame)}else{frame=cc.spriteFrameCache.getSpriteFrame("img_reward_yh.png");this.m_bonus_icon.setSpriteFrame(frame)}"y"!=this.m_achieve.complete_yn?(this.m_btn_sprites[0].setVisible(!1),this.m_btn_sprites[1].setVisible(!1),this.m_btn_sprites[2].setVisible(!0),this.m_complete_btn_mask.setVisible(!1)):(this.m_btn_sprites[0].setVisible(!0),this.m_btn_sprites[1].setVisible(!1),this.m_btn_sprites[2].setVisible(!1),this.m_complete_btn_mask.setVisible(!0)),this.m_complete_mask.setVisible(!1),this.m_achieve.achv_type!=ACHIEVEMENT_EVENTDUNGEON&&"y"==this.m_achieve.bonus_complete_yn?(this.m_btn_sprites[0].setVisible(!1),this.m_btn_sprites[1].setVisible(!1),this.m_btn_sprites[2].setVisible(!0),this.m_complete_mask.setVisible(!0),this.m_complete_btn_mask.setVisible(!0)):(this.m_complete_mask.setVisible(!1),this.m_complete_btn_mask.setVisible(!1))},highlightPosInCell:function(pos){var r=this.m_btn_sprites[0].getBoundingBox();cc.rectContainsPoint(r,pos)&&(this.m_achieve.achv_type!=ACHIEVEMENT_EVENTDUNGEON?"y"==this.m_achieve.complete_yn&&"n"==this.m_achieve.bonus_complete_yn?(this.m_btn_sprites[0].setVisible(!1),this.m_btn_sprites[1].setVisible(!0),this.m_btn_sprites[2].setVisible(!1)):(this.m_btn_sprites[0].setVisible(!1),this.m_btn_sprites[1].setVisible(!1),this.m_btn_sprites[2].setVisible(!0)):"y"==this.m_achieve.complete_yn?(this.m_btn_sprites[0].setVisible(!1),this.m_btn_sprites[1].setVisible(!0),this.m_btn_sprites[2].setVisible(!1)):(this.m_btn_sprites[0].setVisible(!1),this.m_btn_sprites[1].setVisible(!1),this.m_btn_sprites[2].setVisible(!0)))},unhighlightPosInCell:function(pos){var r=this.m_btn_sprites[0].getBoundingBox();cc.rectContainsPoint(r,pos)&&(this.m_achieve.achv_type!=ACHIEVEMENT_EVENTDUNGEON?"y"==this.m_achieve.complete_yn&&"n"==this.m_achieve.bonus_complete_yn?(this.m_btn_sprites[0].setVisible(!0),this.m_btn_sprites[1].setVisible(!1),this.m_btn_sprites[2].setVisible(!1)):(this.m_btn_sprites[0].setVisible(!1),this.m_btn_sprites[1].setVisible(!1),this.m_btn_sprites[2].setVisible(!0)):"y"==this.m_achieve.complete_yn?(this.m_btn_sprites[0].setVisible(!0),this.m_btn_sprites[1].setVisible(!1),this.m_btn_sprites[2].setVisible(!1)):(this.m_btn_sprites[0].setVisible(!1),this.m_btn_sprites[1].setVisible(!1),this.m_btn_sprites[2].setVisible(!0)))},touchPosInCell:function(pos){var r=this.m_btn_sprites[0].getBoundingBox();cc.rectContainsPoint(r,pos)&&(this.m_achieve.achv_type!=ACHIEVEMENT_EVENTDUNGEON?"y"==this.m_achieve.complete_yn&&"n"==this.m_achieve.bonus_complete_yn?(this.m_btn_sprites[0].setVisible(!0),this.m_btn_sprites[1].setVisible(!1),null!=this.m_callback&&this.m_callback(this.m_achieve,this.getIdx())):(this.m_btn_sprites[0].setVisible(!1),this.m_btn_sprites[1].setVisible(!1),this.m_btn_sprites[2].setVisible(!0)):"y"==this.m_achieve.complete_yn?(this.m_btn_sprites[0].setVisible(!0),this.m_btn_sprites[1].setVisible(!1),null!=this.m_callback&&this.m_callback(this.m_achieve,this.getIdx())):(this.m_btn_sprites[0].setVisible(!1),this.m_btn_sprites[1].setVisible(!1),this.m_btn_sprites[2].setVisible(!0)))}}),SUBTRACT_END_DATE=259200,EventDungeonAchievementLayer=cc.Layer.extend({m_tableView:null,m_bgBoxLayer:null,m_tap_day:null,m_tap_event:null,m_tap_event_2nd:null,m_day_new:null,m_event_new:null,m_event_2nd_new:null,m_info_icon:null,m_info_text:null,m_eventPeriodId:0,m_user_achv_list:[],m_all_bonus_btn:null,m_all_achv_reward:!1,ctor:function(){this.m_user_achv_list=[],this._super(),this.init()},init:function(){return!0},setAchivementList:function(list){this.m_user_achv_list=list,this.m_user_achv_list=stable(this.m_user_achv_list,function(l,r){return l.complete_yn<r.complete_yn}),this.m_user_achv_list=stable(this.m_user_achv_list,function(l,r){return l.bonus_complete_yn<r.bonus_complete_yn}),this.m_all_achv_reward=!1;for(var idx=0;idx<this.m_user_achv_list.length;idx++){var achv_list=this.m_user_achv_list[idx];if("y"==achv_list.complete_yn&&"n"==achv_list.bonus_complete_yn)return void(this.m_all_achv_reward=!0)}},setAchvEventPeriod:function(period_id){this.m_eventPeriodId=period_id},initLayout:function(){this.m_bgBoxLayer=this.getAchieveBoxLayer(),this.m_bgBoxLayer.ignoreAnchorPointForPosition(!1),this.m_bgBoxLayer.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_bgBoxLayer.setPosition(ccCenter(this).x,0),this.addChild(this.m_bgBoxLayer)},getAchieveBoxLayer:function(){var m=MasterManager.getInstance(),service=EventDungeonService.getInstance(),layer=new cc.Layer,tap_index=GameContext.getInstance().getAchievementTap();this.m_tap_day=new LabelButton("btn_07_none.png","btn_07_on.png","btn_07_off.png",ccui.Widget.PLIST_TEXTURE),this.m_tap_day.setFont(LABEL_FONT_INDEX.FONT_241),this.m_tap_day.setString("デイリー"),this.m_tap_day.setAnchorPoint(ZERO()),this.m_tap_day.setPosition(17,508),this.m_tap_day.addClickEventListener(function(sender){MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonAchievementScene],ACHIEVEMENT_EVENTDUNGEON_DAILY)}.bind(this)),layer.addChild(this.m_tap_day),this.m_day_new=cc.Sprite.create(RES_CDN_DEFULT+"common/ic_new.png"),this.m_day_new.setAnchorPoint(ANCHOR_MIDDLE()),this.m_day_new.setPosition(ccWidth(this.m_tap_day)-15,ccHeight(this.m_tap_day)-7),this.m_day_new.setVisible(!1),this.m_tap_day.addChild(this.m_day_new),this.m_tap_event=new LabelButton("btn_07_none.png","btn_07_on.png","btn_07_off.png",ccui.Widget.PLIST_TEXTURE),this.m_tap_event.setFont(LABEL_FONT_INDEX.FONT_241),this.m_tap_event.setString("前半"),this.m_tap_event.setAnchorPoint(ZERO()),this.m_tap_event.setPosition(17,508),this.m_tap_event.addClickEventListener(function(sender){MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonAchievementScene],ACHIEVEMENT_EVENTDUNGEON)}.bind(this)),layer.addChild(this.m_tap_event),this.m_event_new=cc.Sprite.create(RES_CDN_DEFULT+"common/ic_new.png"),this.m_event_new.setAnchorPoint(ANCHOR_MIDDLE()),this.m_event_new.setPosition(ccWidth(this.m_tap_event)-15,ccHeight(this.m_tap_event)-7),this.m_event_new.setVisible(!1),this.m_tap_event.addChild(this.m_event_new);var is_event_2nd=!1,p=m.get_EventDungeonPeriod(this.m_eventPeriodId),second_period_idx=(service.getEventDungeonFirstHalfPeriodIdx(p.event_dungeon_group_idx),service.getEventDungeonSecondHalfPeriodIdx(p.event_dungeon_group_idx));(service.IsOpenDungeon(second_period_idx)&&(is_event_2nd=!0),1==is_event_2nd)?(this.m_tap_event_2nd=new LabelButton("btn_07_none.png","btn_07_on.png","btn_07_off.png",ccui.Widget.PLIST_TEXTURE),this.m_tap_event_2nd.setFont(LABEL_FONT_INDEX.FONT_241),3==MasterTable.getInstance().get_EventDungeonPeriodList(p.event_dungeon_group_idx).length?this.m_tap_event_2nd.setString(res_str("btn_label_event_achievement_2nd")):this.m_tap_event_2nd.setString(res_str("btn_label_event_achievement_3rd")),this.m_tap_event_2nd.setAnchorPoint(ZERO()),this.m_tap_event_2nd.setPosition(ccPosX(this.m_tap_event)+ccWidth(this.m_tap_event),ccPosY(this.m_tap_event)),this.m_tap_event_2nd.addClickEventListener(function(sender){MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonAchievementScene],ACHIEVEMENT_EVENTDUNGEON_2ND)}.bind(this)),layer.addChild(this.m_tap_event_2nd),this.m_event_2nd_new=cc.Sprite.create(RES_CDN_DEFULT+"common/ic_new.png"),this.m_event_2nd_new.setAnchorPoint(ANCHOR_MIDDLE()),this.m_event_2nd_new.setPosition(ccWidth(this.m_tap_event_2nd)-15,ccHeight(this.m_tap_event_2nd)-7),this.m_event_2nd_new.setVisible(!1),this.m_tap_event_2nd.addChild(this.m_event_2nd_new)):this.m_tap_event.setString(res_str("btn_label_event_achievement"));this.m_tap_day.setVisible(!1),tap_index==ACHIEVEMENT_EVENTDUNGEON_DAILY?this.m_tap_day.setEnabled(!1):tap_index==ACHIEVEMENT_EVENTDUNGEON?this.m_tap_event.setEnabled(!1):tap_index==ACHIEVEMENT_EVENTDUNGEON_2ND?null!=this.m_tap_event_2nd&&this.m_tap_event_2nd.setEnabled(!1):tap_index==ACHIEVEMENT_EVENTDUNGEON_3RD&&null!=this.m_tap_event_3rd&&this.m_tap_event_3rd.setEnabled(!1);var bg_box=cc.Sprite.create(RES_CDN_DEFULT+"common/img_box_01.png");bg_box.setAnchorPoint(ZERO()),bg_box.setPosition(ZERO()),layer.addChild(bg_box),layer.setContentSize(ccSize(bg_box)),this.m_tableView=new cc.TableView(this,cc.size(924,432)),this.m_tableView.setDirection(cc.SCROLLVIEW_DIRECTION_VERTICAL),this.m_tableView.setVerticalFillOrder(0),this.m_tableView.scrollBarEnable(!0),this.m_tableView.setPosition(17,58),layer.addChild(this.m_tableView),this.m_tableView.setDelegate(this),this.m_tableView.reloadData(),this.setTapNewIcon(),this.m_info_icon=cc.Sprite.create(res.m_info_icon),this.m_info_icon.setAnchorPoint(ZERO()),tap_index==ACHIEVEMENT_EVENTDUNGEON_DAILY?this.m_info_icon.setPosition(361,17):tap_index!=ACHIEVEMENT_EVENTDUNGEON&&tap_index!=ACHIEVEMENT_EVENTDUNGEON_2ND&&tap_index!=ACHIEVEMENT_EVENTDUNGEON_3RD||this.m_info_icon.setPosition(311,17),layer.addChild(this.m_info_icon);var info_text=this.getEventEndDateString();return this.m_info_text=cmLabel.getLabel(info_text,LABEL_FONT_INDEX.FONT_1613),this.m_info_text.setAnchorPoint(ZERO()),this.m_info_text.setPosition(this.m_info_icon.x+ccWidth(this.m_info_icon),24),layer.addChild(this.m_info_text),this.m_all_bonus_btn=new LabelButton("btn_11_off.png","btn_11_on.png","btn_11_none.png",ccui.Widget.PLIST_TEXTURE),this.m_all_bonus_btn.setFont(LABEL_FONT_INDEX.FONT_201),this.m_all_bonus_btn.setString(res_str("btn_label_all_accept")),this.m_all_bonus_btn.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),this.m_all_bonus_btn.setPosition(ccWidth(bg_box)-17,18),this.m_all_bonus_btn.addClickEventListener(function(){0==EVENT_ACHIEVEMENT_BTN&&(EVENT_ACHIEVEMENT_BTN=!0,this.sendRewardAllAchievement())}.bind(this)),this.m_all_bonus_btn.setEnabled(this.m_all_achv_reward),layer.addChild(this.m_all_bonus_btn),layer},setTapNewIcon:function(){var achv_service=AchievementService.getInstance(),mt=MasterManager.getInstance(),edService=EventDungeonService.getInstance(),event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx(),period=mt.get_EventDungeonPeriod(event_dungeon_period_idx),first_half_event_dungeon_period_idx=edService.getEventDungeonFirstHalfPeriodIdx(period.event_dungeon_group_idx),middle_event_dungeon_period_idx=0;middle_event_dungeon_period_idx=3==achv_service.getEventDungeonGroupPeriodCount(event_dungeon_period_idx)?edService.getEventDungeonMiddleHalfPeriodIdx(period.event_dungeon_group_idx):edService.getEventDungeonSecondHalfPeriodIdx(period.event_dungeon_group_idx);var second_half_event_dungeon_period_idx=edService.getEventDungeonSecondHalfPeriodIdx(period.event_dungeon_group_idx),day_count=achv_service.getUserAchievementCompleteCount(ACHIEVEMENT_EVENTDUNGEON_DAILY),event_count=achv_service.getUserAchievementCompleteCount(ACHIEVEMENT_EVENTDUNGEON,first_half_event_dungeon_period_idx),event_2nd_count=achv_service.getUserAchievementCompleteCount(ACHIEVEMENT_EVENTDUNGEON_2ND,middle_event_dungeon_period_idx),event_3rd_count=achv_service.getUserAchievementCompleteCount(ACHIEVEMENT_EVENTDUNGEON_3RD,second_half_event_dungeon_period_idx);0!=day_count?this.m_day_new.setVisible(!0):this.m_day_new.setVisible(!1),0!=event_count?this.m_event_new.setVisible(!0):this.m_event_new.setVisible(!1),null!=this.m_event_2nd_new&&(0!=event_2nd_count?this.m_event_2nd_new.setVisible(!0):this.m_event_2nd_new.setVisible(!1)),null!=this.m_event_3rd_new&&(0!=event_3rd_count?this.m_event_3rd_new.setVisible(!0):this.m_event_3rd_new.setVisible(!1))},changeTapMenu:function(index,reload){switch(null!=this.m_tap_day&&this.m_tap_day.setEnabled(!0),null!=this.m_tap_event&&this.m_tap_event.setEnabled(!0),null!=this.m_tap_event_2nd&&this.m_tap_event_2nd.setEnabled(!0),null!=this.m_tap_event_3rd&&this.m_tap_event_3rd.setEnabled(!0),index){case ACHIEVEMENT_EVENTDUNGEON_DAILY:this.m_tap_day.setEnabled(!1),this.m_info_icon.setPosition(361,17),this.m_info_text.setPosition(cc.p(this.m_info_icon).x+ccWidth(this.m_info_icon),24),this.m_info_text.setString("毎日午前４時に更新されます。");break;case ACHIEVEMENT_EVENTDUNGEON:var info_text=this.getEventEndDateString();this.m_tap_event.setEnabled(!1),this.m_info_icon.setPosition(311,17),this.m_info_text.setPosition(cc.p(this.m_info_icon).x+ccWidth(this.m_info_icon),24),this.m_info_text.setString(info_text);break;case ACHIEVEMENT_EVENTDUNGEON_2ND:if(null!=this.m_tap_event_2nd){info_text=this.getEventEndDateString();this.m_tap_event_2nd.setEnabled(!1),this.m_info_icon.setPosition(311,17),this.m_info_text.setPosition(ccPosX(this.m_info_icon)+ccWidth(this.m_info_icon),24),this.m_info_text.setString(info_text)}break;case ACHIEVEMENT_EVENTDUNGEON_3RD:if(null!=this.m_tap_event_3rd){info_text=this.getEventEndDateString();this.m_tap_event_3rd.setEnabled(!1),this.m_info_icon.setPosition(311,17),this.m_info_text.setPosition(ccPosX(this.m_info_icon)+ccWidth(this.m_info_icon),24),this.m_info_text.setString(info_text)}}this.m_tableView.reloadData(),this.setTapNewIcon(),this.m_all_bonus_btn.setEnabled(this.m_all_achv_reward)},cellSizeForTable:function(table){return cc.size(924,94)},tableCellSizeForIndex:function(){return cc.size(924,94)},tableCellAtIndex:function(table,idx){var c=table.dequeueCell(),cell=null;cell=null!=c?c:new EventDungeonAchieveListItemCell(this.sendRewardAchievement.bind(this));var mail=this.m_user_achv_list[idx];return cell.setUserAchievement(mail),cell},tableCellEnded:function(){},numberOfCellsInTableView:function(table){return this.m_user_achv_list.length},sendRewardAchievement:function(user_achiv){this.getParent().initLayoutProgress(0),GameContext.getInstance().setSelectAchv(user_achiv),MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonAchievementScene],NOTIFY_ACHIEVEMENT_RECIEVE)},sendRewardAllAchievement:function(){GameContext.getInstance().setAllAchv(this.m_user_achv_list),MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonAchievementScene],NOTIFY_ACHIEVEMENT_ALL_RECIEVE)},tableCellTouched:function(table,cell){null!=cell&&cell.touchPosInCell(cell.getTouchPos())},tableCellHighlight:function(table,cell){null!=cell&&cell.highlightPosInCell(cell.getTouchPos())},tableCellUnhighlight:function(table,cell){null!=cell&&cell.unhighlightPosInCell(cell.getTouchPos())},setUserAchivList:function(){var pre_offset=cc.p(this.m_tableView.getContentOffset().x,this.m_tableView.getContentOffset().y);this.m_tableView.reloadData(),pre_offset.y>this.m_tableView.minContainerOffset().y&&this.m_tableView.setContentOffset(pre_offset),this.m_all_bonus_btn.setEnabled(this.m_all_achv_reward),this.setTapNewIcon()},getEventEndDateString:function(){var event_period_info=MasterManager.getInstance().get_EventDungeonPeriod(this.m_eventPeriodId),end_dt=moment(event_period_info.end_dt);return"※期間限定："+((end_dt=end_dt.add(-SUBTRACT_END_DATE,"s")).get("month")+1)+"月"+end_dt.get("date")+"日メンテナンス前まで。"}}),EventDungeonAchievementScene=GameScene.extend({m_achievementLayer:null,ctor:function(){this._super(scene_EventDungeonAchievementScene)},init:function(){ccSize(this);this.bg=cc.Sprite.create(RES_CDN_DEFULT+"common/bg_sub.png"),this.bg.setPosition(ccCenter(this)),this.addChild(this.bg);var mt=MasterManager.getInstance(),achvService=AchievementService.getInstance(),edService=EventDungeonService.getInstance(),achv_list=[],achv_type=GameContext.getInstance().getAchievementTap();AchievementService.getInstance().loadUserAchievement();var context=BattleContext._getInstance(),event_dungeon_period_idx=0;event_dungeon_period_idx=context.getIsPrvEventDungeon()?context.getPrvEventDungeonPeriodIdx():context.getEventDungeonPeriodIdx();var period=mt.get_EventDungeonPeriod(event_dungeon_period_idx);if(0==event_dungeon_period_idx)achv_list=achvService.getUserAchievement(achv_type);else{if(achv_type==ACHIEVEMENT_EVENTDUNGEON)event_dungeon_period_idx=edService.getEventDungeonFirstHalfPeriodIdx(period.event_dungeon_group_idx);else if(achv_type==ACHIEVEMENT_EVENTDUNGEON_2ND){event_dungeon_period_idx=3==AchievementService.getInstance().getEventDungeonGroupPeriodCount(event_dungeon_period_idx)?edService.getEventDungeonMiddleHalfPeriodIdx(period.event_dungeon_group_idx):edService.getEventDungeonSecondHalfPeriodIdx(period.event_dungeon_group_idx)}else achv_type==ACHIEVEMENT_EVENTDUNGEON_3RD&&(event_dungeon_period_idx=edService.getEventDungeonSecondHalfPeriodIdx(period.event_dungeon_group_idx));achv_list=achvService.getUserAchievementEventDungeon(achv_type,event_dungeon_period_idx)}this.m_achievementLayer=new EventDungeonAchievementLayer,this.m_achievementLayer.setAchivementList(achv_list),this.m_achievementLayer.setAchvEventPeriod(event_dungeon_period_idx),this.m_achievementLayer.initLayout(),this.addChild(this.m_achievementLayer);var statusLayer=new StatusLayer;statusLayer.ignoreAnchorPointForPosition(!1),statusLayer.setAnchorPoint(ANCHOR_TOP_RIGHT()),statusLayer.setPosition(ccWidth(this),ccHeight(this)),this.addChild(statusLayer);var title=cc.Sprite.create(RES_CDN_DEFULT+"menu_achievement/img_achievement_text_achievement.png");title.setAnchorPoint(ZERO()),title.setPosition(90,585),this.addChild(title);var back_btn=new ccui.Button;return back_btn.loadTextures("btn_home_off.png","btn_home_on.png","",ccui.Widget.PLIST_TEXTURE),back_btn.setAnchorPoint(ZERO()),back_btn.setPosition(10,559),back_btn.addClickEventListener(function(){this.back()}.bind(this)),this.addChild(back_btn),!0},onNotification:function(msg){this._super(msg);var achvService=AchievementService.getInstance(),achv_list=[];switch(msg){case ACHIEVEMENT_EVENTDUNGEON_DAILY:case ACHIEVEMENT_EVENTDUNGEON:case ACHIEVEMENT_EVENTDUNGEON_2ND:case ACHIEVEMENT_EVENTDUNGEON_3RD:var edService=EventDungeonService.getInstance(),mt=MasterManager.getInstance(),achv_type=msg;GameContext.getInstance().setAchievementTap(msg);var event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx(),period=mt.get_EventDungeonPeriod(event_dungeon_period_idx);if(0==event_dungeon_period_idx)achv_list=achvService.getUserAchievement(achv_type);else{if(achv_type==ACHIEVEMENT_EVENTDUNGEON)event_dungeon_period_idx=edService.getEventDungeonFirstHalfPeriodIdx(period.event_dungeon_group_idx);else if(achv_type==ACHIEVEMENT_EVENTDUNGEON_2ND){event_dungeon_period_idx=3==AchievementService.getInstance().getEventDungeonGroupPeriodCount(event_dungeon_period_idx)?edService.getEventDungeonMiddleHalfPeriodIdx(period.event_dungeon_group_idx):edService.getEventDungeonSecondHalfPeriodIdx(period.event_dungeon_group_idx)}else achv_type==ACHIEVEMENT_EVENTDUNGEON_3RD&&(event_dungeon_period_idx=edService.getEventDungeonSecondHalfPeriodIdx(period.event_dungeon_group_idx));achv_list=achvService.getUserAchievementEventDungeon(achv_type,event_dungeon_period_idx)}this.m_achievementLayer.setAchivementList(achv_list),this.m_achievementLayer.setAchvEventPeriod(event_dungeon_period_idx),this.m_achievementLayer.changeTapMenu(achv_type);break;case NOTIFY_ACHIEVEMENT_RECIEVE:achv_type=GameContext.getInstance().getAchievementTap();this.sendPacketAchievementReceive();break;case NOTIFY_ACHIEVEMENT_ALL_RECIEVE:edService=EventDungeonService.getInstance(),mt=MasterManager.getInstance(),event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx(),period=mt.get_EventDungeonPeriod(event_dungeon_period_idx);if((achv_type=GameContext.getInstance().getAllAchv()[0].achv_type)==ACHIEVEMENT_EVENTDUNGEON)event_dungeon_period_idx=edService.getEventDungeonFirstHalfPeriodIdx(period.event_dungeon_group_idx);else if(achv_type==ACHIEVEMENT_EVENTDUNGEON_2ND){event_dungeon_period_idx=3==AchievementService.getInstance().getEventDungeonGroupPeriodCount(event_dungeon_period_idx)?edService.getEventDungeonMiddleHalfPeriodIdx(period.event_dungeon_group_idx):edService.getEventDungeonSecondHalfPeriodIdx(period.event_dungeon_group_idx)}this.sendPacketAchievementReceiveAll(achv_type,event_dungeon_period_idx);break;default:return!1}return!0},onExit:function(){this._super(),MainObserver.getInstance().removeObserver(sceneStr[scene_EventDungeonAchievementScene])},onEnter:function(){this._super(),MainObserver.getInstance().addObserver(this.onNotification,this,sceneStr[scene_EventDungeonAchievementScene])},sendPacketAchievementReceive:function(){var user_achv=GameContext.getInstance().getSelectAchv(),res={};res.opcode=net.OP.op_user_achievement_bonus_receive,res.achv_id=user_achv.achv_id,this.network_write(res)},sendPacketAchievementReceiveAll:function(achv_type,event_dungeon_period_idx){var res={};res.opcode=net.OP.op_user_achievement_bonus_receive_all,res.achv_type=achv_type,res.event_dungeon_period_idx=event_dungeon_period_idx,this.network_write(res)},onNetworkEvent:function(opcode,state,body){if(this._super(opcode,state,body),opcode==net.OP.op_user_achievement_bonus_receive)this.removeLayerProgress(),body.error==net.ERROR.NET_E_SUCCESS?this.scheduleOnce(function(){var achv_type=GameContext.getInstance().getAchievementTap();AchievementService.getInstance().loadUserAchievement(achv_type);var achv_list=[],achvService=AchievementService.getInstance(),event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx();if(0==event_dungeon_period_idx)achv_list=achvService.getUserAchievement(achv_type);else{var achv_period=MasterManager.getInstance().get_AchivementEventDungeonInfo(body.achv_bonus.achv_id);achv_period.event_dungeon_period_idx!=event_dungeon_period_idx&&(event_dungeon_period_idx=achv_period.event_dungeon_period_idx),achv_list=achvService.getUserAchievementEventDungeon(achv_type,event_dungeon_period_idx)}this.m_achievementLayer.setAchivementList(achv_list),this.m_achievementLayer.setAchvEventPeriod(event_dungeon_period_idx),this.m_achievementLayer.setUserAchivList(),this.showNoticeRewardReceive(body.achv_bonus.bonus_type)},.5,"event_achieve"):(cc.log("op_user_achievement_bonus_receive error"+body.error),body.error==net.ERROR.NET_E_ALREADY_REWARD_RECEIVED||(body.error,net.ERROR.NET_E_ALREADY_RECEIVED_REWARD));else if(opcode==net.OP.op_user_achievement_bonus_receive_all)if(body.error==net.ERROR.NET_E_SUCCESS)this.scheduleOnce(function(){var achv_type=GameContext.getInstance().getAchievementTap(),achv_list=[],achvService=AchievementService.getInstance(),event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx();if(0==event_dungeon_period_idx)achv_list=achvService.getUserAchievement(achv_type);else if(0<body.achv_bonus_list.size()){var achv_period=MasterManager.getInstance().get_AchivementEventDungeonInfo(body.achv_bonus_list.at(0).achv_id);achv_period.event_dungeon_period_idx!=event_dungeon_period_idx&&(event_dungeon_period_idx=achv_period.event_dungeon_period_idx),achv_list=achvService.getUserAchievementEventDungeon(achv_type,event_dungeon_period_idx)}this.m_achievementLayer.setAchivementList(achv_list),this.m_achievementLayer.setAchvEventPeriod(event_dungeon_period_idx),this.m_achievementLayer.setUserAchivList(),0<body.achv_bonus_list.size()&&this.showNoticeRewardReceive(body.achv_bonus_list.at(0).bonus_type)}.bind(this),.5,"event_achieve_all");else if(cc.log("op_user_achievement_bonus_receive_all error"+body.error),body.error==net.ERROR.NET_E_ALREADY_REWARD_RECEIVED){EVENT_ACHIEVEMENT_BTN=!1;var msg=[];msg.push("Err"),this.showMsgBox(msg)}else body.error==net.ERROR.NET_E_ALREADY_RECEIVED_REWARD&&(EVENT_ACHIEVEMENT_BTN=!1)},back:function(){this.m_isPushScene?SceneManager.getInstance().popScene():this.onKeyBack(!0)}}),EventDungeonAchvListItemCell_V2=cc.TableViewCell.extend({m_callback:null,m_list_bg:null,m_complete_btn_mask:null,m_name_label:null,m_reward_label:null,m_content:null,m_count_label:null,m_gauge:null,m_bonus_icon:null,m_complete_mask:null,m_btn_sprites:[],ctor:function(_cb){this._super(),this.m_btn_sprites=[],this.init(_cb)},init:function(_cb){this.m_callback=_cb;var cellSize=cc.size(924,94);this.setContentSize(cellSize),this.m_list_bg=cc.Scale9Sprite.create(RES_CDN_DEFULT+"menu_yh/img_yh_info_box.png",RectZero()),this.m_list_bg.setAnchorPoint(ANCHOR_MIDDLE()),this.m_list_bg.setPosition(ccCenter(cellSize)),this.m_list_bg.setPreferredSize(cellSize),this.addChild(this.m_list_bg),this.setContentSize(ccSize(this.m_list_bg)),cellSize=null,this.m_name_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_2013),this.m_name_label.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),this.m_name_label.setPosition(80,59),this.m_list_bg.addChild(this.m_name_label),this.m_reward_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_1810),this.m_reward_label.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),this.m_reward_label.setPosition(790,59),this.m_list_bg.addChild(this.m_reward_label),this.m_content=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_181),this.m_content.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),this.m_content.setPosition(80,33),this.m_list_bg.addChild(this.m_content);var gauge_bg=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_gauge_frame.png",RectZero());gauge_bg.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),gauge_bg.setPosition(4,5),gauge_bg.setContentSize(916,16),this.m_list_bg.addChild(gauge_bg),this.m_gauge=cc.Sprite.create(RES_CDN_DEFULT+"common/img_9p_gauge_green.png"),this.m_gauge.setAnchorPoint(ANCHOR_MIDDLE_LEFT()),this.m_gauge.setPosition(3,ccCenter(gauge_bg).y),gauge_bg.addChild(this.m_gauge),this.m_count_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_143),this.m_count_label.setAnchorPoint(ANCHOR_MIDDLE()),this.m_count_label.setPosition(ccCenter(gauge_bg)),this.m_count_label.enableOutline(cc.color.BLACK,1),gauge_bg.addChild(this.m_count_label);var bonus_bg=cc.Sprite.create(RES_CDN_DEFULT+"icon/img_icon_frame.png");bonus_bg.setAnchorPoint(ZERO()),bonus_bg.setPosition(4,21),this.m_list_bg.addChild(bonus_bg),this.m_bonus_icon=new cc.Sprite,this.m_bonus_icon.setAnchorPoint(ANCHOR_MIDDLE()),this.m_bonus_icon.setPosition(ccCenter(bonus_bg)),bonus_bg.addChild(this.m_bonus_icon),this.m_complete_btn_mask=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_normal.png",RectZero()),this.m_complete_btn_mask.setAnchorPoint(ZERO()),this.m_complete_btn_mask.setPosition(ZERO()),this.m_complete_btn_mask.setContentSize(924,94),this.m_list_bg.addChild(this.m_complete_btn_mask),this.m_complete_btn_mask.setVisible(!1),this.m_complete_mask=cc.Sprite.create(RES_CDN_DEFULT+"menu_achievement/img_achievement_complete.png"),this.m_complete_mask.setAnchorPoint(ANCHOR_MIDDLE()),this.m_complete_mask.setPosition(ccCenter(this.m_list_bg)),this.m_complete_mask.setVisible(!1),this.m_list_bg.addChild(this.m_complete_mask);var nor=cc.Sprite.create("#btn_05_off.png");nor.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),nor.setPosition(ccWidth(this.m_list_bg)-13,30);var nor_label=cmLabel.getLabel("報酬受取",LABEL_FONT_INDEX.FONT_241);nor_label.setAnchorPoint(ANCHOR_MIDDLE()),nor_label.setPosition(ccCenter(nor)),nor.addChild(nor_label),this.m_list_bg.addChild(nor),this.m_btn_sprites.push(nor);var on=cc.Sprite.create("#btn_05_on.png");on.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),on.setPosition(ccWidth(this.m_list_bg)-13,30);var on_label=cmLabel.getLabel("報酬受取",LABEL_FONT_INDEX.FONT_242);on_label.setAnchorPoint(ANCHOR_MIDDLE()),on_label.setPosition(ccCenter(on)),on.addChild(on_label),this.m_list_bg.addChild(on),on.setVisible(!1),this.m_btn_sprites.push(on);var none=cc.Sprite.create("#btn_04_none.png");none.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),none.setPosition(ccWidth(this.m_list_bg)-13,30);var none_label=cmLabel.getLabel("報酬受取",LABEL_FONT_INDEX.FONT_242);return none_label.setAnchorPoint(ANCHOR_MIDDLE()),none_label.setPosition(ccCenter(none)),none.addChild(none_label),this.m_list_bg.addChild(none),none.setVisible(!1),this.m_btn_sprites.push(none),!0},setUserEventDungeonAchvData:function(achv){this.m_data=achv,this.updateLayout()},updateLayout:function(){var m=MasterManager.getInstance();this.m_name_label.setString(this.m_data.event_achv.name);var first_reward=this.m_data.rewards[0];if(first_reward.bonus_type==BONUS_TYPE_YUNHEE_FIX){var gnrl=m.get_General(first_reward.min_value);this.m_reward_label.setString(cmString("報酬:%sx%s",gnrl.name,Number(first_reward.max_value).toLocaleString("en")))}else{var bonus=m.get_BonusType(first_reward.bonus_type);this.m_reward_label.setString(cmString("報酬:%sx%s",bonus.name,Number(first_reward.min_value).toLocaleString("en")))}this.m_content.setString(cmString(this.m_data.event_achv.content,this.m_data.achv.complete_count));var complete_count=this.m_data.complete_count;if(this.m_data.achv.complete_count<complete_count&&(complete_count=this.m_data.achv.complete_count),0==this.m_data.achv.complete_count)this.m_gauge.setScaleX(0);else{var per=complete_count/this.m_data.achv.complete_count;per*=910,this.m_gauge.setScaleX(per)}if(this.m_count_label.setString(cmString("%d/%d",this.m_data.complete_count,this.m_data.achv.complete_count)),first_reward.bonus_type==BONUS_TYPE_YUNHEE_FIX){var g=m.get_General(first_reward.min_value);if(g.gnrl_type==GENERAL_TYPE_MATERIAL||g.gnrl_type==GENERAL_TYPE_EVOLVE_MATERIAL)if(1==USE_SP_TUBM_SUM){var frame=cc.spriteFrameCache.getSpriteFrame("m_"+g.bone_id+".png");this.m_bonus_icon.setSpriteFrame(frame),1==USE_SP_TUMB_SCALE&&this.m_bonus_icon.setScale(DEF_TUMB_SCALE)}else{frame=cc.spriteFrameCache.getSpriteFrame(g.bone_id+".png");this.m_bonus_icon.setSpriteFrame(frame)}else if(1==USE_SP_TUBM_SUM){frame=cc.spriteFrameCache.getSpriteFrame("m_"+g.gnrl_id+".png");this.m_bonus_icon.setSpriteFrame(frame),1==USE_SP_TUMB_SCALE&&this.m_bonus_icon.setScale(DEF_TUMB_SCALE)}else{frame=cc.spriteFrameCache.getSpriteFrame(g.gnrl_id+".png");this.m_bonus_icon.setSpriteFrame(frame)}}else{frame=cc.spriteFrameCache.getSpriteFrame("img_reward_"+leadingZeros(first_reward.bonus_type,2)+".png");this.m_bonus_icon.setSpriteFrame(frame),1==USE_SP_TUBM_SUM&&this.m_bonus_icon.setScale(1)}this.m_data.is_complete?this.m_data.is_bonus_complete?(this.m_btn_sprites[0].setVisible(!1),this.m_btn_sprites[1].setVisible(!1),this.m_btn_sprites[2].setVisible(!0),this.m_complete_btn_mask.setVisible(!0),this.m_complete_mask.setVisible(!0)):(this.m_btn_sprites[0].setVisible(!0),this.m_btn_sprites[1].setVisible(!1),this.m_btn_sprites[2].setVisible(!1),this.m_complete_btn_mask.setVisible(!1),this.m_complete_mask.setVisible(!1)):(this.m_btn_sprites[0].setVisible(!1),this.m_btn_sprites[1].setVisible(!1),this.m_btn_sprites[2].setVisible(!0),this.m_complete_btn_mask.setVisible(!1),this.m_complete_mask.setVisible(!1))},highlightPosInCell:function(pos){var r=this.m_btn_sprites[0].getBoundingBox();cc.rectContainsPoint(r,pos)&&(this.m_data.is_complete?this.m_data.is_bonus_complete?(this.m_btn_sprites[0].setVisible(!1),this.m_btn_sprites[1].setVisible(!1),this.m_btn_sprites[2].setVisible(!0)):(this.m_btn_sprites[0].setVisible(!1),this.m_btn_sprites[1].setVisible(!0),this.m_btn_sprites[2].setVisible(!1)):(this.m_btn_sprites[0].setVisible(!1),this.m_btn_sprites[1].setVisible(!1),this.m_btn_sprites[2].setVisible(!0)))},unhighlightPosInCell:function(pos){var r=this.m_btn_sprites[0].getBoundingBox();cc.rectContainsPoint(r,pos)&&(this.m_data.is_complete?this.m_data.is_bonus_complete?(this.m_btn_sprites[0].setVisible(!1),this.m_btn_sprites[1].setVisible(!1),this.m_btn_sprites[2].setVisible(!0)):(this.m_btn_sprites[0].setVisible(!0),this.m_btn_sprites[1].setVisible(!1),this.m_btn_sprites[2].setVisible(!1)):(this.m_btn_sprites[0].setVisible(!1),this.m_btn_sprites[1].setVisible(!1),this.m_btn_sprites[2].setVisible(!0)))},touchPosInCell:function(pos){var r=this.m_btn_sprites[0].getBoundingBox();cc.rectContainsPoint(r,pos)&&this.m_data.is_complete&&!this.m_data.is_bonus_complete&&null!=this.m_callback&&this.m_callback(this.m_data)}}),TAB_NEW_ICON_TAG=98373,EventDungeonAchievementLayer_V2=(SUBTRACT_END_DATE=259200,cc.Layer.extend({m_tableView:null,m_current_event_dungeon_period_idx:0,m_all_bonus_btn:null,m_achv_list:[],m_tab_btns:[],ctor:function(){this._super(),this.m_achv_list=[],this.m_tab_btns=[],this.init()},init:function(){var winSize=ccSize(this),context=BattleContext._getInstance(),m=MasterManager.getInstance(),service=EventDungeonService.getInstance(),event_dungeon_period_idx=context.getEventDungeonPeriodIdx();this.m_period=m.get_EventDungeonPeriod(event_dungeon_period_idx);var first_period_idx=service.getEventDungeonFirstHalfPeriodIdx(this.m_period.event_dungeon_group_idx),second_period_idx=service.getEventDungeonSecondHalfPeriodIdx(this.m_period.event_dungeon_group_idx),bg_box=cc.Sprite.create(RES_CDN_DEFULT+"common/img_box_01.png");bg_box.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),bg_box.setPosition(.5*winSize.width,0),this.addChild(bg_box);var btn,new_icon,boxSize=ccSize(bg_box),is_second=service.IsOpenDungeon(second_period_idx),offset_x=17;((btn=new LabelButton("btn_07_none.png","btn_07_on.png","btn_07_off.png",ccui.Widget.PLIST_TEXTURE)).setAnchorPoint(ANCHOR_BOTTOM_LEFT()),btn.setFont(LABEL_FONT_INDEX.FONT_241),is_second?btn.setString(res_str("btn_label_event_achievement_1st")):btn.setString(res_str("btn_label_event_achievement")),btn.setPosition(offset_x,boxSize.height),btn.setTag(first_period_idx),bg_box.addChild(btn),btn.addClickEventListener(function(sender){this.changeTab(first_period_idx)}.bind(this)),(new_icon=cc.Sprite.create(RES_CDN_DEFULT+"common/ic_new.png")).setAnchorPoint(ANCHOR_MIDDLE()),new_icon.setPosition(ccWidth(btn)-15,ccHeight(btn)-7),new_icon.setTag(TAB_NEW_ICON_TAG),btn.addChild(new_icon),new_icon.setVisible(service.IsEnableGainEventDungeonAchvReward(first_period_idx)),this.m_tab_btns.push(btn),offset_x+=ccWidth(btn),service.IsOpenDungeon(second_period_idx))&&((btn=new LabelButton("btn_07_none.png","btn_07_on.png","btn_07_off.png",ccui.Widget.PLIST_TEXTURE)).setAnchorPoint(ANCHOR_BOTTOM_LEFT()),btn.setFont(LABEL_FONT_INDEX.FONT_241),btn.setString(res_str("btn_label_event_achievement_3rd")),btn.setPosition(offset_x,boxSize.height),btn.setTag(second_period_idx),bg_box.addChild(btn),btn.addClickEventListener(function(sender){this.changeTab(second_period_idx)}.bind(this)),(new_icon=cc.Sprite.create(RES_CDN_DEFULT+"common/ic_new.png")).setAnchorPoint(ANCHOR_MIDDLE()),new_icon.setPosition(ccWidth(btn)-15,ccHeight(btn)-7),new_icon.setTag(TAB_NEW_ICON_TAG),btn.addChild(new_icon),new_icon.setVisible(service.IsEnableGainEventDungeonAchvReward(second_period_idx)),this.m_tab_btns.push(btn));var tSize=cc.size(924,432);this.m_tableView=new cc.TableView(this,tSize),this.m_tableView.scrollBarEnable(!0),this.m_tableView.setDirection(cc.SCROLLVIEW_DIRECTION_VERTICAL),this.m_tableView.setVerticalFillOrder(cc.TABLEVIEW_FILL_TOPDOWN),this.m_tableView.setPosition(17,58),bg_box.addChild(this.m_tableView),this.m_tableView.setDelegate(this);var info_icon=cc.Sprite.create(RES_CDN_DEFULT+"menu_friend/img_friend_text.png");info_icon.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),info_icon.setPosition(311,17),bg_box.addChild(info_icon);var info_str=this.getEventEndDateString(),info_text=cmLabel.getLabel(info_str,LABEL_FONT_INDEX.FONT_1613);return info_text.setAnchorPoint(ZERO()),info_text.setPosition(ccPosX(info_icon)+ccWidth(info_icon),24),bg_box.addChild(info_text),this.m_all_bonus_btn=new LabelButton("btn_11_off.png","btn_11_on.png","btn_11_none.png",ccui.Widget.PLIST_TEXTURE),this.m_all_bonus_btn.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),this.m_all_bonus_btn.setPosition(boxSize.width-17,18),this.m_all_bonus_btn.setFont(LABEL_FONT_INDEX.FONT_201),this.m_all_bonus_btn.setString(res_str("btn_label_all_accept")),this.m_all_bonus_btn.addClickEventListener(function(sender){this.reqEventDungeonAchvRecvAll()}.bind(this)),bg_box.addChild(this.m_all_bonus_btn),this.changeTab(first_period_idx),!0},onEnter:function(){this._super()},onExit:function(){this._super()},cellSizeForTable:function(table){return cc.size(924,94)},tableCellSizeForIndex:function(){return cc.size(924,94)},numberOfCellsInTableView:function(table){return this.m_achv_list.length},tableCellAtIndex:function(table,idx){var c=table.dequeueCell(),cell=null;cell=null!=c?c:new EventDungeonAchvListItemCell_V2(this.choiceAchievement.bind(this));var data=this.m_achv_list[idx];return cell.setUserEventDungeonAchvData(data),cell},tableCellEnded:function(table){},scrollViewDidScroll:function(view){},scrollViewDidZoom:function(view){},tableCellTouched:function(table,cell){null!=cell&&cell.touchPosInCell(cell.getTouchPos())},tableCellHighlight:function(table,cell){null!=cell&&cell.highlightPosInCell(cell.getTouchPos())},tableCellUnhighlight:function(table,cell){null!=cell&&cell.unhighlightPosInCell(cell.getTouchPos())},choiceAchievement:function(data){data.is_complete&&(data.is_bonus_complete||this.reqEventDungeonAchvRecv(data))},reqEventDungeonAchvRecv:function(data){var req={};req.opcode=net.OP.op_user_event_dungeon_achv_bonus_recv,req.event_dungeon_achv_list_idx=data.event_dungeon_achv_list_idx,req.event_dungeon_period_idx=data.event_dungeon_period_idx,SceneManager.getInstance().getRunningScene().network_write(req)},reqEventDungeonAchvRecvAll:function(){if(0!=this.m_current_event_dungeon_period_idx){var req={};req.opcode=net.OP.op_user_event_dungeon_achv_bonus_recv_all,req.event_dungeon_period_idx=this.m_current_event_dungeon_period_idx,SceneManager.getInstance().getRunningScene().network_write(req)}},changeTab:function(event_dungeon_period_idx){for(var service=EventDungeonService.getInstance(),i=0;i<this.m_tab_btns.length;i++){var btn=this.m_tab_btns[i],tag=btn.getTag();if(btn.setEnabled(tag!=event_dungeon_period_idx),tag==event_dungeon_period_idx){var new_icon=btn.getChildByTag(TAB_NEW_ICON_TAG);null!=new_icon&&new_icon.setVisible(service.IsEnableGainEventDungeonAchvReward(event_dungeon_period_idx))}}this.m_current_event_dungeon_period_idx=event_dungeon_period_idx,this.m_achv_list=service.getUserEventDungeonAchvList(event_dungeon_period_idx),this.m_tableView.reloadData(),this.m_all_bonus_btn.setEnabled(service.IsEnableGainEventDungeonAchvReward(event_dungeon_period_idx))},getEventEndDateString:function(){var end_dt=moment(this.m_period.end_dt);return"※期間限定："+((end_dt=end_dt.add(-SUBTRACT_END_DATE,"s")).get("month")+1)+"月"+end_dt.get("date")+"日メンテナンス前まで。"},refreshEventDungeonAchvList:function(){this.changeTab(this.m_current_event_dungeon_period_idx)}})),EventDungeonAchievementScene_V2=GameScene.extend({m_achievementLayer:null,ctor:function(){this._super(scene_EventDungeonAchievementScene_V2)},init:function(){var bg=cc.Sprite.create(RES_CDN_DEFULT+"common/bg_sub.png");bg.setPosition(ccCenter(this)),this.addChild(bg);var m=MasterManager.getInstance(),context=BattleContext._getInstance(),event_dungeon_period_idx=0;event_dungeon_period_idx=context.getIsPrvEventDungeon()?context.getPrvEventDungeonPeriodIdx():context.getEventDungeonPeriodIdx();m.get_EventDungeonPeriod(event_dungeon_period_idx);this.m_achievementLayer=new EventDungeonAchievementLayer_V2,this.addChild(this.m_achievementLayer);var statusLayer=new StatusLayer;statusLayer.initLayout(),statusLayer.ignoreAnchorPointForPosition(!1),statusLayer.setAnchorPoint(ANCHOR_TOP_RIGHT()),statusLayer.setPosition(ccWidth(this),ccHeight(this)),this.addChild(statusLayer);var title=cc.Sprite.create(RES_CDN_DEFULT+"menu_achievement/img_achievement_text_achievement.png");title.setAnchorPoint(ZERO()),title.setPosition(90,585),this.addChild(title);var back_btn=new ccui.Button("btn_home_off.png","btn_home_on.png","",ccui.Widget.PLIST_TEXTURE);return back_btn.setAnchorPoint(ZERO()),back_btn.setPosition(10,559),back_btn.addClickEventListener(function(){this.back()}.bind(this)),this.addChild(back_btn),!0},onEnter:function(){this._super(),MainObserver.getInstance().addObserver(this.onNotification,this,sceneStr[scene_EventDungeonAchievementScene_V2])},onExit:function(){this._super(),MainObserver.getInstance().removeObserver(sceneStr[scene_EventDungeonAchievementScene_V2])},onEnterTransitionDidFinish:function(){this._super()},onNotification:function(msg){this._super(msg)},onNetworkEvent:function(opcode,state,body){this._super(opcode,state,body),opcode==net.OP.op_user_event_dungeon_achv_bonus_recv?this.m_achievementLayer.refreshEventDungeonAchvList():opcode==net.OP.op_user_event_dungeon_achv_bonus_recv_all&&this.m_achievementLayer.refreshEventDungeonAchvList()},back:function(){this.onKeyBack(!0)},setTabEventDungeonPeriodIdx:function(event_dungeon_period_idx){this.m_achievementLayer.changeTab(event_dungeon_period_idx)}}),BOARD_REWARD_TYPE_LOVE_ITEM=1,BOARD_REWARD_TYPE_RARE_ORB=2,BOARD_REWARD_TYPE_FORCE_TYPE_ORB=3,BOARD_REWARD_TYPE_LIMIT_OVER=4,BOARD_REWARD_TYPE_MELEE=13,BOARD_REWARD_TYPE_SPEAR=14,BOARD_REWARD_TYPE_ARCHER=15,BOARD_REWARD_TYPE_NORMAL=16,EventDungeonBoardEntranceLayer=cc.Layer.extend({m_period:null,m_base_layer:null,m_message_box:null,m_achv_new_icon:null,m_cutin_info_btn:null,m_event_dungeon_cutin_accum_rate_point:null,m_event_dungeon_point:null,m_board_info_list:[],m_gnrl_img:[],m_deferred:null,m_first_period_idx:0,m_second_period_idx:0,m_is_prv_event_dungeon:!1,m_winSize:null,ctor:function(deferred){this.m_event_dungeon_cutin_accum_rate_point={},this.m_event_dungeon_point={},this.m_board_info_list=[],this.m_gnrl_img=[],this._super(),this.m_deferred=deferred,this.m_first_period_idx=0,this.m_second_period_idx=0,this.m_is_prv_event_dungeon=!1,this.init()},init:function(){this.m_winSize=ccSize(this);var service=EventDungeonService.getInstance(),m=MasterManager.getInstance(),event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx();this.m_is_prv_event_dungeon=BattleContext._getInstance().getIsPrvEventDungeon(),this.m_period=m.get_EventDungeonPeriod(event_dungeon_period_idx);for(var period_list=NetService()._event_dungeon_open_period_info.event_dungeon_open_period,idx=0;idx<period_list.length;idx++){var e=period_list[idx];if(e.event_dungeon_period_idx==event_dungeon_period_idx){e;break}}this.m_first_period_idx=service.getEventDungeonFirstHalfPeriodIdx(this.m_period.event_dungeon_group_idx),this.m_second_period_idx=service.getEventDungeonSecondHalfPeriodIdx(this.m_period.event_dungeon_group_idx),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_period_idx+"/img_eventvs_cut_gauge_back.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_period_idx+"/img_eventvs_cut_gauge_front.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_period_idx+"/img_eventvs_cut_gauge_on.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_period_idx+"/img_eventvs_cut_gauge_red.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_shop_reward_ahn.png",this.m_period.event_dungeon_group_idx)),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_period_idx+"/img_eventvs_cut_cloud.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_cut_cloud_none.png",this.m_first_period_idx));idx=this.m_first_period_idx;return service.IsOpenDungeon(this.m_second_period_idx)&&(idx=this.m_second_period_idx),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+idx+"/img_eventvs_info_boss.png"),cc.loader.load(this.m_gnrl_img,function(err,results){if(!err){service.getUserEventDungeonCutinAccumRatePoint(this.m_period.event_dungeon_period_idx,this.m_event_dungeon_cutin_accum_rate_point),service.getUserEventDungeonPoint(this.m_period.event_dungeon_point_period_idx,this.m_event_dungeon_point),service.getUserEventDungeonRewardBoardInfo(this.m_period.event_dungeon_point_period_idx,this.m_board_info_list);var bg=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_period_idx+"/bg_eventvs_main.png");bg.setPosition(ccCenter(this)),this.addChild(bg);var right_layer=this.getRightLayer();right_layer.ignoreAnchorPointForPosition(!1),right_layer.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),right_layer.setPosition(ccWidth(this)-ccWidth(right_layer)-17,16),this.addChild(right_layer);var left_layer=this.getLeftLayer();left_layer.setPosition(0,22),this.addChild(left_layer);var bottom_info=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_period_idx+"/img_eventvs_info_3.png");bottom_info.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),bottom_info.setPosition(ccCenter(this).x,0),this.addChild(bottom_info);var achv_btn=new LabelButton("btn_36_off.png","btn_36_on.png","",ccui.Widget.PLIST_TEXTURE);achv_btn.setFont(LABEL_FONT_INDEX.FONT_181),achv_btn.setOffFont(LABEL_FONT_INDEX.FONT_188),achv_btn.setString(res_str("btn_label_event_mission")),achv_btn.setAnchorPoint(ZERO()),achv_btn.setPosition(20,10),this.addChild(achv_btn),achv_btn.addClickEventListener(function(sender){GameContext.getInstance().setAchievementTap(ACHIEVEMENT_EVENTDUNGEON),MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonBoardEntranceScene],NOTIFY_MENU_ACHIEV)}),this.m_achv_new_icon=cc.Sprite.create(RES_CDN_DEFULT+"common/ic_new.png"),this.m_achv_new_icon.setAnchorPoint(ANCHOR_MIDDLE()),this.m_achv_new_icon.setPosition(155,35),achv_btn.addChild(this.m_achv_new_icon),this.m_achv_new_icon.setVisible(!1),null!=this.m_achv_new_icon&&(AchievementService.getInstance().isNewCompleteAchievementEventDungeon(this.m_period.event_dungeon_group_idx)?this.m_achv_new_icon.setVisible(!0):this.m_achv_new_icon.setVisible(!1)),this.m_is_prv_event_dungeon&&(achv_btn.setEnabled(!1),this.m_achv_new_icon.setVisible(!1)),this.m_message_box=new GameMessageBox,this.addChild(this.m_message_box,1e4);var help_btn=new ccui.Button;help_btn.loadTextures("btn_help_off.png","btn_help_on.png","",ccui.Widget.PLIST_TEXTURE),help_btn.setAnchorPoint(ZERO()),help_btn.setPosition(10,476),this.addChild(help_btn),help_btn.addClickEventListener(function(sender){GameContext.getInstance().setHelpInfoIndexByCallIndex(2);var scene=new HelpContentScene;SceneManager.getInstance().pushScene(scene)}),this.m_deferred.resolve(!0)}}.bind(this)),!0},onEnter:function(){this._super()},onExit:function(){if(this._super(),null!=this.m_gnrl_img){for(var idx=0;idx<this.m_gnrl_img.length;idx++)cc.loader.release(this.m_gnrl_img[idx]);this.m_gnrl_img=null}},getLeftLayer:function(){var layer=new cc.Layer,mt=MasterTable.getInstance(),service=EventDungeonService.getInstance(),board_reward_type_list=(mt.get_EventDungeonRewardBoardInfo(this.m_period.event_dungeon_group_idx),[]);service.getEventDungeonBoardRewardTypeList(this.m_period.event_dungeon_group_idx,board_reward_type_list);var offset_x=0,bar_offset_x=64;board_reward_type_list.forEach(function(board_reward_type){var board_item_layer=this.getBoardItemLayer(board_reward_type);board_item_layer.setPosition(offset_x,0),layer.addChild(board_item_layer);var bar=cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_shop_reward_road.png",this.m_period.event_dungeon_group_idx));bar.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),bar.setPosition(bar_offset_x,29),layer.addChild(bar),bar_offset_x+=128,offset_x+=128}.bind(this));var info4=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_group_idx+"/img_eventvs_info_4.png");return info4.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),info4.setPosition(0,396),layer.addChild(info4),layer},getBoardItemLayer:function(board_reward_type){var layer=new cc.Layer,mt=MasterTable.getInstance(),list=this.getBoardInfoRewardType(board_reward_type);if(0<list.size()){var offset_y=285;list.forEach(function(user_board_info){var item=new EventDungeonRewardBoardItem;item.setAnchorPoint(ZERO()),item.setPosition(0,offset_y),item._callback=this.cbChoiceBoardInfo.bind(this),layer.addChild(item),item.setData(user_board_info),offset_y-=ccHeight(item),mt.get_EventDungeonRewardBoardMap(user_board_info.event_dungeon_reward_board_info_idx).forEach(function(m){mt.get_EventDungeonRewardBoardMapBonus(m.event_dungeon_reward_board_map_idx).forEach(function(map_bonus){if(map_bonus.bonus_type==BONUS_TYPE_YUNHEE_FIX&&MasterManager.getInstance().get_General(map_bonus.min_value).gnrl_type==GENERAL_TYPE_YUNHEE){var icon=cc.Sprite.create(RES_CDN_DEFULT+cmString("menu_eventvs_%d/img_eventvs_shop_reward_ahn.png",this.m_period.event_dungeon_group_idx));icon.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),icon.setPosition(ccWidth(item),0),item.addChild(icon)}}.bind(this))}.bind(this))}.bind(this))}return layer.setContentSize(128,413),layer},getRightLayer:function(){var size=cc.size(444,122),mt=MasterManager.getInstance(),service=EventDungeonService.getInstance(),layer=new cc.Layer;layer.setContentSize(size);var idx=this.m_first_period_idx;service.IsOpenDungeon(this.m_second_period_idx)&&(idx=this.m_second_period_idx);var point_box=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+idx+"/img_eventvs_info_boss.png");point_box.setAnchorPoint(ZERO()),point_box.setPosition(0,60),layer.addChild(point_box);var unit_type=MasterManager.getInstance().get_EventPointUnitType(this.m_period.event_point_unit_type),unit_title=cmLabel.getLabel(unit_type.name,LABEL_FONT_INDEX.FONT_248);unit_title.setAnchorPoint(ANCHOR_MIDDLE_LEFT()),unit_title.setPosition(64,30),point_box.addChild(unit_title);var event_point_count=cmLabel.getLabel(cmString(mt.get_LanguageData("label_event_dungeon_own_point"),Number(this.m_event_dungeon_point.event_point).toLocaleString("en")),LABEL_FONT_INDEX.FONT_247);event_point_count.setAnchorPoint(ANCHOR_MIDDLE_RIGHT()),event_point_count.setPosition(point_box.width-20,30),point_box.addChild(event_point_count);var first_half_btn=new LabelButton("btn_07_off.png","btn_07_on.png","btn_07_none.png",ccui.Widget.PLIST_TEXTURE);first_half_btn.setFont(LABEL_FONT_INDEX.FONT_221),first_half_btn.setString(mt.get_LanguageData("label_event_dungeon_first_half_enter_text")),first_half_btn.setAnchorPoint(ZERO()),first_half_btn.setPosition(ZERO()),layer.addChild(first_half_btn),first_half_btn.addClickEventListener(function(sender){this.entranceDungeonList(this.m_first_period_idx)}.bind(this)),first_half_btn.setEnabled(service.IsOpenDungeon(this.m_first_period_idx)),first_half_btn.setEnabled(!this.m_is_prv_event_dungeon);var second_half_btn=new LabelButton("btn_07_off.png","btn_07_on.png","btn_07_none.png",ccui.Widget.PLIST_TEXTURE);second_half_btn.setFont(LABEL_FONT_INDEX.FONT_221),second_half_btn.setString(mt.get_LanguageData("label_event_dungeon_second_half_enter_text")),second_half_btn.setAnchorPoint(ZERO()),second_half_btn.setPosition(ccWidth(first_half_btn),0),layer.addChild(second_half_btn),second_half_btn.addClickEventListener(function(sender){this.entranceDungeonList(this.m_second_period_idx)}.bind(this)),second_half_btn.setEnabled(service.IsOpenDungeon(this.m_first_period_idx)),second_half_btn.setEnabled(!this.m_is_prv_event_dungeon);var is_prv_dungeon=BattleContext._getInstance().getIsPrvEventDungeon(),is_exist_prev_dungeon=service.IsExistPrevEventDungeon(this.m_period.event_dungeon_group_idx);if(!is_prv_dungeon&&is_exist_prev_dungeon){var prv_event_dungeon_btn=new LabelButton("btn_36_off.png","btn_36_on.png","",ccui.Widget.PLIST_TEXTURE);prv_event_dungeon_btn.setFont(LABEL_FONT_INDEX.FONT_181),prv_event_dungeon_btn.setOffFont(LABEL_FONT_INDEX.FONT_188),prv_event_dungeon_btn.setString(res_str("label_event_dungeon_circuit_reward_title")),prv_event_dungeon_btn.setString(res_str("btn_label_prev_event_dungeon_reward")),prv_event_dungeon_btn.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),prv_event_dungeon_btn.setPosition(ccWidth(layer)-10,70+ccHeight(point_box)),layer.addChild(prv_event_dungeon_btn),prv_event_dungeon_btn.addClickEventListener(function(sender){BattleContext._getInstance().setPrvEventDungeonPeriodIdx(this.m_period.prev_event_dungeon_group_idx),MainObserver.getInstance().postNotification(NOTIFY_MENU_PRV_EVENT_DUNGEON_ENTRANCE)}.bind(this))}return layer},entranceDungeonList:function(event_dungeon_period_idx){if(!EventDungeonService.getInstance().IsOpenDungeon(event_dungeon_period_idx))return!1;this.getParent().initLayoutProgress(),BattleContext._getInstance().setEventDungeonPeriodIdX(event_dungeon_period_idx);var scene=new EventDungeonListScene;return scene.get_story_deferred().done(function(){this.scheduleOnce(function(dt){SceneManager.getInstance().replaceScene(scene,!0)},1.5,"main_layer_ready")}.bind(this)),!0},createInfoLayer:function(){var service=EventDungeonService.getInstance(),title_banner=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_period_idx+"/img_eventvs_banner.png");title_banner.setAnchorPoint(ANCHOR_MIDDLE_TOP()),title_banner.setPosition(.5*this.m_winSize.width,this.m_winSize.height-60),this.m_base_layer.addChild(title_banner);var idx=EVENT_DUNGEON_FIRST_HALF_IDX;service.IsOpenDungeon(EVENT_DUNGEON_SECOND_HALF_IDX)&&(idx=EVENT_DUNGEON_SECOND_HALF_IDX);var boss_info=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+idx+"/img_eventvs_info.png");boss_info.setAnchorPoint(ANCHOR_TOP_RIGHT()),boss_info.setPosition(this.m_winSize.width-10,this.m_winSize.height-55),this.m_base_layer.addChild(boss_info);var bottom_info=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_period_idx+"/img_eventvs_info_3.png");bottom_info.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),bottom_info.setPosition(.5*this.m_winSize.width,0),this.m_base_layer.addChild(bottom_info)},getBoardInfoRewardType:function(reward_type){for(var list=[],i=0;i<this.m_board_info_list.length;i++)this.m_board_info_list[i].board_info.board_reward_type==reward_type&&list.push(this.m_board_info_list[i]);return list},cbChoiceBoardInfo:function(board){if(board.is_complete_board_info)this.showAlreadyRewarded();else{BattleContext._getInstance().setEventDungeonBoardInfo(board);var scene=new EventDungeonRewardBoardScene;SceneManager.getInstance().replaceScene(scene)}},showAlreadyRewarded:function(){var m=MasterManager.getInstance();this.m_message_box.setTitle(m.get_LanguageData("label_event_dungeon_reward_complete_title")),this.m_message_box.setText(m.get_LanguageData("label_event_dungeon_reward_complete_message"));var btnYes=new MessageButtonInfo(m.get_LanguageData("label_confirm"),MessageBoxButtonType.ButtonTypeNormal,0);btnYes.click=function(){this.m_message_box.hide(!1)}.bind(this),this.m_message_box.addButtonInfo(btnYes),this.m_message_box.is_show()&&this.m_message_box.hide(!1),this.m_message_box.show()}}),EventDungeonBoardEntranceScene=GameScene.extend({m_isPushScene:!1,m_entrance_layer:null,m_deferred:$.Deferred(),ctor:function(){this._super(scene_EventDungeonBoardEntranceScene)},get_story_deferred:function(){return this.m_deferred},init:function(){cc.director.getWinSize();var event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx();this.m_entrance_layer=new EventDungeonBoardEntranceLayer(this.m_deferred),this.addChild(this.m_entrance_layer);var statusLayer=new StatusLayer(INVOKER_TYPE.normal);statusLayer.ignoreAnchorPointForPosition(!1),statusLayer.setAnchorPoint(ANCHOR_TOP_RIGHT()),statusLayer.setPosition(ccWidth(this),ccHeight(this)),this.addChild(statusLayer);var title=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+event_dungeon_period_idx+"/img_eventvs_text_event.png");title.setAnchorPoint(ZERO()),title.setPosition(90,585),this.addChild(title);var back_btn=new ccui.Button;return back_btn.loadTextures("btn_home_off.png","btn_home_on.png","",ccui.Widget.PLIST_TEXTURE),back_btn.setAnchorPoint(ZERO()),back_btn.setPosition(10,559),back_btn.addClickEventListener(function(){this.back()}.bind(this)),this.addChild(back_btn),!0},onEnter:function(){this._super(),MainObserver.getInstance().addObserver(this.onNotification,this,sceneStr[scene_EventDungeonBoardEntranceScene]);var event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx(),period=MasterManager.getInstance().get_EventDungeonPeriod(event_dungeon_period_idx),b_path=RES_CDN_SOUND+SND_TYPE+"sound/"+cmString(BGM_EVENT_DUNGEON_SCENE,period.event_dungeon_point_period_idx),audio=AudioEngine.getInstance();audio.m_bgmPath!=b_path&&(audio.stopBackgroundMusic(),audio.playBackgroundMusic(b_path,!0))},onExit:function(){this._super(),MainObserver.getInstance().removeObserver(sceneStr[scene_EventDungeonBoardEntranceScene])},onNotification:function(msg){return!this._super(msg)},onNetworkEvent:function(opcode,body){},back:function(msg){BattleContext._getInstance().setIsPrvEventDungeon(!1),this.onKeyBack(!0)}}),EventDungeonRewardBoardItem=cc.Layer.extend({m_complete_mark:null,_callback:null,m_reward_new:null,m_disable_mark:null,m_item_btn:null,m_data:null,ctor:function(){this._super(),this.init()},init:function(){var size=cc.size(128,128);this.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),this.setContentSize(size);var mt=MasterManager.getInstance(),event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx(),period=mt.get_EventDungeonPeriod(event_dungeon_period_idx);return this.m_item_btn=new ccui.Button,this.m_item_btn.loadTextures(RES_CDN_DEFULT+"menu_eventvs_"+period.event_dungeon_group_idx+"/img_eventvs_text_event.png",RES_CDN_DEFULT+"menu_eventvs_"+period.event_dungeon_group_idx+"/img_eventvs_shop_reward_click.png"),this.m_item_btn.setAnchorPoint(ANCHOR_MIDDLE()),this.m_item_btn.setPosition(ccCenter(size)),this.addChild(this.m_item_btn),this.m_item_btn.addClickEventListener(function(){this._callback&&this._callback(this.m_data)}.bind(this)),this.m_reward_new=cc.Sprite.create(RES_CDN_DEFULT+"common/ic_new.png"),this.m_reward_new.setAnchorPoint(ANCHOR_MIDDLE()),this.m_reward_new.setPosition(size.width-5,size.height-20),this.addChild(this.m_reward_new),this.m_disable_mark=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+period.event_dungeon_group_idx+"/img_eventvs_shop_reward_none.png"),this.m_disable_mark.setAnchorPoint(ANCHOR_MIDDLE()),this.m_disable_mark.setPosition(ccCenter(size)),this.addChild(this.m_disable_mark),this.m_disable_mark.setVisible(!1),this.m_complete_mark=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+period.event_dungeon_group_idx+"/img_eventvs_shop_reward_finish.png"),this.m_complete_mark.setAnchorPoint(ANCHOR_MIDDLE()),this.m_complete_mark.setPosition(ccCenter(size)),this.addChild(this.m_complete_mark),!0},onEnter:function(){this._super()},onExit:function(){this._super()},setData:function(data){this.m_data=data,this.updateItem()},updateItem:function(){var m=MasterManager.getInstance(),event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx(),period=m.get_EventDungeonPeriod(event_dungeon_period_idx),btn_img=RES_CDN_DEFULT+"menu_eventvs_"+period.event_dungeon_group_idx+"/img_eventvs_shop_reward_"+this.m_data.board_info.board_reward_type+".png";if(this.m_item_btn.loadTextureNormal(btn_img),this.m_complete_mark.setVisible(this.m_data.is_complete_board_info),this.m_data.is_complete_board_info)this.m_disable_mark.setVisible(!1),this.m_reward_new.setVisible(!1);else if(this.m_disable_mark.setVisible(!this.m_data.is_open_board_info),this.m_data.is_open_board_info){for(var is_new=!1,idx=0;idx<this.m_data.map_list.length;idx++){if((m=this.m_data.map_list[idx]).event_point>=m.map_info.need_event_point){is_new=!0;break}}this.m_reward_new.setVisible(is_new)}else this.m_reward_new.setVisible(!1)},onTouchSlot:function(){}}),EventDungeonRewardBoardLayer=cc.Layer.extend({m_bg:null,m_message_box:null,m_base_layer:null,m_event_point_count:null,m_runner:null,m_period:null,m_board_info:null,m_event_dungeon_point:null,m_map_item_list:[],ctor:function(_deferred){this.m_map_item_list=[],this.m_event_dungeon_point={},this._super(),this.init(_deferred)},init:function(_deferred){var winSize=ccSize(this);this.m_board_info=BattleContext._getInstance().getEventDungeonBoardInfo();var m=MasterManager.getInstance(),event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx();this.m_period=m.get_EventDungeonPeriod(event_dungeon_period_idx),this.m_bg=new cc.Sprite(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_point_period_idx+"/bg_eventvs_shop_"+this.m_board_info.board_info.bg_type+".png"),this.m_bg.setPosition(ccCenter(winSize)),this.addChild(this.m_bg);ccSize(this.m_bg);EventDungeonService.getInstance().getUserEventDungeonPoint(this.m_board_info.board_info.event_dungeon_period_idx,this.m_event_dungeon_point),this.m_base_layer=new cc.Layer,this.m_base_layer.setAnchorPoint(ANCHOR_MIDDLE()),this.m_base_layer.ignoreAnchorPointForPosition(!1),this.m_base_layer.setPosition(ccCenter(winSize)),this.addChild(this.m_base_layer);for(var idx=0;idx<this.m_board_info.map_list.length;idx++){var map=this.m_board_info.map_list[idx],item=new EventDungeonRewardBoardMapItem;item._callback=this.cbChoiceBoardMap.bind(this),item.setPosition(map.map_info.x,map.map_info.y),this.m_bg.addChild(item),item.setData(map),this.m_map_item_list.push(item)}var title=new cc.Sprite(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_group_idx+"/img_eventvs_shop_text_"+this.m_board_info.board_info.board_reward_type+".png");if(title.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),title.setPosition(162,448),this.m_bg.addChild(title),this.m_event_point_count=cmLabel.getLabel(cmString(MasterManager.getInstance().get_LanguageData("label_event_dungeon_own_point"),Number(this.m_event_dungeon_point.event_point).toLocaleString("en")),LABEL_FONT_INDEX.FONT_247),this.m_event_point_count.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),this.m_event_point_count.setPosition(1021,524),this.m_bg.addChild(this.m_event_point_count),this.m_runner=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_point_period_idx+"/img_eventvs_ani_1.png"),this.m_runner.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_runner.setPosition(this.m_board_info.board_info.start_pos_x+36,this.m_board_info.board_info.start_pos_y),this.m_runner.setScale(.7),this.m_bg.addChild(this.m_runner),this.m_board_info.is_open_board_info){var anim=this.createRunner(),repeat=cc.repeatForever(anim);this.m_runner.runAction(repeat),this.m_runner.setVisible(!0)}else this.m_runner.setVisible(!1);return this.updateItems(_deferred),this.m_message_box=new CTGameMessageBox,this.addChild(this.m_message_box,1e4),!0},onEnter:function(){this._super()},onExit:function(){this._super()},cbChoiceBoardMap:function(map){this.m_map_item_list.forEach(function(item){item.hideToolTip()}),map.map_info.need_event_point>this.m_event_dungeon_point.event_point?this.showLackEventPointPopup(map):this.showRewardConfirmPopup(map)},showRewardConfirmPopup:function(map){var m=MasterManager.getInstance();this.m_message_box.setTitle(m.get_LanguageData("label_shop_buy_jade_omission_title"));var period=m.get_EventDungeonPeriod(map.event_dungeon_period_idx),unit=m.get_EventPointUnitType(period.event_point_unit_type),reward=map.reward_list[0],bonus_type=m.get_BonusType(reward.bonus_type);if(reward.bonus_type==BONUS_TYPE_YUNHEE_FIX){var g=m.get_General(reward.min_value);this.m_message_box.setText(unit.name+""+Number(map.map_info.need_event_point).toLocaleString("en"),LABEL_FONT_INDEX.FONT_262),this.m_message_box.setText("個と",LABEL_FONT_INDEX.FONT_261),this.m_message_box.setText(g.name,LABEL_FONT_INDEX.FONT_262),this.m_message_box.setText("を",LABEL_FONT_INDEX.FONT_261)}else this.m_message_box.setText(unit.name+""+Number(map.map_info.need_event_point).toLocaleString("en"),LABEL_FONT_INDEX.FONT_262),this.m_message_box.setText("個と",LABEL_FONT_INDEX.FONT_261),this.m_message_box.setText(bonus_type.name+""+reward.min_value,LABEL_FONT_INDEX.FONT_262),this.m_message_box.setText("個を",LABEL_FONT_INDEX.FONT_261);this.m_message_box.setText("\n"),this.m_message_box.setText(m.get_LanguageData("label_event_dungeon_reward_confirm_message_2"),LABEL_FONT_INDEX.FONT_261);var btnNo=new MessageButtonInfo(m.get_LanguageData("btn_label_no"),MessageBoxButtonType.ButtonTypeRed,0);btnNo.click=function(){this.m_message_box.hide(!1)}.bind(this);var btnYes=new MessageButtonInfo(m.get_LanguageData("btn_label_yes"),MessageBoxButtonType.ButtonTypeNormal,0);btnYes.click=function(){this.scheduleOnce(function(float){this.reqRewardMapBonus(map)},.1,"reqRewardMapBonus"),this.m_message_box.hide(!1)}.bind(this),this.m_message_box.addButtonInfo(btnNo),this.m_message_box.addButtonInfo(btnYes),this.m_message_box.is_show()&&this.m_message_box.hide(!1),this.m_message_box.show()},showLackEventPointPopup:function(map){var m=MasterManager.getInstance();this.m_message_box.setTitle(m.get_LanguageData("label_shop_buy_jade_omission_title"));var period=m.get_EventDungeonPeriod(map.event_dungeon_period_idx),unit=m.get_EventPointUnitType(period.event_point_unit_type);this.m_message_box.setText(cmString(m.get_LanguageData("label_event_dungeon_reward_lack_event_point_1"),unit.name),LABEL_FONT_INDEX.FONT_261),this.m_message_box.setText("\n"),this.m_message_box.setText(cmString(m.get_LanguageData("label_event_dungeon_reward_lack_event_point_2"),unit.name),LABEL_FONT_INDEX.FONT_261);var btnYes=new MessageButtonInfo(m.get_LanguageData("label_confirm"),MessageBoxButtonType.ButtonTypeNormal,0);btnYes.click=function(){this.m_message_box.hide(!1)}.bind(this),this.m_message_box.addButtonInfo(btnYes),this.m_message_box.is_show()&&this.m_message_box.hide(!1),this.m_message_box.show()},reqRewardMapBonus:function(map){var req={};req.opcode=net.OP.op_event_dungeon_point_reward_board_map,req.event_dungeon_period_idx=map.event_dungeon_period_idx,req.event_dungeon_reward_board_info_idx=map.map_info.event_dungeon_reward_board_info_idx,req.event_dungeon_reward_board_map_idx=map.map_info.event_dungeon_reward_board_map_idx;var mainScene=SceneManager.getInstance().getMainScene();GameClient().write(req,mainScene.onNetworkEvent)},refreshRewardMapInfo:function(res){EventDungeonService.getInstance().getUserEventDungeonPoint(this.m_board_info.board_info.event_dungeon_period_idx,this.m_event_dungeon_point);for(var func_map_open=function(reward_board_map_idx){for(var i=0;i<this.m_board_info.map_list.length;i++){var m=this.m_board_info.map_list[i];if(reward_board_map_idx==m.event_dungeon_reward_board_map_idx&&m.is_rewarded_yn)return!0}return!1}.bind(this),idx=0;idx<this.m_board_info.map_list.length;idx++){(m=this.m_board_info.map_list[idx]).event_dungeon_reward_board_map_idx==res.event_dungeon_reward_board_map_idx&&(m.event_point=this.m_event_dungeon_point.event_point,m.is_rewarded_yn="y"==res.rewarded_yn)}for(idx=0;idx<this.m_board_info.map_list.length;idx++){var m;0==(m=this.m_board_info.map_list[idx]).map_info.open_prev_dungeon_idx?m.is_open_prev_map=!0:func_map_open(m.map_info.open_prev_dungeon_idx)&&(m.is_open_prev_map=!0)}this.updateItems()},updateItems:function(_deferred){for(var mt=MasterManager.getInstance(),i=0;i<this.m_board_info.map_list.length;i++)if(i<this.m_map_item_list.length){var map=this.m_board_info.map_list[i];if(this.m_map_item_list[i].setData(map),map.is_rewarded_yn){for(var board_map_list=MasterTable.getInstance().get_EventDungeonRewardBoardMap(map.event_dungeon_reward_board_info_idx),idx=0;idx<board_map_list.length;idx++){var m=board_map_list[idx];if(m.event_dungeon_reward_board_map_idx==map.event_dungeon_reward_board_map_idx){this.m_runner.setFlippedX(1==m.flip);break}}this.m_runner.setPosition(map.map_info.x+36,map.map_info.y)}}this.m_event_point_count.setString(cmString(mt.get_LanguageData("label_event_dungeon_own_point"),Number(this.m_event_dungeon_point.event_point).toLocaleString("en"))),null!=_deferred&&_deferred.resolve(!0)},createRunner:function(){for(var animation=cc.Animation.create(),i=1;i<=2;i++){var ani_img=RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_point_period_idx+"/img_eventvs_ani_"+i+".png",frame_texture=cc.textureCache.addImage(ani_img),frame=new cc.SpriteFrame(frame_texture,cc.rect(0,0,frame_texture.getContentSize().width,frame_texture.getContentSize().height));animation.addSpriteFrame(frame)}return animation.setDelayPerUnit(.2),animation.setRestoreOriginalFrame(!0),new cc.Animate(animation)}}),EventDungeonRewardBoardMapItem=cc.Layer.extend({_callback:null,m_reward_item:null,m_need_event_point:null,m_complete_mark:null,m_arrow:null,m_disable_box:null,m_period:null,m_tooltip_box:null,m_data:[],ctor:function(){this.m_arrow=null,this.m_disable_box=null,this.m_tooltip_box=null,this.m_data=[],this._super(),this.init()},init:function(){var size=cc.size(72,72);this.ignoreAnchorPointForPosition(!1),this.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),this.setContentSize(size),this.m_board_info=BattleContext._getInstance().getEventDungeonBoardInfo();var m=MasterManager.getInstance(),event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx();this.m_period=m.get_EventDungeonPeriod(event_dungeon_period_idx);var shop_frame=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_point_period_idx+"/img_eventvs_shop_frame.png");shop_frame.setAnchorPoint(ANCHOR_MIDDLE()),shop_frame.setContentSize(size),shop_frame.setPosition(ccCenter(size)),this.addChild(shop_frame);var icon_frame=cc.Sprite.create(RES_CDN_DEFULT+"icon/img_icon_frame.png");icon_frame.setAnchorPoint(ANCHOR_MIDDLE()),icon_frame.setPosition(ccCenter(size)),shop_frame.addChild(icon_frame),this.m_reward_item=new MissionPreviewBonusItemCell(this.addTooltip.bind(this),this.removeTooltip.bind(this)),this.m_reward_item.setAnchorPoint(ANCHOR_MIDDLE()),this.m_reward_item.setPosition(ccCenter(icon_frame)),this.m_reward_item.setEnableToolTip(!0,!0),this.m_reward_item.setEnableItemCount(!0),icon_frame.addChild(this.m_reward_item),this.m_disable_box=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_point_period_idx+"/img_icon_valuebox_mask.png"),this.m_disable_box.setAnchorPoint(ANCHOR_MIDDLE_TOP()),this.m_disable_box.setPosition(.5*ccWidth(icon_frame),size.height),icon_frame.addChild(this.m_disable_box);var need_count_box=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_point_period_idx+"/img_eventvs_shop_reward_box.png");need_count_box.setAnchorPoint(ANCHOR_MIDDLE_TOP()),need_count_box.setPosition(.5*size.width,-10),this.addChild(need_count_box),this.m_need_event_point=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_1813),this.m_need_event_point.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),this.m_need_event_point.setPosition(70,8),need_count_box.addChild(this.m_need_event_point),this.m_arrow=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_point_period_idx+"/img_eventvs_next.png"),this.m_arrow.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_arrow.setPosition(.5*size.width,54),icon_frame.addChild(this.m_arrow,0);var mu=cc.moveBy(.5,cc.p(0,10)),md=cc.moveBy(.5,cc.p(0,-10)),seq=cc.sequence(mu,md),repeat=cc.repeatForever(seq);this.m_arrow.runAction(repeat),this.m_complete_mark=cc.Sprite.create(RES_CDN_DEFULT+"common/img_attend_finish_small.png"),this.m_complete_mark.setAnchorPoint(ANCHOR_MIDDLE()),this.m_complete_mark.setPosition(ccCenter(shop_frame)),shop_frame.addChild(this.m_complete_mark);var touch_btn=new cc.ControlButton(cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_transbox.png",cc.rect(1,1,1,1)));return touch_btn.setAnchorPoint(ANCHOR_MIDDLE()),touch_btn.setPosition(ccCenter(size)),touch_btn.setPreferredSize(size),this.addChild(touch_btn),touch_btn.addTargetWithActionForControlEvents(this,this.onTouchSlot,cc.CONTROL_EVENT_TOUCH_DOWN),touch_btn.addTargetWithActionForControlEvents(this,this.onTouchSlot,cc.CONTROL_EVENT_TOUCH_UP_INSIDE),touch_btn.addTargetWithActionForControlEvents(this,this.onTouchSlot,cc.CONTROL_EVENT_TOUCH_UP_OUTSIDE),touch_btn.addTargetWithActionForControlEvents(this,this.onTouchSlot,cc.CONTROL_EVENT_TOUCH_CANCEL),!0},onEnter:function(){this._super()},onExit:function(){},setData:function(data){this.m_data=data,this.updateItem()},updateItem:function(){var b=this.m_data.reward_list[0];this.m_need_event_point.setString(Number(this.m_data.map_info.need_event_point).toLocaleString("en"));var item={};b.bonus_type==BONUS_TYPE_YUNHEE_FIX||b.bonus_type==BONUS_TYPE_JIN_FIX?(item.item_type=database.BattleGainItemType.General,item.item_id=b.min_value,item.item_level=1,item.item_count=b.max_value):b.bonus_type==BONUS_TYPE_HEART?(item.item_type=database.BattleGainItemType.Heart,item.item_id=b.bonus_type,item.item_count=b.min_value):b.bonus_type==BONUS_TYPE_SKIP_TICKET?(item.item_type=database.BattleGainItemType.SkipTicket,item.item_id=b.bonus_type,item.item_count=b.min_value):b.bonus_type==BONUS_TYPE_JADE?(item.item_type=database.BattleGainItemType.Jade,item.item_id=b.bonus_type,item.item_count=b.min_value):b.bonus_type==BONUS_TYPE_GOLD?(item.item_type=database.BattleGainItemType.Gold,item.item_id=b.bonus_type,item.item_count=b.min_value):b.bonus_type>=BONUS_TYPE_HWANDAN_1&&b.bonus_type<=BONUS_TYPE_HWANDAN_7||b.bonus_type==BONUS_TYPE_YUBI_RARE?(item.item_type=database.BattleGainItemType.Hwandan,item.item_id=b.bonus_type,item.item_count=b.min_value):b.bonus_type==BONUS_TYPE_EVENT_POINT?(item.item_type=database.BattleGainItemType.EventPoint,item.item_id=b.bonus_type,item.item_count=b.min_value):b.bonus_type==BONUS_TYPE_EVOLVE_STONE?(item.item_type=database.BattleGainItemType.EvolveStone,item.item_id=b.bonus_type,item.item_count=b.min_value):b.bonus_type>=BONUS_TYPE_ATTK_POINT&&b.bonus_type<=BONUS_TYPE_CRI_DMG_POINT?(item.item_type=database.BattleGainItemType.FormationPropertyPoint,item.item_id=b.bonus_type,item.item_count=b.min_value):b.bonus_type>=BONUS_TYPE_EVOLVE_MELEE&&b.bonus_type<=BONUS_TYPE_EVOLVE_ARCHER||b.bonus_type==BONUS_TYPE_YUBI_EVOLVE_HIGH?(item.item_type=database.BattleGainItemType.ForceTypeEvolveMtrl,item.item_id=b.bonus_type,item.item_count=b.min_value,item.item_level=1):b.bonus_type>=BONUS_TYPE_EVOLVE_MELEE_MIDDLE&&b.bonus_type<=BONUS_TYPE_EVOLVE_ARCHER_MIDDLE||b.bonus_type==BONUS_TYPE_YUBI_EVOLVE_MIDDLE?(item.item_type=database.BattleGainItemType.ForceTypeEvolveMtrl,item.item_id=b.bonus_type,item.item_count=b.min_value,item.item_level=1):b.bonus_type>=BONUS_TYPE_EVOLVE_MELEE_LOW&&b.bonus_type<=BONUS_TYPE_EVOLVE_ARCHER_LOW||b.bonus_type==BONUS_TYPE_YUBI_EVOLVE_LOW?(item.item_type=database.BattleGainItemType.ForceTypeEvolveMtrl,item.item_id=b.bonus_type,item.item_count=b.min_value,item.item_level=1):b.bonus_type==BONUS_TYPE_EVOLVE_ORB?(item.item_type=database.BattleGainItemType.EvolveOrb,item.item_id=b.bonus_type,item.item_count=b.min_value):b.bonus_type>=BONUS_TYPE_LOVE_ITEM_MELEE&&b.bonus_type<=BONUS_TYPE_LOVE_ITEM_CAKE||b.bonus_type==BONUS_TYPE_YUBI_LOVE_ITEM||b.bonus_type==BONUS_TYPE_SUPER_CHOCO_CAKE||b.bonus_type==BONUS_TYPE_LOVE_MAX_CAKE?(item.item_type=database.BattleGainItemType.LoveItem,item.item_id=b.bonus_type,item.item_count=b.min_value,item.item_level=1):b.bonus_type>=BONUS_TYPE_JADE_RANDOM_BOX&&b.bonus_type<=BONUS_TYPE_CHRISTMAS_GIFT_BOX?(item.item_type=database.BattleGainItemType.RandomBox,item.item_id=b.bonus_type,item.item_count=b.min_value):b.bonus_type==BONUS_TYPE_SR_LIMIT_OVER_MTRL?(item.item_type=database.BattleGainItemType.LimitOverMtrl,item.item_id=b.bonus_type,item.item_count=b.min_value):b.bonus_type==BONUS_TYPE_SR_RARE_TYPE_ENGAGE||b.bonus_type==BONUS_TYPE_R_RARE_TYPE_ENGAGE||b.bonus_type==BONUS_TYPE_SR_OVER_GACHA_TICKET?(item.item_type=database.BattleGainItemType.GachaTicket,item.item_id=b.bonus_type,item.item_count=b.min_value):b.bonus_type==BONUS_TYPE_SWORD_ORB_RANDDOM_BOX||b.bonus_type==BONUS_TYPE_SPEAR_ORB_RANDDOM_BOX||b.bonus_type==BONUS_TYPE_ARCHER_ORB_RANDDOM_BOX||b.bonus_type==BONUS_TYPE_FORMATION_PROPERTY_POINT_RANDOM_BOX||b.bonus_type==BONUS_TYPE_EQUIPMENT_EXP_BOX_1||b.bonus_type==BONUS_TYPE_EQUIPMENT_EXP_BOX_2||b.bonus_type==BONUS_TYPE_EQUIPMENT_EXP_BOX_3||b.bonus_type==BONUS_TYPE_EQUIPMENT_EXP_BOX_4?(item.item_type=database.BattleGainItemType.RandomBox,item.item_id=b.bonus_type,item.item_count=b.min_value):b.bonus_type==BONUS_TYPE_KEY_REFILL?(item.item_type=database.BattleGainItemType.KeyRefill,item.item_id=b.bonus_type,item.item_count=b.min_value):b.bonus_type!=BONUS_TYPE_REBIRTH_MTRL_TYPE_1&&b.bonus_type!=BONUS_TYPE_REBIRTH_MTRL_TYPE_2&&b.bonus_type!=BONUS_TYPE_REBIRTH_MTRL_TYPE_3&&b.bonus_type!=BONUS_TYPE_REBIRTH_MTRL_TYPE_4&&b.bonus_type!=BONUS_TYPE_REBIRTH_MTRL_TYPE_5&&b.bonus_type!=BONUS_TYPE_REBIRTH_MTRL_TYPE_6&&b.bonus_type!=BONUS_TYPE_REBIRTH_MTRL_TYPE_7&&b.bonus_type!=BONUS_TYPE_REBIRTH_MTRL_TYPE_EVENT_1&&b.bonus_type!=BONUS_TYPE_REBIRTH_MTRL_TYPE_EVENT_2&&b.bonus_type!=BONUS_TYPE_REBIRTH_MTRL_TYPE_EVENT_3&&b.bonus_type!=BONUS_TYPE_REBIRTH_MTRL_TYPE_EVENT_4&&b.bonus_type!=BONUS_TYPE_REBIRTH_MTRL_TYPE_EVENT_5&&b.bonus_type!=BONUS_TYPE_REBIRTH_MTRL_TYPE_EVENT_6&&b.bonus_type!=BONUS_TYPE_REBIRTH_MTRL_TYPE_EVENT_7||(item.item_type=database.BattleGainItemType.RebirthMtrl,item.item_id=b.bonus_type,item.item_count=b.min_value),this.m_reward_item.setGainItem(item),this.m_board_info.is_open_board_info?(this.m_complete_mark.setVisible(this.m_data.is_rewarded_yn),this.m_data.is_rewarded_yn?(this.m_disable_box.setVisible(!1),this.m_arrow.setVisible(!1)):(this.m_disable_box.setVisible(!this.m_data.is_open_prev_map),this.m_arrow.setVisible(this.m_data.is_open_prev_map))):(this.m_complete_mark.setVisible(!1),this.m_disable_box.setVisible(!0),this.m_arrow.setVisible(!1))},hideToolTip:function(){this.m_reward_item.hideTooltip()},onTouchSlot:function(sender,_event){if(_event==cc.CONTROL_EVENT_TOUCH_DOWN)this.m_reward_item.setScale(.95),this.m_reward_item.showTooltip();else if(_event==cc.CONTROL_EVENT_TOUCH_UP_INSIDE){if(this.m_reward_item.setScale(1),this.m_reward_item.hideTooltip(),!this.m_board_info.is_open_board_info)return;if(this.m_data.is_rewarded_yn||!this.m_data.is_open_prev_map)return;this._callback&&this._callback(this.m_data)}else this.m_reward_item.setScale(1),this.m_reward_item.hideTooltip()},addTooltip:function(world_pos,tooltip,title,content){if(null!=this.m_tooltip_box)return!1;this.tooltip_box=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_result_box.png",cc.Rect(20,20,20,20)),this.m_tooltip_box.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_tooltip_box.setPosition(34,73),this.m_tooltip_box.setVisible(!0),this.addChild(this.m_tooltip_box);var tooltip_title=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_1810);tooltip_title.setAnchorPoint(ANCHOR_TOP_LEFT()),this.m_tooltip_box.addChild(tooltip_title);var tooltip_content=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_181);if(tooltip_content.setAnchorPoint(ANCHOR_TOP_LEFT()),this.m_tooltip_box.addChild(tooltip_content),tooltip_title.setString(title),tooltip_content.setString(content),""!=content){var tSize=ccSize(tooltip_title),cSize=ccSize(tooltip_content);(bSize=cc.size(tSize.width+20,tSize.height+20)).width=Math.max(tSize.width+20,cSize.width+20),bSize.height=Math.max(64,bSize.height+cSize.height+5),this.m_tooltip_box.setContentSize(tooltip._contentSize),this.m_tooltip_box.setPreferredSize(bSize),tooltip_title.setPosition(10,bSize.height-10),tooltip_content.setPosition(10,bSize.height-15-tSize.height)}else{tooltip_title.setAnchorPoint(ANCHOR_MIDDLE());var bSize;tSize=ccSize(tooltip_title);(bSize=cc.size(tSize.width+20,tSize.height+20)).width=Math.max(64,tSize.width+20),bSize.height=Math.max(54,bSize.height+10),this.m_tooltip_box.setPreferredSize(bSize),tooltip_title.setPosition(ccCenter(bSize))}},removeTooltip:function(){this.removeChild(this.m_tooltip_box),this.m_tooltip_box=null}}),EventDungeonRewardBoardScene=GameScene.extend({m_reward_layer:null,m_enalble_touch:!1,m_is_max_bonus:!1,m_is_last_bonus:!1,m_bonus_effect_modal_layer:null,m_deferred:null,ctor:function(){this.m_deferred=$.Deferred(),this._super(scene_EventDungeonRewardBoardScene)},init:function(){ccSize(this);this.initLayoutProgress2(255),this.m_reward_layer=new EventDungeonRewardBoardLayer(this.m_deferred),this.addChild(this.m_reward_layer);var statusLayer=new StatusLayer(INVOKER_TYPE.normal);statusLayer.ignoreAnchorPointForPosition(!1),statusLayer.setAnchorPoint(ANCHOR_TOP_RIGHT()),statusLayer.setPosition(ccWidth(this),ccHeight(this)),this.addChild(statusLayer);var m=MasterManager.getInstance(),event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx(),period=m.get_EventDungeonPeriod(event_dungeon_period_idx),title=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+period.event_dungeon_point_period_idx+"/img_eventvs_text_event.png");title.setAnchorPoint(ZERO()),title.setPosition(90,585),this.addChild(title);var back_btn=new ccui.Button;return back_btn.loadTextures("btn_home_off.png","btn_home_on.png","",ccui.Widget.PLIST_TEXTURE),back_btn.setAnchorPoint(ZERO()),back_btn.setPosition(10,559),back_btn.addClickEventListener(function(){this.back()}.bind(this)),this.addChild(back_btn),this.m_bonus_effect_modal_layer=new GameModalLayer,this.addChild(this.m_bonus_effect_modal_layer),this.m_deferred.done(function(){this.scheduleOnce(function(){this.removeLayerProgress2()},.5)}.bind(this)),!0},onEnter:function(){this._super(),MainObserver.getInstance().addObserver(this.onNotification,this,sceneStr[scene_EventDungeonRewardBoardScene]);var event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx(),period=MasterManager.getInstance().get_EventDungeonPeriod(event_dungeon_period_idx);cmString(BGM_EVENT_DUNGEON_SCENE,period.event_dungeon_point_period_idx)},onExit:function(){this._super(),MainObserver.getInstance().removeObserver(sceneStr[scene_EventDungeonRewardBoardScene])},back:function(){this.onKeyBack(!0)},onNotification:function(msg){return!this._super(msg)},onNetworkEvent:function(opcode,state,body){if(opcode==net.OP.op_event_dungeon_point_reward_board_map&&body.error==net.ERROR.NET_E_SUCCESS){this.m_is_max_bonus=!1,this.m_is_last_bonus=!1;var mt=MasterTable.getInstance(),list=mt.get_EventDungeonRewardBoardMapBonus(body.event_dungeon_reward_board_map_idx),map_list=mt.get_EventDungeonRewardBoardMap(body.event_dungeon_reward_board_info_idx),board_info_list=mt.get_EventDungeonRewardBoardInfo(body.event_dungeon_period_idx),max_idx=0;if(0!=(map_list=stable(map_list,function(l,r){return l.order_num<r.order_num})).length&&(max_idx=map_list[0].event_dungeon_reward_board_map_idx),max_idx==body.event_dungeon_reward_board_map_idx){for(var found=!(this.m_is_max_bonus=!0),i=0;i<board_info_list.length;i++){var info=board_info_list[i];if(body.event_dungeon_reward_board_info_idx==info.open_reward_board_info_idx){found=!0;break}}0==found&&(this.m_is_last_bonus=!0)}var bonus_type=list[0].bonus_type,bonus_count=list[0].max_value,item_id=list[0].min_value;this.showBonusEffect(bonus_type,bonus_count,item_id),this.m_reward_layer.refreshRewardMapInfo(body)}},showBonusEffect:function(bonus_type,bonus_count,item_id){this.m_enalble_touch=!1;var audio=AudioEngine.getInstance();audio.stopEffectsAll(),audio.playEffect(RES_CDN_SOUND+SND_TYPE+"sound/SE_all_win_popularity.mp3",!1),audio.playEffect(RES_CDN_SOUND+SND_TYPE+"sound/SE_gacha_back.mp3",!1),this.m_bonus_effect_modal_layer.setContentSize(ccSize(this)),this.m_bonus_effect_modal_layer._contentNode=function(contentSize,m){var layer=new cc.Layer,back_effect=cc.Sprite.create("#img_attend_effect.png");back_effect.setPosition(ccCenter(this)),layer.addChild(back_effect);var action=new cc.RotateBy(1,180),repeat=new cc.RepeatForever(action);back_effect.runAction(repeat);var icon=cc.Sprite.create();icon.setPosition(ccCenter(this)),layer.addChild(icon);var bonus_name_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_503);bonus_name_label.setAnchorPoint(ANCHOR_MIDDLE_TOP()),bonus_name_label.enableOutline(cc.color.BLACK,3),bonus_name_label.setPosition(ccCenter(layer).x,ccHeight(layer)-180),layer.addChild(bonus_name_label);var mt=MasterManager.getInstance();if(bonus_type==BONUS_TYPE_YUNHEE_FIX){var general=mt.get_General(item_id),frame=cc.spriteFrameCache.getSpriteFrame("img_reward_"+leadingZeros(item_id,2)+"_d.png");icon.setSpriteFrame(frame),bonus_name_label.setString(general.name)}else{var bonus=mt.get_BonusType(bonus_type);frame=cc.spriteFrameCache.getSpriteFrame("img_reward_"+leadingZeros(bonus_type,2)+"_d.png");icon.setSpriteFrame(frame),bonus_name_label.setString(bonus.name)}var bonus_count_label=cmLabel.getLabel("x "+bonus_count,LABEL_FONT_INDEX.FONT_503);return bonus_count_label.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),bonus_count_label.enableOutline(cc.color.BLACK,3),bonus_count_label.setPosition(ccCenter(this).x,180),layer.addChild(bonus_count_label),layer}.bind(this),this.m_bonus_effect_modal_layer.show(),this.m_bonus_effect_modal_layer.onItemTouchBegin=function(){return!0},this.m_bonus_effect_modal_layer.onItemTouchEnd=function(){this.m_enalble_touch&&(AudioEngine.getInstance().stopEffectsAll(),this.m_is_max_bonus&&this.scheduleOnce(function(float){this.showMaxBonusReward()},.1,"showMaxBonusReward"),this.m_bonus_effect_modal_layer.hide());this.scheduleOnce(function(float){this.m_enalble_touch=!0},.3,"m_enalble_touch")}.bind(this)},showMaxBonusReward:function(){var mt=MasterManager.getInstance();this.m_box.setTitle(mt.get_LanguageData("label_shop_buy_jade_omission_title")),this.m_box.setText(mt.get_LanguageData("label_event_dungeon_reward_board_text_1")),this.m_box.setText("\n"),this.m_is_last_bonus||this.m_box.setText(mt.get_LanguageData("label_event_dungeon_reward_board_text_2")),this.m_box.addButtonInfo(new MessageButtonInfo(res_str("btn_label_confirm"),MessageBoxButtonType.ButtonTypeNormal,0,function(){this.m_box.hide(!1)}.bind(this))),this.m_box.show()}}),btn_replace_exchange=500,btn_replace_craft_shop=501,EventDungeonCraftShopEntranceLayer=cc.Layer.extend({_achv_new_icon:null,m_craft_shop_material_list:null,m_event_dungeon_cutin_accum_rate_point:null,m_period:null,m_gnrl_img:null,m_event_dungeon_point:null,m_event_dungeon_group_idx:0,m_first_half_period_idx:0,m_second_half_period_idx:0,m_is_prv_event_dungeon:!1,ctor:function(){this._super(),this.m_craft_shop_material_list=[],this.m_event_dungeon_cutin_accum_rate_point={},this.m_event_dungeon_point={},this.init()},init:function(){ccSize(this);var service=EventDungeonService.getInstance(),m=MasterManager.getInstance(),event_dungeon_period_idx=0;this.m_is_prv_event_dungeon=BattleContext._getInstance().getIsPrvEventDungeon(),event_dungeon_period_idx=this.m_is_prv_event_dungeon?BattleContext._getInstance().getPrvEventDungeonPeriodIdx():BattleContext._getInstance().getEventDungeonPeriodIdx(),this.m_period=m.get_EventDungeonPeriod(event_dungeon_period_idx);for(var open_period=(new NetService)._event_dungeon_open_period_info.event_dungeon_open_period,idx=0;idx<open_period.length;idx++){var e=open_period[idx];if(e.event_dungeon_period_idx==event_dungeon_period_idx){e;break}}this.m_event_dungeon_group_idx=this.m_period.event_dungeon_group_idx,BattleContext._getInstance().setEventDungeonPeriodIdX(this.m_event_dungeon_group_idx),this.m_first_half_period_idx=service.getEventDungeonFirstHalfPeriodIdx(this.m_event_dungeon_group_idx),this.m_second_half_period_idx=service.getEventDungeonSecondHalfPeriodIdx(this.m_event_dungeon_group_idx),service.getUserEventDungeonPoint(this.m_period.event_dungeon_period_idx,this.m_event_dungeon_point),this.m_craft_shop_material_list=service.getUserEventDungeonCraftShopMaterial(),service.getUserEventDungeonCutinAccumRatePoint(this.m_period.event_dungeon_period_idx,this.m_event_dungeon_cutin_accum_rate_point),this.m_gnrl_img=[],this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/bg_eventvs_main.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/btn_eventvs_war_1_off.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/btn_eventvs_war_1_on.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/btn_eventvs_war_2_off.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/btn_eventvs_war_2_on.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/btn_eventvs_1_off.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/btn_eventvs_1_on.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/btn_eventvs_2_off.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/btn_eventvs_2_on.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/btn_eventvs_2_on.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_1day_off.png",this.m_period.event_dungeon_group_idx)),this.m_gnrl_img.push(RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_1day_on.png",this.m_period.event_dungeon_group_idx)),this.m_gnrl_img.push(RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_1day_none.png",this.m_period.event_dungeon_group_idx)),this.m_gnrl_img.push(RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_1day_off.png",this.m_second_half_period_idx)),this.m_gnrl_img.push(RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_1day_on.png",this.m_second_half_period_idx)),this.m_gnrl_img.push(RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_1day_none.png",this.m_second_half_period_idx));var res_info_text_5=this.m_first_half_period_idx;return service.IsOpenDungeon(this.m_second_half_period_idx)&&(res_info_text_5=this.m_second_half_period_idx),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+res_info_text_5+"/img_eventvs_ic_text_5.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/img_eventvs_text_3.png"),cc.loader.load(this.m_gnrl_img,function(err,results){if(!err){var bg=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/bg_eventvs_main.png");bg.setPosition(ccCenter(this)),this.addChild(bg);var first_half_btn=new LabelButton(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/btn_eventvs_war_1_off.png",RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/btn_eventvs_war_1_on.png");first_half_btn.setAnchorPoint(ZERO()),first_half_btn.setPosition(LP(this,506,188)),this.addChild(first_half_btn),first_half_btn.addClickEventListener(function(){this.entranceDungeonList(this.m_first_half_period_idx)}.bind(this)),first_half_btn.setEnabled(service.IsOpenDungeon(this.m_first_half_period_idx));var second_half_btn=new LabelButton(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/btn_eventvs_war_2_off.png",RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/btn_eventvs_war_2_on.png",RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/btn_eventvs_war_2_lock.png");second_half_btn.setAnchorPoint(ZERO()),second_half_btn.setPosition(LP(this,649,72)),this.addChild(second_half_btn),second_half_btn.addClickEventListener(function(){this.entranceDungeonList(this.m_second_half_period_idx)}.bind(this)),second_half_btn.setEnabled(service.IsOpenDungeon(this.m_second_half_period_idx));var second_half_dis_btn=new LabelButton(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/btn_eventvs_war_2_lock.png",RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/btn_eventvs_war_2_lock.png",RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/btn_eventvs_war_2_lock.png");second_half_dis_btn.setAnchorPoint(ZERO()),second_half_dis_btn.setPosition(LP(this,649,72)),this.addChild(second_half_dis_btn),second_half_dis_btn.setVisible(!1),0==service.IsOpenDungeon(this.m_second_half_period_idx)&&second_half_dis_btn.setVisible(!0);var craft_shop_btn=new LabelButton(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/btn_eventvs_2_off.png",RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/btn_eventvs_2_on.png");craft_shop_btn.setAnchorPoint(ZERO()),craft_shop_btn.setPosition(LP(this,267,238)),this.addChild(craft_shop_btn),craft_shop_btn.addClickEventListener(function(){BattleContext._getInstance().setEventDungeonPeriodIdX(this.m_period.event_dungeon_group_idx),MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonCraftShopEntranceScene],btn_replace_craft_shop)}.bind(this));var material_exchange_btn=new LabelButton(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/btn_eventvs_1_off.png",RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/btn_eventvs_1_on.png");material_exchange_btn.setAnchorPoint(ZERO()),material_exchange_btn.setPosition(LP(this,25,89)),this.addChild(material_exchange_btn),material_exchange_btn.addClickEventListener(function(){BattleContext._getInstance().setEventDungeonPeriodIdX(this.m_period.event_dungeon_group_idx),MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonCraftShopEntranceScene],btn_replace_exchange)}.bind(this));var offset_x=ccWidth(this)-10,offset_y=20,achv_btn=new LabelButton("btn_eventvs_reward_off.png","btn_eventvs_reward_on.png","",ccui.Widget.PLIST_TEXTURE);if(achv_btn.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),achv_btn.setPosition(ccWidth(this)-10,offset_y),this.addChild(achv_btn,1),achv_btn.addClickEventListener(function(){if(USE_EVENT_DUNGEON_ACHIEVEMENT){var scene=new EventDungeonAchievementScene_V2;SceneManager.getInstance().replaceScene(scene)}else GameContext.getInstance().setAchievementTap(ACHIEVEMENT_EVENTDUNGEON),MainObserver.getInstance().postNotification(NOTIFY_MENU_ACHIEV)}),this.m_achv_new_icon=cc.Sprite.create(res.achv_btn),this.m_achv_new_icon.setAnchorPoint(ANCHOR_MIDDLE()),this.m_achv_new_icon.setPosition(ccWidth(achv_btn)-5,ccHeight(achv_btn)),achv_btn.addChild(this.m_achv_new_icon),this.m_achv_new_icon.setVisible(!1),null!=this.m_achv_new_icon)AchievementService.getInstance().isNewCompleteAchievementEventDungeon(this.m_period.event_dungeon_group_idx)?this.m_achv_new_icon.setVisible(!0):this.m_achv_new_icon.setVisible(!1);if(offset_y+=ccHeight(achv_btn)+10,!this.m_is_prv_event_dungeon){var limit_dungeon=new ccui.Button(RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_1day_off.png",this.m_period.event_dungeon_group_idx),RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_1day_on.png",this.m_period.event_dungeon_group_idx),RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_1day_none.png",this.m_period.event_dungeon_group_idx));limit_dungeon.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),limit_dungeon.setPosition(offset_x,offset_y),this.addChild(limit_dungeon),limit_dungeon.addClickEventListener(function(sender){this.entranceOnceADayDungeonList(this.m_first_half_period_idx,EVENT_DUNGEON_SUB_TYPE_ONCE)}.bind(this)),offset_y+=ccHeight(limit_dungeon)+10}var rightLayer=this.createRightLayer();rightLayer.ignoreAnchorPointForPosition(!1),rightLayer.setAnchorPoint(ANCHOR_TOP_RIGHT()),rightLayer.setPosition(ccWidth(this),ccHeight(this)-69),this.addChild(rightLayer);var idx=this.m_first_half_period_idx;service.IsOpenDungeon(this.m_second_half_period_idx)&&(idx=this.m_second_half_period_idx);var info_text_5=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+idx+"/img_eventvs_ic_text_5.png");info_text_5.setAnchorPoint(ZERO()),info_text_5.setPosition(ZERO()),this.addChild(info_text_5);var raidboss_service=RaidBossService.getInstance();!this.m_is_prv_event_dungeon&&raidboss_service.IsOpenRaidBoss();var help_btn=new ccui.Button("btn_help_off.png","btn_help_on.png","",ccui.Widget.PLIST_TEXTURE);help_btn.setAnchorPoint(ZERO()),help_btn.setPosition(10,476),this.addChild(help_btn),help_btn.addClickEventListener(function(sender){GameContext.getInstance().setHelpInfoIndexByCallIndex(2);var scene=new HelpContentScene;SceneManager.getInstance().pushScene(scene)}.bind(this))}}.bind(this)),!0},entranceDungeonList:function(event_dungeon_period_idx){if(!EventDungeonService.getInstance().IsOpenDungeon(event_dungeon_period_idx))return!1;BattleContext._getInstance().setEventDungeonPeriodIdX(event_dungeon_period_idx);var scene=new EventDungeonListScene;return SceneManager.getInstance().replaceScene(scene),!0},onEnter:function(){this._super()},onExit:function(){this._super();for(var idx=0;idx<this.m_gnrl_img.length;idx++)cc.loader.release(this.m_gnrl_img[idx])},createLeftLayer:function(){},createRightLayer:function(){var layer=new cc.Layer,bg=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/img_eventvs_text_3.png");if(bg.setAnchorPoint(ZERO()),bg.setPosition(ZERO()),layer.addChild(bg),layer.setContentSize(ccSize(bg)),null!=this.m_craft_shop_material_list)for(var idx=0;idx<this.m_craft_shop_material_list.length;idx++){var i=this.m_craft_shop_material_list[idx],count_label=cmLabel.getLabel(Number(i.material_count).toLocaleString("en")+"個",LABEL_FONT_INDEX.FONT_161);count_label.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),layer.addChild(count_label),i.craft_shop_bonus_type==CRAFT_SHOP_BONUS_TYPE_FIRST_LOW?count_label.setPosition(163,248):i.craft_shop_bonus_type==CRAFT_SHOP_BONUS_TYPE_FIRST_MIDDLE?count_label.setPosition(163,218):i.craft_shop_bonus_type==CRAFT_SHOP_BONUS_TYPE_FIRST_HIGH?count_label.setPosition(163,188):i.craft_shop_bonus_type==CRAFT_SHOP_BONUS_TYPE_FIRST_UNIQUE?count_label.setPosition(163,158):i.craft_shop_bonus_type==CRAFT_SHOP_BONUS_TYPE_SECOND_MIDDLE?count_label.setPosition(163,95):i.craft_shop_bonus_type==CRAFT_SHOP_BONUS_TYPE_SECOND_HIGH?count_label.setPosition(163,65):i.craft_shop_bonus_type==CRAFT_SHOP_BONUS_TYPE_SECOND_UNIQUE?count_label.setPosition(163,35):i.craft_shop_bonus_type==CRAFT_SHOP_BONUS_TYPE_TOTAL_LEGEND&&count_label.setPosition(163,5)}var service=EventDungeonService.getInstance(),mtrl_mask=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_half_period_idx+"/img_eventvs_lock_1.png");return mtrl_mask.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),mtrl_mask.setPosition(ccWidth(bg),0),layer.addChild(mtrl_mask),mtrl_mask.setVisible(!service.IsOpenDungeon(this.m_second_half_period_idx)),layer},refreshEventDungeonAchvNewIcon:function(){for(var service=EventDungeonService.getInstance(),period_list=MasterTable.getInstance().get_EventDungeonPeriodList(this.m_period.event_dungeon_group_idx),is_new=!1,i=0;i<period_list.length;i++){var p=period_list[i];if(service.IsOpenDungeon(p.event_dungeon_period_idx)&&service.IsEnableGainEventDungeonAchvReward(p.event_dungeon_period_idx)){is_new=!0;break}}null!=this.m_achv_new_icon&&this.m_achv_new_icon.setVisible(is_new)},entranceOnceADayDungeonList:function(event_dungeon_period_idx,sub_dungeon_type){if(!EventDungeonService.getInstance().IsOpenDungeon(event_dungeon_period_idx))return!1;GameContext.getInstance().setSubDungeonType(sub_dungeon_type),BattleContext._getInstance().setEventDungeonPeriodIdX(event_dungeon_period_idx);var scene=new EventOnceADayDungeonListScene;return SceneManager.getInstance().replaceScene(scene),!0}}),EventDungeonCraftShopEntranceScene=GameScene.extend({m_entrance_layer:null,m_gnrl_img:null,ctor:function(){this._super(scene_EventDungeonCraftShopEntranceScene),this.m_gnrl_img=[]},init:function(){this.initLayoutProgress2(),this.init_rayout()},init_rayout:function(){ccSize(this);var event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx();BattleContext._getInstance().setEventDungeonPeriodIdX(event_dungeon_period_idx),this.m_entrance_layer=new EventDungeonCraftShopEntranceLayer,this.addChild(this.m_entrance_layer);var statusLayer=new StatusLayer;statusLayer.initLayout(),statusLayer.ignoreAnchorPointForPosition(!1),statusLayer.setAnchorPoint(ANCHOR_TOP_RIGHT()),statusLayer.setPosition(ccWidth(this),ccHeight(this)),this.addChild(statusLayer);var period=MasterManager.getInstance().get_EventDungeonPeriod(event_dungeon_period_idx),title=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+period.event_dungeon_point_period_idx+"/img_eventvs_text_event.png");title.setAnchorPoint(ZERO()),title.setPosition(90,585),this.addChild(title);var back_btn=new ccui.Button;back_btn.loadTextures("btn_home_off.png","btn_home_on.png","",ccui.Widget.PLIST_TEXTURE),back_btn.setAnchorPoint(ZERO()),back_btn.setPosition(10,559),back_btn.addClickEventListener(function(){this.back()}.bind(this)),this.addChild(back_btn),this.scheduleOnce(this.removeProgressEnd,1.5)},removeProgressEnd:function(){this.removeLayerProgress2()},onEnter:function(){this._super(),MainObserver.getInstance().addObserver(this.onNotification,this,sceneStr[scene_EventDungeonCraftShopEntranceScene]);var event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx(),period=MasterManager.getInstance().get_EventDungeonPeriod(event_dungeon_period_idx),b_path=RES_CDN_SOUND+SND_TYPE+"sound/"+cmString(BGM_EVENT_DUNGEON_SCENE,period.event_dungeon_point_period_idx),audio=AudioEngine.getInstance();audio.m_bgmPath!=b_path&&(audio.stopBackgroundMusic(),audio.playBackgroundMusic(b_path,!0))},onExit:function(){this._super(),MainObserver.getInstance().removeObserver(sceneStr[scene_EventDungeonCraftShopEntranceScene])},onEnterTransitionDidFinish:function(){if(this._super(),USE_EVENT_DUNGEON_ACHIEVEMENT){var context=BattleContext._getInstance(),event_dungeon_period_idx=0;if(!context.getIsPrvEventDungeon()){event_dungeon_period_idx=context.getEventDungeonPeriodIdx();var period=MasterManager.getInstance().get_EventDungeonPeriod(event_dungeon_period_idx),req={};req.opcode=net.OP.op_user_event_dungeon_achv_list,req.event_dungeon_period_idx=period.event_dungeon_group_idx,this.network_write(req)}}},back:function(){BattleContext._getInstance().setIsPrvEventDungeon(!1);var cur=SceneManager.getInstance().getTopSceneId();if(0!=cur){cur==scene_BattleScene&&(cur=scene_MainHomeScene);var scene=this.replace_scene(cur);SceneManager.getInstance().replaceScene(scene,!1)}},onNotification:function(msg){if(!this._super(msg)){if(msg==btn_replace_craft_shop){var event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx(),res={};res.opcode=net.OP.op_get_user_event_dungeon_craft_shop_product_info,res.event_dungeon_period_idx=event_dungeon_period_idx,this.network_write(res)}else if(msg==btn_replace_exchange){var scene=new EventDungeonCraftShopExchangeScene;SceneManager.getInstance().replaceScene(scene)}return!0}},onNetworkEvent:function(opcode,state,body){if(opcode==net.OP.op_get_user_event_dungeon_craft_shop_product_info){if(body.error==net.ERROR.NET_E_SUCCESS){var scene=new EventDungeonCraftShopItemScene;SceneManager.getInstance().replaceScene(scene)}}else opcode==net.OP.op_user_event_dungeon_achv_list&&USE_EVENT_DUNGEON_ACHIEVEMENT&&this.m_entrance_layer.refreshEventDungeonAchvNewIcon()},onEnterTransitionDidFinish:function(){if(this._super(),USE_EVENT_DUNGEON_ACHIEVEMENT){var context=BattleContext._getInstance(),event_dungeon_period_idx=0;if(!context.getIsPrvEventDungeon()){event_dungeon_period_idx=context.getEventDungeonPeriodIdx();var period=MasterManager.getInstance().get_EventDungeonPeriod(event_dungeon_period_idx),req={};req.opcode=net.OP.op_user_event_dungeon_achv_list,req.event_dungeon_period_idx=period.event_dungeon_group_idx,this.network_write(req)}}}}),EventDungeonCraftShopExchangeItemListCell=cc.TableViewCell.extend({m_item_icon:null,m_product_name_label:null,m_mtrl_1_name_label:null,m_mtrl_2_name_label:null,_callback_make_item:null,_callback_plus_item:null,_callback_minus_item:null,m_mtrl_icon_1:null,m_mtrl_icon_2:null,m_select_mtrl_count_label:null,m_make_count:0,m_mask:null,m_plus_icon:null,m_mtrl_1_count_label:null,m_mtrl_2_count_label:null,m_remain_count_label:null,m_product_count_label:null,m_plus_sprite:null,m_minus_sprite:null,m_select_sprite:null,m_resourceList:null,m_CountSlider:null,_callback_slider_item:null,ctor:function(){this._super(),this.m_plus_sprite=[],this.m_minus_sprite=[],this.m_select_sprite=[],this.m_plus_sprite=[],this.init()},init:function(){if(USE_CRAFTSHOP_SCROLL_BAR){var cellSize=cc.size(646,178);this.setContentSize(cellSize),(list_bg=cc.Scale9Sprite.create(RES_CDN_DEFULT+"menu_yh/img_yh_info_box.png",cc.Rect(20,20,20,20))).setAnchorPoint(ZERO()),list_bg.setPosition(ZERO()),list_bg.setPreferredSize(cellSize),this.addChild(list_bg),(box_arrow=cc.Sprite.create(RES_CDN_DEFULT+"common/img_box_arrow.png")).setAnchorPoint(ZERO()),box_arrow.setPosition(134,67),list_bg.addChild(box_arrow),this.m_item_icon=cc.Sprite.create(),this.m_item_icon.setAnchorPoint(ANCHOR_TOP_LEFT()),this.m_item_icon.setPosition(12,ccHeight(list_bg)-25),list_bg.addChild(this.m_item_icon),this.m_product_name_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_1614),this.m_product_name_label.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_product_name_label.setPosition(68,21),list_bg.addChild(this.m_product_name_label),(mtrl_bg_box=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_info_box_4.png",RectZero())).setPreferredSize(cc.size(228,96)),mtrl_bg_box.setAnchorPoint(ZERO()),mtrl_bg_box.setPosition(199,48),list_bg.addChild(mtrl_bg_box),(mtrl_bg_box_arrow=cc.Sprite.create(RES_CDN_DEFULT+"common/img_box_arrow_3.png")).setAnchorPoint(ANCHOR_MIDDLE_LEFT()),mtrl_bg_box_arrow.setPosition(180,96),list_bg.addChild(mtrl_bg_box_arrow),this.m_product_count_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_181),this.m_product_count_label.enableOutline(cc.color.BLACK,2),this.m_product_count_label.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_item_icon.addChild(this.m_product_count_label),this.m_mtrl_icon_1=cc.Sprite.create(),this.m_mtrl_icon_1.setAnchorPoint(ZERO()),this.m_mtrl_icon_1.setPosition(13,8),mtrl_bg_box.addChild(this.m_mtrl_icon_1),this.m_mtrl_1_name_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_1614),this.m_mtrl_1_name_label.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_mtrl_1_name_label.setPosition(252,26),list_bg.addChild(this.m_mtrl_1_name_label),this.m_mtrl_1_count_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_181),this.m_mtrl_1_count_label.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_mtrl_1_count_label.enableOutline(cc.color.BLACK,2),this.m_mtrl_icon_1.addChild(this.m_mtrl_1_count_label),this.m_plus_icon=cc.Sprite.create(RES_CDN_DEFULT+"common/img_plus.png"),this.m_plus_icon.setAnchorPoint(ZERO()),this.m_plus_icon.setPosition(104,39),mtrl_bg_box.addChild(this.m_plus_icon),this.m_plus_icon.setVisible(!1),this.m_mtrl_icon_2=cc.Sprite.create(),this.m_mtrl_icon_2.setAnchorPoint(ZERO()),this.m_mtrl_icon_2.setPosition(133,8),mtrl_bg_box.addChild(this.m_mtrl_icon_2),this.m_mtrl_2_name_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_1614),this.m_mtrl_2_name_label.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_mtrl_2_name_label.setPosition(374,26),list_bg.addChild(this.m_mtrl_2_name_label),this.m_mtrl_2_count_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_181),this.m_mtrl_2_count_label.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_mtrl_2_count_label.enableOutline(cc.color.BLACK,2),this.m_mtrl_icon_2.addChild(this.m_mtrl_2_count_label);var offset_x=18,offset_y=16;(nor=cc.Sprite.create("#btn_spinner_plus_off.png")).setAnchorPoint(ANCHOR_TOP_RIGHT()),nor.setPosition(ccWidth(list_bg)-offset_x,ccHeight(list_bg)-offset_y),list_bg.addChild(nor),this.m_plus_sprite.push(nor),(on=cc.Sprite.create("#btn_spinner_plus_on.png")).setAnchorPoint(ANCHOR_TOP_RIGHT()),on.setPosition(ccWidth(list_bg)-offset_x,ccHeight(list_bg)-offset_y),list_bg.addChild(on),on.setVisible(!1),this.m_plus_sprite.push(on),offset_x+=ccWidth(nor)+18,(count_box=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_info_box.png",RectZero())).setAnchorPoint(ANCHOR_TOP_RIGHT()),count_box.setPosition(ccWidth(list_bg)-offset_x,ccHeight(list_bg)-offset_y),count_box.setPreferredSize(cc.size(61,40)),list_bg.addChild(count_box),offset_x+=ccWidth(count_box)+18,this.m_select_mtrl_count_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_201),this.m_select_mtrl_count_label.setAnchorPoint(ANCHOR_MIDDLE()),this.m_select_mtrl_count_label.setPosition(ccCenter(count_box)),count_box.addChild(this.m_select_mtrl_count_label),(nor=cc.Sprite.create("#btn_spinner_minus_off.png")).setAnchorPoint(ANCHOR_TOP_RIGHT()),nor.setPosition(ccWidth(list_bg)-offset_x,ccHeight(list_bg)-offset_y),list_bg.addChild(nor),this.m_minus_sprite.push(nor),(on=cc.Sprite.create("#btn_spinner_minus_on.png")).setAnchorPoint(ANCHOR_TOP_RIGHT()),on.setPosition(ccWidth(list_bg)-offset_x,ccHeight(list_bg)-offset_y),list_bg.addChild(on),on.setVisible(!1),this.m_minus_sprite.push(on),offset_x=18,(nor=cc.Sprite.create("#btn_17_off.png")).setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),nor.setPosition(ccWidth(list_bg)-offset_x,12),(nor_label=cmLabel.getLabel(res_str("btn_label_craft_shop_mtrl_select"),LABEL_FONT_INDEX.FONT_241)).setAnchorPoint(ANCHOR_MIDDLE()),nor_label.setPosition(ccCenter(nor)),nor.addChild(nor_label),list_bg.addChild(nor),this.m_select_sprite.push(nor),(on=cc.Sprite.create("#btn_17_on.png")).setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),on.setPosition(ccWidth(list_bg)-offset_x,12),(on_label=cmLabel.getLabel(res_str("btn_label_craft_shop_mtrl_select"),LABEL_FONT_INDEX.FONT_242)).setAnchorPoint(ANCHOR_MIDDLE()),on_label.setPosition(ccCenter(on)),on.addChild(on_label),list_bg.addChild(on),on.setVisible(!1),this.m_select_sprite.push(on),offset_y=12+ccHeight(nor)+16,this.m_CountSlider=new ccui.Slider,this.m_CountSlider.setTouchEnabled(!0),this.m_CountSlider.setScale9Enabled(!0),this.m_CountSlider.loadBarTexture(RES_CDN_DEFULT+"common/img_gauge_frame_02.png"),this.m_CountSlider.loadSlidBallTextures(RES_CDN_DEFULT+"menu_yh/img_yh_feel_gauge_toggle.png",RES_CDN_DEFULT+"menu_yh/img_yh_feel_gauge_toggle.png",""),this.m_CountSlider.loadProgressBarTexture(RES_CDN_DEFULT+"common/img_gauge_green_02.png"),this.m_CountSlider.setCapInsets(cc.rect(0,0,0,0)),this.m_CountSlider.setContentSize(cc.size(190,16)),this.m_CountSlider.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),this.m_CountSlider.setPosition(ccWidth(list_bg)-offset_x,offset_y+6),this.m_CountSlider.addEventListener(this.SlideCallback,this),this.m_CountSlider.setPercent(0),this.addChild(this.m_CountSlider),this.m_mask=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_btn_mask.png",RectZero()),this.m_mask.setPreferredSize(ccSize(this)),this.m_mask.setAnchorPoint(ZERO()),this.m_mask.setPosition(ZERO()),this.addChild(this.m_mask),this.m_mask.setVisible(!1),(lock_icon=cc.Sprite.create(RES_CDN_DEFULT+"common/img_list_lock.png")).setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),lock_icon.setPosition(ccCenter(this.m_mask).x,-10),this.m_mask.addChild(lock_icon)}else{var list_bg,box_arrow,mtrl_bg_box,mtrl_bg_box_arrow,count_box,nor,nor_label,on,on_label,lock_icon;cellSize=cc.size(646,148);this.setContentSize(cellSize),(list_bg=cc.Scale9Sprite.create(RES_CDN_DEFULT+"menu_yh/img_yh_info_box.png",RectZero())).setAnchorPoint(ZERO()),list_bg.setPosition(ZERO()),list_bg.setPreferredSize(cellSize),this.addChild(list_bg),(box_arrow=cc.Sprite.create(RES_CDN_DEFULT+"common/img_box_arrow.png")).setAnchorPoint(ZERO()),box_arrow.setPosition(134,57),list_bg.addChild(box_arrow),this.m_item_icon=cc.Sprite.create(),this.m_item_icon.setAnchorPoint(ZERO()),this.m_item_icon.setPosition(12,29),list_bg.addChild(this.m_item_icon),this.m_product_name_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_1614),this.m_product_name_label.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_product_name_label.setPosition(68,11),list_bg.addChild(this.m_product_name_label),(mtrl_bg_box=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_info_box_4.png",RectZero())).setPreferredSize(cc.size(228,96)),mtrl_bg_box.setAnchorPoint(ZERO()),mtrl_bg_box.setPosition(199,38),list_bg.addChild(mtrl_bg_box),(mtrl_bg_box_arrow=cc.Sprite.create(RES_CDN_DEFULT+"common/img_box_arrow_3.png")).setAnchorPoint(ZERO()),mtrl_bg_box_arrow.setPosition(180,67),list_bg.addChild(mtrl_bg_box_arrow),this.m_product_count_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_181),this.m_product_count_label.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_product_count_label.enableOutline(cc.color.BLACK,2),this.m_item_icon.addChild(this.m_product_count_label),this.m_mtrl_icon_1=cc.Sprite.create(),this.m_mtrl_icon_1.setAnchorPoint(ZERO()),this.m_mtrl_icon_1.setPosition(13,8),mtrl_bg_box.addChild(this.m_mtrl_icon_1),this.m_mtrl_1_name_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_1614),this.m_mtrl_1_name_label.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_mtrl_1_name_label.setPosition(252,16),list_bg.addChild(this.m_mtrl_1_name_label),this.m_mtrl_1_count_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_181),this.m_mtrl_1_count_label.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_mtrl_1_count_label.enableOutline(cc.color.BLACK,1),this.m_mtrl_icon_1.addChild(this.m_mtrl_1_count_label),this.m_plus_icon=cc.Sprite.create(RES_CDN_DEFULT+"common/img_plus.png"),this.m_plus_icon.setAnchorPoint(ZERO()),this.m_plus_icon.setPosition(104,39),mtrl_bg_box.addChild(this.m_plus_icon),this.m_plus_icon.setVisible(!1),this.m_mtrl_icon_2=cc.Sprite.create(),this.m_mtrl_icon_2.setAnchorPoint(ZERO()),this.m_mtrl_icon_2.setPosition(133,8),mtrl_bg_box.addChild(this.m_mtrl_icon_2),this.m_mtrl_2_name_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_1614),this.m_mtrl_2_name_label.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_mtrl_2_name_label.setPosition(374,16),list_bg.addChild(this.m_mtrl_2_name_label),this.m_mtrl_2_count_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_181),this.m_mtrl_2_count_label.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_mtrl_2_count_label.enableOutline(cc.color.BLACK,2),this.m_mtrl_icon_2.addChild(this.m_mtrl_2_count_label),(count_box=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_info_box.png",RectZero())).setAnchorPoint(ZERO()),count_box.setPosition(505,88),count_box.setPreferredSize(cc.size(61,40)),list_bg.addChild(count_box),this.m_select_mtrl_count_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_201),this.m_select_mtrl_count_label.setAnchorPoint(ANCHOR_MIDDLE()),this.m_select_mtrl_count_label.setPosition(ccCenter(count_box)),count_box.addChild(this.m_select_mtrl_count_label),(nor=cc.Sprite.create("#btn_spinner_plus_off.png")).setAnchorPoint(ZERO()),nor.setPosition(583,88),list_bg.addChild(nor),this.m_plus_sprite.push(nor),(on=cc.Sprite.create("#btn_spinner_plus_on.png")).setAnchorPoint(ZERO()),on.setPosition(583,88),list_bg.addChild(on),on.setVisible(!1),this.m_plus_sprite.push(on),(nor=cc.Sprite.create("#btn_spinner_minus_off.png")).setAnchorPoint(ZERO()),nor.setPosition(442,88),list_bg.addChild(nor),this.m_minus_sprite.push(nor),(on=cc.Sprite.create("#btn_spinner_minus_on.png")).setAnchorPoint(ZERO()),on.setPosition(442,88),list_bg.addChild(on),on.setVisible(!1),this.m_minus_sprite.push(on),(nor=cc.Sprite.create("#btn_17_off.png")).setAnchorPoint(ZERO()),nor.setPosition(442,19),(nor_label=cmLabel.getLabel("製錬する",LABEL_FONT_INDEX.FONT_241)).setAnchorPoint(ANCHOR_MIDDLE()),nor_label.setPosition(ccCenter(nor)),nor.addChild(nor_label),list_bg.addChild(nor),this.m_select_sprite.push(nor),(on=cc.Sprite.create("#btn_17_on.png")).setAnchorPoint(ZERO()),on.setPosition(442,19),(on_label=cmLabel.getLabel("製錬する",LABEL_FONT_INDEX.FONT_242)).setAnchorPoint(ANCHOR_MIDDLE()),on_label.setPosition(ccCenter(on)),on.addChild(on_label),list_bg.addChild(on),on.setVisible(!1),this.m_select_sprite.push(on),this.m_mask=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_btn_mask.png",RectZero()),this.m_mask.setPreferredSize(ccSize(this)),this.m_mask.setAnchorPoint(ZERO()),this.m_mask.setPosition(ZERO()),this.addChild(this.m_mask),this.m_mask.setVisible(!1),(lock_icon=cc.Sprite.create(RES_CDN_DEFULT+"common/img_list_lock.png")).setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),lock_icon.setPosition(ccCenter(this.m_mask).x,-10),this.m_mask.addChild(lock_icon)}return!0},setItemData:function(item,make_count){this.m_item_data=item,this.m_make_count=make_count,this.updateCellLayout()},updateCellLayout:function(){var m=MasterManager.getInstance(),g=GeneralService.getInstance(),es=EventDungeonService.getInstance(),event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx(),period=m.get_EventDungeonPeriod(event_dungeon_period_idx),cb=m.get_CraftShopBonusType(this.m_item_data.craft_shop_bonus_type);this.m_item_icon.setTexture(RES_CDN_DEFULT+"menu_eventvs_"+period.event_dungeon_group_idx+"/btn_eventvs_ic_"+this.m_item_data.craft_shop_bonus_type+"_off.png"),this.m_item_icon.setContentSize(104,104),this.m_product_name_label.setString(cb.name),this.m_product_count_label.setString(cmString("x%s",Number(this.m_item_data.craft_bonus_count).toLocaleString("en"))),this.m_product_count_label.setPosition(ccCenter(this.m_item_icon).x,10);var mtrl_craft_shop_bonus_type_1=g.getBonusTypeToCraftShopMtrlType(this.m_item_data.bonus_type);if(this.m_mtrl_icon_1.setTexture(RES_CDN_DEFULT+"menu_eventvs_"+period.event_dungeon_group_idx+"/btn_eventvs_ic_small_"+mtrl_craft_shop_bonus_type_1+"_off.png"),this.m_mtrl_icon_1.setContentSize(40,40),this.m_mtrl_1_count_label.setString("x"+this.m_item_data.need_count),this.m_mtrl_1_count_label.setPosition(ccCenter(this.m_mtrl_icon_1).x+20,10),cb=m.get_CraftShopBonusType(mtrl_craft_shop_bonus_type_1),this.m_mtrl_1_name_label.setString(cb.name),0!=this.m_item_data.bonus_type_2){var mtrl_craft_shop_bonus_type_2=g.getBonusTypeToCraftShopMtrlType(this.m_item_data.bonus_type_2);this.m_plus_icon.setVisible(!0),this.m_mtrl_icon_2.setTexture(RES_CDN_DEFULT+"menu_eventvs_"+period.event_dungeon_group_idx+"/btn_eventvs_ic_small_"+mtrl_craft_shop_bonus_type_2+"_off.png"),this.m_mtrl_icon_2.setContentSize(60,60),this.m_mtrl_2_count_label.setString("x"+Number(this.m_item_data.need_count_2).toLocaleString("en")),this.m_mtrl_2_count_label.setPosition(ccCenter(this.m_mtrl_icon_2).x,10),cb=m.get_CraftShopBonusType(mtrl_craft_shop_bonus_type_2),this.m_mtrl_2_name_label.setString(cb.name)}else this.m_plus_icon.setVisible(!1),this.m_mtrl_icon_2.setTexture(RES_CDN_DEFULT+"common/img_point.png"),this.m_mtrl_2_name_label.setString(""),this.m_mtrl_2_count_label.setString("");this.m_select_sprite.at(0).setVisible(!0),this.m_select_sprite.at(1).setVisible(!1),this.m_plus_sprite.at(0).setVisible(!0),this.m_plus_sprite.at(1).setVisible(!1),this.m_minus_sprite.at(0).setVisible(!0),this.m_minus_sprite.at(1).setVisible(!1),this.m_select_mtrl_count_label.setString(cmString("%d",this.m_make_count));var MaxCount=Math.floor(es.MakeCountCraftShopMtrl(this.m_item_data.material_exchange_id));if(MaxCount<1)this.m_CountSlider.setPercent(0),this.m_CountSlider.setEnabled(!1),this.m_select_sprite.at(0).setVisible(!1),this.m_select_sprite.at(1).setVisible(!0);else{var percent=(this.m_make_count/MaxCount*100).toFixed(1);this.m_CountSlider.setPercent(percent),this.m_CountSlider.setEnabled(!0),0==this.m_make_count?(this.m_select_sprite.at(0).setVisible(!1),this.m_select_sprite.at(1).setVisible(!0)):(this.m_select_sprite.at(0).setVisible(!0),this.m_select_sprite.at(1).setVisible(!1))}var service=EventDungeonService.getInstance();this.m_mask.setVisible(!service.isMakeCraftShopMtrlFirstSecondHalf(this.m_item_data.craft_shop_bonus_type))},highlightPosInCell:function(pos){if(EventDungeonService.getInstance().isMakeCraftShopMtrlFirstSecondHalf(this.m_item_data.craft_shop_bonus_type)){var box=this.m_select_sprite[0],r=box.getBoundingBox();cc.rectContainsPoint(r,pos)&&(this.m_select_sprite[0].setVisible(!1),this.m_select_sprite[1].setVisible(!0),AudioEngine.getInstance().playEffect(RES_CDN_SOUND+SND_TYPE+"sound/"+EFT_NORMAL_BUTTON)),r=(box=this.m_plus_sprite[0]).getBoundingBox(),cc.rectContainsPoint(r,pos)&&(this.m_plus_sprite[0].setVisible(!1),this.m_plus_sprite[1].setVisible(!0),AudioEngine.getInstance().playEffect(RES_CDN_SOUND+SND_TYPE+"sound/"+EFT_NORMAL_BUTTON)),r=(box=this.m_minus_sprite[0]).getBoundingBox(),cc.rectContainsPoint(r,pos)&&(this.m_minus_sprite[0].setVisible(!1),this.m_minus_sprite[1].setVisible(!0),AudioEngine.getInstance().playEffect(RES_CDN_SOUND+SND_TYPE+"sound/"+EFT_NORMAL_BUTTON))}},unhighlightPosInCell:function(pos){(new EventDungeonService.getInstance).isMakeCraftShopMtrlFirstSecondHalf(this.m_item_data.craft_shop_bonus_type)&&(0<this.m_make_count?(this.m_select_sprite.at(0).setVisible(!0),this.m_select_sprite.at(1).setVisible(!1)):(this.m_select_sprite.at(0).setVisible(!1),this.m_select_sprite.at(1).setVisible(!0)),this.m_plus_sprite.at(0).setVisible(!0),this.m_plus_sprite.at(1).setVisible(!1),this.m_minus_sprite.at(0).setVisible(!0),this.m_minus_sprite.at(1).setVisible(!1))},tableCellEnded:function(){},touchPosInCell:function(pos){if((new EventDungeonService.getInstance).isMakeCraftShopMtrlFirstSecondHalf(this.m_item_data.craft_shop_bonus_type)){var box=this.m_select_sprite[0],r=box.getBoundingBox();if(cc.rectContainsPoint(r,pos))if(0<this.m_make_count){if(this.m_select_sprite.at(0).setVisible(!0),this.m_select_sprite.at(1).setVisible(!1),null!=this._callback_make_item){var idx=this.getIdx();this._callback_make_item(idx)}}else this.m_select_sprite.at(0).setVisible(!1),this.m_select_sprite.at(1).setVisible(!0);if(r=(box=this.m_plus_sprite[0]).getBoundingBox(),cc.rectContainsPoint(r,pos)&&(this.m_plus_sprite[0].setVisible(!0),this.m_plus_sprite[1].setVisible(!1),null!=this._callback_plus_item)){idx=this.getIdx();this._callback_plus_item(idx)}if(r=(box=this.m_minus_sprite[0]).getBoundingBox(),cc.rectContainsPoint(r,pos)&&(this.m_minus_sprite[0].setVisible(!0),this.m_minus_sprite[1].setVisible(!1),null!=this._callback_minus_item)){idx=this.getIdx();this._callback_minus_item(idx)}}},SlideCallback:function(sender,type){var slider=sender,idx=this.getIdx(),now=slider.getPercent();0<=idx&&null!=this._callback_slider_item&&this._callback_slider_item(idx,now)}}),SELECTED_1_TAG=1,SELECTED_2_TAG=2,not_enough_mtrl_count=1,btn_exchange_start=2,EventDungeonCraftShopExchangeLayer=cc.Layer.extend({m_item_select_idx:-1,m_tableView:null,m_exchange_list:[],m_make_count_list:[],m_map_mtrl_label:[],m_event_dungeon_group_idx:0,m_first_half_period_idx:0,m_second_half_period_idx:0,ctor:function(){this.m_exchange_list=[],this.m_make_count_list=[],this.m_map_mtrl_label=[],this._super(),this.m_first_half_period_idx=0,this.m_second_half_period_idx=0,this.init()},init:function(){var m=MasterManager.getInstance(),service=EventDungeonService.getInstance(),event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx(),period=m.get_EventDungeonPeriod(event_dungeon_period_idx);this.m_event_dungeon_group_idx=period.event_dungeon_group_idx,this.m_first_half_period_idx=service.getEventDungeonFirstHalfPeriodIdx(this.m_event_dungeon_group_idx),this.m_second_half_period_idx=service.getEventDungeonSecondHalfPeriodIdx(this.m_event_dungeon_group_idx);var bg=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_half_period_idx+"/bg_eventvs_sub.png");bg.setPosition(ccCenter(this)),this.addChild(bg);var character=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_half_period_idx+"/img_evevtvs_ct.png");character.setAnchorPoint(ZERO()),character.setPosition(ZERO()),bg.addChild(character);var talk_box=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_first_half_period_idx+"/img_evevtvs_ct_bubbletext_2.png");talk_box.setAnchorPoint(ZERO()),talk_box.setPosition(273,488),bg.addChild(talk_box);var mt=MasterTable.getInstance();this.m_exchange_list=mt.get_EventDungeonMaterialExchangeList(),this.setSelectMtrlCountList();var status_layer=this.getMaterialStatusLayer();status_layer.ignoreAnchorPointForPosition(!1),status_layer.setAnchorPoint(ANCHOR_TOP_RIGHT()),status_layer.setPosition(ccWidth(this)-10,ccHeight(this)-58),this.addChild(status_layer),this.updateUserMtrl();var bg_box=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_script_box_2.png",RectZero());bg_box.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),bg_box.setPreferredSize(cc.size(680,485)),bg_box.setInsetLeft(44),bg_box.setInsetRight(44),bg_box.setInsetBottom(44),bg_box.setInsetTop(44),bg_box.setPosition(ccWidth(this),0),this.addChild(bg_box,1);var navi=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_navi.png",RectZero());navi.setPreferredSize(cc.size(664,48)),navi.setAnchorPoint(ANCHOR_TOP_LEFT()),navi.setPosition(8,ccHeight(bg_box)-11),bg_box.addChild(navi);var title_label=cmLabel.getLabel("素材製錬所",LABEL_FONT_INDEX.FONT_261);title_label.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),title_label.setPosition(ccCenter(navi).x,14),navi.addChild(title_label);var tSize=cc.size(646,382);this.m_tableView=new cc.TableView(this,tSize),this.m_tableView.setDirection(cc.SCROLLVIEW_DIRECTION_VERTICAL),this.m_tableView.scrollBarEnable(!0),this.m_tableView.setVerticalFillOrder(0),this.m_tableView.setPosition(17,18),this.m_tableView.setDelegate(this),bg_box.addChild(this.m_tableView);var cmplt_item_title=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_info_box_3.png",RectZero());cmplt_item_title.setInsetLeft(19),cmplt_item_title.setInsetRight(19),cmplt_item_title.setPreferredSize(cc.size(136,31)),cmplt_item_title.setAnchorPoint(ZERO()),cmplt_item_title.setPosition(18,393),bg_box.addChild(cmplt_item_title);var cmplt_item_title_label=cmLabel.getLabel("獲得できるアイテム",LABEL_FONT_INDEX.FONT_144);cmplt_item_title_label.setAnchorPoint(ANCHOR_MIDDLE()),cmplt_item_title_label.setPosition(ccCenter(cmplt_item_title)),cmplt_item_title.addChild(cmplt_item_title_label);var mtrl_item_title=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_info_box_3.png",RectZero());mtrl_item_title.setInsetLeft(19),mtrl_item_title.setInsetRight(19),mtrl_item_title.setPreferredSize(cc.size(216,31)),mtrl_item_title.setAnchorPoint(ZERO()),mtrl_item_title.setPosition(222,393),bg_box.addChild(mtrl_item_title);var mtrl_item_title_label=cmLabel.getLabel("生産に必要となる素材",LABEL_FONT_INDEX.FONT_165);mtrl_item_title_label.setAnchorPoint(ANCHOR_MIDDLE()),mtrl_item_title_label.setPosition(ccCenter(mtrl_item_title)),mtrl_item_title.addChild(mtrl_item_title_label),tSize=null},getMaterialStatusLayer:function(){var layer=new cc.Layer,service=EventDungeonService.getInstance(),m=MasterManager.getInstance(),event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx(),status_bg=(m.get_EventDungeonPeriod(event_dungeon_period_idx),cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/img_eventvs_state.png"));status_bg.setAnchorPoint(ZERO()),status_bg.setPosition(ZERO()),layer.addChild(status_bg),layer.setContentSize(ccSize(status_bg));for(var i=4;i<=11;++i){var label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_161);label.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),layer.addChild(label),i==CRAFT_SHOP_BONUS_TYPE_FIRST_LOW?label.setPosition(103,38):i==CRAFT_SHOP_BONUS_TYPE_FIRST_MIDDLE?label.setPosition(224,38):i==CRAFT_SHOP_BONUS_TYPE_FIRST_HIGH?label.setPosition(103,6):i==CRAFT_SHOP_BONUS_TYPE_FIRST_UNIQUE?label.setPosition(224,6):i==CRAFT_SHOP_BONUS_TYPE_SECOND_MIDDLE?label.setPosition(346,38):i==CRAFT_SHOP_BONUS_TYPE_SECOND_HIGH?label.setPosition(468,38):i==CRAFT_SHOP_BONUS_TYPE_SECOND_UNIQUE?label.setPosition(346,6):i==CRAFT_SHOP_BONUS_TYPE_TOTAL_LEGEND&&label.setPosition(468,6),this.m_map_mtrl_label[i]=label}var mask=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/img_eventvs_lock_4.png");return mask.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),mask.setPosition(ccWidth(layer),0),layer.addChild(mask),mask.setVisible(!service.IsOpenDungeon(this.m_second_half_period_idx)),layer},updateUserMtrl:function(){for(var list=EventDungeonService.getInstance().getUserEventDungeonCraftShopMaterial(),idx=0;idx<list.length;idx++){var mtrl=list[idx];this.m_map_mtrl_label[mtrl.craft_shop_bonus_type].setString(Number(mtrl.material_count).toLocaleString("en"))}},exchangeComplete:function(){this.updateUserMtrl(),this.setSelectMtrlCountList();var offset=this.m_tableView.getContentOffset();this.m_tableView.reloadData(),this.m_tableView.setContentOffset(offset)},getExchangeItemInfo:function(){var material_exchange_id=this.m_exchange_list[this.m_item_select_idx].material_exchange_id;return{exchange_id:material_exchange_id,count:this.m_make_count_list[material_exchange_id]}},setSelectMtrlCountList:function(){for(var idx=0;idx<this.m_exchange_list.length;idx++)if(USE_CRAFTSHOP_SCROLL_BAR){var i=this.m_exchange_list[idx];this.m_make_count_list[i.material_exchange_id]=0}else{i=this.m_exchange_list[idx];this.m_make_count_list[i.material_exchange_id]=1}},makeItem:function(idx){var es=EventDungeonService.getInstance();this.m_item_select_idx=idx;for(var used=this.m_tableView.getCellsUsed(),jdx=0;jdx<used.length;jdx++){var uc=used[jdx];this.m_tableView.updateCellAtIndex(uc.getIdx())}var item=this.m_exchange_list[this.m_item_select_idx],make_cnt=this.m_make_count_list[item.material_exchange_id];es.isMakeCraftShopMtrl(item.material_exchange_id,make_cnt)?MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonCraftShopExchangeScene],btn_exchange_start):MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonCraftShopExchangeScene],not_enough_mtrl_count)},plusItem:function(idx){var es=EventDungeonService.getInstance();this.m_item_select_idx=idx;for(var used=this.m_tableView.getCellsUsed(),jdx=0;jdx<used.length;jdx++){var uc=used[jdx];this.m_tableView.updateCellAtIndex(uc.getIdx())}var item=this.m_exchange_list[this.m_item_select_idx],cnt=this.m_make_count_list[item.material_exchange_id];if(cnt++,es.isMakeCraftShopMtrl(item.material_exchange_id,cnt)){this.m_make_count_list[item.material_exchange_id]=cnt;var offset=this.m_tableView.getContentOffset();this.m_tableView.reloadData(),this.m_tableView.setContentOffset(offset)}else MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonCraftShopExchangeScene],not_enough_mtrl_count)},minusItem:function(idx){this.m_item_select_idx=idx;for(var used=this.m_tableView.getCellsUsed(),jdx=0;jdx<used.length;jdx++){var uc=used[jdx];this.m_tableView.updateCellAtIndex(uc.getIdx())}var item=this.m_exchange_list[this.m_item_select_idx],cnt=this.m_make_count_list[item.material_exchange_id];--cnt<=0&&(cnt=0),this.m_make_count_list[item.material_exchange_id]=cnt;var offset=this.m_tableView.getContentOffset();this.m_tableView.reloadData(),this.m_tableView.setContentOffset(offset)},sliderItem:function(idx,count){this.m_item_select_idx=idx;var item=this.m_exchange_list[this.m_item_select_idx],cnt=(EventDungeonService.getInstance().MakeCountCraftShopMtrl(item.material_exchange_id)*count*.01).toFixed(1);this.m_make_count_list[item.material_exchange_id]=Math.floor(cnt);for(var used=this.m_tableView.getCellsUsed(),jdx=0;jdx<used.length;jdx++){used[jdx].getIdx()==idx&&(this.m_tableView._cellsUsed._saveObjectArr[jdx].m_select_mtrl_count_label.setString(cmString("%d",this.m_make_count_list[item.material_exchange_id])),0==this.m_make_count_list[item.material_exchange_id]?(this.m_tableView._cellsUsed._saveObjectArr[jdx].m_select_sprite.at(0).setVisible(!1),this.m_tableView._cellsUsed._saveObjectArr[jdx].m_select_sprite.at(1).setVisible(!0)):(this.m_tableView._cellsUsed._saveObjectArr[jdx].m_select_sprite.at(0).setVisible(!0),this.m_tableView._cellsUsed._saveObjectArr[jdx].m_select_sprite.at(1).setVisible(!1)))}},onEnter:function(){this._super()},onExit:function(){this._super()},cellSizeForTable:function(table){var visibleSize=cc.size();USE_CRAFTSHOP_SCROLL_BAR?visibleSize.setSize(646,178):visibleSize.setSize(646,148)},tableCellSizeForIndex:function(){return cc.size(646,178)},tableCellEnded:function(param){for(var used=this.m_tableView.getCellsUsed(),jdx=0;jdx<used.length;jdx++){var uc=used[jdx];uc.m_select_sprite[0].setVisible(!0),uc.m_select_sprite[1].setVisible(!1),this.m_tableView.updateCellAtIndex(uc.getIdx())}var offset=this.m_tableView.getContentOffset();this.m_tableView.reloadData(),this.m_tableView.setContentOffset(offset)},tableCellAtIndex:function(table,idx){var c=table.dequeueCell(),cell=null;null!=c?cell=c:((cell=new EventDungeonCraftShopExchangeItemListCell)._callback_make_item=this.makeItem.bind(this),cell._callback_plus_item=this.plusItem.bind(this),cell._callback_minus_item=this.minusItem.bind(this),USE_CRAFTSHOP_SCROLL_BAR&&(cell._callback_slider_item=this.sliderItem.bind(this)));var item=this.m_exchange_list[idx],make_count=this.m_make_count_list[item.material_exchange_id];return cell.setItemData(item,make_count),cell},numberOfCellsInTableView:function(table){return this.m_exchange_list.length},tableCellTouched:function(table,cell){null!=cell&&cell.touchPosInCell(cell.getTouchPos())},tableCellUnhighlight:function(table,cell){null!=cell&&cell.unhighlightPosInCell(cell.getTouchPos())},tableCellHighlight:function(table,cell){null!=cell&&cell.highlightPosInCell(cell.getTouchPos())}}),EventDungeonCraftShopExchangeScene=GameScene.extend({m_select_material_exchange_id:0,m_select_item_count:0,m_popup_bg:null,m_exchangeLayer:null,m_exchageModalLayer:null,m_characterModalLayer:null,m_gauge_bar:null,m_popup_btn:null,m_popup_make_label:null,m_gnrl_img:null,ctor:function(){this._super(scene_EventDungeonCraftShopExchangeScene)},init:function(){this.initLayoutProgress2();var winSize=ccSize(this),m=(EventDungeonService.getInstance(),MasterManager.getInstance()),event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx();return this.m_period=m.get_EventDungeonPeriod(event_dungeon_period_idx),this.m_gnrl_img=[],this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_point_period_idx+"/btn_eventvs_ic_4_off.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_point_period_idx+"/btn_eventvs_ic_5_off.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_point_period_idx+"/btn_eventvs_ic_6_off.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_point_period_idx+"/btn_eventvs_ic_7_off.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_point_period_idx+"/btn_eventvs_ic_8_off.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_point_period_idx+"/btn_eventvs_ic_9_off.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_point_period_idx+"/btn_eventvs_ic_10_off.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_point_period_idx+"/btn_eventvs_ic_11_off.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_point_period_idx+"/btn_eventvs_ic_small_4_off.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_point_period_idx+"/btn_eventvs_ic_small_5_off.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_point_period_idx+"/btn_eventvs_ic_small_6_off.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_point_period_idx+"/btn_eventvs_ic_small_7_off.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_point_period_idx+"/btn_eventvs_ic_small_8_off.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_point_period_idx+"/btn_eventvs_ic_small_9_off.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_point_period_idx+"/btn_eventvs_ic_small_10_off.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_point_period_idx+"/btn_eventvs_ic_small_11_off.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_point_period_idx+"/img_eventvs_text_event.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_point_period_idx+"/bg_eventvs_sub.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_point_period_idx+"/img_evevtvs_ct.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_point_period_idx+"/img_evevtvs_ct_bubbletext_2.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_point_period_idx+"/img_eventvs_state.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_point_period_idx+"/img_eventvs_lock_4.png"),resourceLoader(this.m_gnrl_img,function(){this.m_exchangeLayer=new EventDungeonCraftShopExchangeLayer,this.addChild(this.m_exchangeLayer);var statusLayer=new StatusLayer;statusLayer.initLayout(),statusLayer.ignoreAnchorPointForPosition(!1),statusLayer.setAnchorPoint(ANCHOR_TOP_RIGHT()),statusLayer.setPosition(winSize.width,winSize.height),this.addChild(statusLayer);var title=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_point_period_idx+"/img_eventvs_text_event.png");title.setAnchorPoint(ZERO()),title.setPosition(90,585),this.addChild(title),this.back_btn=new ccui.Button,this.back_btn.loadTextures("btn_home_off.png","btn_home_on.png","",ccui.Widget.PLIST_TEXTURE),this.back_btn.setAnchorPoint(ZERO()),this.back_btn.setPosition(10,559),this.back_btn.addClickEventListener(function(){this.back()}.bind(this)),this.addChild(this.back_btn),this.m_exchageModalLayer=new GameModalLayer,this.addChild(this.m_exchageModalLayer,1e3),this.m_characterModalLayer=new GameModalLayer,this.addChild(this.m_characterModalLayer,1e3),this.removeLayerProgress2()}.bind(this)),!0},onEnter:function(){this._super(),MainObserver.getInstance().addObserver(this.onNotification,this,sceneStr[scene_EventDungeonCraftShopExchangeScene]);var event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx(),b_path=RES_CDN_SOUND+SND_TYPE+"sound/"+cmString(BGM_EVENT_DUNGEON_SCENE,event_dungeon_period_idx),audio=AudioEngine.getInstance();audio.m_bgmPath!=b_path&&(audio.stopBackgroundMusic(),audio.playBackgroundMusic(b_path,!0))},onExit:function(){if(this._super(),null!=this.m_gnrl_img){for(var idx=0;idx<this.m_gnrl_img.length;idx++)cc.loader.release(this.m_gnrl_img[idx]);this.m_gnrl_img=null}MainObserver.getInstance().removeObserver(sceneStr[scene_EventDungeonCraftShopExchangeScene])},back:function(msg){this.onKeyBack(!0)},onNotification:function(msg){if(this._super(msg),msg==not_enough_mtrl_count)this.showToastBox(res_str("label_craft_shop_not_enough_mtrl_title"),res_str("label_craft_shop_not_enough_mtrl_text"),1,ToastEnum.CENTER);else if(msg==btn_exchange_start){var exchange_info=this.m_exchangeLayer.getExchangeItemInfo();this.m_select_material_exchange_id=exchange_info.exchange_id,this.m_select_item_count=exchange_info.count,this.showExchangeMaterial()}return!0},showExchangeMaterial:function(item,need_event_point){var mt=MasterManager.getInstance(),craft_shop=mt.get_EventDungeonMaterialExchange(this.m_select_material_exchange_id),bonus_type_1=craft_shop.bonus_type,bonus_type_2=craft_shop.bonus_type_2,need_count_1=craft_shop.need_count*this.m_select_item_count,need_count_2=craft_shop.need_count_2*this.m_select_item_count,c=mt.get_CraftShopBonusType(craft_shop.craft_shop_bonus_type);this.m_ctbox.setTitle("素材製錬"),this.m_ctbox.setText(c.name,LABEL_FONT_INDEX.FONT_262),this.m_ctbox.setText(craft_shop.craft_bonus_count*this.m_select_item_count+"個を製錬しますか。",LABEL_FONT_INDEX.FONT_261),this.m_ctbox.setText("\n");var by=mt.get_BonusType(bonus_type_1);0!=bonus_type_2?(this.m_ctbox.setText(by.name,LABEL_FONT_INDEX.FONT_262),this.m_ctbox.setText(need_count_1+"個,",LABEL_FONT_INDEX.FONT_261),this.m_ctbox.setText("\n"),by=mt.get_BonusType(bonus_type_2),this.m_ctbox.setText(by.name,LABEL_FONT_INDEX.FONT_262),this.m_ctbox.setText(need_count_2+"個を消費します。",LABEL_FONT_INDEX.FONT_261)):(this.m_ctbox.setText(by.name,LABEL_FONT_INDEX.FONT_262),this.m_ctbox.setText(need_count_1+"個を消費します。",LABEL_FONT_INDEX.FONT_261));var btnNo=new MessageButtonInfo(mt.get_LanguageData("btn_label_no"),MessageBoxButtonType.ButtonTypeRed,0,1,1);btnNo.click=function(){this.m_ctbox.hide()}.bind(this);var btnBuy=new MessageButtonInfo(mt.get_LanguageData("btn_label_yes"),MessageBoxButtonType.ButtonTypeNormal,0,-1,1);btnBuy.click=function(){this.scheduleOnce(function(float){this.sendPacketExchage()},.1,"sendPacketExchage"),this.m_ctbox.hide()}.bind(this),this.m_ctbox.addButtonInfo(btnNo),this.m_ctbox.addButtonInfo(btnBuy),this.m_ctbox.show()},showNotSeletedMaterial:function(){this.m_box.setTitle("案内"),this.m_box.setText("素材を選択してください。"),this.m_box.setText("\n"),this.m_box.setText("素材が選択されていません。");var btnOk=new MessageButtonInfo(res_str("label_confirm"),MessageBoxButtonType.ButtonTypeNormal,0,-1,1);btnOk.click=function(){this.m_box.hide()}.bind(this),this.m_box.addButtonInfo(btnOk),this.m_box.show()},sendPacketExchage:function(){var res={};res.opcode=net.OP.op_event_dungeon_craft_shop_material_exchange,res.material_exchange_id=this.m_select_material_exchange_id,res.mtrl_count=this.m_select_item_count,this.network_write(res)},onNetworkEvent:function(opcode,state,body){opcode==net.OP.op_event_dungeon_craft_shop_material_exchange&&(100==body.error?(this.showExchangeEffect(),this.m_exchangeLayer.exchangeComplete()):body.error==net.ERROR.NET_E_LACK_EVENT_DUNGEON_POINT&&this.showInfoPopup(res_str("label_shop_buy_jade_omission_title"),"ポイントが不足しています。"))},showExchangeEffect:function(){this.m_exchageModalLayer.setContentSize(ccSize(this)),this.m_exchageModalLayer._contentNode=function(contentSize,m){var layer=this.getExchangeEffectBoxLayer();return layer.setContentSize(ccSize(this)),layer}.bind(this),this.m_exchageModalLayer.show()},getExchangeEffectBoxLayer:function(){var layer=new cc.Layer,size=cc.size(630,370),rect=cc.Rect(40,40,10,10);this.m_popup_bg=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_script_box_2.png",rect),this.m_popup_bg.setPreferredSize(size),this.m_popup_bg.setPosition(ccCenter(layer)),layer.addChild(this.m_popup_bg);var navi=cc.Sprite.create(RES_CDN_DEFULT+"common/img_navi_center_3.png");navi.setAnchorPoint(ANCHOR_MIDDLE_TOP()),navi.setPosition(.5*size.width,size.height-11),this.m_popup_bg.addChild(navi);var mt=MasterManager.getInstance(),me=mt.get_EventDungeonMaterialExchange(this.m_select_material_exchange_id),cs=mt.get_CraftShopBonusType(me.craft_shop_bonus_type),title_label=cmLabel.getLabel(cs.name+" "+this.m_select_item_count+"回",LABEL_FONT_INDEX.FONT_261);title_label.setAnchorPoint(ANCHOR_MIDDLE()),title_label.setPosition(ccCenter(navi)),navi.addChild(title_label);var icon=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_period.event_dungeon_point_period_idx+"/btn_eventvs_ic_"+me.craft_shop_bonus_type+"_off.png");icon.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),icon.setPosition(ccCenter(this.m_popup_bg).x,160),this.m_popup_bg.addChild(icon);var count_label=cmLabel.getLabel(cmString("x%s",Number(me.craft_bonus_count).toLocaleString("en")),LABEL_FONT_INDEX.FONT_181);count_label.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),count_label.enableOutline(cc.color.BLACK,2),count_label.setPosition(ccCenter(icon).x,10),icon.addChild(count_label);var gauge_frame=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_gauge_frame.png",RectZero());gauge_frame.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),gauge_frame.setPosition(ccCenter(this.m_popup_bg).x,99),gauge_frame.setPreferredSize(cc.size(300,16)),this.m_popup_bg.addChild(gauge_frame),this.m_gauge_bar=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_gauge_green_2.png",RectZero()),this.m_gauge_bar.setAnchorPoint(ANCHOR_MIDDLE_LEFT()),this.m_gauge_bar.setPosition(3,ccCenter(gauge_frame).y),gauge_frame.addChild(this.m_gauge_bar),this.m_gauge_bar.setScaleX(0);var img_build=cc.Sprite.create(RES_CDN_DEFULT+"common/img_build.png");img_build.setAnchorPoint(ANCHOR_MIDDLE()),img_build.setPosition(165,106),this.m_popup_bg.addChild(img_build);var rb=new cc.RotateBy(.1,30),repeat=new cc.RepeatForever(rb);img_build.runAction(repeat),this.m_popup_make_label=cmLabel.getLabel("生産中",LABEL_FONT_INDEX.FONT_181),this.m_popup_make_label.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_popup_make_label.setPosition(ccCenter(this.m_popup_bg).x,117),this.m_popup_bg.addChild(this.m_popup_make_label);var audio=AudioEngine.getInstance(),snd=RES_CDN_SOUND+SND_TYPE+"sound/SE_gauge.mp3";return audio.playEffect(snd),this.schedule(function(float){var width=this.m_gauge_bar.getScaleX();if(width+=14,this.m_gauge_bar.setScaleX(width),294<=width){this.unschedule("gauge_bar"),this.showToastBox("生産完了","生産を完了しました。",.8,ToastEnum.CENTER),this.m_popup_btn.setVisible(!0),this.m_popup_make_label.setString("生産完了");var audio=AudioEngine.getInstance(),snd=RES_CDN_SOUND+SND_TYPE+"sound/SE_gauge_set.mp3";audio.stopEffectsAll(),audio.playEffect(snd)}}.bind(this),.05,"gauge_bar"),this.m_popup_btn=new LabelButton("btn_07_off.png","btn_07_on.png","",ccui.Widget.PLIST_TEXTURE),this.m_popup_btn.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_popup_btn.setFont(LABEL_FONT_INDEX.FONT_241),this.m_popup_btn.setString("確認"),this.m_popup_btn.setPosition(ccCenter(this.m_popup_bg).x,16),this.m_popup_bg.addChild(this.m_popup_btn),this.m_popup_btn.addClickEventListener(function(){this.m_exchageModalLayer.hide()}.bind(this)),this.m_popup_btn.setVisible(!1),layer},effectComplete:function(){this.m_exchageModalLayer.hide()}}),btn_make_start=400,btn_is_remain_cool_time=401,btn_is_make_count_over=402,btn_is_not_select_item=403,btn_time_reduction=404,btn_time_reduction_impossible=405,not_enough_material=406,make_count_over=407,EventDungeonCraftShopItemLayer=cc.Layer.extend({m_item_table_view:null,m_event_dungeon_group_idx:0,m_first_half_period_idx:0,m_second_half_period_idx:0,m_item_select_idx:-1,m_item_recipe_id:0,m_item_id:0,m_time_event_index:0,m_make_item_count:0,m_is_make_count_over:!1,m_tab_idx:0,m_item_bg:null,m_item_img:null,m_character:null,m_talk_box:null,m_tab_first_half:null,m_tab_second_half:null,m_tab_item_list:[],m_item_list:[],m_map_mtrl_label:[],m_material_count_labels:[],m_period:null,m_enable_make_count:0,m_product_enable_cnt:0,m_start_btn:null,m_make_item_count_label:null,m_CountSlider:null,m_info_box:null,ctor:function(){this.m_item_list=[],this.m_material_count_labels=[],this.m_make_item_count_label=null,this.m_start_btn=null,this._super(),this.init()},init:function(){var event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx(),m=MasterManager.getInstance();this.m_period=m.get_EventDungeonPeriod(event_dungeon_period_idx),this.m_event_dungeon_group_idx=this.m_period.event_dungeon_group_idx,this.m_gnrl_img=[],this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/img_eventvs_frame_large.png"),this.m_gnrl_img.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/img_eventvs_state.png");var service=EventDungeonService.getInstance();return service.getEventDungeonCraftShopItemRecipeList(this.m_event_dungeon_group_idx,this.m_item_list),this.m_first_half_period_idx=service.getEventDungeonFirstHalfPeriodIdx(this.m_event_dungeon_group_idx),this.m_second_half_period_idx=service.getEventDungeonSecondHalfPeriodIdx(this.m_event_dungeon_group_idx),this.m_tab_idx=this.m_first_half_period_idx,this.setTabFirstSecondHalfList(),resourceLoader(this.m_gnrl_img,function(){var status_layer=this.getStatusLayer();status_layer.ignoreAnchorPointForPosition(!1),status_layer.setAnchorPoint(ANCHOR_TOP_RIGHT()),status_layer.setPosition(ccWidth(this)-10,ccHeight(this)-58),this.addChild(status_layer);var rightBoxLayer=this.getRightBoxLayer();rightBoxLayer.ignoreAnchorPointForPosition(!1),rightBoxLayer.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),rightBoxLayer.setPosition(ccWidth(this),0),this.addChild(rightBoxLayer,2);var x=ccWidth(this)-17;this.m_tab_second_half=new LabelButton("btn_24_none.png","btn_24_on.png","btn_24_off.png",ccui.Widget.PLIST_TEXTURE),this.m_tab_second_half.setAnchorPoint(ANCHOR_TOP_RIGHT()),this.m_tab_second_half.setFont(LABEL_FONT_INDEX.FONT_241),this.m_tab_second_half.setPosition(x,ccHeight(this)-153),this.m_tab_second_half.setString("後半"),this.m_tab_second_half.addClickEventListener(function(){this.setTab(this.m_second_half_period_idx)}.bind(this)),this.addChild(this.m_tab_second_half),x-=ccWidth(this.m_tab_second_half),this.m_tab_first_half=new LabelButton("btn_24_none.png","btn_24_on.png","btn_24_off.png",ccui.Widget.PLIST_TEXTURE),this.m_tab_first_half.setAnchorPoint(ANCHOR_TOP_RIGHT()),this.m_tab_first_half.setFont(LABEL_FONT_INDEX.FONT_241),this.m_tab_first_half.setPosition(x,ccHeight(this)-153),this.m_tab_first_half.setString("前半"),this.m_tab_first_half.addClickEventListener(function(){this.setTab(this.m_first_half_period_idx)}.bind(this)),this.addChild(this.m_tab_first_half),this.m_tab_first_half.setEnabled(!1);var leftBoxLayer=this.getLeftBoxLayer();leftBoxLayer.setPosition(ZERO()),this.addChild(leftBoxLayer)}.bind(this)),!0},setTabFirstSecondHalfList:function(){this.m_tab_item_list=[];for(var idx=0;idx<this.m_item_list.length;idx++)this.m_item_list[idx].event_dungeon_period_idx==this.m_tab_idx&&this.m_tab_item_list.push(this.m_item_list[idx])},setTab:function(idx){this.m_item_select_idx=-1,this.m_tab_idx=idx,this.setTabFirstSecondHalfList(),this.m_tab_first_half.setEnabled(!0),this.m_tab_second_half.setEnabled(!0),idx==this.m_first_half_period_idx?this.m_tab_first_half.setEnabled(!1):idx==this.m_second_half_period_idx&&this.m_tab_second_half.setEnabled(!1),this.m_item_bg.setVisible(!1),this.m_item_recipe_id=0,this.m_item_id=0,this.m_is_make_count_over=!1,this.m_character.setVisible(!0),this.m_talk_box.setVisible(!0),USE_CRAFTSHOP_SCROLL_BAR&&this.m_info_box.setVisible(!1),this.m_item_table_view.reloadData()},getLeftBoxLayer:function(){var plus_btn,minus_btn,count_box,layer=new cc.Layer;(layer.setContentSize(456,ccHeight(this)),USE_CRAFTSHOP_SCROLL_BAR)?(this.m_character=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/img_evevtvs_ct.png"),this.m_character.setAnchorPoint(ZERO()),this.m_character.setPosition(ZERO()),layer.addChild(this.m_character),this.m_talk_box=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/img_evevtvs_ct_bubbletext.png"),this.m_talk_box.setAnchorPoint(ZERO()),this.m_talk_box.setPosition(273,488),layer.addChild(this.m_talk_box),this.m_item_bg=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/img_eventvs_frame_large.png"),this.m_item_bg.setAnchorPoint(ZERO()),this.m_item_bg.setPosition(ZERO()),layer.addChild(this.m_item_bg),this.m_item_bg.setVisible(!1),this.m_info_box=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_info_box_2.png",cc.Rect(15,16,30,28)),this.m_info_box.setContentSize(323,134),this.m_info_box.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_info_box.setPosition(ccCenter(layer).x,76),layer.addChild(this.m_info_box),this.m_info_box.setVisible(!1),(plus_btn=new ccui.Button).loadTextures("btn_spinner_plus_off.png","btn_spinner_plus_on.png","btn_spinner_plus_none",ccui.Widget.PLIST_TEXTURE),plus_btn.setAnchorPoint(ANCHOR_TOP_RIGHT()),plus_btn.setPosition(ccWidth(this.m_info_box)-68,ccHeight(this.m_info_box)-24),this.m_info_box.addChild(plus_btn,10),plus_btn.addClickEventListener(function(sender){if(!this.m_is_make_count_over&&this.m_enable_make_count>this.m_make_item_count&&this.m_product_enable_cnt>this.m_make_item_count){this.m_make_item_count++,this.m_make_item_count_label.setString(this.m_make_item_count);var percent=(this.m_make_item_count/this.m_product_enable_cnt*100).toFixed(1);this.m_CountSlider.setPercent(percent),this.m_start_btn.setEnabled(!0)}else this.m_product_enable_cnt<=this.m_make_item_count?MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonCraftShopItemScene],make_count_over):this.m_enable_make_count<=this.m_make_item_count&&MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonCraftShopItemScene],not_enough_material)}.bind(this)),(minus_btn=new ccui.Button).loadTextures("btn_spinner_minus_off.png","btn_spinner_minus_on.png","btn_spinner_minus_none",ccui.Widget.PLIST_TEXTURE),minus_btn.setAnchorPoint(ANCHOR_TOP_LEFT()),minus_btn.setPosition(68,ccHeight(this.m_info_box)-24),this.m_info_box.addChild(minus_btn,10),minus_btn.addClickEventListener(function(sender){if(this.m_make_item_count--,this.m_make_item_count<=0&&(this.m_make_item_count=0,this.m_start_btn.setEnabled(!1)),this.m_make_item_count<=0)this.m_CountSlider.setPercent(0);else{var percent=(this.m_make_item_count/this.m_product_enable_cnt*100).toFixed(1);this.m_CountSlider.setPercent(percent)}this.m_make_item_count_label.setString(Number(this.m_make_item_count.toLocaleString("en")))}.bind(this)),(count_box=new cc.Scale9Sprite(RES_CDN_DEFULT+"common/img_9p_info_box.png",RectZero())).setAnchorPoint(ANCHOR_MIDDLE_TOP()),count_box.setPosition(ccCenter(this.m_info_box).x,ccHeight(this.m_info_box)-24),count_box.setPreferredSize(cc.size(61,40)),this.m_info_box.addChild(count_box,10),this.m_make_item_count_label=cmLabel.getLabel(this.m_make_item_count,LABEL_FONT_INDEX.FONT_201),this.m_make_item_count_label.setAnchorPoint(ANCHOR_MIDDLE()),this.m_make_item_count_label.setPosition(ccCenter(count_box)),count_box.addChild(this.m_make_item_count_label),this.m_item_img=cc.Sprite.create(),this.m_item_img.setAnchorPoint(ANCHOR_MIDDLE()),this.m_item_img.setPosition(ccCenter(this.m_item_bg)),this.m_item_img.setScale(1.75),this.m_item_bg.addChild(this.m_item_img),this.m_start_btn=new LabelButton("btn_07_off.png","btn_07_on.png","btn_07_none.png",ccui.Widget.PLIST_TEXTURE),this.m_start_btn.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_start_btn.setFont(LABEL_FONT_INDEX.FONT_241),this.m_start_btn.setPosition(ccCenter(layer).x,16),this.m_start_btn.setString("生産"),this.m_start_btn.setEnabled(!1),this.m_start_btn.addClickEventListener(function(){this.m_make_item_count<=0||(this.m_enable_make_count<this.m_make_item_count?MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonCraftShopItemScene],not_enough_material):this.m_is_make_count_over?MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonCraftShopItemScene],btn_is_make_count_over):0!=this.m_item_recipe_id?MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonCraftShopItemScene],btn_make_start):MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonCraftShopItemScene],btn_is_not_select_item))}.bind(this)),layer.addChild(this.m_start_btn),this.m_CountSlider=new ccui.Slider,this.m_CountSlider.setTouchEnabled(!0),this.m_CountSlider.setScale9Enabled(!0),this.m_CountSlider.loadBarTexture(RES_CDN_DEFULT+"common/img_gauge_frame_03.png"),this.m_CountSlider.loadSlidBallTextures(RES_CDN_DEFULT+"menu_yh/img_yh_feel_gauge_toggle.png",RES_CDN_DEFULT+"menu_yh/img_yh_feel_gauge_toggle.png",""),this.m_CountSlider.loadProgressBarTexture(RES_CDN_DEFULT+"common/img_gauge_green_03.png"),this.m_CountSlider.setCapInsets(cc.rect(0,0,0,0)),this.m_CountSlider.setContentSize(cc.size(222,16)),this.m_CountSlider.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_CountSlider.setPosition(ccCenter(this.m_info_box).x,27),this.m_CountSlider.addEventListener(this.SlideCallback,this),this.m_CountSlider.setPercent(0),this.m_info_box.addChild(this.m_CountSlider)):(this.m_character=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/img_evevtvs_ct.png"),this.m_character.setAnchorPoint(ZERO()),this.m_character.setPosition(ZERO()),layer.addChild(this.m_character),this.m_talk_box=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"img_evevtvs_ct_bubbletext"),this.m_talk_box.setAnchorPoint(ZERO()),this.m_talk_box.setPosition(273,488),layer.addChild(this.m_talk_box),this.m_item_bg=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/img_eventvs_frame_large.png"),this.m_item_bg.setAnchorPoint(ZERO()),this.m_item_bg.setPosition(ZERO()),layer.addChild(this.m_item_bg),this.m_item_bg.setVisible(!1),(plus_btn=new ccui.Button).loadTextures("btn_spinner_plus_off.png","btn_spinner_plus_on.png","btn_spinner_plus_none",ccui.Widget.PLIST_TEXTURE),plus_btn.setAnchorPoint(ZERO()),plus_btn.setPosition(276,210),this.m_info_box.addChild(plus_btn),plus_btn.addClickEventListener(function(sender){if(!this.m_is_make_count_over&&this.m_enable_make_count>this.m_make_item_count&&this.m_product_enable_cnt>this.m_make_item_count){this.m_make_item_count++,this.m_make_item_count_label.setString(Number(this.m_make_item_count).toLocaleString("en"));var percent=(this.m_make_item_count/this.m_product_enable_cnt*100).toFixed(1);this.m_CountSlider.setPercent(percent),this.m_start_btn.setEnabled(!0)}else this.m_product_enable_cnt<=this.m_make_item_count?MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonCraftShopItemScene],make_count_over):this.m_enable_make_count<=this.m_make_item_count&&MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonCraftShopItemScene],not_enough_material)}.bind(this)),(minus_btn=new ccui.Button).loadTextures("btn_spinner_minus_off.png","btn_spinner_minus_off.png","btn_spinner_minus_none",ccui.Widget.PLIST_TEXTURE),minus_btn.setAnchorPoint(ZERO()),minus_btn.setPosition(135,210),this.m_info_box.addChild(minus_btn),minus_btn.addClickEventListener(function(sender){if(this.m_make_item_count--,this.m_make_item_count<=0&&(this.m_make_item_count=0,this.m_start_btn.setEnabled(!1)),this.m_make_item_count<=0)this.m_CountSlider.setPercent(0);else{var percent=(this.m_make_item_count/this.m_product_enable_cnt*100).toFixed(1);this.m_CountSlider.setPercent(percent)}this.m_make_item_count_label.setString(Number(this.m_make_item_count).toLocaleString("en"))}.bind(this)),(count_box=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_info_box.png",RectZero())).setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),count_box.setPosition(ccCenter(this.m_item_bg).x,210),count_box.setPreferredSize(61,40),this.m_info_box.addChild(count_box),this.m_make_item_count_label=cmLabel.getLabel(this.m_make_item_count,LABEL_FONT_INDEX.FONT_201),this.m_make_item_count_label.setAnchorPoint(ANCHOR_MIDDLE()),this.m_make_item_count_label.setPosition(ccCenter(count_box)),count_box.addChild(this.m_make_item_count_label),this.m_item_img=Sprite.create(),this.m_item_img.setAnchorPoint(ANCHOR_MIDDLE()),this.m_item_img.setPosition(ccCenter(this.m_item_bg)),this.m_item_img.setScale(1.75),this.m_item_bg.addChild(this.m_item_img),this.m_start_btn=new LabelButton("btn_07_off.png","btn_07_on.png","btn_07_none.png",ccui.Widget.PLIST_TEXTURE),this.m_start_btn.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_start_btn.setFont(LABEL_FONT_INDEX.FONT_241),this.m_start_btn.setPosition(ccCenter(layer).x,16),this.m_start_btn.setString("生産"),this.m_start_btn.setEnabled(!1),this.m_start_btn.addClickEventListener(function(){this.m_make_item_count<=0||(this.m_enable_make_count<this.m_make_item_count?MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonCraftShopItemScene],not_enough_material):this.m_is_make_count_over?MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonCraftShopItemScene],btn_is_make_count_over):0!=this.m_item_recipe_id?MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonCraftShopItemScene],btn_make_start):MainObserver.getInstance().postNotification(sceneStr[scene_EventDungeonCraftShopItemScene],btn_is_not_select_item))}.bind(this)),layer.addChild(this.m_start_btn));return this.updateUserMtrl(),layer},enable_start_btn:function(bool){this.m_start_btn.setEnabled(bool)},checkMakeItemEnable:function(){return!1},checkMakeItemEnableCount:function(){for(var list=EventDungeonService.getInstance().getUserEventDungeonCraftShopMaterial(),recipe=MasterManager.getInstance().get_EventDungeonCraftShopProductRecipe(this.m_item_recipe_id),mtrl_1_count=0,mtrl_2_count=0,mtrl_3_count=0,gs=GeneralService.getInstance(),idx=0;idx<list.length;idx++){var mtrl=list[idx],mtrl_type=gs.getCraftShopMtrlTypeToBonusType(mtrl.craft_shop_bonus_type);mtrl_type==recipe.mtrl_1?mtrl_1_count=mtrl.material_count:mtrl_type==recipe.mtrl_2?mtrl_2_count=mtrl.material_count:mtrl_type==recipe.mtrl_3&&(mtrl_3_count=mtrl.material_count)}for(var enable_count=1;!(0!=recipe.mtrl_1&&mtrl_1_count<recipe.need_cnt_1*enable_count||0!=recipe.mtrl_2&&mtrl_2_count<recipe.need_cnt_2*enable_count||0!=recipe.mtrl_3&&mtrl_3_count<recipe.need_cnt_3*enable_count);)enable_count++;return enable_count-1},getStatusLayer:function(){var layer=new cc.Layer,service=EventDungeonService.getInstance(),status_bg=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/img_eventvs_state.png");status_bg.setAnchorPoint(ZERO()),status_bg.setPosition(ZERO()),layer.addChild(status_bg),layer.setContentSize(ccSize(status_bg));for(var i=4;i<=11;++i){var label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_161);label.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),layer.addChild(label),i==CRAFT_SHOP_BONUS_TYPE_FIRST_LOW?label.setPosition(103,38):i==CRAFT_SHOP_BONUS_TYPE_FIRST_MIDDLE?label.setPosition(224,38):i==CRAFT_SHOP_BONUS_TYPE_FIRST_HIGH?label.setPosition(103,6):i==CRAFT_SHOP_BONUS_TYPE_FIRST_UNIQUE?label.setPosition(224,6):i==CRAFT_SHOP_BONUS_TYPE_SECOND_MIDDLE?label.setPosition(346,38):i==CRAFT_SHOP_BONUS_TYPE_SECOND_HIGH?label.setPosition(468,38):i==CRAFT_SHOP_BONUS_TYPE_SECOND_UNIQUE?label.setPosition(346,6):i==CRAFT_SHOP_BONUS_TYPE_TOTAL_LEGEND&&label.setPosition(468,6),this.m_map_mtrl_label[i]=label}var second_half_period_idx=service.getEventDungeonSecondHalfPeriodIdx(this.m_period.event_dungeon_group_idx),mask=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/img_eventvs_lock_4.png");return mask.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),mask.setPosition(ccWidth(layer),0),layer.addChild(mask),mask.setVisible(!service.IsOpenDungeon(second_half_period_idx)),layer},updateUserMtrl:function(){for(var list=EventDungeonService.getInstance().getUserEventDungeonCraftShopMaterial(),idx=0;idx<list.length;idx++){var mtrl=list[idx];this.m_map_mtrl_label[mtrl.craft_shop_bonus_type].setString(Number(mtrl.material_count).toLocaleString("en"))}this.m_start_btn.setEnabled(!1),this.m_make_item_count=0,this.m_CountSlider.setPercent(0),this.m_make_item_count_label.setString(this.m_make_item_count)},refreshTableView:function(){this.m_item_bg.setVisible(!1),this.m_item_recipe_id=0,this.m_item_id=0,this.m_item_select_idx=-1,this.m_is_make_count_over=!1;var offset=this.m_item_table_view.getContentOffset(),offset_min=this.m_item_table_view.minContainerOffset();this.m_item_table_view.reloadData(),offset.y<offset_min.y&&(offset=offset_min),this.m_item_table_view.setContentOffset(offset);for(var craft_shop_material_list=EventDungeonService.getInstance().getUserEventDungeonCraftShopMaterial(),idx=0;idx<craft_shop_material_list.length;idx++)for(var mtrl=craft_shop_material_list[idx],jdx=0;jdx<this.m_material_count_labels.length;jdx++){var label=this.m_material_count_labels[jdx];mtrl.craft_shop_bonus_type==label.getTag()&&label.setString(Number(mtrl.material_count).toLocaleString("en"))}this.updateUserMtrl()},setCharacter:function(){this.m_character.setVisible(!0),this.m_talk_box.setVisible(!0),this.m_info_box.setVisible(!1)},getRightBoxLayer:function(){var layer=new cc.Layer,bg_box=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_script_box_2.png",RectZero());bg_box.setAnchorPoint(ZERO()),bg_box.setPreferredSize(cc.size(680,434)),bg_box.setInsetLeft(44),bg_box.setInsetRight(44),bg_box.setInsetBottom(44),bg_box.setInsetTop(44),bg_box.setPosition(ZERO()),layer.addChild(bg_box),layer.setContentSize(ccSize(bg_box));var cmplt_item_title=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_info_box_3.png",RectZero());cmplt_item_title.setInsetLeft(19),cmplt_item_title.setInsetRight(19),cmplt_item_title.setPreferredSize(cc.size(136,31)),cmplt_item_title.setAnchorPoint(ZERO()),cmplt_item_title.setPosition(18,383),bg_box.addChild(cmplt_item_title,1);var cmplt_item_title_label=cmLabel.getLabel("獲得できるアイテム",LABEL_FONT_INDEX.FONT_144);cmplt_item_title_label.setAnchorPoint(ANCHOR_MIDDLE()),cmplt_item_title_label.setPosition(ccCenter(cmplt_item_title)),cmplt_item_title.addChild(cmplt_item_title_label);var mtrl_item_title=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_info_box_3.png",RectZero());mtrl_item_title.setInsetLeft(19),mtrl_item_title.setInsetRight(19),mtrl_item_title.setPreferredSize(cc.size(216,31)),mtrl_item_title.setAnchorPoint(ZERO()),mtrl_item_title.setPosition(262,383),bg_box.addChild(mtrl_item_title,1);var mtrl_item_title_label=cmLabel.getLabel("生産に必要となる素材",LABEL_FONT_INDEX.FONT_165);mtrl_item_title_label.setAnchorPoint(ANCHOR_MIDDLE()),mtrl_item_title_label.setPosition(ccCenter(mtrl_item_title)),mtrl_item_title.addChild(mtrl_item_title_label);var tSize=cc.size(646,372);return this.m_item_table_view=new cc.TableView(this,tSize),this.m_item_table_view.setDelegate(this),this.m_item_table_view.setDirection(cc.SCROLLVIEW_DIRECTION_VERTICAL),this.m_item_table_view.scrollBarEnable(!0),this.m_item_table_view.setVerticalFillOrder(0),this.m_item_table_view.setPosition(18,20),bg_box.addChild(this.m_item_table_view),this.m_item_table_view.reloadData(),tSize=null,layer},cellSizeForTable:function(table){return cc.size(646,158)},tableCellSizeForIndex:function(){return cc.size(646,158)},tableCellAtIndex:function(table,idx){var c=table.dequeueCell(),cell=null;null!=c?cell=c:(cell=new EventDungeonCraftShopItemListCell)._callback_choice_item=this.choiceItem.bind(this);var item=this.m_tab_item_list[idx];return cell.setItemData(this.m_first_half_period_idx,item,idx==this.m_item_select_idx),cell},numberOfCellsInTableView:function(table){return this.m_tab_item_list.length},tableCellEnded:function(){},choiceItem:function(idx){var service=EventDungeonService.getInstance(),second_half_period_idx=service.getEventDungeonSecondHalfPeriodIdx(this.m_event_dungeon_group_idx),is_open=service.IsOpenDungeon(second_half_period_idx);if(-1!=idx){var item=this.m_tab_item_list[idx];if(!is_open&&item.event_dungeon_period_idx==this.m_second_half_period_idx)return}this.m_item_select_idx=idx;var used=this.m_item_table_view.getCellsUsed();for(idx=0;idx<used.length;idx++){var uc=used[idx];this.m_item_table_view.updateCellAtIndex(uc.getIdx())}new net.User_General_Key;if(-1==this.m_item_select_idx)this.m_item_bg.setVisible(!1),this.m_item_recipe_id=0,this.m_item_id=0,this.m_is_make_count_over=!1,this.m_character.setVisible(!0),this.m_talk_box.setVisible(!0),this.m_start_btn.setEnabled(!1),USE_CRAFTSHOP_SCROLL_BAR&&this.m_info_box.setVisible(!1);else if(this.m_is_make_count_over=!1,this.m_character.setVisible(!1),this.m_talk_box.setVisible(!1),this.m_item_bg.setVisible(!0),this.m_start_btn.setEnabled(!1),this.m_make_item_count=0,this.m_make_item_count_label.setString(this.m_make_item_count),USE_CRAFTSHOP_SCROLL_BAR&&(this.m_info_box.setVisible(!0),this.m_CountSlider.setPercent(this.m_make_item_count)),(item=this.m_tab_item_list[this.m_item_select_idx]).bonus_type==BONUS_TYPE_YUNHEE_FIX)this.choiceItem_Resouce(item);else{var frame=cc.spriteFrameCache.getSpriteFrame("img_reward_"+leadingZeros(item.bonus_type,2)+".png");this.m_item_img.setSpriteFrame(frame),this.choiceItem_Resouce(item)}},choiceItem_Resouce:function(item){if(item.bonus_type==BONUS_TYPE_YUNHEE_FIX){var frame=cc.spriteFrameCache.getSpriteFrame(item.min_value+".png");this.m_item_img.setSpriteFrame(frame)}else{frame=cc.spriteFrameCache.getSpriteFrame("img_reward_"+leadingZeros(item.bonus_type,2)+".png");this.m_item_img.setSpriteFrame(frame)}this.m_item_recipe_id=item.product_recipe_id,this.m_item_id=item.product_item_id;for(var user_product_cnt=0,shop_item=(new NetService).get_user_Event_Dungeon_Craft_Shop_Product_Info().user_event_dungeon_craft_shop_item,idx=0;idx<shop_item.length;idx++){var i=shop_item[idx];if(i.product_item_id==item.product_item_id){item.product_enable_cnt<=i.product_cnt&&(this.m_is_make_count_over=!0),user_product_cnt=i.product_cnt;break}}this.m_product_enable_cnt=item.product_enable_cnt-user_product_cnt,this.m_enable_make_count=this.checkMakeItemEnableCount();var max_make_count=0;max_make_count=this.m_enable_make_count<=this.m_product_enable_cnt?this.m_enable_make_count:this.m_product_enable_cnt,USE_CRAFTSHOP_SCROLL_BAR&&(this.m_CountSlider.setPercent(0),0==max_make_count?(this.m_CountSlider.setPercent(0),this.m_CountSlider.setEnabled(!1)):this.m_CountSlider.setEnabled(!0))},getItemProductRecipeId:function(){return this.m_item_recipe_id},getItemMakeCount:function(){return this.m_make_item_count},getItemProductItemId:function(){return this.m_item_id},tableCellTouched:function(table,cell){null!=cell&&cell.touchPosInCell(cell.getTouchPos())},tableCellHighlight:function(table,cell){null!=cell&&cell.highlightPosInCell(cell.getTouchPos())},tableCellUnhighlight:function(table,cell){null!=cell&&cell.unhighlightPosInCell(cell.getTouchPos())},onEnter:function(){this._super()},onExit:function(){this._super()},SlideCallback:function(sender,type){var slider=sender,now=slider.getPercent(),count=(this.m_product_enable_cnt*now*.01).toFixed(1);this.m_make_item_count=Math.floor(count),this.m_make_item_count<=0?(this.m_make_item_count=0,this.m_start_btn.setEnabled(!1),slider.setPercent(0)):now<1?(this.m_make_item_count=0,this.m_start_btn.setEnabled(!1)):this.m_start_btn.setEnabled(!0),this.m_make_item_count_label.setString(this.m_make_item_count)}}),EventDungeonCraftShopItemListCell=cc.TableViewCell.extend({m_select_cover:null,m_is_select:!1,m_item_icon:null,m_item_name:null,_callback_choice_item:null,m_mtrl_icon_1:null,m_mtrl_icon_2:null,m_mtrl_icon_3:null,m_plus_1:null,m_plus_2:null,m_mtrl_1_name_label:null,m_mtrl_2_name_label:null,m_mtrl_3_name_label:null,m_mask:null,m_mtrl_1_count_label:null,m_mtrl_2_count_label:null,m_mtrl_3_count_label:null,m_remain_count_label:null,m_product_count_label:null,m_select_sprite:null,m_release_sprite:null,m_event_dungeon_period_idx:0,ctor:function(){this._super(),this.m_select_sprite=[],this.m_release_sprite=[],this.init()},init:function(){var list_bg=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_info_box_5.png",RectZero());list_bg.setAnchorPoint(ZERO()),list_bg.setPosition(ZERO()),list_bg.setPreferredSize(cc.size(646,158)),this.addChild(list_bg),this.setContentSize(ccSize(list_bg));var icon_frame=cc.Sprite.create(RES_CDN_DEFULT+"icon/img_icon_frame_5.png");icon_frame.setAnchorPoint(ZERO()),icon_frame.setPosition(12,39),list_bg.addChild(icon_frame);var arrow_img=cc.Sprite.create(RES_CDN_DEFULT+"common/img_box_arrow.png");arrow_img.setAnchorPoint(ZERO()),arrow_img.setPosition(134,67),list_bg.addChild(arrow_img),this.m_item_icon=cc.Sprite.create(),this.m_item_icon.setAnchorPoint(ANCHOR_MIDDLE()),this.m_item_icon.setPosition(ccCenter(icon_frame)),this.m_item_icon.setScale(1.75),icon_frame.addChild(this.m_item_icon),this.m_product_count_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_181),this.m_product_count_label.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_product_count_label.setPosition(ccCenter(icon_frame).x,10),this.m_product_count_label.enableOutline(cc.color.BLACK,1),icon_frame.addChild(this.m_product_count_label),this.m_item_name=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_1614),this.m_item_name.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),this.m_item_name.setPosition(14,20),list_bg.addChild(this.m_item_name);var mtrl_bg_box=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_info_box_4.png",RectZero());mtrl_bg_box.setPreferredSize(cc.size(308,96)),mtrl_bg_box.setAnchorPoint(ZERO()),mtrl_bg_box.setPosition(199,48),list_bg.addChild(mtrl_bg_box);var nor,nor_label,on,on_label,mtrl_bg_box_arrow=cc.Sprite.create(RES_CDN_DEFULT+"common/img_box_arrow_3.png");mtrl_bg_box_arrow.setAnchorPoint(ZERO()),mtrl_bg_box_arrow.setPosition(180,77),list_bg.addChild(mtrl_bg_box_arrow),this.m_mtrl_icon_1=cc.Sprite.create(),this.m_mtrl_icon_1.setAnchorPoint(ZERO()),this.m_mtrl_icon_1.setPosition(13,8),mtrl_bg_box.addChild(this.m_mtrl_icon_1),this.m_mtrl_icon_2=cc.Sprite.create(),this.m_mtrl_icon_2.setAnchorPoint(ZERO()),this.m_mtrl_icon_2.setPosition(113,8),mtrl_bg_box.addChild(this.m_mtrl_icon_2),this.m_mtrl_icon_3=cc.Sprite.create(),this.m_mtrl_icon_3.setAnchorPoint(ZERO()),this.m_mtrl_icon_3.setPosition(213,8),mtrl_bg_box.addChild(this.m_mtrl_icon_3),this.m_mtrl_1_count_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_181),this.m_mtrl_1_count_label.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_mtrl_1_count_label.enableOutline(cc.color.BLACK,1),this.m_mtrl_icon_1.addChild(this.m_mtrl_1_count_label),this.m_mtrl_2_count_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_181),this.m_mtrl_2_count_label.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_mtrl_2_count_label.enableOutline(cc.color.BLACK,1),this.m_mtrl_icon_2.addChild(this.m_mtrl_2_count_label),this.m_mtrl_3_count_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_181),this.m_mtrl_3_count_label.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_mtrl_3_count_label.enableOutline(cc.color.BLACK,1),this.m_mtrl_icon_3.addChild(this.m_mtrl_3_count_label),this.m_remain_count_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_1613),this.m_remain_count_label.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_remain_count_label.setPosition(352,12),this.m_remain_count_label.enableOutline(cc.color.BLACK,1),list_bg.addChild(this.m_remain_count_label),this.m_mtrl_1_name_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_1614),this.m_mtrl_1_name_label.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_mtrl_1_name_label.setPosition(252,32),list_bg.addChild(this.m_mtrl_1_name_label),this.m_mtrl_2_name_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_1614),this.m_mtrl_2_name_label.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_mtrl_2_name_label.setPosition(352,32),list_bg.addChild(this.m_mtrl_2_name_label),this.m_mtrl_3_name_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_1614),this.m_mtrl_3_name_label.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),this.m_mtrl_3_name_label.setPosition(452,32),list_bg.addChild(this.m_mtrl_3_name_label),this.m_plus_1=cc.Sprite.create(RES_CDN_DEFULT+"common/img_plus.png"),this.m_plus_1.setAnchorPoint(ZERO()),this.m_plus_1.setPosition(94,39),mtrl_bg_box.addChild(this.m_plus_1),this.m_plus_1.setVisible(!1),this.m_plus_2=cc.Sprite.create(RES_CDN_DEFULT+"common/img_plus.png"),this.m_plus_2.setAnchorPoint(ZERO()),this.m_plus_2.setPosition(194,39),mtrl_bg_box.addChild(this.m_plus_2),this.m_plus_2.setVisible(!1),(nor=cc.Sprite.create("#btn_01_off.png")).setAnchorPoint(ZERO()),nor.setPosition(519,66),(nor_label=cmLabel.getLabel(res_str("btn_label_select"),LABEL_FONT_INDEX.FONT_241)).setAnchorPoint(ANCHOR_MIDDLE()),nor_label.setPosition(ccCenter(nor)),nor.addChild(nor_label),list_bg.addChild(nor),this.m_select_sprite.push(nor),(on=cc.Sprite.create("#btn_01_on.png")).setAnchorPoint(ZERO()),on.setPosition(519,66),(on_label=cmLabel.getLabel(res_str("btn_label_select"),LABEL_FONT_INDEX.FONT_242)).setAnchorPoint(ANCHOR_MIDDLE()),on_label.setPosition(ccCenter(on)),on.addChild(on_label),list_bg.addChild(on),on.setVisible(!1),this.m_select_sprite.push(on),(nor=cc.Sprite.create("#btn_01_red_off.png")).setAnchorPoint(ZERO()),nor.setPosition(519,66),(nor_label=cmLabel.getLabel(res_str("btn_label_release"),LABEL_FONT_INDEX.FONT_241)).setAnchorPoint(ANCHOR_MIDDLE()),nor_label.setPosition(ccCenter(nor)),nor.addChild(nor_label),list_bg.addChild(nor),this.m_release_sprite.push(nor),nor.setVisible(!1),(on=cc.Sprite.create("#btn_01_red_on.png")).setAnchorPoint(ZERO()),on.setPosition(519,66),(on_label=cmLabel.getLabel(res_str("btn_label_release"),LABEL_FONT_INDEX.FONT_242)).setAnchorPoint(ANCHOR_MIDDLE()),on_label.setPosition(ccCenter(on)),on.addChild(on_label),list_bg.addChild(on),this.m_release_sprite.push(on),on.setVisible(!1),this.m_select_cover=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_select_2.png",RectZero()),this.m_select_cover.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),this.m_select_cover.setPosition(ZERO()),this.m_select_cover.setPreferredSize(ccSize(list_bg)),this.addChild(this.m_select_cover),this.m_select_cover.setVisible(!1);var fadeIn=new cc.FadeIn(1),fadeOut=new cc.FadeOut(1),seq=new cc.Sequence(fadeIn,fadeOut),repeat=new cc.RepeatForever(seq);this.m_select_cover.runAction(repeat),this.m_mask=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_btn_mask.png",RectZero()),this.m_mask.setPreferredSize(ccSize(this)),this.m_mask.setAnchorPoint(ZERO()),this.m_mask.setPosition(ZERO()),this.addChild(this.m_mask),this.m_mask.setVisible(!1);var lock_icon=cc.Sprite.create(RES_CDN_DEFULT+"common/img_list_lock.png");return lock_icon.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),lock_icon.setPosition(ccCenter(this.m_mask).x,-10),this.m_mask.addChild(lock_icon),!0},setItemData:function(event_dungeon_period_idx,item,is_select){this.m_event_dungeon_period_idx=event_dungeon_period_idx,this.m_is_select=is_select,this.m_item_data=item,this.updateCellLayout()},updateCellLayout:function(){var service=EventDungeonService.getInstance(),gs=GeneralService.getInstance(),event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx(),m=MasterManager.getInstance(),period=m.get_EventDungeonPeriod(event_dungeon_period_idx),second_half_period_idx=service.getEventDungeonSecondHalfPeriodIdx(period.event_dungeon_group_idx),is_open=service.IsOpenDungeon(second_half_period_idx),b=m.get_BonusType(this.m_item_data.bonus_type);if(this.m_item_name.setString(b.name),this.m_item_data.bonus_type==BONUS_TYPE_YUNHEE_FIX){var general=m.get_General(this.m_item_data.min_value);if(general.gnrl_type==GENERAL_TYPE_MATERIAL||general.gnrl_type==GENERAL_TYPE_EVOLVE_MATERIAL){var frame=cc.spriteFrameCache.getSpriteFrame(general.bone_id+".png");this.m_item_icon.setSpriteFrame(frame)}else{frame=cc.spriteFrameCache.getSpriteFrame(general.gnrl_id+".png");this.m_item_icon.setSpriteFrame(frame)}this.m_item_name.setString(general.name)}else{frame=cc.spriteFrameCache.getSpriteFrame("img_reward_"+leadingZeros(this.m_item_data.bonus_type,2)+".png");this.m_item_icon.setSpriteFrame(frame)}if(this.m_product_count_label.setString(cmString("x%s",this.m_item_data.max_value)),0==this.m_item_data.need_cnt1)this.m_mtrl_icon_1.setTexture(RES_CDN_DEFULT+"common/img_point.png"),this.m_mtrl_1_count_label.setString("");else{var craft_shop_bonus_type=gs.getBonusTypeToCraftShopMtrlType(this.m_item_data.mtrl_1);this.m_mtrl_icon_1.setTexture(RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_ic_small_%d_off.png",period.event_dungeon_group_idx,craft_shop_bonus_type)),this.m_mtrl_icon_1.setContentSize(80,80),this.m_mtrl_1_count_label.setString(cmString("x%s",this.m_item_data.need_cnt1)),this.m_mtrl_1_count_label.setPosition(38,4);var c=m.get_CraftShopBonusType(craft_shop_bonus_type);this.m_mtrl_1_name_label.setString(c.name)}if(0==this.m_item_data.need_cnt2)this.m_plus_1.setVisible(!1),this.m_plus_2.setVisible(!1),this.m_mtrl_icon_2.setTexture(RES_CDN_DEFULT+"common/img_point.png"),this.m_mtrl_2_count_label.setString(""),this.m_mtrl_2_name_label.setString(""),this.m_mtrl_icon_3.setTexture(RES_CDN_DEFULT+"common/img_point.png"),this.m_mtrl_3_count_label.setString(""),this.m_mtrl_3_name_label.setString("");else{this.m_plus_1.setVisible(!0);craft_shop_bonus_type=gs.getBonusTypeToCraftShopMtrlType(this.m_item_data.mtrl_2);this.m_mtrl_icon_2.setTexture(RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_ic_small_%d_off.png",period.event_dungeon_group_idx,craft_shop_bonus_type)),this.m_mtrl_icon_2.setContentSize(80,80),this.m_mtrl_2_count_label.setString(cmString("x%s",this.m_item_data.need_cnt2)),this.m_mtrl_2_count_label.setPosition(ccCenter(this.m_mtrl_icon_2).x,10);c=m.get_CraftShopBonusType(craft_shop_bonus_type);this.m_mtrl_2_name_label.setString(c.name)}if(0==this.m_item_data.need_cnt3)this.m_plus_2.setVisible(!1),this.m_mtrl_icon_3.setTexture(RES_CDN_DEFULT+"common/img_point.png"),this.m_mtrl_3_count_label.setString(""),this.m_mtrl_3_name_label.setString("");else{this.m_plus_2.setVisible(!0);craft_shop_bonus_type=gs.getBonusTypeToCraftShopMtrlType(this.m_item_data.mtrl_3);this.m_mtrl_icon_3.setTexture(RES_CDN_DEFULT+cmString("menu_eventvs_%d/btn_eventvs_ic_small_%d_off.png",period.event_dungeon_group_idx,craft_shop_bonus_type)),this.m_mtrl_icon_3.setContentSize(80,80),this.m_mtrl_3_count_label.setString(cmString("x%s",this.m_item_data.need_cnt3)),this.m_mtrl_3_count_label.setPosition(ccCenter(this.m_mtrl_icon_3).x,10);c=m.get_CraftShopBonusType(craft_shop_bonus_type);this.m_mtrl_3_name_label.setString(c.name)}this.m_mask.setVisible(!1),this.m_is_select?(this.m_release_sprite[0].setVisible(!0),this.m_release_sprite[1].setVisible(!1),this.m_select_sprite[0].setVisible(!1),this.m_select_sprite[1].setVisible(!1)):(this.m_select_sprite[0].setVisible(!0),this.m_select_sprite[1].setVisible(!1),this.m_release_sprite[0].setVisible(!1),this.m_release_sprite[1].setVisible(!1)),is_open||this.m_item_data.event_dungeon_period_idx!=second_half_period_idx||(this.m_select_sprite[0].setVisible(!1),this.m_select_sprite[1].setVisible(!0),this.m_mask.setVisible(!0)),this.m_select_cover.setVisible(this.m_is_select),this.m_remain_count_label.setString("生産可能回数："+this.m_item_data.product_enable_cnt+"回");for(var shop_item=(new NetService).get_user_Event_Dungeon_Craft_Shop_Product_Info().user_event_dungeon_craft_shop_item,idx=0;idx<shop_item.length;idx++){var i=shop_item[idx];if(i.product_item_id==this.m_item_data.product_recipe_id){var product_cnt=this.m_item_data.product_enable_cnt-i.product_cnt;this.m_remain_count_label.setString("生産可能回数："+product_cnt+"回");break}}},highlightPosInCell:function(pos){var service=EventDungeonService.getInstance(),event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx(),period=MasterManager.getInstance().get_EventDungeonPeriod(event_dungeon_period_idx),second_half_period_idx=service.getEventDungeonSecondHalfPeriodIdx(period.event_dungeon_group_idx);if(service.IsOpenDungeon(second_half_period_idx)||this.m_item_data.event_dungeon_period_idx!=second_half_period_idx){var r=this.m_select_sprite[0].getBoundingBox();cc.rectContainsPoint(r,pos)&&(this.m_is_select?(this.m_release_sprite[0].setVisible(!1),this.m_release_sprite[1].setVisible(!0)):(this.m_select_sprite[0].setVisible(!1),this.m_select_sprite[1].setVisible(!0)))}},unhighlightPosInCell:function(pos){var service=EventDungeonService.getInstance(),event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx(),period=MasterManager.getInstance().get_EventDungeonPeriod(event_dungeon_period_idx),second_half_period_idx=service.getEventDungeonSecondHalfPeriodIdx(period.event_dungeon_group_idx);if(service.IsOpenDungeon(second_half_period_idx)||this.m_item_data.event_dungeon_period_idx!=second_half_period_idx){cc.log("============================= unhighlightPosInCell ==========================");this.m_select_sprite[0].getBoundingBox();this.m_is_select?(this.m_release_sprite[0].setVisible(!0),this.m_release_sprite[1].setVisible(!1)):(this.m_select_sprite[0].setVisible(!0),this.m_select_sprite[1].setVisible(!1))}},tableCellUnhighlight:function(pos){cc.log("============================= tableCellUnhighlight ==========================");var r=this.m_select_sprite[0].getBoundingBox();cc.rectContainsPoint(r,pos)&&(this.m_is_select?(this.m_release_sprite[0].setVisible(!1),this.m_release_sprite[1].setVisible(!0)):(this.m_select_sprite[0].setVisible(!1),this.m_select_sprite[1].setVisible(!0)))},touchPosInCell:function(pos){var service=EventDungeonService.getInstance(),event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx(),period=MasterManager.getInstance().get_EventDungeonPeriod(event_dungeon_period_idx),second_half_period_idx=service.getEventDungeonSecondHalfPeriodIdx(period.event_dungeon_group_idx);if(service.IsOpenDungeon(second_half_period_idx)||this.m_item_data.event_dungeon_period_idx!=second_half_period_idx){var r=this.m_select_sprite[0].getBoundingBox();if(cc.rectContainsPoint(r,pos)){if(this.m_is_select)this.m_release_sprite[0].setVisible(!0),this.m_release_sprite[1].setVisible(!1),null!=this._callback_choice_item&&this._callback_choice_item(-1);else if(this.m_select_sprite[0].setVisible(!0),this.m_select_sprite[1].setVisible(!1),null!=this._callback_choice_item){var idx=this.getIdx();this._callback_choice_item(idx)}AudioEngine.getInstance().playEffect(RES_CDN_SOUND+SND_TYPE+"sound/"+EFT_NORMAL_BUTTON)}}}}),EventDungeonCraftShopItemScene=GameScene.extend({m_character_touch_enabled:!1,m_makeItemModalLayer:null,m_characterModalLayer:null,m_skeletonEffectNode:null,m_itemLayer:null,m_talk_box_img:null,m_event_dungeon_group_idx:0,m_character_touch_enabled:!1,m_make_item_count:0,ctor:function(){this._super(scene_EventDungeonCraftShopItemScene)},init:function(){var winSize=ccSize(this),event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx(),period=MasterManager.getInstance().get_EventDungeonPeriod(event_dungeon_period_idx);this.m_event_dungeon_group_idx=period.event_dungeon_group_idx;var bg=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/bg_eventvs_sub.png");bg.setPosition(ccCenter(this)),this.addChild(bg),this.m_itemLayer=new EventDungeonCraftShopItemLayer,this.addChild(this.m_itemLayer);var statusLayer=new StatusLayer;statusLayer.initLayout(),statusLayer.ignoreAnchorPointForPosition(!1),statusLayer.setAnchorPoint(ANCHOR_TOP_RIGHT()),statusLayer.setPosition(winSize.width,winSize.height),this.addChild(statusLayer);var title=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+period.event_dungeon_point_period_idx+"/img_eventvs_text_event.png");title.setAnchorPoint(ZERO()),title.setPosition(90,585),this.addChild(title);var back_btn=new ccui.Button;return back_btn.loadTextures("btn_home_off.png","btn_home_on.png","",ccui.Widget.PLIST_TEXTURE),back_btn.setAnchorPoint(ZERO()),back_btn.setPosition(10,559),back_btn.addClickEventListener(function(){this.back()}.bind(this)),this.addChild(back_btn),this.m_makeItemModalLayer=new GameModalLayer,this.addChild(this.m_makeItemModalLayer),this.m_characterModalLayer=new GameModalLayer,this.addChild(this.m_characterModalLayer),!0},onEnter:function(){this._super(),MainObserver.getInstance().addObserver(this.onNotification,this,sceneStr[scene_EventDungeonCraftShopItemScene]);var event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx(),b_path=RES_CDN_SOUND+SND_TYPE+"sound/"+cmString(BGM_EVENT_DUNGEON_SCENE,event_dungeon_period_idx),audio=AudioEngine.getInstance();audio.m_bgmPath!=b_path&&(audio.stopBackgroundMusic(),audio.playBackgroundMusic(b_path,!0))},onExit:function(){this._super(),MainObserver.getInstance().removeObserver(sceneStr[scene_EventDungeonCraftShopItemScene])},back:function(){this.onKeyBack(!0)},onNotification:function(msg){if(this._super(msg),msg==btn_make_start){var product_recipe_id=this.m_itemLayer.getItemProductRecipeId();EventDungeonService.getInstance().isEnableCraftShopMakeItem(product_recipe_id)?this.showStartMakeItem():this.showNotEnoughMaterial()}else if(msg==btn_is_remain_cool_time)this.showIsRemainCoolTime();else if(msg==btn_is_make_count_over)this.showIsMakeCountOver();else if(msg==btn_is_not_select_item)this.showNotSelectItem();else if(msg==btn_time_reduction){var info=$.extend({},db.UserItemInfo);UserService.getInstance().getUserItemInfo().done(function(userItemInfo){info=userItemInfo;var g=MasterTable.getInstance().get_GoodsFunction(5);if(info.jade_cnt<g.value)return this.showNotEnoughJade(),!0}.bind(this)),this.showTimeReductionStart()}else msg==btn_time_reduction_impossible?this.showImpossibleTimeReduction():msg==not_enough_material?this.showToastBox(res_str("label_craft_shop_not_enough_mtrl_title"),res_str("label_craft_shop_not_enough_mtrl_text"),1,ToastEnum.CENTER):msg==make_count_over&&this.showToastBox(res_str("label_common_information"),res_str("label_craft_shop_item_make_is_count_over_text_1"),1,ToastEnum.CENTER);return!0},onNetworkEvent:function(opcode,state,body){this.removeLayerProgress(),100!=body.error?opcode==net.OP.op_event_dungeon_craft_shop_item_make&&(body.error==net.ERROR.NET_E_LACK_EVENT_DUNGEON_POINT?this.showInfoPopup(res_str("label_shop_buy_jade_omission_title"),res_str("label_craft_shop_not_enough_mtrl_text")):body.error==net.ERROR.NET_E_CRAFT_SHOP_TIME_REMAIN&&this.showIsRemainCoolTime(),this.m_itemLayer.updateUserMtrl()):100==body.error&&(opcode==net.OP.op_event_dungeon_craft_shop_item_make?(this.m_make_item_count=this.m_itemLayer.getItemMakeCount(),this.showMakeEffect(),this.m_itemLayer.updateUserMtrl()):opcode==net.OP.op_event_dungeon_craft_shop_time_reduction&&this.showTimeReductionComplete())},sendPacketItemMake:function(){var req={};req.opcode=net.OP.op_event_dungeon_craft_shop_item_make,req.product_recipe_id=this.m_itemLayer.getItemProductRecipeId(),req.event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx(),req.make_item_count=this.m_itemLayer.getItemMakeCount(),this.network_write(req),this.initLayoutProgress()},sendPacketTimeReduction:function(){var req={};req.opcode=net.OP.op_event_dungeon_craft_shop_time_reduction,req.event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx(),this.network_write(req)},showStartMakeItem:function(){var product_recipe_id=this.m_itemLayer.getItemProductRecipeId(),product_item_id=this.m_itemLayer.getItemProductItemId(),item_count=this.m_itemLayer.getItemMakeCount(),mt=MasterManager.getInstance(),recipe=mt.get_EventDungeonCraftShopProductRecipe(product_recipe_id),mtrl_1_name="",mtrl_2_name="",mtrl_3_name="";0!=recipe.mtrl_1&&null!=recipe.mtrl_1&&null!=recipe.mtrl_1&&(mtrl_1_name=mt.get_BonusType(recipe.mtrl_1).name),0!=recipe.mtrl_2&&null!=recipe.mtrl_2&&null!=recipe.mtrl_2&&(mtrl_2_name=mt.get_BonusType(recipe.mtrl_2).name),0!=recipe.mtrl_3&&null!=recipe.mtrl_3&&null!=recipe.mtrl_3&&(mtrl_3_name=mt.get_BonusType(recipe.mtrl_3).name),this.m_product_item=mt.get_EventDungeonCraftShopProductItem(product_item_id),this.m_box.setTitle("生産");var StringText_1="",StringText_2="",StringText_3="";this.m_product_item.bonus_type==BONUS_TYPE_YUNHEE_FIX?StringText_1=mt.get_General(this.m_product_item.min_value).name+" "+this.m_product_item.max_value*item_count+"個を生産しますか。":StringText_1=mt.get_BonusType(this.m_product_item.bonus_type).name+" "+this.m_product_item.max_value*item_count+"個を生産しますか。";0==recipe.need_cnt_2&&0==recipe.need_cnt_3?StringText_2=mtrl_1_name+" "+recipe.need_cnt_1*item_count+"個を消費します。":0==recipe.need_cnt_3?(StringText_2=mtrl_1_name+" "+recipe.need_cnt_1*item_count+"個,",0!=recipe.need_cnt_2&&(StringText_3=mtrl_2_name+" "+recipe.need_cnt_2*item_count+"個を消費します。")):(StringText_2=mtrl_1_name+" "+recipe.need_cnt_1*item_count+"個,",0!=recipe.need_cnt_2&&(StringText_3=mtrl_2_name+" "+recipe.need_cnt_2*item_count+"個,"),0!=recipe.need_cnt_3&&(StringText_3=mtrl_3_name+" "+recipe.need_cnt_3*item_count+"個を消費します。")),this.m_box.setText(StringText_1),this.m_box.setText("\n"),this.m_box.setText(StringText_2),this.m_box.setText("\n"),this.m_box.setText(StringText_3),this.m_box.setText("\n");var btnNo=new MessageButtonInfo(mt.get_LanguageData("btn_label_no"),MessageBoxButtonType.ButtonTypeRed,0,1,1);btnNo.click=function(){this.m_box.hide()}.bind(this);var btnBuy=new MessageButtonInfo(mt.get_LanguageData("btn_label_yes"),MessageBoxButtonType.ButtonTypeNormal,0,-1,1);btnBuy.click=function(){this.m_itemLayer.enable_start_btn(!1),this.scheduleOnce(function(float){this.sendPacketItemMake()},.1,"sendPacketItemMake"),this.m_box.hide()}.bind(this),this.m_box.addButtonInfo(btnNo),this.m_box.addButtonInfo(btnBuy),this.m_box.show()},showIsRemainCoolTime:function(){this.m_box.setTitle(res_str("label_preparation_title")),this.m_box.setText(res_str("label_craft_shop_item_make_is_cool_time_text_1")),this.m_box.setText("\n"),this.m_box.setText(res_str("label_craft_shop_item_make_is_cool_time_text_2")),this.m_box.addButtonInfo(new MessageButtonInfo(res_str("label_confirm"),MessageBoxButtonType.ButtonTypeNormal,0,function(){this.m_box.hide(!1)}.bind(this))),this.m_box.show()},showIsMakeCountOver:function(){this.m_box.setTitle(res_str("label_preparation_title")),this.m_box.setText(res_str("label_craft_shop_item_make_is_count_over_text_1")),this.m_box.addButtonInfo(new MessageButtonInfo(res_str("label_confirm"),MessageBoxButtonType.ButtonTypeNormal,0,function(){this.m_box.hide(!1)}.bind(this))),this.m_box.show()},showNotEnoughMaterial:function(){this.m_box.setTitle(res_str("label_preparation_title")),this.m_box.setText(res_str("label_craft_shop_item_make_not_enough_material_text_1")),this.m_box.setText("\n"),this.m_box.setText(res_str("label_craft_shop_item_make_not_enough_material_text_2")),this.m_box.addButtonInfo(new MessageButtonInfo(res_str("label_confirm"),MessageBoxButtonType.ButtonTypeNormal,0,function(){this.m_box.hide(!1)}.bind(this))),this.m_box.show()},showNotSelectItem:function(){this.m_box.setTitle(res_str("label_preparation_title")),this.m_box.setText(res_str("label_creaft_shop_item_not_selected")),this.m_box.addButtonInfo(new MessageButtonInfo(res_str("label_confirm"),MessageBoxButtonType.ButtonTypeNormal,0,function(){this.m_box.hide(!1)}.bind(this))),this.m_box.show()},showTimeReductionStart:function(){var mt=MasterTable.getInstance(),g=mt.get_GoodsFunction(5);this.m_box.setTitle(res_str("label_preparation_title")),this.m_box.setText(cmString(res_str("label_craft_shop_time_reduction_text"),g.value));var btnNo=new MessageButtonInfo(mt.get_LanguageData("btn_label_no"),MessageBoxButtonType.ButtonTypeRed,0,1,1);btnNo.click=function(){this.m_box.hide()}.bind(this);var btnBuy=new MessageButtonInfo(mt.get_LanguageData("btn_label_yes"),MessageBoxButtonType.ButtonTypeNormal,0,-1,1);btnBuy.click=function(){this.scheduleOnce(function(float){this.sendPacketTimeReduction()},.1,"sendPacketTimeReduction"),this.m_box.hide()}.bind(this),this.m_box.addButtonInfo(btnNo),this.m_box.addButtonInfo(btnBuy),this.m_box.show()},showImpossibleTimeReduction:function(){this.m_box.setTitle(res_str("label_preparation_title")),this.m_box.setText(res_str("label_craft_shop_time_reduction_impossible_text")),this.m_box.setText("\n"),this.m_box.addButtonInfo(new MessageButtonInfo(res_str("label_confirm"),MessageBoxButtonType.ButtonTypeNormal,0,function(){this.m_box.hide(!1)}.bind(this))),this.m_box.show()},showTimeReductionComplete:function(){this.m_box.setTitle(res_str("label_preparation_title")),this.m_box.setText(res_str("label_craft_shop_time_reduction_complete_text")),this.m_box.setText("\n"),this.m_box.addButtonInfo(new MessageButtonInfo(res_str("label_confirm"),MessageBoxButtonType.ButtonTypeNormal,0,function(){this.m_box.hide(!1)}.bind(this))),this.m_box.show()},showMakeEffect:function(){this.m_makeItemModalLayer.setContentSize(ccSize(this)),this.m_makeItemModalLayer._contentNode=function(contentSize,m){var layer=new cc.Layer;layer.setContentSize(ccSize(this));var ani_img_1=cc.Sprite.create();ani_img_1.setAnchorPoint(ANCHOR_MIDDLE()),ani_img_1.setPosition(LP(this,240,403)),layer.addChild(ani_img_1);var callBack=new cc.CallFunc(this.spineEffectStart,this);ani_img_1.runAction(callBack);var spineBackground=new sp.SkeletonAnimation(RES_CDN_DEFULT+"effect/Fade.json",RES_CDN_DEFULT+"effect/Fade.atlas",1);return spineBackground.setPosition(228,ccCenter(layer).y),spineBackground.setAnimation(0,"fx_1",!1),layer.addChild(spineBackground),this.m_skeletonEffectNode=new sp.SkeletonAnimation(RES_CDN_DEFULT+"effect/Combination.json",RES_CDN_DEFULT+"effect/Combination.atlas",.33),this.m_skeletonEffectNode.setPosition(228,ccCenter(layer).y),this.m_skeletonEffectNode.setAnimation(0,"fx_1",!1),this.m_skeletonEffectNode.setOpacity(0),layer.addChild(this.m_skeletonEffectNode),layer}.bind(this),this.m_makeItemModalLayer.show();var audio=AudioEngine.getInstance(),snd=RES_CDN_SOUND+SND_TYPE+"sound/"+EFT_GROWTH;audio.playEffect(snd)},spineEffectStart:function(){var ani_img_1=cc.Sprite.create();ani_img_1.setAnchorPoint(ANCHOR_MIDDLE()),ani_img_1.setPosition(LP(this,240,403)),this.addChild(ani_img_1);var callBack=new cc.CallFunc(this.effectComplete,this),delay=new cc.DelayTime(1.8),seq=new cc.Sequence(delay,callBack);ani_img_1.runAction(seq),this.m_skeletonEffectNode.setOpacity(255),this.m_skeletonEffectNode.setAnimation(0,"fx_1",!0)},effectComplete:function(){this.m_makeItemModalLayer.hide();var img_list=[];img_list.push(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/img_evevtvs_ct.png"),resourceLoader(img_list,function(){this.showCharacterLayer(),this.m_itemLayer.refreshTableView()}.bind(this))},showCharacterLayer:function(){this.m_characterModalLayer.setContentSize(ccSize(this)),this.m_characterModalLayer._contentNode=function(contentSize,m){BattleContext._getInstance().getEventDungeonPeriodIdx();var layer=new cc.Layer;layer.setContentSize(ccSize(this));var back_effect=cc.Sprite.create("#img_attend_effect.png");back_effect.setPosition(ccCenter(this)),layer.addChild(back_effect);var action=new cc.RotateBy(1,180),repeat=new cc.RepeatForever(action);back_effect.runAction(repeat);var bonus_icon=null;if(this.m_product_item.bonus_type==BONUS_TYPE_YUNHEE_FIX){var g=MasterManager.getInstance().get_General(this.m_product_item.min_value);bonus_icon=cc.Sprite.create("#img_reward_"+g.gnrl_id+"_d.png")}else bonus_icon=cc.Sprite.create("#img_reward_"+leadingZeros(this.m_product_item.bonus_type,2)+"_d.png");var item_count=this.m_make_item_count;bonus_icon.setPosition(ccCenter(this)),layer.addChild(bonus_icon);var bonus_count_label=cmLabel.getLabel("x"+this.m_product_item.max_value*item_count,LABEL_FONT_INDEX.FONT_503);bonus_count_label.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),bonus_count_label.setPosition(ccCenter(this).x,180),layer.addChild(bonus_count_label);var character=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_group_idx+"/img_evevtvs_ct.png");character.setAnchorPoint(ZERO()),character.setPosition(-1*ccWidth(character),0),layer.addChild(character);var callBack=new cc.CallFunc(this.showTalkBox,this),moveTO=new cc.MoveTo(.2,ZERO()),seq=new cc.Sequence(moveTO,callBack);character.runAction(seq),this.m_talk_box_img=cc.Sprite.create("#img_attend_talkbox.png"),this.m_talk_box_img.setAnchorPoint(ZERO()),this.m_talk_box_img.setPosition(LP(this,273,456)),layer.addChild(this.m_talk_box_img),this.m_talk_box_img.setVisible(!1);var audio=AudioEngine.getInstance();return audio.stopEffectsAll(),audio.playEffect(RES_CDN_SOUND+SND_TYPE+"sound/SE_all_win_popularity.mp3",!1),audio.playEffect(RES_CDN_SOUND+SND_TYPE+"sound/SE_gacha_back.mp3",!1),layer}.bind(this),this.m_characterModalLayer.show(),this.m_characterModalLayer.onItemTouchBegin=function(){return!!this.m_character_touch_enabled},this.m_characterModalLayer.onItemTouchEnd=function(){this.m_character_touch_enabled&&(AudioEngine.getInstance().stopEffectsAll(),this.m_characterModalLayer.hide(),this.m_character_touch_enabled=!1,this.m_itemLayer.setCharacter())}.bind(this)},showTalkBox:function(){this.m_talk_box_img.setVisible(!0);var m=MasterManager.getInstance();this.scheduleOnce(function(float){this.m_character_touch_enabled=!0},.5,"m_character_touch_enabled");var talk_box_label=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_2422);if(talk_box_label.setAnchorPoint(ANCHOR_MIDDLE()),talk_box_label.setPosition(ccCenter(this.m_talk_box_img).x,ccCenter(this.m_talk_box_img).y+7),this.m_talk_box_img.addChild(talk_box_label),this.m_product_item.bonus_type==BONUS_TYPE_YUNHEE_FIX){var g=m.get_General(this.m_product_item.min_value);talk_box_label.setString(cmString(res_str("label_event_craft_shop_make_talk_box_text_1"),g.name,this.m_product_item.max_value*this.m_make_item_count))}else{var b=m.get_BonusType(this.m_product_item.bonus_type);talk_box_label.setString(cmString(res_str("label_event_craft_shop_make_talk_box_text_1"),b.name,this.m_product_item.max_value*this.m_make_item_count))}}}),EventDungeonAccumRewardCell=cc.TableViewCell.extend({m_name_label:null,m_reward_label:null,m_content:null,m_gauge:null,m_count_label:null,m_bonus_icon:null,m_callback:null,m_list_bg:null,m_complete_btn_mask:null,m_complete_mask:null,m_btn_sprites:[],m_item_list:null,ctor:function(_callback,_showtooltip){this._super(),this.m_btn_sprites=[],this.m_item_list=[],this.init(_callback,_showtooltip)},init:function(_callback,_showtooltip){cc.size(924,78);for(var i=0;i<2;i++){var item=new EventDungeonAccumRewardItem;item._callback=_callback,item._showtooltip=_showtooltip;var s=ccSize(item);item.setPosition(s.width*i,0),this.addChild(item),this.m_item_list.push(item)}return!0},setData:function(reward){this.m_data_list=reward,this.updateCell()},updateCell:function(){for(var i=0;i<this.m_item_list.length;i++){var item=this.m_item_list[i];item.setVisible(!1),i<this.m_data_list.length&&(item.setVisible(!0),item.setData(this.m_data_list[i]))}},highlightPosInCell:function(pos){for(var i=0;i<this.m_item_list.length;i++){var item=this.m_item_list[i];if(item.isVisible()){var r=item.getBoundingBox();if(cc.rectContainsPoint(r,pos)){item.highlightPosInItem(pos,this.getTouchTablePos());break}}}},unhighlightPosInCell:function(pos){for(var i=0;i<this.m_item_list.length;i++){var item=this.m_item_list[i];if(item.isVisible()){var r=item.getBoundingBox();if(cc.rectContainsPoint(r,pos)){item.unhighlightPosInItem(pos,this.getTouchTablePos());break}}}},touchPosInCell:function(pos){for(var i=0;i<this.m_item_list.length;i++){var item=this.m_item_list[i];if(item.isVisible()){var r=item.getBoundingBox();if(cc.rectContainsPoint(r,pos)){item.touchPosInItem(pos,this.getTouchTablePos());break}}}}}),EventDungeonAccumRewardItem=cc.Layer.extend({m_disable_cover:null,m_complete_mark:null,m_icon_frame:null,m_reward_name:null,m_target_point:null,m_icon:null,_callback:null,_showtooltip:null,m_receive_sprite:null,ctor:function(){this._super(),this.m_receive_sprite=[],this.init()},init:function(){var size=cc.size(462,78);this.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),this.setContentSize(size);var box=cc.Scale9Sprite.create(RES_CDN_DEFULT+"menu_yh/img_yh_info_box.png",cc.Rect(20,20,20,20));box.setPreferredSize(size),box.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),box.setPosition(ZERO()),this.addChild(box),this.m_icon_frame=cc.Sprite.create(RES_CDN_DEFULT+"icon/img_icon_frame.png"),this.m_icon_frame.setAnchorPoint(ANCHOR_MIDDLE_LEFT()),this.m_icon_frame.setPosition(4,.5*size.height),box.addChild(this.m_icon_frame),this.m_icon=cc.Sprite.create("#img_reward_01.png"),this.m_icon.setAnchorPoint(ANCHOR_MIDDLE()),this.m_icon.setPosition(ccCenter(this.m_icon_frame)),this.m_icon_frame.addChild(this.m_icon),this.m_reward_name=cmLabel.getLabel("REWARD NAME",LABEL_FONT_INDEX.FONT_1812),this.m_reward_name.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),this.m_reward_name.setPosition(80,43),box.addChild(this.m_reward_name),this.m_target_point=cmLabel.getLabel("TARGET POINT",LABEL_FONT_INDEX.FONT_181),this.m_target_point.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),this.m_target_point.setPosition(80,16),box.addChild(this.m_target_point);var img_paths=[];img_paths.push("#btn_05_off.png"),img_paths.push("#btn_05_on.png"),img_paths.push("#btn_05_on.png");for(var i=0;i<img_paths.length;i++){var img=cc.Sprite.create(img_paths[i]);img.setAnchorPoint(ANCHOR_MIDDLE_RIGHT()),img.setPosition(size.width-13,.5*size.height),box.addChild(img);var label=cmLabel.getLabel("受け取る",LABEL_FONT_INDEX.FONT_201);label.setAnchorPoint(ANCHOR_MIDDLE()),label.setPosition(ccCenter(img)),img.addChild(label),this.m_receive_sprite.push(img)}return this.m_disable_cover=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_normal.png",cc.Rect(1,1,1,1)),this.m_disable_cover.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),this.m_disable_cover.setPreferredSize(size),this.m_disable_cover.setPosition(ZERO()),this.addChild(this.m_disable_cover),this.m_disable_cover.setVisible(!1),this.m_complete_mark=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs/img_eventvs_complete.png"),this.m_complete_mark.setAnchorPoint(ANCHOR_MIDDLE()),this.m_complete_mark.setPosition(ccCenter(size)),this.addChild(this.m_complete_mark),this.m_complete_mark.setVisible(!1),!0},touchPosInItem:function(pos,table_in_pos){if(!(this.m_data.is_rewarded_yn||this.m_data.user_accum_event_dungeon_point<this.m_data.reward.target_point)){var this_rect=this.getBoundingBox(),r=this.m_receive_sprite[0].getBoundingBox();r.x+=this_rect.x,r.y+=this_rect.y,cc.rectContainsPoint(r,pos)&&(this.m_receive_sprite[0].setVisible(!0),this.m_receive_sprite[1].setVisible(!1),this.m_receive_sprite[2].setVisible(!1),null!=this._callback&&this._callback(this.m_data))}},highlightPosInItem:function(pos,table_in_pos){if(this.m_data.is_rewarded_yn||this.m_data.user_accum_event_dungeon_point<this.m_data.reward.target_point){var this_rect=this.getBoundingBox(),result_pos=cc.p(pos.x-this_rect.x,pos.y-this_rect.y),ir=this.m_icon_frame.getBoundingBox();cc.rectContainsPoint(ir,result_pos)&&this.sendTooltip(table_in_pos)}else{this_rect=this.getBoundingBox();var r=this.m_receive_sprite[0].getBoundingBox();if(r.x+=this_rect.x,r.y+=this_rect.y,cc.rectContainsPoint(r,pos))return this.m_receive_sprite[0].setVisible(!1),this.m_receive_sprite[1].setVisible(!0),void this.m_receive_sprite[2].setVisible(!1);result_pos=cc.p(pos.x-this_rect.x,pos.y-this_rect.y),ir=this.m_icon_frame.getBoundingBox();cc.rectContainsPoint(ir,result_pos)&&this.sendTooltip(table_in_pos)}},unhighlightPosInItem:function(pos,table_in_pos){this.m_data.is_rewarded_yn||this.m_data.user_accum_event_dungeon_point<this.m_data.reward.target_point||(this.m_receive_sprite[0].setVisible(!0),this.m_receive_sprite[1].setVisible(!1),this.m_receive_sprite[2].setVisible(!1))},setData:function(data){this.m_data=data,this.updateLayout()},updateLayout:function(){var m=MasterManager.getInstance(),bonus=m.get_BonusType(this.m_data.reward.bonus_type),period=m.get_EventDungeonPeriod(this.m_data.event_dungeon_period_idx);switch(USE_SP_TUBM_SUM&&USE_SP_TUMB_SCALE&&this.m_icon.setScale(1),this.m_data.reward.bonus_type){case BONUS_TYPE_GOLD:case BONUS_TYPE_KEY:case BONUS_TYPE_HEART:case BONUS_TYPE_JADE:this.m_reward_name.setString(bonus.name+" "+this.m_data.reward.min_value+" 個");var frame=cc.spriteFrameCache.getSpriteFrame("img_reward_"+leadingZeros(this.m_data.reward.bonus_type,2)+".png");this.m_icon.setSpriteFrame(frame);break;case BONUS_TYPE_YUNHEE_FIX:var g=m.get_General(this.m_data.reward.min_value);m.get_RareType(g.rare_type);if(this.m_reward_name.setString(g.name+" "+this.m_data.reward.max_value+" 個"),g.gnrl_type==GENERAL_TYPE_MATERIAL||g.gnrl_type==GENERAL_TYPE_EVOLVE_MATERIAL)if(1==USE_SP_TUBM_SUM){frame=cc.spriteFrameCache.getSpriteFrame("m_"+g.bone_id+".png");this.m_reward_icon.setSpriteFrame(frame),1==USE_SP_TUMB_SCALE&&this.m_icon.setScale(DEF_TUMB_SCALE)}else{frame=cc.spriteFrameCache.getSpriteFrame(g.bone_id+".png");this.m_icon.setSpriteFrame(frame)}else if(USE_SP_TUBM_SUM){frame=cc.spriteFrameCache.getSpriteFrame("m_"+g.gnrl_id+".png");this.m_icon.setSpriteFrame(frame),USE_SP_TUMB_SCALE&&this.m_icon.setScale(DEF_TUMB_SCALE)}else{frame=cc.spriteFrameCache.getSpriteFrame(g.gnrl_id+".png");this.m_icon.setSpriteFrame(frame)}break;case BONUS_TYPE_HWANDAN_1:case BONUS_TYPE_HWANDAN_2:case BONUS_TYPE_HWANDAN_3:case BONUS_TYPE_HWANDAN_4:case BONUS_TYPE_HWANDAN_5:case BONUS_TYPE_HWANDAN_6:case BONUS_TYPE_HWANDAN_7:this.m_reward_name.setString(bonus.name+" "+this.m_data.reward.min_value+" 個");frame=cc.spriteFrameCache.getSpriteFrame("img_reward_"+leadingZeros(this.m_data.reward.bonus_type,2)+".png");this.m_icon.setSpriteFrame(frame);break;case BONUS_TYPE_LOVE_ITEM_MELEE:case BONUS_TYPE_LOVE_ITEM_LANCER:case BONUS_TYPE_LOVE_ITEM_RANGER:case BONUS_TYPE_LOVE_ITEM_CAKE:case BONUS_TYPE_SUPER_CHOCO_CAKE:case BONUS_TYPE_LOVE_MAX_CAKE:case BONUS_TYPE_EVOLVE_STONE:case BONUS_TYPE_EVOLVE_ORB:this.m_reward_name.setString(bonus.name+" "+this.m_data.reward.min_value+" 個");frame=cc.spriteFrameCache.getSpriteFrame("img_reward_"+leadingZeros(this.m_data.reward.bonus_type,2)+".png");this.m_icon.setSpriteFrame(frame);break;case BONUS_TYPE_EVOLVE_MELEE:case BONUS_TYPE_EVOLVE_LANCER:case BONUS_TYPE_EVOLVE_ARCHER:this.m_reward_name.setString(bonus.name+" "+this.m_data.reward.min_value+" 個");frame=cc.spriteFrameCache.getSpriteFrame("img_reward_"+leadingZeros(this.m_data.reward.bonus_type,2)+".png");this.m_icon.setSpriteFrame(frame);break;case BONUS_TYPE_ATTK_POINT:case BONUS_TYPE_DEF_POINT:case BONUS_TYPE_HP_POINT:case BONUS_TYPE_CRI_PRCNT_POINT:case BONUS_TYPE_CRI_DMG_POINT:this.m_reward_name.setString(bonus.name+" "+this.m_data.reward.min_value+" 個");frame=cc.spriteFrameCache.getSpriteFrame("img_reward_"+leadingZeros(this.m_data.reward.bonus_type,2)+".png");this.m_icon.setSpriteFrame(frame);break;case BONUS_TYPE_JADE_RANDOM_BOX:case BONUS_TYPE_GOLD_RANDOM_BOX:case BONUS_TYPE_LOVE_ITEM_RANDOM_BOX:case BONUS_TYPE_RARE_HWANDAN_RANDOM_BOX:case BONUS_TYPE_EXP_CARD_RANDOM_BOX:case BONUS_TYPE_CHRISTMAS_GIFT_BOX:case BONUS_TYPE_SWORD_ORB_RANDDOM_BOX:case BONUS_TYPE_SPEAR_ORB_RANDDOM_BOX:case BONUS_TYPE_ARCHER_ORB_RANDDOM_BOX:case BONUS_TYPE_FORMATION_PROPERTY_POINT_RANDOM_BOX:case BONUS_TYPE_FORMATION_PROPERTY_POINT_GIFT_BOX:this.m_reward_name.setString(bonus.name+" "+this.m_data.reward.min_value+" 個");frame=cc.spriteFrameCache.getSpriteFrame("img_reward_"+leadingZeros(this.m_data.reward.bonus_type,2)+".png");this.m_icon.setSpriteFrame(frame);break;case BONUS_TYPE_R_RARE_TYPE_ENGAGE:case BONUS_TYPE_HR_RARE_TYPE_ENGAGE:case BONUS_TYPE_SR_RARE_TYPE_ENGAGE:case BONUS_TYPE_SR_OVER_GACHA_TICKET:case BONUS_TYPE_SSR_RARE_TYPE_SELECT:this.m_reward_name.setString(bonus.name+" "+this.m_data.reward.min_value+" 個");frame=cc.spriteFrameCache.getSpriteFrame("img_reward_"+leadingZeros(this.m_data.reward.bonus_type,2)+".png");this.m_icon.setSpriteFrame(frame);break;case BONUS_TYPE_SR_LIMIT_OVER_MTRL:case BONUS_TYPE_SSR_LIMIT_OVER_MTRL:default:this.m_reward_name.setString(bonus.name+" "+this.m_data.reward.min_value+" 個");frame=cc.spriteFrameCache.getSpriteFrame("img_reward_"+leadingZeros(this.m_data.reward.bonus_type,2)+".png");this.m_icon.setSpriteFrame(frame)}var unit=m.get_EventPointUnitType(period.event_point_unit_type);this.m_target_point.setString(unit.name+" "+Number(this.m_data.reward.target_point).toLocaleString("en")+" 個"),this.m_data.user_accum_event_dungeon_point<this.m_data.reward.target_point?(this.m_disable_cover.setVisible(!0),this.m_complete_mark.setVisible(!1),this.m_receive_sprite[0].setVisible(!1),this.m_receive_sprite[1].setVisible(!1),this.m_receive_sprite[2].setVisible(!0)):this.m_data.is_rewarded_yn?(this.m_disable_cover.setVisible(!0),this.m_complete_mark.setVisible(!0),this.m_receive_sprite[0].setVisible(!1),this.m_receive_sprite[1].setVisible(!1),this.m_receive_sprite[2].setVisible(!0)):(this.m_disable_cover.setVisible(!1),this.m_complete_mark.setVisible(!1),this.m_receive_sprite[0].setVisible(!0),this.m_receive_sprite[1].setVisible(!1),this.m_receive_sprite[2].setVisible(!1))},convertRewardItem:function(b,item){b.bonus_type==BONUS_TYPE_YUNHEE_FIX||b.bonus_type==BONUS_TYPE_JIN_FIX?(item.item_type=database.BattleGainItemType.General,item.item_id=b.min_value,item.item_level=1,item.item_count=1):b.bonus_type==BONUS_TYPE_HEART?(item.item_type=database.BattleGainItemType.Heart,item.item_id=b.bonus_type,item.item_count=b.min_value):b.bonus_type==BONUS_TYPE_JADE?(item.item_type=database.BattleGainItemType.Jade,item.item_id=b.bonus_type,item.item_count=b.min_value):b.bonus_type==BONUS_TYPE_GOLD?(item.item_type=database.BattleGainItemType.Gold,item.item_id=b.bonus_type,item.item_count=b.min_value):b.bonus_type>=BONUS_TYPE_HWANDAN_1&&b.bonus_type<=BONUS_TYPE_HWANDAN_7||b.bonus_type==BONUS_TYPE_YUBI_RARE?(item.item_type=database.BattleGainItemType.Hwandan,item.item_id=b.bonus_type,item.item_count=b.min_value):b.bonus_type==BONUS_TYPE_EVENT_POINT?(item.item_type=database.BattleGainItemType.EventPoint,item.item_id=b.bonus_type,item.item_count=b.min_value):b.bonus_type==BONUS_TYPE_EVOLVE_STONE?(item.item_type=database.BattleGainItemType.EvolveStone,item.item_id=b.bonus_type,item.item_count=b.min_value):b.bonus_type>=BONUS_TYPE_ATTK_POINT&&b.bonus_type<=BONUS_TYPE_CRI_DMG_POINT?(item.item_type=database.BattleGainItemType.FormationPropertyPoint,item.item_id=b.bonus_type,item.item_count=b.min_value):b.bonus_type>=BONUS_TYPE_EVOLVE_MELEE&&b.bonus_type<=BONUS_TYPE_EVOLVE_ARCHER||b.bonus_type==BONUS_TYPE_YUBI_EVOLVE_HIGH?(item.item_type=database.BattleGainItemType.ForceTypeEvolveMtrl,item.item_id=b.bonus_type,item.item_count=b.min_value,item.item_level=1):b.bonus_type>=BONUS_TYPE_EVOLVE_MELEE_MIDDLE&&b.bonus_type<=BONUS_TYPE_EVOLVE_ARCHER_MIDDLE||b.bonus_type==BONUS_TYPE_YUBI_EVOLVE_MIDDLE?(item.item_type=database.BattleGainItemType.ForceTypeEvolveMtrl,item.item_id=b.bonus_type,item.item_count=b.min_value,item.item_level=1):b.bonus_type>=BONUS_TYPE_EVOLVE_MELEE_LOW&&b.bonus_type<=BONUS_TYPE_EVOLVE_ARCHER_LOW||b.bonus_type==BONUS_TYPE_YUBI_EVOLVE_LOW?(item.item_type=database.BattleGainItemType.ForceTypeEvolveMtrl,item.item_id=b.bonus_type,item.item_count=b.min_value,item.item_level=1):b.bonus_type==BONUS_TYPE_EVOLVE_ORB?(item.item_type=database.BattleGainItemType.EvolveOrb,item.item_id=b.bonus_type,item.item_count=b.min_value):b.bonus_type>=BONUS_TYPE_LOVE_ITEM_MELEE&&b.bonus_type<=BONUS_TYPE_LOVE_ITEM_CAKE||b.bonus_type==BONUS_TYPE_YUBI_LOVE_ITEM||b.bonus_type==BONUS_TYPE_SUPER_CHOCO_CAKE||b.bonus_type==BONUS_TYPE_LOVE_MAX_CAKE?(item.item_type=database.BattleGainItemType.LoveItem,item.item_id=b.bonus_type,item.item_count=b.min_value,item.item_level=1):b.bonus_type>=BONUS_TYPE_JADE_RANDOM_BOX&&b.bonus_type<=BONUS_TYPE_CHRISTMAS_GIFT_BOX||b.bonus_type>=BONUS_TYPE_SWORD_ORB_RANDDOM_BOX&&b.bonus_type<=BONUS_TYPE_ARCHER_ORB_RANDDOM_BOX?(item.item_type=database.BattleGainItemType.RandomBox,item.item_id=b.bonus_type,item.item_count=b.min_value):b.bonus_type==BONUS_TYPE_EVENT_DUNGEON_SPECIAL_POINT?(item.item_type=database.BattleGainItemType.SpecialPoint,item.item_id=b.bonus_type,item.item_count=b.min_value,item.item_level=this.m_data.event_dungeon_period_idx):(b.bonus_type==BONUS_TYPE_JADE_RANDOM_BOX||b.bonus_type==BONUS_TYPE_GOLD_RANDOM_BOX||b.bonus_type==BONUS_TYPE_LOVE_ITEM_RANDOM_BOX||b.bonus_type==BONUS_TYPE_RARE_HWANDAN_RANDOM_BOX||b.bonus_type==BONUS_TYPE_EXP_CARD_RANDOM_BOX||b.bonus_type==BONUS_TYPE_CHRISTMAS_GIFT_BOX||b.bonus_type==BONUS_TYPE_SWORD_ORB_RANDDOM_BOX||b.bonus_type==BONUS_TYPE_SPEAR_ORB_RANDDOM_BOX||b.bonus_type==BONUS_TYPE_ARCHER_ORB_RANDDOM_BOX||b.bonus_type==BONUS_TYPE_FORMATION_PROPERTY_POINT_RANDOM_BOX||b.bonus_type==BONUS_TYPE_FORMATION_PROPERTY_POINT_GIFT_BOX||b.bonus_type==BONUS_TYPE_EQUIPMENT_EXP_BOX_1||b.bonus_type==BONUS_TYPE_EQUIPMENT_EXP_BOX_2||b.bonus_type==BONUS_TYPE_EQUIPMENT_EXP_BOX_3||b.bonus_type==BONUS_TYPE_EQUIPMENT_EXP_BOX_4?item.item_type=database.BattleGainItemType.RandomBox:b.bonus_type==BONUS_TYPE_R_RARE_TYPE_ENGAGE||b.bonus_type==BONUS_TYPE_HR_RARE_TYPE_ENGAGE||b.bonus_type==BONUS_TYPE_SR_RARE_TYPE_ENGAGE||b.bonus_type==BONUS_TYPE_SSR_RARE_TYPE_SELECT||b.bonus_type==BONUS_TYPE_SR_OVER_GACHA_TICKET?item.item_type=database.BattleGainItemType.RandomBox:b.bonus_type==BONUS_TYPE_SR_LIMIT_OVER_MTRL||b.bonus_type==BONUS_TYPE_SSR_LIMIT_OVER_MTRL?item.item_type=database.BattleGainItemType.LimitOverMtrl:b.bonus_type==BONUS_TYPE_KEY_REFILL?item.item_type=database.BattleGainItemType.KeyRefill:b.bonus_type==BONUS_TYPE_MAGIC_KEY_MTRL?item.item_type=database.BattleGainItemType.MagicKeyPiece:b.bonus_type==BONUS_TYPE_RAID_TICKET_REFILL?item.item_type=database.BattleGainItemType.KeyRefill:b.bonus_type==BONUS_TYPE_EVENTDUNGEON_PRESENT_GIFT_BOX?item.item_type=database.BattleGainItemType.RandomBox:b.bonus_type>=BONUS_TYPE_REBIRTH_MTRL_TYPE_1&&b.bonus_type<=BONUS_TYPE_REBIRTH_MTRL_TYPE_7?item.item_type=database.BattleGainItemType.RebirthMtrl:b.bonus_type>=BONUS_TYPE_REBIRTH_MTRL_TYPE_EVENT_1&&b.bonus_type<=BONUS_TYPE_REBIRTH_MTRL_TYPE_EVENT_7?item.item_type=database.BattleGainItemType.RebirthMtrl:b.bonus_type==BONUS_TYPE_JADE_PIECE?item.item_type=database.BattleGainItemType.JadePiece:item.item_type=database.BattleGainItemType.ETC,item.item_id=b.bonus_type,item.item_count=b.min_value)},sendTooltip:function(table_in_pos){var item={};this.convertRewardItem(this.m_data.reward,item),null!=this._showtooltip&&this._showtooltip(item,table_in_pos)}}),ED_AccumReward={COLUMN_COUNT:2},event_dungeon_accum_point_reward_receive_all=88888,event_dungeon_accum_point_reward_receive_one=88889,EventDungeonAccumRewardLayer=cc.Layer.extend({m_table_view:null,m_event_dungeon_period_idx:0,m_all_receive:null,tooltip_box:null,tooltip_content:null,tooltip_title:null,m_reward_list:null,m_event_dungeon_point:null,m_all_receive_diabled:null,m_is_prv_event_dungeon:null,m_info_icon:null,m_info_text:null,ctor:function(){this._super(),this.m_reward_list=[],this.m_event_dungeon_point={},this.init()},init:function(){this.ignoreAnchorPointForPosition(!1),this.setAnchorPoint(ANCHOR_MIDDLE());var winSize=ccSize(this),m=MasterManager.getInstance(),service=EventDungeonService.getInstance(),context=BattleContext._getInstance();this.m_is_prv_event_dungeon=context.getIsPrvEventDungeon(),this.m_is_prv_event_dungeon?this.m_event_dungeon_period_idx=context.getPrvEventDungeonPeriodIdx():this.m_event_dungeon_period_idx=context.getEventDungeonPeriodIdx(),this.m_period=m.get_EventDungeonPeriod(this.m_event_dungeon_period_idx),service.getUserEventDungeonReward(this.m_period.event_dungeon_point_period_idx,this.m_reward_list),service.getUserEventDungeonPoint(this.m_period.event_dungeon_point_period_idx,this.m_event_dungeon_point);for(var idx=0;idx<this.m_reward_list.length;idx++){var r=this.m_reward_list[idx];r.user_event_dungeon_point=this.m_event_dungeon_point.event_point,r.user_accum_event_dungeon_point=this.m_event_dungeon_point.accum_event_point}var bg=new cc.Sprite(RES_CDN_DEFULT+"menu_eventvs_"+this.m_event_dungeon_period_idx+"/bg_eventvs_sub.jpg");bg.setAnchorPoint(ANCHOR_MIDDLE()),bg.setPosition(ccCenter(winSize)),this.addChild(bg);var box=cc.Sprite.create(RES_CDN_DEFULT+"common/img_box_01.png");box.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),box.setPosition(.5*winSize.width,30),this.addChild(box);var boxSize=ccSize(box),event_dungeon_name=m.get_EventDungeonName(this.m_event_dungeon_period_idx),title=cmLabel.getLabel(event_dungeon_name.name,LABEL_FONT_INDEX.FONT_2013);title.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),title.setPosition(34,463),box.addChild(title);var offset_x=boxSize.width-17;this.m_all_receive=new LabelButton("btn_11_off.png","btn_11_on.png","btn_11_none.png",ccui.Widget.PLIST_TEXTURE),this.m_all_receive.setFont(LABEL_FONT_INDEX.FONT_201),this.m_all_receive.setString(res_str("btn_label_all_accept")),this.m_all_receive.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),this.m_all_receive.setPosition(offset_x,453),this.m_all_receive.setSwallowTouches(!0),box.addChild(this.m_all_receive),this.m_all_receive.addClickEventListener(function(sender){MainObserver.getInstance().postNotification(event_dungeon_accum_point_reward_receive_all)}.bind(this)),this.m_all_receive_diabled=new LabelButton("btn_11_none.png","btn_11_none.png","",ccui.Widget.PLIST_TEXTURE),this.m_all_receive_diabled.setFont(LABEL_FONT_INDEX.FONT_201),this.m_all_receive_diabled.setString(res_str("btn_label_all_accept")),this.m_all_receive_diabled.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),this.m_all_receive_diabled.setPosition(offset_x,453),this.m_all_receive_diabled.setSwallowTouches(!0),box.addChild(this.m_all_receive_diabled),this.m_all_receive_diabled.addClickEventListener(function(sender){}.bind(this)),this.m_all_receive_diabled.setVisible(!1),offset_x=offset_x-ccWidth(this.m_all_receive)-5;var unit=m.get_EventPointUnitType(this.m_period.event_point_unit_type),my_point=cmLabel.getLabel(cmString("%s %s",unit.name,Number(this.m_event_dungeon_point.accum_event_point).toLocaleString()),LABEL_FONT_INDEX.FONT_262);my_point.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),my_point.setPosition(offset_x,463),box.addChild(my_point);for(var is_exist_receive_items=!1,i=0;i<this.m_reward_list.length;i++)if(0==this.m_reward_list[i].is_rewarded_yn&&this.m_reward_list[i].reward.target_point<=this.m_event_dungeon_point.accum_event_point){is_exist_receive_items=!0;break}this.m_all_receive.setEnabled(is_exist_receive_items);var tSize=cc.size(924,385);this.m_table_view=new cc.TableView(this,tSize),this.m_table_view.ignoreAnchorPointForPosition(!1),this.m_table_view.setDirection(cc.SCROLLVIEW_DIRECTION_VERTICAL),this.m_table_view.setVerticalFillOrder(cc.TABLEVIEW_FILL_TOPDOWN),this.m_table_view.scrollBarEnable(!0),this.m_table_view.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),this.m_table_view.setPosition(17,58),box.addChild(this.m_table_view),this.m_table_view.setDelegate(this),this.m_table_view.reloadData(),this.m_info_icon=cc.Sprite.create(RES_CDN_DEFULT+"menu_friend/img_friend_text.png"),this.m_info_icon.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),this.m_info_icon.setPosition(311,17),box.addChild(this.m_info_icon);var date_str;return date_str=this.getEventDungeonEndDateString(),this.m_info_text=cmLabel.getLabel(date_str,LABEL_FONT_INDEX.FONT_1613),this.m_info_text.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),this.m_info_text.setPosition(ccPosX(this.m_info_icon)+ccWidth(this.m_info_icon),24),box.addChild(this.m_info_text),this.tooltip_box=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_result_box.png",cc.Rect(20,20,20,20)),this.tooltip_box.setPreferredSize(boxSize),this.tooltip_box.setAnchorPoint(ANCHOR_MIDDLE_LEFT()),this.tooltip_box.setPosition(0,tSize.height+17),this.tooltip_box.setVisible(!1),this.addChild(this.tooltip_box),this.tooltip_title=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_1810),this.tooltip_title.setAnchorPoint(ANCHOR_TOP_LEFT()),this.tooltip_box.addChild(this.tooltip_title),this.tooltip_content=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_181),this.tooltip_content.setAnchorPoint(ANCHOR_TOP_LEFT()),this.tooltip_box.addChild(this.tooltip_content),!0},setAchivementList:function(list){this.m_user_achv_list=list,this.m_user_achv_list.sort(function(l,r){return l.complete_yn<r.complete_yn?1:l.complete_yn>r.complete_yn?-1:0}),this.m_user_achv_list.sort(function(l,r){return l.bonus_complete_yn<r.bonus_complete_yn?1:l.bonus_complete_yn>r.bonus_complete_yn?-1:0})},setAchvEventPeriod:function(period_id){this.m_eventPeriodId=period_id},scrollViewDidScroll:function(view){},scrollViewDidZoom:function(view){},tableCellAtIndex:function(table,idx){var c=table.dequeueCell(),cell=null;cell=null!=c?c:new EventDungeonAccumRewardCell(this.cbReceiveReward.bind(this),this.showTooltip.bind(this));var desc=[],start=idx*ED_AccumReward.COLUMN_COUNT,end=start+ED_AccumReward.COLUMN_COUNT;if(end<this.m_reward_list.length)for(idx=start;idx<=end;idx++)desc.push(this.m_reward_list[idx]);else for(idx=start;idx<this.m_reward_list.length;idx++)desc.push(this.m_reward_list[idx]);return cell.setData(desc),cell},numberOfCellsInTableView:function(table){return Math.ceil(this.m_reward_list.length/ED_AccumReward.COLUMN_COUNT)},tableCellTouched:function(table,cell){cc.log("cell touched at index: "+cell.getIdx());null!=cell&&cell.touchPosInCell(cell.getTouchPos())},tableCellEnded:function(){},tableCellHighlight:function(table,cell){null!=cell&&cell.highlightPosInCell(cell.getTouchPos())},tableCellUnhighlight:function(table,cell){null!=cell&&cell.unhighlightPosInCell(cell.getTouchPos()),this.hideTooltip()},tableCellSizeForIndex:function(){return cc.size(924,78)},cellSizeForTable:function(table){return cc.size(924,78)},cbReceiveReward:function(reward){if(!reward.is_rewarded_yn){AudioEngine.getInstance().playEffect(RES_CDN_SOUND+SND_TYPE+"sound/"+EFT_NORMAL_BUTTON);for(var list=[],found=!1,index=(this.m_reward_list.length,0),idx=0;idx<this.m_reward_list.length;idx++){var item=this.m_reward_list[idx];if(item.reward.target_point<=this.m_event_dungeon_point.accum_event_point&&item.event_dungeon_period_idx==reward.event_dungeon_period_idx&&item.event_dungeon_reward_idx==reward.event_dungeon_reward_idx){list.push(item),found=!0;break}index++}found&&(this.m_reward_list[index].is_selected=!0,MainObserver.getInstance().postNotification(event_dungeon_accum_point_reward_receive_one))}},getChoiceReceiveReward:function(rewards){for(var item={},idx=0;idx<this.m_reward_list.length;idx++){var r=this.m_reward_list[idx];this.m_event_dungeon_point.accum_event_point>=r.reward.target_point&&r.is_selected&&!r.is_rewarded_yn&&(item.event_dungeon_period_idx=this.m_event_dungeon_period_idx,item.event_dungeon_reward_idx=r.reward.event_dungeon_reward_idx,item.event_dungeon_point_period_idx=r.event_dungeon_period_idx,rewards.push(item))}},getAllChoiceReceiveReward:function(rewards){for(var item={},idx=0;idx<this.m_reward_list.length;idx++){var r=this.m_reward_list[idx];this.m_event_dungeon_point.accum_event_point>=r.reward.target_point&&(r.is_rewarded_yn||(item={},r.is_selected=!0,item.event_dungeon_period_idx=this.m_event_dungeon_period_idx,item.event_dungeon_reward_idx=r.reward.event_dungeon_reward_idx,item.event_dungeon_point_period_idx=r.event_dungeon_period_idx,rewards.push(item)))}},refreshRewardList:function(reward){var service=EventDungeonService.getInstance();this.m_reward_list=[];var period=MasterManager.getInstance().get_EventDungeonPeriod(this.m_event_dungeon_period_idx);service.getUserEventDungeonReward(period.event_dungeon_point_period_idx,this.m_reward_list);for(var idx=0;idx<this.m_reward_list.length;idx++){var r=this.m_reward_list[idx];r.user_event_dungeon_point=this.m_event_dungeon_point.event_point,r.user_accum_event_dungeon_point=this.m_event_dungeon_point.accum_event_point}for(var is_exist_receive_items=!1,i=0;i<this.m_reward_list.length;i++)!this.m_reward_list[i].is_rewarded_yn&&this.m_reward_list[i].reward.target_point<=this.m_event_dungeon_point.accum_event_point&&(is_exist_receive_items=!0);is_exist_receive_items?this.m_all_receive.setEnabled(is_exist_receive_items):(this.m_all_receive.setVisible(!1),this.m_all_receive_diabled.setVisible(!0));var offset=this.m_table_view.getContentOffset();this.m_table_view.reloadData(),this.m_table_view.setContentOffset(offset)},showTooltip:function(item,table_in_pos){var t_pos=this.m_table_view.getPosition(),table_pos=this.m_table_view.convertToWorldSpace(t_pos);if(null==this.tooltip_box||isUndefined(this.tooltip_box.content)){this.tooltip_box.setVisible(!0);var x=table_in_pos.x+50;x<0&&(x=0);var y=table_in_pos.y-15;y<0&&(y=0),this.tooltip_box.setPosition(table_pos.x+x,table_pos.y+y)}var m=MasterTable.getInstance(),mt=MasterManager.getInstance();if(item.item_type==database.BattleGainItemType.General){var gnrl=mt.get_General(item.item_id);if(this.tooltip_title.setString(gnrl.name),this.tooltip_title.setAnchorPoint(ANCHOR_TOP_LEFT()),""==(tooltip=m.get_TooltipGeneral(item.item_id)).content||isUndefined(tooltip.content)){this.tooltip_title.setString(gnrl.name),this.tooltip_title.setAnchorPoint(ANCHOR_MIDDLE()),this.tooltip_content.setString("");var tSize=ccSize(this.tooltip_title),bSize=cc.size(tSize.width+20,tSize.height+20),max=0;max=64<=tSize.width+20?tSize.width+20:64,bSize.width=max;max=0;max=54<=bSize.height+10?bSize.height+10:54,bSize.height=max,this.tooltip_box.setContentSize(bSize),this.tooltip_title.setPosition(ccCenter(bSize))}else{this.tooltip_title.setString(gnrl.name),this.tooltip_title.setAnchorPoint(ANCHOR_TOP_LEFT()),this.tooltip_content.setString(tooltip.content);tSize=ccSize(this.tooltip_title);var cSize=ccSize(this.tooltip_content);bSize=cc.size(tSize.width+20,tSize.height+20),max=0;max=tSize.width+20<=cSize.width+20?cSize.width+20:tSize.width+20,bSize.width=max;max=0;max=64<=bSize.height+cSize.height+5?bSize.height+cSize.height+5:64,bSize.height=max,this.tooltip_box.setContentSize(bSize),this.tooltip_title.setPosition(10,bSize.height-10),this.tooltip_content.setPosition(10,bSize.height-15-tSize.height)}}else{var tooltip,bonus=mt.get_BonusType(item.item_id);if(""==(tooltip=MasterTable.getInstance().get_TooltipItem(item.item_id)).content||isUndefined(tooltip.content)){this.tooltip_title.setString(bonus.name),this.tooltip_title.setAnchorPoint(ANCHOR_MIDDLE()),this.tooltip_content.setString("");tSize=ccSize(this.tooltip_title),bSize=cc.size(tSize.width+20,tSize.height+20),max=0;max=64<=tSize.width+20?tSize.width+20:64,bSize.width=max;max=0;max=54<=bSize.height+10?bSize.height+10:54,bSize.height=max,this.tooltip_box.setContentSize(bSize),this.tooltip_title.setPosition(ccCenter(bSize))}else{this.tooltip_title.setString(bonus.name),this.tooltip_title.setAnchorPoint(ANCHOR_TOP_LEFT()),this.tooltip_content.setString(tooltip.content);tSize=ccSize(this.tooltip_title),cSize=ccSize(this.tooltip_content),bSize=cc.size(tSize.width+20,tSize.height+20),max=0;max=tSize.width+20<=cSize.width+20?cSize.width+20:tSize.width+20,bSize.width=max;max=0;max=64<=bSize.height+cSize.height+5?bSize.height+cSize.height+5:64,bSize.height=max,this.tooltip_box.setContentSize(bSize),this.tooltip_title.setPosition(10,bSize.height-10),this.tooltip_content.setPosition(10,bSize.height-15-tSize.height)}}},hideTooltip:function(){null!=this.tooltip_box&&this.tooltip_box.setVisible(!1)},getEventDungeonEndDateString:function(){var end_dt=moment(this.m_period.event_dungeon_point_end_dt);return"※期間限定："+((end_dt=end_dt.add("s")).get("month")+1)+"月"+end_dt.get("date")+"日メンテナンス前まで。"}}),event_dungeno_accum_reward_result_popup_close=97891,event_dungeon_use_point_reward_receive_all=88888,event_dungeon_use_point_reward_receive_one=88889,invoker_accum_reward=1,invoker_vote_league_use_point_reward=2,EventDungeonAccumRewardResultPopup=cc.Layer.extend({m_tableView:null,m_reward_list:null,m_invoker:0,ctor:function(list,invoker){this._super(),this.init(list,invoker)},init:function(list,invoker){this.m_invoker=invoker,null==this.m_invoker&&(this.m_invoker=invoker_accum_reward),this.m_reward_list=list,this.ignoreAnchorPointForPosition(!1),this.setAnchorPoint(ANCHOR_MIDDLE());ccSize(this),MasterTable.getInstance();var boxSize=cc.size(630,370),box=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_script_box_2.png",cc.Rect(40,40,10,10));box.setPreferredSize(boxSize),box.setAnchorPoint(ANCHOR_MIDDLE()),box.setPosition(ccCenter(this.getContentSize())),this.addChild(box);var navi=cc.Sprite.create(RES_CDN_DEFULT+"common/img_navi_center_3.png");navi.setAnchorPoint(ANCHOR_MIDDLE_TOP()),navi.setPosition(.5*boxSize.width,boxSize.height-11),box.addChild(navi);var naviSize=cc.size(navi),title=cmLabel.getLabel(res_str("label_information_title"),LABEL_FONT_INDEX.FONT_261);title.setAnchorPoint(ANCHOR_MIDDLE()),title.setPosition(.5*naviSize.width,.5*naviSize.height+2),navi.addChild(title);var tSize=cc.size(590,184);this.m_tableView=new cc.TableView(this,tSize),this.m_tableView.setDirection(cc.SCROLLVIEW_DIRECTION_VERTICAL),this.m_tableView.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),this.m_tableView.setVerticalFillOrder(cc.TABLEVIEW_FILL_TOPDOWN),this.m_tableView.setPosition(20,116),this.m_tableView.setDelegate(this),box.addChild(this.m_tableView),this.m_tableView.reloadData();var comment=cmLabel.getLabel(res_str("label_event_dungeon_recieve_to_mail_box"),LABEL_FONT_INDEX.FONT_208);comment.setAnchorPoint(ANCHOR_MIDDLE()),comment.setPosition(.5*boxSize.width,100),box.addChild(comment);var btn=new LabelButton("btn_07_off.png","btn_07_on.png","",ccui.Widget.PLIST_TEXTURE);btn.setFont(LABEL_FONT_INDEX.FONT_241),btn.setString(res_str("btn_label_confirm")),btn.setAnchorPoint(ANCHOR_MIDDLE_BOTTOM()),btn.setPosition(.5*boxSize.width,16),box.addChild(btn),btn.addClickEventListener(function(sender){MainObserver.getInstance().postNotification(event_dungeno_accum_reward_result_popup_close)}.bind(this))},cellSizeForTable:function(table){return cc.size(590,40)},tableCellAtIndex:function(table,idx){var c=table.dequeueCell(),cell=null;if(null!=c)cell=c;else{(cell=new cc.TableViewCell).setContentSize(this.cellSizeForTable(table));var label_1=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_247);label_1.setAnchorPoint(ANCHOR_MIDDLE_LEFT()),label_1.setPosition(ccCenter(cell)),cell.addChild(label_1),label_1.setTag(99999);var label_2=cmLabel.getLabel(res_str("label_reward_receive_tail_msg"),LABEL_FONT_INDEX.FONT_241);label_2.setAnchorPoint(ANCHOR_MIDDLE_LEFT()),label_2.setPosition(ccCenter(cell)),cell.addChild(label_2),label_2.setTag(88888)}var data=this.m_reward_list[idx],label=cell.getChildByTag(99999);if(null!=label){var m=MasterManager.getInstance(),name="",reward={},b_type={},bonus_type=0,min_value=0,max_value=0;if(this.m_invoker==invoker_accum_reward?(reward=m.get_EventDungeonReward(data.event_dungeon_reward_idx),b_type=m.get_BonusType(reward.bonus_type),bonus_type=reward.bonus_type,min_value=reward.min_value,max_value=reward.max_value):this.m_invoker==invoker_vote_league_use_point_reward&&(reward=m.get_EventDungeonVoteLeagueUsePointReward(data.event_dungeon_reward_idx),b_type=m.get_BonusType(reward.bonus_type),bonus_type=reward.bonus_type,min_value=reward.min_value,max_value=reward.max_value),bonus_type==BONUS_TYPE_YUNHEE_FIX){name=m.get_General(min_value).name;var text=cmString(res_str("label_reward_receive_count_unit"),name,max_value);label.setString(text)}else if(bonus_type>=BONUS_TYPE_LOVE_ITEM_VD_COCHOLATE_A&&bonus_type<=BONUS_TYPE_LOVE_ITEM_PARTNER_COCHOLATE){name=name+" "+b_type.name;text=cmString(res_str("label_reward_receive_count_unit"),name,min_value);label.setString(text)}else{name=b_type.name;text=cmString(res_str("label_reward_receive_count_unit"),name,min_value);label.setString(text)}}var l1=ccSize(label),label2=cell.getChildByTag(88888),l2=ccSize(label2),offset_x=.5*(590-(l1.width+l2.width+6));return offset_x<0&&(offset_x=0),label.setPositionX(offset_x),offset_x+=l1.width+3,label2.setPositionX(offset_x),cell},numberOfCellsInTableView:function(table){return this.m_reward_list.length},tableCellUnhighlight:function(table,cell){return!0},tableCellSizeForIndex:function(table,idx){return cc.size(590,40)},tableCellEnded:function(table){return!0},tableCellHighlight:function(table){return!0},tableCellTouched:function(table,cell){return!0}}),EventDungeonAccumRewardScene=GameScene.extend({m_reward_layer:null,m_reward_result_modal_layer:null,ctor:function(){this._super(scene_EventDungeonAccumRewardScene)},init:function(){var win_size=ccSize(this),context=BattleContext._getInstance(),event_dungeon_period_idx=0;event_dungeon_period_idx=context.getIsPrvEventDungeon()?context.getPrvEventDungeonPeriodIdx():context.getEventDungeonPeriodIdx(),this.m_reward_layer=new EventDungeonAccumRewardLayer,this.m_reward_layer.setPosition(ccCenter(win_size)),this.addChild(this.m_reward_layer);var statusLayer=new StatusLayer(INVOKER_TYPE.normal);statusLayer.ignoreAnchorPointForPosition(!1),statusLayer.setAnchorPoint(ANCHOR_TOP_RIGHT()),statusLayer.setPosition(ccWidth(this),ccHeight(this)),this.addChild(statusLayer);var title=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+event_dungeon_period_idx+"/img_eventvs_text_event.png");title.setAnchorPoint(ZERO()),title.setPosition(90,585),this.addChild(title);var back_btn=new ccui.Button;return back_btn.loadTextures("btn_home_off.png","btn_home_on.png","",ccui.Widget.PLIST_TEXTURE),back_btn.setAnchorPoint(ZERO()),back_btn.setPosition(10,559),back_btn.addClickEventListener(function(){this.back()}.bind(this)),this.addChild(back_btn),this.m_reward_result_modal_layer=new GameModalLayer,this.addChild(this.m_reward_result_modal_layer,99999),!0},onEnter:function(){this._super(),MainObserver.getInstance().addObserver(this.onNotification,this,sceneStr[scene_EventDungeonAccumRewardScene]);var context=BattleContext._getInstance(),event_dungeon_period_idx=0;event_dungeon_period_idx=context.getIsPrvEventDungeon()?context.getPrvEventDungeonPeriodIdx():context.getEventDungeonPeriodIdx();var period=MasterManager.getInstance().get_EventDungeonPeriod(event_dungeon_period_idx),b_path=RES_CDN_SOUND+SND_TYPE+"sound/"+cmString(BGM_EVENT_DUNGEON_SCENE,period.event_dungeon_point_period_idx),audio=AudioEngine.getInstance();audio.m_bgmPath!=b_path&&(audio.stopBackgroundMusic(),audio.playBackgroundMusic(b_path,!0))},back:function(){this.onKeyBack(!0)},onExit:function(){this._super(),MainObserver.getInstance().removeObserver(sceneStr[scene_EventDungeonAccumRewardScene])},onNotification:function(msg){this._super(msg);AchievementService.getInstance();switch(msg){case event_dungeon_accum_point_reward_receive_all:this.reqEventDungeonRewardReceiveAll();break;case event_dungeon_accum_point_reward_receive_one:this.reqEventDungeonRewardReceive();break;case event_dungeno_accum_reward_result_popup_close:this.hideRewardCompleteMessage()}return!0},onNetworkEvent:function(opcode,state,body){opcode==net.OP.op_event_dungeon_point_reward&&(this.showRewardCompleteMessage(body),this.m_reward_layer.refreshRewardList(body))},reqEventDungeonRewardReceiveAll:function(){var res={};res.opcode=net.OP.op_event_dungeon_point_reward,res.event_dungeon_receive_list=[],this.m_reward_layer.getAllChoiceReceiveReward(res.event_dungeon_receive_list),0<res.event_dungeon_receive_list.length&&this.network_write(res)},reqEventDungeonRewardReceive:function(){var res={};(res.opcode=net.OP.op_event_dungeon_point_reward,res.event_dungeon_receive_list=[],this.m_reward_layer.getChoiceReceiveReward(res.event_dungeon_receive_list),0<res.event_dungeon_receive_list.length)&&SceneManager.getInstance().getRunningScene().network_write(res)},showRewardCompleteMessage:function(res){this.m_reward_result_modal_layer.setContentSize(ccSize(this)),this.m_reward_result_modal_layer._contentNode=function(contentSize,m){return new EventDungeonAccumRewardResultPopup(res.event_dungeon_reward_success)}.bind(this),this.m_reward_result_modal_layer.show()},hideRewardCompleteMessage:function(){this.m_reward_result_modal_layer.is_show()&&this.m_reward_result_modal_layer.hide()}}),EventDungeonListCell=cc.TableViewCell.extend({m_select_box:null,m_highlight:null,m_disable_cover:null,m_dungeon_name:null,m_cell_bg:null,m_data:[],ctor:function(){this._super(),this.m_data=[],this.init()},init:function(){var cellSize=cc.size(444,140);this.ignoreAnchorPointForPosition(!1),this.setAnchorPoint(ANCHOR_BOTTOM_LEFT()),this.setContentSize(cellSize),cc.log(cellSize);var event_dungeon_period_idx=BattleContext._getInstance().getEventDungeonPeriodIdx();USE_SP_EVENT_SCALE?(this.m_cell_bg=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+event_dungeon_period_idx+"/img_eventvs_list_01.png"),this.m_cell_bg.setScale(2),this.m_cell_bg.setAnchorPoint(ANCHOR_MIDDLE()),this.m_cell_bg.setPosition(ccCenter(cellSize)),this.addChild(this.m_cell_bg),this.m_dungeon_name=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_2615),this.m_dungeon_name.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),this.m_dungeon_name.setPosition(cellSize.width-10,20),this.addChild(this.m_dungeon_name)):(this.m_cell_bg=cc.Sprite.create(RES_CDN_DEFULT+"menu_eventvs_"+event_dungeon_period_idx+"/img_eventvs_list_01.png"),this.m_cell_bg.setAnchorPoint(ANCHOR_MIDDLE()),this.m_cell_bg.setPosition(ccCenter(cellSize)),this.addChild(this.m_cell_bg),this.m_dungeon_name=cmLabel.getLabel("",LABEL_FONT_INDEX.FONT_2615),this.m_dungeon_name.setAnchorPoint(ANCHOR_BOTTOM_RIGHT()),this.m_dungeon_name.setPosition(cellSize.width-10,20),this.m_cell_bg.addChild(this.m_dungeon_name)),this.m_disable_cover=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_normal.png",RectZero()),this.m_disable_cover.setAnchorPoint(ANCHOR_MIDDLE()),this.m_disable_cover.setPreferredSize(cellSize),this.m_disable_cover.setPosition(ccCenter(cellSize)),this.addChild(this.m_disable_cover),this.m_disable_cover.setVisible(!1);var lock=cc.Sprite.create(RES_CDN_DEFULT+"common/img_list_lock.png");return lock.setAnchorPoint(ANCHOR_MIDDLE()),lock.setPosition(ccCenter(this.m_disable_cover)),this.m_disable_cover.addChild(lock),this.m_highlight=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_select_1.png",cc.Rect(20,20,20,20)),this.m_highlight.setAnchorPoint(ANCHOR_MIDDLE()),this.m_highlight.setPosition(ccCenter(cellSize)),this.m_highlight.setPreferredSize(cellSize),this.m_highlight.setVisible(!1),this.addChild(this.m_highlight),this.m_select_box=cc.Scale9Sprite.create(RES_CDN_DEFULT+"common/img_9p_select_2.png",cc.Rect(20,20,20,20)),this.m_select_box.setAnchorPoint(ANCHOR_MIDDLE()),this.m_select_box.setPosition(ccCenter(cellSize)),this.m_select_box.setPreferredSize(cellSize),this.m_select_box.setVisible(!1),this.addChild(this.m_select_box),!0},setData:function(data){this.m_data=data,this.updateCell()},unSelected:function(){this.m_select_box.setVisible(!1),this.m_highlight.setVisible(!1)},updateCell:function(){cc.size(this);if(85e3==this.m_data.event_dungeon.event_dungeon_idx?this.m_cell_bg.setTexture(RES_CDN_DEFULT+"menu_eventvs_"+this.m_data.event_dungeon_period.event_dungeon_period_idx+"/img_eventvs_list_present.png"):this.m_cell_bg.setTexture(RES_CDN_DEFULT+"menu_eventvs_"+this.m_data.event_dungeon_period.event_dungeon_period_idx+"/img_eventvs_list_"+leadingZeros(this.m_data.event_dungeon.bg_type,2)+".png"),this.m_dungeon_name.setString(this.m_data.event_dungeon.name),cmLabel.autoSizeFit(this.m_dungeon_name,434,20),this.m_select_box.setVisible(this.m_data.is_selected),this.m_highlight.setVisible(this.m_data.is_selected),this.m_data.is_selected&&this.selectedAnimation(),this.m_data.is_open_pre_event_dungeon){var now=TimeEventEngine.getInstance().getTime(TIME_EVENT_SERVER_TIME),n=moment(now).valueOf(),b=this.m_data.event_dungeon_period.begin_date.valueOf(),e=this.m_data.event_dungeon_period.end_date.valueOf();b<=n?n<=e&&(this.m_data.is_enable=!0):this.m_data.is_enable=!1,this.m_disable_cover.setVisible(!this.m_data.is_enable)}else this.m_disable_cover.setVisible(!0)},selectedAnimation:function(){this.m_select_box.stopAllActions();var fadeout=cc.fadeOut(1),fadein=cc.fadeIn(1),seq=cc.sequence(fadeout,fadein),repeat=cc.repeatForever(seq);this.m_select_box.runAction(repeat)},unhighlightPosInCell:function(pos){}});